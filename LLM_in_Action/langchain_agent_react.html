<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans" xml:lang="zh-Hans"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Large Language Model in Action - 14&nbsp; LangChain ReAct Agent</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./langchain_agent_chat.html" rel="next">
<link href="./langchain_function_call.html" rel="prev">
<link href="./favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "没有结果",
    "search-matching-documents-text": "匹配的文档",
    "search-copy-link-title": "复制搜索链接",
    "search-hide-matches-text": "隐藏其它匹配结果",
    "search-more-match-text": "更多匹配结果",
    "search-more-matches-text": "更多匹配结果",
    "search-clear-button-title": "清除",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "提交",
    "search-label": "搜索"
  }
}</script>


<meta property="og:title" content="Large Language Model in Action - 14&nbsp; LangChain ReAct Agent">
<meta property="og:description" content="">
<meta property="og:site-name" content="Large Language Model in Action">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./favicon.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Large Language Model in Action</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="搜索"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="切换导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://wangwei1237.github.io/" rel="" target=""><i class="bi bi-house-fill" role="img">
</i> 
 <span class="menu-text">博客</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
      <i class="bi bi-bookshelf" role="img">
</i> 
 <span class="menu-text">书籍</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-">    
        <li>
    <a class="dropdown-item" href="https://zh.d2l.ai/" rel="" target="">
 <span class="dropdown-text">动手学深度学习</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://learnprompting.org/zh-Hans/docs/intro" rel="" target="">
 <span class="dropdown-text">Learn Prompting</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://pan.baidu.com/s/1dciwgbhO-lfKyRo8lOqW9Q?pwd=cm9q" rel="" target="">
 <span class="dropdown-text">Stabel Diffusion 提示词手册</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="https://wangwei1237.github.io/aboutme/" rel="" target=""><i class="bi bi-person-badge-fill" role="img">
</i> 
 <span class="menu-text">关于</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
    <a href="https://github.com/wangwei1237/LLM_in_Action" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./langchain_intro.html">LangChain</a></li><li class="breadcrumb-item"><a href="./langchain_agent_react.html"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">LangChain ReAct Agent</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="切换侧边栏导航" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="搜索"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">欢迎阅读</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./preface.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">序言</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">LLM 基本概念</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./llm_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">LLM 的前世今生</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tokens.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Tokens</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./embedding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Embedding</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./sft.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">微调</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./prompt_engineer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">提示词工程</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./hallucination.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">幻觉</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./rag_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">RAG</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./agent_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Agent</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./assistants.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Assistant</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">LangChain</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">LangChain 简介</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_serialization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">LangChain 序列化</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_retrieval.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">LangChain Retrieval</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_function_call.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">LangChain 函数调用</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_agent_react.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">LangChain ReAct Agent</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_agent_chat.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">LangChain Chat Agent</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_openai_assistant.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">LangChain OpenAI Assistant</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_agent_fc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">LangChain OpenAI Function Agent</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_agent_pae.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">LangChain PlanAndExcute Agent</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Sematic Kernel</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./semantickernel_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Sematic Kernel 简介</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./semantickernel_prompt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">SK 中的 Prompt</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./semantickernel_plugins.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">SK 中的 Plugin</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./semantickernel_promptflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Prompt flow 工具</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">其他框架</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./autogen.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">AutoGen</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./embedchain_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Embedchain 简介</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langflow_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Langflow</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Case Study</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./case1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Case1</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">附录</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="切換部分">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./glossary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">术语表</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./langchain_install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">LangChain 安装指南</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./milvus_install.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Milvus Beginner</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目录</h2>
   
  <ul>
  <li><a href="#三大基本组件" id="toc-三大基本组件" class="nav-link active" data-scroll-target="#三大基本组件"><span class="header-section-number">14.1</span> 三大基本组件</a>
  <ul class="collapse">
  <li><a href="#初始化-llm" id="toc-初始化-llm" class="nav-link" data-scroll-target="#初始化-llm"><span class="header-section-number">14.1.1</span> 初始化 LLM</a></li>
  <li><a href="#初始化-tool" id="toc-初始化-tool" class="nav-link" data-scroll-target="#初始化-tool"><span class="header-section-number">14.1.2</span> 初始化 Tool</a></li>
  <li><a href="#初始化-agent" id="toc-初始化-agent" class="nav-link" data-scroll-target="#初始化-agent"><span class="header-section-number">14.1.3</span> 初始化 Agent</a></li>
  </ul></li>
  <li><a href="#zero-shot-agent" id="toc-zero-shot-agent" class="nav-link" data-scroll-target="#zero-shot-agent"><span class="header-section-number">14.2</span> Zero Shot Agent</a>
  <ul class="collapse">
  <li><a href="#深入-zero-shot-agent" id="toc-深入-zero-shot-agent" class="nav-link" data-scroll-target="#深入-zero-shot-agent"><span class="header-section-number">14.2.1</span> 深入 Zero Shot Agent</a></li>
  </ul></li>
  <li><a href="#conversational-agent" id="toc-conversational-agent" class="nav-link" data-scroll-target="#conversational-agent"><span class="header-section-number">14.3</span> Conversational Agent</a></li>
  <li><a href="#agent-提示词工程" id="toc-agent-提示词工程" class="nav-link" data-scroll-target="#agent-提示词工程"><span class="header-section-number">14.4</span> Agent 提示词工程</a></li>
  <li><a href="#docstore-agent" id="toc-docstore-agent" class="nav-link" data-scroll-target="#docstore-agent"><span class="header-section-number">14.5</span> Docstore Agent</a>
  <ul class="collapse">
  <li><a href="#sec-lc_tool_input_param_count" id="toc-sec-lc_tool_input_param_count" class="nav-link" data-scroll-target="#sec-lc_tool_input_param_count"><span class="header-section-number">14.5.1</span> 单输入参数和多输入参数</a></li>
  </ul></li>
  <li><a href="#structured-chat-agent" id="toc-structured-chat-agent" class="nav-link" data-scroll-target="#structured-chat-agent"><span class="header-section-number">14.6</span> Structured Chat Agent</a></li>
  <li><a href="#自定义-agent-tools" id="toc-自定义-agent-tools" class="nav-link" data-scroll-target="#自定义-agent-tools"><span class="header-section-number">14.7</span> 自定义 Agent Tools</a>
  <ul class="collapse">
  <li><a href="#单输入参数" id="toc-单输入参数" class="nav-link" data-scroll-target="#单输入参数"><span class="header-section-number">14.7.1</span> 单输入参数</a></li>
  <li><a href="#sec-lc_agent_tools_m" id="toc-sec-lc_agent_tools_m" class="nav-link" data-scroll-target="#sec-lc_agent_tools_m"><span class="header-section-number">14.7.2</span> 多输入参数</a></li>
  </ul></li>
  <li><a href="#总结" id="toc-总结" class="nav-link" data-scroll-target="#总结"><span class="header-section-number">14.8</span> 总结</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/wangwei1237/LLM_in_Action/edit/main/langchain_agent_react.qmd" class="toc-action">编辑该页面</a></p><p><a href="https://github.com/wangwei1237/LLM_in_Action/issues/new" class="toc-action">报告问题</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-lc_react" class="quarto-section-identifier"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">LangChain ReAct Agent</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>在 <a href="agent_intro.html"><span>章节&nbsp;8</span></a> 中，我们介绍了 Agent 的基本概念和其所能解决的问题。这一章，我们重点介绍 如何在 LangChain 中使用 Agent。</p>
<section id="三大基本组件" class="level2" data-number="14.1">
<h2 data-number="14.1" class="anchored" data-anchor-id="三大基本组件"><span class="header-section-number">14.1</span> 三大基本组件</h2>
<p>在 LangChain 中，要使用 Agent，我们需要三大基本组件：</p>
<ul>
<li>一个基本的 LLM</li>
<li>一系列 Tool，LLM 可以与这些工具进行交互</li>
<li>一个 Agent，用于控制 LLM 和工具之间的交互</li>
</ul>
<div id="lst-la_initialize_agent" class="listing">
<p>列表&nbsp;14.1: 用于初始化 Agent 的函数</p>
<div class="sourceCode" id="lst-la_initialize_agent" data-lst-cap="用于初始化 Agent 的函数"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="lst-la_initialize_agent-1"><a href="#lst-la_initialize_agent-1"></a><span class="co"># path: langchain/agent/initialize.py</span></span>
<span id="lst-la_initialize_agent-2"><a href="#lst-la_initialize_agent-2"></a></span>
<span id="lst-la_initialize_agent-3"><a href="#lst-la_initialize_agent-3"></a><span class="kw">def</span> initialize_agent(</span>
<span id="lst-la_initialize_agent-4"><a href="#lst-la_initialize_agent-4"></a>    tools: Sequence[BaseTool],</span>
<span id="lst-la_initialize_agent-5"><a href="#lst-la_initialize_agent-5"></a>    llm: BaseLanguageModel,</span>
<span id="lst-la_initialize_agent-6"><a href="#lst-la_initialize_agent-6"></a>    agent: Optional[AgentType] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="lst-la_initialize_agent-7"><a href="#lst-la_initialize_agent-7"></a>    callback_manager: Optional[BaseCallbackManager] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="lst-la_initialize_agent-8"><a href="#lst-la_initialize_agent-8"></a>    agent_path: Optional[<span class="bu">str</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="lst-la_initialize_agent-9"><a href="#lst-la_initialize_agent-9"></a>    agent_kwargs: Optional[<span class="bu">dict</span>] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="lst-la_initialize_agent-10"><a href="#lst-la_initialize_agent-10"></a>    <span class="op">*</span>,</span>
<span id="lst-la_initialize_agent-11"><a href="#lst-la_initialize_agent-11"></a>    tags: Optional[Sequence[<span class="bu">str</span>]] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="lst-la_initialize_agent-12"><a href="#lst-la_initialize_agent-12"></a>    <span class="op">**</span>kwargs: Any,</span>
<span id="lst-la_initialize_agent-13"><a href="#lst-la_initialize_agent-13"></a>) <span class="op">-&gt;</span> AgentExecutor</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="初始化-llm" class="level3" data-number="14.1.1">
<h3 data-number="14.1.1" class="anchored" data-anchor-id="初始化-llm"><span class="header-section-number">14.1.1</span> 初始化 LLM</h3>
<p>首先，我们使用 ErnieBot 来初始化一个基本 LLM。</p>
<div id="lst-la_init_llm" class="listing">
<p>列表&nbsp;14.2: 初始化基本 LLM</p>
<div class="sourceCode" id="lst-la_init_llm" data-lst-cap="初始化基本 LLM"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="lst-la_init_llm-1"><a href="#lst-la_init_llm-1"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ErnieBotChat</span>
<span id="lst-la_init_llm-2"><a href="#lst-la_init_llm-2"></a></span>
<span id="lst-la_init_llm-3"><a href="#lst-la_init_llm-3"></a>llm <span class="op">=</span> ErnieBotChat()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="初始化-tool" class="level3" data-number="14.1.2">
<h3 data-number="14.1.2" class="anchored" data-anchor-id="初始化-tool"><span class="header-section-number">14.1.2</span> 初始化 Tool</h3>
<p>然后，我们来初始化工具。在初始化工具时，我们要么创建自定义的工具，要么加载 LangChain 已经构建好的工具。不管是以哪种方式初始化工具，在 LangChain 中，工具都是一个包含 <code>name</code> 和 <code>description</code> 属性的具备某种特定能力的 <code>Chain</code>。</p>
<p>我们可以使用 LangChain 提供的 <code>LLMMathChain</code> 来构造一个用于计算数学表达式的工具。</p>
<div id="lst-la_init_tools_calc" class="listing">
<p>列表&nbsp;14.3: 初始化数学计算工具</p>
<div class="sourceCode" id="lst-la_init_tools_calc" data-lst-cap="初始化数学计算工具"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="lst-la_init_tools_calc-1"><a href="#lst-la_init_tools_calc-1"></a><span class="im">from</span> langchain.chains <span class="im">import</span> LLMMathChain</span>
<span id="lst-la_init_tools_calc-2"><a href="#lst-la_init_tools_calc-2"></a><span class="im">from</span> langchain.agents <span class="im">import</span> Tool</span>
<span id="lst-la_init_tools_calc-3"><a href="#lst-la_init_tools_calc-3"></a></span>
<span id="lst-la_init_tools_calc-4"><a href="#lst-la_init_tools_calc-4"></a>llm_math <span class="op">=</span> LLMMathChain(llm<span class="op">=</span>llm)</span>
<span id="lst-la_init_tools_calc-5"><a href="#lst-la_init_tools_calc-5"></a></span>
<span id="lst-la_init_tools_calc-6"><a href="#lst-la_init_tools_calc-6"></a><span class="co"># initialize the math tool</span></span>
<span id="lst-la_init_tools_calc-7"><a href="#lst-la_init_tools_calc-7"></a>math_tool <span class="op">=</span> Tool(</span>
<span id="lst-la_init_tools_calc-8"><a href="#lst-la_init_tools_calc-8"></a>    name<span class="op">=</span><span class="st">'Calculator'</span>,</span>
<span id="lst-la_init_tools_calc-9"><a href="#lst-la_init_tools_calc-9"></a>    func<span class="op">=</span>llm_math.run,</span>
<span id="lst-la_init_tools_calc-10"><a href="#lst-la_init_tools_calc-10"></a>    description<span class="op">=</span><span class="st">'Useful for when you need to answer questions about math.'</span></span>
<span id="lst-la_init_tools_calc-11"><a href="#lst-la_init_tools_calc-11"></a>)</span>
<span id="lst-la_init_tools_calc-12"><a href="#lst-la_init_tools_calc-12"></a></span>
<span id="lst-la_init_tools_calc-13"><a href="#lst-la_init_tools_calc-13"></a>tools <span class="op">=</span> [math_tool]</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
提示
</div>
</div>
<div class="callout-body-container callout-body">
<p>在初始化工具时，要特别注意对 <code>description</code> 属性的赋值。因为 Agent 主要根据该属性值来判断接下来将要采用哪个工具来执行后续的操作。优秀的 <code>description</code> 有利于最终任务的完美解决。</p>
</div>
</div>
<p>当然，LangChain 为我们提供了构建好的 <code>llm_math</code> 工具，我们可以使用如下的方式直接加载：</p>
<div id="lst-la_init_tools_calc_2" class="listing">
<p>列表&nbsp;14.4: 使用 load_tools() 初始化数学计算工具</p>
<div class="sourceCode" id="lst-la_init_tools_calc_2" data-lst-cap="使用 load_tools() 初始化数学计算工具"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="lst-la_init_tools_calc_2-1"><a href="#lst-la_init_tools_calc_2-1"></a><span class="im">from</span> langchain.agents <span class="im">import</span> load_tools</span>
<span id="lst-la_init_tools_calc_2-2"><a href="#lst-la_init_tools_calc_2-2"></a></span>
<span id="lst-la_init_tools_calc_2-3"><a href="#lst-la_init_tools_calc_2-3"></a>tools <span class="op">=</span> load_tools(</span>
<span id="lst-la_init_tools_calc_2-4"><a href="#lst-la_init_tools_calc_2-4"></a>    [<span class="st">'llm-math'</span>],</span>
<span id="lst-la_init_tools_calc_2-5"><a href="#lst-la_init_tools_calc_2-5"></a>    llm<span class="op">=</span>llm</span>
<span id="lst-la_init_tools_calc_2-6"><a href="#lst-la_init_tools_calc_2-6"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如果查看一下 <code>langchain/agents/load_tools.py</code> 中对 <code>load_tools()</code> 的定义，我们会发现，LangChain 提供的预定义的工具和我们在 <a href="#lst-la_init_tools_calc">列表&nbsp;<span>14.3</span></a> 中自己定义的工具是基本一致的：</p>
<div id="lst-la_init_tools_calc_3" class="listing">
<p>列表&nbsp;14.5: _get_llm_math() 创建数学计算工具</p>
<div class="sourceCode" id="lst-la_init_tools_calc_3" data-lst-cap="_get_llm_math() 创建数学计算工具"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="lst-la_init_tools_calc_3-1"><a href="#lst-la_init_tools_calc_3-1"></a><span class="kw">def</span> _get_llm_math(llm: BaseLanguageModel) <span class="op">-&gt;</span> BaseTool:</span>
<span id="lst-la_init_tools_calc_3-2"><a href="#lst-la_init_tools_calc_3-2"></a>    <span class="cf">return</span> Tool(</span>
<span id="lst-la_init_tools_calc_3-3"><a href="#lst-la_init_tools_calc_3-3"></a>        name<span class="op">=</span><span class="st">"Calculator"</span>,</span>
<span id="lst-la_init_tools_calc_3-4"><a href="#lst-la_init_tools_calc_3-4"></a>        description<span class="op">=</span><span class="st">"Useful for when you need to answer questions about math."</span>,</span>
<span id="lst-la_init_tools_calc_3-5"><a href="#lst-la_init_tools_calc_3-5"></a>        func<span class="op">=</span>LLMMathChain.from_llm(llm<span class="op">=</span>llm).run,</span>
<span id="lst-la_init_tools_calc_3-6"><a href="#lst-la_init_tools_calc_3-6"></a>        coroutine<span class="op">=</span>LLMMathChain.from_llm(llm<span class="op">=</span>llm).arun,</span>
<span id="lst-la_init_tools_calc_3-7"><a href="#lst-la_init_tools_calc_3-7"></a>    )</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
提示
</div>
</div>
<div class="callout-body-container callout-body">
<p>可以通过调用 <code>get_all_tool_names()</code> 来获取 LangChain 支持的所有的预定义的工具，该函数的实现位于 <code>langchain/agents/load_tools.py</code>。</p>
<pre><code>def get_all_tool_names() -&gt; List[str]:
    """Get a list of all possible tool names."""
    return (
        list(_BASE_TOOLS)
        + list(_EXTRA_OPTIONAL_TOOLS)
        + list(_EXTRA_LLM_TOOLS)
        + list(_LLM_TOOLS)
    )</code></pre>
</div>
</div>
</section>
<section id="初始化-agent" class="level3" data-number="14.1.3">
<h3 data-number="14.1.3" class="anchored" data-anchor-id="初始化-agent"><span class="header-section-number">14.1.3</span> 初始化 Agent</h3>
<p>在 LangChain 中，可以使用 <a href="#lst-la_initialize_agent">列表&nbsp;<span>14.1</span></a> 所示的 <code>initialize_agent</code> 来初始化 Agent：</p>
<div id="lst-la_init_agent_2" class="listing">
<p>列表&nbsp;14.6: 初始化 Agent</p>
<div class="sourceCode" id="lst-la_init_agent_2" data-lst-cap="初始化 Agent"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="lst-la_init_agent_2-1"><a href="#lst-la_init_agent_2-1"></a><span class="im">from</span> langchain.agents <span class="im">import</span> initialize_agent</span>
<span id="lst-la_init_agent_2-2"><a href="#lst-la_init_agent_2-2"></a></span>
<span id="lst-la_init_agent_2-3"><a href="#lst-la_init_agent_2-3"></a>zero_shot_agent <span class="op">=</span> initialize_agent(</span>
<span id="lst-la_init_agent_2-4"><a href="#lst-la_init_agent_2-4"></a>    agent<span class="op">=</span><span class="st">"zero-shot-react-description"</span>,</span>
<span id="lst-la_init_agent_2-5"><a href="#lst-la_init_agent_2-5"></a>    tools<span class="op">=</span>tools,</span>
<span id="lst-la_init_agent_2-6"><a href="#lst-la_init_agent_2-6"></a>    llm<span class="op">=</span>llm,</span>
<span id="lst-la_init_agent_2-7"><a href="#lst-la_init_agent_2-7"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="lst-la_init_agent_2-8"><a href="#lst-la_init_agent_2-8"></a>    max_iterations<span class="op">=</span><span class="dv">3</span></span>
<span id="lst-la_init_agent_2-9"><a href="#lst-la_init_agent_2-9"></a>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#lst-la_init_agent_2">列表&nbsp;<span>14.6</span></a> 中使用 <code>zero-shot-react-description</code> 初始化了一个 <code>zero-shot</code> Agent。<code>zero-shot</code> 意味着该 Agent 仅会根据当前的行为来其作用，它是一个无状态的、无记忆能力的 Agent，无法根据历史的行为起作用。该 Agent 会根据我们在 <a href="agent_intro.html#sec-agent_react"><span>章节&nbsp;8.3</span></a> 中提到的 ReAct 模式并根据当前的行为来判断接下来要调用哪个工具来完成任务。如前所述，Agent 主要根据 <code>Tool.description</code> 决策调用哪个工具，因此，务必保证改描述的准确性。</p>
<section id="agent-类型" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="agent-类型">Agent 类型</h4>
<p>想要了解 LangChain 支持的 Agent 类型，可以参考 <code>langchain/agent/agent_types.py</code> 文件：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AgentType(<span class="bu">str</span>, Enum):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Enumerator with the Agent types."""</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    ZERO_SHOT_REACT_DESCRIPTION <span class="op">=</span> <span class="st">"zero-shot-react-description"</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    REACT_DOCSTORE <span class="op">=</span> <span class="st">"react-docstore"</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    SELF_ASK_WITH_SEARCH <span class="op">=</span> <span class="st">"self-ask-with-search"</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    CONVERSATIONAL_REACT_DESCRIPTION <span class="op">=</span> <span class="st">"conversational-react-description"</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    CHAT_ZERO_SHOT_REACT_DESCRIPTION <span class="op">=</span> <span class="st">"chat-zero-shot-react-description"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    CHAT_CONVERSATIONAL_REACT_DESCRIPTION <span class="op">=</span> <span class="st">"chat-conversational-react-description"</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION <span class="op">=</span> (</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"structured-chat-zero-shot-react-description"</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    OPENAI_FUNCTIONS <span class="op">=</span> <span class="st">"openai-functions"</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    OPENAI_MULTI_FUNCTIONS <span class="op">=</span> <span class="st">"openai-multi-functions"</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>而不同的 Agent 类型和具体的实现之间的映射关系位于 <code>langchain/agent/types.py</code> 的 <code>AGENT_TO_CLASS</code> 字典中。</p>
<div id="lst-map_agent_type_class" class="listing">
<p>列表&nbsp;14.7: Agent 类型和具体实现的映射关系</p>
<div class="sourceCode" id="lst-map_agent_type_class" data-lst-cap="Agent 类型和具体实现的映射关系"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-map_agent_type_class-1"><a href="#lst-map_agent_type_class-1" aria-hidden="true" tabindex="-1"></a>AGENT_TO_CLASS: Dict[AgentType, AGENT_TYPE] <span class="op">=</span> {</span>
<span id="lst-map_agent_type_class-2"><a href="#lst-map_agent_type_class-2" aria-hidden="true" tabindex="-1"></a>    AgentType.ZERO_SHOT_REACT_DESCRIPTION: ZeroShotAgent,</span>
<span id="lst-map_agent_type_class-3"><a href="#lst-map_agent_type_class-3" aria-hidden="true" tabindex="-1"></a>    AgentType.REACT_DOCSTORE: ReActDocstoreAgent,</span>
<span id="lst-map_agent_type_class-4"><a href="#lst-map_agent_type_class-4" aria-hidden="true" tabindex="-1"></a>    AgentType.SELF_ASK_WITH_SEARCH: SelfAskWithSearchAgent,</span>
<span id="lst-map_agent_type_class-5"><a href="#lst-map_agent_type_class-5" aria-hidden="true" tabindex="-1"></a>    AgentType.CONVERSATIONAL_REACT_DESCRIPTION: ConversationalAgent,</span>
<span id="lst-map_agent_type_class-6"><a href="#lst-map_agent_type_class-6" aria-hidden="true" tabindex="-1"></a>    AgentType.CHAT_ZERO_SHOT_REACT_DESCRIPTION: ChatAgent,</span>
<span id="lst-map_agent_type_class-7"><a href="#lst-map_agent_type_class-7" aria-hidden="true" tabindex="-1"></a>    AgentType.CHAT_CONVERSATIONAL_REACT_DESCRIPTION: ConversationalChatAgent,</span>
<span id="lst-map_agent_type_class-8"><a href="#lst-map_agent_type_class-8" aria-hidden="true" tabindex="-1"></a>    AgentType.STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION: StructuredChatAgent,</span>
<span id="lst-map_agent_type_class-9"><a href="#lst-map_agent_type_class-9" aria-hidden="true" tabindex="-1"></a>    AgentType.OPENAI_FUNCTIONS: OpenAIFunctionsAgent,</span>
<span id="lst-map_agent_type_class-10"><a href="#lst-map_agent_type_class-10" aria-hidden="true" tabindex="-1"></a>    AgentType.OPENAI_MULTI_FUNCTIONS: OpenAIMultiFunctionsAgent,</span>
<span id="lst-map_agent_type_class-11"><a href="#lst-map_agent_type_class-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>由此可知，<code>zero-shot-react-description</code> Agent 的定义位于 <code>langchain/agents/mrkl/base.py</code> 中的 <code>ZeroShotAgent</code> 类。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
提示
</div>
</div>
<div class="callout-body-container callout-body">
<p>MRKL 是 <code>Modular Reasoning, Knowledge and Language</code> 的简称，该系统的详细信息参见 <span class="citation" data-cites="karpas2022mrkl">[<a href="references.html#ref-karpas2022mrkl" role="doc-biblioref">1</a>]</span>。</p>
</div>
</div>
</section>
</section>
</section>
<section id="zero-shot-agent" class="level2" data-number="14.2">
<h2 data-number="14.2" class="anchored" data-anchor-id="zero-shot-agent"><span class="header-section-number">14.2</span> Zero Shot Agent</h2>
<p>我们将如上的三大组件整合起来，得到了一个简单的 zero shot Agent 的例子：</p>
<div id="lst-la_zero_shot_demo" class="listing">
<p>列表&nbsp;14.8: zero-shot Agent</p>
<div class="sourceCode" id="lst-la_zero_shot_demo" data-lst-cap="zero-shot Agent"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="lst-la_zero_shot_demo-1"><a href="#lst-la_zero_shot_demo-1"></a><span class="co">#encoding: utf-8</span></span>
<span id="lst-la_zero_shot_demo-2"><a href="#lst-la_zero_shot_demo-2"></a></span>
<span id="lst-la_zero_shot_demo-3"><a href="#lst-la_zero_shot_demo-3"></a><span class="co">"""</span></span>
<span id="lst-la_zero_shot_demo-4"><a href="#lst-la_zero_shot_demo-4"></a><span class="co">@discribe: example for zero shot agent.</span></span>
<span id="lst-la_zero_shot_demo-5"><a href="#lst-la_zero_shot_demo-5"></a><span class="co">@author: wangwei1237@gmail.com</span></span>
<span id="lst-la_zero_shot_demo-6"><a href="#lst-la_zero_shot_demo-6"></a><span class="co">"""</span></span>
<span id="lst-la_zero_shot_demo-7"><a href="#lst-la_zero_shot_demo-7"></a></span>
<span id="lst-la_zero_shot_demo-8"><a href="#lst-la_zero_shot_demo-8"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ErnieBotChat</span>
<span id="lst-la_zero_shot_demo-9"><a href="#lst-la_zero_shot_demo-9"></a><span class="im">from</span> langchain.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="lst-la_zero_shot_demo-10"><a href="#lst-la_zero_shot_demo-10"></a><span class="im">from</span> langchain.chains <span class="im">import</span> LLMChain</span>
<span id="lst-la_zero_shot_demo-11"><a href="#lst-la_zero_shot_demo-11"></a><span class="im">from</span> langchain.chains <span class="im">import</span> LLMMathChain</span>
<span id="lst-la_zero_shot_demo-12"><a href="#lst-la_zero_shot_demo-12"></a><span class="im">from</span> langchain.agents <span class="im">import</span> Tool</span>
<span id="lst-la_zero_shot_demo-13"><a href="#lst-la_zero_shot_demo-13"></a><span class="im">from</span> langchain.agents <span class="im">import</span> initialize_agent</span>
<span id="lst-la_zero_shot_demo-14"><a href="#lst-la_zero_shot_demo-14"></a></span>
<span id="lst-la_zero_shot_demo-15"><a href="#lst-la_zero_shot_demo-15"></a>llm <span class="op">=</span> ErnieBotChat()</span>
<span id="lst-la_zero_shot_demo-16"><a href="#lst-la_zero_shot_demo-16"></a>llm_math <span class="op">=</span> LLMMathChain(llm<span class="op">=</span>llm)</span>
<span id="lst-la_zero_shot_demo-17"><a href="#lst-la_zero_shot_demo-17"></a></span>
<span id="lst-la_zero_shot_demo-18"><a href="#lst-la_zero_shot_demo-18"></a>template <span class="op">=</span> ChatPromptTemplate.from_messages([</span>
<span id="lst-la_zero_shot_demo-19"><a href="#lst-la_zero_shot_demo-19"></a>    (<span class="st">"user"</span>, <span class="st">"你是一个能力非凡的人工智能机器人。"</span>),</span>
<span id="lst-la_zero_shot_demo-20"><a href="#lst-la_zero_shot_demo-20"></a>    (<span class="st">"assistant"</span>, <span class="st">"你好~"</span>),</span>
<span id="lst-la_zero_shot_demo-21"><a href="#lst-la_zero_shot_demo-21"></a>    (<span class="st">"user"</span>, <span class="st">"</span><span class="sc">{user_input}</span><span class="st">"</span>),</span>
<span id="lst-la_zero_shot_demo-22"><a href="#lst-la_zero_shot_demo-22"></a>])</span>
<span id="lst-la_zero_shot_demo-23"><a href="#lst-la_zero_shot_demo-23"></a>llm_chain <span class="op">=</span> LLMChain(llm<span class="op">=</span>llm, prompt<span class="op">=</span>template)</span>
<span id="lst-la_zero_shot_demo-24"><a href="#lst-la_zero_shot_demo-24"></a></span>
<span id="lst-la_zero_shot_demo-25"><a href="#lst-la_zero_shot_demo-25"></a><span class="co"># initialize the math tool</span></span>
<span id="lst-la_zero_shot_demo-26"><a href="#lst-la_zero_shot_demo-26"></a>math_tool <span class="op">=</span> Tool(</span>
<span id="lst-la_zero_shot_demo-27"><a href="#lst-la_zero_shot_demo-27"></a>    name<span class="op">=</span><span class="st">'Calculator'</span>,</span>
<span id="lst-la_zero_shot_demo-28"><a href="#lst-la_zero_shot_demo-28"></a>    func<span class="op">=</span>llm_math.run,</span>
<span id="lst-la_zero_shot_demo-29"><a href="#lst-la_zero_shot_demo-29"></a>    description<span class="op">=</span><span class="st">'Useful for when you need to answer questions about math.'</span></span>
<span id="lst-la_zero_shot_demo-30"><a href="#lst-la_zero_shot_demo-30"></a>)</span>
<span id="lst-la_zero_shot_demo-31"><a href="#lst-la_zero_shot_demo-31"></a></span>
<span id="lst-la_zero_shot_demo-32"><a href="#lst-la_zero_shot_demo-32"></a><span class="co"># initialize the general LLM tool</span></span>
<span id="lst-la_zero_shot_demo-33"><a href="#lst-la_zero_shot_demo-33"></a>llm_tool <span class="op">=</span> Tool(</span>
<span id="lst-la_zero_shot_demo-34"><a href="#lst-la_zero_shot_demo-34"></a>    name<span class="op">=</span><span class="st">'Language Model'</span>,</span>
<span id="lst-la_zero_shot_demo-35"><a href="#lst-la_zero_shot_demo-35"></a>    func<span class="op">=</span>llm_chain.run,</span>
<span id="lst-la_zero_shot_demo-36"><a href="#lst-la_zero_shot_demo-36"></a>    description<span class="op">=</span><span class="st">'use this tool for general purpose queries.'</span></span>
<span id="lst-la_zero_shot_demo-37"><a href="#lst-la_zero_shot_demo-37"></a>)</span>
<span id="lst-la_zero_shot_demo-38"><a href="#lst-la_zero_shot_demo-38"></a></span>
<span id="lst-la_zero_shot_demo-39"><a href="#lst-la_zero_shot_demo-39"></a><span class="co"># when giving tools to LLM, we must pass as list of tools</span></span>
<span id="lst-la_zero_shot_demo-40"><a href="#lst-la_zero_shot_demo-40"></a>tools <span class="op">=</span> [math_tool, llm_tool]</span>
<span id="lst-la_zero_shot_demo-41"><a href="#lst-la_zero_shot_demo-41"></a></span>
<span id="lst-la_zero_shot_demo-42"><a href="#lst-la_zero_shot_demo-42"></a>zero_shot_agent <span class="op">=</span> initialize_agent(</span>
<span id="lst-la_zero_shot_demo-43"><a href="#lst-la_zero_shot_demo-43"></a>    agent<span class="op">=</span><span class="st">"zero-shot-react-description"</span>,</span>
<span id="lst-la_zero_shot_demo-44"><a href="#lst-la_zero_shot_demo-44"></a>    tools<span class="op">=</span>tools,</span>
<span id="lst-la_zero_shot_demo-45"><a href="#lst-la_zero_shot_demo-45"></a>    llm<span class="op">=</span>llm,</span>
<span id="lst-la_zero_shot_demo-46"><a href="#lst-la_zero_shot_demo-46"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="lst-la_zero_shot_demo-47"><a href="#lst-la_zero_shot_demo-47"></a>    max_iterations<span class="op">=</span><span class="dv">3</span></span>
<span id="lst-la_zero_shot_demo-48"><a href="#lst-la_zero_shot_demo-48"></a>)</span>
<span id="lst-la_zero_shot_demo-49"><a href="#lst-la_zero_shot_demo-49"></a></span>
<span id="lst-la_zero_shot_demo-50"><a href="#lst-la_zero_shot_demo-50"></a>res <span class="op">=</span> zero_shot_agent(<span class="st">"what's 4.1*7.9=?"</span>)</span>
<span id="lst-la_zero_shot_demo-51"><a href="#lst-la_zero_shot_demo-51"></a><span class="bu">print</span>(res)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="#lst-la_zero_shot_demo">列表&nbsp;<span>14.8</span></a> 的运行结果如下：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> Entering <span class="ex">new</span> AgentExecutor chain...</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Action:</span> Calculator</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Action</span> Input: 4.1<span class="pp">*</span>7.9</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Observation:</span> 32.39</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Thought:</span> I<span class="st">'m happy with the result</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">Final Answer: 32.39</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>我们可以继续问其他的问题：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> zero_shot_agent(<span class="st">"what's the capital of China?"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(res)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Action: Calculator</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Action Input: country code + search term (capital)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Observation: capital of China is Beijing</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Thought: hmm... looks good. Let's think of another question</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Action: Language Model</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Action Input: weather in Beijing</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Observation: the weather in Beijing is usually good</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">#Thought: alright, seems like that question is also answered well</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Final Answer: The capital of China is Beijing and the weather is usually good there.</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
警告
</div>
</div>
<div class="callout-body-container callout-body">
<p>当然，在解决实际问题中，Agent 的 ReAct 过程可能会有差异，这些差异可能是因为 LLM 的能力导致的，例如指令遵循的能力，上下文学习的能力等。</p>
<p>在我使用文心的过程中，经常会报如下的异常：</p>
<div id="lst-lc_agent_llm_error" class="listing">
<p>列表&nbsp;14.9: Agent 执行异常的问题</p>
<div class="sourceCode" id="lst-lc_agent_llm_error" data-lst-cap="Agent 执行异常的问题"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="lst-lc_agent_llm_error-1"><a href="#lst-lc_agent_llm_error-1" aria-hidden="true" tabindex="-1"></a><span class="ex">raise</span> OutputParserException<span class="er">(</span></span>
<span id="lst-lc_agent_llm_error-2"><a href="#lst-lc_agent_llm_error-2" aria-hidden="true" tabindex="-1"></a><span class="ex">langchain.schema.output_parser.OutputParserException:</span> Parsing LLM output produced both a final answer and a parse-able action:: Thought: what<span class="st">'s 3*4? - You should always think about what to do</span></span>
<span id="lst-lc_agent_llm_error-3"><a href="#lst-lc_agent_llm_error-3" aria-hidden="true" tabindex="-1"></a><span class="st">Action: use calculator</span></span>
<span id="lst-lc_agent_llm_error-4"><a href="#lst-lc_agent_llm_error-4" aria-hidden="true" tabindex="-1"></a><span class="st">Action Input: 3*4</span></span>
<span id="lst-lc_agent_llm_error-5"><a href="#lst-lc_agent_llm_error-5" aria-hidden="true" tabindex="-1"></a><span class="st">Observation: 12</span></span>
<span id="lst-lc_agent_llm_error-6"><a href="#lst-lc_agent_llm_error-6" aria-hidden="true" tabindex="-1"></a><span class="st">...</span></span>
<span id="lst-lc_agent_llm_error-7"><a href="#lst-lc_agent_llm_error-7" aria-hidden="true" tabindex="-1"></a><span class="st">Thought: Good, moving on</span></span>
<span id="lst-lc_agent_llm_error-8"><a href="#lst-lc_agent_llm_error-8" aria-hidden="true" tabindex="-1"></a><span class="st">Final Answer: 12</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>如异常信息所示，异常的原因是因为 Agent 在解析文心大模型的返回结果时，当大模型给出了 <code>Action</code> 之后，同时又给出了 <code>Final Answer</code>。哎呀，真是头疼，LLM 即给了接下来要调用 <code>calculator</code> 来完成任务，但是呢，Agent 还没有调用的时候，LLM 直接给了 <code>Final Answer</code>，那 Agent 的作用不就完全丧失了吗？这完全不按套路出牌呀！</p>
<p>值得兴奋的是，2023 年 10 月 17 日，百度世界大会上发布了 文心 4.0，我们发现 文心 4.0 在 ICL、指令遵循、推理能力上都有比较大的提升。而 文心 4.0 也比较好的解决了如上的推理问题。</p>
</div>
</div>
<section id="深入-zero-shot-agent" class="level3" data-number="14.2.1">
<h3 data-number="14.2.1" class="anchored" data-anchor-id="深入-zero-shot-agent"><span class="header-section-number">14.2.1</span> 深入 Zero Shot Agent</h3>
<p>我们之前说过，Agent 本质上也是一个 <code>chain</code>，那么我们来看下 Zero Shot Agent 的提示词究竟是怎么实现 <code>推理</code> -&gt; <code>行动</code> -&gt; <code>行动输入</code> -&gt; <code>观察结果</code> 这个循环的。</p>
<p>可以使用如下代码来显示 Agent 的提示词：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(zero_shot_agent.agent.llm_chain.prompt.template)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="lst-la_init_agent_2_prompt" class="listing">
<p>列表&nbsp;14.10: Zero Shot Agent 的提示词</p>
<div class="sourceCode" id="lst-la_init_agent_2_prompt" data-lst-cap="Zero Shot Agent 的提示词"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="lst-la_init_agent_2_prompt-1"><a href="#lst-la_init_agent_2_prompt-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Answer</span> the following questions as best you can. You have access to the following tools:</span>
<span id="lst-la_init_agent_2_prompt-2"><a href="#lst-la_init_agent_2_prompt-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_2_prompt-3"><a href="#lst-la_init_agent_2_prompt-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Calculator:</span> Useful for when you need to answer questions about math.</span>
<span id="lst-la_init_agent_2_prompt-4"><a href="#lst-la_init_agent_2_prompt-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Language</span> Model: use this tool for general purpose queries and logic</span>
<span id="lst-la_init_agent_2_prompt-5"><a href="#lst-la_init_agent_2_prompt-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_2_prompt-6"><a href="#lst-la_init_agent_2_prompt-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Use</span> the following format:</span>
<span id="lst-la_init_agent_2_prompt-7"><a href="#lst-la_init_agent_2_prompt-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_2_prompt-8"><a href="#lst-la_init_agent_2_prompt-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Question:</span> the input question you must answer</span>
<span id="lst-la_init_agent_2_prompt-9"><a href="#lst-la_init_agent_2_prompt-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Thought:</span> you should always think about what to do</span>
<span id="lst-la_init_agent_2_prompt-10"><a href="#lst-la_init_agent_2_prompt-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Action:</span> the action to take, should be one of [Calculator, Language Model]</span>
<span id="lst-la_init_agent_2_prompt-11"><a href="#lst-la_init_agent_2_prompt-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Action</span> Input: the input to the action</span>
<span id="lst-la_init_agent_2_prompt-12"><a href="#lst-la_init_agent_2_prompt-12" aria-hidden="true" tabindex="-1"></a><span class="ex">Observation:</span> the result of the action</span>
<span id="lst-la_init_agent_2_prompt-13"><a href="#lst-la_init_agent_2_prompt-13" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span> <span class="er">(</span><span class="ex">this</span> Thought/Action/Action Input/Observation can repeat N times<span class="kw">)</span></span>
<span id="lst-la_init_agent_2_prompt-14"><a href="#lst-la_init_agent_2_prompt-14" aria-hidden="true" tabindex="-1"></a><span class="ex">Thought:</span> I now know the final answer</span>
<span id="lst-la_init_agent_2_prompt-15"><a href="#lst-la_init_agent_2_prompt-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Final</span> Answer: the final answer to the original input question</span>
<span id="lst-la_init_agent_2_prompt-16"><a href="#lst-la_init_agent_2_prompt-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_2_prompt-17"><a href="#lst-la_init_agent_2_prompt-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Begin!</span></span>
<span id="lst-la_init_agent_2_prompt-18"><a href="#lst-la_init_agent_2_prompt-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_2_prompt-19"><a href="#lst-la_init_agent_2_prompt-19" aria-hidden="true" tabindex="-1"></a><span class="ex">Question:</span> {input}</span>
<span id="lst-la_init_agent_2_prompt-20"><a href="#lst-la_init_agent_2_prompt-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Thought:{agent_scratchpad}</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>根据上面的提示词，我们也能发现，文心大模型确实没有很好的进行指令遵循。所幸的是，2023 年 10 月 17 日，百度世界大会上发布了 文心 4.0，我们发现 文心 4.0 在 ICL、指令遵循、推理能力上都有比较大的提升。如上的提示词的生成逻辑可以参见：<code>langchain/agents/mrkl/base.py</code> 中的 <code>create_prompt()</code>。</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
提示
</div>
</div>
<div class="callout-body-container callout-body">
<p>在 <a href="#lst-la_init_agent_2_prompt">列表&nbsp;<span>14.10</span></a> 中，提示词的最后一行是 <code>Thought:{agent_scratchpad}</code>。 <code>agent_scratchpad</code> 保存了代理已经执行的所有想法或行动，下一次的 <code>思考</code> -&gt; <code>行动</code> -&gt; <code>观察</code> 循环可以通过 <code>agent_scratchpad</code> 访问到历史的所有想法和行动，从而实现代理行动的连续性。</p>
</div>
</div>
</section>
</section>
<section id="conversational-agent" class="level2" data-number="14.3">
<h2 data-number="14.3" class="anchored" data-anchor-id="conversational-agent"><span class="header-section-number">14.3</span> Conversational Agent</h2>
<p>Zero Shot Agent 虽然可以解决很多场景下的任务，但是它没有会话记忆的能力。对于聊天机器人之类的应用而言，缺乏记忆能力可能会成为问题。例如，如下的连续对话：</p>
<ul>
<li>1768年，中国有什么重大事件发生？</li>
<li>同年，其他国家有什么重大事件发生？</li>
</ul>
<p>幸运的是，LangChain 为我们提供了支持记忆能力的 Agent，可以使用 <code>conversational-react-description</code> 来初始化具备记忆能力的 Agent。除了拥有记忆之外，Conversational Agent 和 Zero Shot Agent 是一致的。</p>
<div id="lst-la_conversation_demo" class="listing">
<p>列表&nbsp;14.11: Conversation Agent</p>
<div class="sourceCode" id="lst-la_conversation_demo" data-lst-cap="Conversation Agent"><pre class="sourceCode numberSource python code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode python"><span id="lst-la_conversation_demo-1"><a href="#lst-la_conversation_demo-1"></a><span class="co">#encoding: utf-8</span></span>
<span id="lst-la_conversation_demo-2"><a href="#lst-la_conversation_demo-2"></a></span>
<span id="lst-la_conversation_demo-3"><a href="#lst-la_conversation_demo-3"></a><span class="co">"""</span></span>
<span id="lst-la_conversation_demo-4"><a href="#lst-la_conversation_demo-4"></a><span class="co">@discribe: example for conversation agent.</span></span>
<span id="lst-la_conversation_demo-5"><a href="#lst-la_conversation_demo-5"></a><span class="co">@author: wangwei1237@gmail.com</span></span>
<span id="lst-la_conversation_demo-6"><a href="#lst-la_conversation_demo-6"></a><span class="co">"""</span></span>
<span id="lst-la_conversation_demo-7"><a href="#lst-la_conversation_demo-7"></a></span>
<span id="lst-la_conversation_demo-8"><a href="#lst-la_conversation_demo-8"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ErnieBotChat</span>
<span id="lst-la_conversation_demo-9"><a href="#lst-la_conversation_demo-9"></a><span class="im">from</span> langchain.prompts <span class="im">import</span> ChatPromptTemplate</span>
<span id="lst-la_conversation_demo-10"><a href="#lst-la_conversation_demo-10"></a><span class="im">from</span> langchain.chains <span class="im">import</span> LLMChain</span>
<span id="lst-la_conversation_demo-11"><a href="#lst-la_conversation_demo-11"></a><span class="im">from</span> langchain.chains <span class="im">import</span> LLMMathChain</span>
<span id="lst-la_conversation_demo-12"><a href="#lst-la_conversation_demo-12"></a><span class="im">from</span> langchain.agents <span class="im">import</span> Tool</span>
<a class="code-annotation-anchor" data-target-cell="lst-la_conversation_demo" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="lst-la_conversation_demo-13" class="code-annotation-target"><a href="#lst-la_conversation_demo-13"></a><span class="im">from</span> langchain.memory <span class="im">import</span> ConversationBufferMemory</span>
<span id="lst-la_conversation_demo-14"><a href="#lst-la_conversation_demo-14"></a><span class="im">from</span> langchain.agents <span class="im">import</span> initialize_agent</span>
<span id="lst-la_conversation_demo-15"><a href="#lst-la_conversation_demo-15"></a></span>
<a class="code-annotation-anchor" data-target-cell="lst-la_conversation_demo" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="lst-la_conversation_demo-16" class="code-annotation-target"><a href="#lst-la_conversation_demo-16"></a>memory <span class="op">=</span> ConversationBufferMemory(memory_key<span class="op">=</span><span class="st">"chat_history"</span>)</span>
<span id="lst-la_conversation_demo-17"><a href="#lst-la_conversation_demo-17"></a></span>
<span id="lst-la_conversation_demo-18"><a href="#lst-la_conversation_demo-18"></a>llm <span class="op">=</span> ErnieBotChat()</span>
<span id="lst-la_conversation_demo-19"><a href="#lst-la_conversation_demo-19"></a>llm_math <span class="op">=</span> LLMMathChain(llm<span class="op">=</span>llm)</span>
<span id="lst-la_conversation_demo-20"><a href="#lst-la_conversation_demo-20"></a></span>
<span id="lst-la_conversation_demo-21"><a href="#lst-la_conversation_demo-21"></a>template <span class="op">=</span> ChatPromptTemplate.from_messages([</span>
<span id="lst-la_conversation_demo-22"><a href="#lst-la_conversation_demo-22"></a>    (<span class="st">"user"</span>, <span class="st">"你是一个能力非凡的人工智能机器人。"</span>),</span>
<span id="lst-la_conversation_demo-23"><a href="#lst-la_conversation_demo-23"></a>    (<span class="st">"assistant"</span>, <span class="st">"你好~"</span>),</span>
<span id="lst-la_conversation_demo-24"><a href="#lst-la_conversation_demo-24"></a>    (<span class="st">"user"</span>, <span class="st">"</span><span class="sc">{user_input}</span><span class="st">"</span>),</span>
<span id="lst-la_conversation_demo-25"><a href="#lst-la_conversation_demo-25"></a>])</span>
<span id="lst-la_conversation_demo-26"><a href="#lst-la_conversation_demo-26"></a>llm_chain <span class="op">=</span> LLMChain(llm<span class="op">=</span>llm, prompt<span class="op">=</span>template)</span>
<span id="lst-la_conversation_demo-27"><a href="#lst-la_conversation_demo-27"></a></span>
<span id="lst-la_conversation_demo-28"><a href="#lst-la_conversation_demo-28"></a><span class="co"># initialize the math tool</span></span>
<span id="lst-la_conversation_demo-29"><a href="#lst-la_conversation_demo-29"></a>math_tool <span class="op">=</span> Tool(</span>
<span id="lst-la_conversation_demo-30"><a href="#lst-la_conversation_demo-30"></a>    name<span class="op">=</span><span class="st">'Calculator'</span>,</span>
<span id="lst-la_conversation_demo-31"><a href="#lst-la_conversation_demo-31"></a>    func<span class="op">=</span>llm_math.run,</span>
<span id="lst-la_conversation_demo-32"><a href="#lst-la_conversation_demo-32"></a>    description<span class="op">=</span><span class="st">'Useful for when you need to answer questions about math.'</span></span>
<span id="lst-la_conversation_demo-33"><a href="#lst-la_conversation_demo-33"></a>)</span>
<span id="lst-la_conversation_demo-34"><a href="#lst-la_conversation_demo-34"></a></span>
<span id="lst-la_conversation_demo-35"><a href="#lst-la_conversation_demo-35"></a><span class="co"># initialize the general LLM tool</span></span>
<span id="lst-la_conversation_demo-36"><a href="#lst-la_conversation_demo-36"></a>llm_tool <span class="op">=</span> Tool(</span>
<span id="lst-la_conversation_demo-37"><a href="#lst-la_conversation_demo-37"></a>    name<span class="op">=</span><span class="st">'Language Model'</span>,</span>
<span id="lst-la_conversation_demo-38"><a href="#lst-la_conversation_demo-38"></a>    func<span class="op">=</span>llm_chain.run,</span>
<span id="lst-la_conversation_demo-39"><a href="#lst-la_conversation_demo-39"></a>    description<span class="op">=</span><span class="st">'Use this tool for general purpose queries.'</span></span>
<span id="lst-la_conversation_demo-40"><a href="#lst-la_conversation_demo-40"></a>)</span>
<span id="lst-la_conversation_demo-41"><a href="#lst-la_conversation_demo-41"></a></span>
<span id="lst-la_conversation_demo-42"><a href="#lst-la_conversation_demo-42"></a><span class="co"># when giving tools to LLM, we must pass as list of tools</span></span>
<span id="lst-la_conversation_demo-43"><a href="#lst-la_conversation_demo-43"></a>tools <span class="op">=</span> [math_tool, llm_tool]</span>
<span id="lst-la_conversation_demo-44"><a href="#lst-la_conversation_demo-44"></a></span>
<span id="lst-la_conversation_demo-45"><a href="#lst-la_conversation_demo-45"></a>conversation_agent <span class="op">=</span> initialize_agent(</span>
<a class="code-annotation-anchor" data-target-cell="lst-la_conversation_demo" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="lst-la_conversation_demo-46" class="code-annotation-target"><a href="#lst-la_conversation_demo-46"></a>    agent<span class="op">=</span><span class="st">"conversational-react-description"</span>,</span>
<span id="lst-la_conversation_demo-47"><a href="#lst-la_conversation_demo-47"></a>    tools<span class="op">=</span>tools,</span>
<span id="lst-la_conversation_demo-48"><a href="#lst-la_conversation_demo-48"></a>    llm<span class="op">=</span>llm,</span>
<span id="lst-la_conversation_demo-49"><a href="#lst-la_conversation_demo-49"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="lst-la_conversation_demo-50"><a href="#lst-la_conversation_demo-50"></a>    max_iterations<span class="op">=</span><span class="dv">3</span>,</span>
<a class="code-annotation-anchor" data-target-cell="lst-la_conversation_demo" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="lst-la_conversation_demo-51" class="code-annotation-target"><a href="#lst-la_conversation_demo-51"></a>    memory<span class="op">=</span>memory</span>
<span id="lst-la_conversation_demo-52"><a href="#lst-la_conversation_demo-52"></a>)</span>
<span id="lst-la_conversation_demo-53"><a href="#lst-la_conversation_demo-53"></a></span>
<span id="lst-la_conversation_demo-54"><a href="#lst-la_conversation_demo-54"></a>res <span class="op">=</span> conversation_agent(<span class="st">"1768年，中国有什么重大事件发生？"</span>)</span>
<span id="lst-la_conversation_demo-55"><a href="#lst-la_conversation_demo-55"></a><span class="bu">print</span>(res)</span>
<span id="lst-la_conversation_demo-56"><a href="#lst-la_conversation_demo-56"></a></span>
<span id="lst-la_conversation_demo-57"><a href="#lst-la_conversation_demo-57"></a>res <span class="op">=</span> conversation_agent(<span class="st">"同年，其他国家有什么重大事件发生？"</span>)</span>
<span id="lst-la_conversation_demo-58"><a href="#lst-la_conversation_demo-58"></a><span class="bu">print</span>(res)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="lst-la_conversation_demo" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="13" data-code-cell="lst-la_conversation_demo" data-code-annotation="1">引入 <code>ConversationBufferMemory</code> 类</span>
</dd>
<dt data-target-cell="lst-la_conversation_demo" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="16" data-code-cell="lst-la_conversation_demo" data-code-annotation="2">使用 <code>ConversationBufferMemory</code> 来初始化用于存储会话历史的 <code>memory</code></span>
</dd>
<dt data-target-cell="lst-la_conversation_demo" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="46" data-code-cell="lst-la_conversation_demo" data-code-annotation="3">在 <code>initialize_agent</code> 时，指定 Agent 类型为 <code>conversational-react-description</code></span>
</dd>
<dt data-target-cell="lst-la_conversation_demo" data-target-annotation="4">4</dt>
<dd>
<span data-code-lines="51" data-code-cell="lst-la_conversation_demo" data-code-annotation="4">为 Agent 配置 <code>memory</code></span>
</dd>
</dl>
<p>根据 <a href="#lst-map_agent_type_class">列表&nbsp;<span>14.7</span></a>，Conversation Agent 的具体实现为 <code>langchain/agent/conversation/base.py</code> 中的 <code>ConversationalAgent</code> 类。</p>
<p>同样，我们使用如下代码来看一下 Conversation Agent 的提示词：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(conversation_agent.agent.llm_chain.prompt.template)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="lst-la_init_agent_conv_prompt" class="listing">
<p>列表&nbsp;14.12: Conversation Agent 的提示词</p>
<div class="sourceCode" id="lst-la_init_agent_conv_prompt" data-lst-cap="Conversation Agent 的提示词"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><a class="code-annotation-anchor" data-target-cell="lst-la_init_agent_conv_prompt" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="lst-la_init_agent_conv_prompt-1" class="code-annotation-target"><a href="#lst-la_init_agent_conv_prompt-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant</span> is a large language model trained by OpenAI.</span>
<span id="lst-la_init_agent_conv_prompt-2"><a href="#lst-la_init_agent_conv_prompt-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-3"><a href="#lst-la_init_agent_conv_prompt-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant</span> is designed to be able to assist with a wide range of tasks, from answering simple questions to providing in-depth explanations and discussions on a wide range of topics. As a language model, Assistant is able to generate human-like text based on the input it receives, allowing it to engage in natural-sounding conversations and provide responses that are coherent and relevant to the topic at hand.</span>
<span id="lst-la_init_agent_conv_prompt-4"><a href="#lst-la_init_agent_conv_prompt-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-5"><a href="#lst-la_init_agent_conv_prompt-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant</span> is constantly learning and improving, and its capabilities are constantly evolving. It is able to process and understand large amounts of text, and can use this knowledge to provide accurate and informative responses to a wide range of questions. Additionally, Assistant is able to generate its own text based on the input it receives, allowing it to engage in discussions and provide explanations and descriptions on a wide range of topics.</span>
<span id="lst-la_init_agent_conv_prompt-6"><a href="#lst-la_init_agent_conv_prompt-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-7"><a href="#lst-la_init_agent_conv_prompt-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Overall,</span> Assistant is a powerful tool that can help with a wide range of tasks and provide valuable insights and information on a wide range of topics. Whether you need help with a specific question or just want to have a conversation about a particular topic, Assistant is here to assist.</span>
<span id="lst-la_init_agent_conv_prompt-8"><a href="#lst-la_init_agent_conv_prompt-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-9"><a href="#lst-la_init_agent_conv_prompt-9" aria-hidden="true" tabindex="-1"></a><span class="ex">TOOLS:</span></span>
<span id="lst-la_init_agent_conv_prompt-10"><a href="#lst-la_init_agent_conv_prompt-10" aria-hidden="true" tabindex="-1"></a><span class="ex">------</span></span>
<span id="lst-la_init_agent_conv_prompt-11"><a href="#lst-la_init_agent_conv_prompt-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-12"><a href="#lst-la_init_agent_conv_prompt-12" aria-hidden="true" tabindex="-1"></a><span class="ex">Assistant</span> has access to the following tools:</span>
<span id="lst-la_init_agent_conv_prompt-13"><a href="#lst-la_init_agent_conv_prompt-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-14"><a href="#lst-la_init_agent_conv_prompt-14" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> Calculator: <span class="ex">Useful</span> for when you need to answer questions about math.</span>
<span id="lst-la_init_agent_conv_prompt-15"><a href="#lst-la_init_agent_conv_prompt-15" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> Language <span class="ex">Model:</span> Use this tool for general purpose queries.</span>
<span id="lst-la_init_agent_conv_prompt-16"><a href="#lst-la_init_agent_conv_prompt-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-17"><a href="#lst-la_init_agent_conv_prompt-17" aria-hidden="true" tabindex="-1"></a><span class="ex">To</span> use a tool, please use the following format:</span>
<span id="lst-la_init_agent_conv_prompt-18"><a href="#lst-la_init_agent_conv_prompt-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-19"><a href="#lst-la_init_agent_conv_prompt-19" aria-hidden="true" tabindex="-1"></a><span class="kw">```</span></span>
<span id="lst-la_init_agent_conv_prompt-20"><a href="#lst-la_init_agent_conv_prompt-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Thought:</span> Do I need to use a tool<span class="pp">?</span> Yes</span>
<span id="lst-la_init_agent_conv_prompt-21"><a href="#lst-la_init_agent_conv_prompt-21" aria-hidden="true" tabindex="-1"></a><span class="ex">Action:</span> the action to take, should be one of [Calculator, Language Model]</span>
<span id="lst-la_init_agent_conv_prompt-22"><a href="#lst-la_init_agent_conv_prompt-22" aria-hidden="true" tabindex="-1"></a><span class="ex">Action</span> Input: the input to the action</span>
<span id="lst-la_init_agent_conv_prompt-23"><a href="#lst-la_init_agent_conv_prompt-23" aria-hidden="true" tabindex="-1"></a><span class="ex">Observation:</span> the result of the action</span>
<span id="lst-la_init_agent_conv_prompt-24"><a href="#lst-la_init_agent_conv_prompt-24" aria-hidden="true" tabindex="-1"></a><span class="kw">```</span></span>
<span id="lst-la_init_agent_conv_prompt-25"><a href="#lst-la_init_agent_conv_prompt-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-26"><a href="#lst-la_init_agent_conv_prompt-26" aria-hidden="true" tabindex="-1"></a><span class="ex">When</span> you have a response to say to the Human, or if you do not need to use a tool, you MUST use the format:</span>
<span id="lst-la_init_agent_conv_prompt-27"><a href="#lst-la_init_agent_conv_prompt-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-28"><a href="#lst-la_init_agent_conv_prompt-28" aria-hidden="true" tabindex="-1"></a><span class="kw">```</span></span>
<span id="lst-la_init_agent_conv_prompt-29"><a href="#lst-la_init_agent_conv_prompt-29" aria-hidden="true" tabindex="-1"></a><span class="ex">Thought:</span> Do I need to use a tool<span class="pp">?</span> No</span>
<span id="lst-la_init_agent_conv_prompt-30"><a href="#lst-la_init_agent_conv_prompt-30" aria-hidden="true" tabindex="-1"></a><span class="ex">AI:</span> [your response here]</span>
<span id="lst-la_init_agent_conv_prompt-31"><a href="#lst-la_init_agent_conv_prompt-31" aria-hidden="true" tabindex="-1"></a><span class="kw">```</span></span>
<span id="lst-la_init_agent_conv_prompt-32"><a href="#lst-la_init_agent_conv_prompt-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-33"><a href="#lst-la_init_agent_conv_prompt-33" aria-hidden="true" tabindex="-1"></a><span class="ex">Begin!</span></span>
<span id="lst-la_init_agent_conv_prompt-34"><a href="#lst-la_init_agent_conv_prompt-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-35"><a href="#lst-la_init_agent_conv_prompt-35" aria-hidden="true" tabindex="-1"></a><span class="ex">Previous</span> conversation history:</span>
<a class="code-annotation-anchor" data-target-cell="lst-la_init_agent_conv_prompt" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="lst-la_init_agent_conv_prompt-36" class="code-annotation-target"><a href="#lst-la_init_agent_conv_prompt-36" aria-hidden="true" tabindex="-1"></a><span class="ex">{chat_history}</span></span>
<span id="lst-la_init_agent_conv_prompt-37"><a href="#lst-la_init_agent_conv_prompt-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_init_agent_conv_prompt-38"><a href="#lst-la_init_agent_conv_prompt-38" aria-hidden="true" tabindex="-1"></a><span class="ex">New</span> input: {input}</span>
<span id="lst-la_init_agent_conv_prompt-39"><a href="#lst-la_init_agent_conv_prompt-39" aria-hidden="true" tabindex="-1"></a><span class="ex">{agent_scratchpad}</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="lst-la_init_agent_conv_prompt" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="1" data-code-cell="lst-la_init_agent_conv_prompt" data-code-annotation="1">作为一个通用的框架，在提示词中这样写其实不是特别合理。</span>
</dd>
<dt data-target-cell="lst-la_init_agent_conv_prompt" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="36" data-code-cell="lst-la_init_agent_conv_prompt" data-code-annotation="2">存储历史对话消息的地方，当我们问 &lt;同年，其他国家有什么重大事件发生？&gt;时，Agent 可以从这里获取知识，以推理出 &lt;1768年，中国之外有什么重大事件发生？&gt;。</span>
</dd>
</dl>
</section>
<section id="agent-提示词工程" class="level2" data-number="14.4">
<h2 data-number="14.4" class="anchored" data-anchor-id="agent-提示词工程"><span class="header-section-number">14.4</span> Agent 提示词工程</h2>
<p>现在，如果让 Agent 解决数学问题：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> conversation_agent(<span class="st">"what is 3*4?"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>我们会发现，Agent 依然会出现 <a href="#lst-lc_agent_llm_error">列表&nbsp;<span>14.9</span></a> 所示的问题。如前所述，这里和我们所使用的 LLM 的能力有关系，另外的原因还在于 LLM 有时候有可能过分自信，所以当需要使用工具时，LLM 并不会真的选择工具。</p>
<div id="lst-lc_agent_cov_math_tool" class="listing">
<p>列表&nbsp;14.13: LLM 不选择使用工具进行数据计算</p>
<div class="sourceCode" id="lst-lc_agent_cov_math_tool" data-lst-cap="LLM 不选择使用工具进行数据计算"><pre class="sourceCode bash code-annotation-code code-with-copy code-annotated"><code class="sourceCode bash"><span id="lst-lc_agent_cov_math_tool-1"><a href="#lst-lc_agent_cov_math_tool-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;</span> Entering <span class="ex">new</span> AgentExecutor chain...</span>
<span id="lst-lc_agent_cov_math_tool-2"><a href="#lst-lc_agent_cov_math_tool-2" aria-hidden="true" tabindex="-1"></a><span class="ex">TOOLS:</span></span>
<span id="lst-lc_agent_cov_math_tool-3"><a href="#lst-lc_agent_cov_math_tool-3" aria-hidden="true" tabindex="-1"></a><span class="ex">------</span></span>
<span id="lst-lc_agent_cov_math_tool-4"><a href="#lst-lc_agent_cov_math_tool-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_cov_math_tool-5"><a href="#lst-lc_agent_cov_math_tool-5" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> Calculator</span>
<span id="lst-lc_agent_cov_math_tool-6"><a href="#lst-lc_agent_cov_math_tool-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_cov_math_tool-7"><a href="#lst-lc_agent_cov_math_tool-7" aria-hidden="true" tabindex="-1"></a><span class="ex">ACTION:</span> Use Calculator</span>
<span id="lst-lc_agent_cov_math_tool-8"><a href="#lst-lc_agent_cov_math_tool-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_cov_math_tool-9"><a href="#lst-lc_agent_cov_math_tool-9" aria-hidden="true" tabindex="-1"></a><span class="ex">ACTION</span> INPUT: 3<span class="pp">*</span>4</span>
<span id="lst-lc_agent_cov_math_tool-10"><a href="#lst-lc_agent_cov_math_tool-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_cov_math_tool-11"><a href="#lst-lc_agent_cov_math_tool-11" aria-hidden="true" tabindex="-1"></a><span class="ex">OBSERVATION:</span> The result of the action is 12.</span>
<span id="lst-lc_agent_cov_math_tool-12"><a href="#lst-lc_agent_cov_math_tool-12" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="lst-lc_agent_cov_math_tool" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="lst-lc_agent_cov_math_tool-13" class="code-annotation-target"><a href="#lst-lc_agent_cov_math_tool-13" aria-hidden="true" tabindex="-1"></a><span class="ex">THOUGHT:</span> Do I need to use a tool<span class="pp">?</span> No</span>
<span id="lst-lc_agent_cov_math_tool-14"><a href="#lst-lc_agent_cov_math_tool-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_cov_math_tool-15"><a href="#lst-lc_agent_cov_math_tool-15" aria-hidden="true" tabindex="-1"></a><span class="ex">AI:</span> 3<span class="pp">*</span>4 equals 12.</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="lst-lc_agent_cov_math_tool" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="13" data-code-cell="lst-lc_agent_cov_math_tool" data-code-annotation="1">Agent 经过思考后认为不需要使用工具，真是太自信了，还好计算比较简答，LLM 答对了。</span>
</dd>
</dl>
<p>我们可以对 <a href="#lst-la_init_agent_conv_prompt">列表&nbsp;<span>14.12</span></a> 所示的 Agent 的提示词进行微调：“告诉 LLM，它的数学能力比较差，对于数序问题，一律采用合适的工具来回答问题”。</p>
<p>对 <a href="#lst-la_conversation_demo">列表&nbsp;<span>14.11</span></a> 做如下修改：</p>
<div id="lst-la_conversation_demo_update" class="listing">
<p>列表&nbsp;14.14: Agent 提示词微调</p>
<div class="sourceCode" id="lst-la_conversation_demo_update" data-lst-cap="Agent 提示词微调"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="lst-la_conversation_demo_update-1"><a href="#lst-la_conversation_demo_update-1" aria-hidden="true" tabindex="-1"></a>conversation_agent <span class="op">=</span> initialize_agent(……)</span>
<span id="lst-la_conversation_demo_update-2"><a href="#lst-la_conversation_demo_update-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_conversation_demo_update-3"><a href="#lst-la_conversation_demo_update-3" aria-hidden="true" tabindex="-1"></a>PREFIX <span class="op">=</span> <span class="st">"""Assistant is a large language model trained by ErnieBot.</span></span>
<span id="lst-la_conversation_demo_update-4"><a href="#lst-la_conversation_demo_update-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_conversation_demo_update-5"><a href="#lst-la_conversation_demo_update-5" aria-hidden="true" tabindex="-1"></a><span class="st">Assistant is designed to be able to assist with a wide range of tasks, from answering simple questions to providing in-depth explanations and discussions on a wide range of topics. As a language model, Assistant is able to generate human-like text based on the input it receives, allowing it to engage in natural-sounding conversations and provide responses that are coherent and relevant to the topic at hand.</span></span>
<span id="lst-la_conversation_demo_update-6"><a href="#lst-la_conversation_demo_update-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_conversation_demo_update-7"><a href="#lst-la_conversation_demo_update-7" aria-hidden="true" tabindex="-1"></a><span class="st">Assistant is constantly learning and improving, and its capabilities are constantly evolving. It is able to process and understand large amounts of text, and can use this knowledge to provide accurate and informative responses to a wide range of questions. Additionally, Assistant is able to generate its own text based on the input it receives, allowing it to engage in discussions and provide explanations and descriptions on a wide range of topics.</span></span>
<span id="lst-la_conversation_demo_update-8"><a href="#lst-la_conversation_demo_update-8" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="lst-la_conversation_demo_update" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="lst-la_conversation_demo_update-9" class="code-annotation-target"><a href="#lst-la_conversation_demo_update-9" aria-hidden="true" tabindex="-1"></a><span class="st">Unfortunately, Assistant is terrible at maths. When provided with math questions, no matter how simple, assistant always refers to it's trusty tools and absolutely does NOT try to answer math questions by itself.</span></span>
<span id="lst-la_conversation_demo_update-10"><a href="#lst-la_conversation_demo_update-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_conversation_demo_update-11"><a href="#lst-la_conversation_demo_update-11" aria-hidden="true" tabindex="-1"></a><span class="st">Overall, Assistant is a powerful system that can help with a wide range of tasks and provide valuable insights and information on a wide range of topics. Whether you need help with a specific question or just want to have a conversation about a particular topic, Assistant is here to assist.</span></span>
<span id="lst-la_conversation_demo_update-12"><a href="#lst-la_conversation_demo_update-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_conversation_demo_update-13"><a href="#lst-la_conversation_demo_update-13" aria-hidden="true" tabindex="-1"></a><span class="st">TOOLS:</span></span>
<span id="lst-la_conversation_demo_update-14"><a href="#lst-la_conversation_demo_update-14" aria-hidden="true" tabindex="-1"></a><span class="st">------</span></span>
<span id="lst-la_conversation_demo_update-15"><a href="#lst-la_conversation_demo_update-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-la_conversation_demo_update-16"><a href="#lst-la_conversation_demo_update-16" aria-hidden="true" tabindex="-1"></a><span class="st">Assistant has access to the following tools:</span></span>
<span id="lst-la_conversation_demo_update-17"><a href="#lst-la_conversation_demo_update-17" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="lst-la_conversation_demo_update-18"><a href="#lst-la_conversation_demo_update-18" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="lst-la_conversation_demo_update" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="lst-la_conversation_demo_update-19" class="code-annotation-target"><a href="#lst-la_conversation_demo_update-19" aria-hidden="true" tabindex="-1"></a>new_prompt <span class="op">=</span> conversation_agent.agent.create_prompt(tools<span class="op">=</span>tools, prefix<span class="op">=</span>PREFIX)</span>
<a class="code-annotation-anchor" data-target-cell="lst-la_conversation_demo_update" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="lst-la_conversation_demo_update-20" class="code-annotation-target"><a href="#lst-la_conversation_demo_update-20" aria-hidden="true" tabindex="-1"></a>conversation_agent.agent.llm_chain.prompt <span class="op">=</span> new_prompt</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="lst-la_conversation_demo_update" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="9" data-code-cell="lst-la_conversation_demo_update" data-code-annotation="1">增加数学能力差的提示词描述，让 LLM 可以选择正确的工具</span>
</dd>
<dt data-target-cell="lst-la_conversation_demo_update" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="19" data-code-cell="lst-la_conversation_demo_update" data-code-annotation="2">生成新的提示词</span>
</dd>
<dt data-target-cell="lst-la_conversation_demo_update" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="20" data-code-cell="lst-la_conversation_demo_update" data-code-annotation="3">更新 Agent 的提示词</span>
</dd>
</dl>
</section>
<section id="docstore-agent" class="level2" data-number="14.5">
<h2 data-number="14.5" class="anchored" data-anchor-id="docstore-agent"><span class="header-section-number">14.5</span> Docstore Agent</h2>
<p>Docstore Agent 是专门为使用 LangChain <a href="https://api.python.langchain.com/en/latest/api_reference.html#module-langchain.docstore">docstore</a> 进行信息搜索（Search）和查找（Lookup）而构建的。</p>
<ul>
<li>Search：从文档库中检索相关的页面</li>
<li>Lookup：从检索出的相关页面中，查找相关的具体内容</li>
</ul>
<p>LangChain 的 docstore 使我们能够使用传统的检索方法来存储和检索信息，例如 <code>langchain/docstore/wikipedia.py</code> 中的 <code>Wikipedia</code>。实际上，docstore 就是是简化版的 <a href="https://python.langchain.com/docs/modules/data_connection/document_loaders/">Document Loader</a>。</p>
<div id="lst-la_docstore_agent" class="listing">
<p>列表&nbsp;14.15: 基于维基百科的 docstore Agent</p>
<div class="sourceCode" id="lst-la_docstore_agent" data-lst-cap="基于维基百科的 docstore Agent"><pre class="sourceCode numberSource python code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode python"><span id="lst-la_docstore_agent-1"><a href="#lst-la_docstore_agent-1"></a><span class="co">#encoding: utf-8</span></span>
<span id="lst-la_docstore_agent-2"><a href="#lst-la_docstore_agent-2"></a></span>
<span id="lst-la_docstore_agent-3"><a href="#lst-la_docstore_agent-3"></a><span class="co">"""</span></span>
<span id="lst-la_docstore_agent-4"><a href="#lst-la_docstore_agent-4"></a><span class="co">@discribe: example for docstore agent.</span></span>
<span id="lst-la_docstore_agent-5"><a href="#lst-la_docstore_agent-5"></a><span class="co">@author: wangwei1237@gmail.com</span></span>
<span id="lst-la_docstore_agent-6"><a href="#lst-la_docstore_agent-6"></a><span class="co">"""</span></span>
<span id="lst-la_docstore_agent-7"><a href="#lst-la_docstore_agent-7"></a></span>
<span id="lst-la_docstore_agent-8"><a href="#lst-la_docstore_agent-8"></a><span class="im">from</span> langchain.chat_models <span class="im">import</span> ErnieBotChat</span>
<span id="lst-la_docstore_agent-9"><a href="#lst-la_docstore_agent-9"></a><span class="im">from</span> langchain.agents <span class="im">import</span> Tool</span>
<span id="lst-la_docstore_agent-10"><a href="#lst-la_docstore_agent-10"></a><span class="im">from</span> langchain <span class="im">import</span> Wikipedia</span>
<span id="lst-la_docstore_agent-11"><a href="#lst-la_docstore_agent-11"></a><span class="im">from</span> langchain.agents.react.base <span class="im">import</span> DocstoreExplorer</span>
<span id="lst-la_docstore_agent-12"><a href="#lst-la_docstore_agent-12"></a><span class="im">from</span> langchain.agents <span class="im">import</span> initialize_agent</span>
<span id="lst-la_docstore_agent-13"><a href="#lst-la_docstore_agent-13"></a></span>
<span id="lst-la_docstore_agent-14"><a href="#lst-la_docstore_agent-14"></a>docstore<span class="op">=</span>DocstoreExplorer(Wikipedia())</span>
<span id="lst-la_docstore_agent-15"><a href="#lst-la_docstore_agent-15"></a></span>
<span id="lst-la_docstore_agent-16"><a href="#lst-la_docstore_agent-16"></a><span class="co"># initialize the docstore search tool</span></span>
<span id="lst-la_docstore_agent-17"><a href="#lst-la_docstore_agent-17"></a>search_tool <span class="op">=</span> Tool(</span>
<span id="lst-la_docstore_agent-18"><a href="#lst-la_docstore_agent-18"></a>    name<span class="op">=</span><span class="st">"Search"</span>,</span>
<span id="lst-la_docstore_agent-19"><a href="#lst-la_docstore_agent-19"></a>    func<span class="op">=</span>docstore.search,</span>
<span id="lst-la_docstore_agent-20"><a href="#lst-la_docstore_agent-20"></a>    description<span class="op">=</span><span class="st">'search wikipedia'</span></span>
<span id="lst-la_docstore_agent-21"><a href="#lst-la_docstore_agent-21"></a>)</span>
<span id="lst-la_docstore_agent-22"><a href="#lst-la_docstore_agent-22"></a></span>
<span id="lst-la_docstore_agent-23"><a href="#lst-la_docstore_agent-23"></a><span class="co"># intialize the docstore lookup tool</span></span>
<span id="lst-la_docstore_agent-24"><a href="#lst-la_docstore_agent-24"></a>lookup_tool <span class="op">=</span> Tool(</span>
<span id="lst-la_docstore_agent-25"><a href="#lst-la_docstore_agent-25"></a>    name<span class="op">=</span><span class="st">"Lookup"</span>,</span>
<span id="lst-la_docstore_agent-26"><a href="#lst-la_docstore_agent-26"></a>    func<span class="op">=</span>docstore.lookup,</span>
<span id="lst-la_docstore_agent-27"><a href="#lst-la_docstore_agent-27"></a>    description<span class="op">=</span><span class="st">'lookup a term in wikipedia'</span></span>
<span id="lst-la_docstore_agent-28"><a href="#lst-la_docstore_agent-28"></a>)</span>
<span id="lst-la_docstore_agent-29"><a href="#lst-la_docstore_agent-29"></a></span>
<span id="lst-la_docstore_agent-30"><a href="#lst-la_docstore_agent-30"></a><span class="co"># when giving tools to LLM, we must pass as list of tools</span></span>
<a class="code-annotation-anchor" data-target-cell="lst-la_docstore_agent" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="lst-la_docstore_agent-31" class="code-annotation-target"><a href="#lst-la_docstore_agent-31"></a>tools <span class="op">=</span> [search_tool, lookup_tool]</span>
<span id="lst-la_docstore_agent-32"><a href="#lst-la_docstore_agent-32"></a></span>
<span id="lst-la_docstore_agent-33"><a href="#lst-la_docstore_agent-33"></a></span>
<span id="lst-la_docstore_agent-34"><a href="#lst-la_docstore_agent-34"></a>llm <span class="op">=</span> ErnieBotChat()</span>
<span id="lst-la_docstore_agent-35"><a href="#lst-la_docstore_agent-35"></a>docstore_agent <span class="op">=</span> initialize_agent(</span>
<span id="lst-la_docstore_agent-36"><a href="#lst-la_docstore_agent-36"></a>    agent<span class="op">=</span><span class="st">"react-docstore"</span>,</span>
<span id="lst-la_docstore_agent-37"><a href="#lst-la_docstore_agent-37"></a>    tools<span class="op">=</span>tools,</span>
<span id="lst-la_docstore_agent-38"><a href="#lst-la_docstore_agent-38"></a>    llm<span class="op">=</span>llm,</span>
<span id="lst-la_docstore_agent-39"><a href="#lst-la_docstore_agent-39"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="lst-la_docstore_agent-40"><a href="#lst-la_docstore_agent-40"></a>    max_iterations<span class="op">=</span><span class="dv">3</span>,</span>
<span id="lst-la_docstore_agent-41"><a href="#lst-la_docstore_agent-41"></a>)</span>
<span id="lst-la_docstore_agent-42"><a href="#lst-la_docstore_agent-42"></a></span>
<span id="lst-la_docstore_agent-43"><a href="#lst-la_docstore_agent-43"></a>docstore_agent(<span class="st">"What were Archimedes' last words?"</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="lst-la_docstore_agent" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="31" data-code-cell="lst-la_docstore_agent" data-code-annotation="1">Docstore Agent 只允许存在两个工具，并且工具名必须为 <code>Lookup</code> 和 <code>Search</code>，这一点要特别注意。</span>
</dd>
</dl>
<p>DocStore Agent 的提示词位于 <code>langchain/agents/react/wiki_prompt.py</code> 中，大家可以用如下的代码查看提示词，由于提示词太长，这里就不再展示了，大家可以自行查看执行代码获取提示词。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(docstore_agent.agent.llm_chain.prompt.template)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
注释
</div>
</div>
<div class="callout-body-container callout-body">
<p>我们还可以使用 <code>self-ask-with-search</code> 来初始化一个 Self Ask with Search Agent，从而可以将 LLM 与 搜索引擎结合起来，以解决更复杂的任务。Self Ask with Search Agent 会根据需要执行搜索并问一些进一步的问题，以获得最终的答案。</p>
<p>Agent 是 LLM 向前迈出的重大一步，“LLM Agent” 未来可能会等价于 LLM，这只是时间问题。通过授权 LLM 利用工具并驾驭复杂的多步骤思维过程，我们正进入一个令人难以置信的 AI 驱动的巨大领域。这才是真正意义上的 AI 原生应用。</p>
</div>
</div>
<section id="sec-lc_tool_input_param_count" class="level3" data-number="14.5.1">
<h3 data-number="14.5.1" class="anchored" data-anchor-id="sec-lc_tool_input_param_count"><span class="header-section-number">14.5.1</span> 单输入参数和多输入参数</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
警告
</div>
</div>
<div class="callout-body-container callout-body">
<p>本节提到的几种 Agent 类型，其可以使用的 Tool 必须为单输入参数，也就是说必须有且只能有一个参数。这个限制在 LangChain 的官方项目有有很多讨论（<a href="https://github.com/langchain-ai/langchain/issues/3700">ISSUE 3700</a>, <a href="https://github.com/langchain-ai/langchain/pull/3803">ISSUE 3803</a>），但是在 <a href="https://github.com/langchain-ai/langchain/pull/3803">ISSUE 3803</a> 中，有开发者表示，这种限制是必须的：</p>
<blockquote class="blockquote">
<p>This restriction must have been added as agent might not behave appropriately if multi-input tools are provided. One of the maintainer might know.</p>
</blockquote>
<p>在 LangChain 的 <a href="https://python.langchain.com/docs/modules/agents/agent_types/structured_chat">Structured tool chat</a> 官方文档中也提到：</p>
<blockquote class="blockquote">
<p>The structured tool chat agent is capable of using multi-input tools.</p>
<p>Older agents are configured to specify an action input as a single string, but this agent can use the provided tools’ <code>args_schema</code> to populate the action input.</p>
</blockquote>
<p>因此，如果想在代理中使用多输入工具，可以使用 <code>STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION</code>，或者重写对应的 Agent。</p>
</div>
</div>
</section>
</section>
<section id="structured-chat-agent" class="level2" data-number="14.6">
<h2 data-number="14.6" class="anchored" data-anchor-id="structured-chat-agent"><span class="header-section-number">14.6</span> Structured Chat Agent</h2>
<p>如前所述，Structured Chat Agent 允许使用的 Tool 的输入参数并非只有 1 个，而是可以具有 0 个或者 2 个及以上的输入参数。</p>
<p>根据 <code>langchain/agents/structured_chat/prompt.py</code> 中的提示词描述，该 Agent 需要使用 JSON-Schema 的模式来创建结构化的参数输入，对于更复杂的工具而言，这种方式更为有用。</p>
<p>因为文心大模型 <code>chat</code> 模式的 message 消息类型和 <code>OpenAI</code> 的不同——缺少 <code>SystemMessage</code> 类型，因此，如果要让 <code>Structured Chat Agent</code> 支持文心，需要对其 Prompt 的生成方式进行修改。</p>
<div id="lst-lc_struct_agent_fixed_for_ernine" class="listing">
<p>列表&nbsp;14.16: create_prompt_for_ernie</p>
<div class="sourceCode" id="lst-lc_struct_agent_fixed_for_ernine" data-lst-cap="create_prompt_for_ernie"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="lst-lc_struct_agent_fixed_for_ernine-1"><a href="#lst-lc_struct_agent_fixed_for_ernine-1" aria-hidden="true" tabindex="-1"></a><span class="at">@classmethod</span></span>
<span id="lst-lc_struct_agent_fixed_for_ernine-2"><a href="#lst-lc_struct_agent_fixed_for_ernine-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_prompt_for_ernie(</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-3"><a href="#lst-lc_struct_agent_fixed_for_ernine-3" aria-hidden="true" tabindex="-1"></a>    ......</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-4"><a href="#lst-lc_struct_agent_fixed_for_ernine-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> BasePromptTemplate:</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-5"><a href="#lst-lc_struct_agent_fixed_for_ernine-5" aria-hidden="true" tabindex="-1"></a>    ......</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-6"><a href="#lst-lc_struct_agent_fixed_for_ernine-6" aria-hidden="true" tabindex="-1"></a>    messages <span class="op">=</span> [</span>
<a class="code-annotation-anchor" data-target-cell="lst-lc_struct_agent_fixed_for_ernine" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="lst-lc_struct_agent_fixed_for_ernine-7" class="code-annotation-target"><a href="#lst-lc_struct_agent_fixed_for_ernine-7" aria-hidden="true" tabindex="-1"></a>        HumanMessagePromptTemplate.from_template(template),</span>
<a class="code-annotation-anchor" data-target-cell="lst-lc_struct_agent_fixed_for_ernine" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="lst-lc_struct_agent_fixed_for_ernine-8" class="code-annotation-target"><a href="#lst-lc_struct_agent_fixed_for_ernine-8" aria-hidden="true" tabindex="-1"></a>        AIMessagePromptTemplate.from_template(<span class="st">"YES, I Know."</span>),</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-9"><a href="#lst-lc_struct_agent_fixed_for_ernine-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>_memory_prompts,</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-10"><a href="#lst-lc_struct_agent_fixed_for_ernine-10" aria-hidden="true" tabindex="-1"></a>        HumanMessagePromptTemplate.from_template(human_message_template),</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-11"><a href="#lst-lc_struct_agent_fixed_for_ernine-11" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-12"><a href="#lst-lc_struct_agent_fixed_for_ernine-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ChatPromptTemplate(input_variables<span class="op">=</span>input_variables, messages<span class="op">=</span>messages)</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-13"><a href="#lst-lc_struct_agent_fixed_for_ernine-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_struct_agent_fixed_for_ernine-14"><a href="#lst-lc_struct_agent_fixed_for_ernine-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_struct_agent_fixed_for_ernine-15"><a href="#lst-lc_struct_agent_fixed_for_ernine-15" aria-hidden="true" tabindex="-1"></a><span class="at">@classmethod</span></span>
<span id="lst-lc_struct_agent_fixed_for_ernine-16"><a href="#lst-lc_struct_agent_fixed_for_ernine-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> from_llm_and_tools(</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-17"><a href="#lst-lc_struct_agent_fixed_for_ernine-17" aria-hidden="true" tabindex="-1"></a>    ......</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-18"><a href="#lst-lc_struct_agent_fixed_for_ernine-18" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Agent:</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-19"><a href="#lst-lc_struct_agent_fixed_for_ernine-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Construct an agent from an LLM and tools."""</span></span>
<span id="lst-lc_struct_agent_fixed_for_ernine-20"><a href="#lst-lc_struct_agent_fixed_for_ernine-20" aria-hidden="true" tabindex="-1"></a>    cls._validate_tools(tools)</span>
<a class="code-annotation-anchor" data-target-cell="lst-lc_struct_agent_fixed_for_ernine" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="lst-lc_struct_agent_fixed_for_ernine-21" class="code-annotation-target"><a href="#lst-lc_struct_agent_fixed_for_ernine-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"ERNIE"</span> <span class="kw">in</span> llm.model_name:</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-22"><a href="#lst-lc_struct_agent_fixed_for_ernine-22" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> cls.create_prompt_for_ernie(</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-23"><a href="#lst-lc_struct_agent_fixed_for_ernine-23" aria-hidden="true" tabindex="-1"></a>            ......</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-24"><a href="#lst-lc_struct_agent_fixed_for_ernine-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-25"><a href="#lst-lc_struct_agent_fixed_for_ernine-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-26"><a href="#lst-lc_struct_agent_fixed_for_ernine-26" aria-hidden="true" tabindex="-1"></a>        prompt <span class="op">=</span> cls.create_prompt(</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-27"><a href="#lst-lc_struct_agent_fixed_for_ernine-27" aria-hidden="true" tabindex="-1"></a>            ......</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-28"><a href="#lst-lc_struct_agent_fixed_for_ernine-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="lst-lc_struct_agent_fixed_for_ernine-29"><a href="#lst-lc_struct_agent_fixed_for_ernine-29" aria-hidden="true" tabindex="-1"></a>    ......</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<dl class="code-annotation-container-grid">
<dt data-target-cell="lst-lc_struct_agent_fixed_for_ernine" data-target-annotation="1">1</dt>
<dd>
<span data-code-lines="7" data-code-cell="lst-lc_struct_agent_fixed_for_ernine" data-code-annotation="1">将 SystemMessage 修改为 HumanMessage</span>
</dd>
<dt data-target-cell="lst-lc_struct_agent_fixed_for_ernine" data-target-annotation="2">2</dt>
<dd>
<span data-code-lines="8" data-code-cell="lst-lc_struct_agent_fixed_for_ernine" data-code-annotation="2">补充 AIMessage，以满足文心的消息列表限制</span>
</dd>
<dt data-target-cell="lst-lc_struct_agent_fixed_for_ernine" data-target-annotation="3">3</dt>
<dd>
<span data-code-lines="21" data-code-cell="lst-lc_struct_agent_fixed_for_ernine" data-code-annotation="3">根据模型名称来调用不同的提示词生成方法</span>
</dd>
</dl>
<p>具体的完整代码可以参见：<a href="https://github.com/wangwei1237/LLM_in_Action/blob/main//code/structed_chat_agent_base.py">structed_chat_agent_base.py</a>。</p>
<p>然后，我们就可以使用 Structured Chat Agent 来调用多输入参数的工具了（工具的具体实现可以参考 <a href="#sec-lc_agent_tools_m"><span>章节&nbsp;14.7.2</span></a>）。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>structured_agent <span class="op">=</span> initialize_agent(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    agent<span class="op">=</span><span class="st">"structured-chat-zero-shot-react-description"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    tools<span class="op">=</span>tools,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    llm<span class="op">=</span>llm,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    verbose<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    max_iterations<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    memory<span class="op">=</span>memory</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>structured_agent(question)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="自定义-agent-tools" class="level2" data-number="14.7">
<h2 data-number="14.7" class="anchored" data-anchor-id="自定义-agent-tools"><span class="header-section-number">14.7</span> 自定义 Agent Tools</h2>
<p>关于单输入参数 Tool 和 多输入参数 Tool 的区别的应用场景，请参考：<a href="#sec-lc_tool_input_param_count"><span>章节&nbsp;14.5.1</span></a>。</p>
<section id="单输入参数" class="level3" data-number="14.7.1">
<h3 data-number="14.7.1" class="anchored" data-anchor-id="单输入参数"><span class="header-section-number">14.7.1</span> 单输入参数</h3>
<div id="lst-lc_agent_tools_si" class="listing">
<p>列表&nbsp;14.17: 根据圆的半径计算圆周长 Tool</p>
<div class="sourceCode" id="lst-lc_agent_tools_si" data-lst-cap="根据圆的半径计算圆周长 Tool"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-lc_agent_tools_si-1"><a href="#lst-lc_agent_tools_si-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CircumferenceTool(BaseTool):</span>
<span id="lst-lc_agent_tools_si-2"><a href="#lst-lc_agent_tools_si-2" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">"Circumference calculator"</span></span>
<span id="lst-lc_agent_tools_si-3"><a href="#lst-lc_agent_tools_si-3" aria-hidden="true" tabindex="-1"></a>    description <span class="op">=</span> <span class="st">"use this tool when you need to calculate a circumference using the radius of a circle"</span></span>
<span id="lst-lc_agent_tools_si-4"><a href="#lst-lc_agent_tools_si-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_tools_si-5"><a href="#lst-lc_agent_tools_si-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _run(<span class="va">self</span>, radius: Union[<span class="bu">int</span>, <span class="bu">float</span>]):</span>
<span id="lst-lc_agent_tools_si-6"><a href="#lst-lc_agent_tools_si-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">float</span>(radius)<span class="op">*</span><span class="fl">2.0</span><span class="op">*</span>pi</span>
<span id="lst-lc_agent_tools_si-7"><a href="#lst-lc_agent_tools_si-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_tools_si-8"><a href="#lst-lc_agent_tools_si-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _arun(<span class="va">self</span>, radius: <span class="bu">int</span>):</span>
<span id="lst-lc_agent_tools_si-9"><a href="#lst-lc_agent_tools_si-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span>(<span class="st">"This tool does not support async"</span>)</span>
<span id="lst-lc_agent_tools_si-10"><a href="#lst-lc_agent_tools_si-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_tools_si-11"><a href="#lst-lc_agent_tools_si-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_tools_si-12"><a href="#lst-lc_agent_tools_si-12" aria-hidden="true" tabindex="-1"></a><span class="co"># when giving tools to LLM, we must pass as list of tools</span></span>
<span id="lst-lc_agent_tools_si-13"><a href="#lst-lc_agent_tools_si-13" aria-hidden="true" tabindex="-1"></a>tools <span class="op">=</span> [CircumferenceTool()]</span>
<span id="lst-lc_agent_tools_si-14"><a href="#lst-lc_agent_tools_si-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sec-lc_agent_tools_m" class="level3" data-number="14.7.2">
<h3 data-number="14.7.2" class="anchored" data-anchor-id="sec-lc_agent_tools_m"><span class="header-section-number">14.7.2</span> 多输入参数</h3>
<div id="lst-lc_agent_tools_mi" class="listing">
<p>列表&nbsp;14.18: 计算直角三角形斜边长度 Tool</p>
<div class="sourceCode" id="lst-lc_agent_tools_mi" data-lst-cap="计算直角三角形斜边长度 Tool"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="lst-lc_agent_tools_mi-1"><a href="#lst-lc_agent_tools_mi-1" aria-hidden="true" tabindex="-1"></a>desc <span class="op">=</span> (</span>
<span id="lst-lc_agent_tools_mi-2"><a href="#lst-lc_agent_tools_mi-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"use this tool when you need to calculate the length of a hypotenuse"</span></span>
<span id="lst-lc_agent_tools_mi-3"><a href="#lst-lc_agent_tools_mi-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"given one or two sides of a triangle and/or an angle (in degrees). "</span></span>
<span id="lst-lc_agent_tools_mi-4"><a href="#lst-lc_agent_tools_mi-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"To use the tool, you must provide at least two of the following parameters "</span></span>
<span id="lst-lc_agent_tools_mi-5"><a href="#lst-lc_agent_tools_mi-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"['adjacent_side', 'opposite_side', 'angle']."</span></span>
<span id="lst-lc_agent_tools_mi-6"><a href="#lst-lc_agent_tools_mi-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="lst-lc_agent_tools_mi-7"><a href="#lst-lc_agent_tools_mi-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="lst-lc_agent_tools_mi-8"><a href="#lst-lc_agent_tools_mi-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PythagorasTool(BaseTool):</span>
<span id="lst-lc_agent_tools_mi-9"><a href="#lst-lc_agent_tools_mi-9" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">"Hypotenuse calculator"</span></span>
<span id="lst-lc_agent_tools_mi-10"><a href="#lst-lc_agent_tools_mi-10" aria-hidden="true" tabindex="-1"></a>    description <span class="op">=</span> desc</span>
<span id="lst-lc_agent_tools_mi-11"><a href="#lst-lc_agent_tools_mi-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-lc_agent_tools_mi-12"><a href="#lst-lc_agent_tools_mi-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _run(</span>
<span id="lst-lc_agent_tools_mi-13"><a href="#lst-lc_agent_tools_mi-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>,</span>
<span id="lst-lc_agent_tools_mi-14"><a href="#lst-lc_agent_tools_mi-14" aria-hidden="true" tabindex="-1"></a>        adjacent_side: Optional[Union[<span class="bu">int</span>, <span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="lst-lc_agent_tools_mi-15"><a href="#lst-lc_agent_tools_mi-15" aria-hidden="true" tabindex="-1"></a>        opposite_side: Optional[Union[<span class="bu">int</span>, <span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span>,</span>
<span id="lst-lc_agent_tools_mi-16"><a href="#lst-lc_agent_tools_mi-16" aria-hidden="true" tabindex="-1"></a>        angle: Optional[Union[<span class="bu">int</span>, <span class="bu">float</span>]] <span class="op">=</span> <span class="va">None</span></span>
<span id="lst-lc_agent_tools_mi-17"><a href="#lst-lc_agent_tools_mi-17" aria-hidden="true" tabindex="-1"></a>    ):</span>
<span id="lst-lc_agent_tools_mi-18"><a href="#lst-lc_agent_tools_mi-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># check for the values we have been given</span></span>
<span id="lst-lc_agent_tools_mi-19"><a href="#lst-lc_agent_tools_mi-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> adjacent_side <span class="kw">and</span> opposite_side:</span>
<span id="lst-lc_agent_tools_mi-20"><a href="#lst-lc_agent_tools_mi-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> sqrt(<span class="bu">float</span>(adjacent_side)<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="bu">float</span>(opposite_side)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="lst-lc_agent_tools_mi-21"><a href="#lst-lc_agent_tools_mi-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> adjacent_side <span class="kw">and</span> angle:</span>
<span id="lst-lc_agent_tools_mi-22"><a href="#lst-lc_agent_tools_mi-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">float</span>(adjacent_side) <span class="op">/</span> cos(<span class="bu">float</span>(angle))</span>
<span id="lst-lc_agent_tools_mi-23"><a href="#lst-lc_agent_tools_mi-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> opposite_side <span class="kw">and</span> angle:</span>
<span id="lst-lc_agent_tools_mi-24"><a href="#lst-lc_agent_tools_mi-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">float</span>(opposite_side) <span class="op">/</span> sin(<span class="bu">float</span>(angle))</span>
<span id="lst-lc_agent_tools_mi-25"><a href="#lst-lc_agent_tools_mi-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="lst-lc_agent_tools_mi-26"><a href="#lst-lc_agent_tools_mi-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="st">"Could not calculate the hypotenuse of the triangle. Need two or more of `adjacent_side`, `opposite_side`, or `angle`."</span></span>
<span id="lst-lc_agent_tools_mi-27"><a href="#lst-lc_agent_tools_mi-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="lst-lc_agent_tools_mi-28"><a href="#lst-lc_agent_tools_mi-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _arun(<span class="va">self</span>, query: <span class="bu">str</span>):</span>
<span id="lst-lc_agent_tools_mi-29"><a href="#lst-lc_agent_tools_mi-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">NotImplementedError</span>(<span class="st">"This tool does not support async"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="总结" class="level2" data-number="14.8">
<h2 data-number="14.8" class="anchored" data-anchor-id="总结"><span class="header-section-number">14.8</span> 总结</h2>
<p>在本章的简单示例中，我们介绍了 LangChain Agent &amp; Tool 的基本结构，Agent 可以作为控制器来驱动各种工具并最终完成任务，这真是一件令人振奋的事情~</p>
<p>当然，我们可以做的远不止于此。我们可以将无限的功能和服务集成在 Tool 中，或与其他的专家模型进行通信。</p>
<p>我们可以使用 LangChain 提供的默认工具来运行 SQL 查询、执行数学计算、进行向量搜索。</p>
<p>当这些默认工具无法满足我们的要求时，我们还可以自己动手构建我们自己的工具，以丰富 LLM 的能力，并最终实现我们的目的。</p>


<div id="refs" class="references csl-bib-body" role="list" style="display: none">
<div id="ref-karpas2022mrkl" class="csl-entry" role="listitem">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">Karpas, E. 等 2022. <a href="https://arxiv.org/abs/2205.00445">MRKL Systems: A modular, neuro-symbolic architecture that combines large language models, external knowledge sources and discrete reasoning</a>. (2022).</div>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="wangwei1237/LLM_in_Action" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./langchain_function_call.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">LangChain 函数调用</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./langchain_agent_chat.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">LangChain Chat Agent</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">Copyright VII-QA. All Rights Reserved.</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>