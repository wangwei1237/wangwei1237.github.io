<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>大模型的运行时推理和 KV Cache</title>
    <url>/2024/11/16/The-LLMs-Runtime-Inference-and-KV-Cache/</url>
    <content><![CDATA[<p><img src="/2024/11/16/The-LLMs-Runtime-Inference-and-KV-Cache/Prefill-and-decoding-phase-in-the-LLM-inference.png" alt></p>
<span id="more"></span>]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>Prefill</tag>
        <tag>KV Cache</tag>
        <tag>Runtime Inference</tag>
      </tags>
  </entry>
  <entry>
    <title>从 Transformer 到 GPT</title>
    <url>/2024/10/31/From-Transformer-To-GPT/</url>
    <content><![CDATA[<p><img src="/2024/10/31/From-Transformer-To-GPT/1.png" alt><br>
在 <a href="/2024/10/16/What-exactly-is-attention/">自注意力究竟是什么？</a> 一文中，我们介绍了基于注意力机制的 Transformer 模型的基本原理和架构。</p>
<ul>
<li>2017年 6 月，谷歌机器翻译团队提出的机器翻译模型 Transformer 就像大语言模型的一颗种子一样，悄然落地生根，并迅速席卷了 AI 领域。</li>
<li>一年之后，2018 年 6 月，OpenAI 发布了基于 Transformer 架构的 GPT-1<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>，虽然当时还存在一些局限性，例如当时还不能根据一个给定的标题来生成一篇新闻报道；但是，谁也没想到，就是这个框架，在 4 年之后成为了 AI 领域最炙手可热的模型。</li>
<li>4 个月后，2018 年 10 月，谷歌也发布了基于 Transformer 架构的 BERT 模型<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>，与 GPT-1 相比，BERT 在很多下游任务上表现出更强劲的性能，并且也刷新了多个榜单的记录。在很长一段时间里，BERT（及其变体）一直处于各类榜单的首位，是人们谈论的焦点。</li>
<li>直到 2022 年 3 月，OpenAI 发布了 GPT-3.5<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>，并基于 GPT-3.5 于当年的 11 月 30 日正式发布了面向消费用户的产品——ChatGPT，大模型再次引起了圈内、圈外的广泛讨论，开启了新一轮的大模型时代。</li>
</ul>
<p>这篇文章，我们就来详细的介绍一下传奇的 GPT 模型以及其原理，慢慢揭开 GPT 那神秘的面纱，也为后续对 <a href="https://openai.com/index/api-prompt-caching/">Prompt Caching</a> 的讨论打下坚实的基础。</p>
<span id="more"></span>
<h2 id="大语言模型族谱">大语言模型族谱</h2>
<p><a href="https://arxiv.org/abs/2304.13712">A Survey on ChatGPT and Beyond</a> 给出了基于 Transformer 架构的大语言模型的发展概况和不同模型之间的演化关系<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>：</p>
<p><img src="/2024/10/31/From-Transformer-To-GPT/LLMTree.jpeg" alt="大语言模型进化树"></p>
<p>从图中可以看出，大语言模型的架构整体上可以分为 Enoder-Only、Encoder-Decoder、Decoder-Only 三类：</p>
<ul>
<li>Encoder-Only 模型：仅包含 Transformer 中的编码器部分，主要用于从输入数据提取特征或表示，最典型的代表就是 2018 年 10 月，谷歌也发布的 BERT<sup class="footnote-ref"><a href="#fn2" id="fnref2:1">[2:1]</a></sup>。</li>
<li>Encoder-Decoder 模型：包含完整的 Transformer 的编码器和解码器，编码器负责将输入序列转换为压缩的中间表示，解码器则基于这个中间表示生成目标输出序列，最典型的代表就是 2019 年 谷歌发布的 T5 模型<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>。</li>
<li>Decoder-Only 模型：仅包含 Transformer 中的解码器部分，专注于使用 <strong>自回归</strong> 的方式根据前面生成的内容生成新的序列，新的输出仅依赖于前面生成的所有内容，最典型的代表就是 2018 年 6 月，OpenAI 发布的 GPT-1<sup class="footnote-ref"><a href="#fn1" id="fnref1:1">[1:1]</a></sup>。2020 年 1月，OpenAI 发布了所谓的语言模型的 <strong>Scaling Law</strong> <sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>，尤其是在 当前的 5 月发布 GPT-3<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup> 之后，Decoder-Only 架构成为了语言模型领域的主流架构。到目前为止，我们所熟知的大部分的大语言模型都是基于 Decoder-Only 架构，真可谓是一枝独秀。</li>
</ul>
<h2 id="自编码-自回归">自编码&amp;自回归</h2>
<p>对于 <strong>『北京的秋天是最美的季节，我爱北京』</strong> 这句话，如果我们对这句话中的词进行随机掩码（遮盖），我们可以得到如下的掩码结果：</p>
<blockquote>
<p>北京的<code>__</code>是最美的季节，我爱北京</p>
</blockquote>
<p>我们的目标就是让模型来预测空白处的被掩码掉的词。有两种模型可以完成这个任务：自编码模型（Auto-Encoder）和自回归模型（Auto-Regressive）。</p>
<h3 id="自编码模型">自编码模型</h3>
<p>自编码模型在预测 <code>空白词</code> 时会同时从两个方向阅读句子，可以同时利用正向预测和反向预测的优势来完成预测：</p>
<ul>
<li>如果使用正向预测，那么模型会从左到右读取所有的词，直到遇到 <code>空白词</code>，然后进行预测：</li>
</ul>
<blockquote>
<p>北京的<code>__</code></p>
</blockquote>
<ul>
<li>如果使用反向预测，那么模型会从右到左读取所有的词，直到遇到 <code>空白词</code>，然后进行预测：</li>
</ul>
<blockquote>
<p><code>__</code>是最美的季节，我爱北京</p>
</blockquote>
<p>从两个方向读取句子，模型能够更加全面和清晰的理解句子，因此自编码模型能够给出更好的结果。这也就是为什么比 GPT-1 晚 4 个月发布 BERT 模型在当时能够获得更好的效果的主要原因<sup class="footnote-ref"><a href="#fn2" id="fnref2:2">[2:2]</a></sup>，也是 2021 年以前，以 BERT 为代表的自编码模型能够一骑绝尘的原因。</p>
<p><img src="/2024/10/31/From-Transformer-To-GPT/bert_result.png" alt="来源：BERT, Pre-training of Deep Bidirectional Transformers for Language Understanding"></p>
<h3 id="自回归模型">自回归模型</h3>
<p>与自编码模型不同，自回归模型在预测 <code>空白词</code> 时要么仅使用正向预测，要么仅使用反向预测，而不能像自编码模型那样可以同时利用正向预测和反向预测的优势来完成预测。大部分情况下，在预测 <code>空白词</code> 时，自回归模型会使用正向预测：</p>
<blockquote>
<p>北京的<code>__</code></p>
</blockquote>
<p>本质上，自回归模型是单向预测模型，也就是说，自回归模型只能沿一个方向来理解句子并做出预测。这也就是我们通常所说的：GPT 只能根据输入序列中的前面的内容来预测序列中的下一个词。</p>
<h2 id="gpt-模型">GPT 模型</h2>
<h3 id="gpt-1">GPT-1</h3>
<p>在 <em>Improving Language Understanding by Generative Pre-Training</em> <sup class="footnote-ref"><a href="#fn1" id="fnref1:2">[1:2]</a></sup> 中，OpenAI 提出了 GPT-1 的模型架构（预训练模型+下游任务微调），并且其核心是一种 <strong>多层 Transformer 解码器</strong> 的 Transformer 架构变体。GPT-1 先计算输入的上下文 tokens 的多头自注意力，然后在经过前向反馈网络的处理，最终生成目标输出 token 的概率分布。在论文的第 3 节 Framework 中，给出了模型的整体架构描述：</p>
<blockquote>
<p>In our experiments, we use a <strong>multi-layer Transformer decoder</strong> for the language model, which is a variant of the transformer. This model applies a multi-headed self-attention operation over the input context tokens followed by position-wise feedforward layers to produce an output distribution over target tokens.</p>
</blockquote>
<p>在论文的第 4 节 Experiments 中，给出了模型的详细参数和训练细节，包括模型超参数、训练数据集和训练过程等：</p>
<blockquote>
<p><strong>Model specifications</strong></p>
<ul>
<li>Our model largely follows the original transformer work.</li>
<li>We trained a 12-layer decoder-only transformer with masked self-attention heads (768 dimensional states and 12 attention heads).</li>
<li>For the position-wise feed-forward networks, we used 3072 dimensional inner states. We used the Adam optimization scheme with a max learning rate of 2.5e-4. The learning rate was increased linearly from zero over the first 2000 updates and annealed to 0 using a cosine schedule. We train for 100 epochs on minibatches of 64 randomly sampled, contiguous sequences of 512 tokens.</li>
<li>Since layernorm is used extensively throughout the model, a simple weight initialization of N(0,0.02) was sufficient.</li>
<li>We used a bytepair encoding (BPE) vocabulary with 40,000 merges and residual, embedding, and attention dropouts with a rate of 0.1 for regularization. We also employed a modified version of L2 regularization proposed in , with w= 0.01 on all non bias or gain weights. For the activation function, we used the Gaussian Error Linear Unit (GELU).</li>
<li>We used learned position embeddings instead of the sinusoidal version proposed in the original work.</li>
</ul>
</blockquote>
<h3 id="gpt-2">GPT-2</h3>
<p>在 <em>Language Models are Unsupervised Multitask Learners</em> <sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup> 中的第 2 节 Approach 中，给出了 GPT-2 和 GPT-1 在处理下游任务的数据的不同：</p>
<ul>
<li>GPT-1 对下游任务的数据进行了标注和处理，加入了一些特殊的词元（&lt;s&gt;，&lt;e&gt;，&lt;$&gt;），分别表示开始、提取、分隔。在预训练阶段，模型没有见过这些词元，因此模型必须经过微调阶段的重新训练后才会认识这些新增加的词元。</li>
<li>在 GPT-2 的 Zero-Shot 的设定下，对于下游任务而言，模型不能再次被调整和更新，因此就无法再引入一些新的词元。也就是说，对于下游任务的输入，模型在预训练阶段都应该见过，这要求模型的输入必须更接近人类的自然语言。在建模过程中，只有一个学习任务，即给定输入序列来预测输出单词的概率：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">∣</mi><mi>i</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(output|input)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mord">∣</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span></span>。同时，模型应该能够执行许多不同的任务，不同的任务，即使输入相同，模型的输出也应该不同，因此模型的学习目标就变成了在给定输入和任务的前提下预测输出的概率：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">∣</mi><mi>i</mi><mi>n</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo separator="true">,</mo><mi>t</mi><mi>a</mi><mi>s</mi><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(output|input, task)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord mathdefault">o</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mord">∣</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mord mathdefault">p</span><span class="mord mathdefault">u</span><span class="mord mathdefault">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span>。</li>
</ul>
<p>在模型的后续发展中，我们称 GPT-2 中这种更接近人类自然语言的输入为 <strong>提示词</strong>（<em>Prompt</em>），GPT-2 的这种 Zero-Shot 设定和使用自然语言提示词来指导预训练模型执行下游任务是 GPT-2 的最大胆的一步。</p>
<p>但是，在模型结构上，论文的第 2.3 节 Model 中指出，GPT-2 与 GPT-1 相比基本一致，仅仅是做了一些小的修改而已：</p>
<ul>
<li>把 Post-LN 改成了 Pre-LN</li>
<li>在最后一个 Transformer-Decoder 模块之后增加了一个 Norm 层。</li>
<li>扩大了 Transformer-Encoder 模块的层数以及模型对应的超参数的增加。</li>
</ul>
<blockquote>
<p>We use a Transformer based architecture for our LMs.</p>
<ul>
<li>The model largely follows the details of the OpenAI GPT model (Radford et al., 2018) with a few modifications.</li>
<li>Layer normalization was moved to the input of each sub-block, similar to a pre-activation residual network and an additional layer normalization was added after the final self-attention block.</li>
</ul>
</blockquote>
<h3 id="gpt-3">GPT-3</h3>
<p>GPT-1 提出的“预训练模型+下游任务微调”的模式有一个很大的限制：下游任务需要针对特定任务标注数据集。GPT-2 虽然可以实 Zero-Shot，并不再需要针对特定任务标注数据集，但在当时仍然存在很多限制导致模型并没有达到 SOTA 的效果。</p>
<p>从应用的角度讲，持续提升 Zero-Shot 的效果非常必要，因为对于“预训练模型+下游任务微调”而言：</p>
<ul>
<li>不同的下游任务都需要大量的标注数据集，但是下游任务类型非常多，如果每个任务都要收集数据集并微调的话，成本相对较大。</li>
<li>在下游任务上微调之后的效果好并不一定能说明预训练的大模型泛化效果好，还有可能是过拟合了预训练数据集所包含的一部分微调任务的数据而已。因此，对于下游任务而言，如果不需要针对性的微调，那么起决定性作用的就是预训练模型的泛化性。</li>
<li>从人类学习一个新技能的角度看，我们执行一个新的任务时并不需要巨大的数据集，可能看一两个例子就学会了。</li>
</ul>
<p>对于所有类型的任务，在没有任何梯度更新或微调的情况下，GPT-3 只需通过自然语言文本的方式给出少量示例并指定任务就可以完成对应的任务。</p>
<p>在 <em>Language Models are Few-Shot Learners</em> <sup class="footnote-ref"><a href="#fn7" id="fnref7:1">[7:1]</a></sup> 的第 2.1 节 Model and Architectures 中指出，GPT-3 和 GPT-2 的模型架构是一致的，并且为了验证先前的论文 <em>Scaling Laws for Neural Language Models</em> <sup class="footnote-ref"><a href="#fn6" id="fnref6:1">[6:1]</a></sup> 中提出的“Scaling Laws”，OpenAI 特意训练了 8 个不同规模的模型。</p>
<blockquote>
<ul>
<li>We use the same model and architecture as GPT-2, including the modified initialization, pre-normalization, and reversible tokenization described therein, with the exception that we use alternating dense and locally banded sparse attention patterns in the layers of the transformer, similar to the Sparse Transformer.</li>
<li>To study the dependence of ML performance on model size, we train 8 different sizes of model, ranging over three orders of magnitude from 125 million parameters to 175 billion parameters, with the last being the model we call GPT-3.</li>
</ul>
</blockquote>
<h3 id="gpt-架构的演化">GPT 架构的演化</h3>
<p>因此，根据如上的描述，我们可以看出 GPT 系列模型架构的演化过程如下：</p>
<p><img src="/2024/10/31/From-Transformer-To-GPT/GPTX_arch.png" alt="从 Transformer 到 GPT 架构的演化"></p>
<p>利用如上的模型架构，我们可以实现如下所示的内容生成任务：</p>
<p><img src="/2024/10/31/From-Transformer-To-GPT/GPT_demo_for_student.gif" alt="使用 GPT 进行内容续写的示例"></p>
<h2 id="gpt-的压缩本质">GPT 的压缩本质</h2>
<p>在如上的 demo 中，GPT 是如何根据提示词来生成下一个词呢？</p>
<p>在 <a href="/2024/10/16/What-exactly-is-attention/">自注意力究竟是什么？</a> 这篇文章的 <em>举个例子🌰</em> 这一节我们提到，经过矩阵的线性变换后，<code>I am good</code> 这三个词的词向量之间可以表示成如下的形式：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mi mathvariant="bold">I</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.97</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">I</mi></msub><mo>+</mo><mn>0.02</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub><mo>+</mo><mn>0.01</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.27</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">I</mi></msub><mo>+</mo><mn>0.73</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub><mo>+</mo><mn>0.00</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.90</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">I</mi></msub><mo>+</mo><mn>0.05</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub><mo>+</mo><mn>0.05</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{z_{I}}    &amp;= 0.97 \cdot \mathbf{x_{I}} + 0.02 \cdot \mathbf{x_{am}} + 0.01 \cdot \mathbf{x_{good}} \\
\mathbf{z_{am}}   &amp;= 0.27 \cdot \mathbf{x_{I}} + 0.73 \cdot \mathbf{x_{am}} + 0.00 \cdot \mathbf{x_{good}} \\
\mathbf{z_{good}} &amp;= 0.90 \cdot \mathbf{x_{I}} + 0.05 \cdot \mathbf{x_{am}} + 0.05 \cdot \mathbf{x_{good}}
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">7</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>换句话说，经过自注意力机制后，提示词中的最后一个词都将包含提示词中的任何一个单词的信息。随着 Transformer-Decoder 的层级不断增加，提示词中的最后一个词所包含的信息将会越来越丰富、越来越精准。从另一个角度来讲，经过多层 Transformer-Decoder 之后，提示词中的所有信息将压缩至了最后一个词向量中，然后，我们就可以利用最后一个词向量来生成下一个词。</p>
<p>具体的过程如下图所示：</p>
<p><img src="/2024/10/31/From-Transformer-To-GPT/llm_compress.png" alt="词向量的处理流程"></p>
<p>这也就是为什么 OpenAI 前首席科学家 Ilya Sutskever 在<a href="https://www.youtube.com/watch?v=goOa0biX6Tc&amp;ab_channel=FuVenture">公开采访</a> 中指出大规模预训练本质上是在做一个世界知识的压缩，从而能够学习到一个编码世界知识的参数模型，这个模型能够通过解压缩所需要的知识来解决真实世界的任务。</p>
<p>所以 Ilya Sutskever 一直的信念就是：</p>
<blockquote>
<p>如果能够高效的压缩信息，就已经得到了知识。想高效压缩信息，就一定得有一些知识，所以他坚信 GPT-3 和最新的 GPT-4，它们已经有了一个世界模型在里面！GPT 学的其实不是语言，而是语言背后的那个真实世界。</p>
</blockquote>
<p>在 <a href="https://arxiv.org/pdf/2309.10668">Language Modeling Is Compression</a> 这篇论文中，作者也提到：</p>
<blockquote>
<p>由于大模型表现出强悍的预测能力，因此它们非常适合成为强大的压缩器。我们通过压缩的视角来看待大模型的预测问题，并评估了大模型的压缩能力。</p>
</blockquote>
<h2 id="gpt-模型的参数量">GPT 模型的参数量</h2>
<p>在 <em>Language Models are Few-Shot Learners</em> <sup class="footnote-ref"><a href="#fn7" id="fnref7:2">[7:2]</a></sup> 中提到，GPT-3 的参数数量是 1750 亿，我们也经常说 ChatGPT 的参数数量是 1750 亿，那么如何计算模型的参数数量呢？</p>
<p>既然 GPT-3 的架构、超参数都是公开的，我们不妨按照相关数据来测算一下 GPT-3 的参数数量，也借这个机会熟悉一下 GPT 系列模型的细节。</p>
<p>对于之前的文本生成的例子，下图展示了其中的一个迭代的详细过程：</p>
<p><img src="/2024/10/31/From-Transformer-To-GPT/GPT_arch_detail.png" alt="GPT 预测下一个词的详细过程"></p>
<p>如上图所示，对于 GPT 架构而言，整个预测的过程可以分为 6 个步骤：</p>
<ol>
<li>
<p>分词<br>
对于原始的输入 <code>我是一个学生</code>，首先需要使用某种分词算法进行分词，并得到分词之后的 Tokens 序列：</p>
<blockquote>
<p>tokens = [我是, 一个, 学生]</p>
</blockquote>
<p>以 GPT-3 为例，模型的总词汇量（tokens）为 50257，每个 token 都有一个对应的 ID 序号，比如 <code>tokens = [我是, 一个, 学生]</code> 对应的 ID 序号为：</p>
<blockquote>
<p>tokens = [176389, 22912, 52770]</p>
</blockquote>
<p>对于分词而言，并不涉及到任何的模型参数，由于涉及到的计算量并不大，因此整体的操作均在 CPU 上完成。得到 tokens 后，然后将对应的序列发送给 GPU 进行计算。</p>
</li>
<li>
<p>词嵌入<br>
模型需要根据 <code>tokens = [176389, 22912, 52770]</code> 中的 ID 得到对应 token 的词向量，并组装成矩阵形式的输入序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span>。在这个过程中，需要使用模型的词嵌入矩阵，该矩阵的每一行代表一个 token 的词向量，词嵌入矩阵的维度依赖于具体的模型。以 GPT-3 为例，其词汇量为 50257，每个 token 的维度为 12288，所以 GPT-3 的词嵌入矩阵的维度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>50257</mn><mo>×</mo><mn>12288</mn></mrow><annotation encoding="application/x-tex">50257 \times 12288</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mord">0</span><span class="mord">2</span><span class="mord">5</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span></span></span></span>，也就是共计有 <code>617,558,016</code> 个参数。</p>
</li>
<li>
<p>位置嵌入<br>
根据 <a href="/2024/10/16/What-exactly-is-attention/#transformer-%E4%B8%AD%E7%9A%84-positional-encoding">自注意力究竟是什么？中的 Transformer 中的 Positional Encoding 一节</a> 中的介绍，我们还需要对输入的矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 增加位置信息，并得到含有位置信息的输入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span>。而在该步骤中，需要使用到模型的位置嵌入矩阵，该矩阵的行数和模型的上下文大小一致，并且每一行的大小和模型的词嵌入矩阵中每个 token 的维度一致。以 GPT-3 为例，其模型上下文大小为 2048，所以 GPT-3 的位置嵌入矩阵的维度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2048</mn><mo>×</mo><mn>12288</mn></mrow><annotation encoding="application/x-tex">2048 \times 12288</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mord">4</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span></span></span></span>，也就是共计有 <code>25,165,824</code> 个参数。</p>
</li>
<li>
<p>计算自注意力<br>
接下来，需要根据输入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 计算自注意力，根据之前的介绍，需要首先利用 3 个权重矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> 对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 进行线性变换并得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span>，然后利用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">Q</mi><mo separator="true">,</mo><mi mathvariant="bold">K</mi><mo separator="true">,</mo><mi mathvariant="bold">V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(\mathbf{Q},\mathbf{K},\mathbf{V})=\text{softmax}\left(\frac{\mathbf{Q}\mathbf{K}^T}{\sqrt{d_k}}\right)\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">Q</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">K</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.80002em;vertical-align:-0.65002em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.089473em;"><span style="top:-2.5864385em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622307142857143em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222307142857144em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">Q</span></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9190928571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span> 计算自注意力。在 GPT-3 中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> 的维度均为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12288</mn><mo>×</mo><mn>128</mn></mrow><annotation encoding="application/x-tex">12288 \times 128</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span></span></span></span>，并且每个解码器包含 96 个自注意力模块，因此共计有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12288</mn><mo>×</mo><mn>128</mn><mo>×</mo><mn>3</mn><mo>×</mo><mn>96</mn></mrow><annotation encoding="application/x-tex">12288 \times 128 \times 3 \times 96</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">9</span><span class="mord">6</span></span></span></span>——即 <code>452,984,832</code> 个参数。对于多头注意力计算的结果，还需要使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>96</mn><mo>∗</mo><mn>128</mn><mo>×</mo><mn>12288</mn></mrow><annotation encoding="application/x-tex">96*128 \times 12288</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">9</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span></span></span></span> 的矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span> 对其进行线性变换，因此还需要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>96</mn><mo>∗</mo><mn>128</mn><mo>×</mo><mn>12288</mn></mrow><annotation encoding="application/x-tex">96*128 \times 12288</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">9</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span></span></span></span>——即 <code>150,994,944</code> 个参数。因此，对于每个解码器而言，自注意力模块的参数共计有 <code>603,979,776</code> 个参数。而 GPT-3 中，共计包含 96 个解码器，因此共计有 <code>57,982,058,496</code> 个参数。</p>
</li>
</ol>
<p><img src="/2024/10/31/From-Transformer-To-GPT/mhattention_parameters.png" alt></p>
<ol start="5">
<li>前向反馈网络处理<br>
前向连接层的计算公式为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>FFN</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>max</mtext><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi mathvariant="bold">x</mi><msub><mi mathvariant="bold">W</mi><mn>1</mn></msub><mo>+</mo><msub><mi mathvariant="bold">b</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mi mathvariant="bold">W</mi><mn>2</mn></msub><mo>+</mo><msub><mi mathvariant="bold">b</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\text{FFN}(\mathbf{x}) = \text{max}(0, \mathbf{x}\mathbf{W}_1 + \mathbf{b}_1)\mathbf{W}_2+\mathbf{b}_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">FFN</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">max</span></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">x</span></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">b</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，因此，其参数包括四个部分：两个权重矩阵和两个偏置变换。权重矩阵的维度 = 词向量维度 * 隐藏层维度，在 GPT-3 中，隐藏层维度为 4 倍词向量维度，因此，前向反馈网络的参数量为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12288</mn><mo>∗</mo><mo stretchy="false">(</mo><mn>12288</mn><mo>∗</mo><mn>4</mn><mo stretchy="false">)</mo><mo>∗</mo><mn>2</mn><mo>+</mo><mn>12288</mn><mo>∗</mo><mn>4</mn><mo>+</mo><mn>12288</mn></mrow><annotation encoding="application/x-tex">12288 * (12288 * 4) * 2 + 12288 * 4 + 12288</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">2</span><span class="mord">8</span><span class="mord">8</span></span></span></span>——即 <code>1,208,020,992</code> 个参数。而 GPT-3 中，共计包含 96 个解码器，因此共计有 <code>115,970,015,232</code> 个参数。</li>
<li>线性层生成 logit 向量 并计算概率<br>
最终，经过 96 层的解码器之后，我们得到了最后一个词的向量表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">h</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{h}_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">h</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，然后利用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">h</mi><mi>n</mi></msub><msubsup><mi mathvariant="bold">W</mi><mi>e</mi><mi>T</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{softmax}(\mathbf{h}_n\mathbf{W}_e^T)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913309999999998em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf">h</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">e</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 计算下一个词的可能概率。由于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">W</mi><mi>e</mi><mi>T</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{W}_e^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.088331em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">e</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span> 和模型的词向量矩阵是一致的，因此不需要额外的参数。</li>
</ol>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">归一化层的参数
</p><p>对于 GPT-3 模型而言，除了如上的步骤外，在每一个解码器中，还会有 2 个归一化层，同时在最后一个解码器之后，还增加了一个额外的归一化层，其主要作用为：</p>
<ul>
<li>稳定训练过程：在深度神经网络中，层归一化通过将每层的输入标准化为相同的分布，减少了梯度爆炸或梯度消失的问题，使模型能够更稳定地进行训练。</li>
<li>加速收敛：归一化层可以使模型在训练中更快地找到合适的权重参数，通常会加快模型的收敛速度，从而缩短训练时间。</li>
<li>减小内部协变量偏移：归一化层通过使输入分布保持一致，减少了每层的激活分布随训练而发生的变化，从而有助于模型更容易捕捉数据的特征。</li>
<li>提升泛化能力：归一化操作可以使模型的训练更具鲁棒性，从而在测试数据上表现更好，提高模型的泛化能力。</li>
</ul>
<p>归一化层只涉及到两个参数：缩放参数（gamma）和偏移参数（beta），这两个参数的大小和模型的词向量维度大小一致。因此，对于 GPT-3 而言，每个归一化层需要 <code>12288 * 2 = 24,576</code> 个参数。</p>
</div>
<p>我们可以使用如下的代码来计算 GPT 的参数数量，完整的代码参见 <a href="https://github.com/wangwei1237/R/blob/main/llm_parameters.R">llm_parameters.R</a>。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">get_llm_parameters_cnt &lt;- <span class="keyword">function</span>(</span><br><span class="line">  model_name = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  n_vocabulary,    <span class="comment"># 模型的总 token 量</span></span><br><span class="line">  n_ctx,           <span class="comment"># 模型的 prompt 窗口大小</span></span><br><span class="line">  d_model,         <span class="comment"># 模型的 embedding 向量维度</span></span><br><span class="line">  d_q,             <span class="comment"># W^Q 矩阵的行向量维度</span></span><br><span class="line">  d_k,             <span class="comment"># W^K 矩阵的行向量维度</span></span><br><span class="line">  d_v,             <span class="comment"># W^V 矩阵的行向量维度</span></span><br><span class="line">  n_heads,         <span class="comment"># 每一个解码器中多头注意力矩阵的头数</span></span><br><span class="line">  n_layers,        <span class="comment"># 解码器的层数</span></span><br><span class="line">  d_ff             <span class="comment"># 前向反馈网络隐藏层的维度</span></span><br><span class="line">) &#123;</span><br><span class="line">  n_embedding  &lt;- n_vocabulary * d_model</span><br><span class="line">  n_position   &lt;- n_ctx * d_model</span><br><span class="line"></span><br><span class="line">  <span class="comment"># n_layers 层解码器的总参数</span></span><br><span class="line">  n_attention  &lt;- n_layers * single_decoder_attention_cnt(d_model,</span><br><span class="line">                                                          d_q,</span><br><span class="line">                                                          d_k,</span><br><span class="line">                                                          d_v,</span><br><span class="line">                                                          n_heads)</span><br><span class="line">  n_ffn        &lt;- n_layers * single_decoder_ffn_cnt(d_model, d_ff)</span><br><span class="line">  n_norm       &lt;- n_layers * single_decoder_norm_cnt(d_model)</span><br><span class="line">  n_top_norm   &lt;- 2 * d_model <span class="comment"># 最顶层的 Norm 层的参数</span></span><br><span class="line"></span><br><span class="line">  total_params &lt;- n_embedding + n_position + n_attention + n_ffn + n_norm +</span><br><span class="line">    n_top_norm</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 输出相关参数</span></span><br><span class="line">  df &lt;- data.frame(Model     = model_name,</span><br><span class="line">                   Embedding = n_embedding,</span><br><span class="line">                   Emd_Rate  = <span class="built_in">round</span>(n_embedding / total_params, <span class="number">1</span>),</span><br><span class="line">                   Position  = n_position,</span><br><span class="line">                   Attention = n_attention,</span><br><span class="line">                   Atn_Rate  = <span class="built_in">round</span>(n_attention / total_params, <span class="number">1</span>),</span><br><span class="line">                   Ffn       = n_ffn,</span><br><span class="line">                   Ffn_Rate  = <span class="built_in">round</span>(n_ffn / total_params, <span class="number">1</span>),</span><br><span class="line">                   Norm      = n_norm,</span><br><span class="line">                   Total     = total_params)</span><br><span class="line">  print(kable(df, format = <span class="string">&quot;markdown&quot;</span>))</span><br><span class="line"></span><br><span class="line">  <span class="built_in">return</span>(total_params)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据论文中公开的模型超参数，我们可以得到不同模型的参数数量，如下表所示：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">llm_list &lt;- <span class="built_in">list</span>(</span><br><span class="line">  <span class="built_in">list</span>(model_name = <span class="string">&quot;GPT-1&quot;</span>,</span><br><span class="line">       n_vocabulary = <span class="number">40000</span>,</span><br><span class="line">       n_ctx = <span class="number">512</span>,</span><br><span class="line">       d_model = <span class="number">768</span>,</span><br><span class="line">       d_q = <span class="number">64</span>,</span><br><span class="line">       d_k = <span class="number">64</span>,</span><br><span class="line">       d_v = <span class="number">64</span>,</span><br><span class="line">       n_heads = <span class="number">12</span>,</span><br><span class="line">       n_layers = <span class="number">12</span>,</span><br><span class="line">       d_ff = <span class="number">768</span> * <span class="number">4</span>),</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">get_llm_list_parameters_cnt(llm_list)</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">Model</th>
<th style="text-align:right">Embedding</th>
<th style="text-align:right">Emd_Rate</th>
<th style="text-align:right">Position</th>
<th style="text-align:right">Attention</th>
<th style="text-align:right">Atn_Rate</th>
<th style="text-align:right">Ffn</th>
<th style="text-align:right">Ffn_Rate</th>
<th style="text-align:right">Norm</th>
<th style="text-align:right">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">GPT-1</td>
<td style="text-align:right">30720000</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">393216</td>
<td style="text-align:right">28311552</td>
<td style="text-align:right">0.2</td>
<td style="text-align:right">56669184</td>
<td style="text-align:right">0.5</td>
<td style="text-align:right">36864</td>
<td style="text-align:right">116132352</td>
</tr>
<tr>
<td style="text-align:left">GPT-2-Small</td>
<td style="text-align:right">38597376</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">786432</td>
<td style="text-align:right">28311552</td>
<td style="text-align:right">0.2</td>
<td style="text-align:right">56669184</td>
<td style="text-align:right">0.5</td>
<td style="text-align:right">36864</td>
<td style="text-align:right">124402944</td>
</tr>
<tr>
<td style="text-align:left">GPT-3-Small</td>
<td style="text-align:right">38597376</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">1572864</td>
<td style="text-align:right">28311552</td>
<td style="text-align:right">0.2</td>
<td style="text-align:right">56669184</td>
<td style="text-align:right">0.5</td>
<td style="text-align:right">36864</td>
<td style="text-align:right">125189376</td>
</tr>
<tr>
<td style="text-align:left">GPT-3-Medium</td>
<td style="text-align:right">51463168</td>
<td style="text-align:right">0.1</td>
<td style="text-align:right">2097152</td>
<td style="text-align:right">100663296</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">201449472</td>
<td style="text-align:right">0.6</td>
<td style="text-align:right">98304</td>
<td style="text-align:right">355773440</td>
</tr>
<tr>
<td style="text-align:left">GPT-3-Large</td>
<td style="text-align:right">77194752</td>
<td style="text-align:right">0.1</td>
<td style="text-align:right">3145728</td>
<td style="text-align:right">226492416</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">453169152</td>
<td style="text-align:right">0.6</td>
<td style="text-align:right">147456</td>
<td style="text-align:right">760152576</td>
</tr>
<tr>
<td style="text-align:left">GPT-3-XL</td>
<td style="text-align:right">102926336</td>
<td style="text-align:right">0.1</td>
<td style="text-align:right">4194304</td>
<td style="text-align:right">603979776</td>
<td style="text-align:right">0.4</td>
<td style="text-align:right">805552128</td>
<td style="text-align:right">0.5</td>
<td style="text-align:right">196608</td>
<td style="text-align:right">1516853248</td>
</tr>
<tr>
<td style="text-align:left">GPT-3-2.7B</td>
<td style="text-align:right">128657920</td>
<td style="text-align:right">0.0</td>
<td style="text-align:right">5242880</td>
<td style="text-align:right">838860800</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">1678131200</td>
<td style="text-align:right">0.6</td>
<td style="text-align:right">327680</td>
<td style="text-align:right">2651225600</td>
</tr>
<tr>
<td style="text-align:left">GPT-3-6.7B</td>
<td style="text-align:right">205852672</td>
<td style="text-align:right">0.0</td>
<td style="text-align:right">8388608</td>
<td style="text-align:right">2147483648</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">4295622656</td>
<td style="text-align:right">0.6</td>
<td style="text-align:right">524288</td>
<td style="text-align:right">6657880064</td>
</tr>
<tr>
<td style="text-align:left">GPT-3-13B</td>
<td style="text-align:right">258320980</td>
<td style="text-align:right">0.0</td>
<td style="text-align:right">10526720</td>
<td style="text-align:right">4210688000</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">8455300000</td>
<td style="text-align:right">0.7</td>
<td style="text-align:right">822400</td>
<td style="text-align:right">12935668380</td>
</tr>
<tr>
<td style="text-align:left">GPT-3-175B</td>
<td style="text-align:right">617558016</td>
<td style="text-align:right">0.0</td>
<td style="text-align:right">25165824</td>
<td style="text-align:right">57982058496</td>
<td style="text-align:right">0.3</td>
<td style="text-align:right">115970015232</td>
<td style="text-align:right">0.7</td>
<td style="text-align:right">4718592</td>
<td style="text-align:right">174599540736</td>
</tr>
</tbody>
</table>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition attention"><p class="admonition-title">Attention Is (Not) All You Need
</p><p>根据如上的参数量表格，在 GPT 架构中，Attention 层的参数占整个模型的参数的占比在 20%~40%，特别在 GPT-3-175B 模型中，Attention 层的参数占比只有 30%。因此，在大模型架构中，Attention 并非是模型的全部，<em>Attention Is <strong>(Not)</strong> All You Need</em>，这一点需要特别的注意。</p>
</div>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://openai.com/index/language-unsupervised/">Improving Language Understanding by Generative Pre-Training</a> <a href="#fnref1" class="footnote-backref">↩︎</a> <a href="#fnref1:1" class="footnote-backref">↩︎</a> <a href="#fnref1:2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://arxiv.org/abs/1810.04805">BERT: Pre-training of Deep Bidirectional Transformers for Language Understanding</a> <a href="#fnref2" class="footnote-backref">↩︎</a> <a href="#fnref2:1" class="footnote-backref">↩︎</a> <a href="#fnref2:2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://arxiv.org/abs/2203.02155">Training language models to follow instructions with human feedback</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://arxiv.org/abs/2304.13712">Harnessing the Power of LLMs in Practice: A Survey on ChatGPT and Beyond</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://arxiv.org/abs/1910.10683">Exploring the Limits of Transfer Learning with a Unified Text-to-Text Transformer</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://arxiv.org/abs/2001.08361">Scaling Laws for Neural Language Models</a> <a href="#fnref6" class="footnote-backref">↩︎</a> <a href="#fnref6:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p><a href="https://arxiv.org/abs/2005.14165">Language Models are Few-Shot Learners</a> <a href="#fnref7" class="footnote-backref">↩︎</a> <a href="#fnref7:1" class="footnote-backref">↩︎</a> <a href="#fnref7:2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn8" class="footnote-item"><p><a href="https://cdn.openai.com/better-language-models/language_models_are_unsupervised_multitask_learners.pdf">Language Models are Unsupervised Multitask Learners</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>GPT</tag>
        <tag>Transformer</tag>
      </tags>
  </entry>
  <entry>
    <title>自注意力究竟是什么？</title>
    <url>/2024/10/16/What-exactly-is-attention/</url>
    <content><![CDATA[<p><img src="/2024/10/16/What-exactly-is-attention/1.png" alt></p>
<p>最近的 1 年多以来，一直使用 文心一言、豆包、Kimi 等大模型来帮助自己提高各种场景的效率，但是一直没有对当前大模型的底层原理做深入了解。在编写 <a href="https://wangwei1237.github.io/LLM_in_Action/">Large Language Model in Action</a> 这本书的时候，我也曾说过：</p>
<blockquote>
<p>这是一本关于大语言模型实践的书籍，而不是一本深入研究大语言模型的运行原理和底层算法的书籍。</p>
</blockquote>
<p>但是，2024 年 10 月 1 日，OpenAI 发布了 <a href="https://openai.com/index/api-prompt-caching/">Prompt Caching in the API</a> 以提升大语言模型 API 的性能。当听到这个消息的时候，我感到非常震惊，也非常兴奋，于是接下来的几天我总想搞明白这背后的原理是什么，这里的 <code>prompt caching</code> 又究竟是什么？</p>
<p>于是，我想，是时候需要深入了解一下当前大模型的起点——Transformer 模型，也是时候需要深入了解一下究竟什么是自注意力机制。</p>
<span id="more"></span>
<h2 id="向量的点积和矩阵表示">向量的点积和矩阵表示</h2>
<p>令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">x</span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi></mrow><annotation encoding="application/x-tex">\mathbf{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span></span></span> 表示维度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span> 的向量，即：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi mathvariant="bold">x</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">[</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi mathvariant="bold">y</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">[</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>y</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{x} &amp;= [x_1, x_2, ..., x_n] \\
\mathbf{y} &amp;= [y_1, y_2, ..., y_n]
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.0000000000000004em;vertical-align:-1.2500000000000002em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.7500000000000002em;"><span style="top:-3.91em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2500000000000002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">x</span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi></mrow><annotation encoding="application/x-tex">\mathbf{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span></span></span></span> 的点积运算（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⋅</mo></mrow><annotation encoding="application/x-tex">\cdot</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44445em;vertical-align:0em;"></span><span class="mord">⋅</span></span></span></span>）可以表示这两个向量之间的相似度，向量点积越大，表明两个向量越相似。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>⋅</mo><mi mathvariant="bold">y</mi><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><msub><mi>x</mi><mi>i</mi></msub><msub><mi>y</mi><mi>i</mi></msub></mrow><mo>=</mo><msub><mi>x</mi><mn>1</mn></msub><msub><mi>y</mi><mn>1</mn></msub><mo>+</mo><msub><mi>x</mi><mn>2</mn></msub><msub><mi>y</mi><mn>2</mn></msub><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><msub><mi>x</mi><mi>n</mi></msub><msub><mi>y</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{x} \cdot \mathbf{y} = \sum_{i=1}^{n}{x_iy_i} = x_1y_1 + x_2y_2 +...+ x_ny_n
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44445em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">x</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.63888em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.929066em;vertical-align:-1.277669em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>如果用向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi></mrow><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.44444em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">x</span></span></span></span></span> 表示一个词的词向量，对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">m</span></span></span></span> 个词向量而言，其任意两个词向量之间的相似度可以表示为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">i</mi></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">j</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mrow><msub><mi>x</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><msub><mi>y</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub></mrow><mo>=</mo><msub><mi>x</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><msub><mi>y</mi><mrow><mi>j</mi><mn>1</mn></mrow></msub><mo>+</mo><msub><mi>x</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><msub><mi>y</mi><mrow><mi>j</mi><mn>2</mn></mrow></msub><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><msub><mi>y</mi><mrow><mi>j</mi><mi>n</mi></mrow></msub><mspace width="1em"><mi mathvariant="normal">∀</mi><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><mi>m</mi></mspace></mrow><annotation encoding="application/x-tex">\mathbf{x_i} \cdot \mathbf{x_j} = \sum_{k=1}^{n}{x_{ik}y_{jk}} = x_{i1}y_{j1} + x_{i2}y_{j2} + ... + x_{in}y_{jn} \quad \forall i,j = 1,2,\cdots,m
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59445em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.730548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.9535100000000005em;vertical-align:-1.302113em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.300005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.302113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8694379999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord">∀</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">m</span></span></span></span></span></p>
<p>如果用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">m \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span> 的矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 来表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">m</span></span></span></span> 个词向量，</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>12</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mn>1</mn><mi>n</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>22</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mn>2</mn><mi>n</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mi>m</mi><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mi>m</mi><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mrow><mi>m</mi><mi>n</mi></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{X} = \begin{bmatrix}
\mathbf{x_1} \\
\mathbf{x_2} \\
\vdots \\
\mathbf{x_m}
\end{bmatrix} = \begin{bmatrix}
x_{11} &amp; x_{12} &amp; \cdots &amp; x_{1n} \\
x_{21} &amp; x_{22} &amp; \cdots &amp; x_{2n} \\
\vdots &amp; \vdots &amp; \vdots &amp; \vdots \\
x_{m1} &amp; x_{m2} &amp; \cdots &amp; x_{mn}
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:5.459999999999999em;vertical-align:-2.4799999999999995em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:5.459999999999999em;vertical-align:-2.4799999999999995em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="minner">⋯</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">S</mi><mo>=</mo><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">X</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{S} = \mathbf{X} \mathbf{X}^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">S</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf">X</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>×</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">m \times m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">m</span></span></span></span> 的矩阵，并且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">i</mi></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">j</mi></msub></mrow><annotation encoding="application/x-tex">s_{ij} = \mathbf{x_i} \cdot \mathbf{x_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.59445em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.730548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span> 表示第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> 个词向量和第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span></span></span> 个词向量之间的相似度。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">X</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{X}\mathbf{X}^T = \begin{bmatrix}
\mathbf{x_1} \cdot \mathbf{x_1} &amp; \mathbf{x_1} \cdot \mathbf{x_2} &amp; \cdots &amp; \mathbf{x_1} \cdot \mathbf{x_m} \\
\mathbf{x_2} \cdot \mathbf{x_1} &amp; \mathbf{x_2} \cdot \mathbf{x_2}  &amp; \cdots &amp; \mathbf{x_2} \cdot \mathbf{x_m} \\
\vdots &amp; \vdots &amp; \vdots &amp; \vdots \\
\mathbf{x_m} \cdot \mathbf{x_1} &amp; \mathbf{x_m} \cdot \mathbf{x_2}  &amp; \cdots &amp; \mathbf{x_m} \cdot \mathbf{x_m}
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8913309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf">X</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:5.459999999999999em;vertical-align:-2.4799999999999995em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="minner">⋯</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>使用 <code>softmax()</code> 函数对矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">S</mi></mrow><annotation encoding="application/x-tex">\mathbf{S}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">S</span></span></span></span></span> 进行归一化处理得到矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">W</mi><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">X</mi><mi>T</mi></msup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{W} = \text{softmax}\left(\mathbf{X}\mathbf{X}^T\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf">X</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span>，使得 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">W</mi></mrow><annotation encoding="application/x-tex">\mathbf{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span></span></span></span> 中每一行的所有元素之和都为 1，于是每一行的各个元素就可以看作是一个权重。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>w</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>w</mi><mrow><mi>i</mi><mi>m</mi></mrow></msub></mrow><annotation encoding="application/x-tex">w_{i1},w_{i2},\cdots,w_{im}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 分别表示第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> 个词向量和第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><mi>m</mi></mrow><annotation encoding="application/x-tex">1,2,\cdots,m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">m</span></span></span></span> 个词向量之间的相似度权重，用该权重分别乘以对应的词向量，于是我们得到了第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> 个词的新的表达形式 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">z</mi><mi mathvariant="bold">i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{z_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>，某个词向量的权重越大，表示相似度越高。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">z</mi><mi mathvariant="bold">i</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">k</mi></msub></mrow><mo>=</mo><msub><mi>w</mi><mrow><mi>i</mi><mn>1</mn></mrow></msub><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub><mo>+</mo><msub><mi>w</mi><mrow><mi>i</mi><mn>2</mn></mrow></msub><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub><mo>+</mo><mo>⋯</mo><mo>+</mo><msub><mi>w</mi><mrow><mi>i</mi><mi>m</mi></mrow></msub><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{z_i} = \sum_{k=1}^{m}{w_{ik}\mathbf{x_k}} = w_{i1}\mathbf{x_1} + w_{i2}\mathbf{x_2} + \cdots + w_{im}\mathbf{x_m} 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.9535100000000005em;vertical-align:-1.302113em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000002em;"><span style="top:-1.8478869999999998em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.300005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.302113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">m</span></span></span></span> 个词向量都执行如上的操作可以得到：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">z</mi><mn mathvariant="bold">1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">z</mi><mn mathvariant="bold">2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">z</mi><mi mathvariant="bold">m</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>w</mi><mn>11</mn></msub><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>12</mn></msub><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub><mo>+</mo><mo>⋯</mo><mo>+</mo><msub><mi>w</mi><mrow><mn>1</mn><mi>m</mi></mrow></msub><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>w</mi><mn>21</mn></msub><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>22</mn></msub><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub><mo>+</mo><mo>⋯</mo><mo>+</mo><msub><mi>w</mi><mrow><mn>2</mn><mi>m</mi></mrow></msub><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="+0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>w</mi><mrow><mi>m</mi><mn>1</mn></mrow></msub><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub><mo>+</mo><msub><mi>w</mi><mrow><mi>m</mi><mn>2</mn></mrow></msub><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub><mo>+</mo><mo>⋯</mo><mo>+</mo><msub><mi>w</mi><mrow><mi>m</mi><mi>m</mi></mrow></msub><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">m</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{Z} = \begin{bmatrix}
\mathbf{z_1} \\
\mathbf{z_2} \\
\vdots \\
\mathbf{z_m}
\end{bmatrix} = \begin{bmatrix}
w_{11}\mathbf{x_1} + w_{12}\mathbf{x_2} + \cdots + w_{1m}\mathbf{x_m} \\
w_{21}\mathbf{x_1} + w_{22}\mathbf{x_2} + \cdots + w_{2m}\mathbf{x_m} \\
\vdots \\
w_{m1}\mathbf{x_1} + w_{m2}\mathbf{x_2} + \cdots + w_{mm}\mathbf{x_m}
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:5.459999999999999em;vertical-align:-2.4799999999999995em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:5.459999999999999em;vertical-align:-2.4799999999999995em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9799999999999995em;"><span style="top:-5.8275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-4.6275em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.7674999999999996em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord">⋮</span><span class="mord rule" style="border-right-width:0em;border-top-width:1.5em;bottom:0em;"></span></span></span></span><span style="top:-1.5675000000000006em;"><span class="pstrut" style="height:3.6875em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4799999999999995em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.953995em;"><span style="top:-1.3499850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.4999850000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.0959850000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.6919850000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.712975em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.953995em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.4500349999999997em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>实际上，可以证明：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi><mo>=</mo><mi mathvariant="bold">W</mi><mi mathvariant="bold">X</mi><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">X</mi><mi>T</mi></msup><mo fence="true">)</mo></mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{Z} = \mathbf{W}\mathbf{X} = \text{softmax}\left(\mathbf{X}\mathbf{X}^T\right)\mathbf{X}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2413409999999998em;vertical-align:-0.35001em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf">X</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span></span></p>
<p>于是，对于原始的词向量矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 而言，经过一些列的矩阵乘法运算，我们得到了根据相关性权重的加权词向量表示。也就是说原始的词向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{x_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 可以表示为所有词向量的加权表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">z</mi><mi mathvariant="bold">i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{z_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>。所以，可以用 <code>Attention</code> 来解释一句话中不同词之间的相互关系。Transformer 模型中的 <code>Attention</code> 其实就是矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi></mrow><annotation encoding="application/x-tex">\mathbf{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span></span></span></span>，所以 Transformer 可以理解输入序列中的不同的部分，并分析输入序列中不同词之间的关系，进而捕获到上下文信息。</p>
<p>了解如上介绍的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">X</mi><mi>T</mi></msup><mo fence="true">)</mo></mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\text{softmax}\left(\mathbf{X}\mathbf{X}^T\right)\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf">X</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 背后的逻辑对于理解 Transformer 中的各个矩阵的含义至关重要，因此我们花了很大的篇幅来对其进行分析。</p>
<p>接下来，我们用一个具体的例子来展示如上的过程。</p>
<h3 id="举个例子🌰">举个例子🌰</h3>
<p>以 <code>I am good</code> 这句话为例，我们用词向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x_1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 表示 <code>I</code>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x_2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 表示 <code>am</code>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">3</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x_3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 表示 <code>good</code>，对应的词向量分别为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">2</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">x</mi><mn mathvariant="bold">3</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{x_1} &amp;= [1, 3, 2] \\
\mathbf{x_2} &amp;= [1, 1, 3] \\
\mathbf{x_3} &amp;= [1, 2, 1]
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mclose">]</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mclose">]</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>所以，我们有矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span>：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{X} = \begin{bmatrix}
1 &amp; 3 &amp; 2 \\
1 &amp; 1 &amp; 3 \\
1 &amp; 2 &amp; 1
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.6010299999999997em;vertical-align:-1.55002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>于是，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">W</mi></mrow><annotation encoding="application/x-tex">\mathbf{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span></span></span></span> 矩阵的计算过程如下：</p>
<p><img src="/2024/10/16/What-exactly-is-attention/zmatrix.png" alt></p>
<p>权重矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">W</mi></mrow><annotation encoding="application/x-tex">\mathbf{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span></span></span></span> 中某一行分别与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 的一列相乘，如前所述，该操作相当于对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 中各行向量（不同的词向量）加权求和，得到的结果是每个词向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{x_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 经过加权求和之后的新表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">z</mi><mi mathvariant="bold">i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{z_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>，而权重矩阵则是经过相似度和归一化计算而得到的。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/vec_matrix.png" alt></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mi mathvariant="bold">I</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.97</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">I</mi></msub><mo>+</mo><mn>0.02</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub><mo>+</mo><mn>0.01</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.27</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">I</mi></msub><mo>+</mo><mn>0.73</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub><mo>+</mo><mn>0.00</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.90</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">I</mi></msub><mo>+</mo><mn>0.05</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub><mo>+</mo><mn>0.05</mn><mo>⋅</mo><msub><mi mathvariant="bold">x</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{z_{I}}    &amp;= 0.97 \cdot \mathbf{x_{I}} + 0.02 \cdot \mathbf{x_{am}} + 0.01 \cdot \mathbf{x_{good}} \\
\mathbf{z_{am}}   &amp;= 0.27 \cdot \mathbf{x_{I}} + 0.73 \cdot \mathbf{x_{am}} + 0.00 \cdot \mathbf{x_{good}} \\
\mathbf{z_{good}} &amp;= 0.90 \cdot \mathbf{x_{I}} + 0.05 \cdot \mathbf{x_{am}} + 0.05 \cdot \mathbf{x_{good}}
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">7</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<h3 id="r-实现过程">R 实现过程</h3>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">softmax &lt;- <span class="keyword">function</span>(mat) &#123;</span><br><span class="line">  exp_mat &lt;- <span class="built_in">exp</span>(mat)           <span class="comment"># 对矩阵中的每个元素取指数</span></span><br><span class="line">  row_sums &lt;- rowSums(exp_mat)  <span class="comment"># 计算每行的总和</span></span><br><span class="line">  softmax_mat &lt;- sweep(exp_mat, <span class="number">1</span>, row_sums, FUN = <span class="string">&quot;/&quot;</span>)  <span class="comment"># 对每行进行归一化</span></span><br><span class="line">  <span class="built_in">return</span>(softmax_mat)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">X &lt;- matrix(<span class="built_in">c</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>), nrow = <span class="number">3</span>, byrow = <span class="literal">TRUE</span>)</span><br><span class="line">W &lt;- softmax(X %*% t(X))</span><br><span class="line">Z &lt;- W %*% X</span><br><span class="line">print(Z)</span><br><span class="line"></span><br><span class="line"><span class="comment">#=================================================================</span></span><br><span class="line"></span><br><span class="line">     [,<span class="number">1</span>]     [,<span class="number">2</span>]     [,<span class="number">3</span>]</span><br><span class="line">[<span class="number">1</span>,]    <span class="number">1</span> <span class="number">2.957691</span> <span class="number">2.011295</span></span><br><span class="line">[<span class="number">2</span>,]    <span class="number">1</span> <span class="number">1.540148</span> <span class="number">2.722573</span></span><br><span class="line">[<span class="number">3</span>,]    <span class="number">1</span> <span class="number">2.864164</span> <span class="number">2.000000</span></span><br></pre></td></tr></table></figure>
<h3 id="引入新的矩阵">引入新的矩阵</h3>
<p>现在，我们引入一个新的矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Y</mi></mrow><annotation encoding="application/x-tex">\mathbf{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span></span></span></span>，并令</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">Y</mi><mi>T</mi></msup><mo fence="true">)</mo></mrow><mi mathvariant="bold">Y</mi><mo>=</mo><mi mathvariant="bold">W</mi><mi mathvariant="bold">Y</mi></mrow><annotation encoding="application/x-tex">\mathbf{Z} = \text{softmax}\left(\mathbf{X}\mathbf{Y}^T\right)\mathbf{Y} = \mathbf{W}\mathbf{Y}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2413409999999998em;vertical-align:-0.35001em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="mord"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span></span></span></span></span></p>
<p>根据之前的描述，此时的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi></mrow><annotation encoding="application/x-tex">\mathbf{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 中的每一个词向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{x_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 在 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Y</mi></mrow><annotation encoding="application/x-tex">\mathbf{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.02875em;">Y</span></span></span></span></span> 中的每一个词向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">y</mi><mi mathvariant="bold">j</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{y_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.730548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span> 的加权表示，即：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi mathvariant="bold">i</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi mathvariant="bold">y</mi><mi mathvariant="bold">j</mi></msub></mrow></mrow><annotation encoding="application/x-tex">\mathbf{x_i} = \sum_{j=1}^{m}{w_{ij}\mathbf{y_j}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.0651740000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6513970000000007em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><img src="/2024/10/16/What-exactly-is-attention/w_xy.png" alt></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mi mathvariant="bold">I</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.95</mn><mo>⋅</mo><msub><mi mathvariant="bold">y</mi><mtext>我</mtext></msub><mo>+</mo><mn>0.05</mn><mo>⋅</mo><msub><mi mathvariant="bold">y</mi><mtext>很好</mtext></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.12</mn><mo>⋅</mo><msub><mi mathvariant="bold">y</mi><mtext>我</mtext></msub><mo>+</mo><mn>0.88</mn><mo>⋅</mo><msub><mi mathvariant="bold">y</mi><mtext>很好</mtext></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi mathvariant="bold">z</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>0.88</mn><mo>⋅</mo><msub><mi mathvariant="bold">y</mi><mtext>我</mtext></msub><mo>+</mo><mn>0.12</mn><mo>⋅</mo><msub><mi mathvariant="bold">y</mi><mtext>很好</mtext></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{z_{I}}    &amp;= 0.95 \cdot \mathbf{y_{\text{我}}} + 0.05 \cdot \mathbf{y_{\text{很好}}} \\
\mathbf{z_{am}}   &amp;= 0.12 \cdot \mathbf{y_{\text{我}}} + 0.88 \cdot \mathbf{y_{\text{很好}}} \\
\mathbf{z_{good}} &amp;= 0.88 \cdot \mathbf{y_{\text{我}}} + 0.12 \cdot \mathbf{y_{\text{很好}}} 
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">我</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">很好</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">我</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">很好</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">我</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">很好</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>如上的计算和权重只是为了说明原理而随机选择的数据，并不代表真实的相关性。因此，我们会看到 <code>good</code> 和 <code>我</code>（而不是 <code>很好</code>） 之间的关系最相似。</p>
<h2 id="transformer-中的自注意力">Transformer 中的自注意力</h2>
<p>论文 <a href="https://arxiv.org/html/1706.03762v7">Attention Is All You Need</a> 的 3.2 节对 Attention 的描述如下<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>：</p>
<blockquote>
<p>An attention function can be described as mapping a query and a set of key-value pairs to an output, where the query, keys, values, and output are all vectors.</p>
<p>The output is computed as a weighted sum of the values, where the weight assigned to each value is computed by a compatibility function of the query with the corresponding key.</p>
</blockquote>
<p>论文中也给出了 Self-Attention 的计算公式：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">Q</mi><mo separator="true">,</mo><mi mathvariant="bold">K</mi><mo separator="true">,</mo><mi mathvariant="bold">V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(\mathbf{Q},\mathbf{K},\mathbf{V})=\text{softmax}\left(\frac{\mathbf{Q}\mathbf{K}^T}{\sqrt{d_k}}\right)\mathbf{V}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">Q</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">K</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.468361em;vertical-align:-0.95003em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183309999999999em;"><span style="top:-2.25278em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85722em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.81722em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18278000000000005em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">Q</span></span><span class="mord"><span class="mord"><span class="mord mathbf">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span></span></p>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span> 都是矩阵，分别代表 <code>Query</code>、<code>Key</code> 和 <code>Value</code>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span> 的行向量维度。 <code>Query</code>、<code>Key</code> 和 <code>Value</code> 都是为了计算 <code>自注意力</code> 而引入的抽象的概念，它们都是对原始的输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 的线性变换。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi mathvariant="bold">Q</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi mathvariant="bold">K</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi mathvariant="bold">V</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{Q} &amp;= \mathbf{X}\mathbf{W}^Q \\
\mathbf{K} &amp;= \mathbf{X}\mathbf{W}^K \\
\mathbf{V} &amp;= \mathbf{X}\mathbf{W}^V
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.653993000000002em;vertical-align:-2.076996500000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5769965000000004em;"><span style="top:-4.685665500000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">Q</span></span></span></span><span style="top:-3.1343345em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">K</span></span></span></span><span style="top:-1.5830034999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.076996500000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5769965000000004em;"><span style="top:-4.685665500000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.891331em;"><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span></span></span></span></span></span></span><span style="top:-3.1343345em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span><span style="top:-1.5830034999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.076996500000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>因为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">m \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span> 的矩阵，所以如果令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> 均是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span> 的单位矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">I</mi></mrow><annotation encoding="application/x-tex">\mathbf{I}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">I</span></span></span></span></span>，那么 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span> 经过线性变换（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">I</mi></mrow><annotation encoding="application/x-tex">\mathbf{I}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">I</span></span></span></span></span>）后仍然是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span>，此时我们可以用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 替换 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span>，那么公式就变成了：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">Q</mi><mo separator="true">,</mo><mi mathvariant="bold">K</mi><mo separator="true">,</mo><mi mathvariant="bold">V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi mathvariant="bold">X</mi><msup><mi mathvariant="bold">X</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(\mathbf{Q},\mathbf{K},\mathbf{V})=\text{softmax}\left(\frac{\mathbf{X}\mathbf{X}^T}{\sqrt{d_k}}\right)\mathbf{X}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">Q</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">K</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.468361em;vertical-align:-0.95003em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183309999999999em;"><span style="top:-2.25278em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85722em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.81722em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18278000000000005em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">X</span></span><span class="mord"><span class="mord"><span class="mord mathbf">X</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span></span></p>
<p>这也就是为什么我们之前面说：Transformer 模型中的 <code>Attention</code> 其实就是对原始输入词向量的加权求和而得到的新的表示，在新的表示中，Transformer 可以理解输入序列中的不同的部分，并分析输入序列中不同词之间的关系，进而捕获到上下文信息。</p>
<p>实际上，为了增强增强模型的拟合能力，我们并不会采用单位矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">I</mi></mrow><annotation encoding="application/x-tex">\mathbf{I}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">I</span></span></span></span></span> 对矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 做线性变换，而是分别采用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> 这三个可以通过大量语料训练而学习到的参数矩阵（参数矩阵可以是任何维度，但行向量个数必须和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 的行向量维度一致）。</p>
<p>除此之外，在计算 <code>softmax()</code> 之前，Transformer 会用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.18278000000000005em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85722em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.81722em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18278000000000005em;"><span></span></span></span></span></span></span></span></span> 对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{Q}\mathbf{K}^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035771em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span><span class="mord"><span class="mord"><span class="mord mathbf">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 的结果进行缩放，所以论文中也把 <code>自注意力</code> 叫作：Scaled Dot-Product Attention。当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 很大时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{Q}\mathbf{K}^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.035771em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span><span class="mord"><span class="mord"><span class="mord mathbf">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 的向量点积会非常大，如果不进行缩放，<code>softmax()</code> 的梯度会非常小，进而导致在反向传播时，模型参数更新的速度会变慢，甚至接近停滞，影响模型的学习效率。</p>
<p>自注意力机制的整体流程如下图所示：</p>
<p><img src="/2024/10/16/What-exactly-is-attention/sattention.png" alt="自注意力机制"></p>
<p>所以，根据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">Q</mi><mo separator="true">,</mo><mi mathvariant="bold">K</mi><mo separator="true">,</mo><mi mathvariant="bold">V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Attention}(\mathbf{Q},\mathbf{K},\mathbf{V})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">Q</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">K</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span><span class="mclose">)</span></span></span></span>，Transformer 可以理解一句话中不同词之间的相互关系。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi><mo separator="true">,</mo><mi mathvariant="bold">K</mi><mo separator="true">,</mo><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q},\mathbf{K},\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">K</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span> 和原始输入之间的关系如下图所示<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>：</p>
<p><img src="/2024/10/16/What-exactly-is-attention/qkv.png" alt="计算 Q、K、V 矩阵的示例"></p>
<h3 id="scaled-的说明">Scaled 的说明</h3>
<p>对于一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">m\times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">m</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span> 的矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">A</mi></mrow><annotation encoding="application/x-tex">\mathbf{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">A</span></span></span></span></span>，<code>softmax()</code> 的计算如下：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></msup><mrow><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msup><mi>e</mi><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{softmax}(\mathbf{A}_{ij}) = \frac{e^{\mathbf{A}_{ij}}}{\sum_{k=1}^{n}e^{\mathbf{A}_{ik}}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.514279em;vertical-align:-0.994002em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.520277em;"><span style="top:-2.305708em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.804292em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.769277em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.843277em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.994002em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 变大时，会存在向量点积结果过大的可能性，如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{A}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.972218em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 很大，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></msup></mrow><annotation encoding="application/x-tex">e^{\mathbf{A}_{ij}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.843277em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.843277em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 会迅速趋近于无穷大，而行向量中其余较小的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{A}_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.972218em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 则会变得相对较小。此时，<code>softmax()</code> 的结果会向 0 或 1 的两个极端值推移。</p>
<p>根据 <code>softmax()</code> 的梯度定义<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></mfrac><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">A</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac{\partial \text{softmax}(\mathbf{A}_{ij})}{\partial \mathbf{A}_{ij}} = \text{softmax}(\mathbf{A}_{ij})(1 - \text{softmax}(\mathbf{A}_{ij}))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.399108em;vertical-align:-0.972108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<p>当 <code>softmax()</code> 的输出值过于极端（输出 0 或 1）时，<code>softmax()</code> 的梯度结果将趋近于零，在反向传播时，模型参数的更新速度会非常慢，甚至接近停滞。这也就是所谓的梯度消失（vanishing gradient）问题，梯度消失会导致模型训练效率极大降低，特别是在深度神经网络中，梯度消失可能会导致网络无法有效学习。</p>
<p>为了避免梯度消失问题，可以使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.383108em;vertical-align:-0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.5864385em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622307142857143em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222307142857144em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 缩放点积结果：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{\mathbf{Q}\mathbf{K}^T}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.627473em;vertical-align:-0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.089473em;"><span style="top:-2.5864385em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622307142857143em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222307142857144em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">Q</span></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9190928571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。缩放之后，点积结果的数值会变小，确保 <code>softmax()</code> 的输入不会过大，避免 <code>softmax()</code> 输出过于极端的值，从而使得 <code>softmax()</code> 的梯度更加适中，进而更有利于模型的有效训练。</p>
<h3 id="multi-head-attention">Multi-Head Attention</h3>
<p>回想一下前面我们介绍的 <code>I am good</code> 的例子，我们假设该结果就是按照 Transforer 中的自注意力机制计算而来，那么 <code>good</code> 的自注意力为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">z</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub><mo>=</mo><mn>0.90</mn><mo>⋅</mo><msub><mi mathvariant="bold">v</mi><mi mathvariant="bold">I</mi></msub><mo>+</mo><mn>0.05</mn><mo>⋅</mo><msub><mi mathvariant="bold">v</mi><mrow><mi mathvariant="bold">a</mi><mi mathvariant="bold">m</mi></mrow></msub><mo>+</mo><mn>0.05</mn><mo>⋅</mo><msub><mi mathvariant="bold">v</mi><mrow><mi mathvariant="bold">g</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{z_{good}} = 0.90 \cdot \mathbf{v_{I}} + 0.05 \cdot \mathbf{v_{am}} + 0.05 \cdot \mathbf{v_{good}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.730548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33027699999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.161108em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">a</span><span class="mord mathbf mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.730548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">g</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">o</span><span class="mord mathbf mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>由此，我们可以看出，<code>good</code> 的自注意力值实际上由 <code>I</code> 的值向量来主导。</p>
<p>但是如果我们要计算下句中的 <code>it</code> 的自注意力值呢？<code>it</code> 的自注意力值应该由 <code>dog</code> 主导还是由 <code>food</code> 主导呢？当然，我们可以很容易的看出，<code>it</code> 的自注意力值应该由 <code>dog</code> 主导，但是机器如何来判断呢？</p>
<blockquote>
<p>A dog ate the food because it was hungry.</p>
</blockquote>
<p>如果 <code>it</code> 的自注意力值的结果如下所示，那么 <code>it</code> 的自注意力值确实由 <code>dog</code> 主导：</p>
<p><img src="/2024/10/16/What-exactly-is-attention/msattention.png" alt></p>
<p>但如果 <code>it</code> 的自注意力值的结果如下所示呢？</p>
<p><img src="/2024/10/16/What-exactly-is-attention/msattention_2.png" alt></p>
<p>因此，为了确保结果的准确性，我们不能依赖一个注意力矩阵，而应该计算多个注意力矩阵，并将这多个注意力矩阵的结果整合起来，这也就是 <code>Multi-Head Attention</code> 的由来<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>。如果我们有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span> 个注意力矩阵，那么我们可以按如下的方式将这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span> 个注意力矩阵的结果整合起来得到最终的注意力矩阵：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>MultiHeadAttention</mtext><mo>=</mo><mtext>Concatenate</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">Z</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">Z</mi><mi>h</mi></msub><mo stretchy="false">)</mo><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\text{MultiHeadAttention} = \text{Concatenate}(\mathbf{Z}_1,\cdots,\mathbf{Z}_h)\mathbf{W}^O
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord text"><span class="mord">MultiHeadAttention</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Concatenate</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p>
<h3 id="矩阵-w-o-的说明">矩阵 W^O 的说明</h3>
<p>根据 <a href="https://arxiv.org/html/1706.03762v7">Attention Is All You Need</a> 的 第 3.2.2 节 <strong>Multi-Head Attention</strong> 的描述，对于多头注意力机制中的任何一个注意力头 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> 而言，其各参数矩阵的维度如下所示：</p>
<blockquote>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_i^Q \in \mathbb{R}^{d_{\text{model}} \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.236103em;vertical-align:-0.276864em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.959239em;"><span style="top:-2.4231360000000004em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.1809080000000005em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.276864em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8491079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>×</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_i^K \in \mathbb{R}^{d_{\text{model}} \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0999949999999998em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.441336em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8491079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>×</mo><msub><mi>d</mi><mi>v</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W_i^V \in \mathbb{R}^{d_{\text{model}} \times d_v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0999949999999998em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-2.441336em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8491079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>h</mi><msub><mi>d</mi><mi>v</mi></msub><mo>×</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W^O \in \mathbb{R}^{h d_v \times d_{\text{model}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.880431em;vertical-align:-0.0391em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8491079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">h</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
</blockquote>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>model</mtext></msub></mrow><annotation encoding="application/x-tex">d_{\text{model}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为模型词向量的维度，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><msub><mi mathvariant="bold">W</mi><mi mathvariant="bold">i</mi></msub><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W_i}^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0673409999999999em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.917341em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span></span></span></span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><msub><mi mathvariant="bold">W</mi><mi mathvariant="bold">i</mi></msub><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W_i}^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0673409999999999em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.917341em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span>的列向量维度，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><msub><mi mathvariant="bold">W</mi><mi mathvariant="bold">i</mi></msub><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf {W_i}^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0673409999999999em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.01597em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathbf mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.917341em;"><span style="top:-3.1390100000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> 的列向量维度。</p>
<p>所以，矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span> 主要有两个作用：</p>
<ul>
<li>把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span> 个注意力头输出的拼接结果转换成单个注意力头的维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>×</mo><msub><mi>d</mi><mi>v</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbb{R}^{d_{\text{model}} \times d_v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>把单个注意力头的维度再次转换为模型的词向量维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>×</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbb{R}^{d_{\text{model}} \times d_{\text{model}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbb">R</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>实际上，如上的操作其实是把两个线性变换操作合并到了一个矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span> 中。在 <a href="https://www.3blue1brown.com/lessons/attention">Visualizing Attention, a Transformer’s Heart</a> 的第 23:08 的时候，也对此进行了详细的说明<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>,<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/wo_note.png" alt></p>
<h2 id="transformer-中的-positional-encoding">Transformer 中的 Positional Encoding</h2>
<p>对于 Transformer 模型而言，为了缩短训练时间，我们会将一句话中的所有的词并行的输入到模型中。但是，这也带来了一个问题：并行输入的词向量之间丢失了相互之间的位置信息。词序信息能够帮助 Transformer 模型学习词与词之间的相互关系，因此，为了解决这个问题，Transformer 中引入了 <code>Positional Encoding</code>。</p>
<p>对于一个给定的句子，例如：<code>I am good</code>，我们首先计算每个单词的词向量表示（假定词向量的维度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）。如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">d_{model} = 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span>，那么对于 <code>I am good</code> 而言，我们就得到了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">3 \times 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span> 的输入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span>：</p>
<p><img src="/2024/10/16/What-exactly-is-attention/pe_input_x.png" alt="输入矩阵 X"></p>
<p>如果把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 直接输入到 Transformer 的 Encoder 中，那么模型无法理解不同单词之间的词序。所以，需要对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 增加一些表示词序信息的数据，以便模型可以正确理解句子的含义。为此，我们可以构造一个包含位置编码信息的矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span></span></span></span>，然后把矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span></span></span></span> 添加到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 中，即可得到包含位置信息的输入矩阵。</p>
<p>在 <a href="https://arxiv.org/html/1706.03762v7">Attention Is All You Need</a> 的第 3.5 节 <strong>Positional Encoding</strong> 中给出了位置矩阵的计算方式：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="bold">P</mi><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>s</mi><mi>i</mi><mi>n</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="bold">P</mi><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>c</mi><mi>o</mi><mi>s</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{P}(pos, 2i) &amp;= sin\left(\frac{pos}{10000^{2i/d_{model}}}\right) \\ 
\mathbf{P}(pos, 2i + 1) &amp;= cos\left(\frac{pos}{10000^{2i/d_{model}}}\right)
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.308em;vertical-align:-1.904em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.404em;"><span style="top:-4.404em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">P</span></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mord mathdefault">i</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">P</span></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.904em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.404em;"><span style="top:-4.404em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.2960000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.704em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.15em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.2960000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">0</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.704em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.904em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">pos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span></span></span></span> 表示当前的单词在句子中的位置，也就是输入矩阵的第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">pos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span></span></span></span> 行（从 0 开始索引）；</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> 表示当前的单词在输入矩阵中的列位置，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>i</mi></mrow><annotation encoding="application/x-tex">2i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord mathdefault">i</span></span></span></span> 表示 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span></span></span></span> 的所有偶数列，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 表示所有的奇数列。</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d_{model}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是词向量的维度。</li>
</ul>
<p>根据位置矩阵的计算公式，对与所有的偶数列，使用正弦函数计算位置编码信息；对于所有的奇数列，使用余弦函数计算位置编码信息。对于 <code>I am good</code> 而言，位置矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span></span></span></span> 的计算结果如下：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mi mathvariant="bold">P</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mn>0</mn></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mn>0</mn></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mn>0</mn></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mn>0</mn></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mn>0</mn></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mn>0</mn></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mrow><mo fence="true">(</mo><mfrac><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><mrow><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow></msup></mrow></mfrac><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mn>0</mn><mi mathvariant="normal">/</mi><mn>100</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mn>0</mn><mi mathvariant="normal">/</mi><mn>100</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><mn>100</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mn>1</mn><mi mathvariant="normal">/</mi><mn>100</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mn>2</mn><mi mathvariant="normal">/</mi><mn>100</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mn>2</mn><mi mathvariant="normal">/</mi><mn>100</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.841</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.54</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.01</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.99</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.909</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.416</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.02</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.99</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{P} &amp;= 
\begin{bmatrix}
sin\left(\frac{pos}{10000^{0}}\right) &amp; cos\left(\frac{pos}{10000^{0}}\right) &amp; sin\left(\frac{pos}{10000^{2/4}}\right) &amp; cos\left(\frac{pos}{10000^{2/4}}\right) \\
sin\left(\frac{pos}{10000^{0}}\right) &amp; cos\left(\frac{pos}{10000^{0}}\right) &amp; sin\left(\frac{pos}{10000^{2/4}}\right) &amp; cos\left(\frac{pos}{10000^{2/4}}\right) \\
sin\left(\frac{pos}{10000^{0}}\right) &amp; cos\left(\frac{pos}{10000^{0}}\right) &amp; sin\left(\frac{pos}{10000^{2/4}}\right) &amp; cos\left(\frac{pos}{10000^{2/4}}\right)
\end{bmatrix} \\
&amp;= \begin{bmatrix}
sin(0) &amp; cos(0) &amp; sin(0/100) &amp; cos(0 / 100) \\
sin(1) &amp; cos(1) &amp; sin(1/100) &amp; cos(1 / 100) \\
sin(2) &amp; cos(2) &amp; sin(2/100) &amp; cos(2 / 100) \\
\end{bmatrix} \\
&amp;= \begin{bmatrix}
0 &amp; 1 &amp; 0 &amp; 1 \\
0.841 &amp; 0.54 &amp; 0.01 &amp; 0.99 \\
0.909 &amp; -0.416 &amp; 0.02 &amp; 0.99 
\end{bmatrix}
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:11.808335em;vertical-align:-5.6541675em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:6.1541675em;"><span style="top:-8.1541675em;"><span class="pstrut" style="height:4.1031375em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">P</span></span></span></span><span style="top:-4.2000199999999985em;"><span class="pstrut" style="height:4.1031375em;"></span><span class="mord"></span></span><span style="top:-0.2989900000000001em;"><span class="pstrut" style="height:4.1031375em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.6541675em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:6.1541675em;"><span style="top:-8.1541675em;"><span class="pstrut" style="height:4.1031375em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1031375em;"><span style="top:-4.253137499999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.0177125000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-1.7822874999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.6031375em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1031375em;"><span style="top:-4.253137499999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.0177125000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-1.7822874999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.6031375em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1031375em;"><span style="top:-4.253137499999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.614575em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">/</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.38542499999999996em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.0177125000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.614575em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">/</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.38542499999999996em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-1.7822874999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.614575em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">/</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.38542499999999996em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.6031375em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1031375em;"><span style="top:-4.253137499999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.614575em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">/</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.38542499999999996em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-3.0177125000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.614575em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">/</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.38542499999999996em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-1.7822874999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7475em;"><span style="top:-2.614575em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8220357142857143em;"><span style="top:-2.8220357142857138em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5357142857142856em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">/</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.38542499999999996em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.6031375em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-4.2000199999999985em;"><span class="pstrut" style="height:4.1031375em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord">0</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord">1</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">n</span><span class="mopen">(</span><span class="mord">2</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mopen">(</span><span class="mord">0</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mopen">(</span><span class="mord">1</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mopen">(</span><span class="mord">2</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-0.2989900000000001em;"><span class="pstrut" style="height:4.1031375em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">4</span><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">0</span><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mord">4</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">4</span><span class="mord">1</span><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">9</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:5.6541675em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>于是，我们得到了包含位置信息的输入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>+</mo><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf{X} + \mathbf{P}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76944em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">P</span></span></span></span></span>：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi mathvariant="bold">X</mi><mo>+</mo><mi mathvariant="bold">P</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2.2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5.8</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7.3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9.9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8.5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7.1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>9.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>7.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.9</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10.1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>+</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.841</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.54</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.01</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.99</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.909</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mn>0.416</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.02</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.99</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.8</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3.4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6.8</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8.141</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10.44</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8.51</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>8.09</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>10.009</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6.684</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.92</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>11.09</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\mathbf{X} + \mathbf{P} &amp;= 
\begin{bmatrix}
1.8 &amp; 2.2 &amp; 3.4 &amp; 5.8 \\
7.3 &amp; 9.9 &amp; 8.5 &amp; 7.1 \\
9.1 &amp; 7.1 &amp; 0.9 &amp; 10.1 
\end{bmatrix} + 
\begin{bmatrix}
0 &amp; 1 &amp; 0 &amp; 1 \\
0.841 &amp; 0.54 &amp; 0.01 &amp; 0.99 \\
0.909 &amp; -0.416 &amp; 0.02 &amp; 0.99 
\end{bmatrix} \\
&amp;= \begin{bmatrix}
1.8 &amp; 3.2 &amp; 3.4 &amp; 6.8 \\
8.141 &amp; 10.44 &amp; 8.51 &amp; 8.09 \\
10.009 &amp; 6.684 &amp; 0.92 &amp; 11.09
\end{bmatrix}
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.802059999999999em;vertical-align:-3.6510299999999996em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.1510299999999996em;"><span style="top:-6.1510299999999996em;"><span class="pstrut" style="height:4.05101em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">X</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathbf">P</span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:4.05101em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.6510299999999996em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.1510299999999996em;"><span style="top:-6.1510299999999996em;"><span class="pstrut" style="height:4.05101em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">8</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">7</span><span class="mord">.</span><span class="mord">3</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">9</span><span class="mord">.</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord">.</span><span class="mord">2</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">9</span><span class="mord">.</span><span class="mord">9</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">7</span><span class="mord">.</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span><span class="mord">.</span><span class="mord">4</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">8</span><span class="mord">.</span><span class="mord">5</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">5</span><span class="mord">.</span><span class="mord">8</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">7</span><span class="mord">.</span><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">8</span><span class="mord">4</span><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">0</span><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span><span class="mord">4</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">−</span><span class="mord">0</span><span class="mord">.</span><span class="mord">4</span><span class="mord">1</span><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">9</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:4.05101em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">8</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">8</span><span class="mord">.</span><span class="mord">1</span><span class="mord">4</span><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span><span class="mord">.</span><span class="mord">2</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">0</span><span class="mord">.</span><span class="mord">4</span><span class="mord">4</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">.</span><span class="mord">6</span><span class="mord">8</span><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">3</span><span class="mord">.</span><span class="mord">4</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">8</span><span class="mord">.</span><span class="mord">5</span><span class="mord">1</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">.</span><span class="mord">8</span></span></span><span style="top:-3.0099999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">8</span><span class="mord">.</span><span class="mord">0</span><span class="mord">9</span></span></span><span style="top:-1.8099999999999994em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">1</span><span class="mord">.</span><span class="mord">0</span><span class="mord">9</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.5500000000000007em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.0510099999999998em;"><span style="top:-2.2500000000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.8099900000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.05101em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55002em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.6510299999999996em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>计算位置矩阵的 R 代码如下所示：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 位置编码函数，从 0 开始计算</span></span><br><span class="line">get_position_encoding &lt;- <span class="keyword">function</span>(<span class="built_in">seq_len</span>, d_model) &#123;</span><br><span class="line">  position &lt;- 0:(<span class="built_in">seq_len</span> - <span class="number">1</span>)</span><br><span class="line">  div_term &lt;- <span class="built_in">exp</span>(seq(<span class="number">0</span>, d_model - <span class="number">1</span>, by = <span class="number">2</span>) * -(<span class="built_in">log</span>(<span class="number">10000</span>) / d_model))</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 初始化位置编码矩阵</span></span><br><span class="line">  position_enc &lt;- matrix(<span class="number">0</span>, nrow = <span class="built_in">seq_len</span>, ncol = d_model)</span><br><span class="line">  <span class="keyword">for</span> (pos <span class="keyword">in</span> <span class="number">0</span>:(<span class="built_in">seq_len</span> - <span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="comment"># 奇数索引：sin函数</span></span><br><span class="line">    position_enc[pos + <span class="number">1</span>, seq(<span class="number">1</span>, d_model, by = <span class="number">2</span>)] &lt;- <span class="built_in">sin</span>(pos * div_term)</span><br><span class="line">    <span class="comment"># 偶数索引：cos函数</span></span><br><span class="line">    position_enc[pos + <span class="number">1</span>, seq(<span class="number">2</span>, d_model, by = <span class="number">2</span>)] &lt;- <span class="built_in">cos</span>(pos * div_term)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">return</span>(position_enc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成位置编码矩阵</span></span><br><span class="line">position_encoding_matrix &lt;- get_position_encoding(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看位置编码矩阵</span></span><br><span class="line">print(position_encoding_matrix)</span><br></pre></td></tr></table></figure>
<p>如果一个句子包含 128 个词，每个词向量的维度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub><mo>=</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">d_{model} = 512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span></span></span></span>，那么位置编码矩阵的维度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>128</mn><mo>×</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">128 \times 512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mord">2</span></span></span></span>，可以用如下的 R 代码生成位置编码矩阵，并对其可视化。</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">position_encoding_matrix &lt;- get_position_encoding(<span class="number">128</span>, <span class="number">512</span>)</span><br><span class="line">position_encoding_df &lt;- melt(position_encoding_matrix)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制热图</span></span><br><span class="line">ggplot(position_encoding_df, aes(x = Var2, y = Var1, fill = value)) +</span><br><span class="line">  geom_tile() +</span><br><span class="line">  scale_fill_viridis_c() +                     <span class="comment"># 使用类似的颜色映射</span></span><br><span class="line">  scale_y_reverse() + </span><br><span class="line">  theme_minimal(base_family = <span class="string">&quot;STKaiti&quot;</span>) + </span><br><span class="line">  scale_x_continuous(expand = expansion(mult = <span class="built_in">c</span>(<span class="number">0</span>, <span class="number">0.05</span>))) + </span><br><span class="line">  labs(title = <span class="string">&quot;Position Encoding 可视化&quot;</span>,</span><br><span class="line">       x = <span class="string">&quot;Dimensions&quot;</span>, y = <span class="string">&quot;words&quot;</span>, fill = <span class="string">&quot;Value&quot;</span>) + </span><br><span class="line">  theme(panel.grid.major.x = element_blank(),  <span class="comment"># 移除 x 轴的主要网格线</span></span><br><span class="line">        panel.grid.minor.x = element_blank(),</span><br><span class="line">        panel.grid.minor.y = element_blank(),</span><br><span class="line">        axis.line = element_line(),           <span class="comment"># 保留x轴和y轴本身</span></span><br><span class="line">        axis.ticks = element_line(),          <span class="comment"># 保留x轴和y轴上的刻度线</span></span><br><span class="line">        legend.position = <span class="string">&quot;top&quot;</span>,              <span class="comment"># 图例放置在左上角</span></span><br><span class="line">        legend.justification = <span class="built_in">c</span>(<span class="number">0</span>, <span class="number">1</span>),       <span class="comment"># 设置图例的对齐方式</span></span><br><span class="line">        legend.title = element_blank())</span><br></pre></td></tr></table></figure>
<p><img src="/2024/10/16/What-exactly-is-attention/pe_hot_image.png" alt></p>
<h2 id="transformer-中的-encoder">Transformer 中的 Encoder</h2>
<p>在 <code>Multi-Head Attention</code> 和 <code>Positional Encoding</code> 的基础之上，再增加前馈网络、叠加和归一组件，就得到了完整的 Transformer Encoder。当然，实际中，可以将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span> 个 Encoder 一个一个的叠加起来，最后一个 Encoder 的输出就是原始输入内容的特征值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span>（矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> 与输入内容的词向量矩阵的维度是一致的）。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/encoder.png" alt="Encoder 架构图"></p>
<h2 id="transformer-中的-decoder">Transformer 中的 Decoder</h2>
<p>假设我们要把英语句子 <code>I am a student</code>（原句）翻译成中文 <code>我是一个学生</code>（目标句）。</p>
<ol>
<li>首先，我们把原句 <code>I am a student</code> 输入到 Transformer 的 Encoder 中，让 Encoder 学习原句并得到原句的特征矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span>。</li>
<li>然后，我们把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> 输入到解码器，解码器根据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> 和解码器之前的输出作为输入，并生成目标句中的下一个词，直到生成目标句为止（解码器每次迭代会生成一个词，直到生成目标句为止）。</li>
</ol>
<p>具体的生成过程如下图所示：</p>
<p><img src="/2024/10/16/What-exactly-is-attention/decode_demo1.gif" alt="解码器的例子"></p>
<h3 id="带掩码的多头注意力层">带掩码的多头注意力层</h3>
<p>以如上的翻译认为为例，假设训练数据集如下所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">原句</th>
<th style="text-align:center">目标句</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">I am a student</td>
<td style="text-align:center">我是一个学生</td>
</tr>
<tr>
<td style="text-align:center">I am a teacher</td>
<td style="text-align:center">我是一个老师</td>
</tr>
<tr>
<td style="text-align:center">Good morning</td>
<td style="text-align:center">早上好</td>
</tr>
<tr>
<td style="text-align:center">Thank you very much</td>
<td style="text-align:center">非常感谢你</td>
</tr>
</tbody>
</table>
<p>上表所示的数据集由两部分构成：<code>原句</code> 和 <code>目标句</code>。如前所述，我们也了解了解码器在 <strong>运行时</strong> 逐字（token）预测目标句的过程。但是，在训练时，由于我们有标注好的、正确的 <code>目标句</code>，所以，为了简化训练过程，我们可以对整个 <code>目标句</code> 稍作修改然后将其作为输入（而不需要像 <strong>运行时</strong> 那样逐字输入）。解码器把输入的 <strong>&lt;sos&gt;</strong>（start of sequence）作为第一个 token，并在之后的每一步中把下一个预测 token 追加到当前的输入，以预测目标句，直到预测输出为 <strong>&lt;eos&gt;</strong>（end of sequence）为止。因此，在训练时，我们只需要把 <strong>&lt;sos&gt;</strong> 添加到 <code>目标句</code> 的开头，然后将其作为输入发送给解码器，具体如下图所示。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/encoder_decoder_demo1.png" alt="Transformer 中的编码器和解码器"></p>
<p>如上图所示，如果要把 <code>I am a student</code> 翻译成 <code>我是一个学生</code>，我们只需要把 <code>&lt;sos&gt;我是一个学生</code> 作为输入发送给解码器，解码器的目标是根据 <code>I am a student</code> 和 <code>&lt;sos&gt;我是一个学生</code> 预测输出 <code>我是一个学生&lt;eos&gt;</code>。</p>
<p>对于解码器的输入序列而言，我们会先将其转换成嵌入矩阵并增加位置编码信息得到输入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span>，然后我们将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 输入到编码器中进行后续的预测。假设矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.7</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.8</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.2</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.7</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.6</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.5</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{X} = \begin{bmatrix}
1.1 &amp; 1.2  &amp; 1.3  &amp; \cdots &amp; 1.4 \\
1.5 &amp; 1.6  &amp; 1.7  &amp; \cdots &amp; 1.8 \\
1.2 &amp; 1.1  &amp; 1.3  &amp; \cdots &amp; 1.2 \\
1.4 &amp; 1.5  &amp; 1.6  &amp; \cdots &amp; 1.7 \\
1.6 &amp; 1.3  &amp; 1.4  &amp; \cdots &amp; 1.5
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:6.00503em;vertical-align:-2.75004em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2549900000000003em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.1999800000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-2.79598em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.39198em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.9879800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.0139700000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-5.25499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">4</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">6</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">1</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">3</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">7</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">3</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">6</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="minner">⋯</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="minner">⋯</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2500000000000004em;"><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">4</span></span></span><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">8</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">2</span></span></span><span style="top:-1.8099999999999998em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">7</span></span></span><span style="top:-0.6099999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.7500000000000004em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.2549900000000003em;"><span style="top:-1.0499800000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.1999800000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-2.79598em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.39198em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.9879800000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.0139700000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-5.25499em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.75004em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>解码器首先会计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 的自注意力矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi></mrow><annotation encoding="application/x-tex">\mathbf{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span></span></span></span>，然后计算句子中所有词之间的关联并提取每个词的信息。但是与编码器不同的是，在解码器的 <strong>运行时</strong>，解码器只是将上一个步骤生成的词作为输入，而不是将整个输入序列作为输入。因此，在第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span> 步时，解码器的输入中只有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>&lt;</mo><mi>s</mi><mi>o</mi><mi>s</mi><mo>&gt;</mo><mo separator="true">,</mo><mtext>我</mtext><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[&lt;sos&gt;, 我]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord cjk_fallback">我</span><span class="mclose">]</span></span></span></span>，所以我们只能得到这两个词之间的关联，而不能得到之后的任何词的信息。</p>
<p>因此，在训练期间，虽然我们可以将整个 <code>目标句</code> 作为输入，但是我们仍然需要以解码器在 <code>运行时</code> 的运行方式来训练模型。也就是说，在训练期间，我们只能计算 <code>目标句</code> 序列中某个词和该词之前的所有词之间的注意力。为此，可以引入 <code>掩码</code> 的概念以实现这个目的。例如，我们想要预测 <code>&lt;sos&gt;我</code> 之后的词 <code>是</code>，此时，模型应该只看到 <code>&lt;sos&gt;我</code>，所以我们需要用掩码来阻止模型看到 <code>我</code> 之后的词。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/mask_demo.png" alt="掩码的例子"></p>
<p>根据注意力矩阵的计算方式：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">Q</mi><mo separator="true">,</mo><mi mathvariant="bold">K</mi><mo separator="true">,</mo><mi mathvariant="bold">V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(\mathbf{Q},\mathbf{K},\mathbf{V})=\text{softmax}\left(\frac{\mathbf{Q}\mathbf{K}^T}{\sqrt{d_k}}\right)\mathbf{V}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">Q</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf">K</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.468361em;vertical-align:-0.95003em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183309999999999em;"><span style="top:-2.25278em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85722em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.81722em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.18278000000000005em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">Q</span></span><span class="mord"><span class="mord"><span class="mord mathbf">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span></span></p>
<p>我们在计算 <code>softmax()</code> 之前，对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{\mathbf{Q}\mathbf{K}^T}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.627473em;vertical-align:-0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.089473em;"><span style="top:-2.5864385em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622307142857143em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222307142857144em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">Q</span></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9190928571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 矩阵进行如下的操作即可：在预测第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> 个词的注意力时，用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">-\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord">−</span><span class="mord">∞</span></span></span></span> 替换 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{\mathbf{Q}\mathbf{K}^T}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.627473em;vertical-align:-0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.089473em;"><span style="top:-2.5864385em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622307142857143em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222307142857144em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">Q</span></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9190928571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 中该词之后的所有点积结果。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/mask_demo_2.png" alt="带掩码的权重矩阵"></p>
<p>此时，我们就可以利用 <code>softmax()</code> 对如上的掩码矩阵进行计算，并乘以对应的矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span>，得到最终的注意力矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi></mrow><annotation encoding="application/x-tex">\mathbf{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span></span></span></span>。同样的，如果我们有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span> 个注意力矩阵，那么我们可以按如下的方式将这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span> 个注意力矩阵的结果整合起来得到最终的注意力矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">M</mi></mrow><annotation encoding="application/x-tex">\mathbf{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">M</span></span></span></span></span>：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">M</mi><mo>=</mo><mtext>Concatenate</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">Z</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">Z</mi><mi>h</mi></msub><mo stretchy="false">)</mo><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{M} = \text{Concatenate}(\mathbf{Z}_1,\cdots,\mathbf{Z}_h)\mathbf{W}^O
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">M</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Concatenate</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p>
<h3 id="多头注意力层">多头注意力层</h3>
<p>为了根据解码器中计算的 <code>原句</code> 的注意力矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> 和解码器中计算的 <code>目标句</code> 的带掩码的注意力矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">M</mi></mrow><annotation encoding="application/x-tex">\mathbf{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">M</span></span></span></span></span> 来预测最终的 <code>目标句</code>，我们还需要一个多头注意力层。由于该层涉及到了编码器与解码器的交互，因此，这一层也称之为 <strong>编码器-解码器注意力层</strong>（Encoder-Decoder Attention）。</p>
<p>多头注意力机制的第一步就是要创建查询矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>、键矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span> 和值矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span>。如前所述，可以通过输入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">X</span></span></span></span></span> 乘以权重矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span></span></span></span></span></span></span></span>、键矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span> 和值矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> 得到查询矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>、键矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span> 和值矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span>。但是现在，我们有两个输入矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span>（编码器输出的特征矩阵） 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">M</mi></mrow><annotation encoding="application/x-tex">\mathbf{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">M</span></span></span></span></span>（解码器中带掩码的多头注意力层输出的注意力矩阵），我们该如何使用这两个输入矩阵呢？怎么利用这两个输入矩阵生成查询矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>、键矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span> 和值矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span> 呢？</p>
<p>我们使用矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">M</mi></mrow><annotation encoding="application/x-tex">\mathbf{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">M</span></span></span></span></span> 生成查询矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>，以使得查询矩阵可以包含 <code>目标句</code> 的特征；使用矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> 生成键矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span> 和值矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span>，以使得键矩阵和值矩阵可以包含 <code>原句</code> 的特征。然后再利用计算求得的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span>、<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span> 计算注意力矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi></mrow><annotation encoding="application/x-tex">\mathbf{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span></span></span></span>。具体的步骤如下所示：</p>
<ol>
<li>
<p>使用矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">M</mi></mrow><annotation encoding="application/x-tex">\mathbf{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">M</span></span></span></span></span> 乘以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">Q</span></span></span></span></span></span></span></span></span></span></span> 生成查询矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span>，使用矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> 乘以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">K</span></span></span></span></span></span></span></span></span></span></span> 生成键矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf{K}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">K</span></span></span></span></span>，使用矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">R</mi></mrow><annotation encoding="application/x-tex">\mathbf{R}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">R</span></span></span></span></span> 乘以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.22222em;">V</span></span></span></span></span></span></span></span></span></span></span> 生成值矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span>。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/m_r_qkv.png" alt="根据矩阵 M 和矩阵 R 创建矩阵 Q、K、V"></p>
</li>
<li>
<p>计算查询矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf{Q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8805499999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathbf">Q</span></span></span></span></span> 和键矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{K}^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413309999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 的点积，得到 <code>目标句</code> 中每个词和 <code>原句</code> 中每个词的相似度。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/m_r_q_mul_k.png" alt="查询矩阵和键矩阵的点积"></p>
</li>
<li>
<p>根据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac></mrow><annotation encoding="application/x-tex">\frac{\mathbf{Q}\mathbf{K}^T}{\sqrt{d_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.627473em;vertical-align:-0.538em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.089473em;"><span style="top:-2.5864385em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622307142857143em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222307142857144em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">Q</span></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9190928571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 的到权重矩阵，为了演示方便，此处我们令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">d_k = 64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">6</span><span class="mord">4</span></span></span></span>。</p>
</li>
<li>
<p>根据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\text{softmax}\left(\frac{\mathbf{Q}\mathbf{K}^T}{\sqrt{d_k}}\right) \mathbf{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.80002em;vertical-align:-0.65002em;"></span><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.089473em;"><span style="top:-2.5864385em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622307142857143em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3487714285714287em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15122857142857138em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8222307142857144em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.17776928571428574em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">Q</span></span><span class="mord mtight"><span class="mord mtight"><span class="mord mathbf mtight">K</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9190928571428572em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">V</span></span></span></span></span> 计算注意力矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi></mrow><annotation encoding="application/x-tex">\mathbf{Z}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">Z</span></span></span></span></span>。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/m_r_attention.png" alt></p>
<p>如图所示：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">z</mi><mtext>我</mtext></msub><mo>=</mo><mn>0.99</mn><mo>⋅</mo><msub><mi mathvariant="bold">v</mi><mi>I</mi></msub><mo>+</mo><mn>0.01</mn><mo>⋅</mo><msub><mi mathvariant="bold">v</mi><mrow><mi>a</mi><mi>m</mi></mrow></msub><mo>+</mo><mn>0.0</mn><mo>⋅</mo><msub><mi mathvariant="bold">v</mi><mi>a</mi></msub><mo>+</mo><mn>0.0</mn><mo>⋅</mo><msub><mi mathvariant="bold">v</mi><mrow><mi>s</mi><mi>t</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>n</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{z}_{我} = 0.99 \cdot \mathbf{v}_{I} + 0.01 \cdot \mathbf{v}_{am} + 0.0 \cdot \mathbf{v}_{a} + 0.0 \cdot \mathbf{v}_{student}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord cjk_fallback mtight">我</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">9</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.59444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">t</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">n</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>由此，如上的结果可以让模型理解 <code>目标句</code> 中的 <code>我</code> 指代的其实就是 <code>原句</code> 中的 <code>I</code>。</p>
</li>
</ol>
<p>同样的，在该层中，我们仍然可以有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span> 个注意力矩阵，那么我们可以按如下的方式将这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span> 个注意力矩阵的结果整合起来得到最终的注意力矩阵 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">D</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">c</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">r</mi><mi mathvariant="bold">M</mi><mi mathvariant="bold">u</mi><mi mathvariant="bold">l</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">i</mi><mo>−</mo><mi mathvariant="bold">h</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">a</mi><mi mathvariant="bold">d</mi><mi mathvariant="bold">A</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">n</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">i</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">n</mi></mrow><annotation encoding="application/x-tex">\mathbf{Decoder Multi-head Attention}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathbf">D</span><span class="mord mathbf">e</span><span class="mord mathbf">c</span><span class="mord mathbf">o</span><span class="mord mathbf">d</span><span class="mord mathbf">e</span><span class="mord mathbf">r</span><span class="mord mathbf">M</span><span class="mord mathbf">u</span><span class="mord mathbf">l</span><span class="mord mathbf">t</span><span class="mord mathbf">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathbf">h</span><span class="mord mathbf">e</span><span class="mord mathbf">a</span><span class="mord mathbf">d</span><span class="mord mathbf">A</span><span class="mord mathbf">t</span><span class="mord mathbf">t</span><span class="mord mathbf">e</span><span class="mord mathbf">n</span><span class="mord mathbf">t</span><span class="mord mathbf">i</span><span class="mord mathbf">o</span><span class="mord mathbf">n</span></span></span></span></span>：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="bold">D</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">c</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">d</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">r</mi><mi mathvariant="bold">M</mi><mi mathvariant="bold">u</mi><mi mathvariant="bold">l</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">i</mi><mo>−</mo><mi mathvariant="bold">h</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">a</mi><mi mathvariant="bold">d</mi><mi mathvariant="bold">A</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">e</mi><mi mathvariant="bold">n</mi><mi mathvariant="bold">t</mi><mi mathvariant="bold">i</mi><mi mathvariant="bold">o</mi><mi mathvariant="bold">n</mi></mrow><mo>=</mo><mtext>Concatenate</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">Z</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">Z</mi><mi>h</mi></msub><mo stretchy="false">)</mo><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{Decoder Multi-head Attention} = \text{Concatenate}(\mathbf{Z}_1,\cdots,\mathbf{Z}_h)\mathbf{W}^O
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathbf">D</span><span class="mord mathbf">e</span><span class="mord mathbf">c</span><span class="mord mathbf">o</span><span class="mord mathbf">d</span><span class="mord mathbf">e</span><span class="mord mathbf">r</span><span class="mord mathbf">M</span><span class="mord mathbf">u</span><span class="mord mathbf">l</span><span class="mord mathbf">t</span><span class="mord mathbf">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathbf">h</span><span class="mord mathbf">e</span><span class="mord mathbf">a</span><span class="mord mathbf">d</span><span class="mord mathbf">A</span><span class="mord mathbf">t</span><span class="mord mathbf">t</span><span class="mord mathbf">e</span><span class="mord mathbf">n</span><span class="mord mathbf">t</span><span class="mord mathbf">i</span><span class="mord mathbf">o</span><span class="mord mathbf">n</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1413309999999999em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">Concatenate</span></span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord mathbf">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">Z</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913309999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>同编码器一样，在多头注意力层之后，我们还会增加叠加和归一组件、前馈网络层并最终构成了完整的解码器。在实际应用中，我们可以将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span> 个解码器一个一个的叠加起来，最后一个解码器的输出就是最终的 <code>目标句</code> 的特征值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">T</mi></mrow><annotation encoding="application/x-tex">\mathbf{T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">T</span></span></span></span></span>。</p>
<p><img src="/2024/10/16/What-exactly-is-attention/encoder_decoder.png" alt="Decoder 架构图"></p>
<h3 id="线性层和-softmax-层">线性层和 softmax 层</h3>
<p>一旦解码器学习到了 <code>目标句</code> 的特征值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">T</mi></mrow><annotation encoding="application/x-tex">\mathbf{T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">T</span></span></span></span></span>，我们就可以使用线性层和 <code>softmax</code> 层来生成最终的 <code>目标句</code>。线性层将生成一个 <code>logit</code> 向量，其大小等于 <code>目标句</code> 中的词汇量。假设目标句的词汇量只有 4 个词组成：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mi>u</mi><mi>l</mi><mi>a</mi><mi>r</mi><mi>y</mi><mo>=</mo><mo stretchy="false">{</mo><mtext>是</mtext><mo separator="true">,</mo><mtext>我</mtext><mo separator="true">,</mo><mtext>学生</mtext><mo separator="true">,</mo><mtext>一个</mtext><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">Vocabulary = \{ 是, 我, 学生, 一个 \}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault">b</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord cjk_fallback">是</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord cjk_fallback">我</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord cjk_fallback">学</span><span class="mord cjk_fallback">生</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">个</span><span class="mclose">}</span></span></span></span></span></p>
<p>那么，线性层返回的 <code>logit</code> 的向量的维度将是 4。然后使用 <code>softmax()</code> 将 <code>logit</code> 向量转换成概率表示，最后输出具有最高概率值的词的索引值。</p>
<p>例如，如果解码器的输入是 <code>&lt;sos&gt;我</code>，则解码器需要根据当前的输入预测下一个词。我们把最顶层的解码器的输出特征值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">T</mi></mrow><annotation encoding="application/x-tex">\mathbf{T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68611em;vertical-align:0em;"></span><span class="mord"><span class="mord mathbf">T</span></span></span></span></span> 输入到线性层，假设我们得到的 <code>logit</code> 向量如下所示：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>logit</mtext><mo>=</mo><mo stretchy="false">[</mo><mn>39</mn><mo separator="true">,</mo><mn>20</mn><mo separator="true">,</mo><mn>31</mn><mo separator="true">,</mo><mn>35</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\text{logit} = [39, 20, 31, 35]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">logit</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">3</span><span class="mord">9</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">2</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mord">5</span><span class="mclose">]</span></span></span></span></span></p>
<p>然后，我们对如上的 <code>logit</code> 向量应用 <code>softmax()</code> 计算，并得到如下的概率向量：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>probability</mtext><mo>=</mo><mo stretchy="false">[</mo><mn>0.98</mn><mo separator="true">,</mo><mn>0.00</mn><mo separator="true">,</mo><mn>0.00</mn><mo separator="true">,</mo><mn>0.12</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\text{probability} = [0.98, 0.00, 0.00, 0.12]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">probability</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mord">.</span><span class="mord">9</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">2</span><span class="mclose">]</span></span></span></span></span></p>
<p>从中，我们可以看出，索引值为 0 的词 <code>是</code> 具有最高的概率值，因此，解码器会输出索引值为 0 的词 <code>是</code> 作为下一个词。通过该方式，解码器可以不断的预测 <code>目标句</code> 中的下一个词，直到输出 <code>&lt;eos&gt;</code> 为止。</p>
<h2 id="transformer-整体架构">Transformer 整体架构</h2>
<p>根据如上的介绍，我们可以得到 Transformer 模型的整体架构图：</p>
<p><img src="/2024/10/16/What-exactly-is-attention/transformer.png" alt="Transformer 的架构图"></p>
<p>在上图中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo></mrow><annotation encoding="application/x-tex">N \times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord">×</span></span></span></span> 表示可以堆叠 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span> 个编码器和解码器，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>×</mo></mrow><annotation encoding="application/x-tex">h \times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">h</span><span class="mord">×</span></span></span></span> 表示可以堆叠 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span> 个注意力矩阵。我们可以看到，一旦输入 <code>原句</code>，编码器就会学习 <code>原句</code> 的特征并将特征发送给解码器，而解码器则会不断的预测并生成 <code>目标句</code>。</p>
<p>在内容生成的场景中，我们提供给模型的 <code>prompt</code> 就相当于 <code>原句</code>，而 <code>目标句</code> 则相当于生成的内容。从 Transformer 的整体架构图中，我们可以看到，模型会不断的根据 <code>prompt</code> 和 <code>目标句</code> 的特征来生成最终的 <code>目标句</code>，而不会生成与 <code>prompt</code> 无关的内容，这也就是我们所说的 <strong>上下文学习</strong>（ICL: in context learning） 和 <strong>指令遵循</strong>（instruction following）。</p>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://arxiv.org/html/1706.03762v7">Attention Is All You Need</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://jalammar.github.io/illustrated-transformer/">The Illustrated Transformer</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://eli.thegreenplace.net/2016/the-softmax-function-and-its-derivative/">The Softmax function and its derivative</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://medium.com/@ngiengkianyew/multi-headed-attention-8b940b76c351">Intuition for Multi-headed Attention</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://www.3blue1brown.com/lessons/attention">Visualizing Attention, a Transformer’s Heart</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://www.bilibili.com/video/BV1TZ421j7Ke?spm_id_from=333.788.recommend_more_video.-1&amp;vd_source=fbeb46d16d08ad900fac814e55c3f27f">Visualizing Attention, a Transformer’s Heart（B站版）</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>Transformer</tag>
        <tag>Attention</tag>
        <tag>自注意力机制</tag>
      </tags>
  </entry>
  <entry>
    <title>推断统计方法在评估分析中的应用</title>
    <url>/2024/10/06/The-Statistical-Approach-for-the-Product-Evaluation/</url>
    <content><![CDATA[<p><img src="/2024/10/06/The-Statistical-Approach-for-the-Product-Evaluation/Inferential-Statistics.png" alt></p>
<p>在 <a href="/2024/08/17/The-Basic-Model-for-the-Product-Evaluation/">产品评测的基本模型</a> 这篇文章中，我提到了对 <strong>评测的疑惑</strong>：</p>
<blockquote>
<p>曾经多少次，在系统上线之前，我们从多个方面进行了评测：性能也提升了，效果也提升了，我们兴高采烈的上线，然后激动的等待着实验数据的产出，最后得到的却是效果不明显的结论。多少个不眠的夜里，我总会问自己：技术上已经有了很大的提升啦，为什么却没有在线上表现出对应的效果呢？这究竟是为什么呀？</p>
</blockquote>
<p>同时，根据我的观察和实践，提出了评测的基本模型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Perception</mtext><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mtext>Actual</mtext><mo separator="true">,</mo><mtext> Expected</mtext><mo separator="true">,</mo><mtext> UX</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Perception} = f(\text{Actual}, \ \text{Expected}, \ \text{UX})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">Perception</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord text"><span class="mord">Actual</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">Expected</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">UX</span></span><span class="mclose">)</span></span></span></span> 来解释了评测的疑惑。但是，仅仅依靠这个模型，我们就可以得出合理的结论吗？如上的模型，只能帮助我们获得准确的观察数据，但是如何从准确的观察数据中得出合理的结论呢？</p>
<span id="more"></span>
<h2 id="举个例子🌰">举个例子🌰</h2>
<p>我们来看一个视频编解码的例子：有 100 个源视频（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>1</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>S</mi><mn>100</mn></msub></mrow><annotation encoding="application/x-tex">S_1,...,S_{100}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>），每个视频都会通过 A、B 两组编码参数进行转码并得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mn>1</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><msub><mi>A</mi><mn>100</mn></msub></mrow><annotation encoding="application/x-tex">A_1,...A_{100}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mn>1</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><msub><mi>B</mi><mn>100</mn></msub></mrow><annotation encoding="application/x-tex">B_1,...B_{100}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 两组编码后的视频。我们对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">A_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">B_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 进行成对评估，得到了如下的结果：</p>
<table>
<thead>
<tr>
<th>A 好于 B 的视频数量</th>
<th>A 差于 B 的视频数量</th>
<th>差不多的视频数量</th>
</tr>
</thead>
<tbody>
<tr>
<td><center>42</center></td>
<td><center>37</center></td>
<td><center>21</center></td>
</tr>
</tbody>
</table>
<p>那么，A 编码参数和 B 编码参数究竟哪个好呢？还是没有差别呢？</p>
<p>因为 A 编码参数更好的视频占比是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>42</mn><mi mathvariant="normal">/</mi><mn>100</mn><mo>=</mo><mn>42</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">42/100 = 42\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">4</span><span class="mord">2</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">4</span><span class="mord">2</span><span class="mord">%</span></span></span></span>, B 编码参数更好的视频占比是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>37</mn><mi mathvariant="normal">/</mi><mn>100</mn><mo>=</mo><mn>37</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">37/100 = 37\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">3</span><span class="mord">7</span><span class="mord">/</span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">3</span><span class="mord">7</span><span class="mord">%</span></span></span></span>，所以 A 编码参数的效果更好。我们在以往的视频质量评估中，采用的大多都是这样的方式来分析评估结果，但是这个结论是正确的吗？</p>
<p>在如上的结果中，A 和 B 之间有差异的数据总共是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>42</mn><mo>+</mo><mn>37</mn><mo>=</mo><mn>79</mn></mrow><annotation encoding="application/x-tex">42 + 37 = 79</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">7</span><span class="mord">9</span></span></span></span> 条。而在在 79 条数据中，A 要么比 B 差，要么比 B 好，令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">X_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mn>79</mn></mrow><annotation encoding="application/x-tex">i=1,...,79</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">7</span><span class="mord">9</span></span></span></span>）表示评估的结果，那么 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">X_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是一个二项分布。我们先判断在 5% 的显著性水平下，A 与 B 是否没有显著差异，即：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub><mo>:</mo><mi>p</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mspace width="1em"><mi>v</mi><mi>s</mi><mspace width="1em"><msub><mi>H</mi><mn>1</mn></msub><mo>:</mo><mi>p</mi><mo mathvariant="normal">≠</mo><mfrac><mn>1</mn><mn>2</mn></mfrac></mspace></mspace></mrow><annotation encoding="application/x-tex">H_0: p = \frac{1}{2} \quad vs \quad H_1: p \neq \frac{1}{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:1em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>我们可以使用如下的 <code>R</code> 代码进行检验：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">&gt; binom.test(<span class="number">42</span>, <span class="number">79</span>)</span><br><span class="line"></span><br><span class="line">	Exact binomial test</span><br><span class="line"></span><br><span class="line">data:  <span class="number">42</span> and <span class="number">79</span></span><br><span class="line">number of successes = <span class="number">42</span>, number of trials = <span class="number">79</span>, p-value = <span class="number">0.653</span></span><br><span class="line">alternative hypothesis: true probability of success is not equal to <span class="number">0.5</span></span><br><span class="line">95 percent confidence interval:</span><br><span class="line"> <span class="number">0.4159522</span> <span class="number">0.6448955</span></span><br><span class="line">sample estimates:</span><br><span class="line">probability of success </span><br><span class="line">             <span class="number">0.5316456</span> </span><br></pre></td></tr></table></figure>
<p>从结果可以看出，根据评测数据，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mtext>value</mtext><mo>=</mo><mn>0.653</mn></mrow><annotation encoding="application/x-tex">p-\text{value} = 0.653</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord text"><span class="mord">value</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">6</span><span class="mord">5</span><span class="mord">3</span></span></span></span>，因此在 5% 的显著性水平下，我们不能拒绝 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">p=\frac{1}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，即 A 和 B 之间没有差异的假设。</p>
<p>同样的，我们可以使用 <code>R</code> 得到如下的假设的检验结果：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub><mo>:</mo><mi>p</mi><mo>≤</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mspace width="1em"><mi>v</mi><mi>s</mi><mspace width="1em"><msub><mi>H</mi><mn>1</mn></msub><mo>:</mo><mi>p</mi><mo>≥</mo><mfrac><mn>1</mn><mn>2</mn></mfrac></mspace></mspace></mrow><annotation encoding="application/x-tex">H_0: p \le \frac{1}{2} \quad vs \quad H_1: p \ge \frac{1}{2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8304100000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:1em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:1em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8304100000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<figure class="highlight r"><table><tr><td class="code"><pre><span class="line">&gt; binom.test(<span class="number">42</span>, <span class="number">79</span>, alternative=<span class="string">&quot;greater&quot;</span>)</span><br><span class="line"></span><br><span class="line">	Exact binomial test</span><br><span class="line"></span><br><span class="line">data:  <span class="number">42</span> and <span class="number">79</span></span><br><span class="line">number of successes = <span class="number">42</span>, number of trials = <span class="number">79</span>, p-value = <span class="number">0.3265</span></span><br><span class="line">alternative hypothesis: true probability of success is greater than <span class="number">0.5</span></span><br><span class="line">95 percent confidence interval:</span><br><span class="line"> <span class="number">0.4333002</span> <span class="number">1.0000000</span></span><br><span class="line">sample estimates:</span><br><span class="line">probability of success </span><br><span class="line">             <span class="number">0.5316456</span></span><br></pre></td></tr></table></figure>
<p>从结果可以看出，根据评测数据，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mtext>value</mtext><mo>=</mo><mn>0.3265</mn></mrow><annotation encoding="application/x-tex">p-\text{value} = 0.3265</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord text"><span class="mord">value</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">3</span><span class="mord">2</span><span class="mord">6</span><span class="mord">5</span></span></span></span>，因此我们无法拒绝 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>≤</mo><mfrac><mn>1</mn><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">p \le \frac{1}{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304100000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 得到 A 更好的结论。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">❓
</p><p>同样的一份数据在采用不同的分析方法时得出了不同的结论，哪个才是正确的呢？</p>
<p>虽然在如上的例子中，有很多例如：显著性水平，<em>p-value</em> 等术语，但是不用担心，在文章的后面，我们会详细介绍这些术语的含义。</p>
</div>
<h2 id="什么是推断统计？">什么是推断统计？</h2>
<p>统计学（<em>Statistics</em>）是一门从数据中学习的艺术，它包括数据的收集，也包括通过后续的数据描述和数据分析来获得结论。对数据的分析有两种不同的方式：描述统计和推断统计，描述统计是统计学的基础，其主要处理样本数据；而推断统计则是描述统计的升华，其利用样本数据来推测总体特征。</p>
<ul>
<li>
<p>描述统计主要关注于数据的收集、处理、汇总、图表描述、概括与分析，包括统计数据的收集方法、数据的加工处理方法、数据的显示方法、数据的分布特征与分析方法等。描述统计的目的是将数据转化为有意义的信息，并帮助我们理解数据的特征和规律。常见的描述统计包括直方图、平均数、中位数、众数等。</p>
</li>
<li>
<p>推断统计主要关注如何利用样本数据来推断总体特征，包括参数估计（例如平均数、标准差的估计）和假设检验两种类型。推断统计允许我们根据部分数据来推断总体特征，从而提高研究的效率和准确性。常用的推断统计包括置信区间、t 检验、方差分析等。</p>
</li>
</ul>
<p>推断统计是数据分析的强大力量，允许我们能够根据样本来推断总体的特征，并对总体进行预测。</p>
<p>正如数据可视化领域的先驱 William Cleveland 所说<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>：</p>
<blockquote>
<p>现代数据分析的目标是预测和推断，而不仅仅是描述（The goal of modern data analysis is prediction and inference, not just description）。</p>
</blockquote>
<p>统计学领域的泰斗 John Tukey 给出了推断的定义，这意味着推断统计的本质在于从整体的一小部分告诉我们整体的情况<sup class="footnote-ref"><a href="#fn1" id="fnref1:1">[1:1]</a></sup>：</p>
<blockquote>
<p>推断不是演绎，而是归纳（Inference is not deduction; it’s induction.）。</p>
</blockquote>
<h2 id="在评估中应用推断统计">在评估中应用推断统计</h2>
<p>如今，随着大模型的兴起，大模型评估也越来越重要，我们经常会看到各种榜单公布的不同大模型的能力排行，例如 <a href="https://huggingface.co/spaces/lmsys/chatbot-arena-leaderboard?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE3Mjg1MzMxNzAsImZpbGVHVUlEIjoiV2xBcmRndkdsNVNud3ZxMiIsImlhdCI6MTcyODUzMjg3MCwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjotODkyNzg3NTY0Nn0.pvYtAUT7FOF_BXcGBDjMdtku1GHb_svVO8pqoHL__P4">Huggingface 的 Chatbot Arena</a>，<a href="https://superclueai.com/">SuperGLUE 榜单</a> 等。</p>
<p>但是，这些榜单中的不同打分究竟意味着什么呢？在为业务选择模型、优化模型的时候，79 分就一定比 78 分要好吗？就像体育赛事中，虽然有冠军和亚军，但是冠军和亚军之间会存在非常显著的差异吗？</p>
<p>在 <a href="https://arxiv.org/html/2403.15250v2">Comprehensive Reassessment of Large-Scale Evaluation Outcomes in LLMs: A Multifaceted Statistical Approach</a><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> 这篇文论中提到：</p>
<blockquote>
<p>The rapid growth of LLMs calls for more comprehensive and reliable evaluation methods. This necessitates broadening the scope of assessments, employing rigorous statistical methods.</p>
<p>Currently, fundamental statistical techniques, such as ANOVA or <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>χ</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\chi^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.008548em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">χ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span> tests are missing in testing resulting data. These analyses are crucial for understanding whether LLM performance varies significantly across different training types, architectures, and parameter sizes.</p>
<p><img src="/2024/10/06/The-Statistical-Approach-for-the-Product-Evaluation/2.png" alt></p>
</blockquote>
<p>在美国，新药上市之前必须经过美国食品药品监督管理局（FDA）的批准，即“新药申请审评程序”（NDA），以确保药品的安全性和有效性。并且为了确保药品安全性和有效性评估的科学严谨性，新药的审批需要根据 <a href="https://www.fda.gov/regulatory-information/search-fda-guidance-documents/e9-statistical-principles-clinical-trials">ICH E9: Statistical Principles for Clinical Trials</a> 中提供的标准的实验框架和规范的统计方法。</p>
<p>回头想想，虽然在我们的视频评估过程中，我们进行了各种结果打分的优化（比如引入 GSB， <a href="/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/">Elo 打分</a>……），我们可以更精准的刻画不同编解码器的效果，但是我们只能给出绝对排序却无法判断不同编解码器之间是否存在显著差异；我们只能说在当前的样本上，哪个编解码器的效果更好，但是却无法将这个结论泛化到线上的所有视频。就像我们在文章开头举的例子那样，42% 就一定比 37% 要好吗？而推断统计方法就可以帮助我们更好的分析数据，并得出更为合理的结论。</p>
<h2 id="参数估计与假设检验">参数估计与假设检验</h2>
<p>参数估计和假设检验是统计推断中的两个基本问题：参数估计提供对总体参数的估计，而假设检验则对总体参数是否等于某个特定值进行检验。</p>
<ul>
<li>参数估计主要解决如何使用数据来估计感兴趣的参数。例如，科学家可能想要确定受到酸雨影响的中西部湖泊的比例。参数估计主要有点估计和区间估计两种。点估计方法用一个数字来估计感兴趣的统计量（例如，中西部湖泊中有 47% 的湖泊受到了酸雨的影响）。区间估计则是以一个数值区间的形式来估计总体参数的范围（例如，中西部湖泊中有 45% ~ 49% 的湖泊受到了酸雨的影响）。区间估计方法还告诉我们对其估计结果的 “置信水平”（ level of confidence）。例如，尽管我们并不能肯定 47% 就是受影响的湖泊的确切比例，但我们很可能有 95% 的信心认为实际受影响的湖泊比例在 45% ~ 49% 之间。</li>
<li>假设检验则是利用数据来检验特定假设的合理性。例如，假设检验可能会拒绝 “中西部受酸雨影响的湖泊少于 44%” 这样的假设。建设检验技术会涉及到如下的概念：统计量，显著性水平，原假设，备择假设，拒绝域，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mtext>value</mtext></mrow><annotation encoding="application/x-tex">p-\text{value}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord text"><span class="mord">value</span></span></span></span></span> 等概念<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>：
<ul>
<li>原假设（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">H_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）：这是我们的起点（默认假设），通常表示没有效应、差异或关联。例如，一个新药与现有药物在疗效上没有差异。</li>
<li>备择假设（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">H_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）：与原假设相对立的假设，表示存在某种效应、差异或关联。例如，一个新药比现有药物更有效。</li>
<li>拒绝域：检验统计量的值域，如果检验统计量的值落在这个区域内，我们将拒绝原假设。</li>
<li>显著性水平（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span></span></span></span>）：这是我们愿意承担错误拒绝原假设的最大风险水平，通常设定为 0.05 或 0.01。</li>
<li>检验统计量（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>T</mi></mrow><annotation encoding="application/x-tex">T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span></span></span></span>）：一个基于样本数据计算出的数值，用于衡量样本统计量与原假设之间的差异。</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mtext>value</mtext></mrow><annotation encoding="application/x-tex">p-\text{value}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord text"><span class="mord">value</span></span></span></span></span>：在原假设为真的情况下，观察到的样本结果出现的概率，如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mtext>value</mtext><mo>≤</mo><mi>α</mi></mrow><annotation encoding="application/x-tex">p-\text{value} \le \alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.83041em;vertical-align:-0.13597em;"></span><span class="mord text"><span class="mord">value</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span></span></span></span>，则拒绝零假设，这表明观察到的效应或差异在统计上是显著的。如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>−</mo><mtext>value</mtext><mo>&gt;</mo><mi>α</mi></mrow><annotation encoding="application/x-tex">p-\text{value} \gt \alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.73354em;vertical-align:-0.0391em;"></span><span class="mord text"><span class="mord">value</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span></span></span></span>，则不拒绝零假设，这表明没有足够的证据表明观察到的效应或差异是显著的。</li>
</ul>
</li>
</ul>
<p>当涉及到需要判断多组数据时，我们通常使用 ANOVA（分析方差）和卡方检验来检验不同方案的效果是否一致的假设。例如<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>：</p>
<blockquote>
<p>目前市面上有 4 款软件可以教授用户学习一门新的变成语言，某大公司正在考虑大规模购买这 4 款软件中的一款。公司内部一些资深人士声称，这几款软件没有太大的区别，它们对用户的最终学习效果影响很小。为了检验这一假设，公司决定选择 160 名工程师，并将他们分成 4 组，每组 40 人。第 <em>i</em> 组的工程师使用第 <em>i</em> 款软件来学习新的语言。当所有工程师完成学习后，参与学习的所有工程师将进行一次全面考试。公司希望使用这次考试的结果来确定不同的教学软件是否真的可以互换。该公司需要怎么做才能实现这一点？</p>
</blockquote>
<h2 id="推荐阅读">推荐阅读</h2>
<p>Introduction to Probability and Statistics for Engineers and Scientists (Sixth Edition) 是一本为工程师和科学家而作的有关概率论和数理统计方面的书籍。这本书展示了如何应用概率论来洞察现实生活中的统计问题，书中精心设计的概率论相关的内容将真实现象的概率模型和其统计程序关联起来，以便读者能够更直观的理解实践工程师和科学家最常用的统计程序和策略。</p>
<p>可以点击<a href="https://wangwei1237.github.io/introduction_to_probability_and_statistics/">🔗链接</a>来阅读这本书的中文翻译版。</p>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://aimarketingengineers.com/inferential-statistics/">inferential statistics</a> <a href="#fnref1" class="footnote-backref">↩︎</a> <a href="#fnref1:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://arxiv.org/html/2403.15250v2">Comprehensive Reassessment of Large-Scale Evaluation Outcomes in LLMs: A Multifaceted Statistical Approach</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://mp.weixin.qq.com/s/UUIfY4oAvUXoxS-t1zPR2g">假设检验 101：基于数据构建的可信结论</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://wangwei1237.github.io/introduction_to_probability_and_statistics/chapter_10/10.html">方差分析</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>数据分析</tag>
        <tag>评测</tag>
        <tag>统计学</tag>
        <tag>推断统计</tag>
      </tags>
  </entry>
  <entry>
    <title>产品评测的基本模型</title>
    <url>/2024/08/17/The-Basic-Model-for-the-Product-Evaluation/</url>
    <content><![CDATA[<p><img src="/2024/08/17/The-Basic-Model-for-the-Product-Evaluation/1.png" alt></p>
<p>2024 年 7 月 25 日，我面向公司内部做了一次关于大模型多模态评测的分享，在这次的分享中，我总结了自己在产品评测和分析方面多年来的观察、实践和思考，并首次提出了 <strong>产品评测的基本模型</strong> 这一概念，并用这一模型分析了我们在实践中遇到的问题。</p>
<p>现在，把 <strong>产品评测的基本模型</strong> 这部分内容单独整理出来，以便能够让更多的人可以利用这个模型更好地进行产品评测。</p>
<span id="more"></span>
<h2 id="评测的疑惑">评测的疑惑</h2>
<p>刚工作的时候，经常从事性能评估工作以评估当前系统的改动是否会影响系统的整体性能。那个时候，我们总能够找到各种方法构造线下的性能测试环境，并且性能指标的测试结果往往能够代表上线后的系统的真实表现。也就是说，上线前的性能测试结果和上线后的后验表现之间具备很好的相关性，所以，性能测试结果能够解释、代表上线后的系统性能。</p>
<p>后来，开始参与产品评测的工作，并且开始发现：从解释、指导层面讲，产品评测和之前的性能评测非常不同，产品评测的结果和上线之后的后验结果之间往往有非常大的偏差，甚至是完全相反的结论。</p>
<p>曾经多少次，在系统上线之前，我们从多个方面进行了评测：性能也提升了，效果也提升了，我们兴高采烈的上线，然后激动的等待着实验数据的产出，最后得到的却是效果不明显的结论。多少个不眠的夜里，我总会问自己：技术上已经有了很大的提升啦，为什么却没有在线上表现出对应的效果呢？这究竟是为什么呀？</p>
<h3 id="相机-vs-iphone">相机 VS iPhone</h3>
<p>后来，我看到了旧金山摄影师 <a href="https://om.co/about/">OM MALIK</a> 制作的一张 <a href="https://om.co/2021/02/07/iphone-vs-camera-no-contest/">全球相机和 iPhone 销量的对比图</a>。</p>
<p><img src="/2024/08/17/The-Basic-Model-for-the-Product-Evaluation/iPhonevsCameraSales2020.jpeg" alt></p>
<p>在这张对比图上，我们可以明显看到相机和 iPhone 之间此消彼长的态势，以及以 iPhone 为代表的智能手机对相机展开的销量 “屠杀”：</p>
<ul>
<li>2007 年 iPhone 问世时，正处于相机的巅峰时期，其年出货量都在上亿台左右，iPhone 对相机行业的影响也微乎其微。</li>
<li>2012 年，随着 iPhone 5 的面世，800 万像素的手机相机镜头已经开始对相机行业带来冲击。</li>
</ul>
<p>近几年的情况就更不用介绍了，对于普通消费者而言，手机足以满足日常拍摄需求，相机的销量被极度压缩。如今，相机的年出货量还不到 1 千万台，已经不足鼎盛时期的 10%。而 iPhone 的出货量已超过 2 亿台，是相机的近 30 倍。</p>
<p><img src="/2024/08/17/The-Basic-Model-for-the-Product-Evaluation/2.png" alt></p>
<p>在 <a href="https://www.dxomark.cn/smartphones-vs-cameras-closing-the-gap-on-image-quality/">智能手机与相机图像质量：逐渐弥合的差距</a> 这篇文章中，对比了相机和手机的拍照体验，其中也提到在很多场景下，相机的性能确实是比当前的高端手机要好很多的。所以，从技术角度上讲，相机的能力并不差，甚至在某些场景（比如抓拍）还要优于手机。尤其是在几年前，相机的拍照能力远远超过手机的时候，相机的销量依然在持续下跌。</p>
<p>技术没问题呀，用户怎么就是不买呢？</p>
<h2 id="产品评测模型">产品评测模型</h2>
<p>我一直在想，为什么产品评测的结果和上线后的后验表现之间往往比较大的偏差呢？这背后究竟隐藏着什么秘密和规律呢？</p>
<h3 id="用户体验模型">用户体验模型</h3>
<p>2021 年底的时候，基于自己的观察和思考以及阅读的大量资料，我写了一篇文章：<a href="/2021/12/17/the-QoE-model-for-production/">产品的用户体验模型</a> ，在这篇文章中提出了如下的用户体验模型：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>Q</mi><mi>o</mi><mi>E</mi><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>用户上瘾</mtext><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if  </mtext><mi>Q</mi><mi>o</mi><mi>E</mi><mtext> </mtext><mo>&gt;</mo><mi mathvariant="normal">Δ</mi><mo separator="true">;</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>基本满足</mtext><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if  </mtext><mi mathvariant="normal">∣</mi><mtext> </mtext><mi>Q</mi><mi>o</mi><mi>E</mi><mtext> </mtext><mi mathvariant="normal">∣</mi><mo>&lt;</mo><mi>ε</mi><mo separator="true">;</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>用户离去</mtext><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if   </mtext><mi>Q</mi><mi>o</mi><mi>E</mi><mtext> </mtext><mo>&lt;</mo><mo>−</mo><mi mathvariant="normal">Δ</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>s</mi><mi mathvariant="normal">.</mi><mi>t</mi><mi mathvariant="normal">.</mi><mtext>  </mtext><mn>0</mn><mo>&lt;</mo><mi>ε</mi><mo>≪</mo><mi mathvariant="normal">Δ</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
&amp;QoE = \begin{cases}
\text{用户上瘾}, &amp;\text{if } \ QoE\  &gt; \Delta;\\
\text{基本满足}, &amp;\text{if } \ |\ QoE\ | &lt; \varepsilon;\\
\text{用户离去}, &amp;\text{if } \ \ QoE\  &lt;  -\Delta
\end{cases}\\
&amp;\\
&amp; s.t. \ \ 0 &lt; \varepsilon \ll \Delta
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.62em;vertical-align:-3.5599999999999996em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.0600000000000005em;"><span style="top:-6.0600000000000005em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"></span></span><span style="top:-3.0100000000000007em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"></span></span><span style="top:-1.5100000000000007em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5599999999999996em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.0600000000000005em;"><span style="top:-6.0600000000000005em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35002em;"><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.19499em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.20499em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.2950099999999996em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.30501em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.60002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8500199999999998em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">用户上瘾</span></span><span class="mpunct">,</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">基本满足</span></span><span class="mpunct">,</span></span></span><span style="top:-1.5300000000000002em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">用户离去</span></span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace"> </span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">Δ</span><span class="mpunct">;</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace"> </span><span class="mord">∣</span><span class="mspace"> </span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace"> </span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">ε</span><span class="mpunct">;</span></span></span><span style="top:-1.5300000000000002em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace"> </span><span class="mspace"> </span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord">Δ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.0100000000000007em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top:-1.5100000000000007em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault">s</span><span class="mord">.</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mspace"> </span><span class="mspace"> </span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">ε</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">Δ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5599999999999996em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><img src="/2021/12/17/the-QoE-model-for-production/2.png" alt></p>
<p>事情好像渐渐明晰了起来，但是好像还是没有从根本上解释产品评测的结果和上线后的后验表现之间存在偏差的原因。</p>
<h3 id="评测基本模型">评测基本模型</h3>
<p>直到最近，在一次针对语音的多维度评估中，我们才从多个视角的评估数据中忽然发现了这其中的秘密。高兴之情溢于言表，可真是：潇潇雨，雾蒙浓，一线阳光穿云出。我把我们的发现称之为：产品评测的基本模型。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Perception</mtext><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mtext>Actual</mtext><mo separator="true">,</mo><mtext> Expected</mtext><mo separator="true">,</mo><mtext> UX</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Perception} = f(\text{Actual}, \ \text{Expected}, \ \text{UX}) 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">Perception</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord text"><span class="mord">Actual</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">Expected</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">UX</span></span><span class="mclose">)</span></span></span></span></span></p>
<ul>
<li><strong>Perception</strong>：代表着用户使用产品的感知体验。</li>
<li><strong>Actual</strong>：代表着产品的实际具有的能力，比如 佳能 EOS R5 Mark II 相机可以拍摄 8K 60P 的视频。</li>
<li><strong>Expected</strong>：代表着用户使用产品之前的预期，即用户希望这个产品有什么能力，比如用户希望单反相机能够拍出 4K HDR 的视频。</li>
<li><strong>UX</strong>：代表的用户使用产品过程中的交互体验，比如相机的 3A——自动对焦 (AF)、自动曝光 (AE) 和自动白平衡 (AWB)——使得我们在拍照过程中不需要频繁调节各种参数，大大提升了用户拍照的交互体验。</li>
</ul>
<p>用户的感知体验不仅仅依赖于产品的实际能力，也不仅仅与用户预期有关，而是和产品的实际能力、用户预期、交互体验这三者（我们称之为感知体验三要素）有关，是这三者共同决定的。我们之前的评测往往只关注了这三者中的某个或者某两个因素，因此导致了评测结果和上线后的后验表现之间存在偏差。</p>
<h4 id="actual">Actual</h4>
<p>产品的实际能力取决于产品的技术实力，是产品感知体验的基础和根本。没有强大的技术实力，很难纯靠贩卖预期和在细节上死扣交互体验而做出让用户满意的产品，更很难获得较好的用户感知体验。</p>
<h4 id="expected">Expected</h4>
<p>用户预期是感知体验的显著影响力，当用户想要一个苹果时，我们却给了他一车香蕉，即便是最好的香蕉，那么用户也很难满意。在雷军的 《小米创业思考》这本书中，雷军对用户预期给予了高度关注。</p>
<div class="douban-card-block">
	<a class="douban-card" href="https://book.douban.com/subject/36057097">
		<div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img1.doubanio.com/view/subject/s/public/s34286309.jpg');"></div>
		<div class="douban-card-left">
			<div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img1.doubanio.com/view/subject/s/public/s34286309.jpg');"></div>
		</div>
		<div class="douban-card-right" style="line-height: 1.7;">
			<div class="douban-card-item"><span>书名: </span><strong>小米创业思考</strong></div>
			<div class="douban-card-item"><span>作者: </span><span>雷军</span></div>
			<div class="douban-card-item"><span>出版年份: </span><span>2022-8-1</span></div>
			<div class="douban-card-item"><span>评分: </span><span>8.1</span></div>
		</div>
	</a>
</div>
<style>
	.douban-card-block {
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		max-height: 400px;
	}
	.douban-card {
		display: flex;
		margin: 30px 10px;
		padding: 15px;
		border-radius: 10px;
		position: relative;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		color: antiquewhite;
		text-decoration: none;
	}
	.douban-card:hover {
		text-decoration: none;
	}
	.douban-card-bgimg {
		position: absolute;
		width: 115%;
		height: 115%;
		filter: blur(15px) brightness(0.6);
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
	}
	.douban-card-left {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.douban-card-right {
		position: relative;
		display: flex;
		flex-direction: column;
		margin-left: 12px;
		font-size: 16px;
		font-family: 'Courier New', Courier, monospace;
		line-height: 1.3;
		color: antiquewhite;
	}
	.douban-card-item {
		margin-top: 4px;
	}
</style>
<p>在 《小米创业思考》 一书中，雷军总结了小米成功的互联网七字诀：专注、极致、口碑、快。对于 “口碑” 这个秘诀，书里这样写到：</p>
<blockquote>
<p>用户口碑是所有产品成功的关键因素，这是不言而喻的公理。</p>
<p>资源永远有限，对于创业公司尤其如此。只有专注，才能集中所有资源做一件事情，才能把这件事情做到极致；只有极致，才能从内心深处打动用户，用户才愿意口口相传，从而形成良好的口碑传播效应。</p>
<p>良好的口碑从何而来？我的理解是，好产品不一定能带来口碑，便宜的产品不一定能带来口碑，又好又便宜的产品也不一定能带来口碑，<code>只有超过预期的产品才能带来口碑</code>。</p>
</blockquote>
<p>在 《小米创业思考》 这本书中，总共提到了近 40 次用户预期，在这本书的 14 个章节中，有 5 个章节提到了用户预期，从中也可以看出用户预期的重要性。在第 12 章——生态链模式——介绍小米手环的时候，书里这样写道：</p>
<blockquote>
<p>为了刺激用户的超预期感，我们玩了点“小心思”，在发布产品时，我们对外宣称可以实现 30 天的超长待机（这在当时已经是个不敢想象的数字），但实际上实验数据要远大于这个数字。</p>
<p><strong>很多用户使用之后才发现续航时间比说明书里说的要长很多，大大超出预期，由此进一步扩大了小米手环的口碑。</strong></p>
</blockquote>
<p>我们认为，用户预期来自两个因素：</p>
<ul>
<li>用户的自我认知</li>
<li>竞品的实际能力</li>
</ul>
<p>如何理解呢？如果小孩平时考试都是考 70 分左右（满分 100 分），忽然有一天孩子告诉你她考了 90 分，那么作为父母的我们一定会感到很高兴。过了几天，你去参加家长会，发现那次考试全班 30 个孩子有 29 个考了满分，那么此时我们可能就不会那么高兴了。</p>
<p>技术变化很快，各类产品层出不穷，用户的预期也随着用户自我认知的提高而不断变化。<strong>所以用户预期并不是一成不变的，而是随着用户自我认知的变化而不断变化</strong>。这要求我们在对待用户预期时，即不能刻舟求剑，也不能坐井观天，而是要用发展的眼光看待用户预期的变化。</p>
<p>所以，分析到此处，我们才发现了这么多年以来，<code>我们做产品评测的第一大误区</code>：评测的本质应该去探测用户的预期，而不是去对比产品之间的某个具体功能的差异。预期是随着人的不同而不断变化的，是分人群的，是因人而异的；但是不同产品之间的功能差异是固定的，是不因人而异的。</p>
<h4 id="ux">UX</h4>
<p>UX 是强有力的粘合剂，是产品实际能力和用户预期之间的润滑剂。当用户预期和产品的实际能力之间出现了偏差的时候，那么就需要依靠强大的 UX 来进行一定的补偿，以避免感知体验上的巨大落差。</p>
<p>在电影 《抓娃娃》中，有一个马继业带着奶奶和妈妈去吃海底捞的片段：</p>
<blockquote>
<p>马继业钱花完了，没钱买菜，于是就带着奶奶和妈妈去海得捞改善下伙食（排队就餐时海得捞提供的免费的饮料和零食），当服务员说可以进去用餐的时候，马继业连忙说：不用不用，我们还想多排一会呢……</p>
</blockquote>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=1906408958&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<p>从这个层面来看，我们发现 Loading 动画是 UX 最伟大的发明之一。</p>
<h2 id="评测基本模型中的-f">评测基本模型中的 <em>f</em></h2>
<p>在评测的基本模型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Perception</mtext><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mtext>Actual</mtext><mo separator="true">,</mo><mtext> Expected</mtext><mo separator="true">,</mo><mtext> UX</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Perception} = f(\text{Actual}, \ \text{Expected}, \ \text{UX})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">Perception</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord text"><span class="mord">Actual</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">Expected</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">UX</span></span><span class="mclose">)</span></span></span></span> 中，除了我们上面介绍的感知体验三要素外，感知体验三要素的组合方式 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span></span></span></span> 也是一个非常重要的、我们容易忽略的因素。</p>
<p>在同一个坐标系之中，即便对于是相同的自变量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">x</span></span></span></span>，如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span></span></span></span> 不同，那么因变量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">y = f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span> 也将不同。</p>
<p><img src="/2024/08/17/The-Basic-Model-for-the-Product-Evaluation/3.png" alt></p>
<p>对于评测的基本模型 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Perception</mtext><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mtext>Actual</mtext><mo separator="true">,</mo><mtext> Expected</mtext><mo separator="true">,</mo><mtext> UX</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Perception} = f(\text{Actual}, \ \text{Expected}, \ \text{UX})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">Perception</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord text"><span class="mord">Actual</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">Expected</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">UX</span></span><span class="mclose">)</span></span></span></span> 也是如此，即便感知体验的三要素相同，对着三要素的不同组合方式带来的感知体验也不同。正如 <a href="https://baike.baidu.com/item/%E7%94%B0%E5%BF%8C%E8%B5%9B%E9%A9%AC/1137056">田忌赛马</a> 的典故中所说的那样：</p>
<blockquote>
<p>孙子曰：今以君之下驷与彼上驷，取君上驷与彼中驷，取君中驷与彼下驷。既驰三辈毕，而田忌一不胜而再胜，卒得王千金。</p>
</blockquote>
<p>要素很重要，但是要素的组成方式和构成结构更为重要。正如我在 <a href="/2023/07/09/My-practice-of-working-backwards/">我的 “逆向工作” 实践</a> 中提到的那样：</p>
<blockquote>
<p>对于实现特定目标的系统而言，要素很重要，但是连接更为重要。结构决定性质，性质决定用途，就是这个样子。同样都是由 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span> 原子构成，石墨和钻石的结构不同决定了其性质存在非常大的差异。</p>
<p><img src="/2023/07/09/My-practice-of-working-backwards/7.png" alt></p>
<p>图片中的结构模型由 <a href="https://molview.org/">molview</a> 工具生成。</p>
</blockquote>
<p>到此，我们也发现了这么多年来，<code>我们做产品评测的第二大误区</code>：产品评测应该去探测如何组合感知体验的三要素，从而让产品获得最优的感知体验；而不是去对比产品之间的某个具体功能的差异。如何将某一要素的领先优势发挥到极致、采用什么样的结构能够避免某一要素的不足，这才是产品评测更应该关注的事情。</p>
<h2 id="总结">总结</h2>
<p>回头想想，我们发现 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Perception</mtext><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mtext>Actual</mtext><mo separator="true">,</mo><mtext> Expected</mtext><mo separator="true">,</mo><mtext> UX</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Perception} = f(\text{Actual}, \ \text{Expected}, \ \text{UX})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord">Perception</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord text"><span class="mord">Actual</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">Expected</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord text"><span class="mord">UX</span></span><span class="mclose">)</span></span></span></span> 这个模型源自一次评测中的数据不一致性，这也让我想起了一句话：创新源自异种文化之间的思想碰撞。当数据出现不一致的时候，可能就是创新开始的时候。</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>产品评测</tag>
        <tag>用户体验</tag>
      </tags>
  </entry>
  <entry>
    <title>音频质量评估中的 ABX 测试</title>
    <url>/2024/04/04/ABX-test-in-the-Audio-Quality-Assessment/</url>
    <content><![CDATA[<p><img src="/2024/04/04/ABX-test-in-the-Audio-Quality-Assessment/1.jpeg" alt></p>
<p>在音频编解码中，经常需要判断经过不同的编解码算法、参数而生成的音频在人的感知层面是否存在差异。虽然 <a href="2023/08/12/the-interesting-elo-rating-system/">成对打分</a> 也可以用于这种场景，但是成对比较的结果可能会涉及到很多无意识的影响因素，例如不同受试者的经验、心情等。如果受试者采用随机选择的策略，对于成对比较而言，则缺乏有效的手段来对其进行识别。</p>
<span id="more"></span>
<h2 id="成对打分法的缺点">成对打分法的缺点</h2>
<p>我们可以在成对打分中引入<strong>锚点样本</strong>来评估受试者的打分是否置信，但是为了避免评估过程中的感知疲劳对受试者带来干扰，我们引入的<strong>锚点样本</strong>必须控制在一定量级，比如 2 个。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">锚点样本
</p><p>锚点样本指的是在一个待评估的样本序列中，随机插入的、有明显质量差异的、有预先设定好打分的样本。</p>
</div>
<p>在评估过程中，一组样本（A，B）要么是有差异的，要么是没有差异的，因此结果是一个典型的<a href="https://baike.baidu.com/item/0%E2%80%941%E5%88%86%E5%B8%83">伯努利分布</a>。当锚点样本数量为 2 时，我们可以使用如下的代码来计算随机因素下的打分正确的概率：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> binom</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    x = binom.pmf(k, <span class="number">2</span>, <span class="number">0.5</span>)</span><br><span class="line">    <span class="built_in">print</span>(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0.25 0.5 0.25</span></span><br></pre></td></tr></table></figure>
<p>可知，即便两个锚点样本的打分都是正确的，那么也可能有 25% 的概率是受试者在随机打分的情况下做出的选择。</p>
<h2 id="abx-测试">ABX 测试</h2>
<p>和 <strong>成对打分</strong> 类似，ABX 测试是一种判断两个信号（例如视觉、听觉、嗅觉等信号）之间是否存在感知差异的一种评估方法。</p>
<p>在 ABX 测试中，会先将两个已知的样本（分别为样本A和样本B）呈现给受试者，然后从A、B中随机选择一个样本作为未知样本 X 呈现给受试者。受试者的目标就是根据自己的感知体验来判断 X 究竟是 A 还是 B。如果在一定次数的测试中，受试者无法以较低的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值可靠地识别出 X，则不能否定零假设——即没有足够的证据证明 A 与 B 之间存在可感知的差异。</p>
<p>在 ABX 测试中，样本 A 和 样本 B 均是在样本 X 之前呈现给受试者，所以受试者无需依赖长期记忆或过去的经验来辨别差异，这可以消除其他评估方式中存在的无意识影响因素。</p>
<p>同时，在 ABX 测试中，除了传统的正确率指标外，还会通过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值来进行假设检验，从而可以最大程度的避免随机因素带来的误差的概率，进而使得评估的结果更为置信。</p>
<p>ABX 测试最早是由贝尔实验室的两位研究人员 W.a.Munson 和 Mark B.Gardner 在 1950 年发表的 <em>Standardizing Auditory Tests</em> 这篇论文中提出的音频测试方法<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。在这篇论文中，作者提到：ABX 测试其实就是一种成对比较方式的变体。</p>
<blockquote>
<p>The procedure, which we have called the “ABX” test, is a modification of the method of paired comparisons.</p>
</blockquote>
<h2 id="abx-结果的统计分析">ABX 结果的统计分析</h2>
<p>在论文 <em>Statistical Analysis of ABX Results Using Signal Detection Theory</em> 中，作者提到：虽然 ABX 测试作为一种简单、直观的评估音频之间是否存在可感知的差异的测试方法已经存在了几十年，但是在目前的 ABX 测试中，评估者却很少披露评估结果的统计分析结果，这导致 ABX 测试的结论缺乏相应的置信度和可解释性<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>]。</p>
<p>因此，在 ABX 测试中，除了一般的聚合指标外，还需要对评估结果进行统计推断，以获得更可信的评估结果。例如 <a href="https://abxtests.com/">ABXTEST.COM</a> 提供的 ABX 测试中，就会包含 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值计算结果<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。</p>
<p>如前所述，ABX 测试中的打分结果如下表所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">样本 X 来源</th>
<th style="text-align:center">受试者选择 A</th>
<th style="text-align:center">受试者选择 B</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">A</td>
<td style="text-align:center">正确</td>
<td style="text-align:center">错误</td>
</tr>
<tr>
<td style="text-align:center">B</td>
<td style="text-align:center">错误</td>
<td style="text-align:center">正确</td>
</tr>
</tbody>
</table>
<p>因此，ABX 测试的结果本质上是一个伯努利分布：要么打分正确，要么打分错误。其结果的概率密度函数（<em>PMF: probability mass function</em>）如下所示：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo stretchy="false">)</mo><mo>=</mo><msubsup><mi>C</mi><mi>n</mi><mi>k</mi></msubsup><msup><mi>p</mi><mi>k</mi></msup><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><msup><mo stretchy="false">)</mo><mrow><mi>n</mi><mo>−</mo><mi>k</mi></mrow></msup></mrow><annotation encoding="application/x-tex">f(k) = C_{n}^{k}p^{k}(1-p)^{n-k}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999998em;"><span style="top:-2.4530000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.149108em;vertical-align:-0.25em;"></span><span class="mord mathdefault">p</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.03148em;">k</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span> 表示实验次数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span></span></span></span> 表示正确次数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 表示每次实验正确的概率。</p>
<h3 id="abx-的置信区间">ABX 的置信区间</h3>
<p>如果某次 ABX 测试包含 10 个测试样本，某个受试者打分正确的样本个数为 8，那么能说明 A 与 B 之间存在可感知的差异吗？一个用户可以以 80%（8/10）的正确率来识别出样本 X 的来源，这么高的正确率难道还不足以证明 A 与 B 之间存在可感知的差异吗？</p>
<p>我们可以用如下的代码计算 10 次实验所对应的伯努利的概率分布图：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt </span><br><span class="line"><span class="keyword">import</span> scipy.stats</span><br><span class="line"></span><br><span class="line">X = []</span><br><span class="line">Y = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    Y.append(stats.binom.pmf(i, <span class="number">10</span>, <span class="number">0.5</span>))</span><br><span class="line">    X.append(i)</span><br><span class="line">plt.bar(X, Y)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/04/ABX-test-in-the-Audio-Quality-Assessment/10_binom_p_d.png" alt="图1 概率分布"></p>
<p>从 图1 中可以看出，如果假设（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">H_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）受试者是按照完全随机的情况来打分，那么出现 8 次打分正确的概率就是 0.044（4.4%），这看起来确实是一个比较小的概率。换句话说，如果出现了 8 次正确的打分的情况，那么该结果是受试者按照完全随机的情况来打分的概率是 4.4%，这个概率比出现 7 次正确打分的概率（11.7%）要更置信。</p>
<p>那么对于不同实验次数的情况，我们是否要求 80% 的打分正确率才能拒绝 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">H_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 呢？</p>
<p>我们可以使用如下的代码获取在置信度为 95% 的情况下，不同的实验次数至少需要出现多少次正确的打分才能拒绝 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">H_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scipy.stats </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>, <span class="number">26</span>):</span><br><span class="line">    p_value = stats.binom.interval(<span class="number">0.95</span>, i, <span class="number">0.5</span>)</span><br><span class="line">    <span class="built_in">print</span>(i, p_value[<span class="number">1</span>], p_value[<span class="number">1</span>] * <span class="number">1.0</span> / i)</span><br></pre></td></tr></table></figure>
<p>具体结果如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">实验次数</th>
<th style="text-align:center">10</th>
<th style="text-align:center">20</th>
<th style="text-align:center">40</th>
<th style="text-align:center">80</th>
<th style="text-align:center">160</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">最小正确次数</td>
<td style="text-align:center">8</td>
<td style="text-align:center">14</td>
<td style="text-align:center">26</td>
<td style="text-align:center">49</td>
<td style="text-align:center">92</td>
</tr>
<tr>
<td style="text-align:center">最小正确率</td>
<td style="text-align:center">80%</td>
<td style="text-align:center">70%</td>
<td style="text-align:center">65%</td>
<td style="text-align:center">61.25%</td>
<td style="text-align:center">57.5%</td>
</tr>
</tbody>
</table>
<p>可见，当实验次数为 40 的时候，我们只需要 65% 的打分正确率就可以达到 95% 的置信度。</p>
<h3 id="abx-的累积概率分布">ABX 的累积概率分布</h3>
<p>然后，我们可以利用如下的代码计算 10 次实验对应的伯努利的累积概率分布（<em>CDF: cumulative distribution function</em>）和逆累积概率分布（<em>ICDF: inverse cumulative distribution function</em>）：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scipy.stats</span><br><span class="line"></span><br><span class="line">X = []</span><br><span class="line">PMF = []</span><br><span class="line">CDF = [] </span><br><span class="line">ICDF = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    PMF.append(scipy.stats.binom.pmf(i, <span class="number">10</span>, <span class="number">0.5</span>))</span><br><span class="line">    CDF.append(scipy.stats.binom.cdf(i, <span class="number">10</span>, <span class="number">0.5</span>))</span><br><span class="line">    X.append(i)</span><br><span class="line"></span><br><span class="line">ICDF.append(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    ICDF.append(<span class="number">1</span> - CDF[i])</span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/04/ABX-test-in-the-Audio-Quality-Assessment/CDF_ICDF.jpg" alt="图2 累积概率分布和逆累积概率分布"></p>
<p>从 图2 中可以看出，当实验次数为 10 次时，至少有 8 次打分正确的概率为 5.5%，也就是说，如果受试者在随机打分的情况下，其至少有 8 次打分正确的概率是 5.5%，而当正确打分次数提升至 9 次时，其概率则降低为 1.1%。</p>
<h3 id="abx-的-p-值">ABX 的 p 值</h3>
<p>我们可以对观察到的打分结果样本计算其 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值，从而来判断是否存在足够的观测正确来允许我们拒绝 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">H_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</p>
<p>根据 <em>Improving Your Statistical Inferences</em> 中的 第一章中对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值的介绍<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>：</p>
<blockquote>
<p>在区分信号和噪点时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值是作为防止被随机因素诱导的第一道防线。</p>
<p>并且有迹象表明，禁止使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值将会使得研究者更容易做出错误结论。</p>
<p>研究者提出差异性说明时，如果假设检验方法使用得当，是可以有效控制研究者自欺欺人的。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> scipy.stats</span><br><span class="line"></span><br><span class="line">k = []</span><br><span class="line">p = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    p_value = scipy.stats.binomtest(i, <span class="number">10</span>, <span class="number">0.5</span>)</span><br><span class="line">    k.append(i)</span><br><span class="line">    p.append(p_value.pvalue)</span><br><span class="line"></span><br><span class="line">plt.bar(k, p)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="/2024/04/04/ABX-test-in-the-Audio-Quality-Assessment/p_value.png" alt="图3 对于 10 次实验，不同成功次数对应的 p 值"></p>
<p>从 图3 中可以看出，当实验次数为 10 次时，如果有 8 次打分正确时，其 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值是 10.9%，而有 9 次正确打分时，其 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值为 2.1%。如果我们取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>=</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">\alpha = 0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span></span></span></span>，则当正确打分次数为 9 次时，我们认为此时存在足够的证据拒绝 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">H_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，即认为 A 与 B 之间存在可感知的差异。 当然，从概率的角度来说，即便是 9 次打分正确也是存在受试者随机打分的可能性，只是我们说这种可能性比较小而已。</p>
<p>因此，在 ABX 测试报告中，除了聚类类统计信息外，我们还需要披露更多的统计推断的指标，例如 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span></span></span></span> 值，置信区间等，以便让结果更具备可解释性。</p>
<h2 id="abx-测试需要关注的事项">ABX 测试需要关注的事项</h2>
<h3 id="样本大小需要控制">样本大小需要控制</h3>
<p>根据 QSC 的建议：在进行 ABX 测试时，样本的大小一般可以为 10~25 个，因为过多的样本会导致受试者可能会出现疲劳，这会降低测试的敏感性。<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup></p>
<blockquote>
<p>The very minimum number of trials you should do in a session is ten.</p>
<p>It’s not a good idea to try more than 25 trials in the same sitting with the same listener. After a while, listener fatigue sets in and it gets harder for him or her to concentrate and judge the sound quality.</p>
</blockquote>
<h3 id="abx-无法得出无差异的结论">ABX 无法得出无差异的结论</h3>
<p>在 <em>Improving Your Statistical Inferences</em> 的第一章中提到，基于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值推论的结果是以已知的最大误差率为基础，因此 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值永远不允许我们肯定地陈述任何事情。即便概率再低，也有被随机因素诱导的可能<sup class="footnote-ref"><a href="#fn4" id="fnref4:1">[4:1]</a></sup>。</p>
<blockquote>
<p>Because claims are made using a methodological procedure with known maximum error rates, <strong>a p-value never allows you to state anything with certainty</strong>.</p>
<p>Even if we set the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span></span></span></span> level to 0.000001, any single claim can be an error, Fisher (<a href="http://tankona.free.fr/fisher1935.pdf">1935</a>) reminds us, ‘for the “one chance in a million” will undoubtedly occur, with no less and no more than its appropriate frequency, however surprised we may be that it should occur to us”.</p>
</blockquote>
<p>ABX 只能证明 A 和 B 之间存在差异；我们不能根据 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值不足以证明 A 和 B 之间存在差异，就得出 A和 B 之间是无差异的这种论述<sup class="footnote-ref"><a href="#fn2" id="fnref2:1">[2:1]</a></sup>。</p>
<blockquote>
<p>For example, ABX can only tell you if there is a perceptible difference between two sounds.</p>
<p>It cannot tell you that there is no difference between the sounds.</p>
<p>Do not conclude there is no difference. ABX can only prove differences in audio files, not prove that there is no difference.</p>
</blockquote>
<h3 id="x-必须符合均匀分布">X 必须符合均匀分布</h3>
<p>在 ABX 测试中，我们总是希望 X 的来源是随机的，这样才能从样本上保证 A 和 B 之间是无偏差的。还是以 10 样本的实验为例，如果 X 信号的来源分布如下所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">X 样本数</th>
<th style="text-align:center">来自 A</th>
<th style="text-align:center">来自 B</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">9</td>
<td style="text-align:center">1</td>
</tr>
</tbody>
</table>
<p>在这种情况下，假定来在 A 的 9 个样本用户打分全部正确，但是来自 B 的 1 个样本用户打分错误，如果我们假设此时用户还是会随机给每个样本打分（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">H_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.08125em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>），那么会出现什么情况？</p>
<table>
<thead>
<tr>
<th style="text-align:center">指标</th>
<th style="text-align:center">结果</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">实验次数</td>
<td style="text-align:center">10</td>
</tr>
<tr>
<td style="text-align:center">正确次数</td>
<td style="text-align:center">9</td>
</tr>
<tr>
<td style="text-align:center">正确百分比</td>
<td style="text-align:center">90%</td>
</tr>
<tr>
<td style="text-align:center"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值</td>
<td style="text-align:center">0.02</td>
</tr>
<tr>
<td style="text-align:center">置信水平</td>
<td style="text-align:center">95%</td>
</tr>
<tr>
<td style="text-align:center">出现概率</td>
<td style="text-align:center">0.0098</td>
</tr>
</tbody>
</table>
<p>在如上的结果下，我们能得出 A 和 B 之间存在差异的结论吗？看起来这个结论是不合理的。为了避免样本的分布偏差对结果的影响，我们在组织 ABX 测试时，必须保证 X 的来源是随机抽取的，是符合均匀分布的。</p>
<h3 id="完整披露全部统计数据">完整披露全部统计数据</h3>
<p>对于 ABX 的统计推断分析而言，重要的是要证明结果是公正的（总体结果和每个受试者的结果）。对于任何 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>&lt;</mo><mn>0.05</mn></mrow><annotation encoding="application/x-tex">p&lt;0.05</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335400000000001em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">5</span></span></span></span> 的显著结果，必须报告实验的：</p>
<ul>
<li><strong>样本均衡性</strong></li>
<li><strong>试验总次数</strong></li>
<li><strong>正确次数</strong></li>
<li><strong>正确百分比</strong></li>
<li><strong>随机变量出现的概率</strong></li>
<li><strong>置信水平</strong></li>
<li><strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">p</span></span></span></span> 值</strong></li>
</ul>
<p>统计学上的显著结果只能表明，受试者只是在猜测的概率很小。但是，我们必须时刻提醒自己，即便概率再小也完全有可能在随机猜测下获得统计学上的显著结果。因此，在 ABX 测试中，如果结果达到 95% 的置信水平，我们可以说听众只是随机猜测的可能性只有 5%。此时，我们会很有把握地声称 A 和 B 之间可能存在可感知的差异，仅此而已。</p>
<h2 id="度知了中的-abx-测试">度知了中的 ABX 测试</h2>
<p>为了让用户更方便的进行 ABX 测试，我们把如上提到的、ABX 需要关注的各种因素统一集成到了度知了中。当前，度知了 iOS 最新版本（v2.2.0）已经提供了 ABX 测试的功能，Android 版本我们也在快马加鞭的开发中，希望能够尽快与大家见面。</p>
<p><img src="/2024/04/04/ABX-test-in-the-Audio-Quality-Assessment/abx_ios.jpeg" alt="ABX 测试"></p>
<p>当然，在我们的最新版本中，除了 ABX 测试，我们还提供了 <a href="https://www.itu.int/rec/R-REC-BS.1534">MUSHRA</a>、<a href="https://www.itu.int/rec/T-REC-P.800-199608-I">CCR</a>、<a href="https://www.itu.int/rec/R-REC-BS.1116">DCR</a>、<a href="https://www.itu.int/rec/R-REC-BT.500">ACR</a>等多种评测方法，以满足不同用户、多场景下的音频质量评估需求。</p>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://pubs.aip.org/asa/jasa/article/22/5_Supplement/675/625412/Standardizing-Auditory-Tests">Standardizing Auditory Tests</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://www.researchgate.net/publication/267193579_Statistical_Analysis_of_ABX_Results_Using_Signal_Detection_Theory">Statistical Analysis of ABX Results Using Signal Detection Theory</a> <a href="#fnref2" class="footnote-backref">↩︎</a> <a href="#fnref2:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://abxtests.com/">abxtests.com/</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://lakens.github.io/statistical_inferences/01-pvalue.html">Using p-values to test a hypothesis</a> <a href="#fnref4" class="footnote-backref">↩︎</a> <a href="#fnref4:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://www.manualslib.com/manual/513767/Qsc-Abx-Comparator.html">QSC ABX Comparator User Manual</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>音频技术</category>
      </categories>
      <tags>
        <tag>音频质量评估</tag>
        <tag>ABX</tag>
      </tags>
  </entry>
  <entry>
    <title>如何计算多组 ACR 打分的 ELO 积分</title>
    <url>/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/</url>
    <content><![CDATA[<p><img src="/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/1.jpeg" alt></p>
<p>在 <a href="/2023/08/12/the-interesting-elo-rating-system/">有趣的 Elo 积分系统</a> 这篇文章中，我们介绍了 Elo 积分系统的基本原理，并介绍了我们如何在视频评估系统中采用 Elo 积分来评估不同编解码器之间的性能。不过，之前文章中介绍的是对于 <em><strong>成对打分</strong></em> 场景下应用  Elo 积分，在本文中，我们将介绍在 <em><strong>ACR 打分场景</strong></em> 下如何采用 Elo 积分评估不同方案的性能。</p>
<span id="more"></span>
<h2 id="背景">背景</h2>
<p>我们最近需要评估不同版本的 TTS 的表现效果，由于我们的评估系统 <a href="/2023/02/13/duzhiliao/">度知了</a> 还不支持对纯音频的评估，因此我们需要把音频转换为视频，然后利用视频的评估方案对音频进行评估。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ffmpeg -f lavfi -i color=s=1920x1080:r=15:c=<span class="string">&#x27;0x000000&#x27;</span>:d=5 \</span><br><span class="line">-i INPUT.mp3 \</span><br><span class="line">-map <span class="string">&quot;0:v&quot;</span> -map <span class="string">&quot;1:a&quot;</span> -acodec copy OUTPUT.mp4</span><br></pre></td></tr></table></figure>
<p>在 <em>度知了</em> 中，采用 <em>成对评估法</em> 对视频进行打分时没有开放切换视频语音的能力（在视频评估中，我们认为音频效果并非核心关注点），因此我们需要采用接下来要介绍的 <em>ACR 打分法</em> 对音频进行打分。</p>
<p>于是，也就有了本文提到的问题：如何计算多组 ACR 打分的 Elo 积分？</p>
<h2 id="什么是-acr-打分？">什么是 ACR 打分？</h2>
<p><a href="https://wangwei1237.github.io/digital_video_concepts/docs/4_2_1_SubjectiveVideoQualityEvaluation.html">ACR（绝对等级评分）打分</a> 是音、视频主观质量评估标准中的一种评估方法。在 ACR 的打分过程中，会逐个呈现测试序列中的每一个待评估样本，并针对每一个样本在质量等级量表内对其进行独立打分。ACR 也称之为单刺激方法，其中受试者观看、听取一个刺激（例如，视频剪辑、音频剪辑），然后对其进行独立评级。</p>
<p>在 我们的评估系统中，采用标准的 ACR 打分量级表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">分数</th>
<th style="text-align:center">等级</th>
<th style="text-align:center">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">Excellent</td>
<td style="text-align:center">优秀</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">Good</td>
<td style="text-align:center">良好</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">Fair</td>
<td style="text-align:center">普通</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">Poor</td>
<td style="text-align:center">较差</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">Bad</td>
<td style="text-align:center">差</td>
</tr>
</tbody>
</table>
<p>针对每一个样本，我们会让至少 10 名用户按照如上的量级表进行打分，然后根据用户的打分（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span> 个用户对第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span></span></span> 个样本的打分）得到每个样本的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">MOS_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 分（平均主观得分），最后我们会将 5 分制的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">MOS</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> 分转换为 100 分制的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">MOS</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> 分作为该样本的最终 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">MOS</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> 分。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mi>j</mi></msub><mo>=</mo><mo fence="false">(</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>S</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mo>−</mo><mn>1</mn><mo fence="false">)</mo><mo>×</mo><mn>25</mn></mrow><annotation encoding="application/x-tex">MOS_j = \big(\frac{1}{N} \sum_{i=1}^{N} S_{i,j} - 1 \big) \times 25
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.106005em;vertical-align:-1.277669em;"></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mord">1</span><span class="mord"><span class="delimsizing size1">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span></span></span></span></span></p>
<h2 id="acr-的评估方案">ACR 的评估方案</h2>
<p>我们有两个不同版本的 TTS 模型，我们抽取了 100 个文本样本利用不同的模型分别生成了对应的音频样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><msub><mi>e</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">sample_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><msub><mi>e</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">sample_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，然后我们采用洗牌算法对两个样本进行打乱，然后招募用户对这些样本进行音频效果的 ACR 打分。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mo>=</mo><mi>s</mi><mi>h</mi><mi>u</mi><mi>f</mi><mi>f</mi><mi>l</mi><mi>e</mi><mo fence="false">(</mo><mo stretchy="false">{</mo><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><msub><mi>e</mi><mi>A</mi></msub><mo separator="true">,</mo><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><msub><mi>e</mi><mi>B</mi></msub><mo stretchy="false">}</mo><mo fence="false">)</mo></mrow><annotation encoding="application/x-tex">sample = shuffle\big(\{sample_A, sample_B\}\big)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">h</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mopen">{</span><span class="mord mathdefault">s</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">a</span><span class="mord mathdefault">m</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">}</span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></span></p>
<p>用户打分完毕之后，我们会得到混合之后的样本的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">MOS</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> 得分（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mrow><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi></mrow></msub></mrow><annotation encoding="application/x-tex">MOS_{sample}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">m</span><span class="mord mathdefault mtight">p</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>），然后我们根据生成样本的 TTS 的模型的不同得到 A、B 两组 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">MOS</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> 打分：<a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/code/mosA"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">MOS_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></a>，<a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/code/mosB"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">MOS_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></a>。</p>
<h2 id="根据-acr-计算-elo-积分">根据 ACR 计算 Elo 积分</h2>
<p>因为 ELo 本身具备<strong>收敛过程</strong>和<strong>比赛顺序相关</strong>等特点，因此我们采用了 <a href="https://online.stat.psu.edu/stat500/lesson/11/11.2/11.2.1">Bootstrap Sampling</a> 方法来计算 Elo 积分。</p>
<p>为了保证样本的随机型，在每一次重抽样的过程中，我们会首先从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">MOS_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">MOS_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 中随机抽取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span> 个样本，然后取其平均值作为该次对抗的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">MOS</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span></span></span></span> 分来计算 Elo 积分。</p>
<ul>
<li>STEP 1：从 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">MOS_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mi>B</mi></msub></mrow><annotation encoding="application/x-tex">MOS_B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 中随机抽取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span> 个样本得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><msup><mi>A</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">MOS_{A&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828285714285715em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><msup><mi>B</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">MOS_{B&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828285714285715em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>STEP 2：计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><msup><mi>A</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">MOS_{A&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">A</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828285714285715em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><msup><mi>B</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">MOS_{B&#x27;}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828285714285715em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的平均值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">MOS_{A,i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mrow><mi>B</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">MOS_{B,i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>STEP 3：利用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">MOS_{A,i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>O</mi><msub><mi>S</mi><mrow><mi>B</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">MOS_{B,i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328331em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span> 计算 Elo 积分</li>
<li>STEP 4：重复如上步骤 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> 次，得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> 轮的 Elo 积分</li>
<li>STEP 5：计算 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> 组 Elo 积分的平均值作为最终 Elo 积分</li>
</ul>
<p>具体的代码如下所示：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">eloA = []</span><br><span class="line">eloB = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(num_round), desc=<span class="string">&quot;bootstrap&quot;</span>):</span><br><span class="line">    A = random.sample(mosA, batch_size)</span><br><span class="line">    B = random.sample(mosB, batch_size)</span><br><span class="line">    meanA = <span class="built_in">int</span>(np.mean(A))</span><br><span class="line">    meanB = <span class="built_in">int</span>(np.mean(B))</span><br><span class="line">    ratingA, ratingB = func_compute_elo(meanA, meanB, ratingA, ratingB)</span><br><span class="line">    eloA.append(ratingA)</span><br><span class="line">    eloB.append(ratingB)</span><br><span class="line"></span><br><span class="line">eloA = np.mean(eloA)</span><br><span class="line">eloB = np.mean(eloB)</span><br></pre></td></tr></table></figure>
<p>完整的代码实现可以参考：</p>
<ul>
<li><a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/code/elo.py">elo.py</a></li>
<li><a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/code/utils.py">utils.py</a></li>
<li><a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/code/elo_test_acr.py">elo_test_acr.py</a></li>
</ul>
<p>根据我们的实验，当 bootstrap sampling 的轮数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> 设置为 5000 时，Elo 的积分会趋于收敛和稳定。</p>
<p>例如对于相同打分的两组打分，抽样 5000 次的结果如下图所示：</p>
<p><img src="/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/bootstrap_5000.png" alt="抽样 5000 次"></p>
<p>而抽样 1000 次的结果如下图所示：</p>
<p><img src="/2024/03/13/How-to-calculate-the-ELO-ratings-for-multiple-sets-of-ACR-scores/bootstrap_1000.png" alt="抽样 1000 次"></p>
<p>对于同样打分的两组样本而言，其最终的 Elo 积分应该是趋于一致的，从如上的结果对比也可以看出，当抽样 5000 次时，Elo 积分趋向于一致，也更为置信。</p>
]]></content>
      <categories>
        <category>算法与数学</category>
      </categories>
      <tags>
        <tag>ACR</tag>
        <tag>Elo rating</tag>
      </tags>
  </entry>
  <entry>
    <title>Sora——AGI 漫漫长夜中的星光</title>
    <url>/2024/02/22/Sora-the-starlight-in-the-long-night-of-AGI/</url>
    <content><![CDATA[<p><img src="/2024/02/22/Sora-the-starlight-in-the-long-night-of-AGI/1.jpg" alt></p>
<blockquote>
<p>Prompt: 一位时尚的女士漫步在东京的街道，街道上充满了温暖的霓虹灯和生动的城市标志。她穿着黑色皮夹克、红色长裙和黑色靴子，手里拿着一个黑色钱包。她戴着太阳镜，涂着红色的口红。她走路自信而随意。街道潮湿且反光，形成了彩色灯光的镜面效果。街道上，许多行人走来走去。</p>
</blockquote>
<p>2024 年，2 月 16 日，农历的大年初七，当我们还沉浸在春节假期的团聚与欢乐时，大洋彼岸的 OpenAI 突然发布了轰动科技街的最新研究成果——Sora。利用如上的 <code>提示词</code>，Sora 可以生成较高画质的、非常逼真的、长达一分钟的视频。就像当时 ChatGPT 发布一样，Sora 的发布又一次引爆了技术大讨论。正如 Sora 的开发者 Bill Peebles 所说的那样：Sora 令他们非常兴奋，他们可以通过模拟一切来不断地追求 AGI。<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<blockquote>
<p>we’re pumped about pursuing AGI by simulating everything!</p>
</blockquote>
<span id="more"></span>
<h2 id="sora-的流行趋势">Sora 的流行趋势</h2>
<ul>
<li>自从 Bill Peebles 在 Twitter 上发布 Sora 生成的视频以来，该帖子已经超过 19W 的浏览量。</li>
<li>如果在各大平台搜索 Sora，我们也会发现相关的文章、视频如雨后春笋般在暴增。</li>
<li>在 Sora 发布的 4 天内，中信建投、国泰君安、申万宏源、招商证券等 10 家券商在研报中均表示，Sora 是人工智能发展进程中的里程碑，预示 AGI（人工通用智能）将加速到来，众多行业将迎来颠覆式变革<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>。</li>
<li>2 月 19 日，央视财经频道的《天下财经》栏目也对 Sora 的爆火进行了报道<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。</li>
<li>对 Sora 的讨论依然在持续火热中……</li>
</ul>
<p>通过谷歌趋势我们发现，在 Sora 刚发布的 1 个小时以内，Sora 的搜索热度就开始突增。对于国内的热度曲线，我们会发现一个比较有趣的地方：即便在凌晨，即便此时的搜索热度在下降，但是搜索的热度依然没有下降至 0。即便在夜深人静的时刻，仍然有很多人在跟踪新的事物，这也从侧面反映出 Sora 的发布所带来的影响。</p>
<p><img src="/2024/02/22/Sora-the-starlight-in-the-long-night-of-AGI/sora_google_trend.png" alt="Sora 的谷歌搜索热度趋势"></p>
<p>从分城市的热度趋势能看到，中国、印度、美国、欧洲区的相关城市的搜索热度相对较高，并且北京、杭州、深圳的热度进到了热度城市的 TOP5，足见国内对 Sora 的关注度。</p>
<p><img src="/2024/02/22/Sora-the-starlight-in-the-long-night-of-AGI/sora_hot_city.png" alt="Sora 的分城市搜索热度趋势"></p>
<p>根据热搜引擎提供的微博热搜历史数据，在 Sora 发布的当天早上 9 点的时候，在大洋彼岸已经沸腾了 6 个小时之后，Sora 也初次登上了微博热搜榜，并且之后的几天里一直在榜。</p>
<p><img src="/2024/02/22/Sora-the-starlight-in-the-long-night-of-AGI/Sora_weibo_hot_search.png" alt="Sora 登上微博热搜榜"></p>
<p>受到 Sora 发布的影响，Adobe 股价 2 月 16 日暴跌 7% 以上，创 2023 年 11 月 1 日以来的新低，市值在短短一个交易日内就蒸发了近 198 亿美元。</p>
<p><img src="/2024/02/22/Sora-the-starlight-in-the-long-night-of-AGI/adobe_stock.png" alt="Abode 股价趋势"></p>
<h2 id="sora-的能力">Sora 的能力</h2>
<p>目前网络上已经有很多人从产品、技术等不同的层面对 Sora 进行了详细的分析，这些内容可以很方便的从网络中获取。即便如此，也建议大家认真阅读 OpenAI 官方发布的 Sora 介绍（Creating video from text<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>）和 Sora 的技术文档（Video generation models as world simulators<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>）。</p>
<p>OpenAI 官方发布的 <a href="https://openai.com/sora">Sora 介绍页面</a> 描述了 Sora 可以提供的能力及其当前存在的问题，同时还提供了 48 个 由 Sora 生成的视频。</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=1950695804&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<h3 id="更高的时长">更高的时长</h3>
<p>Sora 可以生成长达 1 分钟的视频，而传统的文生视频模型生成的视频的平均长度则只有 4 秒，从时间上看，Sora 已经是一个非常大的突破。同时，在长达 1 分钟的视频中，Sora 还能持续维持视频画质并遵循用户提示词中给出的指令，这一点也让人惊叹。目前的短视频时长大概也就在 10S ~ 1 Min 左右的样子，而微短剧的时长也就在 2Min ~ 5 Min，因此，从视频时长和指令遵循这两点看，Sora 对整个视频行业带来了非常有想象力的空间。</p>
<h3 id="更好的物理规律模拟能力">更好的物理规律模拟能力</h3>
<p>Sora 能够生成复杂场景的视频，这些复杂场景可以具有多个角色、特定类型的运动、具备精确细节的主体和背景。Sora 不仅了解用户在提示词中的要求，还了解这些实体在物理世界中是如何存在的——他们之间的关系是怎样的、他们会如何互动、他们之间的互动会产生怎样的反馈……</p>
<h3 id="更多的镜头表现能力">更多的镜头表现能力</h3>
<p>Sora 对自然语言有着深刻的理解，这使其可以准确地解释用户输入的提示词，并生可以表达丰富情感的、逼真的角色。在一次生成的这个视频中，Sora 可以创建多个镜头，并可以在不同的镜头中保持角色和视觉风格的一致。视频是由镜头构成的，镜头是视频展现其背后人文特性的基本语言。电影《疯狂的赛车》共有 2400 个镜头，平均镜头时长为 2.5S，《让子弹飞》共有 4000 个镜头，其平均镜头时长为 1.92 S。从平均镜头时长看，Sora 生成的视频中可以包含多达 30 个镜头，这足以让生成的视频具备更丰富的表现能力。</p>
<video poster="/2024/02/22/Sora-the-starlight-in-the-long-night-of-AGI/1.jpg" autoplay="autoplay" id="videojs1" class="video-js vjs-16-9" controls preload="auto"><source src="https://cdn.openai.com/sora/videos/tokyo-walk.mp4" type="video/mp4"></video><link href="/libs/videojs2/videojs.css" rel="stylesheet"><script src="/libs/videojs2/video.min.js"></script><script src="/libs/videojs2/zh-CN.min.js"></script><script src="/libs/videojs2/videojs.hotkeys.min.js"></script><script>player1=videojs("videojs1",{language:"zh-CN",responsive:true,plugins:{hotkeys:{alwaysCaptureHotkeys:true},},});</script><link rel="stylesheet" href="/libs/videojs2/mytoast.css"><script src="/libs/videojs2/mytoast.js"></script><script>toast_init(player1)</script><link rel="stylesheet" href="/libs/videojs2/videojs-mobile-ui.css"><script src="/libs/videojs2/videojs-mobile-ui.min.js"></script><script>player1.mobileUi();</script><script src="/libs/videojs2/videojs-remember.min.js"></script><script>videojs(document.querySelector("video")).remember({"localStorageKey": "videojs.remember.myvideo"});</script>
<p>如上的视频将 Sora 的优势体现的淋漓尽致，当我第一次见到这个视频的时候，我也被视频的逼真程度惊掉了下巴。</p>
<ul>
<li>对光影的模拟，对主角和背景人物的处理都表现的非常逼真。</li>
<li>对采用“跟”镜头的方式来拍摄主角的镜头运动方式和轨迹也非常真实。</li>
<li>当路边的广告牌跟随者镜头的运动逐渐出现，并从近景慢慢变为远景的时候，广告牌上的字体也慢慢变得模糊，并且在这个过程中视频丝毫没有出现跳跃。</li>
<li>在视频的第 36S 处，视频从全景镜头丝滑切换到了特写镜头，墨镜的反光效果、脸部皮肤、头发的效果、主角的表情更是相当逼真。</li>
</ul>
<p>我们之所以感觉到 Sora 生成的视频如此的逼真，是因为 Sora 不仅仅是在操作像素、图形，而是在慢慢的学习物理世界的规律。就像 ChatGTP 通过大量的数据来理解人类语言体系一样，Sora 正在通过大量的视觉数据来理解物理世界的法则——视觉数据中的信息是对真实物理世界的映射，这才是 Sora 最令人惊奇的地方。</p>
<p>Sora 可以理解画面，理解画面上的角色和实体，并理解实体之间的相互关系和物理规律。ChatGPT 通过理解人类语言实现了 AI 和人的互动，Sora 通过理解物理世界则可能会实现 AI 和世界的互动，这是既 ChatGPT 以来， AGI 道路上的又一座里程碑。</p>
<p>正如 OpenAI 在 Sora 技术报告中所说的那样<sup class="footnote-ref"><a href="#fn5" id="fnref5:1">[5:1]</a></sup>：</p>
<blockquote>
<p>Our results suggest that scaling video generation models is a promising path towards building general purpose simulators of the physical world.</p>
</blockquote>
<p>也正如 OpenAI 在其使命和愿景中所说的那样<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>：</p>
<blockquote>
<p>Our mission is to ensure that artificial general intelligence—AI systems that are generally smarter than humans—benefits all of humanity.</p>
</blockquote>
<h2 id="sora-的不足">Sora 的不足</h2>
<p>从目前 Sora 生成的视频来看，即便 Sora 已经令我们相当兴奋，但是也依然存在很多不足。所有的这些不足，OpenAI 在其官方介绍页面也都给了对应的生成视频，并且给出了对应视频中存在的问题。</p>
<ul>
<li>对于某些复杂的场景，Sora 很难准确模拟这些复杂场景的物理特性，也可能无法理解这些场景中存在的对象之间的因果关系。例如：
<ul>
<li>一个人咬了一口饼干，但是饼干可能没有咬痕</li>
<li>一个人在吹生日蛋糕上的蜡烛，但是蜡烛的火焰却没有熄灭</li>
</ul>
</li>
<li>Sora 还可能会混淆用户提示词中的空间细节（混淆左右）。</li>
</ul>
<video poster="/2024/02/22/Sora-the-starlight-in-the-long-night-of-AGI/2.jpg" autoplay="autoplay" id="videojs2" class="video-js vjs-16-9" controls preload="auto"><source src="https://cdn.openai.com/sora/videos/grandma-birthday.mp4" type="video/mp4"></video><link href="/libs/videojs2/videojs.css" rel="stylesheet"><script src="/libs/videojs2/video.min.js"></script><script src="/libs/videojs2/zh-CN.min.js"></script><script src="/libs/videojs2/videojs.hotkeys.min.js"></script><script>player2=videojs("videojs2",{language:"zh-CN",responsive:true,plugins:{hotkeys:{alwaysCaptureHotkeys:true},},});</script><link rel="stylesheet" href="/libs/videojs2/mytoast.css"><script src="/libs/videojs2/mytoast.js"></script><script>toast_init(player2)</script><link rel="stylesheet" href="/libs/videojs2/videojs-mobile-ui.css"><script src="/libs/videojs2/videojs-mobile-ui.min.js"></script><script>player2.mobileUi();</script><script src="/libs/videojs2/videojs-remember.min.js"></script><script>videojs(document.querySelector("video")).remember({"localStorageKey": "videojs.remember.myvideo"});</script>
<h2 id="sora-的相关技术">Sora 的相关技术</h2>
<p>在 Sora 的技术文档 <a href="https://openai.com/research/video-generation-models-as-world-simulators">Video generation models as world simulators</a> 中，OpenAI 介绍了 Sora 模型的能力和用到的相关技术，但是对于 Sora 模型的具体技术细节并没有进行过多的披露。</p>
<ul>
<li>把 Visual Patches 作为 Visual Tokens，进而统一了文本、图像、视频的生成式模型架构。不过 Visual Tokens 并非是 OpenAI 的原创，而是借鉴了谷歌的 magvit<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup> <sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup> 的思路。</li>
<li>Diffusion Models，正如技术报告中所述：<em>Sora is a diffusion model, given input noisy patches (and conditioning information like text prompts), it’s trained to predict the original “clean” patches. <strong>Importantly, Sora is a diffusion transformer.</strong></em> 而这个技术最初是由 Bill 和 谢赛宁在论文 <a href="https://arxiv.org/abs/2212.09748">Scalable Diffusion Models with Transformers</a><sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup> 提出的。这也导致当 Sora 刚发布的的时候，网上有自媒体误传 Sora 的作者是 谢赛宁的乌龙事件，之后 谢赛宁也在 Twitter 上对此作了解释和回应。</li>
<li>Autoregressive Transformers，为了让 DiT 支持自回归 Diffusion，Sora 借鉴了谷歌在 <a href="https://arxiv.org/abs/2312.06662">Photorealistic Video Generation with Diffusion Models</a> 中提到的 W.A.L.T 方案。</li>
</ul>
<p>更多的技术解读可以参考红博士的 <a href="https://mp.weixin.qq.com/s/H8UYQ27nNPbW2jetseJgYQ">去魅 Sora: OpenAI 鲜肉小组的小试牛刀</a>，此处不再一一介绍。</p>
<p>微软研究院和理海大学的研究者根据已发表的技术报告和逆向工程，首次在论文 <em>Sora: A Review on Background, Technology, Limitations, and Opportunities of Large Vision Models</em> 中全面回顾了 Sora 的背景、相关技术、新兴应用、当前局限和未来机遇<sup class="footnote-ref"><a href="#fn10" id="fnref10">[10]</a></sup>。</p>
<h2 id="sora-的思考">Sora 的思考</h2>
<p>所以，整体上看 Sora 并没有发明新的技术，只是对原有技术的整合而已。但是这恰恰是我们该认真思考的最重要的点。都是原有的技术，这些技术论文也都是公开的，为什么在 Sora 之前，却没有出现如此惊艳的 TTV 效果呢？单纯的技术拼凑可以拼凑出类似 Sora 的突破性产品吗？同样是用乐高的零件，为什么有的大牛就能<a href="https://zhuanlan.zhihu.com/p/336748815">用 84000 片乐高拼成宏伟的紫禁城呢</a>，而有些人离开了图纸就什么也拼不出来呢？</p>
<h3 id="鉴定的践行能力">鉴定的践行能力</h3>
<p>我想，之所以是 OpenAI 首先发布了 Sora，这里面肯定是有某些特殊的原因的。在我看来 <strong>思维方式的多样性</strong> 以及其 <strong>坚定的践行能力</strong> 是非常重要的因素。</p>
<p>从 <em>A Survey on ChatGPT and Beyond</em><sup class="footnote-ref"><a href="#fn11" id="fnref11">[11]</a></sup> 中的大语言模型族谱中我们也能发现，GPT 在发展之初就没有采用当时自编码的主流方案，而是采用了很少有人涉足的自回归的分支，这对 OpenAI 的科研工作者而言，需要非常大的勇气和毅力。感谢 OpenAI 的大胆和魄力，我们才尽可能早的感受到了 AI 大模型的强大性能。</p>
<p><img src="https://wangwei1237.github.io/LLM_in_Action/images/LLMTree.jpeg" alt="大语言模型族谱"></p>
<p>而这样的大胆，并非是匹夫之勇，而是通过不断实践、实验来不断强化对技术方向的判断。在 <em>Scaling Laws for Neural Language Models</em><sup class="footnote-ref"><a href="#fn12" id="fnref12">[12]</a></sup> 中，他们提到：</p>
<blockquote>
<p>We study <strong>empirical scaling laws</strong> for language model performance on the cross-entropy loss. The loss scales as a power-law with model size, dataset size, and the amount of compute used for training, with some trends spanning more than seven orders of magnitude. Other architectural details such as network width or depth have minimal effects within a wide range.</p>
</blockquote>
<p>在 Sora 的技术文档中，我们又看到：</p>
<blockquote>
<p>We <strong>explore large-scale training of generative models on video data</strong>.</p>
</blockquote>
<p>从 GPT 的演进历程<sup class="footnote-ref"><a href="#fn13" id="fnref13">[13]</a></sup>我们也能感受到，从 2018 年～2022 年，在长达 5 年多的时间里，OpenAI 一步一步通过探索和实践，让大模型应该具备的相关能力一点一点的浮出水面，进入我们的视野。</p>
<p>实践是检验真理的唯一标准，想尽一切办法让实践边的可行：扩大数据规模，增强数据质量，扩大模型规模……</p>
<h3 id="强大的工程能力">强大的工程能力</h3>
<p>当不该发生的事情发生了，科学就需要登场了；当该发生的事情没有发生，工程就需要登场了。OpenAI 强大的技术整合能力和工程化能力是 Sora 可以成功的另一个因素。</p>
<p>虽然 Sora 用到的大部分的技术都是现成的技术，但是为了在工程上将其整合到一起从而实现 Sora 的效果，整个团队作了非常多的事情：</p>
<ul>
<li>整合 DiT<sup class="footnote-ref"><a href="#fn9" id="fnref9:1">[9:1]</a></sup> 和 W.A.L.T<sup class="footnote-ref"><a href="#fn7" id="fnref7:1">[7:1]</a></sup>。</li>
<li>在训练阶段，利用 GPT 给视频标注 Caption 数据，在推理阶段，利用 GPT 扩写用户输入的 Prompt，这使得 Sora 可以生成精准遵循用户指令的高质量的视频。</li>
<li>生产了足够规模、质量足够大的标注数据，做过标注的应该都可以理解到这里的难度究竟有多大。</li>
<li>提出了通用视觉数据模型，从而可以不再像之前的方法那样需要对不同的视觉数据进行特定的处理。</li>
<li>……</li>
</ul>
<p>我们的工程能力产出了多少像下图那样的系统？</p>
<p><img src="https://wangwei1237.github.io/2021/09/11/How-to-Read-and-Use-the-Open-Source-Projects/2.png" alt></p>
<p>在 GPT-4 的技术报告中<sup class="footnote-ref"><a href="#fn14" id="fnref14">[14]</a></sup>，OpenAI 提到他们可以做到：在小规模的计算成本下训练出来的模型，可以准确预估到在计算成本扩大之后，模型的性能将会怎样？这对于像 GPT4 这样训练一次就要耗费几周甚至上月的大模型而言，其效率提升真的是如虎添翼。</p>
<blockquote>
<p>A large focus of the GPT-4 project was building a deep learning stack that scales predictably. The primary reason is that for very large training runs like GPT-4, it is not feasible to do extensive model-specific tuning. To address this, we developed infrastructure and optimization methods that have very predictable behavior across multiple scales. These improvements allowed us to reliably predict some aspects of the performance of GPT-4 from smaller models trained using 1, 000× – 10, 000× less compute.</p>
</blockquote>
<p>所以我们讲，科学和技术决定了产品的上限，工程能力决定了产品的下限，科学和技术可以试错，但是工程能力务必讲究精益求精，唯有精益求精的工程能力才能产生足够惊艳的效果。</p>
<h2 id="后记">后记</h2>
<p>随着 Sora 的爆火，越来越多的公司也开始发布新的技术：</p>
<ul>
<li>2 月 22 日，Stability AI 发布了 <a href="https://stability.ai/news/stable-diffusion-3">Stable Diffusion 3</a>，从其官方展示的效果看，SD3 在文字拼写、色彩协调、图片逼真度等各个方面都表现惊人。</li>
</ul>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://twitter.com/billpeeb/status/1758194105111269697?s=20">Sora is here!</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://news.cctv.com/2024/02/20/ARTINzD0eOR0jQxxVZxibLQT240220.shtml">Sora 爆火 96 小时</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://www.toutiao.com/article/7337293210861388303/">新模型 Sora 爆火，OpenAI 估值不到 10 个月增加近两倍</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://openai.com/sora">Creating video from text</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://openai.com/research/video-generation-models-as-world-simulators">Video generation models as world simulators</a> <a href="#fnref5" class="footnote-backref">↩︎</a> <a href="#fnref5:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://openai.com/about">OpenAI Vision</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p><a href="https://github.com/google-research/magvit">google-research/magvit</a> <a href="#fnref7" class="footnote-backref">↩︎</a> <a href="#fnref7:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn8" class="footnote-item"><p><a href="https://arxiv.org/abs/2212.05199">MAGVIT: Masked Generative Video Transformer</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn9" class="footnote-item"><p><a href="https://arxiv.org/abs/2212.09748">Scalable Diffusion Models with Transformers</a> <a href="#fnref9" class="footnote-backref">↩︎</a> <a href="#fnref9:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn10" class="footnote-item"><p><a href="https://arxiv.org/abs/2402.17177">Sora: A Review on Background, Technology, Limitations, and Opportunities of Large Vision Models</a> <a href="#fnref10" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn11" class="footnote-item"><p><a href="https://arxiv.org/abs/2304.13712">Harnessing the Power of LLMs in Practice: A Survey on ChatGPT and Beyond</a> <a href="#fnref11" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn12" class="footnote-item"><p><a href="https://arxiv.org/abs/2001.08361">Scaling Laws for Neural Language Models</a> <a href="#fnref12" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn13" class="footnote-item"><p><a href="https://wangwei1237.github.io/LLM_in_Action/llm_intro.html">GPT 的贡献</a> <a href="#fnref13" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn14" class="footnote-item"><p><a href="https://arxiv.org/abs/2303.08774">GPT-4 Technical Report</a> <a href="#fnref14" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>TTV</tag>
        <tag>CG</tag>
        <tag>AGI</tag>
        <tag>文生视频</tag>
      </tags>
  </entry>
  <entry>
    <title>大话线上事故</title>
    <url>/2023/11/26/Drama-talk-about-online-accidents/</url>
    <content><![CDATA[<p><img src="/2023/11/26/Drama-talk-about-online-accidents/1_1.png" alt></p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">这就是微服务，这就是线上事故——17哥
</p><p>微服务架构虽然解决了单体架构下的部署、运维、扩展、效率等痛点问题，但是它让系统架构变得更加复杂。很多时候，微服务架构用的不好，就很容易形成分布式单体的效果，最终导致很多非预期的线上问题。</p>
<p>如上图所示，当我们兴冲冲的发现了一个线上 BUG，满怀激动的修复好，然后一脸骄傲的点下发布按钮之后，我们才深悟痛彻的理解了那句：“能跑就别动它”。</p>
<p>我的同事将自己工作中遇到的一些线上问题的案例进行了提炼、总结，然后形成了这篇文章——其中很多案例即有趣又痛心——希望对大家有所帮助。</p>
</div>
<span id="more"></span>
<p>说起线上事故，资深的 IT 从业人员也难免“谈虎色变”。对于一叶扁舟的小型初创公司，它像狂风暴雨，轻则使之风雨飘摇，对于泰坦尼克号类的大型公司，则可能是危险的冰山，重则致其折戟沉沙。</p>
<p>本文尝试通过浅显易懂的方式，从系统设计的角度对某些线上事故进行原因分析并总结其改进方案，愿“哀之鉴之，不使后人而复哀后人也”。</p>
<ul>
<li>事故一：西瓜和芝麻一起蚌埠住了–组件上线导致服务不可用x分钟</li>
<li>事故二：超时还是不超时，这是个问题–不合理的止损方案导致服务大量拒绝</li>
<li>事故三：删除一条数据，系统崩溃了–牵一发而动全身，不合理的系统架构</li>
</ul>
<h2 id="事故一-西瓜和芝麻一起宕机了">事故一 西瓜和芝麻一起宕机了</h2>
<p><code>故障描述</code>：不重要的芝麻组件发生配置变更，由于线上程序不兼容，导致其重启后挂掉，重要的西瓜组件由于采用同步阻塞方式调用了芝麻组件，进而无法写入卡死，导致大量用户访问拒绝</p>
<p><img src="/2023/11/26/Drama-talk-about-online-accidents/1.png" alt></p>
<p><code>经验教训</code>：</p>
<ul>
<li>关键点：西瓜重要，相对来说，芝麻不重要，芝麻丢了不应该西瓜也一起跟着丢掉，需要保住西瓜！！</li>
<li>芝麻组件未做好前向兼容，对于不能识别的配置，没有终止操作</li>
<li>组件之间的强/弱耦合关系需要正确处理，系统才具备容灾/解耦能力</li>
<li>由于程序健壮性不足，无法自动重启，通过手动发单操作重启，导致回滚环节持续时间较长</li>
</ul>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition error"><p class="admonition-title">17哥 点评
</p><p>千里之堤毁于蚁穴，一叶扁舟之险也。需要面向服务整体进行服务等级的划分，并做好服务降级、容灾、限流等措施。</p>
<p>在微服务架构下，没有什么服务有高低贵贱之分，所有服务都是平等的。在服务演化的进程中，谁能保证所有人都能意识到某个服务是弱依赖？谁又能保证，所有人都做了容错的兜底？</p>
</div>
<h2 id="事故二-超时还是不超时-这是个问题">事故二 超时还是不超时，这是个问题</h2>
<p><code>故障描述</code>：网络异常触发了 Redis 主从全量同步，导致 Redis 负载较高，读写成功率降低。处理该问题时，将超时时间配置修改为 0，意图尝试快速超时断开 Redis 连接，而 0 的含义实际为不超时，操作后问题进一步扩大：PHP 进程夯住，大量请求拒绝，问题等级上升为事故。</p>
<p><img src="/2023/11/26/Drama-talk-about-online-accidents/2.png" alt></p>
<p><code>经验教训</code>：</p>
<ul>
<li>存储层未区分核心、非核心，导致无法对非核心数据进行摘除，止损方案本身不合理</li>
<li>连接层的处理上，未对边界配置进行充分了解，仓促进行调整，导致故障范围扩大</li>
<li>监控角度，地域连通性监控，主从同步监控有效性需要检查</li>
</ul>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition error"><p class="admonition-title">17哥 点评
</p><p>在分布式架构下，服务的状态不是只有 <code>成功</code>、<code>失败</code> 两态，而是三态：<code>成功</code>、<code>超时</code>、<code>失败</code>。</p>
</div>
<h2 id="事故三-删除一条数据-系统崩溃了">事故三 删除一条数据，系统崩溃了</h2>
<p><code>故障描述</code>：删除 Redis 的一个大 Key，导致地域 X、Y 机房 Redis 阻塞，Redis 不可读写，在横跨多业务线的系统中，逐层触发重试风暴，最终 DB 流量暴增被压垮，同时影响共用 DB 的模块 B、C、D，其中包含某“一级服务（核心）”，另外上游模块也被拖死，请求大量拒绝。</p>
<p><img src="/2023/11/26/Drama-talk-about-online-accidents/3.png" alt></p>
<p><code>经验教训</code>：</p>
<ul>
<li>不合理的重试次数设置：底层服务挂掉后，逐层触发重试，疯狂重试</li>
<li>共用数据库可以考虑拆分与隔离，使用异步队列等</li>
<li>大 Key 删除可能导致“堵水管”（redis 主线程执行 del），4.0 以后得版本可以考虑 lazy free</li>
<li>同理考虑 DB 删除记录带来的锁升级风险</li>
</ul>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition error"><p class="admonition-title">17哥 点评
</p><p>不知道哪个角落的某台计算机发生了故障，导致了我们自己的电脑无法使用，这就是分布系统。</p>
<p>如果你不了解服务的全貌，那么就不要轻易去动任何你觉得“并不重要”的东西。任何时候，对线上都要保持敬畏，如果不了解，就别动；如果想动，就要去做好全面的了解。</p>
</div>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>架构</tag>
        <tag>线上事故</tag>
      </tags>
  </entry>
  <entry>
    <title>大语言模型实践</title>
    <url>/2023/11/05/LLM-in-Action/</url>
    <content><![CDATA[<p><img src="/2023/11/05/LLM-in-Action/1.png" alt></p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">书籍链接
</p><ul>
<li><a href="https://wangwei1237.github.io/LLM_in_Action/">https://wangwei1237.github.io/LLM_in_Action/</a></li>
</ul>
</div>
<p>这是一本关于 <code>大语言模型</code> <strong>实践</strong>的书籍，而不是一本深入研究 <code>大语言模型</code> 的运行原理和底层算法的书籍。如果您是一位想深入学习框架、算法并对其进行优化改进的研究者，本书可能并不适合您。如果您想大概了解一下相关的概念，并以此来指导自己的实践，想了解目前在应用开发中有哪些工具以及这些工具的具体实践用法，那么这本书正是为您你而作。</p>
<span id="more"></span>
<p>本书的实践大部分以文心大模型为主，正如这本书的题目，这本书会更偏向<strong>实践、应用</strong>，但是我们也会在数据介绍大模型相关的概念，这些概念会让您对大模型有一个初步的认识，仅此而已。如果您想深入了解相关概念的底层细节，我们也提供了对应的文献，您可以深入阅读相关的文献。</p>
<p>这是一个飞速发展的时代，技术、工具的发展亦是如此——每天有新的工具产生，也会有部分技术过时——因此我们以在线书籍的方式来构建这本书以保持内容的与时俱进。</p>
<p>作为大模型领域的非原著居民，我们将自己在实践中探索的过程整理到本书之中，希望帮助和我们一样正在实践的大模型领域的爱好者。这本书整体会分为三大部分：</p>
<ul>
<li>PART 1：基本概念篇，主要介绍大模型相关的基本概念</li>
<li>PART 2：相关工具篇，主要介绍大模型相关的工具，LangChain, Langflow, AutoGen……</li>
<li>PART 3：具体实践偏，主要介绍应用大模型的具体案例</li>
</ul>
<p>这也是一本开放的书籍，如果您希望为本书贡献自己的力量，您可以进入点击本书导航栏右上角的<i class="fa fa-github" style="color:#0681D0"></i>图标进入本书的代码仓库，提交您的内容。</p>
]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>LangChain</tag>
        <tag>OpenAI</tag>
        <tag>Ernie</tag>
        <tag>LLM</tag>
      </tags>
  </entry>
  <entry>
    <title>LangChain 简介</title>
    <url>/2023/09/20/Introduction-to-LangChain/</url>
    <content><![CDATA[<p><img src="/2023/09/20/Introduction-to-LangChain/langchain.png" alt></p>
<p>我们不想花更多的力气来实现和LLM交互的流程，而是更关注于业务逻辑的实现；我们也不想重复编写相似的流程代码，而是可以共享我们的成果，别人只需要键入 <code>docker pull</code> 就可以使用我们的成果……如果你有这样的想法，那么 LangChain 正是你的菜~</p>
<span id="more"></span>
<h2 id="langchain-的发展">LangChain 的发展</h2>
<p>随着大型语言模型（LLM）的引入，自然语言处理已经成为互联网上的热门话题。LangChain 是一个开源 Python 框架，利用 LangChain，开发人员能够非常方便的开发基于大型语言模型的应用程序（AI 原生应用），例如：聊天机器人，摘要，生成式问答……。</p>
<p>LangChain 虽然是一个非常年轻的框架，但又是一个发展速度非常快的框架。自从 2022 年 10 月 25 在 GitHub <a href="https://github.com/langchain-ai/langchain/commit/18aeb7201">第一次提交</a>以来，在 11 个 月的时间里，累计发布了 200 多次，累计提交 <a href="https://github.com/langchain-ai/langchain/graphs/commit-activity">4000</a> 多次代码。2023 年 3 月，ChatGPT 的 API 因升级降价大受欢迎，LangChain 的使用也随之爆炸式增长。</p>
<p><img src="/2023/09/20/Introduction-to-LangChain/langchain_commit_counts.jpg" alt="LangChain 代码提交趋势"></p>
<p>之后，LangChain 在没有任何收入也没有任何明显的创收计划的情况下，获得了 1000 万美元的种子轮融资和 2000-2500 万美元的 A 轮融资，估值达到 2 亿美元左右。<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<p>作为一个年轻而又活力的框架，LangChain 正在彻底改变工业和技术，改变我们与技术的每一次互动。</p>
<h2 id="langchain-的目标">LangChain 的目标</h2>
<p>不同的大语言模型都有各自的优势，我们可能会用 A 模型来进行自然语言理解，然后用 B 模型进行逻辑推理并获取结果……此时，如果使用大语言模型各自提供的 API 来和模型交互，那么就会存在非常多的重复工作。</p>
<p>虽然大语言模型有很多，但是和大语言模型的交互流程又是非常类似，如果每次和模型交互都需要重复如上的步骤，那听起来也是一件非常繁琐的事情。对于相同的提示词，我们不想每次都 <code>ctr+c</code>、<code>ctr+v</code>，这真是一件非常可怕的事情。</p>
<p><img src="/2023/09/20/Introduction-to-LangChain/1.jpg" alt="和模型交互的流程"></p>
<p>和 FFmpeg 对视频的处理一样，FFmpeg 提供的 <code>filtergraph</code> <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>机制大大增强了其音视频的处理能力，奠定其在视音频领域的地位。<code>filtergraph</code> 可以将不同的音视频处理能力以链条的形式组合起来，不但简化了音视频的处理流程，更让 FFmpeg 可以实现复杂的音视频处理。</p>
<p>同理，和 LLMs 的单次交互并不会形成什么惊人的能量，而如果可以使用类似 <code>filtergraph</code> 的机制，将与 LLMs 的多次交互整合起来，那么其所释放的能量将是无穷的。</p>
<p>而 LangChain 就是为了解决如上的问题而产生的。LangChain 可以提供给我们的最主要的价值如下<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>：</p>
<ul>
<li>组件化：LangChain 对与 LLMs 交互的流程进行了统一的抽象，同时也提供了不同 LLMs 的实现。这极大的提升了我们使用 LLMs 的效率。</li>
<li>序列化：LangChain 提供的序列化的能力，可以将<code>提示词</code>、<code>chain</code>等以文件的形式而不是以代码的形式进行存储，这样可以极大的方便我们共享 <code>提示词</code>，并对 <code>提示词</code> 进行版本管理。<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></li>
<li>丰富的 chains 套件：LangChain 提供了丰富、用于完成特定目的、开箱即用的 chains 套件，例如用于总结文档的 <code> StuffDocumentsChain</code> 和 <code>MapReduceDocumentsChain</code>，这些套件将会降低我们使用 LLMs 的门槛。</li>
</ul>
<p>更具体的， LangChain 可以在如下的 6 大方向上给我们提供非常大的便利：</p>
<ol>
<li><strong>LLMs &amp; Prompt</strong>：LangChain 提供了目前市面上几乎所有 LLM 的通用接口，同时还提供了 <code>提示词</code> 的管理和优化能力，同时也提供了非常多的相关适用工具，以方便开发人员利用 LangChain 与 LLMs 进行交互。</li>
<li><strong>Chains</strong>：LangChain 把 <code>提示词</code>、<code>大语言模型</code>、<code>结果解析</code> 封装成 <code>Chain</code>，并提供标准的接口，以便允许不同的 <code>Chain</code> 形成交互序列，为 AI 原生应用提供了端到端的 <code>Chain</code>。</li>
<li><strong>Data Augemented Generation</strong><sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>：<code>数据增强生成式</code> 是一种解决预训练语料数据无法及时更新而带来的回答内容陈旧的方式。LangChain 提供了支持 <code>数据增强生成式</code> 的 <code>Chain</code>，在使用时，这些 <code>Chain</code> 会首先与外部数据源进行交互以获得对应数据，然后再利用获得的数据与 <code>LLMs</code> 进行交互。典型的应用场景如：基于特定数据源的问答机器人。</li>
<li><strong>Agent</strong>：对于一个任务，<code>代理</code> 主要涉及让 <code>LLMs</code> 来对任务进行拆分、执行该行动、并观察执行结果，<code>代理</code> 会重复执行这个过程，直到该任务完成为止。LangChain 为 <code>代理</code> 提供了标准接口，可供选择的代理，以及一些端到端的 <code>代理</code> 的示例。</li>
<li><strong>Memory</strong>：<code>内存</code> 指的是 chain 或 agent 调用之间的状态持久化。LangChain 为 <code>内存</code> 提供了标准接口，并提供了一系列的 <code>内存</code> 实现。</li>
<li><strong>Evaluation</strong>：LangChain 还提供了非常多的评估能力以允许我们可以更方便的对 <code>LLMs</code> 进行评估。</li>
</ol>
<h2 id="langchain-的基本概念">LangChain 的基本概念</h2>
<p>使用 LLMs 和使用电脑一样，需要一些基本的架构体系。LangChain 把整体架构体系分为两部分：输入/输出系统，大语言模型。其中，输入部分为 <code>Prompt</code> 相关组件，输出为 <code>Output Parser</code> 相关组件。具体如下：</p>
<p><img src="/2023/09/20/Introduction-to-LangChain/langchain_io.png" alt="LangChain I/O"></p>
<p>LangChain 提供了与 LLMs 交互的通用构件：</p>
<ul>
<li><code>Prompts</code>：提示词模版，提示词动态选择，提示词序列化。</li>
<li><code>LLMs</code>：与 LLM 交互的通用接口。</li>
<li><code>Output Parsers</code>：对模型的输出信息进行解析，以输出符合特定格式的响应。</li>
</ul>
<p><img src="/2023/09/20/Introduction-to-LangChain/langchain_io_example.jpeg" alt="LangChain I/O 示例"></p>
<h3 id="prompt-templates">Prompt Templates</h3>
<p>提示词模版为不同的提示词提供预定义格式。就好像目前超市售卖的洗净切好、配好相关配菜源材料的预制菜一样，提示词模版可以简化我们和 LLMs 交互的效率。</p>
<p>模版会包含：指令，少量的样本示例，相关的上下文信息。LLMs 会分为 <code>大语言模型</code> 和 <code>聊天模型</code> 两种类型，因此，LangChain 提供了两种类型的提示词模版：<code>prompt template</code>、<code>chat prompt template</code>。</p>
<ul>
<li><code>prompt template</code>：提供字符串格式的提示词。</li>
<li><code>chat prompt template</code>：提示聊天消息格式的提示词。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> PromptTemplate</span><br><span class="line"></span><br><span class="line">prompt_template = PromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;请以轻松欢快的语气写一篇描写 &#123;topic&#125; 的文章，字数不超过 &#123;count&#125; 字。&quot;</span></span><br><span class="line">)</span><br><span class="line">res = prompt_template.<span class="built_in">format</span>(topic=<span class="string">&quot;北京的秋天&quot;</span>, count=<span class="string">&quot;100&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># 请以轻松欢快的语气写一篇描写 北京的秋天 的文章，字数不超过 100 字。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">template = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;你是一个能力非凡的人工智能机器人，你的名字是 &#123;name&#125;。&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;你好！&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;ai&quot;</span>, <span class="string">&quot;你好~&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;user_input&#125;&quot;</span>),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">messages = template.format_messages(</span><br><span class="line">    name=<span class="string">&quot;小明&quot;</span>,</span><br><span class="line">    user_input=<span class="string">&quot;你是谁？&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(messages)</span><br><span class="line"><span class="comment"># [SystemMessage(content=&#x27;你是一个能力非凡的人工智能机器人，你的名字是 小明。&#x27;, </span></span><br><span class="line"><span class="comment">#                additional_kwargs=&#123;&#125;), </span></span><br><span class="line"><span class="comment"># HumanMessage(content=&#x27;你好！&#x27;, additional_kwargs=&#123;&#125;, example=False), </span></span><br><span class="line"><span class="comment"># AIMessage(content=&#x27;你好~&#x27;, additional_kwargs=&#123;&#125;, example=False), </span></span><br><span class="line"><span class="comment"># HumanMessage(content=&#x27;你是谁？&#x27;, additional_kwargs=&#123;&#125;, example=False)]</span></span><br></pre></td></tr></table></figure>
<h3 id="llms">LLMs</h3>
<p>LangChain 提供了两种模型的通用接口：</p>
<ul>
<li><code>LLMs</code>：模型以字符串格式的提示词作为输入，并返回字符串格式的结果。</li>
<li><code>Chat models</code>：其背后也是由某种 LLM 来支撑，但是以聊天消息列表格式的提示词作为输入，并返回聊天消息格式的结果。</li>
</ul>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">LLM 和 聊天模式的区别
</p><p>LLM 和 聊天模式 之间的区别虽然很微妙，但是却完全不同。</p>
<p>LangChain 中的 LLM 指的是纯文本 I/O 的模型，其包装的 API 将字符串提示作为输入，并输出字符串。OpenAI 的 GPT-3 就是 LLM。</p>
<p>聊天模型通常由 LLM 支持，但专门针对对话进行了调整，其 API 采用聊天消息列表作为输入，而不是单个字符串。通常，这些消息都标有角色（例如，“System”，“AI”，“Human”）。聊天模型会返回一条 AI 聊天消息作为输出。OpenAI 的 GPT-4，Anthropic 的 Claude，百度的 Ernie 都是聊天模型。</p>
</div>
<p>在 LangChain 中，LLM 和 聊天模式两者都实现了 <code>BaseLanguageModel</code> 接口，因此一般情况下，这两种模型可以混用。例如，两种模型都实现了常见的方法 <code>predict()</code> 和 <code>predict_messages()</code>。<code>predict()</code> 接受字符串并返回字符串，<code>predict_messages()</code> 接受消息并返回消息。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpenAI</span>(<span class="params">BaseOpenAI</span>):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseOpenAI</span>(<span class="params">BaseLLM</span>):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseLLM</span>(<span class="params">BaseLanguageModel[<span class="built_in">str</span>], ABC</span>):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ErnieBotChat</span>(<span class="params">BaseChatModel</span>):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseChatModel</span>(<span class="params">BaseLanguageModel[BaseMessageChunk], ABC</span>):</span></span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>
<p>接下来，我们将 <code>Prompt</code> 和 <code>LLM</code> 整合起来，实现和大语言模型交互。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain <span class="keyword">import</span> PromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain.llms <span class="keyword">import</span> OpenAI</span><br><span class="line"></span><br><span class="line">prompt_template = PromptTemplate.from_template(</span><br><span class="line">    <span class="string">&quot;请以轻松欢快的语气写一篇描写 &#123;topic&#125; 的文章，字数不超过 &#123;count&#125; 字。&quot;</span></span><br><span class="line">)</span><br><span class="line">llm = OpenAI()</span><br><span class="line"></span><br><span class="line">prompt = prompt_template.<span class="built_in">format</span>(topic=<span class="string">&quot;北京的秋天&quot;</span>, count=<span class="string">&quot;100&quot;</span>)</span><br><span class="line">res = llm.predict(prompt)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 秋天来到了北京，一片金黄色的枫叶，漫山遍野。</span></span><br><span class="line"><span class="comment"># 湖面上的微风，吹起柔和的秋意，空气中弥漫着淡淡的枫香。</span></span><br><span class="line"><span class="comment"># 这时，每一个角落都洋溢着秋日的温馨，令人心旷神怡。</span></span><br><span class="line"><span class="comment"># 古老的长城上披着红叶，熙熙攘攘的人群中，也多了几分热闹与欢畅，这就是北京的秋天</span></span><br></pre></td></tr></table></figure>
<p>由于文心聊天模型对 <code>message</code> 角色和条数有限制<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup> <sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup>，因此我们需要对 <code>提示词</code> 做一些修改。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ErnieBotChat</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">template = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;你是一个能力非凡的人工智能机器人，你的名字是 &#123;name&#125;。&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;你好~&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;user_input&#125;&quot;</span>),</span><br><span class="line">])</span><br><span class="line">chat = ErnieBotChat()</span><br><span class="line"></span><br><span class="line">messages = template.format_messages(</span><br><span class="line">    name=<span class="string">&quot;小明&quot;</span>,</span><br><span class="line">    user_input=<span class="string">&quot;你是谁？&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">res = chat.predict_messages(messages)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># content=&#x27;我是你的新朋友小明，一个拥有先进人工智能技术的人工智能机器人。&#x27; </span></span><br><span class="line"><span class="comment"># additional_kwargs=&#123;&#125; example=False</span></span><br></pre></td></tr></table></figure>
<h3 id="output-parsers">Output Parsers</h3>
<p>大语言模型一般会输出文本内容作为响应，当然更高级的大语言模型（例如文心大模型）还可以输出图片、视频作为响应。但是，很多时候，我们希望可以获得更结构化的信息，而不仅仅是回复一串字符串文本。</p>
<p>我们可以使用 <code>提示词工程</code> 来提示 LLMs 输出特定的格式，如下所示：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ErnieBotChat</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"></span><br><span class="line">template = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;你是一个能力非凡的人工智能机器人，你的名字是 &#123;name&#125;。&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;你好~&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;user_input&#125;&quot;</span>),</span><br><span class="line">])</span><br><span class="line">chat = ErnieBotChat()</span><br><span class="line"></span><br><span class="line">messages = template.format_messages(</span><br><span class="line">    name=<span class="string">&quot;小明&quot;</span>,</span><br><span class="line">    user_input=<span class="string">&quot;请给出 10 个表示快乐的成语，并输出为 JSON 格式&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">res = chat.predict_messages(messages)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line"><span class="comment"># content=&#x27;```json\n[\n    &quot;乐不可支&quot;,</span></span><br><span class="line"><span class="comment">#                    \n    &quot;喜从天降&quot;,</span></span><br><span class="line"><span class="comment">#                    \n    &quot;笑逐颜开&quot;,</span></span><br><span class="line"><span class="comment">#                    \n    &quot;手舞足蹈&quot;,</span></span><br><span class="line"><span class="comment">#                     ......</span></span><br><span class="line"><span class="comment">#                    \n    &quot;弹冠相庆&quot;\n]\n```&#x27; </span></span><br><span class="line"><span class="comment"># additional_kwargs=&#123;&#125; example=False</span></span><br></pre></td></tr></table></figure>
<p>但是，使用 LangChain 提供的 <code>Output Parsers</code> 能力，会更加的方便。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ErnieBotChat</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain.output_parsers <span class="keyword">import</span> CommaSeparatedListOutputParser</span><br><span class="line"></span><br><span class="line">template = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;你是一个能力非凡的人工智能机器人，你的名字是 &#123;name&#125;。&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;你好~&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;user_input&#125;&quot;</span>),</span><br><span class="line">])</span><br><span class="line">chat = ErnieBotChat()</span><br><span class="line"></span><br><span class="line">messages = template.format_messages(</span><br><span class="line">    name=<span class="string">&quot;小明&quot;</span>,</span><br><span class="line">    user_input=<span class="string">&quot;请仅给5个表示快乐的成语并以 , 分隔，除了成语外不要输出任何其他内容&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">res = chat.predict_messages(messages)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># content=&#x27;欢呼雀跃，手舞足蹈，笑逐颜开，心花怒放，喜笑颜开&#x27; additional_kwargs=&#123;&#125; example=False</span></span><br><span class="line"></span><br><span class="line">output_parser = CommaSeparatedListOutputParser()</span><br><span class="line">res =  output_parser.parse(res.content.replace(<span class="string">&#x27;，&#x27;</span>, <span class="string">&#x27;, &#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># [&#x27;欢呼雀跃&#x27;, &#x27;手舞足蹈&#x27;, &#x27;笑逐颜开&#x27;, &#x27;心花怒放&#x27;, &#x27;喜笑颜开&#x27;]</span></span><br></pre></td></tr></table></figure>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition warning"><p class="admonition-title">warning</p><p>由于文心大模型的指令遵循能力还有进一步提升的空间，因此这里的演示可能需要进行一些额外的操作，例如需要对模型返回的内容进行一些简单的字符串替换。</p>
</div>
<h3 id="llmchain">LLMChain</h3>
<p>虽然一台独立的计算机也能实现很强大的功能，但是通过网络将更多的计算机链接起来，可能发挥出更大的性能。同样的，单独使用 LLMs 已经可以实现强大的功能，但是如果可以将更多次的交互有效的链接起来，则能发挥 LLMs 更大的能量。为了实现这个目标，LangChain 提供了 <code>Chain</code> 的概念，以实现对不同组件的一系列调用。</p>
<p>在 LangChain 中，<code>提示词</code>、<code>LLM</code>、<code>输出解析</code> 这三者构成了 <code>Chain</code>，而不同的 <code>Chain</code> 则可以通过一定的方式链接起来，以实现强大的功能。具体如下所示。</p>
<p><img src="/2023/09/20/Introduction-to-LangChain/chain.png" alt="LangChain 中 Chain 的概念"></p>
<p>利用 <code>Chain</code> 的概念，我们可以对之前的代码进行重构，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ErnieBotChat</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate</span><br><span class="line"><span class="keyword">from</span> langchain.output_parsers <span class="keyword">import</span> CommaSeparatedListOutputParser</span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> LLMChain</span><br><span class="line"></span><br><span class="line">template = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;你是一个能力非凡的人工智能机器人，你的名字是 &#123;name&#125;。&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;你好~&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;user&quot;</span>, <span class="string">&quot;&#123;user_input&#125;&quot;</span>),</span><br><span class="line">])</span><br><span class="line">chat = ErnieBotChat()</span><br><span class="line"></span><br><span class="line">chain =  LLMChain(llm=chat, prompt=template, output_parser=CommaSeparatedListOutputParser())</span><br><span class="line"></span><br><span class="line">res =  chain.run(name=<span class="string">&quot;小明&quot;</span>, user_input=<span class="string">&quot;请仅给5个表示快乐的成语并以 , 分隔，除了成语外不要输出任何其他内容&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="comment"># [&#x27;以下是五个表示快乐的成语：\n\n1. 喜出望外\n2. 乐不可支\n3. 心花怒放\n4. 满心欢喜\n5. 手舞足蹈&#x27;]</span></span><br></pre></td></tr></table></figure>
<h2 id="langchain-的学习资料">LangChain 的学习资料</h2>
<ul>
<li>LangChain 官方文档：<a href="https://python.langchain.com/docs/get_started">https://python.langchain.com/docs/get_started</a></li>
<li>LangChain 的典型应用场景：<a href="https://python.langchain.com/docs/use_cases">https://python.langchain.com/docs/use_cases</a></li>
<li>LangChain 目前集成的能力：<a href="https://python.langchain.com/docs/integrations">https://python.langchain.com/docs/integrations</a></li>
<li>LangChain AI Handbook：<a href="https://www.pinecone.io/learn/series/langchain/">https://www.pinecone.io/learn/series/langchain/</a></li>
<li>LangChain Dart：<a href="https://langchaindart.com/#/">https://langchaindart.com/#/</a></li>
<li>百度智能云千帆大模型平台：<a href="https://cloud.baidu.com/product/wenxinworkshop">https://cloud.baidu.com/product/wenxinworkshop</a></li>
</ul>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://ecosystem.lafrenchtech.com/companies/langchain">LangChain 估值</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://ffmpeg.org/ffmpeg-filters.html">FFmpeg Filters Documentation</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://python.langchain.com/docs/get_started/introduction">LangChain Introdction</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://python.langchain.com/docs/modules/model_io/prompts/prompt_templates/prompt_serialization">Prompt Serialization</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://www.datacamp.com/tutorial/complete-guide-data-augmentation">A Complete Guide to Data Augmentation</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://cloud.baidu.com/doc/WENXINWORKSHOP/s/4lilb2lpf">ERNIE-Bot-turbo</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p><a href="https://cloud.baidu.com/product/wenxinworkshop">百度智能云千帆大模型平台</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>LangChain</tag>
        <tag>OpenAI</tag>
        <tag>Ernie</tag>
      </tags>
  </entry>
  <entry>
    <title>有趣的 Elo 积分系统</title>
    <url>/2023/08/12/the-interesting-elo-rating-system/</url>
    <content><![CDATA[<p><img src="/2023/08/12/the-interesting-elo-rating-system/1.png" alt></p>
<p>我们的 <a href="/2023/02/13/duzhiliao/">视频质量评估系统</a> 可以通过众包的形式为一组视频进行主观质量打分。如果想评估两个视频编解码器的编码效果，并确定哪个编解码器更优，则可以采用我们的系统来完成。</p>
<span id="more"></span>
<h2 id="众包成对打分法">众包成对打分法</h2>
<p>我们会利用不同的编解码器对相同的视频源进行编码，并得到两个视频：A（编解码器 A 的编码视频），B（编解码器 B 的编码视频）。在评估的过程中，我们的系统会隐藏编解码器的信息，并要求众包用户对两个视频的效果进行评估，以选取效果好的视频。具体的打分如下图所示：</p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/2.png" alt></p>
<p>其中各选项对应的得分如下：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>5分制打分</th>
<th>百分制打分</th>
</tr>
</thead>
<tbody>
<tr>
<td>A 特好</td>
<td>1</td>
<td>0~19</td>
</tr>
<tr>
<td>A 较好</td>
<td>2</td>
<td>20~39</td>
</tr>
<tr>
<td>差不多</td>
<td>3</td>
<td>40~59</td>
</tr>
<tr>
<td>B 较好</td>
<td>4</td>
<td>60~79</td>
</tr>
<tr>
<td>B 特好</td>
<td>5</td>
<td>80~100</td>
</tr>
</tbody>
</table>
<p>对于每一个视频，我们都会邀请至少 10 个众包用户进行打分，我们会过滤不置信的打分并对剩余的打分进行 MOS 计算，然后将结果转换为百分制的打分（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>5</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1,5]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">5</span><span class="mclose">]</span></span></span></span>-&gt;<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>100</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,100]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mclose">]</span></span></span></span>）。例如，如果有5对视频，我们可能会得到如下的打分：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MOS_Scores &#x3D; [61, 55, 54, 65, 15] </span><br></pre></td></tr></table></figure>
<p>根据实践，我们不能采用平均分的方式对两个编解码器效果进行评估，否则可能会存在偏差。以如上的打分为例，其平均打分为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mrow><mi>M</mi><mi>O</mi><mi>S</mi><mi mathvariant="normal">_</mi><mi>S</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mi>s</mi></mrow></msub><mo>=</mo><mn>50</mn></mrow><annotation encoding="application/x-tex">\mu_{MOS\_Scores}=50</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.79756em;vertical-align:-0.367em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">O</span><span class="mord mathdefault mtight" style="margin-right:0.05764em;">S</span><span class="mord mtight" style="margin-right:0.02778em;">_</span><span class="mord mathdefault mtight" style="margin-right:0.05764em;">S</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">r</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.367em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span><span class="mord">0</span></span></span></span>，但是我们不能说两个编解码器的效果是一致的。因为 B 对于 A 而言，其 GSB（Good/Same/Bad）分布为：40%/40%/20%。因此，对于我们的评估系统而言，我们一般用 GSB 的分布，而不是一个单一的分数来确定哪个编解码器更好。</p>
<h2 id="chatbot-arena">Chatbot Arena</h2>
<p>但是，事情发生了一些有趣的变化。</p>
<p>最近在阅读一篇大语言模型评估的综述论文——<a href="https://arxiv.org/abs/2307.03109"><em>A Survey on Evaluation of Large Language Models</em></a>，该论文中提到了由 <a href="https://lmsys.org/">LMSYS Org</a> 发布的 Chatbot Arena 平台，Chatbot Arena 是一个基于 Elo 打分的大语言模型的基准平台（<a href="https://lmsys.org/blog/2023-05-03-arena/">Chatbot Arena: Benchmarking LLMs in the Wild with Elo Ratings</a>）。</p>
<p>Chatbot Arena 平台通过众包的形式，采用匿名、随机的方式对不同的 LLMs（Large Language Models） 进行打分，然后基于国际象棋等竞技游戏中广泛使用的 Elo 积分系统对 LLMs 进行 Elo 积分计算，最终通过 Elo 积分对 LLMs 进行排序以确定 LLMs 的排名。</p>
<p>Chatbot Arena 每次会随机选择两个不同的大语言模型和用户聊天，并让用户在匿名的情况下判定哪款大模型产品的表现更好一些。</p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/3.png" alt></p>
<p>在得到用户的匿名打分之后，Chatbot Arena 通过计算 Elo 算法来获得 LLMs 的 Elo 积分。</p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/4.png" alt></p>
<p>我们可以在 <a href="https://huggingface.co/spaces/lmsys/chatbot-arena-leaderboard">chatbot-arena-leaderboard 页面</a> 获取当前 Chatbot Arena 平台的 LLMs 的榜单。</p>
<h2 id="elo-rating">Elo rating</h2>
<h3 id="elo-的历史">Elo 的历史</h3>
<p>Elo 不是缩写，而是根据 Elo 评分系统的发明者、美国物理学教授 Arpad Elo 的姓氏来命名的一个评分机制。Elo 评分机制的目的是为了更加公平的评估像如国际象棋这类竞技比赛的选手的水平。</p>
<p>在 Elo 以前，国际象棋选手排名体系已经有<a href="https://en.wikipedia.org/wiki/Chess_rating_system">两套系统</a>：</p>
<ul>
<li>欧洲的 Ingo 等级积分系统</li>
<li>美国象棋协会（USCF）的 Harkness 等级积分系统</li>
</ul>
<p>虽然说 Harkness 系统相对公平，但是在某些情况下会产生许多不准确的评分。为了解决这个问题，Elo 教授代表 USCF 设计了一个更完善的新系统。1960 年，USCF 正式采用 Elo 评级系统；1970 年，国际棋联正式采用 Elo 评级系统。目前，许多国际象棋组织和网站也使用 Elo 系统来对玩家进行评分<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。</p>
<h3 id="elo-的数学原理">Elo 的数学原理</h3>
<p>每个选手的 Elo 评分由一个数字表示，该数字反映了该选手在之前评分游戏中的成绩。每场比赛之后，选手的评分都会根据比赛结果进行调整。根据经验，一名得分比对手高 100 分的选手预计将赢得八场比赛中的五场（64%），一个拥有 200 分优势的选手大概会赢得四场比赛中的三场（75%）。</p>
<p>Elo 在解释选手对战情况时，分为两个部分<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>：</p>
<ul>
<li><strong>1.根据战力差来计算对战胜率情况，多少分差对应多少胜率。</strong></li>
<li><strong>2.选手完成对局后实际获得的积分增长。</strong></li>
</ul>
<h4 id="elo-预期胜率">Elo 预期胜率</h4>
<p>在竞技比赛中，强手未必总是胜过弱手，即使在其最好的状态时，仍然可能会犯错并输掉比赛。实际上，任何一名选手的比赛表现都应该符合正态分布：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><msqrt><mrow><mn>2</mn><mi>π</mi></mrow></msqrt><mi>σ</mi></mrow></mfrac><msup><mi>e</mi><mfrac><mrow><mo>−</mo><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>μ</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac></msup></mrow><annotation encoding="application/x-tex">f(x) = \frac{1}{\sqrt{2\pi}\sigma}e^{\frac{-(x-\mu)^2}{2\sigma^2}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.25909em;vertical-align:-0.93em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.2027799999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.90722em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span></span></span><span style="top:-2.86722em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.13278em;"><span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.32909em;"><span style="top:-3.4534200000000004em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.250957142857143em;"><span style="top:-2.5061857142857145em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9384399999999999em;"><span style="top:-2.93844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.5020714285714285em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mathdefault mtight">x</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight">μ</span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.04844em;"><span style="top:-3.04844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49381428571428565em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">μ</span></span></span></span> 代表选手实力的平均水平，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span></span></span></span> 代表实力的稳定性。</p>
<p>对于两个选手而言：</p>
<ul>
<li>选手A，平均表现 1800 分，但是发挥不稳定，其波动分值为 200 分左</li>
<li>选手B，平均表现 2000 分，并且发挥很稳定，其波动分值在 100 左右</li>
</ul>
<p>那么，他们的表现应符合如下的两个正态分布：</p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/5.jpg" alt></p>
<p>在这种情况下，那么在 1850 分处，B 能战胜 A 的条件为：A 得 1850 时，B 的表现分高于 1850。也就是：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>B</mi><mo>:</mo><mi>w</mi><mi>i</mi><mi>n</mi></mrow></msub><mo stretchy="false">(</mo><mn>1850</mn><mo stretchy="false">)</mo><mo>=</mo><msub><mi>P</mi><mi>A</mi></msub><mo stretchy="false">(</mo><mn>1850</mn><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>P</mi><mi>B</mi></msub><mo stretchy="false">(</mo><mo>&gt;</mo><mn>1850</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P_{B:win}(1850) = P_{A}(1850) * P_{B}(&gt;1850)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span><span class="mrel mtight">:</span><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">8</span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mord">8</span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.13889em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">8</span><span class="mord">5</span><span class="mord">0</span><span class="mclose">)</span></span></span></span></span></p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/6.jpg" alt></p>
<p>而像 1850 这样的点有无数个：</p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/elo_demo.gif" alt></p>
<p>所以 B 能战胜 A 的最终概率，是这无数个点下，B 战胜 A 的概率的和，也就是一个积分运算：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo>+</mo><msubsup><mo>∫</mo><mn>0</mn><mi>D</mi></msubsup><mrow><mfrac><mn>1</mn><mrow><msqrt><mrow><mn>2</mn><mi>π</mi></mrow></msqrt><mi>σ</mi></mrow></mfrac><msup><mi>e</mi><mfrac><mrow><mo>−</mo><msup><mi>x</mi><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac></msup><mi>d</mi><mi>x</mi></mrow></mrow><annotation encoding="application/x-tex">P(D) = \frac{1}{2} + \int_{0}^{D}{\frac{1}{\sqrt{2\pi}\sigma}e^{\frac{-x^2}{2\sigma^2}}dx}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.521231em;vertical-align:-0.93em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.591231em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3.8129000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9119499999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.2027799999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.90722em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span></span></span><span style="top:-2.86722em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.13278em;"><span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.24644em;"><span style="top:-3.4534200000000004em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1328857142857145em;"><span style="top:-2.5061857142857145em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9384399999999999em;"><span style="top:-2.93844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.04844em;"><span style="top:-3.04844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49381428571428565em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span><span class="mord mathdefault">d</span><span class="mord mathdefault">x</span></span></span></span></span></span></p>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> 为两名选手的分差。</p>
<p>利用最小二乘法，可以得到与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span> 函数趋向相近的另一个函数，也是我们实际应用时更常用的函数：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><mn>1</mn><msup><mn>0</mn><mfrac><mi>D</mi><mn>400</mn></mfrac></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">P(D) = \frac{1}{1 + 10^{\frac{D}{400}}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.2537849999999997em;vertical-align:-0.932345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.1509850000000004em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.959015em;"><span style="top:-3.3485500000000004em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mtight">0</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02778em;">D</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.932345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>即当选手 A 与选手 B 的分差（A-B）为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> 时，选手 A 对选手 B 的期望胜率为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span>，则 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span> 与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> 之间的变化关系如下图：</p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/7.png" alt></p>
<h4 id="elo-积分迭代">Elo 积分迭代</h4>
<p>我们如何确定选手的 Elo 积分到底是多少呢？</p>
<p>Elo 的做法是：通过选手与不同分数选手的大量比赛结果，对选手的 Elo 分数进行不断修正，直到选手的分数收敛到其相应的真实水平。</p>
<p>Elo 的积分迭代公式如下：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>n</mi></msub><mo>=</mo><msub><mi>R</mi><mi>o</mi></msub><mo>+</mo><mi>K</mi><mo>∗</mo><mo stretchy="false">(</mo><mi>W</mi><mo>−</mo><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R_n = R_o + K * (W - P(D))
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">R_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是选手比赛结束后的新的 Elo 积分</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>o</mi></msub></mrow><annotation encoding="application/x-tex">R_o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.00773em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是选手比赛前的 Elo 积分</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> 是一个加成系数，由选手当前的分值水平决定，分值越高 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span></span></span></span> 越小</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span> 是选手的实际对局结果得分，赢得 1 分，输得 0 分，平局得 0.5 分</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span> 是选手的预期胜率</li>
</ul>
<p>比赛结束后，选手的积分增加与分差 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> 之间的变化趋势如下图：</p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/8.png" alt></p>
<p>由此可知：</p>
<ul>
<li>如果选手战胜比自己低 800 分的选手后，因为此时 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo><mo>≈</mo><mn>100</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">P(D) \approx 100\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">0</span><span class="mord">%</span></span></span></span>，因此，即便选手获胜也基本不得分。</li>
<li>如果选手战胜比自己高 800 分的选手后，因为此时 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo><mo>≈</mo><mn>0</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">P(D) \approx 0\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.80556em;vertical-align:-0.05556em;"></span><span class="mord">0</span><span class="mord">%</span></span></span></span>，因此，如果选手获胜，则可以得到 32 分。</li>
</ul>
<p>对于 Elo 积分系统而言，该系统的特点是：选手之间的水平差距决定了他们能赢多少分或输多少分。</p>
<p>Elo 分高得多的选手有望获胜，因此他们在与得分低得多的选手的比赛中获胜不会得到很多分数，同时，他们的对手也没有因为失败而损失大量的分数。</p>
<p>反之，Elo 分较低的选手获胜时，则该选手会获得更多的 Elo 分数，其对手也会受到对应的比较多的扣分。</p>
<p>这看起来是多么的合理。</p>
<h2 id="elo-在视频质量打分中的应用">Elo 在视频质量打分中的应用</h2>
<h3 id="elo-的特点">Elo 的特点</h3>
<p>Elo 具备如下的特点<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>：</p>
<ul>
<li><strong>离散性</strong>：Elo 积分的计算不需要太多的信息，只需要知道三个要素即可对积分进行迭代：选手赛前积分，对手赛前积分，比赛结果。</li>
<li><strong>具备收敛过程</strong>：Elo 积分在达到合理之前存在一个收敛过程，比如一个 2000 分水平的玩家在玩小号时，其遇到的对手大概率都是从 1200 分开始的，这时候 Elo 分无法精确的反应他的真实实力。为了获取该玩家的真实水平，需要一个过程，也就是 Elo 积分的收敛过程。</li>
<li><strong>对所有比赛一视同仁</strong>：Elo 分只会根据同一评分体系下的积分进行迭代，积分增长情况和赛事重要性无关。</li>
<li><strong>与比赛顺序有一定关系</strong>：比赛顺序可能会对 Elo 积分的变化有一定影响。但是，因为选手的表现是成正太分布，再加上 Elo 积分的收敛特性，因此，在经过多轮比赛之后，Elo 的积分最终会趋向一个比较合理的分值。</li>
</ul>
<h3 id="elo-如何评估编解码器的水平">Elo 如何评估编解码器的水平</h3>
<p>正因为 Elo 有如上的特点，我们认为在对比评估两个编解码器时，可以使用 Elo 积分来进行编解码器的排位。每一个视频的打分都可以被视为一次比赛，而随着评估视频的数量增加，最终的 Elo 积分也会不断收敛至一个合理的水平，进而可以比较准确的来衡量编解码器的优劣。</p>
<p>对于编解码器 A、B 的如下 MOS 分：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MOS_Scores &#x3D; [61, 55, 54, 65, 15] </span><br></pre></td></tr></table></figure>
<p>如果初始得分均为 1500，则我们可以得到最终的 Elo 得分如下：</p>
<ul>
<li>A：1490</li>
<li>B：1510</li>
</ul>
<p>可以使用 <a href="https://github.com/wangwei1237/wangwei1237.github.io_src/blob/master/source/_posts/the-interesting-elo-rating-system/elo.py">elo.py</a> 脚本 <a href="https://github.com/wangwei1237/wangwei1237.github.io_src/blob/master/source/_posts/the-interesting-elo-rating-system/MOS">对 100 个评估视频的 MOS 得分</a> 进行 Elo 积分迭代，其 Elo 积分的迭代如下图所示：</p>
<p><img src="/2023/08/12/the-interesting-elo-rating-system/9.png" alt></p>
<p>从图上可知：对于 Elo 而言，确实需要一定的收敛周期。如果评估视频样本量不够，比如只有 38 个，那么很有可能就会得到错误的结论。</p>
<p>另外，对于视频评估而言，我们认为，给定两个编码器赋以相同的初始分（假定两个编解码器效果一致）更为合理。</p>
<h3 id="视频顺序对-elo-的影响">视频顺序对 Elo 的影响</h3>
<p>如前所述，初始分数有可能会对 Elo 带来影响，但是因为 Elo 的收敛特性，当视频样本足够多的时候，视频顺序不会影响最终的 Elo 得分。</p>
<p>为此，我们对视频顺序进行了随机排序，然后再来计算 Elo 得分。我们发现，视频顺序变换后，并没有影响最终的结论。<br>
<img src="/2023/08/12/the-interesting-elo-rating-system/10.png" alt></p>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://www.chess.com/terms/elo-rating-chess">Elo Rating System</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://en.wikipedia.org/wiki/Elo_rating_system">Elo Rating System</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://zhuanlan.zhihu.com/p/28190267">通俗讲义：匹配系统核心 “ELO”积分揭秘</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>算法与数学</category>
      </categories>
      <tags>
        <tag>Elo rating</tag>
        <tag>Chatbot Arena</tag>
      </tags>
  </entry>
  <entry>
    <title>我的“逆向工作”实践</title>
    <url>/2023/07/09/My-practice-of-working-backwards/</url>
    <content><![CDATA[<p><img src="/2023/07/09/My-practice-of-working-backwards/1.png" alt></p>
<p>2023 年 4 月 1 日，我在 <a href="https://bj2022.livevideostack.cn/schedule">LiveVideoStack 2022 北京站</a> 大会上，以 <a href="https://mp.weixin.qq.com/s/J2QGTiMOgMnZbAyI81I87Q">《百度视频质量评测的实践之路》</a> 为题介绍了团队在视频质量评测方向的思考与认知。回首向来萧瑟处，金戈铁马，苍山如海。</p>
<p>站在后验结果的视角来审视这个过程，发现有很多的地方——尤其是“逆向工作”思路对整个事情的推动，值得进一步思考与总结。同时，最近和同事在讨论其他方向的工作思路时，我发现“逆向工作”这个词频繁的出现。再加上，近来又在读贝佐斯的 24 封“致股东信”，在 2008 年的“致股东信”中提到的“逆向倒推”深深启发了我。因此，更想对过去的这一段工作进行一番总结。</p>
<span id="more"></span>
<h2 id="虚拟摄像头-逆向初体验">虚拟摄像头——逆向初体验</h2>
<p>时针回拨到 2019 年的夏天，那个时候，抖音、快手提供的可以使用手机拍摄视频并实时增加各种特效的功能蔚然成风。在鹏寰国际大厦的一个会议室中，有一群人正在诉说着工作中那令人“烦恼”的快乐，这群人是当时“全民小视频”测试团队的同学，他们刚刚完成了拍摄器特效功能大改版的测试。</p>
<ul>
<li>为了测试这次增加的“拍天空”特效，我都晒黑了……<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=253011891&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
</li>
<li>为了测试张嘴特效，我的下巴都脱臼了……</li>
<li>……</li>
</ul>
<p>我意识到我有必要做点什么来改变这种局面，然后问了一句：如何才能做到一次拍摄，次次可用？这样咱们就不用害怕晒黑和下巴脱臼啦~</p>
<p>一时间，大家都沉默了，一是因为这确实是个好主意，二是因为这个问题超出了我们能回答的范畴。确实，在当时，我们在技术上确实没有办法做到这一点，否则我们就不会下巴脱臼了。片刻沉默之后，大家又热烈的讨论了起来，我们天马行空的想了很多方案，但是在谈到谁可以来跟进的时候，事情又开始变得非常微妙。</p>
<p>讨论之后的工作又恢复了往日的忙碌，大家似乎都忘记了有过这样一次讨论，不过我依然兴奋不已。为了实现“一次拍摄，次次可用”的目标，我和几个志同道合的同事开启了一段难忘的时光，在这段时光里，我们疯狂汲取大量的各类新知识：</p>
<ul>
<li>音视频基础知识，数字视频基本概念</li>
<li>Android 相机系统原理</li>
<li>FFmpeg，OpenGL</li>
<li>Xposed框架，Android逆向破解</li>
<li>……</li>
</ul>
<p>令人欣喜的是，在 2019 年的国庆节前，我们还真的就实现了“用指定视频替换摄像头采集到的画面”的功能，我们称之为“摄像头 HOOK”。昨日之深渊，今日之浅谈。的确，当我们跨越种种困难实现目标之后，回头想想，整个事情好像也没有那么困难。</p>
<p>我们将核心的思路公开到了 <a href="https://github.com/wangwei1237/CameraHook">GitHub</a>，在 GitHub 上，我们遇到了新的朋友，基于我们的思路，我们的新朋友实现了能力更丰富的 <a href="https://github.com/w2016561536/android_virtual_cam">虚拟摄像头项目</a>。后来，我们也基于这个核心思想，实现了：贴纸测试自动化，高精准肢体、人脸识别，高精准直播延迟测试……等技术，彻底改变了原有的工作方式，极大提升了工作效率。</p>
<h2 id="逆向倒推">逆向倒推</h2>
<p>在虚拟摄像头的项目上我尝到了一丝丝的甜头，我惊奇的发现，原来还可以这样解决问题，我开始重新思考这种工作方式的有趣之处：</p>
<ul>
<li>不以现有的技术为出发点去确定问题可以解决的程度<br>
<img src="/2023/07/09/My-practice-of-working-backwards/2.png" alt></li>
<li>以问题的最终解决为目标重新思考需要做何种准备<br>
<img src="/2023/07/09/My-practice-of-working-backwards/3.png" alt></li>
</ul>
<p>直到最近一口气读完了亚马逊 CEO <a href="https://mp.weixin.qq.com/s/ZIEBKte_CNsx_VdHH2TGPg">贝佐斯的24封致股东信</a> 之后，我才意识到，原来这种思维模式就是贝佐斯在 <a href="https://mp.weixin.qq.com/s/ejNdFv0g1Bg8_U8A1G6-tQ">2008 年致股东信</a> 中提到的“逆向倒推法”。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">逆向倒推
</p><p>从用户需求出发的“逆向倒推法”，可与利用现有技术和能力推动商机的“技能正推法”形成鲜明对比。</p>
<ul>
<li>“技能正推法”的理念是：我们非常擅长 <code>X</code>，利用 <code>X</code>，我们还能做些什么呢？这的确是一种实用且有效的做法。然而，如果仅仅依靠擅长的技能，那么公司便永远不会有动力去开发新的技能，而既有的技能也终将过时淘汰。</li>
<li>以用户为出发点进行倒推的方法，往往会要求我们锻炼新的技能并动用平时不常练到的肌肉，绝不要将迈出第一步时可能出现的不适与尴尬放在心上。</li>
</ul>
</div>
<p>在 <a href="https://book.douban.com/subject/35771946/">亚马逊逆向工作法</a> 这本书中，作者写到：</p>
<blockquote>
<p>自 2004 年起，亚马逊推出的所有重要产品和计划，大都具有一个共同的、非常鲜明的亚马逊特色：他们的诞生都经历过我们所说的“逆向工作”流程。</p>
<p>“逆向工作”对公司的成功起着关键作用。“逆向工作”是一种审查想法、创造新产品的系统性方法。其关键原则是：</p>
<ul>
<li>首先思考客户体验</li>
<li>然后由此反复逆向工作</li>
<li>直到团队对要建造的产品拥有清晰的想法</li>
</ul>
</blockquote>
<p>因此，当我第一次读到关于“逆向工作”的内容后，这引起了我内心深处强烈的共鸣。同时我又庆幸，自己当时能够突破自我，勇敢的闯了下去，毕竟在事情没开始之前，谁能预知自己就能解决所有的问题呢？</p>
<h2 id="度知了的成长-逆康威定律">度知了的成长——逆康威定律</h2>
<p>工作依然在平凡而又偶尔充满惊喜的节奏中前行，2020 年，基于在“虚拟摄像头”项目中补足的音视频专业技能，我又启动了新的方向：视频质量评测。那个时候，视频质量评测还没有引起大家足够的重视，但是我朦胧中认为评测终将会在音视频领域占据一席之地。那个时候，<a href="https://www.livevideostack.cn/">LiveVideoStack</a> 已经在音视频领域非常火，我怎么也不会想到，有朝一日，我也能站在 LiveVideoStack 大会的讲台上，向业界朋友介绍我们在视频质量评测工作上的认知和实践。</p>
<p>随着时间继续往前推移，在 2021 年的时候，我们的视频质量评测平台在内部也取得了不错的应用效果，很多其它业务线的同学也慕名而来，希望可以一起合作。然而，随成长而来的不只有内心的兴奋，在平台不断成长壮大的过程中，烦恼也会随着而来：</p>
<ul>
<li>如果让评测结果更符合线上用户的实际感知？</li>
<li>如何才能让评测的结果更置信？</li>
<li>如何才能实现规模化的评测系统？</li>
<li>……</li>
</ul>
<p>恰巧，在这个时候，我读到了一本至今看来都让我受益匪浅的书：<a href="https://teamtopologies.com/"><em>Team Topologies: Organizing business and technology teams for fast flow</em></a>，这本书的中文译本就是非常有名的 <a href="https://item.jd.com/12880565.html">《高效能团队模式：支持软件快速交付的组织架构》</a>。这本书中的两个核心观点给了我思路：</p>
<ul>
<li>团队而非个人是组织的基本构件单元，要把团队摆在第一位，并将认知负荷作为建立团队边界的有力工具</li>
<li>逆康威定律</li>
</ul>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">康威定律&逆康威定律
</p><ul>
<li>
<p>1968 年，梅尔·康威发表了一篇论文：How Do Committees Invent?，在这篇论文中，康威研究了组织结构和最终系统设计之间的关系。这也就是后来的<code>康威定律</code>：<em>设计系统的组织由于受到约束，这些设计往往是组织内部沟通结构的副本</em>。</p>
</li>
<li>
<p>2015 年，ThoughtWorks 的技术总监 James Lewis 突发奇想地提出应用<code>逆康威定律</code>：<em>组织要根据他们想得到的软件架构来设计团队结构，而不是期望团队盲从一个被设计好的团队结构。</em></p>
</li>
</ul>
<blockquote>
<p>如今一直火得一塌糊涂的“微服务架构”就是 James Lewis 在一次架构峰会上提出来的，具体可参见 <a href="https://wangwei1237.github.io/monolith-to-microservices/docs/What_Are_Microservices.html">“微服务”一词的历史</a>。</p>
</blockquote>
</div>
<p>实际上，“逆康威定律”本质上是一种特殊的“逆向倒推法”，根据合理的软件架构来调整组织结构，而不是让软件架构受制于组织构成。在组织与技术架构这个特殊的领域中，“逆向倒推法”有了一个更为高大上的说法，仅此而已。</p>
<p>于是我开始重新进行思路调整：</p>
<ul>
<li>以视频质量评测的最终目标（置信、效率）重新调整技术路径
<ul>
<li>端到端的视频质量评测能力，打通PC、Android、iOS三端能力</li>
<li>各种算法的深入分析和深度优化，并集成到现有的平台能力</li>
</ul>
</li>
<li>以提供一站式评测服务的最终目标来重新调整团队的结构
<ul>
<li>明确团队的认知负荷，不再一味强调自研，转而寻求其他团队的优秀人员，协同共创价值</li>
<li>遇水搭桥，逢山开路，自建众测团队</li>
</ul>
</li>
<li>……</li>
</ul>
<blockquote>
<p>更多的细节也可以参考另一篇文章 <a href="/2022/09/05/How-to-break-through-the-resource-limitation-and-create-the-more-value/">如何突破资源限制，创造更大的价值？</a> 以及 <a href="https://mp.weixin.qq.com/s/J2QGTiMOgMnZbAyI81I87Q">《百度视频质量评测的实践之路》</a>。</p>
</blockquote>
<p>基于这样的思路，我们慢慢建设并不断优化视频质量评测系统：<a href="/2023/02/13/duzhiliao/">度知了</a>。时至今日，度知了依然在各个视频业务中发挥着非常重要的作用，我们也依然在路上——今天依然是第一天。</p>
<h2 id="基于目标的全局最优解">基于目标的全局最优解</h2>
<p>在 Sam Newman 的 <a href="https://samnewman.io/books/monolith-to-microservices/">Monolith To Microservices</a> 一书的第 <a href="/monolith-to-microservices/docs/Global_Versus_Local_Optimization.html">5.9节局部优化VS.全局优化</a> 中写道：</p>
<blockquote>
<p>假设团队对自己的本地决策负有更多的责任，团队或许会拥有他们所管理的微服务的整个生命周期，那么我们需要考虑在本地决策与更多的全局指标之间做出平衡。</p>
<p>很难期望在微服务迁移的早期旅程中就发现这种问题，随着时间的推移，每个团队将越来越专注于自己的本地问题，并将基于本地问题来优化他们解决问题的方式。</p>
</blockquote>
<p>2022 年春天的时候，我们遇到了评测效率的问题。这个时候，参与到“度知了”项目中的角色也越来越多，大家也都卯足了劲儿，在各自的工作范畴内做各种优化来提升评测效率。虽然会有改善，但总也无法满足业务方越来越多的评测需求。</p>
<p>这个时候，我们基于评测目标的全局视角对评测全流程各环节进行了详细的梳理，对不同的环节进行了归并、删减，对不同环节的时序进行了全局最优调整，最后在每个环节内部操作进行各种优化手段。在全局层面，我们增加了任务自动拆分，任务自动调度执行，结果自动聚合等能力；在算子内部，我们还通过优化算子来提升算子的计算效率……</p>
<p>在 2022 年的夏始春余之际，“度知了”从整体服务流程上变的面貌全新了，这个时候，整体的评测效率也有了非常大的突破，我们也解决了之前存在的评测效率的问题。</p>
<p><img src="/2023/07/09/My-practice-of-working-backwards/4.png" alt></p>
<h4 id="结构优化是核心">结构优化是核心</h4>
<p>如果你问我，在效率提升的过程中，做的最成功的决策是什么？我想，这个答案会是：基于目标而进行的系统结构的调整。</p>
<p>我们现在都在讲“端到端”的优化，“端到端”的含义非常广泛：</p>
<ul>
<li>系统的层级架构</li>
<li>系统的流程架构</li>
<li>用户的全流程声明周期</li>
<li>……</li>
</ul>
<p>有时候，我们确实是在做“端到端”优化，但是却是在既有的架构、流程下来进行的“端到端”优化，而这种层面的“端到端”优化，有时候收效甚微，就像我们在 2022 年春年遇到的困境那样。</p>
<p>“逆康威法则”的本质意味着，如果要实现质的飞跃，端到端优化首要的、也最核心的首先是系统结构的调整。首先要从基于目标，从全局视角对结构进行调整，然后在深入到每个具体环节中进行局部调整，最终才会实现“端到端”的最优解。</p>
<p>在 <a href="https://book.douban.com/subject/11528220/">系统之美</a> 这本书中，对系统作出如下的定义：</p>
<blockquote>
<p>系统并不仅仅是一些事物的简单集合，而是一个由一组相互连接的要素构成的、能够实现某个<strong>目标</strong>的整体。</p>
</blockquote>
<p>对于实现特定<strong>目标</strong>的系统而言，要素很重要，但是连接更为重要。结构决定性质，性质决定用途，就是这个样子。同样都是由 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span></span> 原子构成，石墨和钻石的结构不同决定了其性质存在非常大的差异。</p>
<p><img src="/2023/07/09/My-practice-of-working-backwards/7.png" alt></p>
<blockquote>
<p>图片中的结构模型由 <a href="https://molview.org/">molview</a> 工具生成。</p>
</blockquote>
<p>当基于效率目标对“度知了”系统进行了结构调整和优化之后，我们惊奇的发现，评测效率问题不但就这样迎刃而解了，而且整个系统看起来还更加紧凑。忽然间，想起了多年以前和同事闲聊，谈到为什么系统总是出问题时的场景：</p>
<blockquote>
<p>我们的系统，其原型是一个“三角形”，但是随着时间的推移，用户需求变成了“水桶”。所以，这个“水桶”其实是用“三角形”不断地逼近的结果，而其本质上并不是“水桶”。无论我们在构成水桶的每块“三角形”上做任何的优化，最终还是会出现问题。</p>
</blockquote>
<h2 id="基于目标的拆解与整合">基于目标的拆解与整合</h2>
<p>不知不觉，时针指向了 2022 年的秋天，北京的秋天是一年之中最美丽的季节。而此时，度知了也已经成为规模比较大的视频质量评测服务。</p>
<p>忽然有一天，我开始以后验视角回顾这整个过程。我发现，整个过程中，始终基于目标的自顶向下的拆解与自底向上将各种优化手段再次整合成为目标的正反双循环的思路，在整个度知了的成长历程上，发挥着举足轻重的作用。</p>
<p><img src="/2023/07/09/My-practice-of-working-backwards/5.png" alt></p>
<p>贝佐斯在 <a href="https://mp.weixin.qq.com/s/Q-dS6YNUcdRFqYFu4zWoDQ">2007 年致股东信</a> 中介绍 Kindle 时写道：</p>
<blockquote>
<p>任何事情，只要降低难度和减少阻力，便会遍地开花。</p>
</blockquote>
<p>基于目标的自顶向下的拆解，可以使得目标难度最小化，只有这样优化才会成为可能，路径才会得以实现，否则就容易造成望而却步的窘境，尤其是当团队成员正在突破自己的认知负荷的前提下。</p>
<p>拆解是能力，整合是控制力，当所有事情拆解完毕后，我们需要确保所有的优化最终能够整合到一个具体的产品上，这有这样，使用这个产品的门槛才会降低。当整个过程的正、反双循环打通之后，这个事情自然而然也就成功了。</p>
<p>在整个拆、合的过程中，目标是其背后的最核心的关节点。早在 2020 年的时候，还没有明确 “视频质量评测产品化” 的目标，虽然那个时候，我们也在优化各种算法，但是最终也就是仅仅优化了而已。因此，我们始终在优化各种问题的层面转圈，最终又很难将所做的所有优化进行整合并阐述其价值。现在想想，那个时候还是很焦虑的：技术上确实有进步，但是说不清楚技术的价值。直到我们明确了目标之后，事情才变得好了起来，所有的优化都可以体现到“度知了”的产品上了。</p>
<p><img src="/2023/07/09/My-practice-of-working-backwards/6.png" alt></p>
<p>从问题切入有利于解决眼下的事情，而基于目标的思维，可以避免被眼下的错综纷扰而迷惑。不识庐山真面目，只缘身在此山中，这是如此。有很多的时候，从更高一层的目标出发，当前的问题可能已经不是问题了。</p>
<blockquote>
<p>我们已经走得太远，以至于忘记了为什么而出发。——《先知》，纪伯伦</p>
</blockquote>
<h2 id="试点陷阱">试点陷阱</h2>
<p>我们过于自信，总认为我们的优化肯定是最完美的方案；同时我们又过份的忧虑，总担心如果采用新的方案会对现有业务带来非预期的影响。</p>
<p>我们即追求创新，又害怕承担创新可能带来的损失局面（创新总要付出代价），在自信与害怕的矛盾心理下，我们选择了一种比较折中的方案：试点。我们会先在一个小的、可控的范围内对优化进行试点，如果试点结果不好，那么这项优化就可以提前结束了；而如果试点结果很好，那接下来怎么办呢——“To do or not to do,that’s a question”。</p>
<p>面对一个庞杂的软件系统，如果想使用更高级的语言来重构这个系统，并验证重构的效果，我们会采取怎样的路径？我们可能会先对外围不重要的模块进行重构试点，以增强我们的信心。最终，我们会发现，多年以后，这个系统最核心的 20% 的部分分，依然还在使用着更古老的语言。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">试点陷阱
</p><p>试点一直在路上，但未全面取而代之或者引发质的变革，这种现象我称之为——试点陷阱。</p>
</div>
<p>关于试点陷阱，整体而言，我遇到了如下几种情况：</p>
<ul>
<li>从不重要的模块启动新技术的试点，导致对于系统总体而言，新技术没有体现其优势。</li>
<li>从不重要的项目启动新技术的试点，导致对于团队而言，新技术没有发挥其优势。</li>
<li>在系统全流程的部分流程启动新技术试点，导致对于全流程而言，新的技术没有体现其优势。</li>
</ul>
<p>对于数字化转型，麦肯锡的研究发现，大量制造企业在数字化转型初期的试点非常成功，但在全面推广并取得财务、运营和可持续绩效方面持续改善的过程中却困难重重，74% 的企业在启动数字化项目不久后就泥足深陷。</p>
<p>还好在“度知了”的发展过程中，我们没有踩到“试点陷阱”。这并不是我们不想踩“试点陷阱”，而是优化的紧迫性以及资源的限制并没有给我们留下“试点”的机会，我们必须全力以赴，所有的优化必须在下次的全流程评测中得以应用，以保证最终结果的高效和置信。</p>
<p>瞅准目标，不留后路，全力以赴，all-in，往往会有意想不到的收获。一旦我们有 Plan B，在前行的路上，一旦我们遇到风吹草动，我们就会不自然的想到 Plan B进而陷入“试点陷阱”，我们就会在纷繁错综的环境中错失机会。</p>
<h2 id="先验与后验">先验与后验</h2>
<p>时间在悄然间流逝，年华在匆匆中而过，不经意间，时针已经悄悄指向了 2023 年，机缘巧合，我的工作范围也在不断扩大，也慢慢学会了以后验的视角来审视自己工作的技巧。</p>
<p>最近，在刷抖音时，惊喜地收到一条关于介绍“运算放大器”的视频推送：​将“运算放大器”的输出和负输入相连接时，会产生非常美妙的特性曲线，而这个曲线也奠定了“运算放大器”在电子世界中的地位。</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=314781365&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<p>忽然在想：如果将后验的认知输入到先验作为一种负反馈闭环，那么打通正向、反向双循环之后，工作的事项岂不是可以像“运算放大器”那样更有价值？</p>
<p>于是，在最近的团队核心工作上，我和相关同学对这种先验、后验双向闭环的方式进行了实践，最终也发现确实这是一种非常有效的方式。</p>
<p>后来想想，这种先验、后验和“逆向倒推”也有一定的相似之处，“逆向倒推”让我们开启行程，而后验会让我们在行程中不断调整步伐和方向，以使得我们可以更好的达到终点。</p>
<p>先验是能力，后验是执行力。站在当下看未来，我们将如何行动，这需要强大的先验能力；而站在当下看过去，我们又有哪些得失，这些得失是否可以作用于未来，为我们前行做出指导，这需要强大的执行力。</p>
<p><img src="/2023/07/09/My-practice-of-working-backwards/8.png" alt></p>
<h2 id="总结">总结</h2>
<p>道理纵有千千万万，实践总是一件非常难的事情。我们总也无法预知未来，因此更需要我们认准目标，以逆向工作的思路，乘着后验之风，在谨慎而又快速、不断调整的实践中创造未来，创造价值。</p>
<p>凡是过往，皆为序章。今天，仍然是第一天。</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>实践</tag>
        <tag>逆向倒推</tag>
        <tag>逆康威定律</tag>
        <tag>试点陷阱</tag>
      </tags>
  </entry>
  <entry>
    <title>我对 ChatGPT 的思考</title>
    <url>/2023/04/05/my-understanding-for-chatGPT/</url>
    <content><![CDATA[<p><img src="/2023/04/05/my-understanding-for-chatGPT/1.jpg" alt></p>
<p>不经意间，2023 年已经过去了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mn>4</mn></mrow><annotation encoding="application/x-tex">1/4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">/</span><span class="mord">4</span></span></span></span>。到目前为止，如果说科技圈最引人注目的事情，那莫过于 <a href="https://openai.com/blog/chatgpt">ChatGPT</a> 的爆火了。上线仅仅两个月，ChatGPT的活跃用户就突破一亿<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>，其火爆程度，可见一斑。</p>
<span id="more"></span>
<h2 id="chatgpt-发布时间线">ChatGPT 发布时间线</h2>
<p>根据 <em>ChatGPT — Release Notes</em> <sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>，ChatGTP 的关键时间线如下：</p>
<ul>
<li>2022-11-30: ChatGPT正式发布</li>
<li>2022-12-15: 第一次更新
<ul>
<li>提升了总体性能</li>
<li>增加了保存和查看历史对话记录的新功能</li>
</ul>
</li>
<li>2023-01-09: 第二次更新
<ul>
<li>改善了回答的真实性</li>
<li>增加了“停止生成”功能</li>
</ul>
</li>
<li>2023-01-30: 第三次更新
<ul>
<li>提升答案真实性</li>
<li>提升数学能力</li>
</ul>
</li>
<li>2023-02-13: 第四次更新
<ul>
<li>提升了免费版的性能</li>
<li>新增 “ChatGPT Plus” 的国际购买能力</li>
</ul>
</li>
<li>2023-03-14: GPT-4正式发布
<ul>
<li>大型多模态模型</li>
<li>不仅能够阅读文字，还能识别图像，并生成文本结果</li>
</ul>
</li>
<li>2023-03-23: 支持plugins</li>
</ul>
<h2 id="chatgpt-的流行趋势">ChatGPT 的流行趋势</h2>
<p>ChatGPT 发布后的 5 天内，其注册用户就达到了 100W+，在其发布的前两个月，其注册用户数就超过了 1亿。</p>
<h3 id="similarweb-的流量趋势图">similarweb 的流量趋势图</h3>
<p>根据 <a href="https://www.similarweb.com/zh/website/chat.openai.com/#ranking">similarweb</a> 的数据，ChatGPT 每天大概有 5000W 的访问 PV，3000W 的访问 UV。根据当前的增长趋势，预计到 2023 年最后一个季度末，ChatGPT的用户量级将会突破 10 亿<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>。</p>
<p><img src="/2023/04/05/my-understanding-for-chatGPT/2.jpg" alt></p>
<h3 id="google-trend-趋势图">Google Trend 趋势图</h3>
<p>从 <a href="https://trends.google.com/trends/explore?date=2022-11-30%202023-04-14&amp;q=ChatGPT&amp;hl=en">谷歌趋势</a> 的数据也可以看出，ChatGPT 的热度也是持续增加。并且从分地区的热度趋势也能看出，国内技术圈对 ChatGPT 的讨论是最热的。</p>
<p><img src="/2023/04/05/my-understanding-for-chatGPT/3.jpg" alt></p>
<h2 id="chatgpt-的大讨论">ChatGPT 的大讨论</h2>
<h3 id="上榜热搜">上榜热搜</h3>
<p>根据 <a href="https://weibo.zhaoyizhe.com/superInfo.html?topic=ChatGPT">热搜引擎</a> 提供的微博热搜历史数据，我们发现，2022 年 12 月 5 日，ChatGPT 第一次登上微博热搜榜，其最后的在榜时间为 2023 年 3 月 31 日，累计在榜时长达到了 1391 分钟。如果在 <em>热搜引擎</em> 上检索 ChatGPT，我们会发现，直到现在，虽然距离 ChatGPT 的首次发布过去了 4 个月之久，但是对 ChatGPT 的各种讨论依然非常火热。</p>
<p><img src="/2023/04/05/my-understanding-for-chatGPT/4.jpg" alt></p>
<h3 id="两会热点">两会热点</h3>
<p>在 3 月 5 日的十四届全国人大一次会议的首场“部长通道”采访中，科学技术部部长王志刚也对 ChatGPT 发表了自己的看法<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup>。 3 月 9 日，新京报 《两会三人谈》栏目组也邀请了全国政协委员、人工智能专家，对 ChatGPT 为代表的人工智能技术进行了讨论<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>。</p>
<h3 id="llms-大爆发">LLMs 大爆发</h3>
<p>根据 <a href="https://baike.baidu.com/starmap/view?nodeId=e0a309bf5b0f017891c7b859">百科星图</a> 可知，目前谷歌、亚马逊、百度、阿里等多个科技巨头都加入到了 <em>对话式大语言模型</em> 的研发中。</p>
<ul>
<li>2023 年 2 月 6 日，谷歌宣布将推出一款聊天机器人——Bard，2 月 9 日，谷歌 Bard 发布会试演翻车，回答内容出现错误，当日市值暴跌1000亿美元。</li>
<li>2023 年 2 月 24 日，Meta 官宣 SOTA 大语言模型 LLaMA，对非商用的研究用例开源。</li>
<li>2023 年 3 月 14 日，斯坦福发布了一个由 LLaMA 7B 微调的模型 Alpaca，性能和 GPT-3.5 不相上下。</li>
<li>2023 年 3 月 16 日，百度举办“百度文心一言新闻发布会”，正式发布 <em>文心一言</em>。</li>
<li>2023 年 4 月 11 日，阿里在阿里云峰会上，正式宣布推出大语言模型 <em>通义千问</em>。</li>
<li>2023 年 4 月 16 日，百度 CTO 王海峰做客 <a href="http://tv.cctv.com/2023/04/16/VIDE32EopwFYhGR54OaF63KN230416.shtml">CCTV-2《中国经济大讲堂》</a>，阐释 <em>文心一言</em> 这类大语言模型的产品能力、技术原理和产业价值。</li>
<li>……</li>
</ul>
<h2 id="chatgtp-对我们究竟有怎样的影响">ChatGTP 对我们究竟有怎样的影响</h2>
<p>在 <a href="https://book.douban.com/subject/30221932/">知识大迁移</a> 这本书中，作者试图使用 “达克效应” 来解释：信息爆炸时代，为什么人却越来越无知？</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">达克效应
</p><p>康奈尔大学心理学教授大卫·邓宁（David Dunning）和他的研究生贾斯汀·克鲁格（Justin Kruger）通过一系列的实验发现了一种现象：最缺乏知识和技能的人反而最无法认知到自己的这种欠缺。</p>
<p>这一现象后来被称为“邓宁-克鲁格效应（the Dunning-Kruger effect），简称“达克效应”。</p>
</div>
<h3 id="chatgpt-提升生产效率">ChatGPT 提升生产效率</h3>
<p>对于 ChatGPT 而言，有些人惊呼于其强大的能力，并且已经开始使用 ChatGPT 来帮助自己完成各种各样的任务。</p>
<ul>
<li>研究发现，基于 OpenAI 构建的 Github Copilot 可以帮助程序开发人员提升 55% 的开发效率<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>。</li>
<li>在线学习平台 <a href="http://Study.com">Study.com</a> 向 1000 名 18 岁以上学生发起的一项调查显示，超过 89% 的学生承认使用 ChatGPT 来完成家庭作业<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup>。</li>
<li>2023 年 3 月 16 日，微软宣布将推出名为 Copilot 的人工智能服务，并将其嵌入 Word、PowerPoint、Excel 等 Office 办公软件。</li>
<li>……</li>
</ul>
<h3 id="chatgpt-的安全隐患">ChatGPT 的安全隐患</h3>
<p>而另一方面，有更多的对 ChatGPT 认识更深入的个人、组织也对 ChatGPT 所存在的数据安全、隐私安全、政策安全等各方面的安全表示出担忧。</p>
<ul>
<li>2022 年 12 月 6 日，知名开发者问答网站 Stack Overflow 发布一项临时政策：禁用用 ChatGPT 生成内容来回答 Stack Overflow 上的问题。</li>
<li>2023 年 1 月 31 日，全球最大预印本发布平台arXiv宣布新政策：不允许将 ChatGPT 等生成式 AI 工具列为作者。</li>
<li>2023 年 3 月 28日，1000 多名人工智能专家和科技名人联名发布公开信呼吁暂停开发 AGI 系统，署名者包括特斯拉首席执行官、推特掌门人——埃隆·马斯克，马斯克说：“领先的 AGI 开发人员不会注意这个警告，但至少有人说过”。</li>
<li>路透社报道称，意大利个人数据保护局（DPA）宣布从 2023 年 3 月 31 日起禁止使用 ChatGPT，限制 OpenAI 处理意大利用户信息数据，同时对其隐私安全问题立案调查。</li>
<li>……</li>
</ul>
<h3 id="chatgpt-的例子">ChatGPT 的例子</h3>
<p>为了测试 ChatGPT 的能力，我用非常简单的推理题对 ChatGPT 进行了测试，其表现出的效果令人非常激动。<br>
<img src="/2023/04/05/my-understanding-for-chatGPT/ChatGPT_DEMO.gif" alt></p>
<h3 id="chatgpt-对工作的影响">ChatGPT 对工作的影响</h3>
<p>我们都认识到 ChatGPT 将会对我们的工作带来非常大的影响，诚如目前大家所讨论的一样。然而，ChatGPT 对哪些工作会带来影响，会带来哪些具体的影响，却没有人能说的清楚。</p>
<p>2023 年 3 月 17 日， <a href="https://openai.com/">OpenAI</a>、<a href="https://openresearch.com/">OpenResearch</a>、<a href="https://www.upenn.edu/">宾夕法尼亚大学</a> 共同发表了一篇论文 <a href="https://arxiv.org/abs/2303.10130"><em>GPTs are GPTs: An early look at the labor market impact potential of large language models</em></a> 来详细的研究 GPT 这种大语言模型对我们的工作的具体影响<sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup>。</p>
<p>在 <em>GPTs are GPTs</em> 这篇论文中：</p>
<ul>
<li>论文采用了 美国劳工统计局（Bureau of Labor Statistics, BLS）的劳动力市场统计数据和美国求职网站 <a href="https://www.onetonline.org/">O*Net</a> 的职位招聘数据来分析类似 GPT 的 LLMs 对美国不同职业的影响。在论文中，作者定义了 Exposure 的概念来分析 LLMs 对不同职业的影响。</li>
<li>论文中引用了 <a href="https://arxiv.org/abs/2303.08774">GPT-4 Technical Report</a> 中提供的 GPT 在各种考试中的得分情况，从下图中可以看出，GPT 的表现还是非常好的，尤其是在美国生物奥林匹克竞赛、法学院入学考试、高中数学考试、心理学、环境科学……<sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup><br>
<img src="/2023/04/05/my-understanding-for-chatGPT/5.jpg" alt></li>
<li>论文指出，根据分析，80% 的职业中的 10% 的工作会受到 LLMs 的影响。并且，19% 的工作中，至少有 50% 的工作会受到 LLMs 的影响。论文还指出，在 LLMs 的帮助下，15% 的工作可以在同等质量下更快的完成，如果考虑到基于 LLMs 构建的各种工具，这个比例可以提升到 50%。<br>
<img src="/2023/04/05/my-understanding-for-chatGPT/6.jpg" alt></li>
<li>根据论文的研究，对于需要科学分析、批判性思维等技能的工作，LLMs 不会对其带来较大影响，但是对于需要编程、写作等技能的工作，LLMs 会对其带来非常大的影响。并且，准入门槛越高、收入越高的职业越有可能会受到 LLMs 的影响。<br>
<img src="/2023/04/05/my-understanding-for-chatGPT/7.jpg" alt></li>
</ul>
<p>由此，我们可以看出，LLMs 作为一种通用目的技术，必然会对经济、社会的各个方面带来不同层面的冲击。</p>
<p>我们如何面对这种冲击？正视他、学习他、利用他？还是回避他、拒绝他？</p>
<p>我们又如何正确的认识 LLMs 的能力和人的能力之间的异同呢？</p>
<p>就其当前能力而言，LLMs 更多是产生具体的、明确的、预期之内的结果，而作为社会化动物的人而言，这是与 AI 完全不同的最重要的一点。人类在长期的进化过程中所形成的心理、激情、拼搏等，人类对命运的不确定性所展现的风华，目前看 AI 还是很难仅仅通过语料的训练或者一定程度的随机演化而产生。</p>
<ul>
<li>酒逢知己千杯少，人逢喜事精神爽，这种精神层面所赋予的动力，AI 暂时还是不具备的。</li>
<li>在 AI 的评估下，是无法出现像巨鹿之战、官渡之战、赤壁之战等历史星空中的璀璨之星。</li>
</ul>
<p>但是，4 月 12 日发布的，由 GPT-4 驱动的 AutoGPT，其认知能力更为强大。与 ChatGPT 的单次提问、单次回答模式不同，AutoGPT 主打全自动，给定任务，他就可以建立一个自我“思考、行动、观察结果、决定下一步行动、再次行动、再次观察结果”的循环。</p>
<p>根据 B 站 UP 主发布的视频可以发现：AutoGPT 可以实现自己查询文献、学习文献，并最终完成给定论文题目写作的整个过程，而整个过程中出了最开始需要给 AutoGPT 发布任务外，其他环节则全部由 AutoGPT 自动完成。</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=782579587&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<p>《流浪地球》 这部电影中的 MOSS 则是更为智能的 AI 了。作为一台智能量子计算机，MOSS 负责管理空间站事务，是流浪地球计划与火种计划的监督者和执行者。MOSS 会坚定的执行延续人类文明的使命，并能在最短的时间内做出最正确的决定，是趋于完美的智慧体。</p>
<p>电影中，MOSS 经过计算发现根本不可能点燃木星，地球即将发生无法挽回的变故。因此，MOSS 执行了火种计划，强制人类进行休眠，空间站启动逃离程序。与此形成鲜明对比的是，刘培强则怒砸 MOSS，然后利用牺牲自己和空间站的方式，最终成功引燃木星，拯救了地球。</p>
<h2 id="积极拥抱-gpt">积极拥抱 GPT</h2>
<p>GPT 不同版本的参数量和预训练数据量的对比：</p>
<table>
<thead>
<tr>
<th>模型</th>
<th>发布时间</th>
<th>参数量</th>
<th>预训练数据量</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPT</td>
<td>2018 年 6 月</td>
<td>1.17 亿</td>
<td>5GB</td>
</tr>
<tr>
<td>GPT-2</td>
<td>2019 年 2 月</td>
<td>15 亿</td>
<td>40GB</td>
</tr>
<tr>
<td>GPT-3</td>
<td>2020 年 5 月</td>
<td>1,750 亿</td>
<td>45TB</td>
</tr>
<tr>
<td>GPT-4</td>
<td>2023 年 3 月</td>
<td>预估是 1 万亿</td>
<td>–</td>
</tr>
</tbody>
</table>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">大脑神经元和突触
</p><p>人类的大脑大概有 1000 亿个神经元，神经元与神经元之间通过突触“链接”在一起。每个神经元可以通过突触与其他神经元形成 1000 个链接。</p>
</div>
<p>目前看，GPT-3 的参数个数已经和人脑的神经元个数量级一致，并且从目前看，GPT-3 也出现了很多的“涌现能力”<sup class="footnote-ref"><a href="#fn10" id="fnref10">[10]</a></sup>。随着参数个数的不断增大，类似 GPT 的 LLMs 是否能够进化出更多类人的能力也不是一件不可能的事情。在未来相当长的一段时间内，LLMs 的发展是否会超出人类的控制，这也是一件无法预知的事情。</p>
<p>正如 20 世纪，人们很担心被机器取而代之。如今，更多的人开始焦虑：我们是否会被 LLMs 取代？</p>
<p>无论如何，未来已来，LLMs 的存在与发展，对所有人而言，是带来不确定性与焦虑的挑战，更是值得去深思，可以去拥抱，给与天生会使用工具的人类以助力的莫大机遇与法宝。</p>
<p>作为一名普通的工程师，面对这种“不确定性”，与其焦虑，不如相时而动，利用好 LLMs 赋予的力量，挖掘自己无尽的潜能，成为科技浪潮的弄潮儿。</p>
<p>我们要开始学着和 LLMs 为伍，我们要开始学着怎么让 LLMs 帮助我们完成各种之前不可能完成的事情，提升我们的效率。</p>
<p>尤其是对于年轻一代，或者对于那些刚刚步入有非常大的技术门槛的行业的新人来说，LLMs 会赋予我们更强大的技术基础能力。对于我们而言，LLMs 的加持，可以让我们非常轻松的具备之前需要长时间才能积累起来的技术门槛，可以快速打平我们和这个行业、领域的牛人之间的技术差距。</p>
<p>因此，在我看来，LLMs 对于年轻人而言具有非常大的优势，是年轻人弯道超车的强大法宝。</p>
<p>未来，LLMs 也许会具备独立的意识并且各项能力完全超越人类。那时，我们还需要考虑“机器是否会摆脱人的控制”、“人与 LLMs 如何共生”等一系列问题……</p>
<p>过去心不可得，未来心不可得，唯一需要做的就是抓住 LLMs 的机会，靠近他、研究他、使用他。</p>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://seo.ai/blog/chatgpt-user-statistics-facts">ChatGPT User Statistics &amp; Facts (100 million users reached in January 2023)</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://help.openai.com/en/articles/6825453-chatgpt-release-notes">ChatGPT — Release Notes</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://www.demandsage.com/chatgpt-statistics/">ChatGPT Statistics for 2023 (New Data + GPT-4 Facts)</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://baijiahao.baidu.com/s?id=1759507457489651193&amp;wfr=spider&amp;for=pc">关于6G、ChatGPT，全国两会首场“部长通道”最新回应</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://baijiahao.baidu.com/s?id=1759897401604443186&amp;wfr=spider&amp;for=pc">两会三人谈丨ChatGPT是一场“虚火”还是颠覆性技术革命？</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://github.blog/2022-09-07-research-quantifying-github-copilots-impact-on-developer-productivity-and-happiness/">Research: quantifying GitHub Copilot’s impact on developer productivity and happiness</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p><a href="https://study.com/resources/perceptions-of-chatgpt-in-schools">Productive Teaching Tool or Innovative Cheating?</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn8" class="footnote-item"><p><a href="https://arxiv.org/abs/2303.10130">GPTs are GPTs: An early look at the labor market impact potential of large language models</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn9" class="footnote-item"><p><a href="https://arxiv.org/abs/2303.08774">GPT-4 Technical Report</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn10" class="footnote-item"><p><a href="https://arxiv.org/abs/2206.07682">Emergent Abilities of Large Language Models</a> <a href="#fnref10" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>LLM</category>
      </categories>
      <tags>
        <tag>OpenAI</tag>
        <tag>ChatGPT</tag>
      </tags>
  </entry>
  <entry>
    <title>FFmpeg滤镜中的多线程计算</title>
    <url>/2023/03/01/multithreading-operation-in-ffmpeg-filters/</url>
    <content><![CDATA[<p><img src="/2023/03/01/multithreading-operation-in-ffmpeg-filters/1.png" alt></p>
<p>在图像处理中，可以通过滤镜来实现多种多样的图像特殊效果。同样的，在视频处理中，滤镜的概念也基本相似——滤镜指的是在编码之前针对解码器解码出来的原始数据（即音视频帧）进行处理的动作。</p>
<span id="more"></span>
<h2 id="1-ffmpeg-滤镜的基本概念">1. FFmpeg 滤镜的基本概念</h2>
<p>FFmpeg 通过 libavfilter 库来实现滤镜的功能，并且在 FFmpeg 中，可以通过滤镜来对输入视频进行各种各样的处理。</p>
<p>FFmpeg中，滤镜的处理位置如下图所示：</p>
<p><img src="/2023/03/01/multithreading-operation-in-ffmpeg-filters/2.png" alt></p>
<p>例如，如果我们要对一个视频从中间部分进行“镜像”操作，则可以用如下的“滤镜链”来实现：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">                [main]</span><br><span class="line">input --&gt; split ---------------------&gt; overlay --&gt; output</span><br><span class="line">            |                             ^</span><br><span class="line">            |[tmp]                  [flip]|</span><br><span class="line">            |                             |</span><br><span class="line">            +-----&gt; crop --&gt; vflip -------+</span><br></pre></td></tr></table></figure>
<p>在这个“滤镜链”图中，利用 <code>split</code> 滤镜把输入流分离成了两路流，其中一路通过 <code>crop</code> 滤镜和 <code>vfilp</code> 滤镜的同一路级联应用，再同另外一路一起通过 <code>overlay</code> 滤镜处理的流合成并输出最终处理之后的视频。</p>
<p>如上操作对应的 FFmpeg 命令如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg -i INPUT -vf &quot;split [main][tmp]; [tmp] crop=iw:ih/2:0:0, vflip [flip]; [main][flip] overlay=0:H/2&quot; OUTPUT</span><br></pre></td></tr></table></figure>
<p>更详细的 FFmpeg 滤镜的相关内容可以参考 <a href="http://ffmpeg.org/ffmpeg-filters.html">FFmpeg Filters Documentation</a>。</p>
<h2 id="2-ffmpeg-滤镜开发简介">2. FFmpeg 滤镜开发简介</h2>
<p>根据 <a href="https://trac.ffmpeg.org/wiki/FilteringGuide">FFmpeg Filtering Guide</a>，可以在 <a href="https://wiki.multimedia.cx/index.php/FFmpeg_filter_HOWTO">FFmpeg filter HOWTO</a> 的帮助下来编写 FFmpeg 滤镜，为 FFmpeg 增加新的能力。</p>
<p>但是，根据个人经验，在开发滤镜时，我更建议把 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/doc/writing_filters.txt">FFmpeg/doc/writing_filters.txt</a> 作为滤镜开发指南。</p>
<h2 id="3-多线程滤镜开发">3. 多线程滤镜开发</h2>
<p>FFmpeg 滤镜会涉及到大量的计算，因此，如果可以采用多线程的方式来加速滤镜的计算，对于有效率要求的场景而言将是一大福音。</p>
<p>根据 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/doc/writing_filters.txt">FFmpeg/doc/writing_filters.txt</a> 的说明，到目前为止，对于滤镜而言，FFmpeg 仅支持 <code>slice-级别</code>多线程（还不支持<code>帧-级别</code>多线程）。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">slice 基本概念
</p><p><img src="/2023/03/01/multithreading-operation-in-ffmpeg-filters/3.jpeg" alt>
<br> 如上图所示，在滤镜计算过程中，视频帧被分割成若干单独的 <code>slice(切片)</code>，不同的 <code>slice</code> 可以同时并行执行滤镜操作。</p>
<p>实际上，在计算过程中，可以简单的把 <code>slice</code> 理解为由多行构成的帧数据。因此，<code>slice-级别</code> 的多线程实际上就是按行将图像拆分为多个 <code>slice</code>，然后多个 <code>slice</code> 之间并行执行滤镜计算。</p>
</div>
<h3 id="3-1-slice-分割">3.1 slice 分割</h3>
<p>对于单线程的滤镜操作，整体代码实现如下所示：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; inlink-&gt;h; y++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (x = <span class="number">0</span>; x &lt; inlink-&gt;w; x++) &#123;</span><br><span class="line">        dst[x] = foobar(src[x]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了使如上的代码可以进行 <code>slice-级别</code> 的并行计算，需要做如下的修改：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="keyword">for</span> (y = slice_start; y &lt; slice_end; y++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (x = <span class="number">0</span>; x &lt; inlink-&gt;w; x++) &#123;</span><br><span class="line">        dst[x] = foobar(src[x]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中，<code>slice_start</code>，<code>slice_end</code> 在回调函数 <code>avfilter_action_func</code> 中根据线程的数量来定义，一般而言，其定义的代码如下所示：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> slice_start = (in-&gt;height *  jobnr     ) / nb_jobs;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> slice_end   = (in-&gt;height * (jobnr + <span class="number">1</span>)) / nb_jobs;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-定义-threaddata">3.2 定义 ThreadData</h3>
<p><code>avfilter_action_func</code> 的定义位于 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavfilter/avfilter.h">libavfilter/avfilter.h</a> 中：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A function pointer passed to the @ref AVFilterGraph.execute callback to be</span></span><br><span class="line"><span class="comment"> * executed multiple times, possibly in parallel.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param ctx the filter context the job belongs to</span></span><br><span class="line"><span class="comment"> * @param arg an opaque parameter passed through from @ref</span></span><br><span class="line"><span class="comment"> *            AVFilterGraph.execute</span></span><br><span class="line"><span class="comment"> * @param jobnr the index of the job being executed</span></span><br><span class="line"><span class="comment"> * @param nb_jobs the total number of jobs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return 0 on success, a negative AVERROR on error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(avfilter_action_func)</span><span class="params">(AVFilterContext *ctx, <span class="keyword">void</span> *arg, <span class="keyword">int</span> jobnr, <span class="keyword">int</span> nb_jobs)</span></span>;</span><br></pre></td></tr></table></figure>
<p>根据如上的文档可知，为了使得 <code>avfilter_action_func</code> 可以并行执行，需要通过 <code>arg</code> 参数将滤镜执行需要的数据传递到回调函数中。一般而言，可以通过定义一个 <code>ThreadData</code> 的结构来打包滤镜计算所需要的信息：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ThreadData</span> &#123;</span></span><br><span class="line">    AVFrame *in, *out;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125; ThreadData;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-修改-filter-frame">3.3 修改 filter_frame</h3>
<p>最后，在 <code>filter_frame()</code> 中，我们需要调用 <code>threading distributor</code> 以实现滤镜的并行执行。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ThreadData td;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">td.in  = in;</span><br><span class="line">td.out = out;</span><br><span class="line"></span><br><span class="line">ff_filter_execute(ctx, filter_slice, &amp;td, <span class="literal">NULL</span>, FFMIN(outlink-&gt;h, ff_filter_get_nb_threads(ctx)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<h3 id="3-4-修改-avfilter-flags">3.4 修改 AVFilter.flags</h3>
<p>到此为止，我们已经让滤镜具备的多线程并行执行的能力，但是为了能够实现并行计算的能力，我们还要修改 <code>AVFilter.flags</code>，并为其增加 <code>AVFILTER_FLAG_SLICE_THREADS</code> 属性。</p>
<p>在 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavfilter/avfilter.h">libavfilter/avfilter.h</a> 中，<code>AVFILTER_FLAG_SLICE_THREADS</code> 的定义如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The filter supports multithreading by splitting frames </span></span><br><span class="line"><span class="comment"> * into multiple parts and processing them concurrently.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AVFILTER_FLAG_SLICE_THREADS         (1 &lt;&lt; 2)</span></span><br></pre></td></tr></table></figure>
<h2 id="4-多线程滤镜-demo">4. 多线程滤镜 Demo</h2>
<p>在 <a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2023/03/01/multithreading-operation-in-ffmpeg-filters/vf_ms.c">vf_ms.c</a> 中，我们实现了一个简单的滤镜，该滤镜仅提供了一个参数（<code>ms</code>）用来控制是否启用多线程。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -<span class="built_in">help</span> filter=ms</span></span><br><span class="line"></span><br><span class="line">Filter ms</span><br><span class="line">  Test for the multithreading filter.</span><br><span class="line">    slice threading supported</span><br><span class="line">    Inputs:</span><br><span class="line">       #0: default (video)</span><br><span class="line">    Outputs:</span><br><span class="line">       #0: default (video)</span><br><span class="line">ms AVOptions:</span><br><span class="line">   ms                &lt;boolean&gt;    ..FV....... Multithreading or not (default false)</span><br></pre></td></tr></table></figure>
<p>在相同的机器上对如上滤镜进行测试，在不开启多线程的情况下，其性能如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -i ./test.mp4 -vf ms=ms=0 -f null -</span></span><br><span class="line"></span><br><span class="line">frame= 2455 fps= 88 q=-0.0 Lsize=N/A time=00:01:43.12 bitrate=N/A speed=3.71x</span><br></pre></td></tr></table></figure>
<p>在开启多线程时，其性能如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -i ./test.mp4 -vf ms=ms=1 -f null -</span></span><br><span class="line"></span><br><span class="line">frame= 2455 fps= 97 q=-0.0 Lsize=N/A time=00:01:43.12 bitrate=N/A speed=4.07x</span><br></pre></td></tr></table></figure>
<p>当然，如上的测试不是一个严格的测试过程，因此并不能用该测试来证明启用多线程就一定能提升滤镜的性能。但是，从如上的对比可知，开启多线程计算时，针对该滤镜算法，其性能大概有 10% 左右的提升。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title>「度知了」使用指南</title>
    <url>/2023/02/13/duzhiliao/</url>
    <content><![CDATA[<h2 id="画质评测利器-度知了">画质评测利器——度知了</h2>
<p>经过 2 年多的打磨，经历近 5000+ 主观评估，400,000+ 评估样本，1000+ 评测人员（专家和普通用户），趟过一个又一个的坑，利用技术解决实际评测中遇到的一个又一个的不置信因素，高效的视频画质评估系统『度知了』终于迎来面世。</p>
<p>度知了基于 ITU 标准，依托自研的 10+ 项专利技术，在不断实践的基础之上而形成的一款支持多端（PC，Android，iOS）评测的视频画质评测服务。</p>
<span id="more"></span>
<p>本文将详细介绍自研的画质评测系统『度知了』的使用方式，以及我们如何利用度知了来客观、置信、高效地评测视频画质，进而提升用户体验。</p>
<h2 id="评测入门">评测入门</h2>
<p>为了提升评测结果的置信度，我们准备了一些评测样例供用户参考。这些样例均为在画质上存在显著区别的视频，尽管个体感受存在差异，但是在这些示例视频上是可以达成共识和一致结果的。<br>
其次，我们也准备了一些指导文档，帮助用户快速入门，了解一些视频画质相关的基础知识。<br>
<img src="/2023/02/13/duzhiliao/1-sample.png" alt></p>
<h2 id="一-安装">一、安装</h2>
<p>目前『度知了』已上架各大商店应用市场</p>
<ul>
<li>安卓端：华为应用商店、百度手机助手、小米应用商店、oppo应用商店、vivo应用商店可直接搜索『度知了』进行安装。</li>
<li>ios端：App store搜索『度知了』进行安装。</li>
</ul>
<h2 id="二-创建任务">二、创建任务</h2>
<h3 id="2-1-快捷创建">2.1 快捷创建</h3>
<p>可以通过如下图指引三步完成APP端快捷创建一个评测任务<br>
<img src="/2023/02/13/duzhiliao/1_createTask.png" alt></p>
<!-- #### Step 1. 点击首页下方+号，进入创建任务页面
#### Step 2. 如果评测任务无保密要求，点击确认创建即可
#### Step 3. 选择模板、填写测试样本地址、选择可视范围后完成创建 -->
<p>第三步中要填写的内容如下：</p>
<h4 id="1-选择模板">1）选择模板</h4>
<p>目前可选的任务模板包括：短视频主观折损对折损（如下图左）、小视频主观折损对折损（如下图右）。可根据评测样本的视频类型按需选择。<br>
<img src="/2023/02/13/duzhiliao/2-template.png" alt></p>
<h4 id="2-评测样本地址">2）评测样本地址</h4>
<p>此处需要给出一个可解析的csv文件地址，csv文件内容如下表所示，第一行不进行解析，可随意填写，第二行开始每行为一组对比视频的地址，左边为参考视频地址，右边为对比视频地址。在评测时每组视频会以左右随机的顺序呈现给用户。<br>
参考地址：<a href="http://bj.bcebos.com/baidu-rmb-video-cover-1/2022-9/1662380786685/480P-test.csv">http://bj.bcebos.com/baidu-rmb-video-cover-1/2022-9/1662380786685/480P-test.csv</a></p>
<!-- ![](3_csvDetail.png) -->
<table>
<thead>
<tr>
<th>url1</th>
<th>url2</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://video1.mp4">http://video1.mp4</a></td>
<td>http://video1_compared.mp4</td>
</tr>
<tr>
<td><a href="http://video2.mp4">http://video2.mp4</a></td>
<td>http://video2_compared.mp4</td>
</tr>
<tr>
<td><a href="http://video3.mp4">http://video3.mp4</a></td>
<td>http://video3_compared.mp4</td>
</tr>
</tbody>
</table>
<h4 id="3-可视范围">3）可视范围</h4>
<p>如评测任务无保密要求，可直接选择【暂无】，点击【确认创建】按钮完成创建。<br>
如果任务的保密要求较高，可继续通过2.2创建用户隔离的任务。</p>
<h3 id="2-2-仅产品线内用户可见">2.2 仅产品线内用户可见</h3>
<p>考虑到部分评测任务涉及到视频内容保密等情况，我们通过创建产品线-邀请入组的方式来保证此类任务只对组内成员开放。</p>
<h4 id="step-1-创建产品线">Step 1. 创建产品线</h4>
<p>选择底部导航栏中【我的】页面，创建产品线一栏中填写新业务线名称，点击【确认创建】就可以生成新的产品线并自动加入到该产品线中。同时会生成一个6位数的邀请码。<br>
<img src="/2023/02/13/duzhiliao/5-createProduct.png" alt></p>
<h4 id="step-2-创建包含组织的任务">Step 2. 创建包含组织的任务</h4>
<p>按照如下图所示步骤，在【选择可视范围】一栏中选择上一步创建的产品线，点击【确认创建】即可创建出只对该产品线成员可见的任务。<br>
<img src="/2023/02/13/duzhiliao/6-createTaskWithProduct.png" alt></p>
<h4 id="step-3-邀请用户加入产品线">Step 3. 邀请用户加入产品线</h4>
<p>被邀请的用户在【我的】页面【加入产品线】一栏中，输入组织邀请码，点击【确认加入】，即可加入到对应的产品线中。<br>
<img src="/2023/02/13/duzhiliao/10-joinGroup.jpg" alt></p>
<!-- ![](7-create.png) -->
<h2 id="三-评测任务">三、评测任务</h2>
<p>点击底层导航栏选择【视频评测】或【图片评测】进入评测列表页，选择目标任务进入评测任务的说明页面，该页面详细介绍了评估的注意事项、打分的标准等信息。点击【去测评】按钮，进入评测详情页，逐条打分直至本组任务评完，即完成评测。</p>
<!-- ![](8-startTask.png) -->
<p><img src="/2023/02/13/duzhiliao/9-startEvaluate.png" alt></p>
<h2 id="四-结束任务及查看结果">四、结束任务及查看结果</h2>
<p>在创建的任务中可以对用户评测结果进行计算和结果查看，点击【计算】后后台会开始统计用户的平均MOS打分，当按钮变成【查看结果】时，即可点击查看每个视频对及对应的MOS打分。<br>
<img src="/2023/02/13/duzhiliao/11-endTask.png" alt></p>
<p>对于对比视频B和参考视频A比较得到的 MOS 分和划分档次对应关系如下：</p>
<table>
<thead>
<tr>
<th>MOS</th>
<th>档位</th>
</tr>
</thead>
<tbody>
<tr>
<td>0-39</td>
<td>负向</td>
</tr>
<tr>
<td>40-59</td>
<td>持平</td>
</tr>
<tr>
<td>60-100</td>
<td>正向</td>
</tr>
</tbody>
</table>
<h2 id="度知了app支持的评测场景">度知了APP支持的评测场景</h2>
<p>上面介绍了在度知了创建任务、评测、查看结果的整个流程，目前度知了已支持丰富的评测场景和完备的评测能力，具体能力如下：</p>
<table>
<thead>
<tr>
<th>能力项</th>
<th>场景说明</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>设备&amp;终端</td>
<td>PC、iOS、Android</td>
<td></td>
</tr>
<tr>
<td>评测标准</td>
<td>ACR、DCR、CCR</td>
<td>CCR 的评估支持左右视频随机混淆的能力</td>
</tr>
<tr>
<td>媒体类型</td>
<td>视频、图片</td>
<td></td>
</tr>
<tr>
<td>视频格式-1</td>
<td>SDR、HDR</td>
<td></td>
</tr>
<tr>
<td>视频格式-2</td>
<td>横版视频、竖版视频</td>
<td></td>
</tr>
<tr>
<td>终端显示-1</td>
<td>横版视频16:9视窗、横版视频3:2视窗</td>
<td>横版视频的不同视窗支持：ACR，DCR，CCR</td>
</tr>
<tr>
<td>终端显示-2</td>
<td>视频播放模式评测、视频单帧模式评测</td>
<td></td>
</tr>
<tr>
<td>终端显示-3</td>
<td>华为鸿蒙系统视频超分能力：ACR，DCR，CCR</td>
<td>CCR 的评估支持左右视频随机混淆的能力</td>
</tr>
<tr>
<td>横版视频CCR 对比方式</td>
<td>16:9 视窗单屏对比、3:2 视窗单屏对比、全屏左右对比、全屏左右滑动对比</td>
<td></td>
</tr>
<tr>
<td>竖版视频CCR对比方式</td>
<td>全屏左右对比、全屏手动切换对比</td>
<td></td>
</tr>
<tr>
<td>评测方式</td>
<td>普通用户评测、专家多维度评测</td>
<td></td>
</tr>
<tr>
<td>打分方式</td>
<td>5级打分、资源异常打分、备注信息上报</td>
<td></td>
</tr>
</tbody>
</table>
<!-- 短视频对比评测：
![](4-1duanshipin.png) -->]]></content>
      <categories>
        <category>IVQA</category>
      </categories>
      <tags>
        <tag>视频评测</tag>
        <tag>画质评测</tag>
        <tag>度知了</tag>
      </tags>
  </entry>
  <entry>
    <title>关于健身，关于工作</title>
    <url>/2023/02/04/fitness-and-work/</url>
    <content><![CDATA[<p><img src="/2023/02/04/fitness-and-work/1.png" alt></p>
<blockquote>
<p>根据 <a href="https://baijiahao.baidu.com/s?id=1748260598565473604">2022年轻人潮流健身报告</a>，我们发现，年轻人开始相信开始相信「运动即正义」，越来越多的年轻人加入到健身的行列中。</p>
</blockquote>
<p>作为一项“反人性”的运动，参与的人很多，长久坚持的人很少。据统计，健身房会员中，能坚持 1 年不间断健身的人比例为 1/150，能坚持 3 年不间断健身的人比例为 1/1000。</p>
<p>作为一个想变胖的瘦子，我也开启了我的健身之旅。在这个过程中，我慢慢的发现，健身和工作其实有些时候是相通的。</p>
<span id="more"></span>
<h2 id="1-明确健身目标">1. 明确健身目标</h2>
<p>健身要有一个非常明确的、具体的目标，比如：增肌、减脂；不能是：增强体质、提升气质、舒缓压力等这些比较抽象的概念。</p>
<p>增肌和减脂的运动方式并不一致，腹肌和背部的训练动作也不一样，如果没有明确的目标，就没办法制定合理的运动计划，也没办法在运动过程中获得运动的反馈信息，更无法感受到进步的快乐，最后只能是不了了之。</p>
<p><img src="/2023/02/04/fitness-and-work/2.png" alt></p>
<p>比如增肌属于一个科学抗阻训练的过程，增肌需要大量的力量训练（当然也需要摄入更多卡路里和蛋白质），以此达到增加肌肉量的目的，让自己看起来更有力量感。明确增肌的目标后，需要制定一系列相关的二级目标：体重、体质率、肌肉维度、抗阻重量……，然后根据这些目标制定相关的阻抗训练计划，比如三分化、五分化等。</p>
<p>在训练过程中，可以非常方便的测量这些二级目标，因此能够快速得到运动反馈，并根据这些反馈信息来判断运动效果和增肌目标达成的情况，同时还方便我们根据反馈信息来调整自己的运动计划，以达到更好的效果。</p>
<h2 id="2-注重理论学习">2. 注重理论学习</h2>
<p>健身之前，一直有个思维误区：锻炼嘛，练就是了，什么增肌，什么减脂，动起来就行。所以，最开始，我就一直在跑步机上待着，然后跑累了随便摆弄几下其他的器械，1年下来，体重就是没有增加。</p>
<p>实际上，增肌是一道复杂的数学题。对身体进行若干输入，得到增肌目标的输出。输入涵盖了训练、饮食和休息，休息包括了组间休息与睡眠；输出就是你想要达成的身材目标。对于严格的训练而言，锻炼什么肌群，采用什么动作，如何安排需求，如何安排饮食等都需要进行精细的计算。</p>
<p>增肌又是一道复杂的物理题，例如做哑铃弯举时，哑铃把我们的肱二头肌由中间往两端拉开，此时肌肉所承受的 “机械张力”会刺激身体，进而合成更多的肌蛋白。</p>
<p>因此，为了让运动效果更高效，我们还要了解和健身相关的其他理论，例如：运动生理学，运动解剖学，人体力学等，这样能够最大可能的在运动过程中做到运动保护，另一方面有利于我们选择最高效的训练动作。</p>
<p>否则，盲目地去健身，不仅无法达到健身目标，反而损伤了自己的身体健康，白白地浪费了自己的时间和精力。</p>
<h2 id="3-善于合作训练">3. 善于合作训练</h2>
<p>在健身过程中，配合训练是可以让自己快速进步的一种有效方式。在训练过程中，越是大的肌群，例如胸部肌群、腿部肌群，越是需要配合训练。和独自训练相比，配合训练往往可以达到事半功倍的效果：</p>
<ul>
<li>健身搭档的加入，能够激起拼搏心理，从而激发自己的训练斗志。</li>
<li>健身搭档的辅助可以更有效的保护自己，尤其是对于卧推这种运动，有健身搭档，我们会更有安全感，从而可以挑战更大的重量。</li>
<li>在训练过程中，健身搭档就像监控一样，可以纠正我们的错误动作，让我们更好的完成训练动作。</li>
</ul>
<p>在健身的过程中，学会成为一名优秀的健身搭档和健身一样重要。不要以为辅助别人训练是一种浪费时间的行为，正所谓：赠人玫瑰手留余香。作为健身搭档，需要了解再什么情况下需要给予辅助，需要给予怎样的辅助才能帮助训练者获得最好的效果。只有不断地帮助别人，帮助更优秀的人，自己才有可能得到更优秀的人的帮助，自己的进步也才会更快。封闭的独自训练，没有反馈，缺乏挑战和激励，成长也会更慢。</p>
<h2 id="4-持续训练">4. 持续训练</h2>
<p>健身是一种抗阻运动，这意意味着健身不是人体的舒适区，健身更是一个持续走出舒适区的过程。<br>
自我看来，健身是最公平的一件事：</p>
<ul>
<li>我们付出多少，撒过多少汗水，最终都会体现到自己的身体上。即便你的朋友可以做20个引体向上，如果你不运动起来，你还是不可能完成20个引体向上。</li>
<li>健身没有一劳永逸之说，健身不会允许我们仅依靠之前的积累就能永远保持之前的状态。一旦停止健身，好不容易训练出来的肌肉就会有所退化，甚至消失，大概3个月之后，努力训练才得到的肌肉身材就会消失，此时会跟普通人一样。</li>
<li>对于健身而言，每天都是新的开始，都需要奋起拼搏。在大草原上，不管是狮子还是羚羊，每当太阳升起的时候，都必须全力以赴开始奔跑。</li>
</ul>
<h2 id="5-重视roi">5. 重视ROI</h2>
<p>健身不是一种时间消耗的方式，而是一种投资，对自我身体的投资。投资就需要考虑ROI，就需要如何在最短的时间内，无限的接近甚至超过我们的既定目标。</p>
<ul>
<li>我们需要不断地思考，如何才能更高效的达到健身的目标，需要采用什么动作，需要如何安排饮食，需要付出什么</li>
<li>我们需要考虑的都是我如何能够在更短的时间内完成健身目标，而不是我今天要做多少个动作，运动多长时间</li>
<li>我们需要基于目标和收益来选择动作，来合理规划和安排训练节奏</li>
<li>我们更多的要考虑不同动作的效果，而不是每天练习很多看起来比较华丽的动作</li>
</ul>
<h2 id="6-团队项目重视配合">6. 团队项目重视配合</h2>
<p>2022年，尤金世锦赛4x100接力赛中，有望夺冠的美国队交接失误遗憾获得第二。</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=556318760&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<p>回顾整个比赛，我们会发现，因为第三、四棒交接时出现了失误从而让加拿大队以0.07秒的优势夺冠。</p>
<table>
<thead>
<tr>
<th></th>
<th>第一棒</th>
<th style="text-align:left">第二棒</th>
<th style="text-align:left">第三棒</th>
<th style="text-align:left">第四棒</th>
<th style="text-align:left">总时长</th>
</tr>
</thead>
<tbody>
<tr>
<td>加拿大队</td>
<td>10.45</td>
<td style="text-align:left">8.86</td>
<td style="text-align:left">9.38</td>
<td style="text-align:left">8.79</td>
<td style="text-align:left">37.48</td>
</tr>
<tr>
<td>美国队</td>
<td>10.35(-0.10)</td>
<td style="text-align:left">8.94(+0.08)</td>
<td style="text-align:left">9.31(-0.07)</td>
<td style="text-align:left">8.95(+0.16)</td>
<td style="text-align:left">37.55(+0.07)</td>
</tr>
</tbody>
</table>
<p>因此，对于这种赛事运动，不同环节之间的配合和交接也同样重要。</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>方法论</tag>
        <tag>思考</tag>
      </tags>
  </entry>
  <entry>
    <title>色温的基本概念</title>
    <url>/2022/12/03/introduction-to-color-temperature/</url>
    <content><![CDATA[<p><img src="/2022/12/03/introduction-to-color-temperature/1.webp" alt></p>
<p>色温与白平衡是摄影中十分重要的两个技巧，色温是光线在不同能量下人们眼晴所感受到的颜色变化。而白平衡的调整则是通过调整色温来实现的，两者存在着密不可分的关系。</p>
<span id="more"></span>
<h3 id="色温的基本概念">色温的基本概念</h3>
<p>在不同光线的照射下，物体的色彩会产生变化。例如在如下的视频中，相同的物体在不同的灯光下其反映的色彩也不同。</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=716433256&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<p>但是，由于人的眼睛能够修正光源变化造成的色偏，因此不管光源如何变化（无论是在室外的阳光下，还是在室内的白炽灯光下），人眼仍会将白色的物体视为白色，将红色的物体视为红色。</p>
<p>然而，相机却会精确地将这些光源变化而带来的光的颜色的变化记录在照片或者视频中。于是，在纠正之前，照片或者视频看上去是偏色的，但其实这才是物体在当前环境中的真实色彩。</p>
<p>为了区别各种色彩间的变化，在彩色摄影中引进了“色温”的概念。所谓“色温”，指的是一种物理现象，即将金属加热到一定温度后会发出有颜色的光，这种光源的温度被称为“色温”。例如，当一个黑体物质受热后便开始发光，先变成暗红色，随着温度的升高会逐渐变成黄色，然后变成白色，最后变成蓝色。</p>
<p>通常，人眼所见到的光线是由七种色光的光谱所组成的，其中有些偏蓝，有些则偏红。色温就是专门用来度量光线的光谱成分的物理量，色温用绝对温标 K(Kelvin）来表示。</p>
<p>当光源发射的光的颜色与绝对物体在某一温度下辐射光的颜色相同时，绝对物体的温度就被称为该光源的色温。色温越高，则光色越偏蓝；色温越低，则光色越偏红、橙、黄。</p>
<h3 id="不同色温的颜色">不同色温的颜色</h3>
<p>以一天中不同时刻的太阳直射光为例：</p>
<ul>
<li>日出后 30 分钟，光色发黄，色温值约为 2400K</li>
<li>正午时分，日光偏白，色温上升至 4400 ~ 5500K</li>
<li>日落前，太阳直射光光色发红，色温又降至 1900K 左右</li>
</ul>
<p><img src="/2022/12/03/introduction-to-color-temperature/2.jpeg" alt></p>
<p>更详细的色温和RGB之间的映射关系可以参考<a href="http://www.vendian.org/mncharity/dir3/blackbody/UnstableURLs/bbr_color.html">Blackbody color datafile</a>。</p>
<h3 id="不同色温的视觉感知">不同色温的视觉感知</h3>
<p>光源的色温不同，光色不同，带给人的视觉感受也不相同：</p>
<ul>
<li>色温在 3300K 以下，有一种温暖、热烈、活泼的感受</li>
<li>色温在 3000～5000K 为中间色温，有明朗爽快的感觉</li>
<li>色温在 5000K 是最接近自然光的色温，又称为“自然白”。</li>
<li>色温在 5000K 以上会带给人一种寒冷、严肃、安宁的感受</li>
</ul>
<p>同时，人类的文化传统也赋予颜色不同的象征意义：</p>
<ul>
<li>红色象征着热烈、喜庆</li>
<li>绿色象征着和平、生命</li>
<li>蓝色象征着宁静、广阔</li>
<li>黄色象征着温暖、权势</li>
<li>白色象征着光明、纯洁</li>
<li>黑色象征着严肃、神秘</li>
<li>……</li>
</ul>
<h3 id="白平衡的概念">白平衡的概念</h3>
<p>前面在介绍色温的时候，我们提到：</p>
<ul>
<li>人的眼睛能够修正光源变化造成的色偏，因此不管光源如何变化，人眼仍会将白色的物体视为白色</li>
<li>相机的镜头却无法修正光源变化带来的色偏，因此光源的变化会导致相机记录的色彩的变化</li>
</ul>
<p>白平衡 (White Balence) 是数码单反相机运用自身电路来校正不同光源下光线色彩偏移的一种功能。</p>
<p>正常条件下的光通常被称为“白光”，而在这种光线下的色彩是人们所认为的“正常”色彩。所谓“白平衡”，简单地说，就是让相机在任何光线条件下都能识别什么是白色。</p>
<p>人们常说照相机的镜头是物镜，原因在于不论在什么样的光线条件下，它都只能如实地记录它所看到的一切。白平衡的设置就是为了让相机在任何光线条件下都可以正确地还原色彩，使它像人眼那样能够自动适应环境的光线。通常相机的白平衡模式大体分为手动白平衡、自动白平衡两种模式，还设有闪光灯、阴影、日光、荧光、白炽灯等预设白平衡模式。</p>
<p>无论哪种白平衡模式，其本质都是对色温的控制。目前，很多的光源（影视灯、闪光灯）都是有固定色温的，并且在其产品规格中也会明确标定其发光的色温值。对于这种场景，拍摄的时候，直接调整相机的白平衡为对应的光源色温值即可。</p>
<p>如前所述，5000K 是最接近自然光的色温，如果我们拍摄的环境色温值为 4000K，此时环境中的物体是偏暖色的。想要还原物体本身的色彩，那么就需要把相机的白平衡设置为 4000K，这样就可以还原物体本身的色彩了。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition warning"><p class="admonition-title">注意色温和白平衡的区别
</p><p>虽然可以使用色温来调整相机的白平衡，但是需要注意的是：相机白平衡色温和物理色温并不是同一个概念。</p>
<ul>
<li>相机的色温值调低，相机就会认为此时的环境偏红，所以就要往画面中加入冷色调，此时画面会变的更冷。</li>
<li>相机的色温值调高，相机就会认为此时的环境偏蓝，所以就要往画面中加入暖色调，此时画面会变得更暖。</li>
</ul>
</div>
<p>所以，如果想要拍摄暖色调的画面，或者采用色温较低的光源，或者可以通过调高相机的白平衡色温值。</p>
<p><img src="/2022/12/03/introduction-to-color-temperature/3.jpg" alt></p>
<p>关于色温在不同场景下的运用，可以参考如下的视频。</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=248829829&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<h3 id="通过后处理修改色温">通过后处理修改色温</h3>
<p>当然，现在很多软件可以对照片或者视频的色温进行后处理。但是可以后处理调整色温，并不意味着，前期的灯光以及相机的白平衡设置是不重要的。如果前期灯光乱七八糟，那么后续怎么调整都显得无能为力。</p>
<p>例如，对于婚纱摄影而言，在拍摄时，可以对人物的脸部加上暖色补光灯。这种情况下，如果后期对人物的脸部进行白平衡调整，那天空就会因为色温的后期调整而变成深蓝色。类似的，如果拍摄时给人物脸部补冷色光，那么当按照脸部调整白平衡之后，环境就会变成暖色。除非后期把用不同色温照射的部分单独创建图层单独调整色温，否则无论后期怎么调整，都不会得到令人满意的结果。</p>
<p>后处理调整色温主要是通过色温来调整RGB各通道的颜色值来实现。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">kelvin_table = &#123;</span><br><span class="line">    <span class="number">1000</span>: (<span class="number">255</span>, <span class="number">56</span>, <span class="number">0</span>),</span><br><span class="line">    <span class="number">1100</span>: (<span class="number">255</span>, <span class="number">71</span>, <span class="number">0</span>),</span><br><span class="line">    ...</span><br><span class="line">    <span class="number">12000</span>: (<span class="number">195</span>, <span class="number">209</span>, <span class="number">255</span>),</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">image   = Image.<span class="built_in">open</span>(image_file)</span><br><span class="line">r, g, b = kelvin_table[color_temperature]</span><br><span class="line">color_matrix = (r / <span class="number">255.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, </span><br><span class="line">                <span class="number">0.0</span>, g / <span class="number">255.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span>, </span><br><span class="line">                <span class="number">0.0</span>, <span class="number">0.0</span>, b / <span class="number">255.0</span>, <span class="number">0.0</span>)</span><br><span class="line">new_image = image.convert(<span class="string">&#x27;RGB&#x27;</span>, color_matrix)</span><br></pre></td></tr></table></figure>
<p>其中，代码中的 <code>kelvin_table</code> 可以从 <a href="http://www.vendian.org/mncharity/dir3/blackbody/UnstableURLs/bbr_color.html">Blackbody color datafile</a> 获取。</p>
<p>利用这种方式对图片的色温进行调整（1000K~12000K），可以得到如下的效果：</p>
<p><img src="/2022/12/03/introduction-to-color-temperature/4.jpg" alt></p>
<h3 id="色温对视觉信息的影响">色温对视觉信息的影响</h3>
<p>通过下图的色温调整可以看到，色温的调整会简介的影响图像的色调、饱和度、亮度、色彩度等信息，从而影响视觉效果。</p>
<p><img src="/2022/12/03/introduction-to-color-temperature/5.jpg" alt></p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>色温</tag>
        <tag>白平衡</tag>
      </tags>
  </entry>
  <entry>
    <title>如何突破资源限制，创造更大的价值？</title>
    <url>/2022/09/05/How-to-break-through-the-resource-limitation-and-create-the-more-value/</url>
    <content><![CDATA[<p><img src="/2022/09/05/How-to-break-through-the-resource-limitation-and-create-the-more-value/1.webp" alt></p>
<p>在 <a href="https://item.jd.com/13067829.html">偏差——人类决策中的陷阱</a> 一书的 <em>谨小慎微的选择，大胆无畏的预测</em> 这一章节中说道：</p>
<blockquote>
<p>如果一个项目的倡导者处于接近组织层级最顶端的位置，那么他的建议、预测和假设就不会受到太多的审查。</p>
<p>相反，由更基层的员工提出的小规模项目缺必须克服重重障碍，在得到批准之前要经受多层审查。</p>
</blockquote>
<p>如果你所在的项目由处于接近组织层级最顶端位置的人发起，那么恭喜你进入了一个明星项目，你所获得的收益也会因为明星项目的快速发展而与众不同。</p>
<p>谁不想做明星项目呢？</p>
<p>但是，明星项目的数量总归是有限的，其所能承载的团队成员的数量也是有限的。当我们处在一个普通项目的时候，我们又如何才能突破资源的限制，创造出更大的价值？</p>
<span id="more"></span>
<h2 id="灵镜之路">灵镜之路</h2>
<p>2020年初，在我翻译完 <a href="https://wangwei1237.github.io/digital_video_concepts/">Digital Video Concepts, Methods, and Metrics</a> 这本书的时候，从书中的 <em>视频质量指标</em> 这一章节发现了当前视频评测存在的问题，也嗅到了机会。从那个时候起，就想着把视频评测这个方向系统地做起来。</p>
<ul>
<li>2020年 Q1，我们按照 ITU 的标准建设了评测的标准和体系，当时甚至还没有成型的工具可以使用。</li>
<li>2020年 Q2，我们完成了 WEB 版本的工程开发并在 2020年 Q3 的时候在直播业务落地使用。</li>
<li>2020年 Q4，我们和 ACG 合作，利用 WebAssembly 技术实现了在 Chrome浏览器播放 H265 视频的能力。同时我们还在客观算法上进行了各种探索和集成。</li>
<li>2021年 Q1，我们和研发、UE 合作，实现了 Android 版本，直到那个时候我们才给项目起了“灵镜”这个名字。</li>
<li>2022年 Q1，我们继续和研发、UE 合作，实现了 iOS 版本，实现了 PC+Android+iOS 的多端评估能力。</li>
<li>2022年 Q2，我们和 PMO 合作，建设了灵镜专属的众测团队，灵镜成为公司级别的视频评测平台。</li>
<li>2022年 Q3，“灵镜Magic” iOS版本上架苹果 AppStore，实现产品化的第一步。</li>
<li>2023年 Q1，“灵镜”升级为“度知了”，上架各 Android 市场渠道，实现双端发布。</li>
<li>2023年 Q1，我们在 LiveVideoStack 2022 北京站大会上，分享了我们的整个实践过程并受到业界朋友的好评。</li>
<li>……</li>
</ul>
<p>回首过去，灵镜这个项目就像种下的种子一样，慢慢生根，发芽，开花，结果。想当初，我们这个虚拟团队只有 2 个人，到现在我们这个虚拟团队有 10 余人以及上百人的众测用户。灵镜，就这样在没有人关注的时候，慢慢成长，并在某个时刻突然爆发了起来。</p>
<h2 id="小事着手-志存高远">小事着手，志存高远</h2>
<p>在 <a href="https://www.infoq.cn/article/tFuwP4gZLNUVU5lpvSBl">InfoQ的超级连麦栏目</a> 中，TGO 鲲鹏会的董事会成员于游说：</p>
<blockquote>
<p>不要总想着做高大上的事，有很多平平常常的工作把它完成好就已经很好了。</p>
</blockquote>
<p>回顾灵镜的整个过程，确实如此。视频质量评测这个事情，说出来，大家可能都会认为这是一件非常小的、没什么技术含量的、谁也看不上的项目。</p>
<p>我们最开始给别人介绍的时候，别人的反馈确实如此：这有什么技术含量呢，不就是人来打打分嘛？等我们介绍完之后，大家才恍然大悟，原来你们做的是视频画质提升的“度量衡”呀！原来你们把一些看起来非常简单的事情全部集成、整合到一个产品中了呀！在 <a href="https://github.com/wangwei1237/wangwei1237.github.io/issues/325">如何正确的评测视频画质</a> 的评论区中，用户留言说：</p>
<blockquote>
<p>博主你好，从公众号追了过来，写的非常赞！如下内容，想跟你探讨一下：……</p>
</blockquote>
<p>是的，虽然最开始的时候灵镜看起来是一件比较小的事情，但是我们在决定做的时候就是冲着视频画质提升的“度量衡”这个目标来规划的。我们在从小事着手的同时，必须要志存高远，否则我们所做的事情永远都是一些无法连贯起来的小事情。</p>
<p>现在，我们讨论的时候也发现：其实，视频评测并不是一件简单的事情，只是整个团队通过努力把这件复杂的事情变得简单了。</p>
<p>神话有两种：一是完成别人认为不可能完成的事情，二是把别人认为简单的事情做到极致。</p>
<h2 id="乐于合作-价值共享">乐于合作，价值共享</h2>
<p>在创业创新的市场环境下，单打独斗的创业风险极高，且成功率极低。在灵镜项目的整个推进过程中，我深深地认识到：<strong>不要总想着自己能解决所有事情，只有合作，才能走得更快，赢得胜利</strong>。</p>
<p>当灵镜从 WEB 版本升级到 客户端 APP 版本的时候，我发现：团队中没有人可以开发 iOS/Android，没有人可以设计客户端的 UI。当灵镜需要分析视觉因子，进而建模的时候，我发现：我们根本不懂色调、饱和度等视觉信息的含义，我们也不懂机器学习。当灵镜需要组建众测团队以提升效率的时候，我发现：团队中没有人可以有效地运营我们的众测用户……我们遇到了一系列困难，项目是否就此打住？</p>
<p>工程师往往都会高估自己的能力，很难承认自己的平凡，总是会认为我们也能码出一个操作系统。因此，每当遇到问题的时候，为了证明自己的实力，总是会亲自来解决问题。即便是未知的领域，也能依靠超强的学习能力，快速学习并解决问题。这也许是一个办法。</p>
<p>但反过来想，为什么自己的团队成员需要会这么多的技能呢？为什么什么事情都要自己搞定，都要自研呢？这次，我走了另一条路：和专业的团队进行合作，让专业的人做专业的事情。</p>
<p>从后验结果来看，与专业的团队合作是灵镜快速发展的有效法宝之一。如果没有专业团队的加持，我想，我们或者在招聘的路上，或者在挑灯夜学相关技能的路上，又或者在埋头不停地解决一个又一个的 BUG……</p>
<h4 id="资源置换">资源置换</h4>
<p>想要寻找专业的团队合作，首先要问，别人凭什么和我们合作呢？对于明星项目而言，因为是自顶向下的模式，因此合作会非常地顺利。但是，对于灵镜而言，别人凭什么要与我们合作呢？</p>
<p>合作的本质是交易、是资源置换，你有什么资源，我有什么资源，大家交换一下，讲究的是公平。合作的目的是创造价值，而不是共担风险，这是我在灵镜项目中行动的指导原则。</p>
<p>资源置换的目的是合作双方利用资源置换来实现双方的共赢，在合作的时候，不要总是奢求对方的付出，更多地要想清楚：我们有什么资源，我们需要什么资源，哪个团队有这样的资源，我们能为对方付出的资源创造什么样的价值？</p>
<p>没有灵镜，业务方完成一次视频画质评测需要花费 2 周的时间，而如果使用灵镜，则这个时间会缩短到 1 天，这是灵镜能够提供的资源和价值。然而，这个是 WEB 版本的灵镜，如果想让实验结果更准确，就需要 iOS/Android 版本的灵镜，这是灵镜需要的资源。因此，我们和业务方以这种资源置换的方式实现了灵镜和业务方的共赢。灵镜帮助业务提升了视频评测的效率和置信度，而业务方的资源也让灵镜更强大。同时，合作的最终结果也让灵镜的竞争壁垒变得更高，这也就是所谓的 1 + 1 = 10。</p>
<h4 id="价值共享">价值共享</h4>
<p>合作中往往会出现：共患难易，同富贵难的现象。从合作产生的价值上看，我们总会认为自己的贡献比对方高。不是吗？在汇报的时候，我们会说：我们之所以取得辉煌成就，主要是合作方的大力支持？这会导致一种比较奇怪的现象：一个项目，汇报评奖的时候有 100 个人，但是真正出问题了，解决问题的时候可能只有 10 个人。</p>
<p>《大染坊》中的陈寿亭对卢家驹说：没有当初这一桶水，活不了我这条大鲤鱼。</p>
<p>在合作中，对方的作用要高于自己，要定期的和合作方做好价值共享，这是指导我在推进灵镜中的又一个原则。我定期的和所有的合作方共享灵镜当前所取得的收益和价值，并定期向所有合作方汇报灵镜接下来要做什么，为什么要做，这么做还能让我们得到什么？要让所有的合作方随时了解，大家付出的资源所取得和创造的价值。</p>
<h2 id="善于整合">善于整合</h2>
<p>技术人员总觉得写代码、设计架构才是技术，通过灵镜我发现，整合也是一种技术，整合本身也需要非常高的技术能力。在 CPU 大小的芯片上集成 1 个晶体管很简单，但是要集成几千万的晶体管就需要更高超的技术了。</p>
<p>对于工具而言，整合率越高，工具的标准化越好、技术要求越高、人性化也越好。高度整合的工具具备非常重要的3个特征：标准化、科技化、人性化。</p>
<p>通过不断地努力，我们将视频评测标准、视频评测的几十种场景、视频分析算法、视频处理的上下游链路等全部整合到灵镜中，灵镜也在视频评测中发挥着越来越重要的综合效应。通过整合，我们让灵镜变得简单、易用，从目前的情况看，我们可以让用户 0 门槛使用灵镜进行画质评测。</p>
<p>灵镜不但对视频评测技术进行整合，还对视频数据、评测用户进行整合，最终以服务的形态来呈现。视频评测，灵镜足以。</p>
<p>依赖智能手机的整合能力，我们不但可以打电话、发短信，还可以拍视频、玩游戏、看新闻……</p>
<h2 id="服务精神">服务精神</h2>
<p>在公司时间长了，我们慢慢地会习惯于公司的组织架构所带来的团队之间的关联：PM 提出需求，RD 实现需求，QA 把控质量……</p>
<p>每一个团队都会有对应的角色来承担对应的工作。久而久之，我们就形成了一种无形的傲慢。我们会批判 PM 的需求不合理，我们会批判 RD 的代码质量太差，我们会批判 QA 什么也测不出来，这不是一种正常的状态。我们不会以一种服务的姿态去和 PEER 合作，因为我们知道，我们是官方指定的唯一的需求承接方。不是吗？</p>
<p>就在前几天，一个同学问我：</p>
<blockquote>
<p>17哥，我们为什么什么样的需求都接呢？</p>
</blockquote>
<p>我说：虽然我们规模很小，但是我想按照 TOB 的模式来运营，任何需求，我们都需要接。我们要通过技术手段的优化让我们可以承载这些需求，而不是通过制度方式来拒绝掉这些需求。所有企业的不辞辛苦不就是为了获取更多的用户和需求吗？有哪个餐厅会将前来用餐的人拒之门外呢？</p>
<p>在《用户真正需要什么》中介绍了用户租赁赫兹公司的汽车发生了车祸的例子，客服人员说：</p>
<blockquote>
<p>我希望您能确认一下，您确定没事吗？</p>
<p>车毁了，赫兹公司随时都可以再买一辆，但是，我们必须确保您没事。</p>
</blockquote>
<p>当灵镜提供的服务出现异常影响到大家的使用时，我们必须站在用户的角度去思考：因为我们的问题给用户带来的问题、损失以及情绪上的波动。而不是一句简单的话术：收到，跟进中，有结论同步。</p>
<p>在我看来，灵镜是我们提供视频评测服务的一个工具，我们不但要去开发工具，还要思考如何才能在有限的资源内达成最好的结果。服务精神的思维，激励着我们不断依赖技术能力提供更好的评测服务。只有能为更多的人提供服务，才可以创造更多的价值。</p>
<p>实际上，我们在提供更多的服务的同时，也发现了更多之前没有发现的问题，例如 <a href="https://wangwei1237.github.io/2022/06/19/Does-1Kbit-equal-1024bit/">1k bit = 1024 bit？</a>。在提供更多服务的同时，客户也在帮助灵镜不断地完善和成长。</p>
<h2 id="冲在一线">冲在一线</h2>
<p>极客邦科技总裁池建强在 <a href="https://mp.weixin.qq.com/s/T2A6sjefoopnnsxUsFAFqA">要冲在第一线，而不是脱离一线</a> 中说：</p>
<blockquote>
<p>是你带着大家向前走，不是动动嘴、路都让别人走。这么小的团队，你自己也得干活啊。</p>
<p>创业也是一样，不要以为自己是 CEO 了，定一下战略、找找人、找找钱就完事了。写文章、录视频、设计产品啥不得自己干啊。</p>
</blockquote>
<p>我一直认为：只有深入一线，与一线打成一片，才能发现项目中存在的真正问题，才能制定正确的技术规划。</p>
<p>为了测试“张嘴“特效，张嘴张到嘴抽筋，所以我发起了摄像头Mock的项目；2020 年，我在央视参与了百度世界大会重保，我发现了影响项目迭代周期的诸多因素，所以我发起了直播测试中台的项目；为了解决视频评测效率和置信度的问题，我发起了灵镜项目。到目前为止，灵镜提供的所有能力都是在视频评测第一线的摸爬滚打中锻造出来的。</p>
<p>猛将必发于卒伍，脱离一线，就会出现某经济学家的魔幻言论：“现在谁家还没有50万呢？中国人没那么穷……中国人现状平均家庭资产300万。”。</p>
<h2 id="接受质疑">接受质疑</h2>
<p>当年我负责内容生态流量分析项目的时候，一个同学私下找我抱怨道：</p>
<blockquote>
<p>17哥，我们做的这些工作 PGM 根本就一点都不重视呀。你看，我发了一封分析邮件，PGM 到现在了都不回。</p>
</blockquote>
<p>我说：这是非常正常的事情呀。凭什么我们分析一个问题，别人就必须要有回应呢？这个问题是什么，分析的逻辑是否有漏洞，有没有后续的跟进建议，能给产品的发展带来什么，PGM 现在想的是什么？……如果如上的问题都呈现得非常清晰了，那么我们就需要持续地输出类似的分析邮件和报告，以引起 PGM 的重视。</p>
<p>前些日子，我有幸参加了和微帧的技术交流，微帧说当时他们的编码器是世界第一，但是没有人信。然后，他们开始参加 MSU 大赛，结果表明他们确实是世界第一，然后大家都开始认可他们了。</p>
<p>对于刚接触到我们的所有人而言，对我们心存质疑是非常正常的一件事情。大家要合作共赢，就必然要知根知底，就必然要考虑到使用你的能力所带来的风险，就必然会有所质疑。我们要根据大家的质疑，找到行之有效的方式来消除大家的疑虑，而不是一味地对抗。</p>
<p>灵镜的业务落地实践过程中，也会受到各种各样的质疑，我们会不停地组织向大家分享灵镜的技术方案，不停地将灵镜的能力文档化，不停地介绍为什么灵镜的效率会更高、灵镜的结果会更置信……我们也开始在各个渠道（全球顶级音视频社区 LiveVideoStack，百度Geek说，术说……）发表文章，介绍我们的工作。所以我发现，有很多的时候，我的工作会从设计架构、编码变成写文章、写PPT、写文档……</p>
<p>质疑是一件好事，我们要乐于接受大家的质疑，我们所要做的是尽一切努力消除外界对我们的质疑。</p>
<h2 id="总结">总结</h2>
<p>从小事做起，志存高远，确定好目标，盘点好资源，以服务精神，和专业的团队合作共赢。心有猛虎，细嗅蔷薇，把小事情不断做大，把平凡的项目做出不平凡的价值，星星之火，可以燎原。</p>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>延展</tag>
        <tag>整合</tag>
        <tag>合作</tag>
      </tags>
  </entry>
  <entry>
    <title>视频中为什么需要这么多的颜色空间？</title>
    <url>/2022/08/14/Why-so-much-color-space-in-video/</url>
    <content><![CDATA[<p><img src="/2022/08/14/Why-so-much-color-space-in-video/1.jpeg" alt></p>
<p>在视频处理中，我们经常会用到不同的色彩空间：<code>非线性RGB</code>，<code>线性 RGB</code>，<code>YUV</code>，<code>XYZ</code>……为什么需要这么多的色彩空间呢？为什么在 FFmpeg 中会有 <code>color_space</code>，<code>color_transfer</code>，<code>color_primaries</code> 等一系列的颜色属性呢？这些术语之间究竟隐藏着什么秘密？</p>
<span id="more"></span>
<h2 id="视频采集">视频采集</h2>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/2.png" alt></p>
<p>如上图所示，在相机系统中，外部世界的光信息（光子，photons）通过透镜或其他光学器件聚焦之后达到相机的图像传感器（<a href="https://en.wikipedia.org/wiki/Charge-coupled_device">CCD</a> 或者 <a href="https://en.wikipedia.org/wiki/Active-pixel_sensor">CMOS</a>）。<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<ul>
<li>图像传感器可以将一个入射光子（photon）转换为对应的一个电子（electron）。</li>
<li>在曝光时间内，图像传感器对转换的电子进行电荷积累。</li>
<li>然后，图像传感器会将积累的电荷信号转换成对应的电压信号。</li>
<li>最后，利用 <a href="https://en.wikipedia.org/wiki/Analog-to-digital_converter">ADC</a> 把电信号转换成数字信号，而转换后的数字信号则为某个范围内的整数值。</li>
</ul>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">ADC 数字信号的取值范围
</p><p>ADC 转换之后的数字信号的取值范围受限于 ADC 设备。对于 8-bits 的 ADC 而言，数字信号的取值范围为 [0, 2^8-1]，因此，对于每一个像素而言，会用 [0, 255] 之间的整数来进行编码。</p>
</div>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/3.jpeg" alt></p>
<p>ADC 转换的数字信号的数值是一个线性编码的过程，这意味着如果将图像传感器上的光量增加 1 倍，则 ADC 转换之后对应的数值也会增加 1 倍。这是一个非常有用的特性：无论是增加物理世界的光量，还是增加 ADC 转换之后的数值，对图片而言，都会带来相同的效果。线性编码意味着我们所处理的数据和光发射的强度成正比关系。<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p>
<p>由数码相机中的 CMOS 传感器产生并写入原始文件（Raw File）的数据是线性的。与普通照片相比，线性数据通常看起来非常暗且对比度较低。<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/4.jpg" alt></p>
<p>在 iPhone 手机中，可以通过设置相机来拍摄 <a href="https://support.apple.com/zh-cn/HT211965">Apple ProRAW</a> 格式的照片。</p>
<h2 id="视频伽马校正">视频伽马校正</h2>
<p>实际上，研究表明，人类视觉系统是以对数函数的方式来感知光亮度。这意味着，人眼会提高暗部的敏感度，降低高光部分的敏感度。<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/5.png" alt></p>
<p>从数学角度看，感知光强度和测量光强度之间存在一个近似的平方关系，具体如下式所示。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>近似感知亮度</mtext><mo>=</mo><msqrt><mtext>测量亮度</mtext></msqrt></mrow><annotation encoding="application/x-tex">\text{近似感知亮度} = \sqrt{\text{测量亮度}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord cjk_fallback">近似感知亮度</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.06445999999999996em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9755400000000001em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord text"><span class="mord cjk_fallback">测量亮度</span></span></span></span><span style="top:-2.93554em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.06445999999999996em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>由于人类视觉感知系统不是以线性方式工作的，因此必须使用非线性曲线来对 ADC 生成的的线性数据进行变换，从而使得拍摄的图像色调与我们的视觉系统的工作方式相匹配。这个过程也就是我们所说的 <a href="https://en.wikipedia.org/wiki/Gamma_correction">伽马校正</a>。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><msubsup><mi>V</mi><mrow><mi>i</mi><mi>n</mi></mrow><mi>γ</mi></msubsup></mrow><annotation encoding="application/x-tex">V_{out}=V_{in}^{\gamma}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2805559999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">u</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.059164em;vertical-align:-0.276864em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7822999999999999em;"><span style="top:-2.4231360000000004em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">n</span></span></span></span><span style="top:-3.180908em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.276864em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>因此，在从线性 RGB 空间转换到非线性 RGB 空间时，需要 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span></span></span></span> 作为转换参数。相机中的 ISP 模块负责对图像传感器的线性 RGB 进行伽马校正进而产生对应的符合人眼感知的非线性 RGB 数据。</p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/6.png" alt></p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">RGB 的设备依赖性
</p><p>不同显示设备支持的色域空间不同，因此对于不同的显示设备而言，伽马校正之后的 RGB 数值也不同。从这个角度讲，RGB 是设备依赖型的色彩空间。</p>
</div>
<h2 id="视频压缩">视频压缩</h2>
<p>根据如上的信息，我们知道：相机系统经过 ISP 处理之后，最终会得到非线性的 RGB 信息。对于视频而言，如果以 RGB 存储每帧的信息，则需要消耗大量的存储空间。</p>
<p>人类视觉系统对颜色信息的敏感度要弱于亮度信息，利用这一特点，通常相机会将捕获的 RGB 信息转换为 <a href="https://en.wikipedia.org/wiki/YUV">YUV</a> 格式，然后对 YUV 格式进行色度信息采样（例如，YUV420）以便压缩图像空间。</p>
<p>RGB-&gt;YUV，不同标准有不同要求，一般常用的标准有：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Rec._601">BT. 601(SD: Standard-Definition)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Rec._709">BT. 709(HD: High-Definition)</a></li>
<li><a href="https://en.wikipedia.org/wiki/Rec._2020">BT. 2020(UHD: Ultra-High-Definition)</a></li>
</ul>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">注意
</p><p>标准中，不但会规定 RGB-&gt;YUV 的转换系数，同时还会规定从线性 RGB 到非线性 RGB 转换的 gamma 系数。</p>
</div>
<p>将 RGB颜色模型，转换成 YUV 模型后，接下来会采用某种视频编解码算法（例如，H265, VP9）对获取的数据进行视频编码，最终得到视频文件（此处忽略了音频的采集编码以及合流的操作）。</p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/7.png" alt></p>
<h2 id="视频转码">视频转码</h2>
<p>出于各种原因，例如：</p>
<ul>
<li>终端用户的带宽受限</li>
<li>终端用户支持的视频编解码算法和相机压缩视频的编解码算法不一致</li>
<li>……</li>
</ul>
<p>一般不会直接把相机产出的视频文件分发给用户去消费。媒体服务商会对相机生成的视频文件进行转码，然后选择合适的转码后的视频分发给终端消费用户。<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup></p>
<p>在视频转码阶段，如果我们希望对原视频进行色域的变换，例如从 BT. 601 转码为 BT. 709，则需要在不同色域的 RGB 数值之间进行转换。<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup></p>
<p>在不同的色域空间进行 RGB 数据的转换，这也就是我们所说的 <a href="https://en.wikipedia.org/wiki/Color_management">色彩管理</a>。色彩管理会对图像进行色彩管理以适配当前环境下的颜色效果，从而保证同一张图片在不同输入、输出上都呈现出最好的颜色。<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup></p>
<p>色彩转换需要在某个线性空间下进行操作，并且操作过程需要保持设备的独立性。因此，不同的 RGB 色域空间是不能直接进行转换的，需要一个设备无关、线性的颜色模型作为中转才能实现其转换。</p>
<p>而 <a href="https://en.wikipedia.org/wiki/CIE_1931_color_space">XYZ(CIE 1931 XYZ color space)</a> 具备设备无关、线性操作的特性。</p>
<p>在 FFmpeg 中，主要使用 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavfilter/vf_colorspace.c">colorspace 滤镜</a> 来完成不同色域空间的转换。<sup class="footnote-ref"><a href="#fn6" id="fnref6:1">[6:1]</a></sup>根据 colorspace 的实现可知，在 FFmpeg 中，BT. 601-&gt;BT. 709 的转换过程如下所示：</p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/15.png" alt></p>
<p>在如上的变换中，涉及到 3 个颜色空间的转换，分别是：</p>
<ol>
<li>YUV 和 RGB 之间的转换</li>
<li>线性 RGB 和非线性 RGB 之间的转换</li>
<li>线性 RGB 和 XYZ 之间的转换</li>
</ol>
<p>在 FFmpeg 中，所有的这些转换参数都保存在 <a href="https://ffmpeg.org/doxygen/trunk/structAVFrame.html">AVFrame</a> 结构中<sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup>：</p>
<ul>
<li>AVFrame-&gt;<a href="https://ffmpeg.org/doxygen/trunk/structAVFrame.html#a9262c231f1f64869439b4fe587fe1710">colorspace</a> 中保存了 YUV/RGB 的转换矩阵</li>
<li>AVFrame-&gt;<a href="https://ffmpeg.org/doxygen/trunk/structAVFrame.html#ab09abb126e3922bc1d010cf044087939">color_trc</a> 中保存了线性 RGB 和非线性 RGB 之间的转换函数（transformation characteristics）。</li>
<li>AVFrame-&gt;<a href="color_primaries">color_primaries</a> 中保存了 RGB/XYZ 的转换矩阵</li>
</ul>
<p>如果用 <code>ffprobe</code> 命令解析视频文件，则：</p>
<ul>
<li>color_space 字段对应 YUV/RGB 的转换矩阵</li>
<li>color_transfer 字段对应线性 RGB 和非线性 RGB 之间的转换函数</li>
<li>color_primaries 字段对应 RGB/XYZ 的转换矩阵</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ffprobe -select_streams v:0 -show_entries stream&#x3D;color_space,color_transfer,color_primaries test.mp4</span><br><span class="line"></span><br><span class="line">[STREAM]</span><br><span class="line">color_space&#x3D;bt2020nc</span><br><span class="line">color_transfer&#x3D;arib-std-b67</span><br><span class="line">color_primaries&#x3D;bt2020</span><br><span class="line">[&#x2F;STREAM]</span><br></pre></td></tr></table></figure>
<p>在如上的例子中，<a href="https://ffmpeg.org/doxygen/trunk/pixfmt_8h.html#ad4791ea14975f098b649db7fcd731ce6">arib-std-b67</a> 也就是我们所熟悉的 HLG。</p>
<p>在 <code>MediaInfo</code> 中，</p>
<ul>
<li>Matrix coefficients 字段对应 YUV/RGB 的转换矩阵</li>
<li>Transfer characteristic 字段对应线性 RGB 和非线性 RGB 之间的转换函数</li>
<li>Color primaries 字段对应 RGB/XYZ 的转换矩阵</li>
</ul>
<p>除了如上的参数外，AVFrame-&gt;<a href="https://ffmpeg.org/doxygen/trunk/pixfmt_8h.html#a3da0bf691418bc22c4bcbe6583ad589a">range</a> 还用来存储视频中对应像素的每个分量的取值范围。在 <a href="https://github.com/FFmpeg/FFmpeg/blob/a78f136f3fa039fd7ad664fd6e6e976f1448c68b/libavfilter/vf_setparams.c">vf_setparams.c</a> 中也作了相关的定义说明：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;limited&quot;, NULL, 0, AV_OPT_TYPE_CONST, &#123;.i64&#x3D;AVCOL_RANGE_MPEG&#125;,  0, 0, FLAGS, &quot;range&quot;&#125;,</span><br><span class="line">&#123;&quot;tv&quot;,      NULL, 0, AV_OPT_TYPE_CONST, &#123;.i64&#x3D;AVCOL_RANGE_MPEG&#125;,  0, 0, FLAGS, &quot;range&quot;&#125;,</span><br><span class="line">&#123;&quot;mpeg&quot;,    NULL, 0, AV_OPT_TYPE_CONST, &#123;.i64&#x3D;AVCOL_RANGE_MPEG&#125;,  0, 0, FLAGS, &quot;range&quot;&#125;,</span><br><span class="line">&#123;&quot;full&quot;,    NULL, 0, AV_OPT_TYPE_CONST, &#123;.i64&#x3D;AVCOL_RANGE_JPEG&#125;,  0, 0, FLAGS, &quot;range&quot;&#125;,</span><br><span class="line">&#123;&quot;pc&quot;,      NULL, 0, AV_OPT_TYPE_CONST, &#123;.i64&#x3D;AVCOL_RANGE_JPEG&#125;,  0, 0, FLAGS, &quot;range&quot;&#125;,</span><br><span class="line">&#123;&quot;jpeg&quot;,    NULL, 0, AV_OPT_TYPE_CONST, &#123;.i64&#x3D;AVCOL_RANGE_JPEG&#125;,  0, 0, FLAGS, &quot;range&quot;&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="视频解码-播放">视频解码&amp;播放</h2>
<p>转码之后的视频，可以通过各种渠道分发到终端用户进行消费。对于大部分显示设备，例如CRT显示器、LCD、OLED，屏幕上的每个像素都是通过驱动三个非常靠近但仍然分开的小型 RGB 光源而构建的。<sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup> 因此，显示屏（监视器，电视机，屏幕等等）仅使用 RGB 模型，并以不同的方式来组织，并显示最终的图像。<sup class="footnote-ref"><a href="#fn10" id="fnref10">[10]</a></sup></p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/8.jpeg" alt></p>
<p>如前所述，不同的显示设备采用的 RGB 的色域并不一定相同，因此，RGB 是一种设备依赖型的颜色模型。<sup class="footnote-ref"><a href="#fn11" id="fnref11">[11]</a></sup>在 Mac 电脑上，可以通过显示器配置来选择显示器支持不同的 RGB 色域。</p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/10.jpg" alt></p>
<h4 id="显示设备和相机的色域一致">显示设备和相机的色域一致</h4>
<p>如果编码视频和播放视频的显示器采用的 RGB 色域是一致的，比如都是 sRGB，此时的播放过程相对比较简单。视频解码之后，得到 YUV 数据，然后根据标准将 YUV 数据转换成非线性的 sRGB 数据，然后显示器根据 sRGB 数据显示图像即可。</p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/11.png" alt></p>
<h4 id="显示设备和相机的色域不一致">显示设备和相机的色域不一致</h4>
<p>当显示设备支持的色域从 sRGB 变为 Rec. 2020 时，如果直接显示 sRGB 色域下的数据，则会导致比较严重的颜色失真。</p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/12.png" alt></p>
<p>和转码阶段的色域转换类似，此时，也需要在不同的色域空间进行 RGB 数据的转换（<a href="https://en.wikipedia.org/wiki/Color_management">色彩管理</a>）以保证相同的视频在不同输入、输出、显示设备上都呈现出最好的颜色。</p>
<p>对于显示设备而言，sRGB-&gt;RGB(Rec. 2020)的转换过程如下所示：</p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/13.png" alt></p>
<p>因此，对于拍摄设备和显示设备的色域不同时，视频的播放增加了颜色管理的过程。<br>
<img src="/2022/08/14/Why-so-much-color-space-in-video/14.png" alt></p>
<h2 id="视频观看">视频观看</h2>
<p>虽然视频信息的采集和最终终端播放采用的都是 RGB 的颜色模型，但是对人眼而言，RGB 其实并不直观，比如我们很难马上反应出<code>天青色</code>的 RGB 色值？</p>
<p>为了能够更直观的表示颜色，又引入了 <a href="https://en.wikipedia.org/wiki/HSL_and_HSV">HSL</a> 色彩模型。HSL 比 RGB 更加直观，比如：想从黄色过度到红色，只需要调整色相即可，饱和度和亮度保持不变。因此，HSL 一般更适合人的色彩感知，而 RGB 更适合显示领域。</p>
<p>为了让作品可以呈现出期望的效果，提升用户的视觉体验，在摄影后期，使用 HSL 对作品进行调整是最方便的一种方式。利用 HSL 对作品进行调整，简单几步就可以让灰暗的「马路随拍」秒变「街头大片」。<sup class="footnote-ref"><a href="#fn12" id="fnref12">[12]</a></sup></p>
<p><img src="/2022/08/14/Why-so-much-color-space-in-video/16.webp" alt></p>
<p>FFmpeg 的 <code>signalstats</code> 滤镜可以分析获取视频的色调、饱和度、亮度信息。但是该滤镜获取的色调、饱和度和 <a href="https://www.rapidtables.com/convert/color/rgb-to-hsl.html">HSL 中的计算</a> 是不一致的。</p>
<p><code>signalstats</code> 计算色调、饱和度的算法如下所示：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>u</mi><mi>e</mi><mo>=</mo><mfrac><mn>180</mn><mi>π</mi></mfrac><mo>∗</mo><mi>a</mi><mi>r</mi><mi>c</mi><mi>t</mi><mi>a</mi><mi>n</mi><mfrac><mrow><mi>U</mi><mo>−</mo><mn>128</mn></mrow><mrow><mi>V</mi><mo>−</mo><mn>128</mn></mrow></mfrac><mo>+</mo><mn>180</mn><mo separator="true">,</mo><mi>a</mi><mi>r</mi><mi>c</mi><mi>t</mi><mi>a</mi><mi>n</mi><mfrac><mi>y</mi><mi>x</mi></mfrac><mo>∈</mo><mo stretchy="false">[</mo><mo>−</mo><mi>π</mi><mo separator="true">,</mo><mi>π</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Hue=\frac{180}{\pi} * arctan{\frac{U-128}{V-128}} + 180, arctan{\frac{y}{x}} \in [-\pi, \pi]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault">u</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">π</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mord">8</span><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.1296600000000003em;vertical-align:-0.7693300000000001em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693300000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.7935599999999998em;vertical-align:-0.686em;"></span><span class="mord">1</span><span class="mord">8</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">x</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">−</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="mclose">]</span></span></span></span></span></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>a</mi><mi>t</mi><mi>u</mi><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><mi>U</mi><mo>−</mo><mn>128</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>V</mi><mo>−</mo><mn>128</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">Saturation=\sqrt{(U-128)^2 + (V-128)^2}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">u</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">a</span><span class="mord mathdefault">t</span><span class="mord mathdefault">i</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.25612499999999994em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.983875em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"></span><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">1</span><span class="mord">2</span><span class="mord">8</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9438750000000002em;"><span class="pstrut" style="height:3.2em;"></span><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.25612499999999994em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>如果需要得到视频的标准 HSL 信息，可以使用作者开发的 <a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2022/08/14/Why-so-much-color-space-in-video/vf_hsl.c">vf_hsl 滤镜</a>。</p>
<h2 id="总结">总结</h2>
<p>虽然颜色还是那个颜色，但是不同的颜色空间的适用范围并不相同：</p>
<ul>
<li>RGB：面向采集和显示设备</li>
<li>YUV：面向存储</li>
<li>HSL：面向人类视觉感知</li>
<li>XYZ：RGB之间的转换桥梁</li>
</ul>
<p>从视频采集到视频消费的整个过程，涉及到不同的设备和标准，而不同的设备和标准所支持的色域空间又不相同。正是通过不同的颜色模型转换和不同的色域转换，才得以让我们实现：在不同输入、输出、显示设备上都呈现出最好的颜色，才得以让我们实现以近似相同的观看体验来消费视频。</p>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://zhuanlan.zhihu.com/p/158502818">CMOS Image Sensor原理简述</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://discuss.pixls.us/t/what-does-linear-rgb-mean/16584">What does linear RGB mean ?</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://www.astropix.com/html/astrophotography/how.html">How Digital Cameras Work</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://www.pathwaylighting.com/products/downloads/brochure/technical_materials_1466797044_Linear+vs+Logarithmic+Dimming+White+Paper.pdf">Linear vs. Logarithmic Dimming—A White Paper</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://medium.com/videocoin/what-is-video-transcoding-and-why-do-you-do-it-348a2610cefc">What is Video Transcoding and Why Do You Do It?</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://medium.com/invideo-io/talking-about-colorspaces-and-ffmpeg-f6d0b037cc2f">Talking About Colorspaces and FFmpeg</a> <a href="#fnref6" class="footnote-backref">↩︎</a> <a href="#fnref6:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p><a href="https://blog.csdn.net/weixin_43194305/article/details/107944264">【颜色科学】RGB和XYZ颜色空间的转换</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn8" class="footnote-item"><p><a href="https://trac.ffmpeg.org/wiki/colorspace">Colorspace support in FFmpeg</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn9" class="footnote-item"><p><a href="https://en.wikipedia.org/wiki/RGB_color_model">RGB color model</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn10" class="footnote-item"><p><a href="https://wangwei1237.github.io/2020/02/28/Introduction-to-digital-video-technology/">数字视频导论</a> <a href="#fnref10" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn11" class="footnote-item"><p><a href="https://www.spiedigitallibrary.org/ebooks/PM/Computational-Color-Technology/eISBN-9780819481085/10.1117/3.660835">Computational Color Technology</a> <a href="#fnref11" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn12" class="footnote-item"><p><a href="https://zhuanlan.zhihu.com/p/142767122">用HSL调色=简单、快速、超出片！</a> <a href="#fnref12" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>RGB</tag>
        <tag>XYZ</tag>
        <tag>linear RGB</tag>
        <tag>HSL</tag>
        <tag>FFmpeg colorspace</tag>
      </tags>
  </entry>
  <entry>
    <title>1k bit = 1024 bit？</title>
    <url>/2022/06/19/Does-1Kbit-equal-1024bit/</url>
    <content><![CDATA[<p><img src="/2022/06/19/Does-1Kbit-equal-1024bit/1.jpg" alt></p>
<h2 id="引言">引言</h2>
<p>我们的平台有一个算子用于计算给定视频的音视频流的码率，该算子底层通过调用 <code>ffprobe</code> 来计算音视频的码率。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ffprobe -select_streams v:0 -show_entries stream=bit_rate \</span><br><span class="line">-of default=nokey=0:noprint_wrappers=1 <span class="string">&#x27;video_file&#x27;</span></span><br></pre></td></tr></table></figure>
<p>此时，得到的 bit_rate 的单位是 b/s，为了方便，我们把该码率转换为了 Mb/s：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bit_rate = bit_rate / <span class="number">1024</span> / <span class="number">1024</span>;</span><br></pre></td></tr></table></figure>
<p>忽然有一天，我们的用户反馈，平台返回的码率结果和 <code>ffprobe</code> 的结果不一致。具体表现如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Stream #0:0(und): Video: hevc (Main) (hvc1), 3492 kb&#x2F;s, ...</span><br><span class="line">    ...</span><br><span class="line">bit_rate&#x3D;3492451 &#x3D;&#x3D;&gt; 3.33 Mb&#x2F;s</span><br></pre></td></tr></table></figure>
<p>平台返回 3.33 Mb/s x 1024 = 3410 kb/s，而 <code>ffprobe</code> 返回的则为 3492 kb/s。</p>
<span id="more"></span>
<h2 id="问题追查">问题追查</h2>
<p>都是 <code>ffprobe</code> 返回的数据，为什么单位转换之后结果不一致呢了？带着这个问题，我咨询了音视频处理的同事，同事答复说：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在 FFmpeg 中，kb 就是 1000 bit 的意思，b 转换到 kb 是 &#x2F;1000 而不是 &#x2F;1024。</span><br></pre></td></tr></table></figure>
<p>从 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/avcodec.c">libavcodec/avcodec.c</a> 中的 avcodec_string() 所定义的码率信息打印操作的代码可以知道，在 FFmpeg 中，1kb 的确为 1000 bit。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bitrate = get_bit_rate(enc);</span><br><span class="line"><span class="keyword">if</span> (bitrate != <span class="number">0</span>) &#123;</span><br><span class="line">    av_bprintf(&amp;bprint, <span class="string">&quot;, %&quot;</span>PRId64<span class="string">&quot; kb/s&quot;</span>, bitrate / <span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (enc-&gt;rc_max_rate &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    av_bprintf(&amp;bprint, <span class="string">&quot;, max. %&quot;</span>PRId64<span class="string">&quot; kb/s&quot;</span>, enc-&gt;rc_max_rate / <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>印象中，在学校的时候老师就告诉我们：</p>
<blockquote>
<p>1024B = 1KB，1024KB = 1MB，1024MB = 1GB，……</p>
</blockquote>
<p>翻阅2017 年出版的 <a href="https://item.jd.com/10046467986315.html">《计算机文化基础》</a> 的 <strong>1.2.2 计算机中的单位</strong> 章节中写到：</p>
<blockquote>
<p>字节（Byte，缩写为 B）是计算机存储信息的最基本单位。1 个字节用 8 位二进制数表示。</p>
<p>存储空间容量的单位除了用字节表示以外，还从小到大依次可以用千字节（KB）、兆字节（MB）、吉字节（GB）、太字节（TB）等表示。它们之间每一级别的换算关系为 1024 倍，也就是说 1KB 相当于 1024B，其他单位以此类推。</p>
</blockquote>
<p>为什么到了 FFmpeg 这里，1 kb 就等于 1000 b 了呢？</p>
<p>我发起了一个关于 <strong>1kb = (?)b</strong> 的问卷，在回收的 105 份问卷中，答案的分布如下：</p>
<p><img src="/2022/06/19/Does-1Kbit-equal-1024bit/6.png" alt></p>
<h2 id="kb-and-kib">kb and Kib</h2>
<p>维基百科对码率的解释如下：</p>
<blockquote>
<p>The bit rate is expressed in the unit bit per second (symbol: bit/s), often in conjunction with an SI prefix such as kilo (1 kbit/s = 1,000 bit/s), mega (1 Mbit/s = 1,000 kbit/s), giga (1 Gbit/s = 1,000 Mbit/s) or tera (1 Tbit/s = 1,000 Gbit/s).</p>
<p>When quantifying large or small bit rates, SI (International System of Units) prefixes (also known as metric prefixes or decimal prefixes).</p>
<p>Binary prefixes are sometimes used for bit rates. The International Standard (IEC 80000-13) specifies different abbreviations for binary and decimal (SI) prefixes (e.g. 1 KiB/s = 1024 B/s = 8192 bit/s, and 1 MiB/s = 1024 KiB/s).</p>
</blockquote>
<p>在 SI 中，基于 10 进制定义了各<a href="https://en.wikipedia.org/wiki/Metric_prefix">缩写字母</a>的含义：</p>
<ul>
<li>k：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">10^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span></li>
<li>M：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mn>6</mn></msup></mrow><annotation encoding="application/x-tex">10^6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></li>
<li>G：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mn>9</mn></msup></mrow><annotation encoding="application/x-tex">10^9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></li>
<li>T：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mn>12</mn></msup></mrow><annotation encoding="application/x-tex">10^{12}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>P：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><msup><mn>0</mn><mn>15</mn></msup></mrow><annotation encoding="application/x-tex">10^{15}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>在二进制领域中，使用“k”（kilo-）、“M”（mega-）、“G”（giga-）等缩写符号会引起严重的混淆，因此在 1999 年 1 月，国际电工委员会（IEC）在 <a href="https://webstore.iec.ch/publication/12253">IEC 60027-2:1972/AMD2:1999</a> 的第 3.8.3 节中引入了“kibi-”、“mebi-”、“gibi-”等词头以及缩写符号“Ki”、“Mi”、“Gi”等来明确说明二进制计数。</p>
<p><img src="/2022/06/19/Does-1Kbit-equal-1024bit/3.jpg" alt></p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition attention"><p class="admonition-title">IEC 80000-13:2008
</p><p><a href="https://webstore.iec.ch/publication/7479">IEC 80000-13:2008</a> 取消并替换了 IEC 60027-2 中的第 3.8 和 3.9 节中的内容。</p>
<p><img src="/2022/06/19/Does-1Kbit-equal-1024bit/4.png" alt></p>
</div>
<p>因此：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>G</mi><mi>b</mi><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>3</mn></msup><mi>M</mi><mi>b</mi><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>6</mn></msup><mi>k</mi><mi>b</mi><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>9</mn></msup><mi>b</mi></mrow><annotation encoding="application/x-tex">1Gb = 10^{3}Mb = 10^{6}kb = 10^{9}b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord mathdefault">G</span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">b</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>G</mi><mi>i</mi><mi>b</mi><mo>=</mo><msup><mn>2</mn><mn>10</mn></msup><mi>M</mi><mi>i</mi><mi>b</mi><mo>=</mo><msup><mn>2</mn><mn>20</mn></msup><mi>K</mi><mi>i</mi><mi>b</mi><mo>=</mo><msup><mn>2</mn><mn>30</mn></msup><mi>b</mi></mrow><annotation encoding="application/x-tex">1Gib = 2^{10}Mib = 2^{20}Kib = 2^{30}b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord mathdefault">G</span><span class="mord mathdefault">i</span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">i</span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mord mathdefault">i</span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">0</span></span></span></span></span></span></span></span></span><span class="mord mathdefault">b</span></span></span></span></li>
</ul>
<p>所以，在 FFmpeg 中，当码率需要转换为 kb/s 单位时，采用了 <strong>(b/s) / 1000</strong> 的操作。</p>
<h2 id="必须关注kib制带来的差别">必须关注Kib制带来的差别</h2>
<p>在 Linux 或者 Mac 中，已经采用了 IEC 引入了 KiB、MiB 等单位。例如，我们可以查看下 <code>du</code> 命令的帮助文档：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ man du</span><br><span class="line">  ...</span><br><span class="line">  -h      “Human-readable” output.  Use unit suffixes: Byte, Kilobyte, Megabyte, Gigabyte, Terabyte and Petabyte based on powers of 1024.</span><br><span class="line">  --si    “Human-readable” output.  Use unit suffixes: Byte, Kilobyte, Megabyte, Gigabyte, Terabyte and Petabyte based on powers of 1000.</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>如果我们查看 Mac 系统中的文件简介的时候，我们也会发现 Mac 是采用了 SI 来表示单位转换的。<br>
<img src="/2022/06/19/Does-1Kbit-equal-1024bit/2.jpg" alt></p>
<p>我们用 <code>du</code> 命令的不同选项来查看同一个文件的大小的时候也会发现其中的差异：<br>
<img src="/2022/06/19/Does-1Kbit-equal-1024bit/5.jpg" alt></p>
<p>因此，后续在使用相关命令的时候，务必需要查看对应的文档，以确认该命令的输出是基于 SI 还是基于 IEC。</p>
<h2 id="结语">结语</h2>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>k</mi><mi>b</mi><mo mathvariant="normal">≠</mo><mn>1024</mn><mi>b</mi></mrow><annotation encoding="application/x-tex">1kb \ne 1024b
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel"><span class="mord"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.69444em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="rlap"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="inner"><span class="mrel"></span></span><span class="fix"></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mord mathdefault">b</span></span></span></span></span></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>K</mi><mi>i</mi><mi>b</mi><mo>=</mo><mn>1024</mn><mi>b</mi></mrow><annotation encoding="application/x-tex">1Kib = 1024b
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mord mathdefault">i</span><span class="mord mathdefault">b</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">2</span><span class="mord">4</span><span class="mord mathdefault">b</span></span></span></span></span></p>
<p>是时候更新我们的知识库了~</p>
]]></content>
      <categories>
        <category>软件理论</category>
      </categories>
      <tags>
        <tag>IEC(国际电工委员会)</tag>
        <tag>SI(国际单位制)</tag>
        <tag>KiB</tag>
        <tag>kB</tag>
      </tags>
  </entry>
  <entry>
    <title>用 Excel 分析数据的小技巧</title>
    <url>/2022/05/18/Tips-for-Analyzing-data-with-excel/</url>
    <content><![CDATA[<p><img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/1.jpeg" alt></p>
<p>因为工作原因，最近经常要分析一些数据，这些数据的格式不规范，并且数据量级不大——大概在 1W 左右。</p>
<p>一开始，我是不屑于使用 Excel 来处理的，总想着写个程序来完成处理。后来，我发现，我的想法是多么的愚蠢，因为我发现，Excel 简直是太强大了，完全满足了我的各种需要。还好我及时纠正了自己愚蠢的想法，否则我现在还在忙个不停的调试自己的那些代码。</p>
<p>本文把自己使用 Excel 进行数据分析过程中学习到的小技巧进行了梳理总结。</p>
<span id="more"></span>
<h2 id="数据说明">数据说明</h2>
<p>在我的分析中，数据格式如下所示：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>score1</th>
<th>score2</th>
<th>……</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>2.32</td>
<td>3.56</td>
<td>6.78</td>
</tr>
<tr>
<td>2</td>
<td>3.22</td>
<td>6.56</td>
<td>8.23</td>
</tr>
<tr>
<td>3</td>
<td>6.98</td>
<td>8.12</td>
<td>3.78</td>
</tr>
<tr>
<td>4</td>
<td>4.56</td>
<td>7.35</td>
<td>6.53</td>
</tr>
<tr>
<td>5</td>
<td>5.78</td>
<td>2.34</td>
<td>9.12</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>其中，ID 代表我的分析对象中的某个样本，每个样本都会请求不同的服务对其进行打分，因而会得到如下图所示的表格文件。</p>
<p><img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/2.jpg" alt></p>
<p>在上图的 Excel 中，每个 Sheet 的数据为不同服务返回的打分数据。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition warning"><p class="admonition-title">注意
</p><p>不同服务返回的打分中，可能会存在样本的丢失。例如 Sheet2 中就缺少 ID=10 的数据打分。</p>
<p>在分析中，这种数据缺失是完全随机的。</p>
</div>
<h2 id="vlookup">VLOOKUP</h2>
<p>为了分析方便，需要把 Sheet1 和 Sheet2 的数据按照 ID 进行聚合。这个时候，使用 VLOOKUP 就可以非常方便的完成这个工作。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title"><a href="https://support.microsoft.com/en-us/office/vlookup-function-0bbc8083-26fe-4963-8ab8-93a18ad188a1">VLOOKUP</a> 
</p><p>Use VLOOKUP when you need to find things in a table or a range by row. For example, look up a price of an automotive part by the part number, or find an employee name based on their employee ID.</p>
<p>=VLOOKUP(What you want to look up, where you want to look for it, the column number in the range containing the value to return, return an Approximate or Exact match – indicated as 1/TRUE, or 0/FALSE).</p>
</div>
<p>因此，我们用如下的代码就可以实现按照 ID 合并两个 Sheet 的数据：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x3D;VLOOKUP(A1,Sheet2!A:B,2,0)</span><br></pre></td></tr></table></figure>
<p><img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/3.jpg" alt></p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition warning"><p class="admonition-title"><a href="https://www.microsoft.com/en-us/microsoft-365/blog/2011/08/17/making-sense-of-dollar-signs-in-excel/">注意单元格的引用方式</a>
</p><ul>
<li>相对引用，如：A1，B1，公式复制到另一个位置时行和列都要变</li>
<li>绝对引用，如：$A$1，$B$1，公式复制到另一个位置时行和列都不变</li>
<li>混合引用，如：$A1，$B1，$A1此时公式复制到另一个位置时行要变，列不变</li>
</ul>
</div>
<h2 id="数据透视表">数据透视表</h2>
<p>如果希望分析 score1 的不同区间（例如[1, 10],[11, 20]）下，score2 分数各整数区间的个数，也即：</p>
<ul>
<li>scroe1 属于 [1, 10]</li>
<li>score2 属于 [1,2], [2,3], [3,4], …的样本个数</li>
</ul>
<p>此时使用数据透视表就非常方便了。</p>
<ul>
<li>首先，我们选中需要进行数据分析的数据。<br>
<img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/4.jpg" alt></li>
<li>然后，按照如下图视频所示的方式进行数据分析。<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=939365062&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
</li>
</ul>
<h2 id="excel-宏">Excel 宏</h2>
<h4 id="从存在超链接的单元格中提取超链接">从存在超链接的单元格中提取超链接</h4>
<p>如下图所示，从 <strong>工具-&gt;宏-&gt;Visual Basic编辑器</strong> 打开Visual Basic 编辑器，然后选择插入<strong>模块</strong>选项，在编辑器中输入如下的代码。</p>
<p><img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/5.jpg" alt></p>
<figure class="highlight vb"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Function</span> GetAdrs(Rng)</span><br><span class="line">    Application.Volatile <span class="literal">True</span></span><br><span class="line">    <span class="keyword">With</span> Rng.Hyperlinks(<span class="number">1</span>)</span><br><span class="line">        GetAdrs = IIf(.Address = <span class="string">&quot;&quot;</span>, .SubAddress, .Address)</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">With</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure>
<p>然后按照如下图所示像使用普通 Excel 函数一样使用 <code>GetAdrs</code> 就可以了。<br>
<img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/6.jpg" alt></p>
<h2 id="字符串操作">字符串操作</h2>
<p>当需要处理类似视频分辨率信息的数据<code>720x1280</code>时，Excel 中的字符串相关函数就派上大用途了。例如，对于如下表所示的视频数据信息中，如何从resolution列提取视频对应宽高信息？</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>URL</th>
<th>resolution</th>
<th>……</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>url</td>
<td>720*1280</td>
<td>……</td>
</tr>
<tr>
<td>2</td>
<td>url</td>
<td>1080*1920</td>
<td>……</td>
</tr>
</tbody>
</table>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title"><a href="https://support.microsoft.com/en-us/office/left-leftb-functions-9203d2d2-7960-479b-84c6-1ea52b99640c">left</a>, <a href="https://support.microsoft.com/en-us/office/right-rightb-functions-240267ee-9afa-4639-a02b-f19e1786cf2f">right</a>, <a href="https://support.microsoft.com/en-us/office/len-lenb-functions-29236f94-cedc-429d-affd-b5e33d2c67cb">len</a>, <a href="https://support.microsoft.com/en-us/office/find-findb-functions-c7912941-af2a-4bdf-a553-d0d89b0a0628">find</a>
</p><ul>
<li><strong>LEFT</strong> returns the first character or characters in a text string, based on the number of characters you specify.</li>
<li><strong>RIGHT</strong> returns the last character or characters in a text string, based on the number of characters you specify.</li>
<li><strong>LEN</strong> returns the number of characters in a text string.</li>
<li><strong>FIND</strong> locate one text string within a second text string, and return the number of the starting position of the first text string from the first character of the second text string.</li>
</ul>
</div>
<p>对于 <code>720*1280</code> 而言，<code>*</code>左边的字符构成了视频的宽度信息，而 <code>*</code> 右边的字符构成了高度信息。</p>
<ul>
<li>宽度信息：left(str, position(*) - 1) → <code>=LEFT(str, FIND(&quot;*&quot;, str)-1)</code></li>
<li>高度信息：right(str, length(str) - position(*)) → <code>=RIGHT(str, LEN(str)-FIND(&quot;*&quot;,str))</code></li>
</ul>
<p><img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/7.jpg" alt></p>
<p>在视频中，我们一般称视频的分辨率为720P，1080P……，其实也就是宽高信息中的最小值。因此，在得到宽高信息后，我们还希望得到这个视频是720P还是1080P。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title"><a href="https://support.microsoft.com/en-us/office/min-function-61635d12-920f-4ce2-a70f-96f202dcc152">min</a>，<a href="https://support.microsoft.com/en-us/office/value-function-257d0108-07dc-437d-ae1c-bc2d3953d8c2">value</a>
</p><ul>
<li><strong>MIN</strong> Returns the smallest number in a set of values.</li>
<li><strong>VALUE</strong> Converts a text string that represents a number to a number.</li>
</ul>
</div>
<p>但是，实际中，我们使用 <code>min</code> 得出的结果却是 0，如下图所示。<br>
<img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/8.jpg" alt></p>
<p>至于原因，在 <a href="https://support.microsoft.com/en-us/office/min-function-61635d12-920f-4ce2-a70f-96f202dcc152">min</a> 的 <code>Remarks</code> 部分解释的非常清楚：</p>
<ul>
<li>If an argument is an array or reference, only numbers in that array or reference are used. Empty cells, logical values, or <strong>text</strong> in the array or reference are ignored.</li>
<li>If the arguments contain no numbers, MIN returns 0.</li>
</ul>
<p>因为我们之前通过 <code>left</code>、<code>right</code> 得到的数据是字符串类型，因此在 <code>min</code> 函数中，这些数据均被过滤，而当 <code>min</code> 函数参数中不存在数字参数时，它就返回 0。</p>
<p>此时就需要用到 <code>value</code> 函数将字符串转成数字，如下所示：<br>
<img src="/2022/05/18/Tips-for-Analyzing-data-with-excel/9.jpg" alt></p>
<h2 id="总结">总结</h2>
<p>写到这里，回头想想，觉得自己真是幸运，幸运于自己及时制止了那按耐不住的想展示一下技术的愚蠢的想法，否则我现在还在焦头烂额的调试自己的那一堆代码。当然，Excel 还有更多的、其他的强大的能力，等遇到了再继续补充吧~</p>
]]></content>
      <categories>
        <category>数据分析</category>
      </categories>
      <tags>
        <tag>Excel</tag>
        <tag>VLOOKUP</tag>
        <tag>数据透视表</tag>
      </tags>
  </entry>
  <entry>
    <title>如何正确的评测视频画质</title>
    <url>/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/</url>
    <content><![CDATA[<p><img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/1.png" alt></p>
<p>作为视频业务，经常需要：</p>
<ul>
<li>对比不同的视频，从而确定哪个视频的画质更好，以便可以为用户带来更好的体验。</li>
<li>对比不同编码参数生成的视频，以便确定在哪些配置下产生的视频能带来最好的体验。</li>
<li>对比不同产品的视频画质，以便做到知彼知己，并在对比之中带来较好的用户体验。</li>
</ul>
<span id="more"></span>
<p>总之，需要回答一个问题：究竟哪个是画质最好的视频？本文将从影响画质的因素、为什么要不断提升视频画质、画质评测的重要性、如何正确的评测视频画质、自研的画质评测系统——灵镜来介绍我们如何利用灵镜来客观、置信、高效的评测视频画质，进而提升用户体验。</p>
<h2 id="影响画质的因素是什么？">影响画质的因素是什么？</h2>
<p>当我们提及“视频”时，一般指得均是“数字视频”。视觉信号经过记录、压缩<br>
、存储才能产生我们所说的“视频”<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>。同时，由于 HVS(HVS, human visual system，人类视觉系统) 的特点，在视频记录、压缩、存储的过程中，我们可以在视觉质量损失和视频数据压缩之间做出权衡，而不影响视觉质量<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>。</p>
<p>一般而言，影响视频画质的因素主要有以下几点：</p>
<ul>
<li>分辨率：图像中的像素数量，在特定尺寸下，分辨率越高，像素越多，显示的细节则更精细。<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></li>
<li>帧率：一秒内显示的图像数量，电影的帧率一般是 24fps，标准电视的帧率通常是 30fps。<sup class="footnote-ref"><a href="#fn3" id="fnref3:1">[3:1]</a></sup></li>
<li>亮度：可以显示的图像照明强度的范围，人眼能感知到的亮度范围在 10W 尼特左右。</li>
<li>位深：每个像素可以显示的颜色数量，位深度越大，可显示的颜色越多，从而渐变更平滑、更自然。<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></li>
<li>色域：色域是某个特定的色彩的子集，用以表示可以显示的所有颜色的范围。色域一般使用 CIE 1931 色度图上的面积来表示，CIE 1931 曲线的边缘代表可见光光谱颜色的范围。<sup class="footnote-ref"><a href="#fn4" id="fnref4:1">[4:1]</a></sup></li>
<li>码率：编码每秒视频需要的 bit 数量称之为码率（bitrate）。在一定条件下，码率会影响视频的质量，码率越低，压缩率越大，画质相对越差。当然，并非码率越高画质越好，在很多情况下，更高的码率带来的往往却只是带宽的浪费。<sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup></li>
</ul>
<h2 id="为什么要提升画质？">为什么要提升画质？</h2>
<p>我们经常认为：改善影响视频画质的诸多因素，提升视频的画质，就会提升用户体验，进而会提升产品的相关用户指标。因此，本着以终为始的原则，我们要不断提升视频画质。</p>
<p>然而，事实确实如此吗？我们是否想过如下的问题：</p>
<ul>
<li>用户视频观看时长的增加或降低是视频画质的波动导致的吗？</li>
<li>用户在观看视频时，是视频内容的影响力更大还是视频画质的影响力更大？</li>
<li>为什么《西游记》的画质比较粗糙，却能循环播放 30 多年，并创造出万人空巷的奇迹？</li>
<li>当提升了分辨率、帧率等因素后，画质变好了，但是这同时也意味着需要消耗的带宽、算力、电量等必然会增加。在手机耗电量与画质、播放流畅度与画质之间，用户会选择画质优先吗？</li>
<li>提升视频的分辨率和帧率还意味着带宽成本的增加，例如 4K 视频比 1080P 视频的带宽成本要高 3~4 倍。那么，对于流媒体服务商而言，如果对如上的几个问题还存疑的话，为什么要提升画质呢？</li>
</ul>
<p>2020年，华纳兄弟与皮克斯等公司的双盲测实验发现，多数消费者其实并无法分辨 8K 与 4K 的区别。<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup></p>
<p>看起来，画质提升的必要性并不强烈。既然如此，为什么还要提升视频画质呢？为什么整个视频行业都在为了视频画质的提升而不断努力呢？</p>
<ol>
<li>显示设备的分辨率不断升级。例如，<a href="https://consumer.huawei.com/cn/phones/mate40-pro/specs/">HUAWEI Mate 40 Pro</a> 的屏幕分辨率就达到了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>K</mi><mo stretchy="false">(</mo><mn>2772</mn><mo>×</mo><mn>1344</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">2K(2772 \times 1344)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mopen">(</span><span class="mord">2</span><span class="mord">7</span><span class="mord">7</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord">3</span><span class="mord">4</span><span class="mord">4</span><span class="mclose">)</span></span></span></span> 标准。对于电视而言，8K 电视目前也成为了趋势。如果视频本身的分辨率依然停留在 480P 时代，那么在高分辨率的屏幕上观看时，就会出现比较明显的马赛克效应。</li>
<li>视频采集设备不断升级。例如，<a href="https://www.apple.com.cn/iphone-13-pro/specs/">iPhone 13 Pro</a> 可以支持 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mi>K</mi><mtext>，</mtext><mn>60</mn><mtext> </mtext><mi>f</mi><mi>p</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">4K，60\ fps</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="mord cjk_fallback">，</span><span class="mord">6</span><span class="mord">0</span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">p</span><span class="mord mathdefault">s</span></span></span></span> 的视频拍摄，即便是 Android 的千元机档位 <a href="https://www.vivo.com/vivo/param/y53s">VIVO Y53S</a>，视频的最低拍摄分辨率也达到了 720P。在这种情况下，如果视频消费端的分辨率还停留在较低分辨率（例如 480P），那就会带来拍摄预览和回放观看体验严重不一致的问题。</li>
<li>视频编解码算法不断升级<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup>。有多大的硬件资源，就会产生多复杂的软件产品。不断进化的编解码算法为更高画质的应用提供了底层支撑。当具备了制造飞机的技术时，就不会满足与只制造自行车。</li>
<li>不断丰富的消费级应用和玩法需要更高的画质。根据国家广电总局发布的<a href="http://www.nrta.gov.cn/module/download/downfile.jsp?classid=0&amp;filename=cf359da741ac4bdba25f4b77b9cfc160.pdf">《5G 高新视频——VR 视频技术白皮书(2020) 》</a> ，用于 VR 视频节目制作与交换中的视频，建议目前最低使用 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>7680</mn><mo>×</mo><mn>3840</mn></mrow><annotation encoding="application/x-tex">7680\times3840</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">7</span><span class="mord">6</span><span class="mord">8</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">8</span><span class="mord">4</span><span class="mord">0</span></span></span></span> 像素数。尤其是在元宇宙之中，要感知到色声香味触法，太差的画质是无法达到要求的。</li>
<li>不断增加的竞对产品。此时，视频画质的基线水平取决于处在该行业中的竞对产品。并且，视频画质已经成为一种对外宣传的有效手段，例如 B 站的 4K/120帧 视频，西瓜的 4K 高清修复技术……这无形之中就会形成一种用户对视频画质的预期，当产品的画质如果低于这种预期的时候，用户体验就会降低。当然，更高的画质依赖更高性能的设备和更高的带宽。但是我们需要明白：同样能得 100 分，能力只能到 100 分 和 卷面只有 100 分之间的差距是非常大的。</li>
</ol>
<h2 id="为什么评测视频画质如此重要？">为什么评测视频画质如此重要？</h2>
<p>如前所述，众多原因推动视频画质不断提升。然而，没有度量就无法改进，没有度量也就无法评测画质是否有提升、提升的程度如何。另外，在工作中，需要通过评估视频画质来确定流媒体系统的整体要求、对比竞品提供的服务、确定端到端的视频质量等。</p>
<p>视频画质评估如同度量衡一般，构成视频画质提升以及编解码器改进的基石。</p>
<h4 id="主观评估">主观评估</h4>
<p>评测视频画质的显而易见的方式就是征求用户的意见，这也就是我们所说的：主观评估。但是，主观评估具备如下的问题：</p>
<ul>
<li>主观评估是一个繁琐的、非自动化的过程，不可能利用主观评估来评测每个视频。</li>
<li>不同的个体对相同的视频画质感知不同，因此主观评估的结果会随评估者的不同而出现波动。</li>
</ul>
<h4 id="客观评估">客观评估</h4>
<p>即便如此，主观评估仍然是一种有价值的方法，并且可以为客观视频画质评估算法提供数据支撑，例如 <a href="https://github.com/Netflix/vmaf">VMAF</a> 就是利用算法指标对主观评估建模的结果。利用算法来评估视频的画质我们称之为：客观评估。</p>
<h4 id="主-客评估之间的关系">主、客评估之间的关系</h4>
<p>需要注意的是，在视频画质评估领域，虽然算法可以快速、高效、自动的评测视频画质，但是算法也仅仅是对主观评估结果的拟合、预测。也就是说，客观评估算法必须与主观评估之间保持感知上的一致性。</p>
<p>正因为如此，在实际工作中，客观算法一般用以衡量大盘数据，而对于视频编解码器的调整、编解码参数的优化等效果评估，还是会以主观评估为主。<a href="http://www.compression.ru/video/codec_comparison/index_en.html">MSU Video Codecs Comparisons</a> 大赛中，主观打分的结果也是一项重要的指标，例如 <a href="http://www.compression.ru/video/codec_comparison/hevc_2019/#subjective_report">HEVC/AV1 2019</a> 的比赛结果。作为工程师，我们总想着用算法、模型来解决一切问题，然而，我们必须要意识到，并不是所有的问题都可以用算法、模型来解决的。还记得《谁动了我的奶酪》中的“哼哼”吗？</p>
<p>视频画质主、客观评估算法这里不再过多介绍，更详细的信息可以参考<a href="https://wangwei1237.github.io/digital_video_concepts/docs/4_0_VideoQualityMetrics.html">《数字视频概念，方法和测量指标》的 视频质量指标</a> 这一章。</p>
<h2 id="影响评测置信度的因素有哪些？">影响评测置信度的因素有哪些？</h2>
<p>主观评估是画质提升的基石，如何才能保证主观评估结果的客观性、置信度是视频画质评测的核心问题。</p>
<p>为了保证主观评估的置信度，ITU-T 第 9 研究组（SG9, study group 9）提出了若干建议作为主观评估方法，例如 <a href="https://www.itu.int/rec/R-REC-BT.500/en">ITU-R BT.500</a>。更详细的标准和规范可以参考 <a href="https://wangwei1237.github.io/shares/vqs.pdf">视频质量主观评估方法和规范</a>，此处不再一一列举。</p>
<p>在工作中，我们发现：不按照标准和规范执行，主观评估的结果肯定是不置信的。但是，有了标准和规范，按照标准和规范来执行主观画质评测，主观评估的结果就置信了吗？</p>
<p>在工作中，我们发现，并非如此。标准提供了建议，但是具体执行却受限于各种因素，这些受限的因素会影响最终的结果置信度。</p>
<p>一个看起来非常简单的事情（不就是找人来打个分吗），实际上却并不简单。</p>
<h4 id="评测样本的问题">评测样本的问题</h4>
<p>视频样本本身对视频画质主观评估的结果会产生非常大的影响，实际评测过程中，遇到的样本相关的问题主要有如下几种：</p>
<ol>
<li>评测视频时间较长，场景变化较大。这种情况下，用户可能没有耐心看完整个视频，或者跳跃性的观看视频，导致在评测过程中忽略部分信息而而导致最终结果置信度较差。</li>
<li>评测的视频中存在产品 logo。视频中的 logo 会对用户的主观评测带来额外的信息干扰，进而干扰到最终的评测结果。实际评测过程中，我们也观察到视频中的 logo 确实会影响用户的主观打分。<br>
<img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16517338315179.jpg" alt></li>
<li>评测视频的场景覆盖率较低，或者只覆盖了部分产品场景。例如只选取了风景、人物等场景的视频，而缺失了运动类，知识类等场景的视频。</li>
</ol>
<h4 id="评测工具的问题">评测工具的问题</h4>
<ol>
<li>视频缩放带来的误差。为了能够同时对比两个视频，一般而言，评测工具会同时播放待评估的两个视频来让用户主观打分。但是，如下图所示，当视频分辨率比较大时（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1080</mn><mo>×</mo><mn>1920</mn></mrow><annotation encoding="application/x-tex">1080 \times 1920</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">0</span><span class="mord">8</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">9</span><span class="mord">2</span><span class="mord">0</span></span></span></span>），这种方式就会导致视频显示区域的缩放，进而导致视频中画质较差的地方因为视频显示区域的缩放而隐藏。<br>
<img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16517351583684.jpg" alt></li>
<li>视频重叠带来的误差。为了解决上一个问题，评估工具会增加如下图所示的重叠样式来避免缩放带来的误差问题，同时也希望重叠方式能够更直接的对比出视频间的差异。<br>
<img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16517375976060.jpg" alt><br>
但是，在实际评估中，我们发现这种看起来比较好的方式因为存在视频画面的阶段，也会导致主观评估结果的不置信。用户在评估过程中，需要不停的拖动画面的分割线，来观察视频不同区域的画质差异。并且对于 ROI 编码的视频而言，用一个视频的区域 A 和另一个视频的区域 B 做对比，本身就非常不合理。</li>
<li>视频运动带来的误差。和图片不同，视频是一个在时间上连续变化的帧序列。而这种视频本身的运动和变化会在一定程度上隐藏视频中某些帧的某些区域的画质问题。这也就是我们常说的 HVS 的运动掩蔽效应。为了避免这种误差，尤其是对于编解码算法的研发人员，往往希望能够对视频进行逐帧对比，以发现潜在的隐藏风险。虽然诸如 QuickTime、VLC等播放器提供了单帧播放能力，但是评测工具却较少提供单帧对比的能力。</li>
<li>忽略播放设备的差异带来的误差。工作中，我们不止一次的发现用 PC 的评估工具来评估移动设备的播放效果的场景。利用标准和规范指导下的工具得到了一个结果，却忽视了不同设备下显示效果的差异，最终导致这个本来应该置信的结果变得非常不置信。尤其是对于 HDR<sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup> 视频而言，设备的差异性会体现的更加明显。</li>
</ol>
<h4 id="评测者的认知差异">评测者的认知差异</h4>
<ul>
<li>评测者的惯性认知带来的误差。对于固定顺序出现的对比评估，我们发现评测者总是会根据前面几对样本的结果来对后面的结果进行预测，然后按照预测的结果来打分，而不是完全按照自己个主观感知来打分。这种预测的惯性认知会给评估带来非常大的干扰和误差。</li>
<li>评测者的关注焦点不同带来的误差。不同的评测者对同一画面的关注点不同而带来的评估结果波动较大的问题在实际评估工作中经常出现。例如，用户从背景、前景、亮度、美妆等不同角度来评估时，给出的打分也不相同。</li>
</ul>
<h2 id="画质评测利器-灵镜">画质评测利器——灵镜</h2>
<p>历时 2 年多，经历近 500+ 主观评估，1000+ 评估样本，1000+ 评测人员（专家和普通用户），趟过一个又一个的坑，利用技术解决实际评测中遇到的一个又一个的不置信因素，逐步建成了目前较为置信的视频画质评估系统——灵镜。</p>
<p>灵镜基于 ITU 标准，依托自研的 10+ 项专利技术，在不断实践的基础之上而形成的一款支持多端（PC，Android，iOS）评测的视频画质评测服务。</p>
<p><img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16517546841705.png" alt></p>
<p>同时灵镜还提供视频画质评估的一站式服务，涵盖了：从视频生产至视频消费的全链路画质评估，画质、成本等全方位的评测以及解析。</p>
<p><img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16520635610845.jpg" alt></p>
<p>在评测方式上，灵镜支持PC、Android、iOS设备上的横屏、竖屏视频的以下 4 种评测方式：</p>
<ol>
<li>
<p>单屏评测<br>
<img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16517999977033.jpg" alt></p>
</li>
<li>
<p>同屏重叠评测（同时支持 DCR 和 CCR 两种评估模式，并且为了保证置信度，采用视频同区域对比的方式进行同屏重叠对比，可以滑动视频区域来选择不同区域的视频进行对比）<br>
<img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16518006317482.jpg" alt></p>
</li>
<li>
<p>专家评测<br>
<img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16518012927012.jpg" alt></p>
</li>
<li>
<p>同屏评测<br>
<img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/16518013761932.jpg" alt></p>
</li>
</ol>
<p>除此之外，灵镜还提供了：</p>
<ul>
<li>摄像头 Mock 能力，实现用指定视频替换摄像头的采集数据</li>
<li>画质客观评估能力，例如 VMAF，PSNR，SSIM等，对于 PSNR，灵镜还提供了空间可视化能力，以便进行更客观的评测<br>
<img src="/2022/05/09/How-to-Assess-the-Video-Quality-Correctly/o1.gif" alt></li>
<li>视频属性计算能力，例如 SITI，码率，帧率，分辨率等</li>
<li>视频处理&amp;检测能力，例如 静态帧检测，单色帧检测，音画同步检测，异常视频构造等</li>
</ul>
<p>接下来，我们还将继续完善灵镜的能力：</p>
<ul>
<li>单帧对比评测能力</li>
<li>HDR 评测体系</li>
<li>8K，120帧 的高分辨率、高帧率评测体系</li>
<li>美颜、美妆等评测体系</li>
<li>……</li>
</ul>
<p>所有的努力，只为让灵镜更置信、更专业、更高效，只为让灵镜成为视频评测的首选工具。为你，千千万万遍。</p>
<h3 id="灵镜-灵镜-快告诉我-哪个是画质最好的视频？"><code>灵镜，灵镜，快告诉我，哪个是画质最好的视频？</code></h3>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://wangwei1237.github.io/digital_video_concepts/docs/1_1_TheKeyConcepts.html">https://wangwei1237.github.io/digital_video_concepts/docs/1_1_TheKeyConcepts.html</a>. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://wangwei1237.github.io/digital_video_concepts/docs/2_2_0_TheHumanVisualSystem.html">https://wangwei1237.github.io/digital_video_concepts/docs/2_2_0_TheHumanVisualSystem.html</a>. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://wangwei1237.github.io/2020/02/28/Introduction-to-digital-video-technology/">https://wangwei1237.github.io/2020/02/28/Introduction-to-digital-video-technology/</a>. <a href="#fnref3" class="footnote-backref">↩︎</a> <a href="#fnref3:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://wangwei1237.github.io/shares/hdr-field-guide-final-web.pdf">https://wangwei1237.github.io/shares/hdr-field-guide-final-web.pdf</a>. <a href="#fnref4" class="footnote-backref">↩︎</a> <a href="#fnref4:1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://filmora.wondershare.com/video-editing-tips/what-is-video-bitrate.html">https://filmora.wondershare.com/video-editing-tips/what-is-video-bitrate.html</a>. <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://www.techhive.com/article/578376/8k-vs-4k-tvs-most-consumers-cannot-tell-the-difference.html">https://www.techhive.com/article/578376/8k-vs-4k-tvs-most-consumers-cannot-tell-the-difference.html</a>. <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p><a href="https://wangwei1237.github.io/2021/07/27/The-History-of-the-Video-Codec-Improvement/">https://wangwei1237.github.io/2021/07/27/The-History-of-the-Video-Codec-Improvement/</a>. <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn8" class="footnote-item"><p><a href="https://wangwei1237.github.io/2021/01/26/HDR-introduction/">https://wangwei1237.github.io/2021/01/26/HDR-introduction/</a>. <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>IVQA</category>
      </categories>
      <tags>
        <tag>视频评测</tag>
        <tag>画质评测</tag>
      </tags>
  </entry>
  <entry>
    <title>视频编码中的码率控制模式</title>
    <url>/2022/03/11/Understanding-Rate-Control-Modes/</url>
    <content><![CDATA[<p><img src="/2022/03/11/Understanding-Rate-Control-Modes/1.png" alt></p>
<p>数字视频在处理、存储和传输上需要大量数据，典型的 30FPS 的高清视频（1920x1080），如果每个像素需要 8bit 来表示的话，那么每秒需要大约 15亿 bit。而视频编码技术的目标就是获取码率和视觉质量之间的权衡。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1920 x 1080 x 8 x 3 x 30 &#x3D; 1,492,992,000</span><br></pre></td></tr></table></figure>
<p>在视频编码技术中，码率控制（Rate Control）是一件非常重要的事情。在编码视频帧时，码率控制决定了编码器为该视频帧分配的 bit 数。</p>
<p>本文将基于 FFmpeg 中的 X264、X265 编码器来介绍常用的码率控制模式。</p>
<span id="more"></span>
<h2 id="cqp-constant-quantization-parameter">CQP(Constant Quantization Parameter)</h2>
<p><a href="https://www.vcodex.com/h264avc-4x4-transform-and-quantization/"><strong>QP(Quantization Parameter)</strong></a> 用于控制每帧视频中每一个宏块的压缩量。实际上，QP 反映了空间细节压缩情况。QP 越小，就会保留越多的细节信息，视频质量也会越高，同时码率越大。QP 越大，细节信息丢失的越多，码率也会随之降低，但图像失真也会越严重。也就是说，QP 和码率成反比，QP 越大，码率越低；QP 越小，码率越高。</p>
<p>在 H.264/H.265 中，QP 的取值范围为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>51</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 51]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mclose">]</span></span></span></span>。利用 FFmpeg，我们可以非常方便的为整个编码（转码）过程设置一个固定的 QP。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg -i &lt;input&gt; -c:v libx264 -qp 23 &lt;output&gt;</span><br><span class="line">ffmpeg -i &lt;input&gt; -c:v libx265 -x265-params qp=23 &lt;output&gt;</span><br></pre></td></tr></table></figure>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition attention"><p class="admonition-title">谨慎使用 CQP
</p><p>除非我们知道自己在做什么，否则永远不要使用 CQP 来进行码率控制。为整个编码过程设置一个固定的 QP 意味着：最终的视频码率会因为场景的复杂性而发生巨大变化。如果设置的 QP 足够低，那么编码的视频质量会非常好，但与 CRF 相比，这无疑会产生码率的浪费。</p>
<p>CQP 比较适合用于视频编码器的研究，比如在 RD 曲线中，我们会采用不同的 QP 来产生对应的编码视频，进而对编码器进行对比。</p>
</div>
<h4 id="qp-与-率失真曲线">QP 与 率失真曲线</h4>
<p>在评估不同编码器时，我们会用到率失真（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>D</mi></mrow><annotation encoding="application/x-tex">RD</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span>）曲线。一般而言，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>D</mi></mrow><annotation encoding="application/x-tex">RD</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> 曲线都是以码率(<em>Kbps</em>)做为横坐标，以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>S</mi><mi>N</mi><mi>R</mi><mo stretchy="false">(</mo><mi>d</mi><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">PSNR(dB)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathdefault">d</span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span> 作为纵坐标做出来一条曲线。对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>D</mi></mrow><annotation encoding="application/x-tex">RD</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.00773em;">R</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span></span></span></span> 曲线上的点，我们一般采用的是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mi>P</mi><mo>=</mo><mn>28</mn><mo separator="true">,</mo><mn>32</mn><mo separator="true">,</mo><mn>36</mn><mo separator="true">,</mo><mn>40</mn></mrow><annotation encoding="application/x-tex">QP=28, 32, 36, 40</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">Q</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="mord">2</span><span class="mord">8</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">3</span><span class="mord">6</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">4</span><span class="mord">0</span></span></span></span> 这四个 QP 下的编码码率和编码质量。</p>
<h2 id="abr-average-bitrate">ABR(Average Bitrate)</h2>
<p>ABR 又称为目标码率（target bitrate）。ABR 会为编码器设置一个目标码率，然后让编码器来计算如何才能达到我们设定的目标码率。</p>
<p>我们可以利用如下的命令将目标码率设定为 1Mbs。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg -i &lt;input&gt; -c:v libx264 -b:v 1M &lt;output&gt;</span><br><span class="line">ffmpeg -i &lt;input&gt; -c:v libx265 -b:v 1M &lt;output&gt;</span><br></pre></td></tr></table></figure>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition attention"><p class="admonition-title">避免使用 ABR
</p><p>一位 x264 的主要开发人员说：永远不要使用 ABR 来控制视频的码率。为什么这么说呢？这主要是因为，编码器无法确切的知道接下来需要编码的视频帧的情况，因此编码器不得不通过猜测来确定如何才能达到我们设定的目标码率。这也意味着，ABR 在控制码率时，码率的波动范围相对较大，尤其是在视频的开头或者达到目标码率的地方。尤其是对于 HAS(HTTP Adaptive Streaming) 流媒体而言，ABR 会导致分片内的视频质量产生较大的变化。</p>
</div>
<p>ABR 并不是一种固定码率控制模式。尽管 ABR 也是一种 VBR 模式，但是 因为 ABR 并无法可靠的提供良好的编码质量，因此，ABR 也并不比 CBR 好多少。</p>
<h2 id="cbr-constant-bitrate">CBR(Constant Bitrate)</h2>
<p>如果我们需要强制编码器总是使用某个固定的码率来编码视频，我们可以使用 CBR。对于 x264，可以通过 nal-hrd 来设置 CBR 和 VBR 模式。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg -i &lt;input&gt; -c:v libx264 -x264-params &quot;nal-hrd=cbr:force-cfr=1&quot; \</span><br><span class="line">-b:v 1M -minrate 1M -maxrate 1M -bufsize 2M &lt;output&gt;</span><br></pre></td></tr></table></figure>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">nal-hrd
</p><p><a href="http://www.chaneru.com/Roku/HLS/X264_Settings.htm#nal-hrd">nal-hrd</a></p>
<p>Default: None</p>
<p>Signal HRD information. Required for Blu-ray streams, television broadcast and a few other specialist areas. Acceptable values are:</p>
<ul>
<li>none: Specify no HRD information</li>
<li>vbr: Specify HRD information</li>
<li>cbr: Specify HRD information and pack the bitstream to the bitrate specified by bitrate. Requires bitrate mode ratecontrol.</li>
</ul>
<p>Recommendation: none, unless you need to signal this information.</p>
</div>
<h2 id="crf-constant-rate-factor">CRF(Constant Rate Factor)</h2>
<p>CRF 是 x264 和 x265 编码器的默认质量/码率控制设置。CRF 的取值范围为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>51</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,51]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">5</span><span class="mord">1</span><span class="mclose">]</span></span></span></span>，数值越低，质量越好，文件越大。对于不同的编码器，CRF的默认值如下：</p>
<ul>
<li>x264：23</li>
<li>x265：28</li>
</ul>
<p>当CRF 取值为 18(x264)、24(x265) 时，其编码质量在视觉上被认为是无感知的，更小的取值往往意味着码率的浪费。</p>
<p>CRF 的值每 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>±</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">\pm 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">±</span><span class="mord">6</span></span></span></span>，对应的编码文件的大小就会增加1倍或减半。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg -i &lt;input&gt; -c:v libx264 -crf 23 &lt;output&gt;</span><br><span class="line">ffmpeg -i &lt;input&gt; -c:v libx265 -crf 28 &lt;output&gt;</span><br></pre></td></tr></table></figure>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">CRF & 2-Pass
</p><p>具有相同码率的 2-Pass 和 CRF 编码在质量上应该相同。二者的主要区别在于：</p>
<ul>
<li>使用 2-Pass 编码时，可以控制文件大小</li>
<li>使用 CRF 时，只需指定所需的视频质量</li>
</ul>
</div>
<h2 id="2-pass-abr-2-pass-average-bitrate">2-Pass ABR(2-Pass Average Bitrate)</h2>
<p>当采用 2-Pass 编码的时候，对于视频流中的所有数据，编码器会对其处理两次。在第一遍处理的时候，编码器会收集视频的相关信息，在第二次处理时，编码器利用第一次处理收集到的信息来优化编码过程。</p>
<p>在 CBR 模式下，2-Pass 编码比 1-Pass 编码的效率更高。2-Pass 编码比 1-Pass 编码的质量要高，但是编码时间也会随之增加。使用 2-Pass 编码时，对于场景变化不大的画面（如静态画面），分配的码率会低一些；而场景变化大的画面（如赛车、运动等），分配的码率会高一些。因此， 2-Pass 编码可以让整部影片的清晰度比较均匀。</p>
<p>x264 编码器的 2-Pass 编码命令如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg -i &lt;input&gt; -c:v libx264 -b:v 1M -pass 1 -f null /dev/null</span><br><span class="line">ffmpeg -i &lt;input&gt; -c:v libx264 -b:v 1M -pass 2 &lt;output&gt;.mp4</span><br></pre></td></tr></table></figure>
<p>x265 编码器的 2-Pass 编码命令如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg -i &lt;input&gt; -c:v libx265 -b:v 1M -x265-params pass=1 -f null /dev/null</span><br><span class="line">ffmpeg -i &lt;input&gt; -c:v libx265 -b:v 1M -x265-params pass=2 &lt;output&gt;.mp4</span><br></pre></td></tr></table></figure>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition error"><p class="admonition-title">直播场景
</p><p>2-Pass 编码不可用于直播场景。</p>
</div>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://slhck.info/video/2017/03/01/rate-control.html">Understanding Rate Control Modes (x264, x265, vpx)</a></li>
<li><a href="https://slhck.info/video/2017/02/24/crf-guide.html">CRF Guide (Constant Rate Factor in x264, x265 and libvpx)</a></li>
</ul>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>CQP</tag>
        <tag>CBR</tag>
        <tag>ABR</tag>
        <tag>CRF</tag>
      </tags>
  </entry>
  <entry>
    <title>产品的用户体验模型</title>
    <url>/2021/12/17/the-QoE-model-for-production/</url>
    <content><![CDATA[<p><img src="/2021/12/17/the-QoE-model-for-production/1.png" alt></p>
<p>我们天天在说“用户体验”，但是，用户体验究竟是个啥呢？是功能，是价值，是认知，还是感觉？怎么来衡量“用户体验”呢？虽然，有很多专业的书籍来解释“用户体验”，但是我还是想从另外一个角度来阐述一下自己对“用户体验”这一概念的理解。</p>
<span id="more"></span>
<h2 id="什么是用户体验">什么是用户体验</h2>
<p>百度百科对于 <a href="https://baike.baidu.com/item/%E7%94%A8%E6%88%B7%E4%BD%93%E9%AA%8C/1994">用户体验</a> 的定义如下：</p>
<blockquote>
<p>用户体验（User Experience，简称UE/UX）是用户在使用产品过程中建立起来的一种纯主观感受。</p>
<p>ISO 9241-210 标准将用户体验定义为: “人们对于针对使用或期望使用的产品、系统或者服务的认知印象和回应”。</p>
<p>通俗来讲就是“这个东西好不好用，用起来方不方便”。因此，用户体验是主观的，且其注重实际应用时的产生的效果。</p>
<p>ISO 定义的补充说明有着如下解释：用户体验，即用户在使用一个产品或系统之前、使用期间和使用之后的全部感受，包括情感、信仰、喜好、认知印象、生理和心理反应、行为和成就等各个方面。</p>
</blockquote>
<p>Luke Miller（卢克·米勒）在其著作《用户体验方法论》中讲道：</p>
<div class="douban-card-block">
	<a class="douban-card" href="https://book.douban.com/subject/26753288">
		<div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img9.doubanio.com/view/subject/s/public/s28539365.jpg');"></div>
		<div class="douban-card-left">
			<div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img9.doubanio.com/view/subject/s/public/s28539365.jpg');"></div>
		</div>
		<div class="douban-card-right" style="line-height: 1.7;">
			<div class="douban-card-item"><span>书名: </span><strong>用户体验方法论</strong></div>
			<div class="douban-card-item"><span>作者: </span><span>[美]卢克·米勒</span></div>
			<div class="douban-card-item"><span>出版年份: </span><span>2016-1-1</span></div>
			<div class="douban-card-item"><span>评分: </span><span>5.9</span></div>
		</div>
	</a>
</div>
<style>
	.douban-card-block {
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		max-height: 400px;
	}
	.douban-card {
		display: flex;
		margin: 30px 10px;
		padding: 15px;
		border-radius: 10px;
		position: relative;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		color: antiquewhite;
		text-decoration: none;
	}
	.douban-card:hover {
		text-decoration: none;
	}
	.douban-card-bgimg {
		position: absolute;
		width: 115%;
		height: 115%;
		filter: blur(15px) brightness(0.6);
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
	}
	.douban-card-left {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.douban-card-right {
		position: relative;
		display: flex;
		flex-direction: column;
		margin-left: 12px;
		font-size: 16px;
		font-family: 'Courier New', Courier, monospace;
		line-height: 1.3;
		color: antiquewhite;
	}
	.douban-card-item {
		margin-top: 4px;
	}
</style>
<blockquote>
<p>用户体验的核心使命是让用户获得<strong>超预期</strong>的数字体验，用户不仅能通过这些体验增长才干，同时也会乐在其中。</p>
<p>用户体验既是一个名词，也是一个动词，它既是一个产品所具有的终极成果体验，又是创造这些体验的一套方法。这些方法包括用户研究技巧，例如：</p>
<ul>
<li>如何进行用户访谈和调研？</li>
<li>如何创设能代表用户的形象人物？</li>
<li>如何对竞争产品优势进行分析？</li>
</ul>
</blockquote>
<p>Nir Eyal（尼尔·埃亚尔）和Ryan Hoover（瑞安·胡佛）的《上瘾》中提出的让用户对产品上瘾的上瘾模型中，第一步就是——触发，让用户喜欢上产品。而要做到这一点，就需要在用户使用产品时，超出用户的使用预期，否则，用户有什么动力开始采取“行动”呢？</p>
<div class="douban-card-block">
	<a class="douban-card" href="https://book.douban.com/subject/27030507">
		<div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img3.doubanio.com/view/subject/s/public/s29436163.jpg');"></div>
		<div class="douban-card-left">
			<div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img3.doubanio.com/view/subject/s/public/s29436163.jpg');"></div>
		</div>
		<div class="douban-card-right" style="line-height: 1.7;">
			<div class="douban-card-item"><span>书名: </span><strong>上瘾</strong></div>
			<div class="douban-card-item"><span>作者: </span><span>[美]尼尔·埃亚尔</span></div>
			<div class="douban-card-item"><span>出版年份: </span><span>2017-5</span></div>
			<div class="douban-card-item"><span>评分: </span><span>7.4</span></div>
		</div>
	</a>
</div>
<style>
	.douban-card-block {
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		max-height: 400px;
	}
	.douban-card {
		display: flex;
		margin: 30px 10px;
		padding: 15px;
		border-radius: 10px;
		position: relative;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		color: antiquewhite;
		text-decoration: none;
	}
	.douban-card:hover {
		text-decoration: none;
	}
	.douban-card-bgimg {
		position: absolute;
		width: 115%;
		height: 115%;
		filter: blur(15px) brightness(0.6);
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
	}
	.douban-card-left {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.douban-card-right {
		position: relative;
		display: flex;
		flex-direction: column;
		margin-left: 12px;
		font-size: 16px;
		font-family: 'Courier New', Courier, monospace;
		line-height: 1.3;
		color: antiquewhite;
	}
	.douban-card-item {
		margin-top: 4px;
	}
</style>
<p>因此，用户体验的本质就是：让用户获得超出预期的产品体验。只有超出用户预期的体验，才谈得上用户体验。</p>
<h2 id="用户体验模型">用户体验模型</h2>
<p>通过如上的介绍，我们可以将用户体验拆分为两个部分：产品提供的能力，用户的预期。那么用户体验质量（<em>QoE</em>）就可以用如下的模型来表述：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mi>o</mi><mi>E</mi><mo>=</mo><mtext>产品能力</mtext><mo>−</mo><mtext>用户预期</mtext></mrow><annotation encoding="application/x-tex">QoE = \text{产品能力} - \text{用户预期}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord text"><span class="mord cjk_fallback">产品能力</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord cjk_fallback">用户预期</span></span></span></span></span></span></p>
<p>只有超出用户预期的产品才能让用户上瘾，和用户预期一致的产品只能是基本满足用户的需求，低于用户预期的产品则会被用户抛弃。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>Q</mi><mi>o</mi><mi>E</mi><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.3599999999999999em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>用户上瘾</mtext><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if  </mtext><mi>Q</mi><mi>o</mi><mi>E</mi><mtext> </mtext><mo>&gt;</mo><mi mathvariant="normal">Δ</mi><mo separator="true">;</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>基本满足</mtext><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if  </mtext><mi mathvariant="normal">∣</mi><mtext> </mtext><mi>Q</mi><mi>o</mi><mi>E</mi><mtext> </mtext><mi mathvariant="normal">∣</mi><mo>&lt;</mo><mi>ε</mi><mo separator="true">;</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>用户离去</mtext><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>if   </mtext><mi>Q</mi><mi>o</mi><mi>E</mi><mtext> </mtext><mo>&lt;</mo><mo>−</mo><mi mathvariant="normal">Δ</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mi>s</mi><mi mathvariant="normal">.</mi><mi>t</mi><mi mathvariant="normal">.</mi><mtext>  </mtext><mn>0</mn><mo>&lt;</mo><mi>ε</mi><mo>≪</mo><mi mathvariant="normal">Δ</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
&amp;QoE = \begin{cases}
\text{用户上瘾}, &amp;\text{if } \ QoE\  &gt; \Delta;\\
\text{基本满足}, &amp;\text{if } \ |\ QoE\ | &lt; \varepsilon;\\
\text{用户离去}, &amp;\text{if } \ \ QoE\  &lt;  -\Delta
\end{cases}\\
&amp;\\
&amp; s.t. \ \ 0 &lt; \varepsilon \ll \Delta
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.62em;vertical-align:-3.5599999999999996em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.0600000000000005em;"><span style="top:-6.0600000000000005em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"></span></span><span style="top:-3.0100000000000007em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"></span></span><span style="top:-1.5100000000000007em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5599999999999996em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.0600000000000005em;"><span style="top:-6.0600000000000005em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.35002em;"><span style="top:-2.19999em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:-2.19499em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.20499em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.15001em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-4.2950099999999996em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.30501em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-4.60002em;"><span class="pstrut" style="height:3.15em;"></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.8500199999999998em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">用户上瘾</span></span><span class="mpunct">,</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">基本满足</span></span><span class="mpunct">,</span></span></span><span style="top:-1.5300000000000002em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord cjk_fallback">用户离去</span></span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.41em;"><span style="top:-4.41em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace"> </span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">Δ</span><span class="mpunct">;</span></span></span><span style="top:-2.97em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace"> </span><span class="mord">∣</span><span class="mspace"> </span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace"> </span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">ε</span><span class="mpunct">;</span></span></span><span style="top:-1.5300000000000002em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">if </span></span><span class="mspace"> </span><span class="mspace"> </span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mspace"> </span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">−</span><span class="mord">Δ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.9099999999999997em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.0100000000000007em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"><span class="mord"></span></span></span><span style="top:-1.5100000000000007em;"><span class="pstrut" style="height:4.41em;"></span><span class="mord"><span class="mord"></span><span class="mord mathdefault">s</span><span class="mord">.</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mspace"> </span><span class="mspace"> </span><span class="mord">0</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault">ε</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">Δ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.5599999999999996em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>如上的模型可以用下图来表示：</p>
<p><img src="/2021/12/17/the-QoE-model-for-production/2.png" alt></p>
<h2 id="必须认识到用户预期的重要性">必须认识到用户预期的重要性</h2>
<h4 id="清晨的奶昔">清晨的奶昔</h4>
<p>在克莱顿·克里斯坦森的著作<a href="https://book.douban.com/subject/30203403/">《与运气竞争·关于创新与用户选择》</a>一书中，介绍了一个<strong>奶昔窘境</strong>的案例。</p>
<!--![](3.jpeg)-->
<div class="douban-card-block">
	<a class="douban-card" href="https://book.douban.com/subject/30203403">
		<div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img9.doubanio.com/view/subject/s/public/s29762696.jpg');"></div>
		<div class="douban-card-left">
			<div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img9.doubanio.com/view/subject/s/public/s29762696.jpg');"></div>
		</div>
		<div class="douban-card-right" style="line-height: 1.7;">
			<div class="douban-card-item"><span>书名: </span><strong>与运气竞争</strong></div>
			<div class="douban-card-item"><span>作者: </span><span>[美]克莱顿·克里斯坦森</span></div>
			<div class="douban-card-item"><span>出版年份: </span><span>2018-5</span></div>
			<div class="douban-card-item"><span>评分: </span><span>7.9</span></div>
		</div>
	</a>
</div>
<style>
	.douban-card-block {
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		max-height: 400px;
	}
	.douban-card {
		display: flex;
		margin: 30px 10px;
		padding: 15px;
		border-radius: 10px;
		position: relative;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		color: antiquewhite;
		text-decoration: none;
	}
	.douban-card:hover {
		text-decoration: none;
	}
	.douban-card-bgimg {
		position: absolute;
		width: 115%;
		height: 115%;
		filter: blur(15px) brightness(0.6);
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
	}
	.douban-card-left {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.douban-card-right {
		position: relative;
		display: flex;
		flex-direction: column;
		margin-left: 12px;
		font-size: 16px;
		font-family: 'Courier New', Courier, monospace;
		line-height: 1.3;
		color: antiquewhite;
	}
	.douban-card-item {
		margin-top: 4px;
	}
</style>
<p>一家贩卖奶昔的连锁公司花了数月的时间来研究：如何贩卖更多的奶昔？他们把符合奶昔消费者特征的典型顾客请来，并做深入的问题调研，例如：</p>
<ul>
<li>从一个消费者的角度看，我们如何改进才能促使大家购买更多的奶昔？</li>
<li>你希望奶昔的价格更低一点吗？或者更有嚼劲一点？或者口味再重一点？</li>
<li>……</li>
</ul>
<p>这家奶昔店根据消费者的反馈做了许多创新，并且为了满足用户提出的需求，他们也进行了很多创新。然而，数月之后，他们发现：<strong>什么都没有发生，销量依旧如前</strong>。</p>
<p>然后，这家奶昔店的营销团队选了一天，在餐厅里站了 18 个小时来观察他们的顾客，观察顾客：</p>
<ul>
<li>在什么时间购买奶昔？</li>
<li>穿什么颜色的衣服？</li>
<li>是否独自购买？</li>
<li>除了奶昔外他们是否有购买其他的食品？</li>
<li>他们是如何喝完购买的奶昔的？在餐厅喝完？还是边走边喝？还是开车带走？</li>
</ul>
<p>最终，他们发现奶昔的售出时间集中在两个时间段：上午 9 点之前，晚上下班之后。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">上午9点之前
</p><p>对于上午 9 点之前卖出的奶昔，营销团队经过分析发现这个时间段的消费者往往是独自一人，只买一杯奶昔，然后把奶昔带到车里，开车带走。经过营销人员的深入分析与整合，他们发现：这一批消费者之间的共同点和他们的个人状态没有什么必然的关系，他们的共同点在于他们需要在开车上班的漫长路途中增点乐趣，他们经过漫长的选择，最终发现奶昔是完成这项任务的一个不错的选择。</p>
</div>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">晚上下班之后
</p><p>对于晚上下班之后的消费者情况完全不同。经过一周的时间，父母会在很多事情上对孩子说“不”，作为父母，也希望能找一个机会增进一下和孩子之间的感情。在这种情况下，当父母和孩子在排队点餐的时候，孩子突然问能不能来一杯奶昔的时候，与孩子增进感情的时机就到了。</p>
</div>
<h4 id="用户预期的重要性">用户预期的重要性</h4>
<p>因此，通过这个例子，我们需要清醒的认识到，无论何时，在用户打开手机，选择点开某个 APP 的时候，肯定是会存在某种预期的。如果忽略或者不清楚这背后的预期，即便我们非常认真的进行各种用户调研和问卷，并且也根据用户反馈进行了很多的创新，结果也会像这家奶昔点一样：<strong>什么都没有发生，销量依旧如前</strong>。</p>
<p>另外，我们也需要思考：用户反馈、用户问卷、用户调研等手段可以发现隐藏在用户背后的用户预期吗？并且很多的时候，我们所设计的问卷往往带有一些倾向性，这会导致我们没办法从用户反馈中发现用户的预期。</p>
<p><img src="/2021/12/17/the-QoE-model-for-production/4.png" alt></p>
<h4 id="用户预期的一人千面">用户预期的一人千面</h4>
<p>我们接着看奶昔店的这个案例，我们会发现，对与同样的消费者，同样的产品，在不同的场景下，消费者会有不同的预期：</p>
<ul>
<li>对于上午 9 点的场景：希望奶昔更稠一点，更大一点，因为希望花更多的时间喝完。</li>
<li>对于晚上下班之后的场景：希望奶昔更小一点，更健康一点，一来可以更快吃完，二来不至于让父母太过自责。</li>
</ul>
<p>我依然是我，虽然早上上班时很高兴奶昔能大点、稠点，但是晚上还这样我就很生气了。用户的预期是随场景而发生变化的，必须努力搞清楚用户对产品的使用条件，以及在这些特定的条件下用户要达到的目标究竟是什么，只有这样才能摸清用户的预期，才有可能基于用户的预期来设计产品，给用户带来“哇塞”的体验。</p>
<p>我经常使用打车软件打车，每当天气不好的时候，我总是非常担心打不到车，此时对于打车软件而言，能够帮助我打上车就是我的预期。至于等候时间，并没有太大的预期了，20分钟可以，30分钟可以，40分钟也可以，只要是能打上车就可以。但是，如果在天气非常好的非用车高峰时期，我的预期就会变成快速响应了，如果5分钟还没有打上车，我就会认为这个打车软件不好。</p>
<h4 id="用户预期的千人千面">用户预期的千人千面</h4>
<p>“物以类聚，人以群分”，人群有不同特点，这些不同的特点导致不同人对同一事物的理解并不相同，进而导致对同一事物的预期也不相同。“一千个观众眼中有一千个哈姆雷特”说的也是这个道理，因此，对于同一产品而言，不同用户的预期是各不相同的。</p>
<p>因此，在提升用户体验的时候，我们必须要深刻的认识到这一点，然后去了解：</p>
<ul>
<li>我们的用户是怎样的用户？</li>
<li>我们的用户他们的使用场景是什么？</li>
<li>我们的用户是怎样理解我们的？</li>
<li>……</li>
</ul>
<h2 id="获取用户预期的方法有哪些">获取用户预期的方法有哪些</h2>
<p>目前，可以获取到用户预期的基本方法有如下的几种：</p>
<ul>
<li>问卷调研</li>
<li>用户反馈分析</li>
<li>产品A/B实验分析</li>
<li>用户使用产品时的行为分析</li>
<li>竞品分析</li>
</ul>
<p>目前，如上的每种方法，市面上都有很多书籍和内容来介绍，在此就不一一展开阐述了。</p>
<p>在本文介绍的用户体验模型：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mi>o</mi><mi>E</mi><mo>=</mo><mtext>产品能力</mtext><mo>−</mo><mtext>用户预期</mtext></mrow><annotation encoding="application/x-tex">QoE=\text{产品能力}-\text{用户预期}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">Q</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord text"><span class="mord cjk_fallback">产品能力</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord cjk_fallback">用户预期</span></span></span></span></span>，用户预期扮演着至关重要的作用，在开展用户体验提升的过程中，必须对这个因素引起高度的重视。</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>用户体验</tag>
        <tag>QoE</tag>
        <tag>竞品分析</tag>
        <tag>用户反馈</tag>
      </tags>
  </entry>
  <entry>
    <title>一些有趣但又值得思考的事情</title>
    <url>/2021/12/11/Something-Interesting-But-Worth-Thinking-About/</url>
    <content><![CDATA[<p><img src="/2021/12/11/Something-Interesting-But-Worth-Thinking-About/1.jpeg" alt></p>
<h2 id="引子">引子</h2>
<blockquote>
<p>Any fool can write code that a computer can understand. Good programmers write code that humans can understand.<br>
<em><strong><div align="left">-- Martin Fowler</div></strong></em></p>
</blockquote>
<p>作为程序员，我猜，当看完这句话后，你肯定会觉得这句话是对的，但是不见得会由衷的信服这句话。我还猜，你一定在想，<strong>Martin Fowler</strong> 究竟是谁呀？</p>
<span id="more"></span>
<p>我们再来看下面的这句话：</p>
<blockquote>
<p>Stay Hungry, Stay Foolish.<br>
<em><strong><div align="left">-- Steve Jobs</div></strong></em></p>
</blockquote>
<p>我猜，作为程序员，我们会由衷的信服这句话吧？我也猜，至少今天，我们还都知道 <strong>Steve Jobs</strong> 是谁吧？</p>
<h2 id="几组有意思的问题">几组有意思的问题</h2>
<h4 id="第一组">第一组</h4>
<ul>
<li>微软的创始人有谁？</li>
<li>苹果的创始人有谁？</li>
<li>Facebook 的创始人有谁？</li>
<li>谷歌的创始人有谁？</li>
<li>炒股比较厉害的人有谁？</li>
<li>亚马逊的创始人有谁？</li>
<li>特斯拉的创始人有谁？</li>
<li>……</li>
</ul>
<h4 id="第二组">第二组</h4>
<ul>
<li>C 语言的发明者是谁？</li>
<li>UNIX 的发明者是谁？</li>
<li>分布式系统中著名的 Paxos 算法的发明者是谁？</li>
<li>敏捷软件开发宣言的创作者有谁？</li>
<li>高内聚、低耦合是谁提出来的？</li>
<li>微服务架构的提出者是谁？</li>
<li>……</li>
</ul>
<h4 id="第三组">第三组</h4>
<ul>
<li>《人月神话》的作者是谁？</li>
<li>《重构》的作者是谁？</li>
<li>《设计模式：可复用面向对象软件的基础》的作者是谁？</li>
<li>《算法导论》的作者是谁？</li>
<li>《代码整洁之道》的作者是谁？</li>
<li>《修改代码的艺术》的作者是谁？</li>
</ul>
<p>如上的几组问题，在不利用搜索引擎帮助的情况下，我们能说出几个呢？如果您有时间，不妨花 1-2 分钟的时间一起参与到这件有意思的事情上来，点一点，完成如下的 15 个问题。</p>
<div><iframe height="500" width="100%" src="https://wj.qq.com/s2/9442849/3f79/" frameborder="0" allowfullscreen></iframe></div>
<h4 id="问卷的结果">问卷的结果</h4>
<p>待补充</p>
<h2 id="发现了什么？">发现了什么？</h2>
<p>是不是一件有意思的事情呢？</p>
<p>作为程序员，作为这个圈子里的人，我们天天嘴上讨论这敏捷开发、设计模式、微服务，我们天天在和各种编程语言打交道，我们天天在阅读各种经典的技术书籍……但是，我们却说不出这些经典巨著的作者，说不出某种软件开发模式的提出者，说不出自己每天使用的编程语言的发明者……</p>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>思考</tag>
      </tags>
  </entry>
  <entry>
    <title>新业务的开发就不需要重视内部质量吗？</title>
    <url>/2021/12/04/Should-the-new-business-production-development-focus-on-internal-quality/</url>
    <content><![CDATA[<p><img src="/2021/12/04/Should-the-new-business-production-development-focus-on-internal-quality/0.jpeg" alt></p>
<p>一直以来，我都在思考如下的问题：</p>
<ul>
<li>新启动的业务是否值得花费时间来开展单元测试、接口自动化测等质量保证手段？</li>
<li>新启动的业务是否值得花费时间来践行持续集成等软件开发模式？</li>
<li>新启动的业务是否值得花费时间来设计架构、编写接口文档……?</li>
<li>……</li>
</ul>
<span id="more"></span>
<h2 id="一直以来的疑问和迷惑">一直以来的疑问和迷惑</h2>
<p>一直以来，都没有想的非常清楚。随着经历的越多，观察的越多，对这些问题的迷惑也随之增加：</p>
<ul>
<li>如果说，自动化是提升效率的必要手段，那么，为什么新业务都不愿意采用对应的自动化手段呢？</li>
<li>如果说，持续集成真的能够提升软件价值的交付效率，那么，为什么新业务都不愿意采用这种实践模式？</li>
<li>我总是听到，新业务要快速验证业务逻辑，代码都没有时间写，哪还有时间编写：
<ul>
<li>架构设计文档</li>
<li>接口文档</li>
<li>单元测试用例</li>
<li>自动化用例</li>
<li>……<br>
难道如上的这些手段会降低价值交付的效率？如果不是这样，那为什么我总能听到这种言论呢？</li>
</ul>
</li>
</ul>
<p>直到最近读了 Martin Fowler 的文章 <em><a href="https://martinfowler.com/articles/is-quality-worth-cost.html">Is High Quality Software Worth the Cost?</a></em> （<a href="https://mp.weixin.qq.com/s/mGq5SsMp2yuSA_p5meWRCg">高质量的软件是否值得付出代价？</a>），才想明白了如上的问题和迷惑的根源。</p>
<h2 id="高质量的软件是否值得付出代价？">高质量的软件是否值得付出代价？</h2>
<h4 id="内部质量和外部质量">内部质量和外部质量</h4>
<p>在 <em><a href="https://martinfowler.com/articles/is-quality-worth-cost.html">Is High Quality Software Worth the Cost?</a></em> 一文中，Martin Fowler 将软件质量分为 <strong>外部质量</strong> 和 <strong>内部质量</strong>。</p>
<blockquote>
<p>I thus divide software quality attributes into <strong>external</strong> (such as the UI and defects) and <strong>internal</strong> (architecture).</p>
<p>The distinction is that users and customers can see what makes a software product have high <strong>external quality</strong>, but cannot tell the difference between higher or lower <strong>internal quality</strong>.</p>
</blockquote>
<p>然后，Martin Fowler 提到：既然用户无法区分 <strong>内部质量</strong> 的好坏，为什么要为没有效果的东西付出更多呢？</p>
<blockquote>
<p>Another way I put this is that it makes sense to trade cost for <strong>external quality</strong> but it makes no sense to trade cost for <strong>internal quality</strong>.</p>
<p>A user can judge whether they want to pay more to get a better user interface, since they can assess whether the user interface is sufficiently nicer to be worth the extra money.</p>
<p>But a user can’t see the internal modular structure of the software, let alone judge that it’s better.</p>
<p><strong>Why pay more for something that has no effect?</strong></p>
<p>Since that’s the case - why should any software developer put their time and effort into improving the internal quality of their work?</p>
</blockquote>
<p>因此，对于新业务而言，用户无法感知到：接口文档、单元测试用例、接口测试用例、持续集成的配套建设等有利于 <strong>内部质量</strong> 的措施，有这些时间还不如多写点代码，多实现一些用户可以感知到的功能。</p>
<p>这听起来是多么的合乎逻辑，推理的过程又是多么的顺理成章、无懈可击。</p>
<h4 id="内部质量的重要性">内部质量的重要性</h4>
<p>然后，Martin Fowler 利用 <strong>软件累积功能</strong> 和 <strong>对应的开发成本</strong> 之间的关系模型阐述了 <strong>内部质量</strong> 的重要性。</p>
<blockquote>
<p><img src="/2021/12/04/Should-the-new-business-production-development-focus-on-internal-quality/1.jpg" alt></p>
<p>The fundamental role of <strong>internal quality</strong> is that <strong>it lowers the cost of future change</strong>.</p>
<p>But there is some extra effort required to write good software, which does impose some cost in the short term.</p>
</blockquote>
<p>Martin Fowler 采用了访谈的方式来评估两条曲线的交点在整个软件开发过程中出现的时间，并惊奇的发现该交点在数周以后就会出现。</p>
<p>实际上，对于新业务而言，我们在探索的初期就是向着一个可能会成功的方向上来探索。因此，整个探索的过程会经历数月、甚至 1~2 年的时间。而根据 Martin Fowler 的 <strong>软件累计功能</strong> 模型，如果不重视 <strong>内部质量</strong>，数周之后，糟糕的 <strong>内部质量</strong> 就会严重影响软件的交付效率。因此，只有在一开始就重视软件的 <strong>内部质量</strong>，才能真正有效的提升新业务的价值探索效率。</p>
<blockquote>
<p>The way I assess where lines cross is by canvassing the opinion of skilled developers that I know.</p>
<p>And the answer surprises a lot of folks.</p>
<p>Developers find <strong>poor quality code significantly slows them down within a few weeks</strong>.</p>
<p>So there’s not much runway where the trade-off between internal quality and cost applies.</p>
<p><strong>Even small software</strong> efforts benefit from attention to good software practices, certainly something I can attest from my experience.</p>
</blockquote>
<h4 id="成本和内部质量的关系">成本和内部质量的关系</h4>
<p>在文章的最后，Martin Fowler 也提到：<strong>成本</strong> 和 <strong>内部质量</strong> 是一种不寻常且违反直觉的关系，因此通常难以理解二者之间的关系，但是理解他们之间的关系对于以最高效率开发软件至关重要。</p>
<blockquote>
<p>When thinking about internal quality, I stress that we should only approach it as an economic argument.</p>
<p>High internal quality reduces the cost of future features, meaning that putting the time into writing good code actually reduces cost.</p>
<p>Because the relationship between cost and internal quality is an unusual and counter-intuitive relationship, it’s usually hard to absorb. But understanding it is critical to developing software at maximum efficiency.</p>
</blockquote>
<h2 id="醍醐灌顶">醍醐灌顶</h2>
<p>直到现在，直到读了 Martin Fowler 的这篇文章，直到将软件质量区分为 <strong>内部质量</strong> 和 <strong>外部质量</strong>，直到了解到 <strong>成本</strong> 和 <strong>内部质量</strong> 之间的这种不寻常、但又违反直觉、讲不清道不明、剪不断理还乱的关系，我才明白，我为什么会有本文开头所列的种种迷惑和不解，我才找到了一直追寻的答案。</p>
<h4 id="越是新业务-越要及早重视内部质量">越是新业务，越要及早重视内部质量</h4>
<p>最开始的时候，我也认为在新业务的早期，没有必要过早的建设单元测试、自动化测试、接口文档等工作。对这个事情的认知改变始于 2014 年开始参与的 <strong>宝宝知道</strong> 这款产品的研发工作。</p>
<p>当时，我负责这款产品的服务端测试工作。在 1.0 版本的测试过程中，没有接口文档、没有单元测试用例、没有接口测试用例……整个测试过程就是利用 <code>curl</code> 命令发起请求，然后手动逐一校验返回结果中的每一个字段，校验字段的类型、字段的结果、数据库中的数据……</p>
<p>当 1.0 版本上线的时候，我就在想，不能再这么搞了，效率太低了。恰巧那个时候，研发同学正在推动接口定义的文档化：使用 <code>json</code> 定义接口，然后服务端、iOS 端、Android 端利用该接口定义自动生成各自需要的对象实体。</p>
<p>在新接口设计之初，团队内所有角色都会参与进来一起制定对应接口的 <code>json</code> 格式的接口定义，然后由服务端 RD 存储在代码库之中。借助于这种有利的形式，我开始和 RD 讨论：在 RD 编写代码时，测试人员同步编写自动化接口测试用例的可行性。</p>
<p>最终，我和 RD 一拍即和，在随即开始的下一次迭代开发中，RD 在开发过程中，我也在根据接口定义文档来编写该接口的自动化测试用例。我把之前手工校验的所有校验点全部用代码的方式来实现。同时，为了兼顾到架构层面的风险，我和 RD 约定：每天下午5点，RD 需要将当前的代码入库，然后我就可以拉取到 RD 的代码，并执行 <strong>代码走读</strong>，同时也可以根据目前的代码来及时修正自动化测试的校验点。</p>
<p>我每天都会花费一些时间来编写自动化测试用例，走读代码，修正自动化测试用例。就这样，不断的把原本在 Excel 中的手工测试用例切换到了自动化测试用例。当然，在测试用例设计上，比 1.0 版本的测试设计花费了更多的时间。但是，当 RD 提测的时候，对于测试执行的时间，则比之前大大缩短，我只花了 10 分钟左右的时间就完成了测试。到后来，RD 在开发过程中也用上了我编写的自动化测试用例，RD 在开发中调试、定位、修复问题的效率也大为提升。后来，服务端的架构做了一些调整，例如：数据库迁移、缓存机制、异步提交机制……在自动化测试用例的帮助下，我发现，对于我们而言，这种变更变得非常可控。</p>
<p><strong>时至今日，每当回想起来，我都认为，在项目的初期就采用了代码化的接口定义文档、完善的自动化测试用例等有利于提升 <em>内部质量</em> 的措施，才保证了之后的交付效率，才使得作为后来者的 <em>宝宝知道</em> 在之后的竞争中及时抓住市场机会、获取市场先机，在众多母婴类产品中脱颖而出。</strong></p>
<h4 id="忽略内部质量-欲速则不达">忽略内部质量，欲速则不达</h4>
<p>机缘巧合，我有幸能够观察到更多的新业务的交付过程。对于新业务而言，唯快不破。然而，对于新业务，我发现总会出现 Martin Fowler 所说的那种情况：</p>
<ul>
<li>团队普遍会拒绝为那些没有效果的 <strong>内部质量</strong> 付出更多的资源和成本</li>
<li>团队每天都疲于实现用户可感知到的功能，每天都围绕着 <strong>外部质量</strong> 而忙碌</li>
</ul>
<p>我总能听到这些团队的决策者说：现在业务处于逻辑验证期，要保证功能的快速上线，其他的事情（架构设计、接口文档、自动化测试……）都先放一下，优先保证功能上线。</p>
<p>据我多年的观察，我发现，凡是有这种思想的业务，总会在最该快速奔跑的时刻受到 <strong>内部质量</strong> 的束缚。残缺的架构设计，丢失的接口文档，无法快速验证软件是否正常的自动化测试能力……所有的这些因素导致功能迭代的效率急剧下降，同时带来的还有产品质量的持续走低。</p>
<p>团队着急将某个新特性发布到线上，然而，数小时之后线上开始出现了异常：</p>
<ul>
<li>团队不得不回滚这次新特性的发布，并花费很大的代价来定位&amp;修复问题，然后再次将新特性推送给用户。</li>
<li>更严重的是，功能回滚、问题定位&amp;修复、功能再发布占用了其他新特性的研发时间，打乱了团队的研发节奏，进而严重影响了交付的效率，增加了交付的成本。</li>
<li>最后，为了体现对该问题的重视，每当这个时候，团队会放下手里的新特性，“郑重其事”的对问题的来龙去脉进行复盘，以避免类似的事情再次发生。然而，我观察到，每次的结果总是：年年岁岁花相似，岁岁年年人不同。</li>
<li>直到团队内部所有的人都无法再忍受类似的事情了，无法再忍受那看也看不懂、改也没法改、需要猜来猜去的代码了，一种有趣的现象随之出现：重构，大规模的重构。然而，因为新业务缺乏对应的快速验证的有效手段，因此，此时的重构需要花费高昂的成本。而重构本身又是一种没有 <strong>价值增值</strong> 的行为，当团队花费巨大的成本完成重构的时候，有可能已经错过市场的机会。</li>
</ul>
<p>新业务总想着快速起跑，而忽略了检查自己的装备，倒出鞋里的沙子，系紧鞋带……新业务总认为这些事情会占用跑步的时间，到后来才发现，不久之后，这些事情就会降低跑步的速度，导致我们不得不在之后的某个时间点停下脚步去处理这些事情。在这个时候，就这样眼睁睁的看着别人以不断增加的加速度来奔跑。欲速则不达，非不想，实不能。</p>
<h4 id="忽略内部质量带来的破窗效应">忽略内部质量带来的破窗效应</h4>
<blockquote>
<p><strong>破窗原理</strong></p>
<p>一扇破损的窗户，只要一段时间不去修理，建筑中的居民就会潜移默化地产生一种被遗弃的感觉——当权者不关心这幢建筑的感觉。</p>
<p>然后，其他的窗户也开始损坏，居民开始乱丢废物，墙上开始出现涂鸦，建筑开始出现严重的结构性损坏。</p>
<p>在看上去很短的时间内，建筑的损坏程度就足以打消业主们想修好它的期望，被遗弃的感觉终变成了现实。</p>
</blockquote>
<p>在项目启动的初期，遗留在项目中的那些被忽视的 <strong>内部质量</strong> 问题，就会像破窗效应一样在后续的开发中不断蔓延、扩散。如果低头看一下键盘就会发现，我们总会使用：<code>ctrl + c</code> 和 <code>ctrl +v</code>，每一次这样的操作，都有可能放大那些之前被忽视的 <strong>内部质量</strong> 而带来的问题。</p>
<ul>
<li>原来的代码就是这样写的，之前也都没有问题，为什么现在会出问题呢？</li>
<li>我就是复制了原来的代码而已？</li>
<li>……</li>
</ul>
<p>永远不要指望一个一开始就忽视 <strong>内部质量</strong> 的项目，能够在项目的后期会有较好的质量和迭代效率，我从未见过这样的奇迹发生。</p>
<h4 id="忽略内部质量-远不止成本的增加那样简单">忽略内部质量，远不止成本的增加那样简单</h4>
<p>我们处在一个“数字化生活”的时代，软件对我们日常生活的影响从未像现在一样如此巨大。依赖强大的软件和网络，新发生的事情在数分钟内就会触达世界各地。我们日常生活的各个方面越来越离不开各类软件和网络的支持，我们网上购物、在线支付、利用网络查询信息、和家人互动……</p>
<p>因此，软件带来的问题对我们生活的影响比以往任何一个时期都要严重。2021 年 8 月 30 日，特斯拉汽车互联网网络出现宕机，导致 Model3 车主无法开启车辆。即便是软件偶尔的异常有可能会影响到我们的心情甚至是生活状态。因此，我们对软件的可靠性的理解要比之前更进一步，软件 N 个 9 的可靠性难道不会产生影响用户心情甚至是生活状态的事情了？</p>
<p>在最开始就忽视了 <strong>内部质量</strong> 而带来的问题，远不只 Martin Fowler 文中所说的会增加未来的变革成本那样简单，他们还会对我们的日常生活带来烦恼。</p>
<h2 id="起步时就关注内部质量吧">起步时就关注内部质量吧</h2>
<p>不要再自欺欺人了，不要在业务的一开始就去做 <strong>内部质量</strong> 与 <strong>效率</strong> 的权衡，这样会让我们在之后的研发中根本没有时间去权衡。</p>
<p>在新业务的初期，就应该花费一定的时间来建设那些可以提高软件 <strong>内部质量</strong> 的事情。否则，当我们在全力以赴去加速奔跑的时候，就需要停下脚步来处理因为这些 <strong>内部质量</strong> 而带来的问题。</p>
<p>做饭时，我们要不时的清理灶台和设备。因为做饭时必然会弄脏灶台和设备，如果不快速清洁的话，污垢就会变干，会变的更难去除，而所有的脏东西都会妨碍下一道菜的烹饪。</p>
<h2 id="其他案例">其他案例</h2>
<p>在 <a href="https://mp.weixin.qq.com/s/VAxY0IRwvq0uzs_lJWhNiQ">高手的战略</a> 这篇文章中，也提到了很多不同行业的案例，我们也可以用来参考。</p>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>方法论</tag>
        <tag>软件开发</tag>
        <tag>质量与成本</tag>
      </tags>
  </entry>
  <entry>
    <title>为什么 OpenCV 计算的视频 FPS 是错的</title>
    <url>/2021/11/26/Why-OpenCV-Get-the-Wrong-FPS/</url>
    <content><![CDATA[<p><img src="/2021/11/26/Why-OpenCV-Get-the-Wrong-FPS/1.jpeg" alt></p>
<p>我们有一个平台来周期性的对线上的直播流数据进行某些检测，例如黑/白屏检测、静态画面检测……在检测中，我们会根据提取到的直播流的帧率来预估要计算的帧数量，例如如果要检测 5s 的直播流，而该直播流的帧率为 20 fps，需要计算的帧数量则为 100。忽然有一天，我们发现，平台开始大面积的超时，之前只需要 2s 就能完成的计算，现在却需要 30+ 分钟。查了之后，我们发现，之所以计算超时是因为 OpenCV 计算的帧率为 2000，从而导致需要计算的帧数量从之前的 100 变为了 10000，进而引起了计算超时。</p>
<span id="more"></span>
<h2 id="opencv-如何计算帧率">OpenCV 如何计算帧率</h2>
<p>这个问题的具体描述可以参见 <a href="https://github.com/opencv/opencv/issues/21006">OpenCV Issues 21006</a>。该问题的模拟直播流片段 test.ts 可以点击<a href="https://pan.baidu.com/s/1RY0Zk5C_DOEwTXYe2SLFEg">链接</a>下载，下载提取码为 x87m。</p>
<p>如果用如下的代码获取 test.ts 的 fps，</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> FPS = cap.<span class="built_in">get</span>(cv::CAP_PROP_FPS);</span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;fps: &quot;</span> &lt;&lt; FPS &lt;&lt; std::endl;</span><br></pre></td></tr></table></figure>
<p>可以得到：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> fps: 2000</span></span><br></pre></td></tr></table></figure>
<p>用 ffprobe 对视频进行分析，</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffprobe -select_streams v -show_streams test.ts</span></span><br></pre></td></tr></table></figure>
<p>可以得到：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">codec_name=h264</span><br><span class="line">r_frame_rate=30/1</span><br><span class="line">avg_frame_rate=0/0</span><br><span class="line">……</span><br></pre></td></tr></table></figure>
<p>从 <a href="https://github.com/opencv/opencv/blob/4.x/modules/videoio/src/cap_ffmpeg_impl.hpp">opencv/modules/videoio/src/cap_ffmpeg_impl.hpp</a> 中，我们发现 fps 由 <code>CvCapture_FFMPEG::get_fps()</code> 计算而来，其计算逻辑如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">double fps &#x3D; r2d(ic-&gt;streams[video_stream]-&gt;avg_frame_rate);</span><br><span class="line">if (fps &lt; eps_zero) &#123;</span><br><span class="line">    fps &#x3D; 1.0 &#x2F; r2d(ic-&gt;streams[video_stream]-&gt;codec-&gt;time_base);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="为什么-opencv-得到的帧率是错的">为什么 OpenCV 得到的帧率是错的</h2>
<p>利用 <a href="https://github.com/wangwei1237/wangwei1237.github.io_src/blob/master/source/_posts/Why-OpenCV-Get-the-Wrong-FPS/test_time_base.cpp">test_time_base.cpp</a>，我们可以得到：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">time_base: 1&#x2F;2000</span><br><span class="line">framerate: 0&#x2F;0</span><br><span class="line">avg_framerate: 0&#x2F;0</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">r2d(ic-&gt;streams[video_stream]-&gt;avg_frame_rate) &#x3D; 0</span><br></pre></td></tr></table></figure>
<p>所以 OpenCV 采用了 <a name="opencv-framerate"></a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.0 &#x2F; r2d(ic-&gt;streams[video_stream]-&gt;codec-&gt;time_base) </span><br></pre></td></tr></table></figure>
<p>来计算该视频的 fps。而此处的 <strong>time_base = 1/2000</strong>，因此，最终得到的 fps 是 2000。</p>
<p>也就是说，<strong>AVStream-&gt;codec-&gt;time_base</strong> 的值导致了 OpenCV 得到一个看起来是错误的 fps。那么，<strong>AVStream-&gt;codec-&gt;time_base</strong> 为什么是这个数呢？FFmpeg 是怎么计算这个字段的呢？</p>
<h2 id="ffmpeg-如何计算-avcodeccontext-time-base">FFmpeg 如何计算 AVCodecContext.time_base</h2>
<p><strong>AVStream-&gt;codec-&gt;time_base</strong> 是 <strong>AVCodecContext</strong> 中定义的 <strong>time_base</strong> 字段，根据 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/avcodec.h">libavcodec/avcodec.h</a> 中的定义，该字段的解释如下：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * This is the fundamental unit of time (in seconds) in terms</span></span><br><span class="line"><span class="comment">  * of which frame timestamps are represented. For fixed-fps content,</span></span><br><span class="line"><span class="comment">  * timebase should be 1/framerate and timestamp increments should be</span></span><br><span class="line"><span class="comment">  * identically 1.</span></span><br><span class="line"><span class="comment">  * This often, but not always is the inverse of the frame rate or field rate</span></span><br><span class="line"><span class="comment">  * for video. 1/time_base is not the average frame rate if the frame rate is not</span></span><br><span class="line"><span class="comment">  * constant.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * Like containers, elementary streams also can store timestamps, 1/time_base</span></span><br><span class="line"><span class="comment">  * is the unit in which these timestamps are specified.</span></span><br><span class="line"><span class="comment">  * As example of such codec time base see ISO/IEC 14496-2:2001(E)</span></span><br><span class="line"><span class="comment">  * vop_time_increment_resolution and fixed_vop_rate</span></span><br><span class="line"><span class="comment">  * (fixed_vop_rate == 0 implies that it is different from the framerate)</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * - encoding: MUST be set by user.</span></span><br><span class="line"><span class="comment">  * - decoding: the use of this field for decoding is deprecated.</span></span><br><span class="line"><span class="comment">  *             Use framerate instead.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">AVRational time_base;</span><br></pre></td></tr></table></figure>
<p>从中可以看出，对于解码而言，<strong>time_base</strong> 已经被废弃，需要使用 <strong>framerate</strong> 来替换 <strong>time_base</strong>。并且，对于固定帧率而言，<strong>time_base = 1/framerate</strong>，但是，并非总是如此。</p>
<p>利用 <a href="https://github.com/shi-yan/H264Naked">H264Naked</a> 对 test.ts 对应的 H264 码流进行分析，我们得到 <a name="sps">SPS.Vui</a> 信息：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">timing_info_present_flag :1</span><br><span class="line">num_units_in_tick :1</span><br><span class="line">time_scale :2000</span><br><span class="line">fixed_frame_rate_flag :0</span><br></pre></td></tr></table></figure>
<p>从中可以看到，test.ts 是非固定帧率视频。从 <a href="https://github.com/wangwei1237/wangwei1237.github.io_src/blob/master/source/_posts/Why-OpenCV-Get-the-Wrong-FPS/test_time_base.cpp">test_time_base.cpp</a> 的结果看，test.ts 视频中，<strong>framerate = 0/0</strong>，而 <strong>time_base = 1/2000</strong>。</p>
<p>难道，对于非固定帧率视频而言，<strong>time_base</strong> 和 <strong>framerate</strong> 之间没有关联？如果存在关联，那又是怎样的运算才能产生这种结果？这个 <strong>time_base</strong> 究竟是怎么计算的呢？究竟和 <strong>framerate</strong> 有没有关系呢？一连串的问题随之而来……</p>
<p>源码面前，了无秘密。接下来，带着这个问题，我们来一起分析一下 FFmpeg 究竟是如何处理 <strong>time_base</strong> 的。</p>
<h2 id="avformat-find-stream-info">avformat_find_stream_info</h2>
<p>在 FFmpeg 中，<code>avformat_find_stream_info()</code> 会对 <strong>ic-&gt;streams[video_stream]-&gt;codec</strong> 进行初始化，因此，我们可以从 <code>avformat_find_stream_info()</code> 开始分析。</p>
<p>从 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavformat/avformat.h">libavformat/avformat.h</a> 中，可以得知<code>avformat_open_input()</code>会打开视频流，从中读取相关的信息，然后存储在<code>AVFormatContext</code>中，但是有时候，此处获取的信息并不完整，因此需要调用<code>avformat_find_stream_info()</code>来获取更多的信息。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">* @section lavf_decoding_open Opening a media file</span><br><span class="line">* The minimum information required to open a file is its URL, which</span><br><span class="line">* is passed to avformat_open_input(), as in the following code:</span><br><span class="line">* @code</span><br><span class="line">* <span class="keyword">const</span> <span class="keyword">char</span>    *url = <span class="string">&quot;file:in.mp3&quot;</span>;</span><br><span class="line">* AVFormatContext *s = <span class="literal">NULL</span>;</span><br><span class="line">* <span class="keyword">int</span> ret = avformat_open_input(&amp;s, url, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">* <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span><br><span class="line">*     <span class="built_in">abort</span>();</span><br><span class="line">* @endcode</span><br><span class="line">* The above code attempts to allocate an AVFormatContext, open the</span><br><span class="line">* specified file (autodetecting the format) and read the header, exporting the</span><br><span class="line">* information stored there into s. Some formats <span class="keyword">do</span> <span class="keyword">not</span> have a header <span class="keyword">or</span> <span class="keyword">do</span> <span class="keyword">not</span></span><br><span class="line">* store enough information there, so it is recommended that you call the</span><br><span class="line">* avformat_find_stream_info() function which tries to read <span class="keyword">and</span> decode a few</span><br><span class="line">* frames to find missing information.</span><br></pre></td></tr></table></figure>
<p>需要注意的是：<code>avformat_find_stream_info()</code> 会尝试通过解码部分视频帧来获取需要的信息。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read packets of a media file to get stream information. This</span></span><br><span class="line"><span class="comment"> * is useful for file formats with no headers such as MPEG. This</span></span><br><span class="line"><span class="comment"> * function also computes the real framerate in case of MPEG-2 repeat</span></span><br><span class="line"><span class="comment"> * frame mode.</span></span><br><span class="line"><span class="comment"> * The logical file position is not changed by this function;</span></span><br><span class="line"><span class="comment"> * examined packets may be buffered for later processing.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param ic media file handle</span></span><br><span class="line"><span class="comment"> * @param options  If non-NULL, an ic.nb_streams long array of pointers to</span></span><br><span class="line"><span class="comment"> *                 dictionaries, where i-th member contains options for</span></span><br><span class="line"><span class="comment"> *                 codec corresponding to i-th stream.</span></span><br><span class="line"><span class="comment"> *                 On return each dictionary will be filled with options that were not found.</span></span><br><span class="line"><span class="comment"> * @return &gt;=0 if OK, AVERROR_xxx on error</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @note this function isn&#x27;t guaranteed to open all the codecs, so</span></span><br><span class="line"><span class="comment"> *       options being non-empty at return is a perfectly normal behavior.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @todo Let the user decide somehow what information is needed so that</span></span><br><span class="line"><span class="comment"> *       we do not waste time getting stuff the user does not need.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avformat_find_stream_info</span><span class="params">(AVFormatContext *ic, AVDictionary **options)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>avformat_find_stream_info()</code> 的整体逻辑大致如下图所示，其中特别需要关注图中所示的 7 个步骤：<br>
<img src="/2021/11/26/Why-OpenCV-Get-the-Wrong-FPS/2.png" alt></p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">avformat_find_stream_info() 的重要步骤说明
</p><ul>
<li><a name="step1"><strong>STEP 1</strong></a>. 设置线程数，避免 H264 多线程解码时没有把 <strong>SPS/PPS</strong> 信息提取到 <strong>extradata</strong>。</li>
<li><strong>STEP 2</strong>. 设置 <code>AVStream *st</code>，<strong>st</strong> 会在后续的函数调用中一直透到 <code>try_decode_frame()</code>。</li>
<li><a name="step4"><strong>STEP 4</strong></a>. 设置 <code>AVCodecContext *avctx</code> 为透传的 <strong>st-&gt;internal-&gt;avctx</strong>，在后续的解码函数调用中，一直透传的就是这个 <strong>avctx</strong>，因此，从这里开始的执行流程，FFmpeg 使用的全部都是 <strong>st-&gt;internal-&gt;avctx</strong>，而不是 <strong>st-&gt;codec</strong>，这里要特别的注意。此处同时会设置解码的线程数，其目的和 <a href="#step1">STEP 1</a>是一致的。</li>
<li><a name="step5"><strong>STEP 5</strong></a>. 因为之前设置了解码线程数为 1，因此此处会调用
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ret = avctx-&gt;codec-&gt;decode(avctx, frame, &amp;got_frame, pkt)</span><br></pre></td></tr></table></figure>
来解码并计算 <strong>avctx-&gt;framerate</strong>。
注意，此处的 <strong>avctx</strong> 实际上是透传而来的 <strong>st-&gt;internal-&gt;avctx</strong>。计算 <strong>framerate</strong> 的逻辑会在 <a href="#framerate">如何计算 framerate</a> 介绍。</li>
<li><a name="step6"><strong>STEP 6</strong></a>. 根据解码器得到的 <strong>framerate</strong> 信息来计算 <strong>avctx-&gt;time_base</strong>，注意此处实际上是 <strong>st-&gt;internal-&gt;avctx-&gt;time_base</strong>。
根据 <a href="#framerate">下文 framerate 的计算</a> 可知，此处 <strong>framerate</strong> = {1000, 1}。
根据 <a href="#ticks_per_frame">AVCodecContext.ticks_per_frame 的介绍</a> 可知，<strong>ticks_per_frame</strong> = 2。
因此，此处 <strong>avctx-&gt;time_base</strong> = {1, 2000}：
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">avctx-&gt;time_base = av_inv_q(av_mul_q({1000, 1}, {2, 1})) = {1, 2000}</span><br></pre></td></tr></table></figure></li>
<li><a name="step7"><strong>STEP 7</strong></a>. 这一步可谓是“瞒天过海，明修栈道暗度陈仓”，这一步为了解决 API 的前向兼容，做了一个替换，把 <strong>st-&gt;internal-&gt;avctx-&gt;time_base</strong> 赋值给了 <strong>st-&gt;codec-&gt;time_base</strong>，而把 <strong>st-&gt;avg_frame_rate</strong> 赋值给了 <strong>st-&gt;codec-&gt;framerate</strong>。因此：
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">st-&gt;codec-&gt;time_base = {1, 2000}</span><br><span class="line">st-&gt;codec-&gt;framerate = {0, 0}</span><br></pre></td></tr></table></figure>
<strong>st-&gt;codec-&gt;time_base</strong> 的计算和 <strong>st-&gt;codec-&gt;framerate</strong> 之间没有任何关系，而是和 <strong>st-&gt;internal-&gt;avctx-&gt;framerate</strong> 有关。本质而言，和 <strong>sps.time_scale</strong>，<strong>sps.num_units_in_tick</strong> 有关。
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">st-&gt;internal-&gt;avctx-&gt;time_base.num = sps-&gt;num_units_in_tick * </span><br><span class="line">    st-&gt;internal-&gt;avctx-&gt;ticks_per_frame</span><br><span class="line"></span><br><span class="line">st-&gt;internal-&gt;avctx-&gt;time_base.den = sps-&gt;time_scale * </span><br><span class="line">    st-&gt;internal-&gt;avctx-&gt;ticks_per_frame;</span><br><span class="line"></span><br><span class="line">st-&gt;internal-&gt;avctx-&gt;time_base = {sps-&gt;num_units_in_tick, sps-&gt;time_scale}</span><br></pre></td></tr></table></figure></li>
</ul>
</div>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition attention"><p class="admonition-title">internal->avctx->time_base & internal->framerate
</p><ul>
<li>所以实际上，<strong>internal-&gt;avctx-&gt;time_base</strong> 为：
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">avctx-&gt;time_base = sps-&gt;num_units_in_tick / sps-&gt;time_scale</span><br></pre></td></tr></table></figure></li>
<li>而，<strong>internal-&gt;avctx-&gt;framerate</strong> 则是：
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">avctx-&gt;framerate = sps-&gt;time_scale / (sps-&gt;num_units_in_tick * avctx-&gt;ticks_per_frame)</span><br></pre></td></tr></table></figure>
因此，对于 H264 码流而言，<strong>time_base = 1 / (2 * framerate)</strong>，而不是 <strong>1 / framerate</strong>。</li>
</ul>
<p>这也就是为什么 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/avcodec.h">libavcodec/avcodec.h</a> 中说：</p>
<p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">* This often, but <span class="keyword">not</span> always is the inverse of the frame rate <span class="keyword">or</span> field rate</span><br><span class="line">* <span class="keyword">for</span> video.</span><br></pre></td></tr></table></figure></p>
<p>从如上的分析可以知道：
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">avctx-&gt;framerate = <span class="number">1</span> / (avctx-&gt;time_base * avctx-&gt;ticks_per_frame)</span><br></pre></td></tr></table></figure>
因此，当 <strong>st-&gt;avg_frame_rate = 0</strong> 时，<a href="#opencv-framerate">OpenCV 计算 fps 的逻辑</a> 是错误的。</p>
<p>在 H265 中，<strong>ticks_per_frame = 1</strong>，因此对于 H265 的编码，OpenCV 是没有这个问题的。可以使用 <a href="https://www.dektec.com/products/applications/Zond/">Zond 265</a> 工具来分析一个 H265 的视频码流，然后对照 OpenCV 以及 FFmpeg 的结果来验证。</p>
</div>
<p>同时，正是如上所示的 <em><a href="#step7">STEP 7</a></em> 中的移花接木导致了 <a href="https://github.com/wangwei1237/wangwei1237.github.io_src/blob/master/source/_posts/Why-OpenCV-Get-the-Wrong-FPS/test_time_base.cpp">test_time_base.cpp</a> 的结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">st-&gt;codec-&gt;framerate: 0&#x2F;0</span><br><span class="line">st-&gt;codec-&gt;time_base: 1&#x2F;2000</span><br></pre></td></tr></table></figure>
<h2 id="ff-h264-decoder">ff_h264_decoder</h2>
<p><a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/decode.c">libavcodec/decode.c</a> 中的 <code>decode_simple_internal()</code> 中会调用对应的解码器来进行解码（<a href="#step5">STPE 5</a>）。而正如前所示，test.ts 为 H264 编码的视频流，因此，此处会调用 H264 解码器来进行解码。在 FFmpeg 中，H264 解码器位于 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/h264dec.c">libavcodec/h264dec.c</a> 中定义的 <code>const AVCodec ff_h264_decoder</code>。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> AVCodec ff_h264_decoder = &#123;</span><br><span class="line">    .name                  = <span class="string">&quot;h264&quot;</span>,</span><br><span class="line">    .type                  = AVMEDIA_TYPE_VIDEO,</span><br><span class="line">    .id                    = AV_CODEC_ID_H264,</span><br><span class="line">    .priv_data_size        = <span class="keyword">sizeof</span>(H264Context),</span><br><span class="line">    .init                  = h264_decode_init,</span><br><span class="line">    .close                 = h264_decode_end,</span><br><span class="line">    .decode                = h264_decode_frame,</span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在上文图中的 <a href="#step5">STPE 5</a> 中，</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ret = avctx-&gt;codec-&gt;decode(avctx, frame, &amp;got_frame, pkt);</span><br></pre></td></tr></table></figure>
<p>实际调用的就是</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ff_h264_decoder-&gt;h264_decode_frame(avctx, frame, &amp;got_frame, pkt);</span><br></pre></td></tr></table></figure>
<p>而此处的 <strong>avctx</strong> 也就是 <code>try_decode_frame()</code> 中的透传下来的 <strong>st-&gt;internal-&gt;avctx</strong>，即上文图中的 <a href="#step4">STEP 4</a>。</p>
<h2 id="h264-decode-frame">h264_decode_frame</h2>
<p><code>h264_decode_frame()</code> 的整体逻辑如下图所示：</p>
<p><img src="/2021/11/26/Why-OpenCV-Get-the-Wrong-FPS/3.png" alt></p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title"><a name="ticks_per_frame">AVCodecContext.ticks_per_frame</a>
</p><p>后面会用到 <strong>ticks_per_frame</strong> 来计算 <strong>framerate</strong>。在 <a href="#step6">STEP 6</a> 中计算 <strong>time_base</strong> 的时候也用到了该值。因此，有必要做一下特殊说明。
在 H264 解码器中，<strong>ticks_per_frame=2</strong>，其具体的取值可以从如下几处得知：</p>
<ul>
<li><a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/avcodec.h">libavcodec/avcodec.h</a> 中的字段说明：
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * For some codecs, the time base is closer to the field rate than the frame rate.</span></span><br><span class="line"><span class="comment"> * Most notably, H.264 and MPEG-2 specify time_base as half of frame duration</span></span><br><span class="line"><span class="comment"> * if no telecine is used ...</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Set to time_base ticks per frame. Default 1, e.g., H.264/MPEG-2 set it to 2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> ticks_per_frame;</span><br></pre></td></tr></table></figure></li>
<li><a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/h264dec.c">libavcodec/h264dec.c</a> 中的 <code>h264_decode_init()</code>：
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">avctx-&gt;ticks_per_frame = <span class="number">2</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</div>
<h2 id="如何计算-framerate">如何计算 framerate</h2>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">如何计算 st->internal->avctx->framerate
</p><ul>
<li>STEP 1. 根据整体的计算流程可知，此处的 <strong>h</strong> 实际上就是 <code>avformat_find_stream_info()</code> 中的 <strong>st-&gt;internal-&gt;avctx-&gt;priv_data</strong>。<strong>h</strong> 会一直透传到之后的所有流程，这个务必要注意。</li>
<li>STEP 2. 此处会首先获取到 <strong>sps</strong> 的相关信息，以备后续的计算使用，我们可以再次看一下 <a href="#sps">test.ts sps</a> 的相关信息。
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">timing_info_present_flag :1</span><br><span class="line">num_units_in_tick :1</span><br><span class="line">time_scale :2000</span><br><span class="line">fixed_frame_rate_flag :0</span><br></pre></td></tr></table></figure></li>
<li>STEP 3. 根据 <strong>sps</strong> 的相关信息计算 <strong>framerate</strong>，在上文的 <a href="#step6">STEP 6</a> 中计算 <strong>time_base</strong> 用到的 <strong>framerate</strong> 就是在此处计算的。因为 <strong>timing_info_present_flag = 1</strong>，因此会执行计算 <a name="framerate"><code>framerate</code></a> 的逻辑：
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">avctx-&gt;framerate.den = sps-&gt;num_units_in_tick * h-&gt;avctx-&gt;ticks_per_frame = <span class="number">1</span> * <span class="number">2</span> = <span class="number">2</span></span><br><span class="line">avctx-&gt;framerate.num = sps-&gt;time_scale = <span class="number">2000</span></span><br><span class="line">avctx-&gt;framerate = (AVRational){<span class="number">1000</span>, <span class="number">1</span>}</span><br></pre></td></tr></table></figure>
因此，
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">st-&gt;internal-&gt;avctx-&gt;framerate = {<span class="number">1000</span>, <span class="number">1</span>}</span><br></pre></td></tr></table></figure></li>
</ul>
</div>
<h2 id="结论">结论</h2>
<p>通过如上的分析我们可以知道：</p>
<ul>
<li>FFmpeg 在计算 <code>AVCodecContex</code> 中的 <strong>framerate</strong> 和 <strong>time_base</strong> 的时候，会用到：
<ul>
<li><strong>sps.time_scale</strong></li>
<li><strong>sps.num_units_in_tick</strong></li>
<li><strong>AVCodecContex.ticks_per_frame</strong></li>
</ul>
</li>
<li>在 FFmpeg 中，<strong>framerate</strong> 和 <strong>time_base</strong> 的关系为：
<ul>
<li><strong>framerate = 1 / (time_base * ticks_per_frame)</strong></li>
<li><strong>time_base = 1 / (framerate * ticks_per_frame)</strong></li>
</ul>
</li>
<li>对于非 H.264/MPEG-2，<strong>ticks_per_frame=1</strong>，因此 <strong>framerate</strong> 和 <strong>time_base</strong> 是互为倒数的关系。而对于 H.264/MPEG-2 而言，<strong>ticks_per_frame=2</strong>，因此，此时，二者并非是互为倒数的关系。因此，FFmpeg 中才说，<strong>framerate</strong> 和 <strong>time_base</strong> 通常是互为倒数的关系，但并非总是如此。</li>
<li>在 OpenCV 中，对于 H.264/MPEG-2 视频而言，当 <strong>AVStream.avg_frame_rate=0</strong> 时，其计算 fps 的逻辑存在 BUG。</li>
<li>因为在解码时，<strong>AVCodecContex.time_base</strong> 已经废弃，同时 <strong>AVStream.avctx</strong> 也已经废弃，而 <code>avformat_find_stream_info()</code> 中为了兼容老的 API，因此会利用 <strong>AVStream.internal.avctx</strong> 和其他的信息来设置 <strong>AVStream.avctx</strong>。而 <strong>AVStream.avctx.time_base</strong> 取自 <strong>AVStream.internal.avctx</strong>，<strong>AVStream.avctx.framerate</strong> 则取自 <strong>AVStream.framerate</strong>。</li>
</ul>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
        <tag>OpenCV</tag>
        <tag>帧率</tag>
      </tags>
  </entry>
  <entry>
    <title>LVS 2021 会议相关内容整理和分析</title>
    <url>/2021/11/11/Analysis-For-LVS-2021/</url>
    <content><![CDATA[<p><img src="/2021/11/11/Analysis-For-LVS-2021/LVS_2021.jpeg" alt></p>
<span id="more"></span>


	<div class="row">
    <embed src="LVS_2021.pdf" width="100%" height="550" type="application/pdf">
	</div>



]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>LVS 2021</tag>
        <tag>LiveVideoStack</tag>
      </tags>
  </entry>
  <entry>
    <title>Chrome浏览器中的视频解码硬件加速</title>
    <url>/2021/10/22/Analysis-For-Hardware-Acceleration-Decoding-Of-Video-In-Chromium/</url>
    <content><![CDATA[<p><img src="/2021/10/22/Analysis-For-Hardware-Acceleration-Decoding-Of-Video-In-Chromium/1.png" alt></p>
<p>从 <a href="https://en.wikipedia.org/wiki/Google_Chrome_version_history">Google Chrome version history</a> 可以知道，2011 年 3 月 发布的 10.0.648 版本的 Chrome 浏览器就已经支持视频的硬件加速能力。从 <a href="https://www.reddit.com/r/linux/comments/l112mr/hardware_video_acceleration_now_available_in/">chromium/chrome 88 开始，视频的硬件加速已经成为默认配置</a>。</p>
<p>即便如此，因为视频的硬件解码需要 GPU 的特殊支持，而目前的视频编解码标准又比较丰富，我们如何判断 Chrome 在解码视频的时候是否启用了硬件加速呢？</p>
<span id="more"></span>
<h2 id="1-chrome-gpu">1. chrome://gpu</h2>
<p>首先，利用 <code>chrome://gpu</code> 来获取相关的 GPU 信息，这里获取的信息非常丰富，我们可以从这些信息中来判断 Chrome 是否支持特定场景的 GPU 加速。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">在这部分信息中，我们需要特别关注如下几部分的信息：
</p><ul>
<li>Graphics Feature Status</li>
<li>Driver Information</li>
<li>Display(s) Information</li>
<li>Video Acceleration Information</li>
</ul>
</div>
<h4 id="graphics-feature-status">Graphics Feature Status</h4>
<p><strong>Graphics Feature Status</strong> 反映了 GPU 对 Chrome 中的不同的能力的支持，对于我的 MacBook Pro (13-inch, 2017) 上的 Chrome 94 而言，可以得到如下的结果：</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">Graphics Feature Status
</p><ul>
<li>Canvas: Hardware accelerated</li>
<li>Compositing: Hardware accelerated</li>
<li>Metal: Disabled</li>
<li>Multiple Raster Threads: Enabled</li>
<li>Out-of-process Rasterization: Hardware accelerated</li>
<li>OpenGL: Enabled</li>
<li>Rasterization: Hardware accelerated</li>
<li>Skia Renderer: Enabled</li>
<li>Video Decode: Hardware accelerated</li>
<li>WebGL: Hardware accelerated</li>
<li>WebGL2: Hardware accelerated</li>
</ul>
</div>
<p>从中可以看出，对于 <strong>视频解码</strong> 而言，Chrome 启用了 GPU 的硬件加速。当然我们还能从如上的信息中获取更多内容，例如 WebGL 是否有 GPU 支持，GPU 的硬件加速是采用的 <a href="https://www.opengl.org/">OpenGL</a> 还是 <a href="https://developer.apple.com/cn/metal/">Metal</a>，……</p>
<h4 id="video-acceleration-information">Video Acceleration Information</h4>
<p><strong>Video Acceleration Information</strong> 显示了 Chrome 支持的硬件编解码的编解码器类型以及相关编解码器的 profile。从中我们可以判断，对于某种编解码器而言，Chrome 是否支持硬编解码。该信息大致如下表所示：</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Decoding(VideoDecoder)</td>
<td></td>
</tr>
<tr>
<td>Decode h264 baseline</td>
<td>16x16 to 4096x4096 pixels</td>
</tr>
<tr>
<td>……</td>
<td>……</td>
</tr>
<tr>
<td>Encoding</td>
<td></td>
</tr>
<tr>
<td>Encode h264 baseline</td>
<td>0x0 to 4096x2160 pixels, and/or 30.000 fps</td>
</tr>
<tr>
<td>……</td>
<td>……</td>
</tr>
</tbody>
</table>
<h2 id="2-chrome-flags">2. chrome://flags</h2>
<p>根据 <code>chrome://gpu</code> 提供的信息，我们可以判断我们所使用的 Chrome 在视频编解码时的硬件支持能力。但是，需要注意的是，具备硬件编解码能力，不代表 Chrome 就可以硬件编解码。如果没有开启这些能力，自然是无法利用 Chrome 提供的这些能力的。</p>
<p>因此，我们接下来需要判断，Chrome 是否开启了硬件编解码加速的能力，此时，我们可以使用 <code>chrome://flags</code> 来获取我们需要的信息。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">chrome://flags
</p><p><a href="https://beebom.com/chrome-flags-guide-to-enhance-web-browsing/"><strong>chrome://flags</strong> 是一组实验性功能和设置</a>，它们隐藏在 Chrome 中，供开发人员使用。这些实验性功能包括 Google 正在开发、但尚未为普通用户启用的功能。<strong>chrome://flags</strong> 可以提升我们的浏览体验，还可以让我们使用那些新的、开发中的功能。</p>
</div>
<p>在 <strong>chrome://flags</strong> 中，我们可以得到如下的信息：</p>
<p><img src="/2021/10/22/Analysis-For-Hardware-Acceleration-Decoding-Of-Video-In-Chromium/2.png" alt></p>
<p>从图中的信息，我们可以知道，对于当前的 Chrome 浏览器而言，Chrome 开启了视频的编解码硬件加速能力。</p>
<h2 id="3-chrome-media-internals">3. chrome://media-internals</h2>
<p>如上所述，对于播放的视频，根据视频属性以及 <code>chrome://gpu</code> 和 <code>chrome://flags</code> 提供的信息，我们可以大致判断出在播放该视频时，Chrome 是否使用了硬件解码。</p>
<p>但是，我们要时刻提醒自己，目前为止我们的判断还仅仅是一种猜测而言，要想确切的判断 Chrome 是否使用了硬件解码，就需要获取 Chrome 播放视频时使用的解码器。此时，就该用到 <code>chrome://media-internals</code> 工具啦。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition note"><p class="admonition-title">chrome://media-internals 
</p><p><a href="https://www.chromium.org/audio-video/media-internals"><strong>chrome://media-internals</strong></a> 是一个研究 Chrome 音频/视频内部堆栈结构的工具。目前，<strong>chrome://media-internals</strong> 可以显示如下信息：</p>
<ul>
<li>从媒体堆栈中挖掘有关正在使用的媒体播放器的所有内容，包括已缓冲数据、视频属性、事件之间的测量时间和事件日志。</li>
<li>当前音频流的状态和音量，这些信息不会与特定的 tab 关联。</li>
<li>缓存活动信息，包括对媒体缓存的读取和写入。</li>
</ul>
</div>
<p>我们可以用 Chrome 浏览器播放 <a href="https://www.bilibili.com/video/BV1jh411n7d7?spm_id_from=333.6.0.0">B 站视频上的视频</a>，然后使用 <strong>chrome://media-internals</strong> 工具进行分析，如下图所示：</p>
<p><img src="/2021/10/22/Analysis-For-Hardware-Acceleration-Decoding-Of-Video-In-Chromium/3.png" alt></p>
<p>如上图所示，媒体播放器的所有信息都会以列表的形式展现，同时列表中的每一项都会展现该项对应的播放状态。因为视频正在播放中，因此我们选择状态为 <code>kPlay</code> 的项目来查看对应的媒体播放器的信息。<strong>Player Properties</strong> 信息展示了媒体播放器的详细属性，例如：</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>……</td>
<td>……</td>
</tr>
<tr>
<td>kVideoDecoderName</td>
<td>VDAVideoDecoder</td>
</tr>
<tr>
<td>kVideoTracks</td>
<td>[{“alpha mode”:“is_opaque”,“codec”:“h264”,“coded size”:“1920x1080”,“color space”:&quot;{primaries:BT709, transfer:BT709, matrix:BT709, range:LIMITED}&quot;,“encryption scheme”:“Unencrypted”,“has extra data”:false,“hdr metadata”:“unset”,“natural size”:“1920x1080”,“orientation”:“0°”,“profile”:“h264 high”,“visible rect”:“0,0 1920x1080”}]</td>
</tr>
</tbody>
</table>
<p>根据 <a href="https://chromium.googlesource.com/chromium/src/+/39e7de240b63c0103078624d09130c4a990920d2/media/gpu/ipc/service/vda_video_decoder.h">VDAVideoDecoder</a> 的源码可以知道，VDAVideoDecoder 解码器是通过 MojoVideoDecoder 而运行于 GPU，因此我们可以确定，该 h264 编码的视频在播放时使用的是硬件解码。</p>
<p>使用 Chrome 播放一个 8K 视频，然后使用 <strong>chrome://media-internals</strong> 工具进行分析，可以得到如下信息：</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>……</td>
<td>……</td>
</tr>
<tr>
<td>kVideoDecoderName</td>
<td>Dav1dVideoDecoder</td>
</tr>
<tr>
<td>kVideoTracks</td>
<td>[{“alpha mode”:“is_opaque”,“codec”:“av1”,“coded size”:“7680x4320”,“color space”:&quot;{primaries:BT709, transfer:BT709, matrix:BT709, range:LIMITED}&quot;,“encryption scheme”:“Unencrypted”,“has extra data”:false,“hdr metadata”:“unset”,“natural size”:“7680x4320”,“orientation”:“0°”,“profile”:“av1 profile main”,“visible rect”:“0,0 7680x4320”}]</td>
</tr>
</tbody>
</table>
<p><a href="https://www.videolan.org/projects/dav1d.html">dav1d 解码器</a> 是一个跨平台的开源 AV1 解码器，因此，对于该 8K 视频而言，Chrome 在播放时使用的是 CPU 解码。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>硬件加速</tag>
        <tag>GPU</tag>
        <tag>Chrome Video Decode</tag>
      </tags>
  </entry>
  <entry>
    <title>在解决问题之前首先要正确的定义问题</title>
    <url>/2021/09/16/Define-The-Problem-Rightly-Before-Solve-It/</url>
    <content><![CDATA[<p>多年以前，我阅读了一本至今都让我受益匪浅的书：《你的灯亮着吗？》。工作中，我总会按照书中的内容来训练自己解决工作中遇到的问题。作为一名测试开发工程师，在定位 BUG 时，我也会用到该书中介绍的问题解决思维模式。</p>
<div class="douban-card-block">
	<a class="douban-card" href="https://book.douban.com/subject/1135754">
		<div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img9.doubanio.com/view/subject/s/public/s1104704.jpg');"></div>
		<div class="douban-card-left">
			<div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img9.doubanio.com/view/subject/s/public/s1104704.jpg');"></div>
		</div>
		<div class="douban-card-right" style="line-height: 1.7;">
			<div class="douban-card-item"><span>书名: </span><strong>你的灯亮着吗?</strong></div>
			<div class="douban-card-item"><span>作者: </span><span>唐纳德・高斯</span></div>
			<div class="douban-card-item"><span>出版年份: </span><span>2003-1</span></div>
			<div class="douban-card-item"><span>评分: </span><span>8.0</span></div>
		</div>
	</a>
</div>
<style>
	.douban-card-block {
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		max-height: 400px;
	}
	.douban-card {
		display: flex;
		margin: 30px 10px;
		padding: 15px;
		border-radius: 10px;
		position: relative;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		color: antiquewhite;
		text-decoration: none;
	}
	.douban-card:hover {
		text-decoration: none;
	}
	.douban-card-bgimg {
		position: absolute;
		width: 115%;
		height: 115%;
		filter: blur(15px) brightness(0.6);
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
	}
	.douban-card-left {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.douban-card-right {
		position: relative;
		display: flex;
		flex-direction: column;
		margin-left: 12px;
		font-size: 16px;
		font-family: 'Courier New', Courier, monospace;
		line-height: 1.3;
		color: antiquewhite;
	}
	.douban-card-item {
		margin-top: 4px;
	}
</style>
<p>在这本书的第一章「这是谁的问题」中提到：</p>
<blockquote>
<p>初出茅庐的问题解决者总是在还没有定义好问题的时候就仓促的给出解决方案。迫于外界环境的压力，经验丰富的问题解决者有时也耐不住性子。在这种情况下，尽管他们能找到很多方法来解决问题，但是不一定对症。</p>
</blockquote>
<p>我们一直在孜孜不倦的追求解决问题的方法、策略、妙招，却从来没有仔细想过，问题究竟是什么？</p>
<span id="more"></span>
<h2 id="缘起">缘起</h2>
<p>工作中，经常会自己定位或者帮助同事定位各种各样的 BUG。有时候，BUG 会比较简单，而有时候遇到的 BUG 则相对复杂。在帮助同事定位 BUG 的时候，经常会遇到同事描述的问题和最后实际定位之后的问题并不一致的情况。</p>
<p>在问题定位中，我们要：大胆假设，小心求证。但是，我发现，好多人只做到了大胆假设，在定位 BUG 时，大胆假设了一个问题，然后在定位过程中就把这个大胆假设的问题当成了真正的问题，结果就是在定位 BUG 的道路上越走越迷糊……</p>
<p>每次说到这个的时候，大家普遍反馈：道理是这个道理，理论我们也都懂呀，但是就是做不到呀，怎么办呢？</p>
<p>“鉴于往事，有资于治道”。</p>
<p>为了能够让大家有比较真实的体验，我准备将自己工作中遇到的类似的问题进行梳理。在梳理的过程中，由于各种原因，我无法将原始问题涉及到的内容原样呈现，我需要对原始的问题进行一定的抽象。但是，对问题抽象并不会对问题的原貌和本质进行修改，并力求做到尽量保证问题的原样呈现。</p>
<h2 id="1-为什么容器不能暴露服务的uri呢？">1. 为什么容器不能暴露服务的URI呢？</h2>
<h4 id="问题背景">问题背景</h4>
<p>我们的 CI/CD 服务类似 <a href="https://docs.github.com/en/actions">GitHub Actions</a>，当然和 GitHub Actions 的差异非常大（例如整个任务的编排机制、容器的底层机制、容器的托管机制……），但是使用起来是类似的。</p>
<p><img src="/2021/09/16/Define-The-Problem-Rightly-Before-Solve-It/actions-workflow.svg" alt></p>
<p>每当有对应的事件发生时（例如代码提交、代码合并等），就会触发一些列的自动化任务，例如代码编译、代码扫描、运行单元测试……。在执行这些自动化任务的时候，会首先分配一个容器（类似 <a href="https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners">GitHub-hosted runners</a>），然后在该容器中执行在平台上配置好的任务。</p>
<p><img src="/2021/09/16/Define-The-Problem-Rightly-Before-Solve-It/workflow.gif" alt></p>
<p>有一天，我们团队需要一个功能：<strong>开放容器中部署的 HTTP 服务，以便其他的容器可以通过 URL 来访问这个 HTTP 服务，因为这样的话就可以避免这个 HTTP 服务的多次部署（部署一次，然后供其他的多个任务来使用），从而提升效率。</strong></p>
<p>我安排了一个同事来解决这个问题。同事告诉我说，<strong>从平台的配置上看，是有暴露容器PORT的功能的，但是这个功能目前没有实现，所以需要推动平台方实现这个功能。</strong></p>
<h4 id="问题的变化">问题的变化</h4>
<p>不知道大家发现没有，到目前为止，这个案例中的问题已经发生了变化。问题从<code>在其他容器中访问另外容器中的 HTTP 服务</code> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>  </mtext><mo>⟹</mo><mtext>  </mtext></mrow><annotation encoding="application/x-tex">\implies</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.549em;vertical-align:-0.024em;"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span></span></span> <code>CI/CD 平台方需要提供暴露容器 PORT 的能力</code>。</p>
<p>这个问题的转化看起来是多么的自然而又正常。接下来，为了实现我们的目标，我们和平台方组织了一个技术讨论会，专门讨论平台方何时可以实现<strong>暴露容器 PORT</strong>的功能。</p>
<p>经过和平台方的讨论，因为涉及到端口分配、端口冲突等端口管理问题，<strong>暴露容器 PORT</strong>这个功能短时间内无法实现。</p>
<p>讨论之后，我们发现，我们需要的功能看起来是无法实现了。不是吗？</p>
<h4 id="回归最原始的问题">回归最原始的问题</h4>
<p>在技术讨论的最后，我请教了平台方技术同学我们那个最原始的问题：如果我们想要在其他容器中访问另外容器中的 HTTP 服务，有什么可行的方案吗？</p>
<p>直到这个时候，我们才知道，原来我们容器中使用的 PORT 实际上就是物理机上的 PORT。我们可以直接时候用所分配的容器的 IP 和容器中启动的 HTTP 服务的端口来直接访问这个容器内的服务。</p>
<p>这时，我的同事说，之前用 <code>ifconfig</code> 命令拿到的 IP 和容器中启动的 HTTP 服务的 PORT 测试过，是没办法访问容器内的服务的。</p>
<p>到这里，我想我大概知道问题究竟出在哪里了。<code>ifconfig</code> 获取的是宿主机的网卡 IP 地址，而对于服务器而言，一般会有多个网卡，因此该命令会得到多个 IP 地址。而对于容器的 IP 地址，我们需要使用特定的指令才能够拿到正确的容器 IP。</p>
<p>最后，我们按照平台方的技术同学提供的方法完美的实现了我们所要的功能。</p>
<h4 id="从这个案例中-发现了什么？">从这个案例中，发现了什么？</h4>
<ul>
<li><code>错把假设当证据</code>。在定位 BUG，尤其是一些比较复杂的 BUG，往往需要提出各种假设，并通过逻辑推理、寻找数据证据对其进行检验，然后再根据检验的结果提出新的假设，再对这些新假设逐一验证，不断迭代这个过程以逐步靠近 BUG 的真相。但是，提出假设时，可能已经忘了那仅仅是个假设而已，便在这个假设的基础上展开分析，最后得到一个所谓的“结论”。我的同事一开始利用 <code>ifconfig</code> 获取到的 IP 无法访问到容器内部的 HTTP 服务就得到了错误的结论，而这个结论实际上是源自使用了错误命令的一个假设而已。</li>
<li><code>给专业的人提供解决方案</code>。在一个错误的假设上，我们给平台方提出了一个解决方案。很多时候，这种解决方案可能会实现，但是更多的时候，这种解决方案大概率没法实现。但是，我们忽略了，解决方案不是问题，只是我们以为是个问题而已。这在平台方帮助我们解决真正的问题时会带来很大的干扰。我们不应该<strong>给专业的人提供解决方案</strong>，而应该<strong>给出原始问题描述，向专业人士寻求解决方案</strong>。</li>
</ul>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition warning"><p class="admonition-title">我们经常犯的错误
</p><ul>
<li>错把假设当证据</li>
<li>给专业的人提供解决方案</li>
</ul>
</div>
<h2 id="2-nginx-为什么会自动抢占某个被释放的端口？">2. Nginx 为什么会自动抢占某个被释放的端口？</h2>
<h4 id="问题背景">问题背景</h4>
<p>我个人对 Nginx 比较了解，在工作中也解决了很多业务中遇到的 Nginx 的线上问题。</p>
<p>有一天，一个同事兴致冲冲的来找我，说：</p>
<blockquote>
<p>17哥，我发现了一个 Nginx 的特殊功能——Nginx 会自动抢占某个被释放的端口。</p>
</blockquote>
<p>我之前阅读 Nginx 源码的时候，未曾发现 Nginx 有这个特殊功能，也未曾记得 Nginx 的官方文档有这个特殊功能描述，并且我不认为类似 Nginx 这类的软件，应该具备这样的能力。所以我对同事的这个<em>有趣的发现</em>提出了质疑。</p>
<p>接下来，同事兴高采烈的给我演示了这个有趣的特性。原始的演示当时没有录制，所以，我在自己的电脑上对当时的演示进行了还原，具体如下图所示。</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=933211839&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<blockquote>
<p><strong>说明1</strong>：整个的演示过程从 启动 Nginx 开始。<br>
<strong>说明2</strong>：当时演示的时候，并没有使用 <code>watch</code> 命令，仅仅使用了 <code>lsof</code> 命令。为了避免过多的手工操作，我在这里使用了 <code>watch</code> 命令。</p>
</blockquote>
<h4 id="这个有趣的演示有什么问题？">这个有趣的演示有什么问题？</h4>
<p>看完同事的演示，确实发生了 <strong>Nginx自动抢占被释放的9003端口</strong>的事情，看着演示，我陷入了深思。然后，我多次执行了 <code>lsof</code> 命令，来观察端口的占用信息。</p>
<p>我发现了一个奇怪的现象，这个现象大家观察演示图中的左上角的 <code>watch</code> 命令的结果也能发现：9003 端口的 Nginx 的 PID（进程号）在不断的发生变化。这说明 Nginx 进程在不断的重启。然后，我查看了 Nginx 的日志，发现了如下的信息：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received</span><br><span class="line">2021/09/20 10:41:34 [notice] 5315#0: exiting</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received</span><br><span class="line">2021/09/20 10:41:34 [notice] 5313#0: gracefully shutting down</span><br><span class="line">2021/09/20 10:41:34 [notice] 5313#0: exiting</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 20 (SIGCHLD) received from 5315</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: cache loader process 5315 exited with code 0</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: cache manager process 5314 exited with code 0</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 20 (SIGCHLD) received</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received from 5321</span><br><span class="line">2021/09/20 10:41:34 [notice] 5313#0: exit</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received from 5313</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received from 5313</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 20 (SIGCHLD) received from 5313</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: worker process 5313 exited with code 0</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received</span><br><span class="line">2021/09/20 10:41:34 [notice] 4943#0: signal 23 (SIGIO) received</span><br></pre></td></tr></table></figure>
<p>直到这个时候我们才发现，原来同事说的有趣的特性是 Nginx 不断的 reload 进程导致的。在 Nginx reload 时，会加载最新的配置，然后按照最新的配置启动新的 worker 进程并处理新的请求。于是，就发生了同事所说的 Nginx 的有趣的特性。</p>
<h4 id="回归问题的本质">回归问题的本质</h4>
<p>于是，经过排查，我们把一个假设转变成了假设背后的问题：<code>Nginx 为什么会自动抢占被释放的端口？</code> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>  </mtext><mo>⟹</mo><mtext>  </mtext></mrow><annotation encoding="application/x-tex">\implies</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.549em;vertical-align:-0.024em;"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">⟹</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span></span></span> <code>Nginx 为什么会不停的 reload？</code>。</p>
<p>因为找不到编译这个 Nginx 的源代码了，所以没办法确定是否是在源码层面进行了修改。</p>
<p>为了查清这个问题：</p>
<ul>
<li>我首先查看了 crontab 任务，发现机器上并没有配置类似的定时任务。</li>
<li>然后，我查看了 Nginx 加载的所有 lua 插件代码，同样也没有发现有类似的代码。</li>
<li>然后在 Nginx 信号处理的相关代码块进行的 GDB 单步调试，同样没有发现类似代码。</li>
</ul>
<p>查了 1 天多也没查到为什么这个 Nginx 会不停的 reload。因为还有其他事情，这个问题也就搁置了起来。</p>
<p>后来，过了很长时间，同事告诉我说，在机器的某个目录下，发现了一个每隔 1 秒就 reload 那个 Nginx 的脚本。直到这个时候，整个事情才变得非常清晰。</p>
<h2 id="总结">总结</h2>
<p>庭院深深深几许，楼高不见章台路。工作中，在我们解决问题的时候，我们并不是简单的执行这个问题的解决计划，在这个过程中，我们需要不断的对自己的解决计划实施自我监控，不断的监控：自己的执行是否正确，解决方案是否正确，当前的问题是否发生了默默的变化……我们还要时不时的回头看看，从而确认我们没有走错~</p>
<h2 id="案例征集">案例征集</h2>
<p>如果您也有类似的案例，可以给本文提交 <a href="https://github.com/wangwei1237/wangwei1237.github.io/issues/314">ISSUE 评论</a>，也可以在 <a href="https://github.com/wangwei1237/wangwei1237.github.io/discussions/317">讨论区</a> 留下您的案例，还可以在下方的评论处留下您的案例，我也会将这些案例增加到文章之中。</p>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>方法论</tag>
        <tag>问题定位</tag>
      </tags>
  </entry>
  <entry>
    <title>如何阅读并使用开源项目</title>
    <url>/2021/09/11/How-to-Read-and-Use-the-Open-Source-Projects/</url>
    <content><![CDATA[<p>我会经常浏览并借鉴很多开源项目的代码来完成自己的工作，有很多时候这种方法让我的工作效率非常高。阅读并借鉴开源项目的成果，让我得以站在巨人的肩膀上，使得我可以更高效的工作。</p>
<p>不知道你也是否和我一样？如果你也和我一样，那么我们是否思考过？我们在引用别人的代码完成自己的项目时，我们的项目是否变成了一个如下图所示的四不像呢？</p>
<p><img src="/2021/09/11/How-to-Read-and-Use-the-Open-Source-Projects/1.gif" alt></p>
<span id="more"></span>
<h2 id="缘起">缘起</h2>
<p>很久之前就想写一篇类似的文章，但是一直没有写。前几天，在项目中遇到了类似的问题，我才决定要花时间来写一写。</p>
<p>之前阅读过很多开源项目的代码，例如：</p>
<ul>
<li>Nginx</li>
<li>Redis</li>
<li>FFmpeg</li>
<li>VMAF</li>
<li>……</li>
</ul>
<p>从这些项目中学到了很多，也成长了很多，还曾经利用这些项目来完成过自己的工作。自认为自己对于阅读开源项目代码并利用开源项目帮助自己完成工作上还算是有一些经验。因此，正好借这篇文章将自己过去在阅读并使用开源项目上的一些思考和经验整理了出来。</p>
<h2 id="一个-cmake-的案例">一个 CMake 的案例</h2>
<p>我有一个只有几个人的小组，我们这个小组的主要工作就是探索并开发和视频质量评估、视频检测、视频相关测试等方面的平台和工具。</p>
<p>对于视频检测而言，我们开发了一个项目，可以暂且称之为 MT。整个项目用 C++ 语言来开发，并且使用 CMake 来作为编译工具。因为需要对视频进行解码处理，因此该项目会依赖 FFmpeg。一开始，我们发现，在 CMake 中，<a href="https://github.com/Microsoft/vcpkg/issues/1379">FFmpeg 并不支持使用 find_package 来查找 FFMPeg 的依</a>。为了简单期间，我们就用了暴力一点的方式来解决这个问题，我们在 CMakeLists 中写下了如下的代码：</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;$&#123;ffmpeg_include_path&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">link_directories</span>(<span class="string">&quot;$&#123;ffmpeg_lib_path&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>( MT</span><br><span class="line">    PRIVATE</span><br><span class="line">        libavutil.so</span><br><span class="line">        libavcodec.so</span><br><span class="line">        libavformat.so</span><br><span class="line">        ......</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>这段代码确实写的有些糟糕（你也可以试着说一下这段代码究竟有哪些问题），但是他看起来确实可以工作了。后来，我发现了 <a href="https://github.com/snikulov/cmake-modules/blob/master/FindFFmpeg.cmake">FindFFmpeg.cmake</a> 这个开源的库可以更优雅的实现在 CMake 中查找 FFmpeg 的依赖，于是我让一个同事来升级之前那段有些糟糕的代码。</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="keyword">include</span>(cmake/FindFFmpeg.cmake)</span><br><span class="line"></span><br><span class="line"><span class="keyword">IF</span> (APPLE)</span><br><span class="line"><span class="keyword">target_link_libraries</span>( MT</span><br><span class="line">    PRIVATE</span><br><span class="line">        libavutil.dylib </span><br><span class="line">        libavcodec.dylib </span><br><span class="line">        libavformat.dylib </span><br><span class="line">        ......</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ELSEIF</span> (UNIX)</span><br><span class="line"><span class="keyword">target_link_libraries</span>( MT</span><br><span class="line">    PRIVATE</span><br><span class="line">        libavutil.so</span><br><span class="line">        libavcodec.so</span><br><span class="line">        libavformat.so</span><br><span class="line">        ......</span><br><span class="line">)</span><br><span class="line"><span class="keyword">ENDIF</span> ()</span><br></pre></td></tr></table></figure>
<p>好吧，看起来问题是解决了。但是，我总觉得这段代码看上去有点别扭，这完全有悖于 CMake 的初衷呀：根据不同的系统链接不同动态库的逻辑为什么要这么显示的写出来？这段代码看起来就下下面这个图一样：</p>
<p><img src="/2021/09/11/How-to-Read-and-Use-the-Open-Source-Projects/2.png" alt></p>
<h4 id="我是怎么做的">我是怎么做的</h4>
<p>看到提交的代码后，我打回了同事的代码提交。没有仔细的阅读 FindFFmpeg.cmake 的代码（虽然这段代码并不多，我们也可以在短时间内看懂，但是我并没有这么做），我们首先阅读了 FindFFmpeg.cmake 的文档（其实就是代码开始的注释部分），如下所示：</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment"># - Try to find the required ffmpeg components(default: AVFORMAT, AVUTIL, AVCODEC)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Once done this will define</span></span><br><span class="line"><span class="comment">#  FFMPEG_FOUND         - System has the all required components.</span></span><br><span class="line"><span class="comment">#  FFMPEG_INCLUDE_DIRS  - Include directory necessary for using the required components headers.</span></span><br><span class="line"><span class="comment">#  FFMPEG_LIBRARIES     - Link these to use the required ffmpeg components.</span></span><br><span class="line"><span class="comment">#  FFMPEG_DEFINITIONS   - Compiler switches required for using the required ffmpeg components.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For each of the components it will additionally set.</span></span><br><span class="line"><span class="comment">#   - AVCODEC</span></span><br><span class="line"><span class="comment">#   - AVDEVICE</span></span><br><span class="line"><span class="comment">#   ......</span></span><br><span class="line"><span class="comment"># the following variables will be defined</span></span><br><span class="line"><span class="comment">#  &lt;component&gt;_FOUND        - System has &lt;component&gt;</span></span><br><span class="line"><span class="comment">#  ......</span></span><br></pre></td></tr></table></figure>
<p>因此，阅读完文档后，我们知道只需要使用 <code>$&#123;AVCODEC&#125;</code> 等就可以。于是，同事又第二次提交了升级的代码，如下所示：</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="keyword">include</span>(cmake/FindFFmpeg.cmake)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;$&#123;FFMPEG_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>( MT</span><br><span class="line">    PRIVATE</span><br><span class="line">        <span class="variable">$&#123;FFMPEG_LIBRARIES&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2021/09/11/How-to-Read-and-Use-the-Open-Source-Projects/3.png" alt></p>
<p>因此，无论在阅读别人的代码，还是在使用别人的代码之前，首先阅读代码的文档或者注释是一件非常有必要的事情，这是我们了解代码的最快速有效的手段（如果有比较规范的注释的话，一般对于比较好的开源项目，注释是比较规范的）。</p>
<h2 id="如何使用开源项目">如何使用开源项目</h2>
<h4 id="1-阅读项目的-readme">1. 阅读项目的 README</h4>
<p>一般而言， README 中会对整个项目进行简要的介绍，例如：</p>
<ul>
<li>这个项目是什么？</li>
<li>为什么要做这个项目？</li>
<li>这个项目的目的是什么？</li>
<li>这个项目都提供了什么能力？</li>
<li>如何使用这个项目提供的能力？</li>
<li>……</li>
</ul>
<p>以 VMAF 为例，阅读 <a href="https://github.com/netflix/vmaf#readme">VMAF 的 README</a> 和 <a href="https://github.com/Netflix/vmaf/blob/master/libvmaf/README.md">libvmaf 的 README</a> 能够让我们对项目的背景、目标有一个大致了解，并且能够了解到这个项目的：</p>
<ul>
<li>包含了什么能力？</li>
<li>设计逻辑是什么？</li>
<li>可以解决那些问题？</li>
<li>那些问题解决不了？</li>
<li>如何使用该项目？</li>
<li>可以从那些地方获取到更详细的信息？</li>
<li>……</li>
</ul>
<p>相比较一上来就阅读项目的源码而言，阅读 README 是了解这个项目并准备使用该项目的最快速有效的方法。如果具备可以通过阅读源码提取到项目文档的能力的话，直接阅读源码也可以，但是我认为和阅读 README 相比，阅读源码的效率还是差一点的。</p>
<h4 id="2-深入阅读需要用到的能力">2. 深入阅读需要用到的能力</h4>
<p>在 <a href="/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/">FFmpeg 解码 API 以及在解码过程中存在的丢帧问题</a> 中，我提到过我是如何利用 FFmpeg API 中的代码注释来定位并解决我们小组开发的工具中存在的 BUG。实际上，如果同事当时能够认真的阅读 <a href="https://github.com/FFmpeg/FFmpeg/blob/release/3.1/libavcodec/avcodec.h">FFmpeg avcodec</a> 的文档（代码注释），那么就不会有这篇文章中的 BUG 了。</p>
<p>因此，在阅读完 README 之后，如果要在自己的项目中使用开源项目的某个具体能力或 API，那么首先需要针对需要使用的部分更详细的阅读：</p>
<ol>
<li>
<p>开发者指南中对应的内容</p>
<ul>
<li>Developer Guides：需要首先阅读 Developer Guides 中对应的相关资料，例如 <a href="https://developer.android.com/guide/index.html">Android Developer Guides</a>，<a href="https://plugins.jetbrains.com/docs/intellij/getting-started.html">IntelliJ Platform SDK</a>……还有很多非开源项目也会有 Developer Guides，对于这种项目，Developer Guides 无疑是最好的、必须首先阅读的资料，比较典型的就是<a href="https://developer.apple.com/library/archive/navigation/">Apple Developer Guides</a>，我当时了解 iOS 消息推送相关的技术就是首先阅读的 <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/index.html#//apple_ref/doc/uid/TP40008194">Local and Remote Notification Programming Guide</a>，自我认为比查阅互联网上其他人总结的文档要高效很多。</li>
<li>Document：除了 Developer Guides 之外，项目提供的 documentation 也是需要首先阅读的内容，例如 <a href="http://nginx.org/en/docs/">nginx document</a>，<a href="https://ffmpeg.org/documentation.html">FFmpeg document</a>，……我比较喜欢使用 <a href="https://kapeli.com/dash">Dash</a> 这款 MacOS 上的这款 API document 工具，真的非常方便。每当使用一个新的 API 或者使用一个自己拿不准的 API 的时候，Dash 总是我最好的帮手。<br>
<img src="/2021/09/11/How-to-Read-and-Use-the-Open-Source-Projects/5.png" alt></li>
</ul>
</li>
<li>
<p>API 对应的代码注释<br>
很多的项目，尤其是优秀的项目会有非常优秀的代码注释（很多文档也可能是从代码注释中自动生成的）。因此，在动手写代码之前，最好还是再认真阅读以下项目代码中的注释，这对于我们理解所引用的项目会有很大好处。</p>
<p>在我的工作中，我经常会从开源代码的注释中获取灵感，进而找到解决我所遇到的问题的思路：</p>
<ul>
<li>在 <a href="/2021/09/09/Draw-Circle-Frame-Number-for-Each-Secnod-Using-FFmpeg/">用 FFmpeg 把以秒为周期的帧序号信息写入到视频</a> 一文中，我通过阅读 <a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavfilter/avfilter.h">AVFilter</a> 的注释找到了实现“把当前帧是每秒中的第几帧的信息增加到视频中”的思路。</li>
<li>在 解决 <a href="https://github.com/wangwei1237/CameraHook">Android 摄像头数据 Hook 问题</a> 时，我从阅读 <a href="https://android.googlesource.com/platform/frameworks/base/+/refs/heads/master/graphics/java/android/graphics/SurfaceTexture.java">android.graphics.SurfaceTexture</a> 的源码注释中找到了解决方案。</li>
<li>……</li>
</ul>
</li>
<li>
<p>阅读项目中给出的示例代码<br>
很多项目会直接以源代码的形式给出示例代码，这些代码会放在如下的目录中：</p>
<ul>
<li>test 目录</li>
<li>example 目录</li>
<li>……</li>
</ul>
<p>在动手写代码之前，真的建议大家在这些目录下尝试找到项目给出的使用案例。在我的项目中，每次需要用到 FFmpeg 来帮我完成工作时，我总是会第一时间去 <code>ffmpeg</code>，<code>ffprobe</code>，<code>ffplay</code> 这三个工具的实现中找到灵感。</p>
</li>
</ol>
<h4 id="3-慎用搜索引擎">3. 慎用搜索引擎</h4>
<p>真的，除非万不得已，除非是我们在执行了如上的步骤之后还没有找到解决方案时，我们才需要运用搜索引擎来帮我们找出如何使用某个项目中的特定能力的方法。我非常不建议一开始就运用搜索引擎，当然这在大多数情况下可能会解决我们的问题，但是我们会因为使用搜索引擎而错过获得更多知识、错过更全面的了解我们将要使用的对象的机会。</p>
<p>并且，我们从搜索引擎获得的方案有时候可能会存在问题，我在 <a href="/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/">FFmpeg 解码 API 以及在解码过程中存在的丢帧问题</a> 中提到的解码丢帧问题就是通过搜索引擎而得到的方案。尤其是当我们还处于某方面的新手的时候，这种情况出现的可能会更大。</p>
<h2 id="善用别人的代码">善用别人的代码</h2>
<p>善用别人的项目让我们可以站在巨人的肩膀上工作，最重要的是我们需要了解、熟悉我们所用的代码。否则，我们不但没有利用这个项目的优势，反而让自己的项目变成了恐龙。</p>
<p><img src="/2021/09/11/How-to-Read-and-Use-the-Open-Source-Projects/4.jpeg" alt></p>
<h2 id="后记">后记</h2>
<p>针对文章中提到的 <code>FindFFmpeg.cmake</code> 插件，后来，当我们将该插件应用到自己编译的 <code>FFmpeg</code> 之后，我们发现这个插件无法正常工作。直到这个时候，我和我的同事才开始仔细阅读这个插件的代码，最后发现并且修复了存在的 <a href="https://github.com/snikulov/cmake-modules/pull/2">BUG</a>。我们发现，其实，和开源软件一起成长真的非常快乐。我们要善用别人的代码，同时，我们也要一起为巨人的成长付出应有的努力。</p>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>代码阅读</tag>
      </tags>
  </entry>
  <entry>
    <title>用 FFmpeg 把以秒为周期的帧序号信息写入到视频</title>
    <url>/2021/09/09/Draw-Circle-Frame-Number-for-Each-Secnod-Using-FFmpeg/</url>
    <content><![CDATA[<p>利用 FFmpeg 的 <a href="https://ffmpeg.org/ffmpeg-filters.html#drawtext-1"><strong>drawtext</strong></a> 滤镜，我们可以把特定的文本信息绘制于视频之上。FFmpeg 的 <strong>drawtext</strong> 滤镜可以绘制的文本信息可以参见文档 <a href="https://ffmpeg.org/ffmpeg-filters.html#Text-expansion">Text expansion</a> 中的描述。例如，我们可以把视频的帧号信息描绘在视频上：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -i test.mp4 -vf drawtext=text=%&#123;n&#125;:x=50:y=50 -y output.mp4</span></span><br></pre></td></tr></table></figure>
<p>有时候，我们想绘制一些特殊的内容，比如：<strong>当前帧是每秒中的第几帧</strong>？这是一件有趣的事情，但是 <strong>drawtext</strong> 却没办法支持这种内容的绘制。在大多数场景下，我们几乎用户到这种特殊的功能，但是，如果遇到了，我们如何解决呢？</p>
<span id="more"></span>
<h2 id="不对写入信息做任何改变">不对写入信息做任何改变</h2>
<p>实际上，不进行任何改变也可以实现目的，只是我们需要对现有的工具进行一定程度的整合。一般而言，写入特殊信息到视频中去后，我们会在后续的处理中提取该信息，然后进行很多逻辑判断。</p>
<p>写入信息不做改变，那么就需要在提取信息或者更靠后的步骤进行改变。实际上我们可以在最后使用到该信息的步骤中进行判断就可以了，具体如下图所示：</p>
<p><img src="/2021/09/09/Draw-Circle-Frame-Number-for-Each-Secnod-Using-FFmpeg/1.png" alt></p>
<h2 id="修改-drawtext-滤镜">修改 drawtext 滤镜</h2>
<p>可以使用市面上的视频编辑软件把<strong>当前帧是每秒中的第几帧</strong>的信息增加到视频中，但是这种手工操作的方式还是存在一定的复杂度。</p>
<p>既然 drawtext 滤镜已经提供写入帧号信息的能力了，那么我们是否可以在 drawtext 滤镜的基础上来实现我们的目标呢？</p>
<p>带着问题，阅读了 drawtext 滤镜的源码，发现还真可以实现。</p>
<p>drawtext 滤镜使用如下的代码获取当前帧的帧序号：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">s-&gt;var_values[VAR_N] = inlink-&gt;frame_count_out + s-&gt;start_number;</span><br></pre></td></tr></table></figure>
<p>其中， <code>inlink</code> 为 <code>AVFilterLink</code> 类型的变量，而 <code>AVFilterLink</code> 本身就提供了 <code>frame_rate</code> 信息。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">AVFilterLink</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Frame rate of the stream on the link, or 1/0 if unknown or variable;</span></span><br><span class="line"><span class="comment">    * if left to 0/0, will be automatically copied from the first input</span></span><br><span class="line"><span class="comment">    * of the source filter if it exists.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * Sources should set it to the best estimation of the real frame rate.</span></span><br><span class="line"><span class="comment">    * If the source frame rate is unknown or variable, set this to 1/0.</span></span><br><span class="line"><span class="comment">    * Filters should update it if necessary depending on their function.</span></span><br><span class="line"><span class="comment">    * Sinks can use it to set a default output frame rate.</span></span><br><span class="line"><span class="comment">    * It is similar to the r_frame_rate field in AVStream.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    AVRational frame_rate;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以发现，对 drawtext 滤镜稍加改造，就可以实现目标，具体思路如下所示：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">AVRational frame_rate = inlink-&gt;frame_rate;</span><br><span class="line"><span class="keyword">int</span> fps = frame_rate.num / frame_rate.den;</span><br><span class="line">s-&gt;var_values[VAR_N] = (inlink-&gt;frame_count_out + s-&gt;start_number) % fps;</span><br></pre></td></tr></table></figure>
<p>为了增加 drawtext 的兼容性，可以为该滤镜增加一个参数来，以控制当<code>text=%&#123;n&#125;</code>的时候，滤镜绘制的帧号究竟是连续的帧号还是帧号对帧率的模。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">AVRational frame_rate = inlink-&gt;frame_rate;</span><br><span class="line"><span class="keyword">if</span> (s-&gt;c &amp;&amp; frame_rate.den &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> fps = frame_rate.num / frame_rate.den;</span><br><span class="line">    s-&gt;var_values[VAR_N] = (inlink-&gt;frame_count_out + s-&gt;start_number) % fps;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    s-&gt;var_values[VAR_N] = inlink-&gt;frame_count_out + s-&gt;start_number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>详细的修改代码可以参见 <a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2021/09/09/Draw-Circle-Frame-Number-for-Each-Secnod-Using-FFmpeg/vf_drawtext.patch">vf_drawtext.patch</a>。</p>
<h2 id="修改-drawtext-之后的效果">修改 drawtext 之后的效果</h2>
<p>此时，我们利用修改后的 drawtext 滤镜来生成我们需要视频，具体操作如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -i test.mp4 -vf drawtext=text=%&#123;n&#125;:x=50:y=50:c=1 -y output.mp4</span></span><br></pre></td></tr></table></figure>
<p>生成的视频具体如下所示：</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=975468511&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
      </tags>
  </entry>
  <entry>
    <title>视频压缩标准发展简史</title>
    <url>/2021/07/27/The-History-of-the-Video-Codec-Improvement/</url>
    <content><![CDATA[<p>多年以来，人们设计出许多不同的算法来压缩视频。视频压缩虽然听起来是一个很现代的词，但其实它从模拟视频开始，已经有很长的历史了。在本篇文章中，我会向大家一一介绍视频压缩史上的里程碑事件，正是这些事件的发生才有了今天的视频压缩。从过去到现在，各类视频压缩方法由最初的概念最终演化成现今的标准。很多压缩标准今天还在使用，人们也一直在继续开发和完善新的标准。<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<p>本文仅仅是对文献<sup class="footnote-ref"><a href="#fn1" id="fnref1:1">[1:1]</a></sup>的进一步整理，用时间轴的形式把视频压缩算法的演进历程更好的表现出来。</p>
<style>
    .cd-timeline.svelte-1aijmz5 .svelte-1aijmz5,.cd-timeline.svelte-1aijmz5 .svelte-1aijmz5::after,.cd-timeline.svelte-1aijmz5 .svelte-1aijmz5::before{-webkit-box-sizing:border-box;box-sizing:border-box}.cd-timeline.svelte-1aijmz5{font-size:1.6rem;font-family:"Droid Serif", serif;color:#7f8c97;background-color:#e9f0f5}.cd-timeline.svelte-1aijmz5 a{color:#acb7c0;text-decoration:none}.cd-timeline.svelte-1aijmz5 img{max-width:100%}.cd-timeline.svelte-1aijmz5 h1,h2{font-family:"Open Sans", sans-serif;font-weight:bold}.cd-timeline.svelte-1aijmz5{overflow:hidden;margin:2em auto}.cd-timeline__container.svelte-1aijmz5{position:relative;width:90%;max-width:1170px;margin:0 auto;padding:2em 0}.cd-timeline__container.svelte-1aijmz5::before{content:'';position:absolute;top:0;left:18px;height:100%;width:4px;background:#d7e4ed}@media only screen and (min-width: 1170px){.cd-timeline.svelte-1aijmz5{margin-top:3em;margin-bottom:3em}.cd-timeline__container.svelte-1aijmz5::before{left:50%;margin-left:-2px}}.cd-timeline__block.svelte-1aijmz5{position:relative;margin:2em 0}.cd-timeline__block.svelte-1aijmz5:after{content:"";display:table;clear:both}.cd-timeline__block.svelte-1aijmz5:first-child{margin-top:0}.cd-timeline__block.svelte-1aijmz5:last-child{margin-bottom:0}@media only screen and (min-width: 1170px){.cd-timeline__block.svelte-1aijmz5{margin:4em 0}}.cd-timeline__img.svelte-1aijmz5{position:absolute;top:0;left:0;width:40px;height:40px;border-radius:50%;-webkit-box-shadow:0 0 0 4px white, inset 0 2px 0 rgba(0, 0, 0, 0.08), 0 3px 0 4px rgba(0, 0, 0, 0.05);box-shadow:0 0 0 4px white, inset 0 2px 0 rgba(0, 0, 0, 0.08), 0 3px 0 4px rgba(0, 0, 0, 0.05)}.cd-timeline__img.svelte-1aijmz5{background:#75ce66}@media only screen and (min-width: 1170px){.cd-timeline__img.svelte-1aijmz5{width:50px;height:50px;left:50%;margin-left:-25px;-webkit-transform:translateZ(0);transform:translateZ(0)}}@-webkit-keyframes svelte-1aijmz5-cd-bounce-1{0%{opacity:0;-webkit-transform:scale(0.5);transform:scale(0.5)}60%{opacity:1;-webkit-transform:scale(1.2);transform:scale(1.2)}100%{-webkit-transform:scale(1);transform:scale(1)}}@keyframes svelte-1aijmz5-cd-bounce-1{0%{opacity:0;-webkit-transform:scale(0.5);transform:scale(0.5)}60%{opacity:1;-webkit-transform:scale(1.2);transform:scale(1.2)}100%{-webkit-transform:scale(1);transform:scale(1)}}.cd-timeline__content.svelte-1aijmz5{position:relative;margin-left:60px;background:white;border-radius:0.25em;padding:1em;-webkit-box-shadow:0 3px 0 #d7e4ed;box-shadow:0 3px 0 #d7e4ed}.cd-timeline__content.svelte-1aijmz5:after{content:"";display:table;clear:both}.cd-timeline__content.svelte-1aijmz5::before{content:'';position:absolute;top:16px;right:100%;height:0;width:0;border:7px solid transparent;border-right:7px solid white}.cd-timeline__content.svelte-1aijmz5 h2.svelte-1aijmz5{color:#303e49}.cd-timeline__content.svelte-1aijmz5 p,.cd-timeline__date.svelte-1aijmz5{font-size:1.3rem}.cd-timeline__content.svelte-1aijmz5 p{margin:1em 0;line-height:1.6}.cd-timeline__date.svelte-1aijmz5{display:inline-block}.cd-timeline__date.svelte-1aijmz5{float:left;padding:.8em 0;opacity:.7}@media only screen and (min-width: 768px){.cd-timeline__content.svelte-1aijmz5 h2.svelte-1aijmz5{font-size:2rem}.cd-timeline__content.svelte-1aijmz5 p{font-size:1.6rem}.cd-timeline__date.svelte-1aijmz5{font-size:1.4rem}}@media only screen and (min-width: 1170px){.cd-timeline__content.svelte-1aijmz5{margin-left:0;padding:1.6em;width:45%;-webkit-transform:translateZ(0);transform:translateZ(0)}.cd-timeline__content.svelte-1aijmz5::before{top:24px;left:100%;border-color:transparent;border-left-color:white}.cd-timeline__date.svelte-1aijmz5{position:absolute;width:100%;left:122%;top:6px;font-size:1.6rem}.cd-timeline__block.svelte-1aijmz5:nth-child(even) .cd-timeline__content.svelte-1aijmz5{float:right}.cd-timeline__block.svelte-1aijmz5:nth-child(even) .cd-timeline__content.svelte-1aijmz5::before{top:24px;left:auto;right:100%;border-color:transparent;border-right-color:white}.cd-timeline__block.svelte-1aijmz5:nth-child(even) .cd-timeline__date.svelte-1aijmz5{left:auto;right:122%;text-align:right}}@-webkit-keyframes svelte-1aijmz5-cd-bounce-2{0%{opacity:0;-webkit-transform:translateX(-100px);transform:translateX(-100px)}60%{opacity:1;-webkit-transform:translateX(20px);transform:translateX(20px)}100%{-webkit-transform:translateX(0);transform:translateX(0)}}@keyframes svelte-1aijmz5-cd-bounce-2{0%{opacity:0;-webkit-transform:translateX(-100px);transform:translateX(-100px)}60%{opacity:1;-webkit-transform:translateX(20px);transform:translateX(20px)}100%{-webkit-transform:translateX(0);transform:translateX(0)}}@-webkit-keyframes svelte-1aijmz5-cd-bounce-2-inverse{0%{opacity:0;-webkit-transform:translateX(100px);transform:translateX(100px)}60%{opacity:1;-webkit-transform:translateX(-20px);transform:translateX(-20px)}100%{-webkit-transform:translateX(0);transform:translateX(0)}}@keyframes svelte-1aijmz5-cd-bounce-2-inverse{0%{opacity:0;-webkit-transform:translateX(100px);transform:translateX(100px)}60%{opacity:1;-webkit-transform:translateX(-20px);transform:translateX(-20px)}100%{-webkit-transform:translateX(0);transform:translateX(0)}}
    </style>
<section class="cd-timeline js-cd-timeline svelte-1aijmz5">
    <div class="cd-timeline__container svelte-1aijmz5">
        <div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">帧间压缩首次出现</h2>
                <p>英国的 R.D. Kell 提出将帧间压缩用于模拟视频，这一概念随后便延续下来并应用在今天的数字视频上。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1929</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">差分脉冲编码调制</h2>
                <span id="more"></span>
<p>贝尔实验室的 B.M. Oliver 和 C.W. Harrison 提出可以在视频编码中使用差分脉冲编码调制（DPCM）。在此之前，DPCM 一直被用于音频（今天依然如此）。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1952</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">使用时间压缩的帧间预测编码</h2>
                <p>日本广播公司（NHK）的研究人员 Y. Taki、M. Hatori 和 S. Tanaka 提出使用时间压缩的预测性帧间视频编码的概念。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1959</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">行程长度编码</h2>
                <p>伦敦大学的研究人员 A.H. Robinson 和 C. Cherry 提出行程编码这一概念，最初用于降低模拟电视信号的传输带宽。今天，行程长度编码仍在数字视频中使用。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1967</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">CCD（电荷耦合元件）问世</h2>
                <p>美国贝尔实验室的 Willard S. Boyle 和 GeorgeE. Smith 发明世界上第一个半导体图像传感器 CCD。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1969</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">数字视频首次压缩</h2>
                <p>堪萨斯州立大学的 Nasir Ahmed 提出使用 DCT 编码压缩图像。DCT 将图像分成由不同频率组成的小块，在量化过程中，舍弃高频分量，剩下的低频分量被保存下来并用于后面的图像重建。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1972</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">DCT成为一种图像压缩算法</h2>
                <p>Nasir Ahmed 与德克萨斯大学的 T. Natarajan 和 K.R. Rao 合作，实现了DCT图像压缩算法。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1973</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">混合编码的发展过程</h2>
                <p>南加州大学的 Ali Habibi 将预测编码和 DCT 编码组合在一起使用。Habibi的算法只能应用于帧内图像，无法预测帧间图像。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1974</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">混合编码的进一步发展</h2>
                <p>John A. Roesse 和 Guner S. Robinson 进一步发展了 Habibi 的算法，使它可以应用于帧间。为此，他们尝试了各种方法，最终发现 Ahmed 的 DCT 技术和预测编码结合起来使用是最高效的。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1975</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">更快的DCT算法</h2>
                <p>陈文雄、 C.H. Smith 和S.C. Fralick一起优化了 DCT 算法，他们创立了 Compression Labs 公司，将 DCT 商业化。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1977</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">首个数字视频压缩标准 H.120 问世</h2>
                <p>前期的所有研究最终取得第一个视频压缩标准 H.120 的问世。H.120 主要用于视频会议，这是一次伟大的成就，但由于 H.120 多方面的低效，许多公司不得不试验各种方法来完善这个标准。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1984</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">H.261 获得批准</h2>
                <p>H.261 很可能是你见过或者使用过的一系列编解码器中的第一个。它是第一个有效使用帧内和帧间压缩技术的数字视频压缩标准。H.261 也是第一个在商业上成功的数字视频编码标准。它被用于全世界的视频会议，并引入混合的基于块的视频编码，该编码今天仍在许多视频标准（MPEG-1 第 2 部分、H.262/MPEG-2 第 2 部分、H.263 MPEG-4 第 2 部分、H.264/MPEG-4 第 10 部分和 HEVC）中使用。创建 H.261 标准的方法今天依然被广泛使用。</p>
<p>虽然这个标准在国际上很受欢迎，但它在刚发布时并不完整。该标准分别在 1990 年和 1993 年进行了修订。H.261 不包括处理编码的细节，仅用于解码视频。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1988</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">Motion JPEG（MJPEG）被发明</h2>
                <p>Motion JPEG 被创建出来用于计算机上的多媒体应用。这种视频压缩技术将视频每一帧都分别压缩成JPEG图像。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1992</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">出现了使用 MPEG-1 的VCD</h2>
                <p>MPEG表示Moving Pictures Experts Group（动态图像专家组），它是ISO（International Standardization Organization，国际标准化组织）与IEC（International Electrotechnical Commission，国际电工委员会）联合成立的专门针对媒体编码制定国际标准的组织。1988年左右，他们开始合作制定今天为人所知的视频编码标准——MPEG-1。与 H.261 类似，MPEG-1虽然提供了示例实现，但没有包含如何编码视频的标准。因此，MPEG-1 会根据编码方式展现出截然不同的性能。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1993</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">出现了使用 H.262 和 MPEG-2 的电视广播和 DVD</h2>
                <p>MPEG-2 和 H.262 是同一个视频标准的不同名称，它由许多公司共同开发而成。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1994</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">开始使用 DV 存储数字视频</h2>
                <p>第一个 DV 规范被称为Blue Book，其中定义了录像带、录制调制方法、磁化和基本系统数据等共同特征。DV 使用 DCT 逐帧压缩视频。同MPEG-2一样，它使用色度二次采样进行进一步压缩。DV 是由索尼和松下为专业用户和广播用户设计的。现在有了存储卡和固态驱动器，这种存储方法早已过时了。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1995</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">出现使用 MPEG-4 part 2 的互联网视频</h2>
                <p>MPEG-4 第二部分（也称为 MPEG-4 Visual）是一种与H.263兼容的标准，常用于监控摄像以及高清电视广播和 DVD。它使用了比MPEG-2更高效的算法，且压缩速度更快。不过，因为它无法处理AVC（Advanced Video Coding，高级视频编码）格式，后面才有了MPEG-4 AVC。</p>

                <span class="cd-timeline__date svelte-1aijmz5">1999</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">H264 获得批准</h2>
                <p>MPEG-4 第二部分（也称为 MPEG-4 Visual）是一种与H.263兼容的标准，常用于监控摄像以及高清电视广播和 DVD。它使用了比MPEG-2更高效的算法，且压缩速度更快。不过，因为它无法处理AVC（Advanced Video Coding，高级视频编码）格式，后面才有了MPEG-4 AVC。</p>

                <span class="cd-timeline__date svelte-1aijmz5">2003</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">H.265/HEVC 获得批准</h2>
                <p>H.265/HEVC（High Efficency Video Coding，高效率视频编码）不仅可以做到H.264所能做的一切，而且表现更佳。它将文件大小减少了 50%，并支持非常高质量的视频分辨率——高达 8K（最大分辨率为 8192x4320）。虽然你通常无需用到 8K 或无法通过今天的设备和网络获取到它，但H.265对于AR、VR和 360° 等沉浸式体验非常有用。高昂的成本是它没有得到广泛应用的主要原因。除了Netflix 和 Amazon Prime Video 等大公司可以负担这笔费用外，其他许多公司仍然选择使用 H.264。</p>

                <span class="cd-timeline__date svelte-1aijmz5">2013</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">VP9</h2>
                <p>VP9由谷歌开发，它是H.265的竞争对手。和H.265不同，它是免费的。</p>

                <span class="cd-timeline__date svelte-1aijmz5">2013</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">AV1</h2>
                <p>谷歌、亚马逊、思科、英特尔、微软、Mozilla 和 Netflix 决定一起创建一个新的视频格式标准——AV1。它是 VP9 之后的下一代视频标准，开源且免费。这种格式专为实时应用（如 WebRTC）设计且支持更高分辨率，目的是能够处理 8K 视频。</p>

                <span class="cd-timeline__date svelte-1aijmz5">2018</span>
            </div>
        </div><div class="cd-timeline__block js-cd-block svelte-1aijmz5">
            <div class="cd-timeline__img cd-timeline__img--movie js-cd-img svelte-1aijmz5">
            </div>
            <div class="cd-timeline__content js-cd-content svelte-1aijmz5">
                <h2 class="svelte-1aijmz5">H266/VVC</h2>
                <p>H.266/VVC（Versatile Video Coding，多维度视频编码）主要面向 4K 和8K视频服务。它于 2020 年 7 月发布，是目前为止最新发布的视频压缩标准。H.266进一步优化了压缩（但没有其他创新），大约可节省50%的视频码率，同时确保视频清晰度不变。它使用基于块的混合视频编码方法，其思想是找到优化和改进现有算法和压缩技术的方法。H.266编码速度仍然很慢，但该标准在较低码率下提供了良好的质量改进。</p>

                <span class="cd-timeline__date svelte-1aijmz5">2020</span>
            </div>
        </div>
    </div>
</section>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://mp.weixin.qq.com/s/TKemCfbfnOBiw72FEnDPcg">视频压缩标准简史：从1929到2020</a> <a href="#fnref1" class="footnote-backref">↩︎</a> <a href="#fnref1:1" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>编解码器</tag>
        <tag>压缩标准</tag>
      </tags>
  </entry>
  <entry>
    <title>GraphQL 实践</title>
    <url>/2021/07/17/The-First-Python-Project-For-GraphQL/</url>
    <content><![CDATA[<p><img src="/2021/07/17/The-First-Python-Project-For-GraphQL/1.png" alt></p>
<blockquote>
<p>纸上得来终觉浅，绝知此事要躬行。</p>
</blockquote>
<p>在 <a href="/2021/06/15/Preliminary-Exploration-of-the-GraphQL/">GraphQL 初探</a>一文中，对 GraphQL 进行了初步的介绍和分析。在对 GraphQL 有了一定认识之后，总想着能在实践中真正的体验一下 GraphQL。实践是检验真理的唯一标准嘛，与其轻信与网络上的各种对比分析，倒不如真正的去体验一下。</p>
<p>恰好近期有一个小型的项目需要优化，于是就在该小型项目基础上实践了 GraphQL。之前，该项目是基于 django 框架开发的 REST API，此次实践，采用 <a href="https://github.com/graphql-python/graphene-django">Graphene-Django</a> 为该项目增加了对应的 GraphQL API。</p>
<span id="more"></span>
<h2 id="项目的简化模型">项目的简化模型</h2>
<p>这个小项目的核心其实就是为各种视频物料提供一个存储和检索的微服务，该微服务具有以下的功能：</p>
<ul>
<li>存储视频以及视频的元数据</li>
<li>根据不同的条件检索满足条件的视频</li>
</ul>
<p>在该微服务中的每条视频：</p>
<ul>
<li>都包含视频标签（VideoTag）信息</li>
<li>利用该视频产生其他格式的视频（我们称之为派生视频）</li>
</ul>
<p>该项目用到的数据存储如下图所示：<br>
<img src="/2021/07/17/The-First-Python-Project-For-GraphQL/2.png" alt></p>
<ul>
<li><em>Video</em> 表中存储了视频的相关信息</li>
<li><em>DerivedVideo</em> 表中存储了派生视频的相关信息，用以记录根据 parentId 视频派生出的视频的 vid 信息</li>
<li><em>VideoTag</em> 表中存储了视频的标签信息</li>
</ul>
<p>该微服务的整体架构如下所示：<br>
<img src="/2021/07/17/The-First-Python-Project-For-GraphQL/3.png" alt></p>
<h2 id="graphql-的迁移思路">GraphQL 的迁移思路</h2>
<p>将现有的 REST API 迁移到 GraphQL API 有三种思路：</p>
<ul>
<li>完全按照 GraphQL 实现现有微服务提供的所有能力</li>
<li>利用 GraphQL 对当前系统的现有代码进行整合<br>
<img src="/2021/07/17/The-First-Python-Project-For-GraphQL/4.png" alt></li>
<li>利用 GraphQL 对当前系统的 REST API 进行封装<br>
<img src="/2021/07/17/The-First-Python-Project-For-GraphQL/5.png" alt></li>
</ul>
<p>考虑到学习成本，改造成本，服务性能等问题，最终我们决定采用第 2 种方法对当前的微服务进行 GraphQL 升级。</p>
<h2 id="graphql-迁移过程中的感想">GraphQL 迁移过程中的感想</h2>
<h4 id="graphql-改造确实具有一定的成本">GraphQL 改造确实具有一定的成本</h4>
<p>利用新技术改造老的系统必须要考虑的因素之一就是成本，这里面涉及到：</p>
<ul>
<li>新技术的学习成本</li>
<li>开发的成本</li>
<li>出现问题后的定位成本</li>
<li>……</li>
</ul>
<p>我在 GraphQL 迁移过程所花费的成本上，重点还是学习成本，主要涉及：</p>
<ul>
<li>理论学习</li>
<li>框架学习：<a href="https://docs.graphene-python.org/en/stable/">Graphene</a> 框架以及 <a href="https://docs.graphene-python.org/projects/django/en/latest/">Graphene-Django</a> 框架</li>
</ul>
<p>并且，整个学习所花费的时间比真正开发的时间要高很多，真正用于 GraphQL API 开发所花费的时间并不多。</p>
<p>在整个的开发过程中，感觉 GraphQL API 比起 REST API 而言还是会增加少许的成本的，尤其是各种 type 的定义，确实会增加一点编码的成本。另外，由于 GraphQL 类型系统的限制，GraphQL API 的开发再也不能像 REST API 那样随心所欲了。GraphQL 确实需要从接口抽象开始设计，然后到接口实现。</p>
<p>综上，GraphQL API 的开发确实要稍微的多花费一点时间。但是这额外的时间会带来额外的很多好处，比如和代码同步的接口文档。</p>
<h4 id="graphql-的代码更简练">GraphQL 的代码更简练</h4>
<p>个人感觉，在某些情况下，GraphQL 的类型系统使得其更具表达性，这可以让 GraphQL API 看起来更简练。</p>
<p>如下所示的 GraphQL Schema 中，<code>videoList</code> 字段的类型为 <code>VideoList</code>，而 <code>VideoList</code> 类型则包含一个类型为 <code>[Video]</code> 的字段。因此对于 <code>videoList</code> 字段而言，只需要处理 <code>total</code> 和 <code>hasMore</code> 字段即可。从这个层面上讲，整个的代码会更加简洁。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">type</span> Query &#123;</span><br><span class="line">  video(vid: ID!): Video</span><br><span class="line">  videoList(first: Int!, </span><br><span class="line">            after: Int, </span><br><span class="line">            codec: VideoCodec, </span><br><span class="line">            <span class="built_in">format</span>: VideoDemux, </span><br><span class="line">            resolution: VideoResolution, </span><br><span class="line">            vid: Int): VideoList</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">type</span> VideoList &#123;</span><br><span class="line">  videos: [Video!]</span><br><span class="line">  total: Int!</span><br><span class="line">  hasMore: Boolean!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尤其是在当 <code>video</code> 和 <code>videoList.videos</code> 所需的数据不一致时，GraphQL <em>按需请求</em>的特性使得服务端无需额外的改动，即可实现不同的请求方请求不同数据。而在 REST API 的老系统中，可以随处看到为了兼容不同请求方的各种补丁代码。</p>
<h4 id="graphql-更加面向服务使用者">GraphQL 更加面向服务使用者</h4>
<p>GraphQL API 完成之后，我们找了几名该服务的使用者来亲自体验 GraphQL API。得益于 GraphQL 提供的如下图所示的接口文档，大家普遍反馈使用 GraphQL API 比使用 REST API 更顺畅，更放心，更高效。使用 GraphQL API 后，再也不用到处找 API 的文档了。</p>
<p><img src="/2021/07/17/The-First-Python-Project-For-GraphQL/6.gif" width="200px"></p>
<p>对于 <code>videoList</code>，可以根据视频所用的编解码器（<code>codec</code> 参数）来进行筛选。对于下游消费者而言，如果使用 REST API，则需要通过各种格式的接口文档才能确定该参数的值；而使用 GraphQL API，则直接通过如上图所示的文档即可明确的了解到该参数的取值范围。</p>
<p>尤其是当接口文档和接口的实现不一致的时候，REST API 的文档对于使用者而言，简直就是一场噩梦。而 GraphQL API 的文档是根据 GraphQL Schema 自动生成的，因此，GraphQL 天然就具有文档和代码同步的优势。</p>
<p>尤其是在微服务大行其道的现在，相较于 REST API 而言，我认为 GraphQL API 的效率更高。这里的效率集中体现在<em>沟通效率</em>和<em>协作效率</em>。在 Sam Newman 的 <em>Monolith to Microservices</em> 的<a href="/monolith-to-microservices/docs/Breaking_Changes.html">破坏性的服务变更</a>中讲的那样：</p>
<blockquote>
<p>微服务作为更大的系统的一部分而存在。每个微服务要么使用其他微服务提供的功能，要么向其他微服务提供自己的功能，要么二者兼而有之。对于微服务架构而言，我们正在努力实现其独立可部署性。但是为了实现其独立部署，我们需要确保对微服务的修改不会干扰其下游消费者。</p>
</blockquote>
<p>因此，对于微服务架构下的系统而言，虽然不同的微服务内部可以做到独立部署，但是却不可避免的会使用到其他团队提供的微服务。当微服务的数量不断增加的同时更带来了异常复杂的沟通、协作成本，这种情况下，沟通效率可能会成为阻碍开发效能的重要因素。</p>
<p>所以，我认为，GraphQL 对于微服务架构而言具备天然的优势。当然，如果 REST API 的接口文档能够做到和代码实现同步的话，使用 REST API 也是没有问题的，但是有多少团队可以做到这一点呢？</p>
<h4 id="graphql-api-确实会有性能折损">GraphQL API 确实会有性能折损</h4>
<p>在同一台机器上，采用相同的 QPS 对同一功能的不同实现进行性能测试，最终的测试结果如下图所示：</p>
<p><img src="/2021/07/17/The-First-Python-Project-For-GraphQL/7.png" alt></p>
<p>从压测结果看，GraphQL API 的耗时比 REST API 的耗时高 <code>30ms</code> 左右。由于 GraphQL API 引入了 GraphQL Runtime 层来解析 GraphQL API 的请求，因此从性能角度看，GraphQL API 会不可避免的带来性能损耗。</p>
<p>但是，值得注意的是，GraphQL 提供的按需索取数据的能力可以最大程度的降低性能折损。例如在请求视频列表的时候，如果仅请求每个视频的 vid，url, videoMetainfo 信息，则 GraphQL API 的性能基本上能和 REST API 的性能差异会不断缩小（<code>10ms</code> 左右），具体如下图所示：</p>
<p><img src="/2021/07/17/The-First-Python-Project-For-GraphQL/8.png" alt></p>
<p>而在大部分的情况下，并不是所有的客户端请求都需要获取所有的数据，因此 GraphQL 按需索取的特性在很大程度上也解决了引入 GraphQL Runtime 层而带来的性能折损。</p>
<p>因此，在考虑 GraphQL API 性能的时候，需要综合考虑和对比，否则可能会做出非客观的结论。</p>
]]></content>
      <categories>
        <category>GraphQL</category>
      </categories>
      <tags>
        <tag>GraphQL-Python</tag>
        <tag>Graphene</tag>
        <tag>Graphene-Django</tag>
      </tags>
  </entry>
  <entry>
    <title>GraphQL 初探</title>
    <url>/2021/06/15/Preliminary-Exploration-of-the-GraphQL/</url>
    <content><![CDATA[<p><img src="/2021/06/15/Preliminary-Exploration-of-the-GraphQL/1.jpg" alt></p>
<p>早在 2019 年的时候，我在 InfoQ 上读到了一篇携程介绍其关于 GraphQL 探索的文章：<a href="https://www.infoq.cn/article/xZ0ws6_A5jmrJ6ZTPOz8">全面解析 GraphQL，携程微服务背景下的前后端数据交互方案</a>。这是我第一次接触到 GraphQL 的概念，当时并没有做深入的了解和学习，后来，在工作中，这个概念也在脑海中慢慢的淡化了。</p>
<p>今年 3 月份的时候，我在 InfoQ 上读到了爱奇艺关于 GraphQL 落地的文章：<a href="https://www.infoq.cn/article/cWTUJhYMT6DjGQOHIse2">减少重复开发，GraphQL 在低代码平台如何落地？</a>。刚开始觉得这个概念似曾相识，于是就搜索了一下，然后勾起了初次听到 GraphQL 的记忆。接下来，我在 InfoQ 上搜索了和 GraphQL 相关的内容，才发现原来有很多文章已经在介绍 GraphQL。同时，我在 GitHub 的文档中发现 GitHub 也提供了 <a href="https://docs.github.com/en/graphql">GraphQL API 文档</a>，技术的敏感性促使我下定决心来仔细&amp;深入的了解 GraphQL。</p>
<p>于是，我在 <a href="https://www.manning.com/">manning</a> 上找到了 <a href="https://www.manning.com/books/graphql-in-action">GraphQL in Action</a>（我一般会试图在这个站点找到希望了解的技术领域的最新的书籍）， 然后参照这本书，开启了我的 GraphQL 之旅。</p>
<span id="more"></span>
<h2 id="graphql-简介">GraphQL 简介</h2>
<p>对于 API 而言，GraphQL 被视为一种革命性的新思路、新技术。GraphQL 改变了前后端团队的交互方式、颠覆了前后端团队的通信方式，使得他们可以更顺畅而高效地协作。</p>
<p>正如Samer Buna在其著作 <a href="https://wangwei1237.gitee.io/shares/GraphQL_in_Action.pdf">《GraphQL in Action》</a> 中的序言中所说的那样<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>：</p>
<blockquote>
<p>早在 2015 年，Facebook 首次宣布 GraphQL 项目时，我第一次听说了 GraphQL，那个时候 GraphQL 就深深的吸引了我。并且，学习 GraphQL 是我做过的最好的时间投资之一。</p>
</blockquote>
<p>在不断的了解、学习、使用 GraphQL 之后，我也像 Samer Buna 一样，被 GraphQL 深深的吸引了。</p>
<p>关于 GraphQL 的介绍，网上已经有非常多的资料了，这里不再过多描述，具体可以参考 <a href="https://graphql.cn/">GraphQL.org</a><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>，<a href="https://docs.github.com/en/graphql">GitHub GraphQL Docs</a><sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>，以及 <a href="https://wangwei1237.gitee.io/shares/GraphQL_in_Action.pdf">GraphQL in Action</a>。</p>
<h2 id="graphql-vs-rest">GraphQL vs. REST</h2>
<p>关于 GraphQL 和 REST 之间的详细对比，我认为可以参考 <a href="https://www.apollographql.com/blog/graphql/basics/graphql-vs-rest/">GraphQL vs. REST</a> 以及 <a href="https://www.howtographql.com/basics/1-graphql-is-the-better-rest/">GraphQL is the better REST</a>，此处不再赘述了<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup> <sup class="footnote-ref"><a href="#fn5" id="fnref5">[5]</a></sup>。</p>
<h2 id="graphql-的优势有哪些">GraphQL 的优势有哪些</h2>
<p>在  <a href="https://wangwei1237.gitee.io/shares/GraphQL_in_Action.pdf">《GraphQL in Action》</a> 中，作者对 GraphQL 的优缺点做了很全面的介绍；在 <a href="https://graphql.org/">GraphQL 的社区网站</a> 上，也对 GraphQL 的优点做了全面的介绍；甚至，可以用搜索引擎搜索出一堆 GraphQL 相关的文章和资源……</p>
<p>但是，作为一个刚接触 GraphQL 的门外汉，我还是希望写一写自己学习 GraphQL 之后的感想，尤其是我觉的 GraphQL 那些能让我激动无比的特性。</p>
<h4 id="graphql-的强类型系统">GraphQL 的强类型系统</h4>
<p>在 GraphQL 中，类型系统用于描述 GraphQL Server 的能力并用于判断一个查询是否有效。类型系统还描述了查询参数的输入类型，并在 GraphQL Runtime 中检查参数值的有效性。</p>
<p>一个 GraphQL 服务是通过定义<code>类型</code>和<code>类型</code>上的<code>字段</code>来创建的，然后给每个<code>类型</code>上的每个<code>字段</code>提供<code>解析函数</code>。</p>
<p>例如，在 <a href="https://docs.github.com/en/graphql/overview/explorer">Github GraphQL Server</a> 中，使用 <code>viewer</code> 字段来描述当前登录用户的信息，而 <code>viewer</code> 的<code>类型</code>为 <code>User</code>。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">  viewer: User!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type User &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  location: <span class="built_in">String</span></span><br><span class="line">  login: <span class="built_in">String</span>!</span><br><span class="line">  name: <span class="built_in">String</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一旦启动某个 GraphQL Server，它就能接收 GraphQL 查询，并验证和执行该查询。GraphQL Server 首先会检查该查询以确保它只引用了已定义的<code>类型</code>和<code>字段</code>，然后运行指定的<code>解析函数</code>来生成结果。例如，我们可以在 <a href="https://docs.github.com/en/graphql/overview/explorer">Github GraphQL Server</a> 中运行如下的查询：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">query &#123; </span><br><span class="line">  viewer &#123; </span><br><span class="line">    login</span><br><span class="line">    name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从如上的例子可以看出，GraphQL 实际上是一种强类型的 API。与使用普通的 REST API 相比，强类型系统是 GraphQL 最吸引我的地方之一。在我看来，正是 GraphQL 强类型的特性，开创了 API 的新天地。</p>
<p>在我看来，REST API 缺乏<code>类型系统</code>特性在开发中会引入很多的问题，工作中，我经常会遇到如下的情况：</p>
<ul>
<li>上游服务修改了 REST API 的字段类型而未周知下游消费者导致下游服务异常甚至崩溃</li>
<li>服务端未返回特定字段导致客户端崩溃</li>
<li>客户端请求参数异常，导致服务端的错误率上升</li>
<li>到处找借口文档，好不容易找到了忽然发现，接口文档和接口的返回并不一致，文档太滞后了</li>
<li>……</li>
</ul>
<p>如果有一个类型系统进行约束，则情况会变的更好一点。因此，针对于 json 格式的 REST API 而言，开始出现类似 <a href="https://swagger.io/tools/swagger-ui/">Swagger UI</a> 这样的工具，利用 <a href="https://json-schema.org/">Json Schema</a> 来强化其类型系统。虽然如此，但是，在我看来，基于 Json Schema 的 REST API 类型系统仅仅是一个规范和建议而已，团队中的其他人不使用也没办法。但是，GraphQL 的类型系统是其根基，所有人必须遵守，这就在大家对接口描述形成统一认识上发挥着重要作用。</p>
<p>同样的道理，对于 <a href="https://github.com/Tencent/rapidjson/">rapidjson</a> 而言，从 v1.1 版本开始，也加入了 JSON Schema 功能，使其可以在解析或生成 JSON 时进行校验，以避免类型错误的 json 而导致的解析时崩溃问题的发生。</p>
<p>弱类型语言引入类型系统也变得越来越流行，例如微软的 <a href="https://www.typescriptlang.org/">TypeScript</a>，PHP7 的 <a href="https://www.php.net/manual/en/language.types.declarations.php">强类型模式</a>，还有 Facebook 开发的 <a href="https://hacklang.org/">Hack语言</a>……</p>
<p>弱类型语言，看似无拘无束，实则充满了混乱与危险；强类型语言，看似画地为牢，实则是另一种自由。在 GraphQL 类型系统的帮助下，我们可以精确的描述我们的接口数据，并且可以做到数据描述和接口完全对应。这种能力对于大型、多人协作式团队而言，至关重要。尤其是微服务盛行的今天，我认为，GraphQL 的强类型系统为微服务交互提供了新的活力。</p>
<h4 id="我的地盘听我的-仅要我所需">我的地盘听我的，仅要我所需</h4>
<p>在 GraphQL 中，GraphQL Runtime 确定 GraphQL Server 可以提供的能力，而消费端具体要获取哪些数据则完全由消费者说了算。对于下游消费者而言真正做到了：我的地盘，听我的！只要我所要的，不多也不少！</p>
<p>之所以说 GraphQL 是革命性的新技术，我觉得就在于此。GraphQL 改变了服务之间交互的方式，让通信双方在交互的过程中更加平等，改变了之前响应数据完全由 Server 端说了算的局面。如今，在 GraphQL 中，客户端（消费端）可以以更加平等的地位，更加积极的参与到整个的数据交互过程。</p>
<p>借助于 GraphQL 的类型系统，客户端可以更加自由的根据自己的需求来获得自己的所需，而无需收到 Server 端的限制。</p>
<p>在我的个人博客站点中，我采用 <a href="https://docs.github.com/en/actions">github action</a> 来编译并发布站点内容。站点中，会有很多基于 <a href="https://www.gitbook.com/">gitbook</a> 的书籍，并且每一本书都对应一个 github 仓库。为了加快站点的发布速度，对于每一本书籍而言，都会提前编译并且将编译产物置于 latest release 中。在发布主站内容时，我利用 <a href="https://github.com/wangwei1237/wangwei1237.github.io_src/blob/master/build_books.sh">build_books.sh</a> 脚本来获取书籍的 release 产物。如果采用REST API，则相对比较简单，直接请求如下的 <code>end point</code> 即可：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">https:<span class="comment">//api.github.com/repos/wangwei1237/$&#123;BOOKS[i]&#125;/releases/latest</span></span><br></pre></td></tr></table></figure>
<p>这种情况下，我只需要对应的 <code>assets.browser_download_url</code>字段，但是使用 REST API 我没办法控制接口的返回数据，即便我只需要某一个字段，接口还是会返给我所有的数据。</p>
<p>而如果使用 GraphQL，我就可以自己说了算了：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// GraphQL Query</span></span><br><span class="line">query <span class="function"><span class="title">getBooksAssetUrl</span>(<span class="params">$repo: <span class="built_in">String</span>!, $owner: <span class="built_in">String</span>!</span>)</span> &#123; </span><br><span class="line">  <span class="function"><span class="title">repository</span>(<span class="params">name: $repo, owner: $owner</span>)</span> &#123;</span><br><span class="line">    latestRelease &#123;</span><br><span class="line">      <span class="function"><span class="title">releaseAssets</span>(<span class="params">first: <span class="number">1</span></span>)</span> &#123;</span><br><span class="line">        nodes &#123;</span><br><span class="line">          downloadUrl</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query Variables</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;repo&quot;</span>: <span class="string">&quot;monolith-to-microservices&quot;</span>,</span><br><span class="line">  <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;wangwei1237&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query Response</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;repository&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;latestRelease&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;releaseAssets&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;nodes&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="string">&quot;downloadUrl&quot;</span>: <span class="string">&quot;https://github.com/wangwei1237/monolith-to-microservices/releases/download/v1.1.1/monolith-to-microservices.tar.gz&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，在这种情况下，GraphQL 完美的避免了不必要的数据传输（overfetching）<sup class="footnote-ref"><a href="#fn6" id="fnref6">[6]</a></sup>,尤其是对于如下的场景：流量较大，网络较差，针对不同的客户端返回不同数据……，这个特性尤为重要。更重要的是，这个特性改变了通信双方的话语权。</p>
<h4 id="精确预测响应数据">精确预测响应数据</h4>
<p>GraphQL 不但改变了通信双方的话语权，还使得客户端可以精确的预测服务端的响应。在使用 REST API 时，我们需要借助各种 API 文档才能<strong>大概</strong>预测请求的响应，在开发中，这确实是一件非常讨厌的事情。无法精确的预测请求的响应，这回直接导致代码的容错性大大折扣。谁能确保所有的接口的接口文档都会详细的穷举所有情况下的接口响应呢？据我的经验而言，很难……</p>
<p>当我请求一个没有 release 产物的的仓库时，根据 GraphQL 的类型系统，我会预测到，此时 GraphQL 会返回 null，如下所示：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// latestRelease type</span></span><br><span class="line">latestRelease: Release</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query Variables</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;repo&quot;</span>: <span class="string">&quot;wangwei1237.github.io&quot;</span>,</span><br><span class="line">  <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;wangwei1237&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query Response</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;repository&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;latestRelease&quot;</span>: <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="graphql-api-的版本控制">GraphQL API 的版本控制</h4>
<p>对于 API 的版本控制而言，GraphQL 借鉴了其他语言中的 <code>@deprecated注解</code>。如果经受过 REST API 的版本控制之痛，经受过那些 v1，v2，……，那么你也会像我一样，喜欢 GraphQL 提供的这一特性。</p>
<p>摘录Samer Buna在 <a href="https://wangwei1237.gitee.io/shares/GraphQL_in_Action.pdf">《GraphQL in Action》</a> 中的例子如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">type Query &#123;</span><br><span class="line">  hello: <span class="built_in">String</span></span><br><span class="line">  currentTime: <span class="built_in">String</span></span><br><span class="line">  sumNumbersInRange(begin: Int!, end: Int!): Int! @deprecated(reason: <span class="string">&quot;use new fields numbersInRange&quot;</span>)</span><br><span class="line">  numbersInRange(begin: Int!, end: Int!): NumbersInRange!</span><br><span class="line">  taskMainList: [Task!]</span><br><span class="line">  taskInfo(taskId: ID!): Task!</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;Aggregate info on a range numbers&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">type NumbersInRange &#123;</span><br><span class="line">  sum: Int!</span><br><span class="line">  count: Int!</span><br><span class="line">  avg: Float!</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 <code>sumNumbersInRange</code> 字段，使用 <code>@deprecated</code> 标志该字段是废弃字段，并且利用 <code>reason</code> 参数来将该废弃字段和推荐的新字段关联起来。如果配合 IDE 的代码扫描能力，当在接口中请求 <code>sumNumbersInRange</code> 的时候，IDE 给出对应的废弃提示和原因，那么经过一段时间的迭代，标记为 <code>@deprecated</code> 的字段就会慢慢消失在产品代码中。这会使得 API 的版本管理更加容易，也使得客户端更加容易理解 API 的进化和向后兼容。</p>
<p>而使用 REST API 的时候，在没有这种类似机制的帮助下，我经常会使用了上游服务准备 <code>deprecated</code> 的字段，因此，在这种情况下，准备废弃的字段不得不为了兼容而永久的保留在了服务之中。</p>
<p>我见过一个 REST API，这个 API 经过好几年的发展，每次请求都会返回 10K+ 的数据，并且里面有很多字段的含义基本一致，只不过是有些字段为了兼容某个特定的需求而增加。这个 API 中的字段谁也不敢动，能做的只能是随着需求的增加而不断的增加该 API 的规模。开发这个 API 是一件非常可怕的事情。</p>
<h2 id="如何看待-graphql-的缺点">如何看待 GraphQL 的缺点</h2>
<p>新生之物，其貌必丑。虽然 GraphQL 已经发展了几年，但是实际上而言 GraphQL 还算是一个比较新颖的技术。根据 <a href="https://wangwei1237.gitee.io/shares/GraphQL_in_Action.pdf">《GraphQL in Action》</a> 中的第 1.3 节的介绍，到目前为止，GraphQL 仍然有很多的问题需要解决，例如：</p>
<ul>
<li>安全性问题</li>
<li>缓存问题</li>
<li>学习门槛问题</li>
<li>……</li>
</ul>
<p>虽然如此，我还是认为 GraphQL 开创了 API 交互的新天地，代表着新的技术的发展方向。并且我也发现，目前整个 GraphQL 社区也在做很多的工作来解决目前的一些问题。例如 Facebook 为了解决缓存问题而开发的 dataloader 库，<a href="https://www.apollographql.com/">apollo graphql</a> 在推动 GraphQL 工业落地方面所做的各种努力，……</p>
<p>正如我在 <a href="/2021/05/01/how-to-improve-the-work-efficiency/">如何提升工作效率</a> 一文中说的那样：</p>
<blockquote>
<p>我们必须认识到，短期看，新技术会解决我们当前的问题，但是新技术必然会引入新的问题，我们需要与时俱进，在新的场景下不断解决新技术带来的问题。这有这样，才能不断的提升工作效率。</p>
<p>我们不能因为堵车，就回退到自行车的时代；我们不能因为有假币，就回退到物物交换的时代；……</p>
</blockquote>
<p>并且，目前看，GraphQL 正在变的越来越流行。Postman 博客站点的 <a href="https://blog.postman.com/postman-v7-2-supports-graphql/">Postman v7.2 Supports GraphQL</a> 中提到：</p>
<blockquote>
<p>如果您一直在等待 Postman 对 GraphQL 的支持，那么现在可以结束这种等待了。随着 Postman v7.2 的发布，Postman 已经支持 GraphQL！在 GitHub 上，<a href="https://github.com/postmanlabs/postman-app-support/issues/1669">GraphQL 的内置支持</a>一直是我们的第二大最受欢迎的特性，我们很高兴将这个流行的规范引入 Postman 应用程序。</p>
</blockquote>
<h2 id="如何判断是否要使用-graphql">如何判断是否要使用 GraphQL</h2>
<p>即便如此，在确定是否要使用 GraphQL 技术时，需要做认真的分析，且不可为了追新而采用 GraphQL。</p>
<p>如果所提供服务的下游消费者较少并且范围也较少，那么还是推荐使用 REST API。但是如果提供的服务是类似 Github Open API 这样的规模较大的服务，或者使用该服务的下游消费者范围较大、数量较多，我认为采用 GraphQL 确实是上上之选。</p>
<p>总之，越是涉及到团队交互多、团队协作多的服务，我越是建议采用 GraphQL。因为协作最复杂的地方在于 <code>communication</code>，而 GraphQL 就是革新多方协作的一种新技术。就像万维网彻底改变了人类世界的交流方式一样，我想，GraphQL 正在彻底改变 API 的交流方式，尤其是在微服务架构中<sup class="footnote-ref"><a href="#fn7" id="fnref7">[7]</a></sup> <sup class="footnote-ref"><a href="#fn8" id="fnref8">[8]</a></sup> <sup class="footnote-ref"><a href="#fn9" id="fnref9">[9]</a></sup>。</p>
<style>.admonition {
    margin: 1.5625em 0;
    padding: .6rem;
    overflow: hidden;
    font-size: 1.6rem;
    page-break-inside: avoid;
    border-left: .6rem solid #42b983;
    border-radius: .6rem;
    box-shadow: 0 0.1rem 0.4rem rgba(0,0,0,.5), 0 0 0.05rem rgba(0,0,0,.1);
    background-color: #fafafa;
  }
  
  p.admonition-title {
    position: relative;
    margin: -.6rem -.6rem .8em -.6rem !important;
    padding: .4rem .6rem .4rem .4rem;
    font-weight: 700;
    background-color:rgba(66, 185, 131, .1);
  }
  
  /*
  .admonition-title::before {
    position: absolute;
    top: .9rem;
    left: 1rem;
    width: 12px;
    height: 12px;
    background-color: #42b983;
    border-radius: 50%;
    content: ' ';
  }
  */
  
  .info>.admonition-title, .todo>.admonition-title {
    background-color: rgba(0,184,212,.1);
  }
  
  .warning>.admonition-title, .attention>.admonition-title, .caution>.admonition-title {
    background-color: rgba(255,145,0,.1);
  }
  
  .failure>.admonition-title, .missing>.admonition-title, .fail>.admonition-title, .error>.admonition-title {
    background-color: rgba(255,82,82,.1);
  }
  
  .admonition.info, .admonition.todo {
    border-color: #00b8d4;
  }
  
  .admonition.warning, .admonition.attention, .admonition.caution {
    border-color: #ff9100;
  }
  
  .admonition.failure, .admonition.missing, .admonition.fail, .admonition.error {
    border-color: #ff5252;
  }
  
  .info>.admonition-title::before, .todo>.admonition-title::before {
    background-color: #00b8d4;
    border-radius: 50%;
  }
  
  .warning>.admonition-title::before, .attention>.admonition-title::before, .caution>.admonition-title::before {
    background-color: #ff9100;
    border-radius: 50%;
  }
  
  .failure>.admonition-title::before,.missing>.admonition-title::before,.fail>.admonition-title::before,.error>.admonition-title::before{
    background-color: #ff5252;;
    border-radius: 50%;
  }
  
  .admonition>:last-child {
    margin-bottom: 0 !important;
  }
  </style>
<div class="admonition warning"><p class="admonition-title">除了如上的考虑外，还需要思考如下的问题
</p><ul>
<li>GraphQL 是否适合当前的业务发展阶段？</li>
<li>引入 GraphQL 之后的版本兼容问题、配套基础设施的改造等如何处理？</li>
<li>引入 GraphQL 是否能够在解决现有业务问题的基础上避免引入更多的问题？</li>
<li>团队内部的其他成员是否接受 GraphQL 的这种理念，例如前端人员是否乐意拥有定义接口的这种权利？</li>
<li>……</li>
</ul>
</div>
<p><img src="/2021/06/15/Preliminary-Exploration-of-the-GraphQL/2.png" alt></p>
<h2 id="graphql-分享">GraphQL 分享</h2>
<p>下载地址：<a href="https://github.com/wangwei1237/docs/releases/download/v1.0.0/GraphQL_in_Action.pdf">https://github.com/wangwei1237/docs/releases/download/v1.0.0/GraphQL_in_Action.pdf</a></p>
<h2 id="后记">后记</h2>
<p>后来，我们对一个内部的小项目实施了 GraphQL 迁移，具体的可以参见：<a href="/2021/07/17/The-First-Python-Project-For-GraphQL/">GraphQL 实践</a>。</p>
<p>再之后，我读到了一篇 PayPal 实践 GraphQL 的文章 —— <a href="https://www.infoq.cn/article/l7smlb4HFKjMZrt4wERK">PayPal 大规模采用 GraphQL 的探索和实践</a>，在这篇文章中，讲述了 PayPal 面临的问题，为什么会采用 GraphQL，如何采用 GraphQL，采用 GraphQL 还面临的问题，……这也是对”GraphQL 很难适合有业务包袱的部门和公司“的一个比较好的反驳案例。</p>
<h2 id="学习资源">学习资源</h2>
<ul>
<li><a href="https://spec.graphql.cn/">https://spec.graphql.cn/</a></li>
<li><a href="https://graphql.org/">https://graphql.org/</a> or <a href="https://graphql.cn">https://graphql.cn</a></li>
<li><a href="https://graphql.org/swapi-graphql/">https://graphql.org/swapi-graphql/</a></li>
<li><a href="https://docs.github.com/en/graphql">https://docs.github.com/en/graphql</a></li>
<li><a href="https://docs.github.com/en/graphql/overview/explorer">https://docs.github.com/en/graphql/overview/explorer</a></li>
<li><a href="https://www.apollographql.com/docs/">https://www.apollographql.com/docs/</a></li>
<li><a href="https://www.howtographql.com">https://www.howtographql.com</a></li>
<li><a href="https://wangwei1237.gitee.io/shares/GraphQL_in_Action.pdf">https://wangwei1237.gitee.io/shares/GraphQL_in_Action.pdf</a></li>
<li><a href="https://github.com/graphql/graphql-playground">https://github.com/graphql/graphql-playground</a></li>
</ul>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>Samer Buna. GraphQL in Action. Manning Publications, March 9, 2021. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://graphql.org/">https://graphql.org/</a>, <a href="https://graphql.cn/">https://graphql.cn/</a>. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://docs.github.com/en/graphql">Github Docs: GitHub GraphQL API</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://www.apollographql.com/blog/graphql/basics/graphql-vs-rest/">GraphQL vs. REST</a>. <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn5" class="footnote-item"><p><a href="https://www.howtographql.com/basics/1-graphql-is-the-better-rest/">GraphQL is the better REST</a> <a href="#fnref5" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn6" class="footnote-item"><p><a href="https://www.prisma.io/blog/top-5-reasons-to-use-graphql-b60cfa683511">Reasons to use GraphQL | Top 5 Reasons Why and How to use GraphQL</a> <a href="#fnref6" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn7" class="footnote-item"><p><a href="https://www.cloudbees.com/blog/graphql-as-an-api-gateway-to-micro-services">GraphQL as an API Gateway to Microservices</a> <a href="#fnref7" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn8" class="footnote-item"><p><a href="https://www.infoq.com/news/2021/03/netflix-graphql-microservices/">Netflix Embraces GraphQL Microservices for Rapid Application Development</a> <a href="#fnref8" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn9" class="footnote-item"><p><a href="https://netflixtechblog.com/beyond-rest-1b76f7c20ef6">Beyond REST——Rapid Development with GraphQL Microservices</a> <a href="#fnref9" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>GraphQL</category>
      </categories>
      <tags>
        <tag>GraphQL</tag>
      </tags>
  </entry>
  <entry>
    <title>不同分辨率视频的推荐码率</title>
    <url>/2021/05/28/Recommended-video-bitrates-for-different-resolutions/</url>
    <content><![CDATA[<p>视频的清晰度会受到多种因素的影响：分辨率，帧率，色深……对于UGC类型的视频业务而言，为了保证整站视频的质量，需要对用户上传的视频质量进行一点的判断。虽然不是绝对准确，但是，码率也是一种相对有效的评估指标。<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup></p>
<p><img src="/2021/05/28/Recommended-video-bitrates-for-different-resolutions/1.png" alt></p>
<p>在YouTube的帮助文档中，就提供了一份建议用于指导用户设置其上传的视频的编码参数<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>。本文对码率的推荐数据进行了摘录。</p>
<span id="more"></span>
<h2 id="sdr视频的推荐码率">SDR视频的推荐码率</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Type</th>
<th style="text-align:left">Video Bitrate <br> 标准帧率(24, 25, 30) <br> 编码器(H264)</th>
<th style="text-align:left">Video Bitrate <br> 高帧率(48, 50, 60) <br> 编码器(H264)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">2160p (4K)</td>
<td style="text-align:left">35–45 Mbps</td>
<td style="text-align:left">53–68 Mbps</td>
</tr>
<tr>
<td style="text-align:left">1440p (2K)</td>
<td style="text-align:left">16 Mbps</td>
<td style="text-align:left">24 Mbps</td>
</tr>
<tr>
<td style="text-align:left">1080p</td>
<td style="text-align:left">8 Mbps</td>
<td style="text-align:left">12 Mbps</td>
</tr>
<tr>
<td style="text-align:left">720p</td>
<td style="text-align:left">5 Mbps</td>
<td style="text-align:left">7.5 Mbps</td>
</tr>
<tr>
<td style="text-align:left">480p</td>
<td style="text-align:left">2.5 Mbps</td>
<td style="text-align:left">4 Mbps</td>
</tr>
<tr>
<td style="text-align:left">360p</td>
<td style="text-align:left">1 Mbps</td>
<td style="text-align:left">1.5 Mbps</td>
</tr>
</tbody>
</table>
<h2 id="hdr视频的推荐码率">HDR视频的推荐码率</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Type</th>
<th style="text-align:left">Video Bitrate <br> 标准帧率(24, 25, 30) <br> 编码器(H264)</th>
<th style="text-align:left">Video Bitrate <br> 高帧率(48, 50, 60) <br> 编码器(H264)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">2160p (4K)</td>
<td style="text-align:left">44–56 Mbps</td>
<td style="text-align:left">66–85 Mbps</td>
</tr>
<tr>
<td style="text-align:left">1440p (2K)</td>
<td style="text-align:left">20 Mbps</td>
<td style="text-align:left">30 Mbps</td>
</tr>
<tr>
<td style="text-align:left">1080p</td>
<td style="text-align:left">10 Mbps</td>
<td style="text-align:left">15 Mbps</td>
</tr>
<tr>
<td style="text-align:left">720p</td>
<td style="text-align:left">6.5 Mbps</td>
<td style="text-align:left">9.5 Mbps</td>
</tr>
<tr>
<td style="text-align:left">480p</td>
<td style="text-align:left">Not supported</td>
<td style="text-align:left">Not supported</td>
</tr>
<tr>
<td style="text-align:left">360p</td>
<td style="text-align:left">Not supported</td>
<td style="text-align:left">Not supported</td>
</tr>
</tbody>
</table>
<h2 id="音频的推荐码率">音频的推荐码率</h2>
<table>
<thead>
<tr>
<th style="text-align:left">Type</th>
<th style="text-align:left">Audio Bitrate <br> 采样率(96K/48K HZ) <br> 编码器(AAC-LC)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Mono</td>
<td style="text-align:left">128 kbps</td>
</tr>
<tr>
<td style="text-align:left">Stereo</td>
<td style="text-align:left">384 kbps</td>
</tr>
<tr>
<td style="text-align:left">5.1</td>
<td style="text-align:left">512 kbps</td>
</tr>
</tbody>
</table>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://www.muvi.com/blogs/video-bitrate-or-resolution-what-makes-video-streaming-better.html">https://www.muvi.com/blogs/video-bitrate-or-resolution-what-makes-video-streaming-better.html</a>. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://support.google.com/youtube/answer/1722171?hl=en&amp;ref_topic=9257782">https://support.google.com/youtube/answer/1722171?hl=en&amp;ref_topic=9257782</a>. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>IVQA</category>
      </categories>
      <tags>
        <tag>码率</tag>
        <tag>视频清晰度</tag>
      </tags>
  </entry>
  <entry>
    <title>github commit messages中的emoji使用指南</title>
    <url>/2021/05/05/An-emoji-guide-for-github-commit-messages/</url>
    <content><![CDATA[<p><img src="/2021/05/05/An-emoji-guide-for-github-commit-messages/1.gif" alt></p>
<p>在git commit messages中使用emoji表情可以包含很多有用信息，并且能够提升commit message的阅读体验。但是，需要注意的是，在commit message中，emoji不能乱用，否则容易导致误解。为了解释并标准化commit message中的emoji，<a href="https://gitmoji.dev/">Gitmoji项目</a>应运而生。</p>
<p>我们在commit message中使用emoji的时候，也应该尽量遵循<a href="(https://gitmoji.dev/)">Gitmoji</a>的规范，避免引起不必要的误会。</p>
<span id="more"></span>
<p>在commit message中使用emoji可使得我们能够仅通过emoji就可以轻松确定此次代码的提交意图。</p>
<p><a href="https://gitmoji.dev/">Gitmoji项目</a>中描述的emoji的含义如下表所示。</p>
<table>
<thead>
<tr>
<th style="text-align:center">表情</th>
<th style="text-align:left">emoji</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">🎨</td>
<td style="text-align:left"><code>:art</code></td>
<td style="text-align:left">改进结构和代码格式</td>
</tr>
<tr>
<td style="text-align:center">⚡️</td>
<td style="text-align:left"><code>:zap:</code></td>
<td style="text-align:left">优化性能</td>
</tr>
<tr>
<td style="text-align:center">🔥</td>
<td style="text-align:left"><code>:fire:</code></td>
<td style="text-align:left">移除代码或文件</td>
</tr>
<tr>
<td style="text-align:center">🐛</td>
<td style="text-align:left"><code>:bug:</code></td>
<td style="text-align:left">修复 bug</td>
</tr>
<tr>
<td style="text-align:center">🚑</td>
<td style="text-align:left"><code>:ambulance:</code></td>
<td style="text-align:left">关键修补程序</td>
</tr>
<tr>
<td style="text-align:center">✨</td>
<td style="text-align:left"><code>:sparkles:</code></td>
<td style="text-align:left">引入新功能</td>
</tr>
<tr>
<td style="text-align:center">📝</td>
<td style="text-align:left"><code>:memo:</code></td>
<td style="text-align:left">增加或者升级文档</td>
</tr>
<tr>
<td style="text-align:center">🚀</td>
<td style="text-align:left"><code>:rocket:</code></td>
<td style="text-align:left">部署新功能</td>
</tr>
<tr>
<td style="text-align:center">💄</td>
<td style="text-align:left"><code>:lipstick:</code></td>
<td style="text-align:left">升级 UI 和样式文件</td>
</tr>
<tr>
<td style="text-align:center">🎉</td>
<td style="text-align:left"><code>:tada</code></td>
<td style="text-align:left">初次提交</td>
</tr>
<tr>
<td style="text-align:center">✅</td>
<td style="text-align:left"><code>:white_check_mark:</code></td>
<td style="text-align:left">增加或升级测试用例</td>
</tr>
<tr>
<td style="text-align:center">🔒</td>
<td style="text-align:left"><code>:lock:</code></td>
<td style="text-align:left">修复安全问题</td>
</tr>
<tr>
<td style="text-align:center">🔖</td>
<td style="text-align:left"><code>:bookmark:</code></td>
<td style="text-align:left">发版/版本tags</td>
</tr>
<tr>
<td style="text-align:center">🚨</td>
<td style="text-align:left"><code>:rotating_light:</code></td>
<td style="text-align:left">修复编译警告或者linter警告</td>
</tr>
<tr>
<td style="text-align:center">🚧</td>
<td style="text-align:left"><code>:construction:</code></td>
<td style="text-align:left">工作在进行中</td>
</tr>
<tr>
<td style="text-align:center">💚</td>
<td style="text-align:left"><code>:green_heart:</code></td>
<td style="text-align:left">修复 CI 构建问题</td>
</tr>
<tr>
<td style="text-align:center">⬇️</td>
<td style="text-align:left"><code>:arrow_down:</code></td>
<td style="text-align:left">降级依赖库</td>
</tr>
<tr>
<td style="text-align:center">⬆️</td>
<td style="text-align:left"><code>:arrow_up:</code></td>
<td style="text-align:left">升级依赖库</td>
</tr>
<tr>
<td style="text-align:center">📌</td>
<td style="text-align:left"><code>:pushpin:</code></td>
<td style="text-align:left">Pin dependencies to specific versions.</td>
</tr>
<tr>
<td style="text-align:center">👷</td>
<td style="text-align:left"><code>:construction_worker:</code></td>
<td style="text-align:left">增加或者升级CI构建系统</td>
</tr>
<tr>
<td style="text-align:center">📈</td>
<td style="text-align:left"><code>:chart_with_upwards_trend:</code></td>
<td style="text-align:left">增加或升级分析代码/跟踪代码</td>
</tr>
<tr>
<td style="text-align:center">♻️</td>
<td style="text-align:left"><code>:recycle:</code></td>
<td style="text-align:left">重构代码</td>
</tr>
<tr>
<td style="text-align:center">➕</td>
<td style="text-align:left"><code>:heavy_plus_sign:</code></td>
<td style="text-align:left">增加依赖项</td>
</tr>
<tr>
<td style="text-align:center">➖</td>
<td style="text-align:left"><code>:heavy_minus_sign:</code></td>
<td style="text-align:left">删除依赖项</td>
</tr>
<tr>
<td style="text-align:center">🔧</td>
<td style="text-align:left"><code>:wrench:</code></td>
<td style="text-align:left">增加或升级配置文件</td>
</tr>
<tr>
<td style="text-align:center">🔨</td>
<td style="text-align:left"><code>:hammer:</code></td>
<td style="text-align:left">增加或更新脚本</td>
</tr>
<tr>
<td style="text-align:center">🌐</td>
<td style="text-align:left"><code>:globe_with_meridians:</code></td>
<td style="text-align:left">国际化和本地化</td>
</tr>
<tr>
<td style="text-align:center">✏️</td>
<td style="text-align:left"><code>:pencil2:</code></td>
<td style="text-align:left">修复错别字</td>
</tr>
<tr>
<td style="text-align:center">💩</td>
<td style="text-align:left"><code>:poop:</code></td>
<td style="text-align:left">编写了需要改进的错误代码</td>
</tr>
<tr>
<td style="text-align:center">⏪</td>
<td style="text-align:left"><code>:rewind:</code></td>
<td style="text-align:left">还原变更</td>
</tr>
<tr>
<td style="text-align:center">🔀</td>
<td style="text-align:left"><code>:twisted_rightwards_arrows:</code></td>
<td style="text-align:left">合并分支</td>
</tr>
<tr>
<td style="text-align:center">📦</td>
<td style="text-align:left"><code>:package:</code></td>
<td style="text-align:left">增加或更新已经编译的文件或package</td>
</tr>
<tr>
<td style="text-align:center">👽</td>
<td style="text-align:left"><code>:alien:</code></td>
<td style="text-align:left">因为外部API的更改而更新代码</td>
</tr>
<tr>
<td style="text-align:center">🚚</td>
<td style="text-align:left"><code>:truck:</code></td>
<td style="text-align:left">移动或者重命名资源(例如：files, paths, routes)</td>
</tr>
<tr>
<td style="text-align:center">📄</td>
<td style="text-align:left"><code>:page_facing_up:</code></td>
<td style="text-align:left">增加或更新许可文件（license）</td>
</tr>
<tr>
<td style="text-align:center">💥</td>
<td style="text-align:left"><code>:boom:</code></td>
<td style="text-align:left">引入了破坏性修改</td>
</tr>
<tr>
<td style="text-align:center">🍱</td>
<td style="text-align:left"><code>:bento:</code></td>
<td style="text-align:left">增加或更新assets</td>
</tr>
<tr>
<td style="text-align:center">♿️</td>
<td style="text-align:left"><code>:wheelchair:</code></td>
<td style="text-align:left">Improve accessibility</td>
</tr>
<tr>
<td style="text-align:center">💡</td>
<td style="text-align:left"><code>:bulb:</code></td>
<td style="text-align:left">在源代码中增加或更新注释</td>
</tr>
<tr>
<td style="text-align:center">🍻</td>
<td style="text-align:left"><code>:beers:</code></td>
<td style="text-align:left">Write code drunkenly</td>
</tr>
<tr>
<td style="text-align:center">💬</td>
<td style="text-align:left"><code>:speech_balloon:</code></td>
<td style="text-align:left">Add or update text and literals</td>
</tr>
<tr>
<td style="text-align:center">🗃</td>
<td style="text-align:left"><code>:card_file_box:</code></td>
<td style="text-align:left">执行与数据库相关的更改</td>
</tr>
<tr>
<td style="text-align:center">🔊</td>
<td style="text-align:left"><code>:loud_sound:</code></td>
<td style="text-align:left">增加或升级日志</td>
</tr>
<tr>
<td style="text-align:center">🔇</td>
<td style="text-align:left"><code>:mute:</code></td>
<td style="text-align:left">删除日志</td>
</tr>
<tr>
<td style="text-align:center">👥</td>
<td style="text-align:left"><code>:busts_in_silhouette:</code></td>
<td style="text-align:left">Add or update contributor(s).</td>
</tr>
<tr>
<td style="text-align:center">🚸</td>
<td style="text-align:left"><code>:children_crossing:</code></td>
<td style="text-align:left">改善用户体验/可用性。</td>
</tr>
<tr>
<td style="text-align:center">🏗</td>
<td style="text-align:left"><code>:building_construction:</code></td>
<td style="text-align:left">进行架构上的修改</td>
</tr>
<tr>
<td style="text-align:center">📱</td>
<td style="text-align:left"><code>:iphone:</code></td>
<td style="text-align:left">进行响应式设计</td>
</tr>
<tr>
<td style="text-align:center">🤡</td>
<td style="text-align:left"><code>:clown_face:</code></td>
<td style="text-align:left">Mock things</td>
</tr>
<tr>
<td style="text-align:center">🥚</td>
<td style="text-align:left"><code>:egg:</code></td>
<td style="text-align:left">增加或更新菜单</td>
</tr>
<tr>
<td style="text-align:center">🙈</td>
<td style="text-align:left"><code>:see_no_evil:</code></td>
<td style="text-align:left">增加或更新.gitignore文件</td>
</tr>
<tr>
<td style="text-align:center">📸</td>
<td style="text-align:left"><code>:camera_flash:</code></td>
<td style="text-align:left">添加或更新快照</td>
</tr>
<tr>
<td style="text-align:center">⚗️</td>
<td style="text-align:left"><code>:alembic:</code></td>
<td style="text-align:left">Perform experiments</td>
</tr>
<tr>
<td style="text-align:center">🔍</td>
<td style="text-align:left"><code>:mag:</code></td>
<td style="text-align:left">改善SEO</td>
</tr>
<tr>
<td style="text-align:center">🏷</td>
<td style="text-align:left"><code>:label:</code></td>
<td style="text-align:left">增加或更新类型（types）</td>
</tr>
<tr>
<td style="text-align:center">🌱</td>
<td style="text-align:left"><code>:seedling:</code></td>
<td style="text-align:left">增加或更新seed files</td>
</tr>
<tr>
<td style="text-align:center">🚩</td>
<td style="text-align:left"><code>:triangular_flag_on_post:</code></td>
<td style="text-align:left">Add, update, or remove feature flags</td>
</tr>
<tr>
<td style="text-align:center">🥅</td>
<td style="text-align:left"><code>:goal_net:</code></td>
<td style="text-align:left">Catch errors</td>
</tr>
<tr>
<td style="text-align:center">💫</td>
<td style="text-align:left"><code>:dizzy:</code></td>
<td style="text-align:left">Add or update animations and transitions</td>
</tr>
<tr>
<td style="text-align:center">🗑</td>
<td style="text-align:left"><code>:wastebasket:</code></td>
<td style="text-align:left">Deprecate code that needs to be cleaned up</td>
</tr>
<tr>
<td style="text-align:center">🛂</td>
<td style="text-align:left"><code>:passport_control:</code></td>
<td style="text-align:left">处理与授权、角色和权限相关的代码</td>
</tr>
<tr>
<td style="text-align:center">⚰️</td>
<td style="text-align:left"><code>:coffin:</code></td>
<td style="text-align:left">删除无效代码</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>emoji</tag>
        <tag>commit message</tag>
      </tags>
  </entry>
  <entry>
    <title>如何提升工作效率</title>
    <url>/2021/05/01/how-to-improve-the-work-efficiency/</url>
    <content><![CDATA[<p><img src="/2021/05/01/how-to-improve-the-work-efficiency/0.jpeg" alt></p>
<blockquote>
<div align="right"> 君子性非异也，善假于物也。</div>
</blockquote>
<p>前几天，在一次会议上，有同学问我：<em>如何才能提升工作效率？</em> 和以往的答疑环节不同，我这次没有给出明确的、马上可行的方法，相反，我仅仅是给出了自己对“<em>如何提升工作效率</em>”的思考。</p>
<p>鉴于时间的关系，当时没有展开来讲，对当时的内容进行了梳理、丰富和扩展，就形成了这篇文章。</p>
<span id="more"></span>
<h2 id="日光之下-并无新事">日光之下，并无新事</h2>
<blockquote>
<p>已有的事，后必再有；已行的事，后必再行。日光之下，并无新事。</p>
<div align="right">《圣经·传道书》1:9</div>
</blockquote>
<p>单纯就工作效率提升这件事而言，确实也并不是一件新鲜的事情。有太多的书籍在解答这个问题，比如：</p>
<ul>
<li>高效能人士的七个习惯</li>
<li>卓有成效的管理者</li>
<li>番茄工作法图解</li>
<li>……</li>
</ul>
<p>我们也确实可以通过实践这些书籍中的具体方法来提升自己的工作效率。但是，当我们接下来继续思考如下的问题时，我们又将如何展开呢：</p>
<ul>
<li>我们如何进一步提升工作效率？</li>
<li>提升效率的大方向是什么？</li>
</ul>
<p><a href="https://book.douban.com/author/1323905/">大卫·克里斯蒂安</a> 的“大历史”理论指出：可以依据整个人类的发展历史对未来即将发生的一切做出合理的判断，用长远的、比较的思维来看待问题。</p>
<p>人类改造自然的社会活动已经进行了几千年，同时我们的工作也是一种人类改造自然的活动，因此我们也可以运用“大历史”理论来思考<em>如何提升工作效率</em>这一问题？</p>
<h2 id="大历史理论">大历史理论</h2>
<p>关于大历史理论的具体内容，可以参考大卫·克里斯蒂安的著作 <a href="https://item.jd.com/44600326697.html">《起源-万物大历史》</a>。</p>
<div class="douban-card-block">
	<a class="douban-card" href="https://book.douban.com/subject/30428815">
		<div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img2.doubanio.com/view/subject/s/public/s32278451.jpg');"></div>
		<div class="douban-card-left">
			<div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img2.doubanio.com/view/subject/s/public/s32278451.jpg');"></div>
		</div>
		<div class="douban-card-right" style="line-height: 1.7;">
			<div class="douban-card-item"><span>书名: </span><strong>起源</strong></div>
			<div class="douban-card-item"><span>作者: </span><span>[美]大卫·克里斯蒂安</span></div>
			<div class="douban-card-item"><span>出版年份: </span><span>2019-4-10</span></div>
			<div class="douban-card-item"><span>评分: </span><span>7.9</span></div>
		</div>
	</a>
</div>
<style>
	.douban-card-block {
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		max-height: 400px;
	}
	.douban-card {
		display: flex;
		margin: 30px 10px;
		padding: 15px;
		border-radius: 10px;
		position: relative;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		color: antiquewhite;
		text-decoration: none;
	}
	.douban-card:hover {
		text-decoration: none;
	}
	.douban-card-bgimg {
		position: absolute;
		width: 115%;
		height: 115%;
		filter: blur(15px) brightness(0.6);
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
	}
	.douban-card-left {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.douban-card-right {
		position: relative;
		display: flex;
		flex-direction: column;
		margin-left: 12px;
		font-size: 16px;
		font-family: 'Courier New', Courier, monospace;
		line-height: 1.3;
		color: antiquewhite;
	}
	.douban-card-item {
		margin-top: 4px;
	}
</style>
<blockquote>
<p>大历史可以为我们理解自宇宙大爆炸至今的一切历史提供框架。</p>
<p>通常，在学校里，科学和历史是分开教授的，有专门的物理课，也有专门的讲述文明起源的课程。</p>
<p>但是，大历史打破了这一界限。</p>
<p>每当我学到新知识，不论是生物学、历史学，还是其他任何一门学科，我总是会努力将它放置在大历史的框架中。</p>
<p>再也没有其他其他课程会对我看待世界的方式产生如此之大的影响。</p>
<div align="right">——比尔·盖茨</div>
</blockquote>
<p>在漫长的历史长河中，人类共经历了：旧石器时代、新石器时代、青铜器时代、铁器时代、蒸汽机时代、电力时代，然后到达了目前的信息时代。</p>
<p>回顾历史的长河，我们发现，人类的发展也是工具进化的历程。每一次工具的升级换代，都影响着人类社会的发展方向和人们的生活方式。各行各业在每一次工具层级提升后发生着巨大的变化，人类生活的舒适程度也随着工具层级的不断提升而改善。</p>
<p>当年，唐玄宗为了博得美人一笑，千里快骑送荔枝，才有了“<em>一骑红尘妃子笑，无人知是荔枝来</em>”的典故。然而，现在，在交通工具，物流技术等高速发达的今天，吃上新鲜的荔枝已经不是什么难事了。</p>
<p><img src="/2021/05/01/how-to-improve-the-work-efficiency/1.jpeg" alt></p>
<blockquote>
<div align="right"> 一骑红尘妃子笑，无人知是荔枝来。</div>
</blockquote>
<p>因此，从大历史理论方面来看，我认为，提升工作效率的本质是“<strong>提升工作中所使用的工具的层级</strong>”。这里我说的“工具”泛指我们工作中使用的各类技术、平台、工具、脚本……</p>
<h2 id="提升工具的层级">提升工具的层级</h2>
<p>从历史的进程看，工具的水平反应生产力水平，是生产力水平的重要标志。因此要从根本上提升工作效率，首要的还是要<strong>提升工作中所使用的工具的层级</strong>。</p>
<p>工具层级不但影响我们的工作效率，有时候甚至会决定我们是否可以完成某项工作。正所谓：没有金刚钻，拦不了瓷器活，说的就是这个道理。</p>
<p>想象一下，如果现在让我们用如下图所示的“打孔卡”<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>来编写程序，我们多长时间能写出一个可以输出 <code>hello world</code> 的程序呢？而现在，借助更富有表现性的语言和更高级的工具，我们可以在几秒内就实现这个功能，不是吗？</p>
<p><img src="/2021/05/01/how-to-improve-the-work-efficiency/2.jpeg" alt></p>
<h2 id="工具与具体场景相结合">工具与具体场景相结合</h2>
<blockquote>
<p>如我解佛所说义，无有定法，名阿耨多罗三藐三菩提；亦无有定法，如来可说。</p>
<div align="right">——《金刚经》</div>
</blockquote>
<p>法无定法，一切事物都依赖于一定的因缘或条件才能存在，本身没有任何质的规定性。由此观之，一切的技术和工具，都需要依赖一定的场景才能存在，脱离场景的技术和工具也不能发挥应有的作用。同时，法无定法还提醒我们：自己的觉悟无法移植给别人，觉悟需要要靠自证、自修、自观来体验。</p>
<p><img src="/2021/05/01/how-to-improve-the-work-efficiency/3.jpg" alt></p>
<p>在工作中，经常会遇到脱离具体场景而执着于引入最高层级的工具的情况，我称这种行为为：<strong>惟工具论</strong>。</p>
<p>在《Monolith to Microservices》一书的第 <a href="/monolith-to-microservices/docs/Understanding_the_Goal.html">2.1节</a> 中，作者提到：<em>不了解目标还会让我们面临陷入货物崇拜的风险，此时我们就会假设：“如果微服务对 Netflix 有好处，那么微服务对我们也有好处！”</em></p>
<p>以出行效率为例，一般情况下，汽车的出行效率比自行车要高。但是对于早高峰堵车时的短程行程而言，自行车的效率要远远高于汽车。</p>
<p>再以代码版本管理系统而言，目前 Git 已经成为目前最流行的代码版本管理工具。但是，我们是否有思考过：</p>
<ul>
<li>Git 是否适用于我们？</li>
<li>如果让我们为公司选择一款 SCM（Source Code Management） 工具，我们会如何选择？我们会选择 Git 吗？</li>
</ul>
<p>从 <a href="https://zhuanlan.zhihu.com/p/368422885">Google 和 Facebook 为什么不用 git 管理源码？</a> 这篇文章中，我们也能发现，虽然 Git 非常优秀，但是在某些场景下， Git 还是有其固有的问题。从我的使用经验而言， Git 无法只 <code>pull</code> 代码库的其中部分 path 特性经常让我心有烦恼，而 Subversion 就可以很好的解决这个问题。如果我们的核心点是要保证同一个代码仓库的不同部分分属不同角色（不同角色具有不同权限）来管理时，我们还会选择 Git 吗？<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p>
<p>因此，在具体工具的使用中，不能惟工具论，需要结合具体的场景，结合我们自己的目标来使用工具。否则，工具不但无法提升效率，反而会成为制约效率的因素。</p>
<h2 id="没有工具是银弹">没有工具是银弹</h2>
<blockquote>
<p>在所有恐怖民间传说的妖怪中，最可怕的是人狼，因为它们可以完全出乎意料地从熟悉的面孔变成可怕的怪物。为了对付人狼，我们在寻找可以消灭它们的银弹。</p>
<p>大家熟悉的软件项目具有一些人狼的特性（至少在非技术经理看来），常常看似简单明了的东西，却有可能变成一个落后进度、超出预算、存在大量缺陷的怪物。</p>
<p>因此，我们听到了近乎绝望的寻求银弹的呼唤，寻求一种可以使软件成本像计算机硬件成本一样降低的尚方宝剑。</p>
<p>但是，我们看看近十年来的情况，没有银弹的踪迹。没有任何技术或管理上的进展，能够独立地许诺在生产率、可靠性或简洁性上取得数量级的提高。</p>
<div align="right">——《人月神话》第16章</div>
</blockquote>
<p>从历史的经验看，没有任何一种技术革新能够百分百的解决所有问题，没有任何一种技术革新能够在没有任何成本的前提下解决所有问题，也没有任何一种技术革新能够在不引入新问题的条件下解决所有问题。正如 Sam Newman 在 <a href="/monolith-to-microservices/docs/What_Are_Microservices.html">《Monolith to Microservices》</a> 一书中说的那样：</p>
<blockquote>
<p>正如我的老同事、老朋友、微服务专家 James Lewis 所说：“Microservices buy you options”。</p>
</blockquote>
<p><code>buy</code> 这个词告诫我们，没有任何一种技术革新是免费的，我们都必须付出一定的成本才能换取到技术革新带来的便利。</p>
<p>但是，实际上，根据我在工作中的观察，大多数人在引入新技术，新工具的时候，都只想捞取新技术的成果，而不想为之付出汗水。</p>
<p>我们还总是误解“自由软件”的含义。实际上，“自由软件”是关乎自由的问题，与价格无关，软件如何定价并不影响它是否被归类为自由软件。在英文中，我们使用 Free Software，Free 一词既有自由，也有免费的意思。而 Free Software 中的 Free 是指“自由言论”中的自由，而非“免费”。<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup></p>
<p>我们免费从“自由软件”获得其便利，但却不想花时间来贡献自己的想法，导致我们所使用的版本和“社区”版本之间的差距越来越大，进而导致无法持续获取新技术的便利。甚至有时候，当发展到一定阶段，最初为了解决问题而引入的“自由软件”，反而成了影响效率的主要因素。</p>
<p>我们免费引入革新技术，但是却不想花费时间来提升自己的能力、维护新技术。当在使用新技术遇到些许问题的时候，我们的肌肉记忆就开始发挥主导作用，进而开始打退堂鼓，导致在技术革新上出现“反反复复”的情况。我所经历的不同团队对待自动化测试的态度，都有力的证明了这一点。</p>
<p>我们总想着只要引入某种新技术，我们所面临的问题就一下都解决了。我们总想着寻找一种“银弹”来解决我们的问题。从大历史理论的观点来看，这怎么可能会实现呢？</p>
<p>世界上，大江大河，大多弯弯曲曲，即使所处平原之处的河流，也保持蜿蜒之态。<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup></p>
<p>刘禹锡说：“九曲黄河万里沙，浪淘风簸自天涯。”</p>
<p><img src="/2021/05/01/how-to-improve-the-work-efficiency/4.jpeg" alt></p>
<p>马克思说：社会发展是前进性和曲折性的统一，事物的发展不是直线式前进而是螺旋式上升的，是一个否定之否定的过程。</p>
<p>因此，我们必须认识到，短期看，新技术会解决我们当前的问题，但是新技术必然会引入新的问题，我们需要与时俱进，在新的场景下不断解决新技术带来的问题。这有这样，才能不断的提升工作效率。</p>
<p>我们不能因为堵车，就回退到自行车的时代；我们不能因为有假币，就回退到物物交换的时代；……</p>
<h2 id="天人合一">天人合一</h2>
<p>虽然工具是生产力的标志，但是人是生产力的主体，是首要的生产力，是生产力的主导因素。因此，在提升工具层级的同时，我们不能忽视“人”在效率提升中的重要作用。</p>
<p>为了最大可能的提升效率，我们需要分析清楚：</p>
<ul>
<li>人擅长处理什么工作？</li>
<li>工具、技术、平台擅长处理什么工作？</li>
<li>人和工具如何有效结合？</li>
</ul>
<p>这里，我称这种，人和工具的关系为“天人合一”，只要当人的效能和工具的效能紧密配合在一起的时候，我们的工作效率才能得到最大程度的提升。在这个过程中，我们要发挥自我的思维优势，结合具体的场景，把各种工具有效的整合在一起，形成一套完整的工具体系，这有这样，才能提升我们的工作效率。</p>
<p>在我们解决视频质量评估的整个工作中，我们就利用“天人合一”的思路，把 <code>shell</code>、<code>c++</code>、<code>python</code> 等语言有机的整合在一起，不同语言在系统的不同部分发挥各自的优势，既能保证执行效率，又能保证开发效率……</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=540619133&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<h2 id="工具的三个思维层次">工具的三个思维层次</h2>
<blockquote>
<p>参禅之初，看山是山，看水是水；</p>
<p>禅有悟时，看山不是山，看水不是水；</p>
<p>禅中彻悟，看山仍是山，看水仍是水。</p>
<div align="right">——青原行思禅师</div>
</blockquote>
<p><img src="/2021/05/01/how-to-improve-the-work-efficiency/5.jpeg" alt></p>
<p>记得大学的时候，我们的《设计模式》老师说：设计模式有三个层次：</p>
<ul>
<li>不懂设计模式，所以没法使用设计模式；</li>
<li>了解设计模式，哪里都想用设计模式，处处是模式，处处是反模式；</li>
<li>透彻设计模式，代码看似没用设计模式，却处处体现设计模式的思想；</li>
</ul>
<p>所以，在效率提升的过程中，对待工具也需要达到：看山仍是山，看水仍是水的境界。</p>
<h2 id="参考文献">参考文献</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://zhuanlan.zhihu.com/p/53300998">上世纪的老程序员是如何编程的</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a href="https://zhuanlan.zhihu.com/p/368422885">Google和Facebook为什么不用git管理源码？</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="http://www.gnu.org/philosophy/free-sw.zh-cn.html">什么是自由软件？</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p><a href="https://www.zhihu.com/question/27696813/answer/93053445">为什么河流都是弯弯曲曲的？</a> <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>方法论</tag>
        <tag>大历史理论</tag>
      </tags>
  </entry>
  <entry>
    <title>FFmpeg中基于深度学习模型的目标检测</title>
    <url>/2021/04/27/object-detection-based-on-dnn-detect-in-FFmpeg/</url>
    <content><![CDATA[<p><img src="/2021/04/27/object-detection-based-on-dnn-detect-in-FFmpeg/1.png" alt></p>
<p>从FFmpeg的代码提交记录<a href="https://github.com/FFmpeg/FFmpeg/commit/aa9ffdaa1eaeb5e16fb6b89852f38ff488d81173"><strong>lavfi: add filter dnn_detect for object detection</strong></a>中，我们发现，FFmpeg已经以滤镜的形式提供了基于DNN的目标检测能力。</p>
<span id="more"></span>
<h2 id="dnn-detect滤镜">dnn_detect滤镜</h2>
<p>在FFmpeg中，基于DNN的目标检测能力由<code>dnn_detect滤镜</code>（<a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavfilter/vf_dnn_detect.c">vf_dnn_detect.c</a>）提供。根据该能力的作者所提供的资料<a href="https://mp.weixin.qq.com/s?__biz=MzI3MjU1MjU1Mw==&amp;mid=2247483828&amp;idx=1&amp;sn=df8fe902868ca2a0ea1cf50fff28ff95"><em>目标检测，FFmpeg中第一个基于深度学习模型的视频分析功能</em></a>可知：</p>
<blockquote>
<p>当前目标检测只支持OpenVINO后端，后续还将尽快加入更多功能，比如基于TensorFlow模型的目标检测、支持OpenVINO后端的目标识别、目标检测和识别结果的可视化等。</p>
</blockquote>
<p>根据<a href="https://mp.weixin.qq.com/s?__biz=MzI3MjU1MjU1Mw==&amp;mid=2247483828&amp;idx=1&amp;sn=df8fe902868ca2a0ea1cf50fff28ff95"><em>目标检测，FFmpeg中第一个基于深度学习模型的视频分析功能</em></a>一文提供的demo可知，在当前的版本中，检测结果是通过<code>showinfo滤镜</code>以日志的形式输出的。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@9d26c3a57bc7:/workspace# ffmpeg -i cici.jpg -vf dnn_detect=dnn_backend=openvino:model=face-detection-adas-0001.xml:input=data:output=detection_out:confidence=0.6:labels=face-detection-adas-0001.label,showinfo -f null -</span><br><span class="line">...</span><br><span class="line">[Parsed_showinfo_1 @ 0x561cf20c1f40]   side data - detection bounding boxes:</span><br><span class="line">[Parsed_showinfo_1 @ 0x561cf20c1f40] source: face-detection-adas-0001.xml</span><br><span class="line">[Parsed_showinfo_1 @ 0x561cf20c1f40] index: 0,  region: (1005, 813) -&gt; (1086, 905), label: face, confidence: 10000/10000.</span><br><span class="line">[Parsed_showinfo_1 @ 0x561cf20c1f40] index: 1,  region: (888, 839) -&gt; (967, 926), label: face, confidence: 6917/10000.</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>日志格式的检测结果不利于直观的分析，因此我对该滤镜做了简单的修改，为其增加了检测结果框选的能力，以便可以更方便的评估<code>dnn_detect</code>的检测能力。具体效果如下所示：</p>
<p><img src="/2021/04/27/object-detection-based-on-dnn-detect-in-FFmpeg/2.jpg" alt></p>
<h2 id="dnn-detect滤镜的安装">dnn_detect滤镜的安装</h2>
<h4 id="安装libtensorflow">安装libtensorflow</h4>
<p>从<a href="https://storage.googleapis.com/tensorflow/">https://storage.googleapis.com/tensorflow/</a>中选择适合的libtensorflow版本下载即可，由于我是在MacOS上进行的实验，因此我选择了<a href="https://storage.googleapis.com/tensorflow/libtensorflow/libtensorflow-cpu-darwin-x86_64-2.4.1.tar.gz">libtensorflow/libtensorflow-cpu-darwin-x86_64-2.4.1.tar.gz</a>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd workspace</span><br><span class="line">wget https:&#x2F;&#x2F;storage.googleapis.com&#x2F;tensorflow&#x2F;libtensorflow&#x2F;libtensorflow-cpu-darwin-x86_64-2.4.1.tar.gz --no-check-certificate</span><br><span class="line">tar xzvf libtensorflow-cpu-darwin-x86_64-2.4.1.tar.gz</span><br></pre></td></tr></table></figure>
<h4 id="安装openvino-toolkit">安装openvino_toolkit</h4>
<p>进入<a href="https://software.intel.com/content/www/us/en/develop/tools/openvino-toolkit/download.html">openvino_toolkit的下载页面</a>，根据提示选择对应的版本下载并安装即可。MacOS的openvino_toolkit安装比较简单，下载对应的dmg文件之后，一路点击默认，然后安装就可以。默认会将相关的库文件安装在<code>/opt/intel/openvino_2021</code>目录。</p>
<h4 id="重新编译ffmpeg">重新编译FFmpeg</h4>
<ul>
<li>
<p>拉取FFmpeg的master分支代码。</p>
</li>
<li>
<p>根据<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2021/04/27/object-detection-based-on-dnn-detect-in-FFmpeg/vf_dnn_detect.7a6ea6ce2a.patch">vf_dnn_detect.7a6ea6ce2a.patch</a>修改<code>dnn_detect</code>的代码。</p>
</li>
<li>
<p>设置相关的环境变量，如下所示：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:\</span><br><span class="line">/opt/intel/openvino_2021/inference_engine/lib/intel64:\</span><br><span class="line">/opt/intel/openvino_2021/inference_engine/external/tbb/lib:\</span><br><span class="line">/opt/intel/openvino_2021/deployment_tools/ngraph/lib:\</span><br><span class="line">/workspace/tensorflow/lib:\</span><br><span class="line">/workspace/ffmpeg/outputs/lib</span><br><span class="line"></span><br><span class="line">export DYLD_LIBRARY_PATH=$DYLD_LIBRARY_PATH:\</span><br><span class="line">/workspace/ffmpeg/outputs/lib</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>编译FFmpeg</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;configure --prefix&#x3D;.&#x2F;outputs \</span><br><span class="line">... \</span><br><span class="line">--enable-libtensorflow \</span><br><span class="line">--enable-libopenvino \</span><br><span class="line">--extra-cflags&#x3D;&quot;-I&#x2F;workspace&#x2F;tensorflow&#x2F;include -I&#x2F;opt&#x2F;intel&#x2F;openvino_2021&#x2F;inference_engine&#x2F;include&quot; \</span><br><span class="line">--extra-ldflags&#x3D;&quot;-L&#x2F;workspace&#x2F;tensorflow&#x2F;lib -L&#x2F;opt&#x2F;intel&#x2F;openvino_2021&#x2F;inference_engine&#x2F;lib&#x2F;intel64&quot;</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>根据<a href="https://mp.weixin.qq.com/s?__biz=MzI3MjU1MjU1Mw==&amp;mid=2247483828&amp;idx=1&amp;sn=df8fe902868ca2a0ea1cf50fff28ff95"><em>目标检测，FFmpeg中第一个基于深度学习模型的视频分析功能</em></a>中的demo下载对应的模型和相关文件，并使用ffplay播放。</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd outputs &amp;&amp; .&#x2F;bin&#x2F;ffplay -i test.mp4 \</span><br><span class="line">-vf &quot;dnn_detect&#x3D;dnn_backend&#x3D;openvino:model&#x3D;model&#x2F;face-detection-adas-0001.xml:input&#x3D;data:output&#x3D;detection_out:confidence&#x3D;0.6:labels&#x3D;model&#x2F;face-detection-adas-0001.label&quot;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/04/27/object-detection-based-on-dnn-detect-in-FFmpeg/3.jpg" alt></p>
</li>
</ul>
<h2 id="dnn-detect滤镜参数">dnn_detect滤镜参数</h2>
<p>从<a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavfilter/vf_dnn_detect.c">vf_dnn_detect.c</a>可知，<code>dnn_detect滤镜</code>的参数主要有：</p>
<ul>
<li>dnn_backend：控制dnn的后端，目前只支持openvivo</li>
<li>confidence：dnn目标检测时的置信阈值，可以根据实际情况来设置</li>
<li>labels：指定检测使用模型所对应的label文件路径</li>
<li>model：指定检测使用模型所对应的model文件路径</li>
<li>input：模型的输入</li>
<li>output：模型的输出</li>
<li>backend_configs, options：这两个参数都对应的是模型后端的相关配置</li>
<li>async：设置是否启用异步的DNN接口，默认为异步</li>
</ul>
<p>在使用中，可以根据自己的需要来设置滤镜的相关参数，进而达到自己的目的。例如，通过设置<code>async</code>来启用同步DNN接口，具体如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;bin&#x2F;ffplay -i test.mp4 \</span><br><span class="line">    -vf &quot;dnn_detect&#x3D;dnn_backend&#x3D;openvino:model&#x3D;model&#x2F;face-detection-adas-0001.xml:input&#x3D;data:output&#x3D;detection_out:confidence&#x3D;0.6:labels&#x3D;model&#x2F;face-detection-adas-0001.label:async&#x3D;0&quot;</span><br></pre></td></tr></table></figure>
<h2 id="dnn-detect的其他模型">dnn_detect的其他模型</h2>
<p>在如上的例子中，我们用人脸检测模型作为例子演示了FFmpeg中的DNN目标检测。实际上，作为一个通用的滤镜，替换模型之后，我们也可以用来进行其他类型的目标检测。</p>
<p>在<a href="https://github.com/openvinotoolkit/open_model_zoo">openvinotoolkit/open_model_zoo</a>中，介绍了很多预训练好的模型，我们可以拿来直接用。各预训练模型可以从<a href="https://download.01.org/opencv/">download.01.org/opencv/</a>下载。选择模型的时候，务必保证下载和所使用的OpenVINO版本对应的模型，否则，可能会导致加载模型失败的问题。</p>
<p><img src="/2021/04/27/object-detection-based-on-dnn-detect-in-FFmpeg/4.jpg" alt></p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
        <tag>目标检测</tag>
        <tag>dnn_detect</tag>
      </tags>
  </entry>
  <entry>
    <title>卷积运算以及高斯滤波器的构造</title>
    <url>/2021/04/14/convolution-and-the-gaussian-convolution-kernel/</url>
    <content><![CDATA[<h2 id="卷积的数学定义">卷积的数学定义</h2>
<p>在图像分析和图像处理中，<strong>卷积</strong>(<em>convolution</em>)是一种非常重要的运算。卷积是一个积分运算，其反应的是函数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span>在另一个函数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span></span>上移动时所叠加的量。函数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>在有限域<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi>t</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,t]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">t</span><span class="mclose">]</span></span></span></span>上的一维卷积为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mi>f</mi><mo>∗</mo><mi>h</mi><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mi>f</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mi>h</mi><mo stretchy="false">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="false">)</mo><mi mathvariant="normal">d</mi><mi>τ</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mo>∫</mo><mn>0</mn><mi>t</mi></msubsup><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo>−</mo><mi>τ</mi><mo stretchy="false">)</mo><mi>h</mi><mo stretchy="false">(</mo><mi>τ</mi><mo stretchy="false">)</mo><mi mathvariant="normal">d</mi><mi>τ</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
(f*h)(t) &amp;= \int^{t}_{0}f(\tau)h(t-\tau)\mathrm{d}\tau \\
&amp;= \int^{t}_{0}f(t - \tau)h(\tau)\mathrm{d}\tau
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.510812em;vertical-align:-2.505406em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.005406em;"><span style="top:-5.005406em;"><span class="pstrut" style="height:3.543456em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.543456em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.505406em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.005406em;"><span style="top:-5.005406em;"><span class="pstrut" style="height:3.543456em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5434560000000002em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3.8129000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9119499999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault" style="margin-right:0.1132em;">τ</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.543456em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5434560000000002em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span><span style="top:-3.8129000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9119499999999999em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.1132em;">τ</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault" style="margin-right:0.1132em;">τ</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.505406em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>需要注意的是，卷积积分的上下限实际为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mi mathvariant="normal">∞</mi><mo separator="true">,</mo><mo>+</mo><mi mathvariant="normal">∞</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(-\infty, +\infty)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord">∞</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">+</span><span class="mord">∞</span><span class="mclose">)</span></span></span></span>，但是此处我们假设负坐标部分的值为0，因此这里可以限定在区间<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mi>t</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,t]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">t</span><span class="mclose">]</span></span></span></span>中。<sup>[1]</sup></p>
<span id="more"></span>
<p>根据一维卷积的定义，我们可以得到函数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>在另一个函数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>上移动时的卷积：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mi>f</mi><mo>∗</mo><mi>h</mi><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mo>∫</mo><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><mrow><mo>+</mo><mi mathvariant="normal">∞</mi></mrow></msubsup><mi>f</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mi>h</mi><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>a</mi><mo separator="true">,</mo><mi>y</mi><mo>−</mo><mi>b</mi><mo stretchy="false">)</mo><mi mathvariant="normal">d</mi><mi>a</mi><mi mathvariant="normal">d</mi><mi>b</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mo>∫</mo><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><mrow><mo>+</mo><mi mathvariant="normal">∞</mi></mrow></msubsup><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>a</mi><mo separator="true">,</mo><mi>y</mi><mo>−</mo><mi>b</mi><mo stretchy="false">)</mo><mi>h</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mi mathvariant="normal">d</mi><mi>a</mi><mi mathvariant="normal">d</mi><mi>b</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
(f*h)(x,y) &amp;= \int^{+\infty}_{-\infty}f(a,b)h(x-a,y-b)\mathrm{d}a\mathrm{d}b \\ 
&amp;= \int^{+\infty}_{-\infty}f(x-a,y-b)h(a,b)\mathrm{d}a\mathrm{d}b
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:5.583024em;vertical-align:-2.541512em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.041512em;"><span style="top:-5.041512em;"><span class="pstrut" style="height:3.521231em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.521231em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.541512em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.041512em;"><span style="top:-5.041512em;"><span class="pstrut" style="height:3.521231em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5212310000000002em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span><span style="top:-3.8129000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span><span class="mord mtight">∞</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.970281em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault">a</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault">b</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.521231em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right:0.44445em;position:relative;top:-0.0011249999999999316em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5212310000000002em;"><span style="top:-1.7880500000000001em;margin-left:-0.44445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span><span style="top:-3.8129000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">+</span><span class="mord mtight">∞</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.970281em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault">a</span><span class="mord"><span class="mord mathrm">d</span></span><span class="mord mathdefault">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.541512em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<h2 id="数字图像分析中的卷积">数字图像分析中的卷积</h2>
<p>数字图像是一个二维的离散数据，因此对于数字图像而言，需要将积分运算（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∫</mo></mrow><annotation encoding="application/x-tex">\int</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.11112em;vertical-align:-0.30612em;"></span><span class="mop op-symbol small-op" style="margin-right:0.19445em;position:relative;top:-0.0005599999999999772em;">∫</span></span></span></span>)改为加和运算（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo></mrow><annotation encoding="application/x-tex">\sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.00001em;vertical-align:-0.25001em;"></span><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span></span></span></span>），从而得到<strong>离散卷积</strong>(<em>discrete convolution</em>)。</p>
<p>对于数字图像而言，在图像平面上存在有限的定义域，对于定义域之外的离散卷积结果为0。因此，这个特点并不妨碍我们在数字图像上执行卷积运算。此时，卷积表示的是使用滤波器<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>对图像执行一个线性滤波处理。</p>
<p>我们在图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的一个局部邻域<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi></mrow><annotation encoding="application/x-tex">\mathcal{O}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span></span></span></span>内计算其所有像素的线性组合，邻域<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi></mrow><annotation encoding="application/x-tex">\mathcal{O}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span></span></span></span>中的各个像素的权重由<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>来确定。因此，对于图像中的像素<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>，我们在其邻域<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi></mrow><annotation encoding="application/x-tex">\mathcal{O}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span></span></span></span>内使用滤波器<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>对其执行卷积运算，得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">g(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>=</mo><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo><mo>∈</mo><mi mathvariant="script">O</mi></mrow></munder><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mi>m</mi><mo separator="true">,</mo><mi>j</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo><mi>h</mi><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mstyle></mrow><annotation encoding="application/x-tex">g(i,j)=\displaystyle\sum_{(m,n)\in\mathcal{O}}f(i-m,j-n)h(m,n)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.5660100000000003em;vertical-align:-1.516005em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.808995em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathdefault mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">n</span><span class="mclose mtight">)</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.516005em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>在上式中，称<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>为<strong>卷积掩膜</strong>(<em>convolution mask</em>)或者滤波器，并且一般会选择具有奇数行和列的矩形邻域<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi></mrow><annotation encoding="application/x-tex">\mathcal{O}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span></span></span></span>，以方便确定领域的中心。<sup>[1]</sup></p>
<h2 id="利用高斯滤波器来模糊图像">利用高斯滤波器来模糊图像</h2>
<p>通常，图像处理软件会提供“模糊”（blur）滤镜，使图片产生模糊的效果。具体如下图所示：</p>
<p><img src="/2021/04/14/convolution-and-the-gaussian-convolution-kernel/1.jpeg" alt></p>
<p>模糊的本质就是利用像素邻域<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi></mrow><annotation encoding="application/x-tex">\mathcal{O}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span></span></span></span>内其他像素的线性运算来计算该像素的值，从而提高该像素和邻域内其他像素之间的相关性。</p>
<p>模糊的方式和效果取决于线性运算时的滤波器<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>的选取。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>的选择有很多，其中有一种就是高斯滤波器，其对应的模糊效果称之为“高斯模糊”。“高斯模糊”的本质就是利用高斯函数生成线性运算时各像素的权重，即利用高斯函数（当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\mu=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">μ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>且各方向的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span></span></span></span>相等时）生成滤波器<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><msup><mi>e</mi><mrow><mo>−</mo><mfrac><mrow><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><msup><mi>y</mi><mn>2</mn></msup></mrow><mrow><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac></mrow></msup></mrow><annotation encoding="application/x-tex">G(x,y) = \frac{1}{2\pi\sigma^2}e^{-\frac{x^2+y^2}{2\sigma^2}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.00744em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.3013099999999997em;"><span style="top:-3.4534200000000004em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.2112714285714286em;"><span style="top:-2.5061857142857145em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9384399999999999em;"><span style="top:-2.93844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.4623857142857144em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.04844em;"><span style="top:-3.04844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.04844em;"><span style="top:-3.04844em;margin-right:0.1em;"><span class="pstrut" style="height:2.64444em;"></span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.49381428571428565em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>中心点的坐标为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0,0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">0</span><span class="mclose">)</span></span></span></span>，则整个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>的坐标如下所示：</p>
<p><img src="/2021/04/14/convolution-and-the-gaussian-convolution-kernel/2.png" alt></p>
<p>利用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>的公式，即可计算得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span></span></span></span>为指定值时的高斯滤波器<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">h</span></span></span></span>。具体细节此处不再赘述，具体可以参考：<a href="http://www.ruanyifeng.com/blog/2012/11/gaussian_blur.html">高斯模糊的算法</a>。</p>
<h2 id="不依赖其他库生成高斯滤波器">不依赖其他库生成高斯滤波器</h2>
<p>当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\mu=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">μ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span></span></span></span>且各方向的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span></span></span></span>相等时，对于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>我们得到：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>h</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mstyle></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mfrac><mn>1</mn><mrow><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><msup><mi>e</mi><mrow><mo>−</mo><mo stretchy="false">(</mo><msup><mi>i</mi><mn>2</mn></msup><mo>+</mo><msup><mi>j</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></msup></mrow><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mrow><mfrac><mn>1</mn><mrow><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><msup><mi>e</mi><mrow><mo>−</mo><mo stretchy="false">(</mo><msup><mi>i</mi><mn>2</mn></msup><mo>+</mo><msup><mi>j</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></msup></mrow></mstyle></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mfrac><mn>1</mn><mrow><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><msup><mi>e</mi><mrow><mo>−</mo><mo stretchy="false">(</mo><msup><mi>i</mi><mn>2</mn></msup><mo>+</mo><msup><mi>j</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></msup></mrow><mrow><mfrac><mn>1</mn><mrow><mn>2</mn><mi>π</mi><msup><mi>σ</mi><mn>2</mn></msup></mrow></mfrac><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><msup><mi>e</mi><mrow><mo>−</mo><mo stretchy="false">(</mo><msup><mi>i</mi><mn>2</mn></msup><mo>+</mo><msup><mi>j</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></msup></mstyle></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mo stretchy="false">(</mo><msup><mi>i</mi><mn>2</mn></msup><mo>+</mo><msup><mi>j</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></msup><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><msup><mi>e</mi><mrow><mo>−</mo><mo stretchy="false">(</mo><msup><mi>i</mi><mn>2</mn></msup><mo>+</mo><msup><mi>j</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2</mn><msup><mi>σ</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></msup></mstyle></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}

h(i,j)&amp;=\frac{G(i,j)}{\displaystyle\sum_{i,j}{G(i,j)}} \\
&amp;=\frac{\frac{1}{2\pi\sigma^2}e^{-(i^2+j^2)/(2\sigma^2)}}{\displaystyle\sum_{i,j}{\frac{1}{2\pi\sigma^2}e^{-(i^2+j^2)/(2\sigma^2)}}} \\
&amp;=\frac{\frac{1}{2\pi\sigma^2}e^{-(i^2+j^2)/(2\sigma^2)}}{\frac{1}{2\pi\sigma^2}\displaystyle\sum_{i,j}e^{-(i^2+j^2)/(2\sigma^2)}} \\
&amp;=\frac{e^{-(i^2+j^2)/(2\sigma^2)}}{\displaystyle\sum_{i,j}e^{-(i^2+j^2)/(2\sigma^2)}}

\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:17.421323em;vertical-align:-8.4606615em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:8.9606615em;"><span style="top:-11.255581500000002em;"><span class="pstrut" style="height:3.72192em;"></span><span class="mord"><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span><span style="top:-6.879879499999999em;"><span class="pstrut" style="height:3.72192em;"></span><span class="mord"></span></span><span style="top:-2.232742499999998em;"><span class="pstrut" style="height:3.72192em;"></span><span class="mord"></span></span><span style="top:2.0849595em;"><span class="pstrut" style="height:3.72192em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:8.4606615em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:8.9606615em;"><span style="top:-11.255581500000002em;"><span class="pstrut" style="height:3.72192em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span><span style="top:-3.280005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.727005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.3537820000000003em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-6.879879499999999em;"><span class="pstrut" style="height:3.72192em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.72192em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.32144em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.03588em;">π</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0369199999999998em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.55144em;"><span class="pstrut" style="height:3.32144em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-4.05644em;"><span class="pstrut" style="height:3.32144em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869199999999998em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.625217em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.232742499999998em;"><span class="pstrut" style="height:3.72192em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.72192em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0369199999999998em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.280005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.785005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869199999999998em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.3537820000000003em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:2.0849595em;"><span class="pstrut" style="height:3.72192em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6639199999999998em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0369199999999998em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.280005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.727005em;"><span class="pstrut" style="height:3.050005em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869199999999998em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mtight">/</span><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913142857142857em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.3537820000000003em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:8.4606615em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>使用python得到二维的高斯滤波器的代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gaussian_kernel_2d</span>(<span class="params">sigma, width</span>):</span></span><br><span class="line">    <span class="keyword">if</span> width == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> np.ones((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    kernel_radius = np.floor(width &gt;&gt; <span class="number">1</span>)</span><br><span class="line">    ax            = np.arange(-kernel_radius, kernel_radius + <span class="number">1.</span>, dtype=np.float32)</span><br><span class="line">    xx, yy        = np.meshgrid(ax, ax)</span><br><span class="line">    kernel        = np.exp(-(xx**<span class="number">2</span> + yy**<span class="number">2</span>) / (<span class="number">2.</span> * sigma**<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> kernel / np.<span class="built_in">sum</span>(kernel)</span><br></pre></td></tr></table></figure>
<p>详细代码可以参考<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2021/04/14/convolution-and-the-gaussian-convolution-kernel/gaussian_cov_kernel.ipynb">高斯滤波器的生成和可视化</a>。</p>
<h2 id="滤波器的可分离特性">滤波器的可分离特性</h2>
<p>图像处理中的<strong>可分离滤波器</strong>(<em>separable filter</em>)可以写成两个更简单的滤波器的乘积。通常，可以把二维卷积运算分离为两个一维滤波器，从而降低图像的卷积运算复杂度。</p>
<p>例如，对于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>×</mo><mi>H</mi></mrow><annotation encoding="application/x-tex">W \times H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span>的图像，如果采用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>的二维滤波器，则卷积运算的复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>M</mi><mo separator="true">⋅</mo><mi>N</mi><mo separator="true">⋅</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(M·N·n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，而如果用两个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">1 \times n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">n</span></span></span></span>的一维滤波器，则卷积运算的复杂度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>2</mn><mi>M</mi><mo separator="true">⋅</mo><mi>N</mi><mo separator="true">⋅</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(2M·N·n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>。<sup>[4]</sup></p>
<p>Karas Pavel和Svoboda David在<a href="https://www.intechopen.com/books/design-and-architectures-for-digital-signal-processing/algorithms-for-efficient-computation-of-convolution">Algorithms for Efficient Computation of Convolution</a><sup>[5]</sup>的<strong>3. Separable convolution</strong>部分指出：</p>
<p>给定一个行向量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>u</mi><mo stretchy="true">→</mo></mover><mo>=</mo><mo stretchy="false">(</mo><msub><mi>u</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>u</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><msub><mi>u</mi><mi>m</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\overrightarrow{u}=(u_1,u_2,...u_m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9525600000000001em;vertical-align:0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9525600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">u</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>和一个列向量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mover accent="true"><mi>v</mi><mo stretchy="true">→</mo></mover><mi>T</mi></msup><mo>=</mo><mo stretchy="false">(</mo><msub><mi>v</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>v</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>v</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\overrightarrow{v}^T=(v_1,v_2,...,v_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9525600000000001em;vertical-align:0em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9525600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413309999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>，则其二者的卷积定义为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mover accent="true"><mi>u</mi><mo stretchy="true">→</mo></mover><mo>∗</mo><mover accent="true"><mi>v</mi><mo stretchy="true">→</mo></mover></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mover accent="true"><mi>v</mi><mo stretchy="true">→</mo></mover><mtext> </mtext><mover accent="true"><mi>u</mi><mo stretchy="true">→</mo></mover></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>v</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>v</mi><mn>2</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>v</mi><mi>n</mi></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo>∗</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>u</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>u</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>u</mi><mi>m</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>1</mn></msub><msub><mi>u</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>1</mn></msub><msub><mi>u</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>1</mn></msub><msub><mi>u</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>1</mn></msub><msub><mi>u</mi><mi>m</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>2</mn></msub><msub><mi>u</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>2</mn></msub><msub><mi>u</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>2</mn></msub><msub><mi>u</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>2</mn></msub><msub><mi>u</mi><mi>m</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>3</mn></msub><msub><mi>u</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>3</mn></msub><msub><mi>u</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>3</mn></msub><msub><mi>u</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mn>3</mn></msub><msub><mi>u</mi><mi>m</mi></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>      </mtext><mi mathvariant="normal">.</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>            </mtext><mi mathvariant="normal">.</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi mathvariant="normal">.</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mi>n</mi></msub><msub><mi>u</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mi>n</mi></msub><msub><mi>u</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mi>n</mi></msub><msub><mi>u</mi><mn>3</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>v</mi><mi>n</mi></msub><msub><mi>u</mi><mi>m</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi mathvariant="bold">A</mi><mrow><mi>n</mi><mo>×</mo><mi>m</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\overrightarrow{u}*\overrightarrow{v}&amp;=\overrightarrow{v}\ \overrightarrow{u} \\
&amp;=\begin{pmatrix}
v_1 \\
v_2 \\
. \\
. \\
. \\
v_n \end{pmatrix} * \begin{pmatrix} u_1, u_2, ..., u_m\end{pmatrix} \\
&amp;=\begin{pmatrix}
v_1u_1 &amp; v_1u_2 &amp; v_1u_3 &amp; ... &amp; v_1u_m \\
v_2u_1 &amp; v_2u_2 &amp; v_2u_3 &amp; ... &amp; v_2u_m \\
v_3u_1 &amp; v_3u_2 &amp; v_3u_3 &amp; ... &amp; v_3u_m \\
. &amp; . &amp; . &amp; . &amp; . \\
. &amp; . &amp; . &amp; \ \ \ \ \ \ . &amp; . \\
. &amp; . &amp; . &amp; \ \ \ \ \ \ \ \ \ \ \ \ . &amp; . \\
v_nu_1 &amp; v_nu_2 &amp; v_nu_3 &amp; ... &amp; v_nu_m
\end{pmatrix} \\
&amp;=\mathbf{A}_{n \times m}
\end{aligned}

</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:19.312780000000004em;vertical-align:-9.406390000000002em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:9.90639em;"><span style="top:-15.40389em;"><span class="pstrut" style="height:6.450060000000001em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9525600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">u</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9525600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span></span></span><span style="top:-10.89384em;"><span class="pstrut" style="height:6.450060000000001em;"></span><span class="mord"></span></span><span style="top:-2.7937299999999983em;"><span class="pstrut" style="height:6.450060000000001em;"></span><span class="mord"></span></span><span style="top:2.296330000000001em;"><span class="pstrut" style="height:6.450060000000001em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:9.406390000000002em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:9.90639em;"><span style="top:-15.40389em;"><span class="pstrut" style="height:6.450060000000001em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9525600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span><span class="mspace"> </span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9525600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">u</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span></span></span><span style="top:-10.89384em;"><span class="pstrut" style="height:6.450060000000001em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.8500500000000004em;"><span style="top:-0.44997000000000076em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎝</span></span></span><span style="top:-1.5999800000000008em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-2.1949900000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-2.7900000000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-3.3850100000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-3.9800200000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-4.57503em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-4.61003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-5.85005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎛</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3500499999999995em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.850000000000001em;"><span style="top:-6.010000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.810000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.6100000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-1.2100000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-0.009999999999999953em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.8500500000000004em;"><span style="top:-0.44997000000000076em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎠</span></span></span><span style="top:-1.5999800000000008em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-2.1949900000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-2.7900000000000005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-3.3850100000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-3.9800200000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-4.57503em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-4.61003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-5.85005em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.3500499999999995em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8500000000000001em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35000000000000003em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span><span style="top:-2.7937299999999983em;"><span class="pstrut" style="height:6.450060000000001em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.450060000000001em;"><span style="top:0.1500399999999994em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎝</span></span></span><span style="top:-0.9999700000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-1.5949800000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-2.1899900000000008em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-2.7850000000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-3.3800100000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-3.97502em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-4.57003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-5.16504em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-5.210040000000001em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎜</span></span></span><span style="top:-6.450060000000001em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎛</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.9500599999999997em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.450000000000001em;"><span style="top:-6.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.210000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0100000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-1.8100000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-0.6100000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:0.5900000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.450000000000001em;"><span style="top:-6.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.210000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0100000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-1.8100000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-0.6100000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:0.5900000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.450000000000001em;"><span style="top:-6.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.210000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0100000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-1.8100000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-0.6100000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:0.5900000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.450000000000001em;"><span style="top:-6.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span></span></span><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span></span></span><span style="top:-4.210000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span></span></span><span style="top:-3.0100000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-1.8100000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mord">.</span></span></span><span style="top:-0.6100000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mord">.</span></span></span><span style="top:0.5900000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.95em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.450000000000001em;"><span style="top:-6.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-5.410000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-4.210000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.0100000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-1.8100000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:-0.6100000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">.</span></span></span><span style="top:0.5900000000000001em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.95em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.450060000000001em;"><span style="top:0.1500399999999994em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎠</span></span></span><span style="top:-0.9999700000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-1.5949800000000007em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-2.1899900000000008em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-2.7850000000000006em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-3.3800100000000004em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-3.97502em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-4.57003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-5.16504em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-5.210040000000001em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎟</span></span></span><span style="top:-6.450060000000001em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.9500599999999997em;"><span></span></span></span></span></span></span></span></span></span><span style="top:2.296330000000001em;"><span class="pstrut" style="height:6.450060000000001em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.25833100000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">×</span><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:9.406390000000002em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>并且，当且仅当矩阵<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">A</mi><mrow><mi>n</mi><mo>×</mo><mi>m</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{A}_{n \times m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.894441em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">A</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.25833100000000003em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">n</span><span class="mbin mtight">×</span><span class="mord mathdefault mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span>的秩<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo stretchy="false">(</mo><mi mathvariant="bold">A</mi><mo stretchy="false">)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">r(\mathbf{A})=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">A</span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>时，滤波器才是可分离的滤波器。Gaussian滤波器和Sobel滤波器就是这种可分离的滤波器。</p>
<p>利用这个特性，对于二维高斯滤波器<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h(x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>而言，我们将其分离成两个一维滤波器。对图像的二维卷积运算从而简化为对图像的两次一维卷积，具体如下所示：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>h</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">(</mo><msub><mi>h</mi><mi>x</mi></msub><mo>∗</mo><msub><mi>h</mi><mi>y</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo stretchy="false">(</mo><mi>f</mi><mo>∗</mo><mi>h</mi><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>f</mi><mo>∗</mo><mo stretchy="false">(</mo><msub><mi>h</mi><mi>x</mi></msub><mo>∗</mo><msub><mi>h</mi><mi>y</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo stretchy="false">(</mo><mi>f</mi><mo>∗</mo><msub><mi>h</mi><mi>x</mi></msub><mo stretchy="false">)</mo><mo>∗</mo><msub><mi>f</mi><mi>y</mi></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
h(x,y) &amp;= (h_x * h_y)(x) \\
(f*h)(x,y) &amp;= f*(h_x * h_y) \\
&amp;=(f*h_x)*f_y
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.500000000000002em;vertical-align:-2.000000000000001em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">h</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5000000000000004em;"><span style="top:-4.66em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mclose">)</span></span></span><span style="top:-3.16em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.6599999999999993em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.000000000000001em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>同时，利用如上的特性，我们还可以利用一维高斯滤波器的结果生成二维高斯滤波器，代码如下所示：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gaussian_kernel_2d_acc</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">if</span> self.width == <span class="number">1</span>:</span><br><span class="line">        self.kernel = np.ones((<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    self.gaussian_kernel_1d()</span><br><span class="line">    k = self.kernel</span><br><span class="line">    self.kernel = k.reshape(self.width,<span class="number">1</span>) * k.reshape(<span class="number">1</span>,self.width)</span><br></pre></td></tr></table></figure>
<p>更详细的代码可以参考<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2021/04/14/convolution-and-the-gaussian-convolution-kernel/gaussian_cov_kernel_acc.ipynb">高斯滤波器的生成</a>。</p>
<h2 id="参考文献">参考文献</h2>
<p>[1]: 图像处理、分析与机器视觉（第4版）<br>
[2]: <a href="https://www.zhihu.com/question/22298352">如何通俗易懂的解释卷积？</a><br>
[3]: <a href="http://www.ruanyifeng.com/blog/2012/11/gaussian_blur.html">高斯模糊的算法</a><br>
[4]: <a href="https://en.wikipedia.org/wiki/Separable_filter">separable filter</a><br>
[5]: Karas Pavel and Svoboda David (January 16th 2013). Algorithms for Efficient Computation of Convolution, Design and Architectures for Digital Signal Processing, Gustavo Ruiz and Juan A. Michell, IntechOpen, DOI: 10.5772/51942. Available from: <a href="https://www.intechopen.com/books/design-and-architectures-for-digital-signal-processing/algorithms-for-efficient-computation-of-convolution">https://www.intechopen.com/books/design-and-architectures-for-digital-signal-processing/algorithms-for-efficient-computation-of-convolution</a></p>
]]></content>
      <categories>
        <category>算法与数学</category>
      </categories>
      <tags>
        <tag>卷积</tag>
        <tag>高斯滤波器</tag>
        <tag>图像滤波</tag>
      </tags>
  </entry>
  <entry>
    <title>如何在MacOS下编译vmaf并训练自己的模型</title>
    <url>/2021/03/24/how-to-complie-VMAF-for-the-MacOS/</url>
    <content><![CDATA[<p><a href="https://github.com/Netflix/vmaf">VMAF</a>是Netflix开发的、用于评估视频感知质量的算法。VMAF包括一个独立的C语言库libvmaf及其对该库的Python包装。在Python库中，还提供了一组工具，以方便用户可以训练和测试自定义的VMAF模型。目前为止，在工业实践中，VMAF是视频质量评估领域中最优秀的全参考评估算法。</p>
<p>但是，在MacOS上编译并使用VMAF的过程中，发现会有一些问题导致无法编译成功，并且和模型训练相关的python代码也存在某些小的冲突，导致在整个模型训练的过程会出现某些异常。</p>
<p>本文就是对自己在调试过程中遇到的问题的总结。</p>
<p><img src="/2021/03/24/how-to-complie-VMAF-for-the-MacOS/1.jpeg" alt></p>
<span id="more"></span>
<p>我所使用的VMAF的版本为commit id为<a href="https://github.com/Netflix/vmaf/commit/6f1f0c98845e4e9c34ae0bdfa00aee5c91fa6e0c">6f1f0c98</a>的这次提交。遇到的所有问题也都是基于这次提交，这一点要额外注意。主要解决的问题和具体的解决方法可以参考文章接下来的部分。</p>
<h2 id="libvmaf-test-tools链接问题">libvmaf test/tools链接问题</h2>
<p>在编译libvmaf的<code>C</code>库的时候，发现当编译<code>test</code>和<code>tools</code>目录下的文件时，会出现异常。</p>
<p>经过排查以后，发现是对应的编译产出的链接库出现了异常。在编译时，如果配置<code>default_library</code>为<code>both</code>，则会产出libvmaf的静态链接库和动态链接库，并且在产出<code>test</code>和<code>tools</code>相关对象时，会优先选择采用静态链接库进行链编。具体如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vmaf &#x3D; executable(</span><br><span class="line">    &#39;vmaf&#39;,</span><br><span class="line">    ...</span><br><span class="line">    link_with : get_option(&#39;default_library&#39;) &#x3D;&#x3D; &#39;both&#39; ? libvmaf.get_static_lib() : libvmaf,</span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>不确定为什么这里采用静态链接库时会出现异常，但是把静态链接库改成动态链接库之后，整个工程就可以成功编译了。至于原因，等有时间再仔细定位一下。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vmaf &#x3D; executable(</span><br><span class="line">    &#39;vmaf&#39;,</span><br><span class="line">    ...</span><br><span class="line">    link_with : libvmaf,</span><br><span class="line">    ...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="libsvm库的路径设置问题">libsvm库的路径设置问题</h2>
<p>在使用python目录下提供的相关工具进行模型训练的时候，最终会使用<code>python/vmaf/svmutil.py</code>来实现对<code>libsvm</code>库的调用，进而根据训练数据产出<code>SVM</code>的模型文件。</p>
<p>但是，在<code>svmutil.py</code>中会配置<code>libsvm</code>库的路径，默认情况下，这个路径的配置如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libsvm_path &#x3D; VmafConfig.root_path(&#39;third_party&#39;, &#39;libsvm&#39;, &#39;python&#39;)</span><br></pre></td></tr></table></figure>
<p>而实际上，在我所编译的机器上，使用<code>pip3 install libsvm</code>之后，<code>libsvm</code>的路径并非是如上指定的路径，因此会导致在调用<code>libsvm</code>时出现异常，根据自己编译机器的具体情况，修改<code>libsvm_path</code>的路径即可解决问题，具体如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libsvm_path &#x3D; VmafConfig.root_path(&#39;site-packages&#39;, &#39;libsvm&#39;)</span><br></pre></td></tr></table></figure>
<h2 id="matplotlib中设置backend为agg带来的问题">Matplotlib中设置backend为agg带来的问题</h2>
<p>关于Matplotlib中的backend相关的问题，此处不再详细展开，具体可以参见<a href="/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/">matplotlib的backends以及非交互式绘图</a>。</p>
<p>默认情况下，在vmaf中，Matplotlib的backend会设置为agg模式。例如，在<a href="https://github.com/Netflix/vmaf/blob/master/python/vmaf/script/run_vmaf_training.py">python/vmaf/script/run_vmaf_training.py</a>中，就进行了相关的配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env python3</span><br><span class="line"></span><br><span class="line">import matplotlib</span><br><span class="line">matplotlib.use(&#39;Agg&#39;)</span><br></pre></td></tr></table></figure>
<p>在使用<code>libsvm</code>训练完模型之后，会对VMAF的<code>SRCC</code>，<code>PCC</code>等指标进行计算，并利用<code>python/vmaf/config.py</code>中的<code>DisplayConfig.show()</code>最终调用<code>matplotlib</code>来进行结果的可视化展现。但是，在<code>DisplayConfig.show()</code>中，却是使用是否存在参数<code>write_to_dir</code>来判断调用什么<code>backends</code>，这就会和之前的<code>Agg</code>配置出现冲突，因此这里需要做一个简单的升级，如下所示：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> matplotlib.rcParams[<span class="string">&#x27;backend&#x27;</span>] == <span class="string">&#x27;agg&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;write_to_dir&#x27;</span> <span class="keyword">in</span> kwargs:</span><br><span class="line">        <span class="built_in">format</span> = kwargs[<span class="string">&#x27;format&#x27;</span>] <span class="keyword">if</span> <span class="string">&#x27;format&#x27;</span> <span class="keyword">in</span> kwargs <span class="keyword">else</span> <span class="string">&#x27;png&#x27;</span></span><br><span class="line">        filedir = kwargs[<span class="string">&#x27;write_to_dir&#x27;</span>] <span class="keyword">if</span> kwargs[<span class="string">&#x27;write_to_dir&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> VmafConfig.workspace_path(<span class="string">&#x27;output&#x27;</span>)</span><br><span class="line">        os.makedirs(filedir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">for</span> fignum <span class="keyword">in</span> plt.get_fignums():</span><br><span class="line">            fig = plt.figure(fignum)</span><br><span class="line">            fig.savefig(os.path.join(filedir, <span class="built_in">str</span>(fignum) + <span class="string">&#x27;.&#x27;</span> + <span class="built_in">format</span>), <span class="built_in">format</span>=<span class="built_in">format</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">format</span> = <span class="string">&#x27;png&#x27;</span></span><br><span class="line">        filedir = VmafConfig.workspace_path(<span class="string">&#x27;output&#x27;</span>)</span><br><span class="line">        os.makedirs(filedir, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">for</span> fignum <span class="keyword">in</span> plt.get_fignums():</span><br><span class="line">            fig = plt.figure(fignum)</span><br><span class="line">            fig.savefig(os.path.join(filedir, <span class="built_in">str</span>(fignum) + <span class="string">&#x27;.&#x27;</span> + <span class="built_in">format</span>), <span class="built_in">format</span>=<span class="built_in">format</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<p>实际上，只有在MacOS上才会出现该问题，因此更合理的方式是根据系统来设置Matplotlib的backends，而不是直接修改Config类。具体可以参考<a href="https://github.com/Netflix/vmaf/pull/852">这里的讨论</a>。</p>
<h2 id="libvmaf的特征和python中使用的特征的差异">libvmaf的特征和python中使用的特征的差异</h2>
<h4 id="libvmaf种各特征的类型">libvmaf种各特征的类型</h4>
<p>默认情况下，编译出来的libvmaf库使用的是integer类型的特征，具体如<code>meson_option.txt</code>所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">option(&#39;enable_float&#39;,</span><br><span class="line">    type: &#39;boolean&#39;,</span><br><span class="line">    value: false,</span><br><span class="line">    description: &#39;Compile floating-point feature extractors into the library&#39;)</span><br></pre></td></tr></table></figure>
<h4 id="python训练模型时各特征的类型">python训练模型时各特征的类型</h4>
<p>在使用python来训练模型时，会根据<code>run_vmaf_training.py</code>指定的特征文件来确定是抽取<code>float</code>类型的特征还是<code>integer</code>类型的特征。</p>
<p>当<code>feature_dict</code>的key为<code>VMAF_integer_feature</code>时，则抽取的是<code>integer</code>类型的特征，当key为<code>VMAF_feature</code>时，抽取的为<code>float</code>类型的特征。具体的判断逻辑位于<a href="https://github.com/Netflix/vmaf/blob/master/python/vmaf/core/feature_assembler.py">feature_assembler.py</a>中的<code>FeatureAssembler.run()</code>。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27; 抽取各特征的integer类型特征</span></span><br><span class="line"><span class="string">feature_dict = &#123;</span></span><br><span class="line"><span class="string">    &#x27;VMAF_integer_feature&#x27;: [&#x27;vif_scale0&#x27;, </span></span><br><span class="line"><span class="string">                             &#x27;vif_scale1&#x27;, </span></span><br><span class="line"><span class="string">                             &#x27;vif_scale2&#x27;, </span></span><br><span class="line"><span class="string">                             &#x27;vif_scale3&#x27;, </span></span><br><span class="line"><span class="string">                             &#x27;adm2&#x27;, </span></span><br><span class="line"><span class="string">                             &#x27;motion&#x27;]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span> 抽取各特征的<span class="built_in">float</span>类型特征</span><br><span class="line">feature_dict = &#123;</span><br><span class="line">    <span class="string">&#x27;VMAF_feature&#x27;</span>: [<span class="string">&#x27;vif_scale0&#x27;</span>, </span><br><span class="line">                             <span class="string">&#x27;vif_scale1&#x27;</span>, </span><br><span class="line">                             <span class="string">&#x27;vif_scale2&#x27;</span>, </span><br><span class="line">                             <span class="string">&#x27;vif_scale3&#x27;</span>, </span><br><span class="line">                             <span class="string">&#x27;adm2&#x27;</span>, </span><br><span class="line">                             <span class="string">&#x27;motion&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="保持libvmaf和python的对应">保持libvmaf和python的对应</h4>
<p>因此，在自己训练模型的时候要特别注意：务必保证libvmaf和python两处的特征类型必须对应起来。</p>
<ol>
<li>
<p>可以修改<code>meson_option.txt</code>的配置，让<code>libvmaf</code>的float类型的特征生效，此时需要使用<code>feature_dict['VMAF_feature']</code>来训练模型。</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">option(&#39;enable_float&#39;,</span><br><span class="line">    type: &#39;boolean&#39;,</span><br><span class="line">    value: true,</span><br><span class="line">    description: &#39;Compile floating-point feature extractors into the library&#39;)</span><br></pre></td></tr></table></figure>
<p>如上的所有改动，可以参考<a href="update.diff">update.diff</a>。</p>
</li>
<li>
<p>当然，也可以在编译的时候使用<code>-Denable_float=true</code>来开启float类型的特征支持。</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">meson setup build -Denable_float&#x3D;true</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>使用<code>feature_dict['VMAF_integer_feature']</code>来训练模型，此时不需要修改libvmaf的编译脚本。但是需要修改<a href="https://github.com/Netflix/vmaf/blob/master/python/vmaf/core/feature_extractor.py">feature_extractor.py</a>，将<code>VmafIntegerFeatureExtractor</code>类中的<code>float_ansnr</code>特征去掉。具体如下所示：</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ExternalProgramCaller.call_vmafexec_multi_features(</span><br><span class="line">    [&#39;adm&#39;, &#39;vif&#39;, &#39;motion&#39;],</span><br><span class="line">    yuv_type, ref_path, dis_path, w, h, log_file_path, logger, options&#x3D;&#123;</span><br><span class="line">        &#39;adm&#39;: &#123;&#39;debug&#39;: True&#125;,</span><br><span class="line">        &#39;vif&#39;: &#123;&#39;debug&#39;: True&#125;,</span><br><span class="line">        &#39;motion&#39;: &#123;&#39;debug&#39;: True&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      <categories>
        <category>IVQA</category>
      </categories>
      <tags>
        <tag>VMAF</tag>
      </tags>
  </entry>
  <entry>
    <title>VIF质量评估方法简介</title>
    <url>/2021/03/05/intoduction-to-VIF/</url>
    <content><![CDATA[<p>视觉信息保真度（VIF）是基于<a href="https://en.wikipedia.org/wiki/Scene_statistics">自然场景统计（<em>natural scene statistics</em>）</a>和<a href="https://wangwei1237.gitee.io/digital-video-concept/docs/2_2_0_TheHumanVisualSystem.html">人类视觉系统（<em>human visual system</em>）</a>提取图像信息的一种全参考的图像质量评估指标，并且与人类对视觉质量的判断具有良好的相关性。</p>
<p>2006年，Hamid R Sheikh和Alan Bovik在德克萨斯大学奥斯汀分校的图像和视频工程实验室（<em>LIVE: Laboratory for Image and Video Engineering</em>）提出了<a href="https://live.ece.utexas.edu/research/Quality/VIF.htm">VIF算法</a>。</p>
<p><img src="/2021/03/05/intoduction-to-VIF/1.gif" alt></p>
<span id="more"></span>
<h2 id="背景知识">背景知识</h2>
<h4 id="自然场景统计-nss-natural-scene-statistics">自然场景统计（<em>NSS: natural scene statistics</em>）</h4>
<p>使用可以在光谱范围内进行操作的高质量的<strong>捕获设备</strong>（红外拍摄仪、相机等）而获取到的<strong>视觉环境</strong>的图像和视频，我们称之为自然场景。因此，当我们提到术语<code>自然场景(NS:natural scene)</code>的时候，我们一般指的就是我们所拍摄的，我们所处的，这个世界的照片或视频。这与其他类型的信息完全不同，例如：</p>
<ul>
<li>文本</li>
<li>计算机生成的图形</li>
<li>卡通或者动画</li>
<li>绘画或者绘图</li>
<li>随机噪声</li>
<li>利用<code>nonvisual stimuli</code>生成的图像或者视频，例如雷达、声呐、X-rays、超声成像技术等</li>
</ul>
<p><code>自然场景</code>构成了所有类型的图像集合中的极小的子集。</p>
<p><code>场景统计</code>是感知领域中的一门学科。场景统计涉及到与场景有关的统计规律，并基于如下的前提：设计一个感知系统来解释场景。</p>
<p>很多研究者试图通过研究<a href="https://link.springer.com/article/10.1023/A:1021889010444"><code>自然场景</code>的统计信息来了解其结构</a>。研究人员认为，自然环境产生的视觉刺激促进了HVS的进化，并且，自然场景建模和HVS建模在本质上是一个<a href="https://baike.baidu.com/item/%E5%AF%B9%E5%81%B6%E7%90%86%E8%AE%BA/9582786">对偶问题</a>。</p>
<p>结合信号检测理论（<em>signal detection theory</em>），信息论（<em>information theory</em>）或估计理论（<em>estimation theory.</em>），自然场景统计可用于定义观察者的行为。目前，自然场景统计模型最成功的应用之一就是图片和视频的可感知的质量预测。之所以可以如此应用，其基本的前提是：</p>
<ul>
<li>图像、视频通常会涉及自然场景</li>
<li>图像、视频的失真会改变自然场景的统计信息</li>
<li>人类视觉系统对自然场景统计信息的变化非常敏感</li>
</ul>
<h4 id="vmaf">VMAF</h4>
<p>以VIF为基础，Netflix开发了到目前为止，视频质量评估领域的最优秀的全参考评估算法：<a href="https://netflixtechblog.com/toward-a-practimathcal-perceptual-video-quality-metric-653f208b9652">VMAF（<em>Video Multimethod Assessment Fusion</em>）</a>。</p>
<p>VMAF认为每个基本测量指标都在视频特征、失真类型和失真度上有不同的表现，通过机器学习算法可以将基础的测量指标融合得到最终的结果。当前，VMAF算法使用VIF、DLM（<em>细节损失指标</em>）、运动（<em>相邻帧差异</em>）作为基本测量指标，并使用SVM算法对测量指标进行融合来预测最终结果。VMAF基本原理如下图所示：</p>
<p><img src="/2021/03/05/intoduction-to-VIF/2.png" alt></p>
<p>虽然，VMAF的效果比PSNR和SSIM要好，但是其运行速度却较慢，在部分机器上甚至小于1帧/秒。</p>
<p>同时，虽然开源的VMAF也可以得到较好的得分，但是与Netflix公布的分值相比仍然稍有逊色。或许是因为VMAF未开源的部分中包含了更多的数据集训练模型和GPU的支持。</p>
<h2 id="vif算法">VIF算法</h2>
<h4 id="vif算法的核心思想">VIF算法的核心思想</h4>
<p>VIF算法将图像/视频的质量评估问题看作一个信息保真的问题，并从信息通信和共享的角度来评估图像/视频的质量。</p>
<p>VIF认为：</p>
<ul>
<li>人眼所看到的图像是通过HVS过滤之后而提取到的信息，在这个过程中，人类视觉系统也是一个简单的失真通道</li>
<li>在经过HVS之前，失真图像只是比原始图像多经过了一个失真通道</li>
<li>利用信息论的理论，把人眼从失真图像中提取到的信息和人眼从原始图像中提取到的信息进行对比，从而得到符合人主观感知的图像质量</li>
</ul>
<p>整体VIF算法中包含三个部分：<code>Source Model</code>，<code>Distortion Model</code>，<code>HVS Model</code>，具体如下图所示：</p>
<p><img src="/2021/03/05/intoduction-to-VIF/1.gif" alt></p>
<h4 id="source-model">Source Model</h4>
<p><code>Source Model</code>也称为原始图像建模，为了模拟HVS的多通道特性，VIF算法利用<a href="/2020/03/18/introduction-to-image-pyramid/">高斯金字塔</a>将图像分成四个不同的尺度，然后将每一个尺度分成大小不一的块，每一个块中的所有像素组成一个向量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>c</mi><mo stretchy="true">→</mo></mover></mrow><annotation encoding="application/x-tex">\overrightarrow{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9525600000000001em;vertical-align:0em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9525600000000001em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">c</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span></span></span></span>，并使用高斯混合模型对向量进行建模：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">C</mi><mo>=</mo><mi mathvariant="script">S</mi><mo separator="true">⋅</mo><mi mathvariant="script">U</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>S</mi><mi>i</mi></msub><mo separator="true">⋅</mo><msub><mover accent="true"><mi>U</mi><mo stretchy="true">→</mo></mover><mi>i</mi></msub><mo>:</mo><mi>i</mi><mo>∈</mo><mi>I</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathcal{C} = \mathcal{S} · \mathcal{U} = \{ S_i · \overrightarrow{U}_i : i \in I \}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">U</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.45533em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.05764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">U</span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69862em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mclose">}</span></span></span></span></span></p>
<p>对于<code>Source Model</code>而言，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mclose">)</span></span></span></span>表示第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>个块，如下图所示：<br>
<img src="/2021/03/05/intoduction-to-VIF/3.jpg" alt></p>
<p>在计算时，可以利用第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>块中的系数来估计第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>块的参数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">s</span></span></span></span>，具体如下：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mover accent="true"><mi>s</mi><mo stretchy="true">^</mo></mover><mi>i</mi><mn>2</mn></msubsup><mo>=</mo><mover accent="true"><mrow><mi>C</mi><mi>o</mi><mi>v</mi></mrow><mo stretchy="true">^</mo></mover><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>C</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\widehat{s}_i^2 = \widehat{Cov}(C,C)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1111079999999998em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.67056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span></span></span><span class="svg-align" style="width:calc(100% - 0.11112em);margin-left:0.11112em;top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.24em;"><svg width="100%" height="0.24em" viewbox="0 0 1062 239" preserveaspectratio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.23333em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.98333em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mclose">)</span></span></span></span></span></p>
<h4 id="distortion-model">Distortion Model</h4>
<p>对于<code>Distortion Model</code>而言，为了能够让<code>Distortion Model</code>中的计算可以成立，论文采用局部估计的方式来获取<code>distortion channel</code>的参数。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">D</mi><mo>=</mo><mrow><mi mathvariant="script">G</mi><mi mathvariant="script">C</mi></mrow><mo>+</mo><mi mathvariant="script">V</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>g</mi><mi>i</mi></msub><msub><mover accent="true"><mi>C</mi><mo stretchy="true">→</mo></mover><mi>i</mi></msub><mo>+</mo><msub><mover accent="true"><mi>V</mi><mo stretchy="true">→</mo></mover><mi>i</mi></msub><mo>:</mo><mi>i</mi><mo>∈</mo><mi>I</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathcal{D} = \mathcal{GC} + \mathcal{V} = \{g_i {\overrightarrow{C}}_i+{\overrightarrow{V}}_i:i \in I\}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.78055em;vertical-align:-0.09722em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.0593em;">G</span><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.45533em;vertical-align:-0.25em;"></span><span class="mopen">{</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.35533em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.20533em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="height:0.522em;min-width:0.888em;"><svg width="400em" height="0.522em" viewbox="0 0 400000 522" preserveaspectratio="xMaxYMin slice"><path d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69862em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mclose">}</span></span></span></span></span></p>
<p>具体做法为，在如下图所示的小波变换之后的频域图中，对于图中的第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>个系数而言，我们采用以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>为中心的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>×</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">B \times B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05017em;">B</span></span></span></span>的系数块上估计第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>个系数对应的参数：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">g_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mrow><mi>v</mi><mo separator="true">,</mo><mi>i</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma_{v,i}^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20888em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span></span></span></span>。</p>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">g_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为在该对应块之上的随机场<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">{G}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">G</span></span></span></span></span>的值，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mrow><mi>v</mi><mo separator="true">,</mo><mi>i</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma_{v,i}^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20888em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span></span></span></span>为在该对应块之上的随机场<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.22222em;">V</span></span></span></span></span>的方差。<br>
<img src="/2021/03/05/intoduction-to-VIF/4.jpg" alt></p>
<p>此时，<code>Distortion Model</code>中的参考信号和折损信号都能获取，因此可以很容易的用如下所示方法来对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">g_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mrow><mi>v</mi><mo separator="true">,</mo><mi>i</mi></mrow><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma_{v,i}^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.20888em;vertical-align:-0.394772em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.394772em;"><span></span></span></span></span></span></span></span></span></span>进行估计。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>g</mi><mo stretchy="true">^</mo></mover><mi>i</mi></msub><mo>=</mo><mover accent="true"><mrow><mi>C</mi><mi>o</mi><mi>v</mi></mrow><mo stretchy="true">^</mo></mover><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>D</mi><mo stretchy="false">)</mo><mover accent="true"><mrow><mi>C</mi><mi>o</mi><mi>v</mi></mrow><mo stretchy="true">^</mo></mover><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>C</mi><msup><mo stretchy="false">)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\widehat{g}_{i} = \widehat{Cov}(C,D)\widehat{Cov}(C,C)^{-1}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.865em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.67056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span></span></span><span class="svg-align" style="width:calc(100% - 0.05556em);margin-left:0.05556em;top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.24em;"><svg width="100%" height="0.24em" viewbox="0 0 1062 239" preserveaspectratio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.23333em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.98333em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.98333em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mover accent="true"><mi>σ</mi><mo stretchy="true">^</mo></mover><mrow><mi>v</mi><mo separator="true">,</mo><mi>i</mi></mrow><mn>2</mn></msubsup><mo>=</mo><mover accent="true"><mrow><mi>C</mi><mi>o</mi><mi>v</mi></mrow><mo stretchy="true">^</mo></mover><mo stretchy="false">(</mo><mi>D</mi><mo separator="true">,</mo><mi>D</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mover accent="true"><mi>g</mi><mo stretchy="true">^</mo></mover><mi>i</mi></msub><mover accent="true"><mrow><mi>C</mi><mi>o</mi><mi>v</mi></mrow><mo stretchy="true">^</mo></mover><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\widehat{\sigma}_{v,i}^{2} = \widehat{Cov}(D,D) - \widehat{g}_{i}\widehat{Cov}(C,D)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2472159999999999em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.67056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span></span></span><span class="svg-align" style="top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.24em;"><svg width="100%" height="0.24em" viewbox="0 0 1062 239" preserveaspectratio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.864108em;"><span style="top:-2.4530000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight">i</span></span></span></span><span style="top:-3.1130000000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.23333em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.98333em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.23333em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.67056em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">g</span></span></span><span class="svg-align" style="width:calc(100% - 0.05556em);margin-left:0.05556em;top:-3.43056em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.24em;"><svg width="100%" height="0.24em" viewbox="0 0 1062 239" preserveaspectratio="none"><path d="M529 0h5l519 115c5 1 9 5 9 10 0 1-1 2-1 3l-4 22
c-1 5-5 9-11 9h-2L532 67 19 159h-2c-5 0-9-4-11-9l-5-22c-1-6 2-12 8-13z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.19444em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.98333em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span><span class="svg-align" style="top:-3.6833299999999998em;"><span class="pstrut" style="height:3em;"></span><span style="height:0.3em;"><svg width="100%" height="0.3em" viewbox="0 0 2364 300" preserveaspectratio="none"><path d="M1181 0h2l1171 176c6 0 10 5 10 11l-2 23c-1 6-5 10
-11 10h-1L1182 67 15 220h-1c-6 0-10-4-11-10l-2-23c-1-6 4-11 10-11z"/></svg></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span></span></p>
<p>在估计前，会对每一个系数进行不同尺度的高斯卷积计算。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>o</mi><mi>v</mi><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">,</mo><mi>D</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">[</mo><mi>C</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mi>D</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>∗</mo><mi>F</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>−</mo><mspace linebreak="newline"></mspace><mo stretchy="false">[</mo><mi>C</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>∗</mo><mi>F</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>D</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>∗</mo><mi>F</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">Cov(C,D) = [C(n)D(n)] * F(n) - \\ 
           [C(n)*F(n)][D(n)*F(n)] 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.02778em;">D</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></span></p>
<h4 id="hvs-model">HVS Model</h4>
<p>对于<code>HVS Model</code>而言，VIF将其带来的误差整合为一个噪声。具体如下所示：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">E</mi><mo>=</mo><mi mathvariant="script">C</mi><mo>+</mo><mi mathvariant="script">N</mi><mo>=</mo><mi mathvariant="script">S</mi><mo separator="true">⋅</mo><mi mathvariant="script">U</mi><mo>+</mo><mi mathvariant="script">N</mi><mspace linebreak="newline"></mspace><mi mathvariant="script">F</mi><mo>=</mo><mi mathvariant="script">D</mi><mo>+</mo><msup><mi mathvariant="script">N</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mrow><mi mathvariant="script">G</mi><mi mathvariant="script">C</mi></mrow><mo>+</mo><mi mathvariant="script">V</mi><mo>+</mo><msup><mi mathvariant="script">N</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">\mathcal{E} = \mathcal{C} + \mathcal{N} = \mathcal{S} · \mathcal{U} + \mathcal{N} \\
\mathcal{F} = \mathcal{D} + \mathcal{N}&#x27; = \mathcal{GC} + \mathcal{V} + \mathcal{N}&#x27;
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08944em;">E</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.075em;">S</span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">U</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.801892em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.78055em;vertical-align:-0.09722em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.0593em;">G</span><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.801892em;vertical-align:0em;"></span><span class="mord"><span class="mord"><span class="mord mathcal" style="margin-right:0.14736em;">N</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.801892em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>因此，在VIF算法中，<code>HVS Model</code>其只有一个参数：视觉噪声的方差<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>n</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma_n^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>，从论文中可以发现，该参数是一个可以调节的参数，需要根据不同的视频数据集来调整以获取最佳的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>n</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma_n^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span></span>。</p>
<p>在VIF提供的小波域下的算法实现中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>n</mi><mn>2</mn></msubsup><mo>=</mo><mn>0.4</mn></mrow><annotation encoding="application/x-tex">\sigma_n^2=0.4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">4</span></span></span></span>，在VIF提供的<a href="vifp_mscale.m">像素域下的算法实现中</a>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>n</mi><mn>2</mn></msubsup><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">\sigma_n^2=2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>，在VMAF的integer_vif中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>n</mi><mn>2</mn></msubsup><mo>=</mo><mn>65536</mn><mo>&lt;</mo><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sigma_n^2=65536&lt;&lt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="mord">6</span><span class="mord">5</span><span class="mord">5</span><span class="mord">3</span><span class="mord">6</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&lt;</span></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>。</p>
<p><a href="https://github.com/Netflix/vmaf/blob/master/libvmaf/src/feature/vif_tools.c">VMAF实现VIF时</a>，对相关参数的计算函数<code>vif_statistic_s</code>就是采用了如上的方法。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">g     = sigma12 / (sigma1_sq + eps);</span><br><span class="line">sv_sq = sigma2_sq - g * sigma12;</span><br></pre></td></tr></table></figure>
<h4 id="vif的多尺度计算">VIF的多尺度计算</h4>
<p>最终，结合<code>Source Model</code>，<code>Distortion Model</code>，<code>HVS Model</code>，得到VIF算法：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>I</mi><mi>F</mi><mo>=</mo><mfrac><mrow><mi>I</mi><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">;</mo><mi>F</mi><mi mathvariant="normal">∣</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><mrow><mi>I</mi><mo stretchy="false">(</mo><mi>C</mi><mo separator="true">;</mo><mi>E</mi><mi mathvariant="normal">∣</mi><mi>s</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">VIF = \frac{I(C;F|s)}{I(C;E|s)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">E</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mord">∣</span><span class="mord mathdefault">s</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>在得到一个尺度VIF得分之后，可以非常方便的将计算过程扩展到其他的尺度。例如，对于有4个尺度的VIF的计算过程如下图所示：<br>
<img src="/2021/03/05/intoduction-to-VIF/5.jpg" alt><br>
其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mn>0</mn></mrow><annotation encoding="application/x-tex">f0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord">0</span></span></span></span>-<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">f3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord">3</span></span></span></span>滤波分别对应着宽度（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span>）为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>17</mn><mo>×</mo><mn>17</mn></mrow><annotation encoding="application/x-tex">17 \times 17</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">7</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">7</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn><mo>×</mo><mn>9</mn></mrow><annotation encoding="application/x-tex">9 \times 9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">9</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">9</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mo>×</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">5 \times 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">3 \times 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>=</mo><mi>N</mi><mi mathvariant="normal">/</mi><mn>5</mn></mrow><annotation encoding="application/x-tex">\sigma=N/5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mord">/</span><span class="mord">5</span></span></span></span>的高斯卷积核，具体如下图所示：<br>
<img src="/2021/03/05/intoduction-to-VIF/6.jpg" alt></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>I</mi><mi>F</mi><mo>=</mo><mfrac><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>a</mi><mi>l</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi>s</mi></mrow></munder><mrow><mi>n</mi><mi>u</mi><msub><mi>m</mi><mi>i</mi></msub></mrow></mstyle><mstyle scriptlevel="0" displaystyle="true"><munder><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><mi>a</mi><mi>l</mi><mi>l</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mi>s</mi></mrow></munder><mrow><mi>d</mi><mi>e</mi><msub><mi>n</mi><mi>i</mi></msub></mrow></mstyle></mfrac></mrow><annotation encoding="application/x-tex">VIF = \frac{\displaystyle\sum_{i \in all\_scales}{num_i}}{\displaystyle\sum_{i \in all\_scales}{den_i}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:5.418236em;vertical-align:-2.459118em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.9591180000000006em;"><span style="top:-2.1100000000000003em;"><span class="pstrut" style="height:3.0500050000000005em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em;"><span style="top:-1.847887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mtight" style="margin-right:0.02778em;">_</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">s</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.519113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">d</span><span class="mord mathdefault">e</span><span class="mord"><span class="mord mathdefault">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.2800050000000005em;"><span class="pstrut" style="height:3.0500050000000005em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-4.959118em;"><span class="pstrut" style="height:3.0500050000000005em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em;"><span style="top:-1.847887em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">∈</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mtight" style="margin-right:0.02778em;">_</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight" style="margin-right:0.01968em;">l</span><span class="mord mathdefault mtight">e</span><span class="mord mathdefault mtight">s</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.519113em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord"><span class="mord mathdefault">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.459118em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<h2 id="利用libvmaf计算vif">利用libvmaf计算VIF</h2>
<p>依赖于<a href="https://github.com/Netflix/vmaf">VMAF</a>良好的设计和强大的可扩展性，我们可以利用VMAF来单独的计算其单个特征的评估结果。对于VIF而言，我们可以采用如下的步骤，来计算两个给定的YUV格式的视频的VIF得分：</p>
<ul>
<li>按照<a href="https://github.com/Netflix/vmaf/tree/master/libvmaf">libvmaf的文档</a>编译libvmaf，如果希望得到更多的debug的信息，可以将<a href="https://github.com/Netflix/vmaf/blob/master/libvmaf/src/feature/integer_vif.c">integer_vif</a>的debug参数修改为<code>true</code>。</li>
<li>编写测试代码，调用libvmaf库中提供的相关api计算各尺度的VIF得分，具体参见<a href="test_vif.cpp">test_vif.cpp</a>。</li>
<li>利用如下命令编译test_vif.cpp:<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> g++ -o vif test_vif.cpp -Ilibvmaf/include -Llibvmaf/build/src -lvmaf</span></span><br></pre></td></tr></table></figure>
</li>
<li>计算两个视频的vif得分：<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> DYLD_LIBRARY_PATH=<span class="variable">$DYLD_LIBRARY_PATH</span>:libvmaf/build/src <span class="comment"># 如果执行vif报错</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vif t1.yuv t3.yuv 2160x2840</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>对于如下图所示的视频对，</p>
<p><img src="/2021/03/05/intoduction-to-VIF/9.jpg" alt></p>
<p>我们分别计算vif，ssim，psnr的得分可以得出如下结果：</p>
<p><img src="/2021/03/05/intoduction-to-VIF/8.jpg" alt></p>
<p>从结果看，对于这种折损VIF算法给出的结果更符合人的主观感受。</p>
<h2 id="vif的优势和局限性">VIF的优势和局限性</h2>
<h4 id="vif的优势">VIF的优势</h4>
<ul>
<li>
<p>一个好的<code>Distortion Model</code>可以使得折损图像和合成的图像能够有相同的感官质量。<code>Distortion Model</code>的目的并不是对图像的所有折损类型进行建模，而是对图像的折损带来的主观感受进行建模。因此，VIF不一定能够捕获所有的图像折损，但是却可以捕获这些图像的折损带来的感知折损。</p>
</li>
<li>
<p>另外，从<code>Distortion Model</code>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">D</mi><mo>=</mo><mrow><mi mathvariant="script">G</mi><mi mathvariant="script">C</mi></mrow><mo>+</mo><mi mathvariant="script">V</mi></mrow><annotation encoding="application/x-tex">\mathcal{D} = \mathcal{GC} + \mathcal{V}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.02778em;">D</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.78055em;vertical-align:-0.09722em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.0593em;">G</span><span class="mord mathcal" style="margin-right:0.05834em;">C</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord"><span class="mord mathcal" style="margin-right:0.08222em;">V</span></span></span></span></span>）可以发现，VIF将图像的折损拆分为三部分：</p>
<ul>
<li>信号增益<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">G</span></span></span></span></li>
<li>噪声<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span></span></span></span></li>
<li>HVS噪声<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>N</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">N&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>这使得VIF更符合当前的实际应用。例如图像的亮度增强，对比度增强等场景。在这些场景下，图像信号虽然发生了变化，但是这并不是图像处理过程引入的噪声。这也是为什么PSNR，SSIM等算法无法应用于类似场景的原因，而VIF的折损图像模型却可以完美的应用于这些场景。对于亮度增强或对比度增强的场景，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">G&gt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，从而使得<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>I</mi><mi>F</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">VIF&gt;1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72243em;vertical-align:-0.0391em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">V</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.13889em;">F</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，从而可以得出增强后的图像在感官质量上要优于参考图像的结论。我们用VIF计算对比度提升50%的视频视频时，发现参数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi></mrow><annotation encoding="application/x-tex">G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">G</span></span></span></span>实际上是&gt;1的，<br>
<img src="/2021/03/05/intoduction-to-VIF/12.jpg" alt><br>
并且得到如下的结果：<br>
<img src="/2021/03/05/intoduction-to-VIF/11.jpg" alt></p>
</li>
<li>
<p>从VIF的计算可以，VIF的最终得分是失真图像D在参考图像C下的得分。实际上而言，VIF是一种内容自适应的算法。给定的图像折损，对于不同的内容而言，其带来的主观感受是不一样的。利如，某些时候，我们需要利用运动模糊来展现物体的高速运动，但是对于观看羽毛球比赛时，如果出现羽毛球运动模糊的情况，就会令人讨厌了。对于，PSNR和SSIM等算法而言，在计算过程中是没有做类似的考虑的。<br>
<img src="/2021/03/05/intoduction-to-VIF/7.jpeg" alt></p>
</li>
</ul>
<h4 id="vif的局限性">VIF的局限性</h4>
<ul>
<li>VIF的理论基础来自于<code>自然场景</code>，因此VIF并不适用于非<code>自然场景</code>下的图像/视频的质量评估，这一点要尤其注意。</li>
<li>和PSNR，SSIM等算法相比，VIF算法的计算性能也是需要考虑的问题之一，在某些性能较差的机器上，其运算速度甚至低于1FPS。</li>
</ul>
]]></content>
      <categories>
        <category>IVQA</category>
      </categories>
      <tags>
        <tag>VIF</tag>
        <tag>FR</tag>
      </tags>
  </entry>
  <entry>
    <title>怎样更好的汇报自己的工作</title>
    <url>/2021/02/25/how-to-report-ourselves-work/</url>
    <content><![CDATA[<p>今年的职称评定工作比以往来的要早一点，好多的同学不得不在春节假期就准备自己的材料。每一次review别人的材料后，总会有一些感想，一直也没有时间整理出来，趁着这次机会，也结合自己过去的实践做一个简单的总结。</p>
<p><img src="/2021/02/25/how-to-report-ourselves-work/4.jpeg" alt></p>
<span id="more"></span>
<h2 id="我如何看待ppt">我如何看待PPT</h2>
<p>2019年，新东方年会的一个节目“释放自我”在互联网圈火了：</p>
<blockquote>
<p>干活的累死累活，有成果那又如何，到头来干不过写PPT的</p>
</blockquote>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=47440004&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<p>作为一个技术人，我即反对过度的PPT总结，同时更反对缺乏任何的PPT的总结，只是不要过度包装就好。很多的技术人员会认为只有写写代码才是正事，写PPT纯粹是浪费时间，并且还会说在亚马逊内部，开会时是不会出现画面丰富的PPT的，而是以文字呈现出来的备忘录。</p>
<p>但是，对于职称申请而言，这可不是一次普通的会议。我们要展现出自己的亮点，让评委认可我们的工作，PPT无疑是我们理清工作思路，展现工作成果，分享自己观点的绝佳手段和呈现形式。当对外宣传自己的产品的时候，亚马逊也是采用PPT的方式。</p>
<h2 id="如何框定ppt的版式">如何框定PPT的版式</h2>
<p>当然，对于技术人员而言，PPT不在于有多炫酷、动效有多牛，而在于对内容的合理的组织。缺乏内容的PPT，即便再炫酷也无用。</p>
<p>作为多年的技术人，我写过各种场景的PPT：</p>
<ul>
<li>部门总结大会的</li>
<li>职称申请的</li>
<li>向上汇报的</li>
<li>技术分享会的</li>
<li>技术宣讲会的</li>
<li>……</li>
</ul>
<p>我认为，在PPT的版式上，我们只需要做到让PPT看起来很干净就可以了，没必要在PPT的样式上花费太多的心思。干净要求我们的PPT的内容要：字体统一、样式统一、色调统一，风格统一……</p>
<p>有的同学，动不动就飘红，加粗，加背景，可能是想强调这里是重点，但是当这一页中所有内容都有各种样式的时候，也就分不清哪里是重点，哪里是非重点了。七种颜色一混合，那不就成了白色了吗？</p>
<h2 id="如何进行ppt的整体组织">如何进行PPT的整体组织</h2>
<p>在评审过程中，我发现大部分同学无论是在材料的组织上还是在PPT的组织上，都是乱的一塌糊涂，没有任何逻辑可言，纯粹就是在罗列一件件自己做的事情。</p>
<p>这里我们要清楚一点：材料的意义和作用在于证明我们已经具备了某些方面的能力，材料的功能就是论据。只有材料，没有材料所支持的观点那又有什么意义呢？让评委通过材料来猜吗？</p>
<p>因此，在材料的组织上，我一般推荐使用议论文的三要素来组织：</p>
<ul>
<li>论点</li>
<li>论据</li>
<li>论证</li>
</ul>
<p>我们需要根据要证明的不同能力来对材料进行分类，聚合，然后通过一定的论证方法来整合自己所做的每一件事情。在整合的过程中可以遵循以下的几点：</p>
<ul>
<li>
<p>结构化思维来组织材料：</p>
<ul>
<li>结论先行</li>
<li>以上统下</li>
<li>归纳分组：同类材料归类，有时候同一个材料可能说明我们具备多种能力，那这种情况下，在材料的选择上需要有所取舍，这个材料重点能说明哪些能力？正所谓“横看成岭侧成峰，远近高低各不同”。</li>
<li>逻辑递进：纵向有逻辑关系，横向有递进关系。<br>
<img src="/2021/02/25/how-to-report-ourselves-work/1.jpeg" alt></li>
</ul>
</li>
<li>
<p>每一个大的论点下面可以有多个不同的分论点，但是切忌，分论点不宜过多，最好不要超过3个。</p>
</li>
<li>
<p>不同论点的组织可以采用总分的结构，也可以采用总分总的结构，具体可以根据自己的喜好选择一种。</p>
</li>
<li>
<p>整个PPT的所有页面都是有逻辑关系的，需要认真考虑上下页之间的关联和衔接。</p>
</li>
</ul>
<h2 id="如何选择ppt的材料">如何选择PPT的材料</h2>
<p>在确定了PPT的大的组织方式之后，在正式开始之前，也需要对自己的所有的材料进行甄选，需要明确好要选择那些材料，要放弃那些材料，不同的材料用来支撑那些论点等。在选择材料的时候，可以遵循以下的几点：</p>
<ul>
<li>重要的内容说三遍，对于特别重要的内容，可以重复提及，但是要从不同的层面来提及，而不是简单的重复同样的内容。如果要强调自己的技术能力，可以通过：技术调研，攻克技术难点，自研核心卡脖子技术等多个方面来写。同样是写容貌，可以从沉鱼、落雁、闭月、羞花等方面来反复陈述。</li>
<li>通过别人的评价来证明自己的能力。雷士照明创始人吴长江说：人生五大发展阶段，首先自己要行；其次要有人说你行；再次，说你行的人要行；然后，你说谁行谁就行；最后，谁敢说你不行。因此，在选择别人评价的时候要选择那些重量级的人物，选择那些大家公认的“能行”的人物。</li>
</ul>
<p>当按照结构化思维确定了PPT的整体组织，并且按照PPT的整体组织选定了材料后，如果此时材料仍然比较多，该如何处理呢？怎们来确定哪些材料要放在前面，哪些材料需要删减？我一般采用的方法是把材料划分为5类：</p>
<ul>
<li>痛点材料：解决痛点问题的材料，例如手机上天天有骚扰电话、垃圾短信，有了号码通，一切都解决了。</li>
<li>兴奋点材料：这类材料可以让别人有眼前一亮的“哇塞”感，就好像是炎热夏天时喝下的那口冰红茶。</li>
<li>痒点材料：这种材料解决的问题不一定是痛点问题，但是讲出来之后别人也想尝试。</li>
<li>不痛不痒的材料：可做可不做，但是我们做了，效果层面又不太好说的材料。</li>
<li>常规材料：日常的常规工作。</li>
</ul>
<p>在对材料排序的时候，优先选择痛点材料和兴奋点材料，可以酌情选择痒点材料，尽量删减不痛不痒的材料和常规材料。</p>
<h2 id="如何组织每个材料">如何组织每个材料</h2>
<p>好多的材料都是在记流水账，比如：都是我优化了算法，优化了流程，优化了……我干了这个，做了那个，……</p>
<p>每次看到这种材料，我就会很气愤，我就忍不住的想打低分，这种材料毫无营养可言，毫无信息量可言。</p>
<p>每个材料都应该是一个完整的故事单元，每个材料都应该用最简短的内容体现出最大的信息量，如何才能做到这一点呢？</p>
<p>我一般采用的原则就是STAR原则：</p>
<ul>
<li>S（Situation）情境：做这个事情的背景下是什么？</li>
<li>T（Target）任务/目标：做这个事情要解决什么问题，要达到的目标是什么？</li>
<li>A（Action）行动：在整个项目中我们做了什么？</li>
<li>R（Result）结果：最终的结果如何？价值是怎样的？收益是怎样的？</li>
</ul>
<p><img src="/2021/02/25/how-to-report-ourselves-work/2.png" alt></p>
<p>按照如上的原则组织的材料首先能在背景方面讲所有人拉到一个场景下来思考问题，保证大家的基准是一致的。</p>
<p>另外，背景的意义还在于大家会通过背景来了解到我们所做工作面临的难度，我们要解决的目标的复杂度。难度，复杂度决定了我们的高度。有些时候，难度不是我们说出来的，而是在我们介绍完背景之后大家的共识。</p>
<p>背景要做到少一字则解释不清楚，多一字则是累赘的要求，切忌长篇大论。弱水三千，只取一瓢饮。哐哐哐整页整页的上架构图干嘛呀。</p>
<p>然后在对问题有了一致认识的情况下，才能评估我们拆解的目标是不是合理的，如果连目标都不合理，那么基本上后面所有的内容就没有什么意义了。</p>
<p>有了背景，有了目标，我们的行动才更有意义，才能体现出我们的技术能力，解决问题的能力……</p>
<p>最重要的是，我们做的事情是有结果的，所以最终的结果也是不可或缺的内容。只有结果没有过程，那成功就不可复制；只有过程，没有结果，那过程就是垃圾。</p>
<h4 id="司马光砸缸的材料">司马光砸缸的材料</h4>
<p>以司马光砸缸为例，为了体现司马光的英勇果敢，我们可以按STAR原则来组织材料：</p>
<ul>
<li>S：一群小孩在院子里玩闹，其中一个小孩爬到了水缸边沿，一不小心，跌入了水缸没入水中，其他小孩都吓跑了。</li>
<li>T：要把小孩救出来。</li>
<li>A：司马光拿起石头，砸破了水缸。</li>
<li>R：水从水缸里流了出来，小孩得救了。</li>
</ul>
<p><img src="/2021/02/25/how-to-report-ourselves-work/3.jpeg" alt></p>
<p>如果按照之前的材料写法，那么这个材料就成了：司马光拿起石头，砸破了水缸。如果是这样的话，那么我们如何根据这个材料来对司马光做出评价呢？</p>
<h2 id="如何处理不同级别使用同一材料的场景">如何处理不同级别使用同一材料的场景</h2>
<p>我经常会发现很多不同的级别会引用同样的项目，但是在材料的表述上，又基本一致。如果是这样，那么高级别的同学如何能体现出自己的价值呢？</p>
<p>一个项目确实是由一个团队来完成的，但是这个团队的组成是不同的，就像篮球队一样，有：</p>
<ul>
<li>教练</li>
<li>前锋
<ul>
<li>小前锋</li>
<li>大前锋</li>
</ul>
</li>
<li>中锋</li>
<li>后卫
<ul>
<li>控球后卫</li>
<li>得分后卫</li>
</ul>
</li>
</ul>
<p>完成一个项目的众多团队成员中也会有不同的级别，而不同的级别所担负的职能和责任也不尽相同。因此，在这种情况下，在材料的准备上，要体现出符合自己所处级别要求的材料。</p>
<h2 id="如何组织工作收益">如何组织工作收益</h2>
<p>我看到最多的材料收益是下面的样子：</p>
<ul>
<li>我的技术累计代码行数xxx行</li>
<li>我的技术被多少产品线使用</li>
<li>我开发了多少接口</li>
<li>我的接口被调用了多少次</li>
<li>……</li>
</ul>
<p>但是，在我看来，这些不是具体的收益，这些不过是一个结果而已。以司马光砸缸为例，这就好比是：小孩跌入水缸，没入水中，司马光拿起石头，砸破水缸，水流了出来。</p>
<p>如上的这种结果的写法，这种收益的写法，在我看来是不完整的。</p>
<p>我们在写收益的时候，需要特别注意这一点，我们要多问自己几个：然后呢？</p>
<p>水流了出来，然后呢？</p>
<p>水流了出来不是收益，不是价值，小孩得救了才是最大的价值。开发了几百个接口是现实，然后呢？这些接口提升了50%的研发效率，这才是价值。</p>
<p>目标是业务价值，技术改进只是手段而已，做技术改进的目标不是为了多少次的接口调用，而是实现业务价值。因此，在收益部分要明确好目标和手段的关系。</p>
<h2 id="如何组织-个人介绍">如何组织“个人介绍”</h2>
<p>平时就让所有的人就对我们就非常了解是一件非常难的事。因此，在这种场景下，一份完美的个人介绍材料就相当于是：万事开头难。</p>
<p>有些同学在这一页组织的的过于随意，只是简单罗列一下自己的工作经历就草草了事。殊不知，这种内容还不如没有。草草了事往往会给人不好的印象，往往从一开始就拉低了自己在别人中的层级。这种时候就属于：没有印象比有一个比较差的印象要好很多。</p>
<p>其实，个人介绍这一页的内容不在多，而在于引导别人从哪个角度来评价自己，在于引导别人给自己打上一个什么标签，在于引导别人确定自己的层级……</p>
<p>因此，这一页的材料组织要特别用心，要从自己取得的成就来铺开，要针对自己期望的标签来铺开。比如要体现自己的技术卓越，可以从：专利，获得的高价值的技术创新奖等方面来展开。因为，这些奖项的获取，是经过了审核和认证的，是大家公认的，是不需要别人再做二次评估的。</p>
<p>因此，个人介绍中的材料需要本着如下的原则：</p>
<ul>
<li>材料足够精简但要足够闪光</li>
<li>材料不需要别人二次评估</li>
<li>根据期望别人如何定位自己来组织材料</li>
</ul>
<h2 id="如何应对别人的质疑">如何应对别人的质疑</h2>
<p>所有人都会存在心理上的自我保护机制，当别人质疑我们的时候，这种自我保护机制就会不自然开启。此时，为了减轻别人的质疑所产生的紧张和焦虑，我们会找一些表面上冠冕堂皇的理由来为自己辩护以自圆其说，当然这些理由是经不起推敲的，并非真理由，也非好理由。</p>
<p><img src="/2021/02/25/how-to-report-ourselves-work/5.gif" alt></p>
<p>还会有同学自命不凡，觉得评委什么都不懂，就是坐在下面不停的瞎问，所以在回答评委的问题上，也会显得漫不经心。</p>
<p>我们都是凡人，凭什么我们讲的内容别人就不能有疑问呢？凭什么要求别人就必须认同我们的观点呢？</p>
<p>有时候，有质疑就是我们体现自己的绝佳时刻，因为质疑，我们才能利用这种机会来更详细的阐述自己所做的事情的思路和价值。我们之前讲过：重要的事情说三遍，其实，在回答问题时，就是其中的一遍呀。将别人从质疑带入到认同的过程，是一个呈现自己的良好的机会。</p>
<p>在应对别人的质疑的时候，需要遵循如下的原则：</p>
<ul>
<li>把回答质疑看作是一个分享成果的过程，避免启动自我心理保护</li>
<li>先想清楚别人质疑的点在哪里，不要答非所问，乱说一通</li>
<li>掌握整个答疑的主动权，别被别人牵着鼻子走</li>
</ul>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>汇报</tag>
        <tag>述职</tag>
      </tags>
  </entry>
  <entry>
    <title>HDR技术导论</title>
    <url>/2021/01/26/HDR-introduction/</url>
    <content><![CDATA[<p>真实世界的亮度范围是十分广阔的，而人眼能感知到的亮度范围在十万尼特左右。举个例子，用分光色度计测量向着阳光盛开的花朵，其黄色区域亮度最高可达14700尼特，边缘的红色是2300尼特，中央的花蕊和绿叶只有200尼特以下。但是，在窄色域、亮度普遍不超过100尼特、对比度也只有1000：1的SDR显示器下，这张照片的色彩会暗淡很多。但是随着技术的发展，HDR技术可以达到广色域、1000尼特亮度以及上万的对比度。虽然和现实标准相差还是比较大，但是相较于三十年前的SDR，HDR还是前进了一大步。</p>
<p><img src="/2021/01/26/HDR-introduction/nit.jpg" alt></p>
<span id="more"></span>
<h2 id="hdr介绍">HDR介绍</h2>
<p>HDR是<em>High Dynamic Range</em>的缩写。HDR是一种数字图像技术，可以利用这种技术来提升数字图像的色彩以及对比度的范围。</p>
<p>和SDR（<em>Standard Dynamic Range</em>：标准动态范围）相比，HDR具有如下特点：</p>
<ul>
<li>更宽的色彩范围</li>
<li>更亮的亮度上限</li>
<li>更黑的亮度下限</li>
<li>在对比度、灰度分辨率等维度上对影像质量上进行了整体提升</li>
</ul>
<p>从而，HDR可以给用户带来更具沉浸式的感受。</p>
<p>HDR技术可以应用于拍照（<em>photography</em>）和视频（<em>video</em>），但是需要注意的是：虽然<code>photo HDR</code>和<code>video HDR</code>的目标都是让我们所看到的数字内容更逼近人眼的真实体验，但是这两者确实是完全不同的两个概念。本质上讲，<code>photo HDR</code>是一个相机捕获照片（<em>capture</em>）的过程，而<code>video HDR</code>则是一个显示(<em>display</em>)的过程。[^1]</p>
<h2 id="光度学概念及单位">光度学概念及单位</h2>
<p>在进一步介绍HDR之前，我们需要先了解一些<a href="http://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=AB4FAB66987D97573EA90F4DD56ABA36">光度学</a>的相关概念，以便能够能够对HDR有更好的理解和认识。</p>
<ul>
<li>
<p><strong>辐射通量</strong>：在光辐射测量学中，使用的基本物理量是<code>辐射通量</code>或<code>辐射功率</code>，符号表示为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Φ</mi><mi>e</mi></msub></mrow><annotation encoding="application/x-tex">\Phi_{e}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，单位是瓦特（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi></mrow><annotation encoding="application/x-tex">W</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span>）。辐射通量由一个辐射源发出，并通过某种传播介质进行传输并在某种表面上接收该辐射通量。</p>
</li>
<li>
<p><strong>光通量</strong>：<code>光通量</code>是指按照国际规定的标准人眼视觉特性评价的辐射通量的导出量，也就是对<code>辐射通量</code>的光度量，其符号为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">\Phi_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。可以从<code>辐射通量</code>来导出<code>光通量</code>。</p>
</li>
<li>
<p><strong>光量</strong>： <code>光量</code>也称为<code>光能</code>，指的是在给定的时间间隔（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">\Delta t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord">Δ</span><span class="mord mathdefault">t</span></span></span></span>）内，<code>光通量</code>的时间积分，符号表示为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">Q_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Q</mi><mi>v</mi></msub><mo>=</mo><msub><mo>∫</mo><mrow><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow></msub><mrow><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub><mo>⋅</mo><mi>d</mi><mi>t</mi></mrow></mrow><annotation encoding="application/x-tex">Q_{v}=\int_{\Delta t}{\Phi_{v} \cdot dt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">Q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.1608200000000002em;vertical-align:-0.35582em;"></span><span class="mop"><span class="mop op-symbol small-op" style="margin-right:0.19445em;position:relative;top:-0.0005599999999999772em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.12251099999999993em;"><span style="top:-2.34418em;margin-left:-0.19445em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mathdefault mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35582em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">t</span></span></span></span></span>。</p>
</li>
<li>
<p><strong>发光强度</strong>：<code>发光强度</code>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">I_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）为光源发出的并且在指定方向的立体角元<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">Ω</mi></mrow><annotation encoding="application/x-tex">d \Omega</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord">Ω</span></span></span></span>内传播的光通量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d \Phi_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault">d</span><span class="mord"><span class="mord">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>与该立体角元<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">Ω</mi></mrow><annotation encoding="application/x-tex">d \Omega</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord">Ω</span></span></span></span>的商，即：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>v</mi></msub><mo>=</mo><mfrac><mrow><mi>d</mi><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub></mrow><mrow><mi>d</mi><mi mathvariant="normal">Ω</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">I_{v}=\frac{d \Phi_{v}}{d \Omega}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2412079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8962079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mtight">Ω</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mtight"><span class="mord mtight">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。<code>发光强度</code>的单位为<code>坎德拉</code>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">cd</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">d</span></span></span></span>）。坎德拉是发射出频率为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>540</mn><mo>×</mo><mn>1</mn><msup><mn>0</mn><mn>12</mn></msup><mi>H</mi><mi>z</mi></mrow><annotation encoding="application/x-tex">540 \times 10^{12} Hz</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">5</span><span class="mord">4</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span></span></span></span>的单色辐射的光源在指定方向上的发光强度，并且该光源在该方向上的辐射强度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>683</mn></mfrac><mi>W</mi><mo>⋅</mo><mi>s</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">\frac{1}{683} W \cdot sr</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">8</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span></span></span>。</p>
</li>
<li>
<p><strong>光亮度</strong>： <code>光亮度</code>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">I_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）指在某方向上单位投影面积的面光源沿该方向的<code>发光强度</code>。面光源上小面元的面积为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>A</mi></mrow><annotation encoding="application/x-tex">dA</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span></span></span></span>，某一方向与面元法线的夹角为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span></span></span></span>，面元沿这个方向的投影面积为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>A</mi><mo>⋅</mo><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi></mrow><annotation encoding="application/x-tex">dA \cdot cos \theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">A</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">s</span><span class="mord mathdefault" style="margin-right:0.02778em;">θ</span></span></span></span>，则面元沿这个方向的光亮度为：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mi>I</mi><mi>v</mi></msub><mrow><mi>d</mi><mi>A</mi><mo>⋅</mo><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{I_{v}}{dA \cdot cos \theta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.233431em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8884309999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">A</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.07847em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>I</mi><mi>v</mi></msub><mo>=</mo><mfrac><mrow><mi>d</mi><msub><mi mathvariant="normal">Φ</mi><mi>v</mi></msub></mrow><mrow><mi>d</mi><mi>A</mi><mo>⋅</mo><mi>c</mi><mi>o</mi><mi>s</mi><mi>θ</mi><mo>⋅</mo><mi>d</mi><mi mathvariant="normal">Ω</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">I_{v}=\frac{d \Phi_{v}}{dA \cdot cos \theta \cdot d \Omega}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.07847em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.2412079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8962079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mathdefault mtight">A</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight">s</span><span class="mord mathdefault mtight" style="margin-right:0.02778em;">θ</span><span class="mbin mtight">⋅</span><span class="mord mathdefault mtight">d</span><span class="mord mtight">Ω</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">d</span><span class="mord mtight"><span class="mord mtight">Φ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。由此可知，<code>光亮度</code>的单位为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>d</mi><mi mathvariant="normal">/</mi><msup><mi>m</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">cd/m^{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault">d</span><span class="mord">/</span><span class="mord"><span class="mord mathdefault">m</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>（坎德拉/平方米），又称为<code>尼特</code>。例如，iPhone12的屏幕的光亮度为：625 尼特最大亮度 (典型)，1200 尼特最大亮度 (HDR)。</p>
</li>
</ul>
<h2 id="photography-hdr">photography HDR</h2>
<p>可以通过同时捕获不同曝光度的多张图像的方法来生成HDR照片。相机会使用不同的曝光值快速拍摄三张或更多的照片，然后对其进行处理，以生成一张HDR照片。</p>
<p>在拍摄高对比度场景的照片时，HDR图像处理非常有用。</p>
<p>如下图的夜景所示，例如，曝光度太低时，会让后面的景色显得暗淡。如果调整曝光以显示后面的景色，则前面的景色又会太亮，甚至可能会完全变白。通过组合多次曝光，则可以平均这些不同的曝光，使的后面的景色可以出现在照片上，而又不会过度曝光前面的景色。[^2]</p>
<p><img src="/2021/01/26/HDR-introduction/EVDifferent.png" alt></p>
<p><img src="/2021/01/26/HDR-introduction/EVToneMapping.png" alt></p>
<p>目前，很多智能手机（例如iPhone）的相机都具有HDR选项。我们可以选择让相机：</p>
<ul>
<li>开启HDR（ON）</li>
<li>关闭HDR（OFF）</li>
<li>自动判断是否开启HDR（Auto）</li>
</ul>
<p>对于Auto模式，相机仅在高对比度的情况下才拍摄HDR照片。大多数相机还会在合成HDR照片时，同时捕获普通照片，从而允许我们可以在HDR照片和普通照片之间进行选择。</p>
<h3 id="dodging-and-burning和tone-mapping">dodging and burning和tone mapping</h3>
<p>实际上，在胶片时代，摄影师就会拍摄多张不同曝光程度的底片，并在<a href="https://baike.baidu.com/item/%E6%9A%97%E6%88%BF/62291">暗房</a>中使用一种**<a href="https://en.wikipedia.org/wiki/Dodging_and_burning">dodging and burning</a>**的手法，把数张底片合成为一张具有高动态范围的照片。随着数码相机的出现，HDR将暗房里的技术引入相机成像传感器，通过对同一个场景进行多种不同的曝光，然后对其进行合成，最终实现增强照片动态范围，达到增加照片层次感的目的。在照片HDR中，这种合成技术称之为<a href="https://en.wikipedia.org/wiki/Tone_mapping">色调映射（<em>tone mapping</em>）</a>。当然，在接下来的<code>video HDR</code>中也会用到色调映射技术，不同的是，<code>video HDR</code>中的色调映射是用来将HDR内容映射到SDR显示设备，使得SDR设备也能显示HDR内容。</p>
<h2 id="video-hdr">video HDR</h2>
<p>HDR视频的捕获方式与HDR照片类似。同时以不同的曝光（或不同的ISO配置）来录制每个镜头。然后把这些镜头融合在一起以生成单个镜头。尽管会产生看起来不真实的灰色效果，但这种方法通常可以使视频更亮。因此，HDR视频通常会在发布之前进行后期处理。</p>
<p>为了正确的显示HDR视频，显示设备也必须支持HDR。例如，具备HDR功能的电视必须支持特定的视频输出标准。这些标准中会涉及：10-bit色彩和至少覆盖90％的DCI-P3色彩空间。HDR显示器还必须支持特定的HDR格式，例如HDR10，Dolby Vision或Hybrid Log Gamma（HLG）。</p>
<p><img src="/2021/01/26/HDR-introduction/color_space.jpg" alt></p>
<p>CIE 1931 xy 中各个色彩空间的对比</p>
<p>以HDR10为例，因为HDR10标准使用广色域<code>Rec.2020</code>，10-bit色深以及<code>SMTPE ST 2084</code>PQ转换函数，因此在一台非HDR显示设备上去显示HDR10的内容，则会出现两种情况[<sup>3],[</sup>4]：</p>
<ul>
<li>无法解码导致花屏</li>
<li>可以解码，但是因为影片中的高亮部分会按照显示设备的最高亮度来显示而导致影片整体变灰</li>
</ul>
<p>这也就是HDR照片和HDR视频的不同之处：HDR视频除了视频捕获之外，对显示设备的能力有较强的依赖。</p>
<h4 id="pq-hlg">PQ &amp; HLG</h4>
<p>为了正确显示HDR图像，仅仅提高亮度是不够的，以一种与人类视力相匹配的方式显示色彩和色调至关重要。色彩和色调受伽玛<code>输入-输出</code>特性的影响。在HDR中，伽玛曲线有两种，分别是PQ和HLG。</p>
<ul>
<li>PQ伽玛曲线基于人类视觉感知的特征，并且最适合于在互联网上制作电影或串流视频的内容，其中再现准确性是关键。</li>
<li>HLG伽玛曲线旨在允许在现有的SDR电视上显示而不会看不到位置，并且最适合于广播电视和直播视频馈送。</li>
</ul>
<p>PQ和HLG的具体区别如下表所示：</p>
<table>
<thead>
<tr>
<th></th>
<th>PQ (感知量化)</th>
<th>HLG (混合对数伽玛)</th>
</tr>
</thead>
<tbody>
<tr>
<td>目标</td>
<td>互联网视频流，电影</td>
<td>广播电视，直播视频</td>
</tr>
<tr>
<td>优点</td>
<td>处理亮度的绝对值高达 10,000 cd/m²，基于人类视觉感知的新伽玛曲线</td>
<td>将亮度处理为相对值（与现有标准相同）兼容SDR电视</td>
</tr>
<tr>
<td>最大亮度</td>
<td>1,000 cd/m² 绝对值 一致，不管显示装置</td>
<td>相对值，因显示设备而异</td>
</tr>
<tr>
<td>黑色等级</td>
<td>0.005 cd/m2或更低</td>
<td>0.005 cd/m2 或更低</td>
</tr>
<tr>
<td>提议者</td>
<td>Dolby</td>
<td>BBC 和 NHK</td>
</tr>
<tr>
<td>参考标准</td>
<td>SMPTE ST 2084、ITU-R BT.2100</td>
<td>ITU-R BT.2100</td>
</tr>
<tr>
<td>在SDR显示设备上的效果</td>
<td>Poor</td>
<td>良</td>
</tr>
<tr>
<td>直播效果</td>
<td>良</td>
<td>优</td>
</tr>
</tbody>
</table>
<h2 id="hdr标准">HDR标准</h2>
<h4 id="hdr10">HDR10</h4>
<h4 id="dolby-vision">DOLBY VISION</h4>
<h4 id="hdr10">HDR10+</h4>
<h4 id="uhd-premium">UHD Premium</h4>
<h4 id="displayhdr">DisPlayHDR</h4>
<h4 id="mobile-hdr">Mobile HDR</h4>
<h4 id="cuva-hdr">CUVA HDR</h4>
<h4 id="vesa-hdr">VESA HDR</h4>
<h2 id="手机对hdr的支持">手机对HDR的支持</h2>
<h4 id="iphone">iPhone</h4>
<p>iPhone 12 Pro对于杜比视界的全方位支持，可以说是凭借着一己之力，将一项最先进，最前卫的HDR技术，带到了普罗大众的眼前。作为第一部支持HDR拍摄的手机，iPhone 12的Dolby Vision HDR拍摄是如何实现的？真的如宣传所说的那么牛吗？</p>
<p>或许我们能够从这位拥有5年HDR调色和教学经验的专家Samuel Bilodeau撰写的这篇评测中找到答案。作者在评测的最后说：我特别兴奋和开心的看到iPhone和其他具有HDR拍摄功能的消费级相机的出现，并推动着HDR向前迈了一步。</p>
<div class="bili_video"><div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;"><iframe src="https://player.bilibili.com/player.html?aid=289414701&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;"> </iframe></div></div>
<h2 id="ffmpeg分析hdr内容">FFmpeg分析HDR内容</h2>
<h4 id="ffprobe分析hdr内容的元数据">ffprobe分析HDR内容的元数据</h4>
<p>可以使用ffprobe命令来提取<code>Mastering Display</code>和<code>Content Light Level</code>的元数据。我们只需要提取第一帧的相关数据即可，因此，在分析时，可以使用<a href="http://ffmpeg.org/ffprobe.html#Main-options"><code>-read_intervals &quot;%+#1&quot;</code></a>选项，让ffprobe只提取第一帧的元数据。具体分析名利如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffprobe \</span><br><span class="line">-hide_banner \</span><br><span class="line">-loglevel warning \</span><br><span class="line">-select_streams v \</span><br><span class="line">-print_format json \</span><br><span class="line">-show_frames \</span><br><span class="line">-read_intervals &quot;%+#1&quot; \</span><br><span class="line">-show_entries &quot;frame=color_space,color_primaries,color_transfer,side_data_list,pix_fmt&quot; \</span><br><span class="line">HDR.mp4</span><br></pre></td></tr></table></figure>
<p>各选项的含义如下：</p>
<ul>
<li>-hide_banner -loglevel warning：不显示我们不需要的信息</li>
<li>-select_streams v：只选择视频流来分析</li>
<li>-print_format json：以json格式输出分析结果</li>
<li>-read_intervals “%+#1”：只分析第一帧中的数据</li>
<li>-show_entries … ：只输出我们指定的数据</li>
</ul>
<p>命令执行后，会显示如下的分析结果：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;frames&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;pix_fmt&quot;</span>: <span class="string">&quot;yuv420p10le&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;color_space&quot;</span>: <span class="string">&quot;bt2020nc&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;color_primaries&quot;</span>: <span class="string">&quot;bt2020&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;color_transfer&quot;</span>: <span class="string">&quot;smpte2084&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;side_data_list&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;side_data_type&quot;</span>: <span class="string">&quot;Mastering display metadata&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;red_x&quot;</span>: <span class="string">&quot;34000/50000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;red_y&quot;</span>: <span class="string">&quot;16000/50000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;green_x&quot;</span>: <span class="string">&quot;13250/50000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;green_y&quot;</span>: <span class="string">&quot;34500/50000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;blue_x&quot;</span>: <span class="string">&quot;7500/50000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;blue_y&quot;</span>: <span class="string">&quot;3000/50000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;white_point_x&quot;</span>: <span class="string">&quot;15635/50000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;white_point_y&quot;</span>: <span class="string">&quot;16450/50000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;min_luminance&quot;</span>: <span class="string">&quot;40/10000&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;max_luminance&quot;</span>: <span class="string">&quot;11000000/10000&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上所示，ffprobe分析结果中的颜色值以及最大/小亮度值均为一个比值，颜色值的最终结果会确定母版内容所用的颜色空间，而最大/小亮度值则确定了母版内容的动态范围。</p>
<p>根据如上的结果，我们可以知道，在CIE坐标上，红色，绿色，蓝色以及白点的坐标分别是：</p>
<ul>
<li>red: (0.68, 0.32)</li>
<li>green: (0.265, 0.69)</li>
<li>blue: (0.15, 0.06)</li>
<li>white point: (0.3127, 0.329)</li>
</ul>
<p>从<a href="https://en.wikipedia.org/wiki/DCI-P3">DCI-P3</a>的相关信息可知，该视频的母版内容在制作的时候采用的是<code>P3-D65 (Display)</code>颜色空间，其最小亮度为0.004尼特，最大亮度为1100尼特，对比度为275000。</p>
<h4 id="ffmpeg转码hdr内容">FFmpeg转码HDR内容</h4>
<p>对于HDR视频的转码时，需要将<code>Mastering Display</code>和<code>Content Light Level</code>元数据的内容传递给编码器（注意，不是传递给FFmpeg），否则，在转码的过程中会丢失这些信息，进而导致转码对画面内容的影响。具体的方式如下所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ffmpeg  -i hdr.mp4 \</span><br><span class="line">-map 0 -c:v libx265 \</span><br><span class="line">-x265-params hdr-opt=1:repeat-headers=1:colorprim=bt2020:transfer=smpte2084:colormatrix=bt2020nc:master-display=G(13250,34500)B(7500,3000)R(34000,16000)WP(15635,16450)L(11000000,40) \</span><br><span class="line">-crf 20 \</span><br><span class="line">-preset veryfast \</span><br><span class="line">-pix_fmt yuv420p10le \</span><br><span class="line">test.mp4</span><br></pre></td></tr></table></figure>
<p>其中，</p>
<ul>
<li>hdr-opt=1: 表示我们要启用HDR</li>
<li>repeat-headers=1: 表示每一帧都需要这些数据</li>
<li>colorprim, transfer and colormatrix: 和ffprobe保持一致</li>
<li>master-display: 根据ffprobe的结果来构造的颜色字符串</li>
</ul>
<h2 id="相关术语">相关术语</h2>
<h4 id="color-calibration-of-screens-屏幕的色彩校正">Color Calibration of Screens（屏幕的色彩校正）</h4>
<p>用于确保屏幕上色彩被准确显示的一个过程。一般使用色度计来测量一块显示屏的原生色彩响应，之后计算一个用于修正的指标以确保颜色能正确地显示在该显示器上，最后对经过修正后的响应进行检测。</p>
<h4 id="color-spaces-色彩空间">Color Spaces（色彩空间）</h4>
<p>一个色彩空间可以指一种颜色的组织方式，也可以指某个特定范围的色彩。在影院和电视的领域，我们一般使用 RGB（用红、绿、蓝原色分量来表示一个颜色）或者 YUV（用一个颜色的明度（黑白值），以及它的基于色彩成分差值所计算的色度值）色彩空间（译者注：RGB 和 YUV 为色彩模型，非色彩空间，此处原文有错误）。这些色彩空间一般基于特定的显示设备特性，参见 D65-P3 词条。其它的色彩空间，比如 XYZ 或者 Lab 更适用于表示人眼色彩视觉模型。</p>
<h4 id="contrast-ratio-对比度">Contrast Ratio（对比度）</h4>
<p>对比度是一个系统所能产生的最亮（白）部分和最暗（黑）部分之间的明度比值，通常用一个 n:1 的比值描述。</p>
<h4 id="cri-color-remapping-information-色彩重映射信息">CRI Color Remapping Information（色彩重映射信息）</h4>
<p>一套通过分析相同内容的两份不同母版（如 HDR 和 SDR 母版）所产生的标准元数据。当一份母版（如 HDR）和 CRI 元数据被一同传输时，解码器在面对 HDR 屏幕时可以仅解码 HDR 内容，而在面对 SDR 屏幕时也可以通过利用 CRI 元数据的方式将 HDR 内容变换成 SDR 内容。采用这一方案的主要优势在于对于两个解码后的版本，作者的创作意图得以保留。CRI 是 MPEG（HEVC v2）的标准成分之一，并且对于 Ultra HD Blu-ray 制作是可选功能。</p>
<h4 id="dci-p3-d65-p3-st-428-1">DCI-P3，D65-P3，ST 428-1</h4>
<p>一个数字电影色彩空间。DCI-P3 色彩空间是一个 2005 年由数字影院联盟（Digital Cinema Initiatives）引入的 RGB 色彩空间，并由 SMPTE ST428-1 于 2006 年标准化。</p>
<p>这一色彩空间拥有远比 sRGB（参见 Rec.709）宽广得多的色域。</p>
<p>所有的数字电影放映机都能完整显示 DCI-P3 色彩空间，D65 P3 指的是其白点的色温由 DCI 白点改为 D65 白点。</p>
<p>图中的三个三角形展现了：最大的是 Rec.2020 标准，Ultra HD TV 的新标准（目前只有激光显示能完整实现），略小的、用于数字电影的 DCI-P3，以及传统视频监视器、高清广播电视、蓝光、OTT 所采用的最小的 Rec.709 色彩空间。</p>
<h4 id="edid-扩展显示标识数据">EDID 扩展显示标识数据</h4>
<p>EDID 是扩展显示标识数据（Extended Display Information Data）的缩写，这个标准由 Consumer Technology Association（CTA）制定。这是由每个 DVI 显示器、HDMI 显示器，或其它支持 DVI HDMI 输入的设备（aka DVI/HDMI Sinks）所提供的。可能每个 DVI/HDMI 输入都有自己的 EDID。EDID 会告诉设备它所连接的显示器的性能特征。</p>
<p>源设备确认显示器的 DVI 或者 HDMI 接口是否存在 EDID 存储器（EDID memory）并使用其中的信息优化输出的视频（分辨率、帧率、色彩……）和/或音频格式。所有支持 DVI/HDMI 标准输入的设备，即 TMDS 接收端（DVI/HDMI Sinks）必须实现 EDID。</p>
<h4 id="eotf-电光转换函数">EOTF 电光转换函数</h4>
<p>EOTF 是 Electro-Optical Transfer Function 的缩写。他是一个映射码值到显示亮度的数学函数。换言之，一个 ETOF 定义了图像中的码值如何被显示器或者投影仪显示为可见光。</p>
<p>参见 OETF 光电转换函数，ST2084。</p>
<h4 id="oetf-光电转换函数">OETF 光电转换函数</h4>
<p>OETF 是 Opto-Electronic Transfer Function 的缩写。它是一个映射场景明度（某个场景的光）与可传输压缩的数字编码值之间的数学函数映射关系。这个术语一般用于获取图像的设备，比如数字相机。</p>
<p>在后期制作中，内容一般在某个拥有特定 EOTF 的屏幕上进行调色，历史上，常用一个OETF 的逆函数作为屏幕的 EOTF。</p>
<h4 id="ootf-光光转换函数">OOTF 光光转换函数</h4>
<p>OOTF 是 Optical-to-Optical Transfer Function 的缩写。它是一个把相机所拍摄的场景亮度映射到显示器亮度的数学函数。</p>
<h4 id="flicker-闪烁">Flicker 闪烁</h4>
<p>部分特定种类的显示器的特征，比如老的阴极射线管显示器（CRT），或者调教得很糟糕的平板显示器，甚至电影（motion picture film）放映机这一不受欢迎的亮度改变主要在频率低于 50 帧每秒时可见。对于亮度更高的显示器来说，人眼能感受到更高频率的闪烁。</p>
<h4 id="f-stop-of-dynamic-range-动态范围的-f-制光圈档数">f-stop of Dynamic Range 动态范围的 f 制光圈档数</h4>
<p>在摄影中，一档 f 制光圈的改变对应双倍（或减半）捕获图像时所捕捉的光。</p>
<p>一张图片中所包含的 f 制光圈数量描述了这张图片的对比度（2^N 标记）比如一台相机可以输出 10 档的图像，这意味着对比度可以高达 2^10（1024：1），即白色部分会比黑色部分亮 1024 倍。相比之下，人眼可以达到 18-20 档（这是一个很高的动态范围 HDR，一般的 SDR 视频图像是 6-7 档）</p>
<h4 id="gamut-or-color-gamut-色域">Gamut or Color Gamut 色域</h4>
<p>在包括但不限于计算机图形和摄影领域的色彩还原过程中，色域是某个特定的色彩的子集。</p>
<p>色域一词最常见的用途是指某个范围内可以被准确反应的色彩子集，这个前提可能是某个特定的显示设备或某个给定的色彩空间。色域一般使用 CIE 1931 色度图上的面积来表示，CIE 1931 曲线的边缘代表可见光光谱颜色的范围。</p>
<h4 id="gamut-mapping-色域映射">Gamut Mapping 色域映射</h4>
<p>在几乎所有的转译过程（指的是对于某个特定颜色的表示，在不同色彩空间中的转换过程）中，我们必须面对不同设备的色域所覆盖的范围是有所不同的现实，这使得准确还原色彩是不可能的。</p>
<p>因此，对于靠近色域边缘的部分是有必要进行一些处理的。有些颜色必须被移入色域中，不然它们在输出设备上无法被显示，它们会被粗暴地舍弃（clipped）掉。这就是所谓的色域不匹配，比如说当我们将更广的 RGB 色彩空间转换到 CMYK 色彩空间的时候就会出现。</p>
<p>色彩管理系统可以使用多种方法来实现所需的结果并且给予有经验的用户控制色域映射的的方式。</p>
<h4 id="imf-可交互母版文件">IMF 可交互母版文件</h4>
<p>Interoperable Master Format（IMF）是一个由 SMPTE 提供的标准，用于实现一个单文件的、可交换使用的母版文件格式和结构，用于全球范围内的商业内容分发。它是由 Digital Cinema Package（DCP）架构进化而来的，DCP 为分发渠道提供了一个完整的文件可交换单元。IMF 可以说是一个革命性的进步，IMF 提供了一个真正的基于文件的最终母版。DCP 针对的是影院内容分发，而 IMF 为商用环境提供了一个可以基于同一内容为不同的观众创建多种剪辑版本的母版格式。</p>
<h4 id="inverse-tone-mapping-itm-逆影调映射-反向影调映射">Inverse Tone Mapping (ITM) 逆影调映射/反向影调映射</h4>
<p>对于 SDR 内容的母版重制从而实现 HDR 内容。</p>
<p>ITM 使用 SDR 内容并且扩展其明度和色彩空间，使其匹配 HDR 显示器的能力，并且保留原本内容创作者的意图。</p>
<h4 id="lut-查找表">LUT 查找表</h4>
<p>是 Look Up Table 的缩写。LUT 提供了一种对输入的数据施加复杂数学运算的高效方式———如果不使用 LUT 则会耗费许多的计算资源。因此，它们是一种将图像从一个色彩空间映射到零一个色彩空间的理想实现方法。</p>
<p>存在以下的 LUTs：</p>
<p>3D LUTs，每个像素的输出 R’、G’、B’ 值是由输入像素的 R、G、B 值共同计算的。</p>
<p>1D LUTs，输出的 R’ 只由输入的 R 值计算，G’、B’ 同理。它们一般被用于 gamma 函数和其它 EOTF 的施加矫正，一般在消费级电子设备的芯片组中出现。</p>
<p>3D LUT 相较于 1D LUT 而言，它支持更加强大的数学转换，但在芯片组里部署起来更复杂且更昂贵。一般 3D LUT 被用于在后期制作过程中施加创造性的“风格”以及色彩空间的转换。</p>
<h4 id="maxcll-metadata-maxcll-元数据">MaxCLL Metadata MaxCLL 元数据</h4>
<p>Maximum Content Light Level（MaxCLL）是一个整数类型的元数据值，用于定义某个编码的 HDR 视频流或者文件中，任意一个像素的最高亮度，单位是 nits。MaxCLL 可以在母版制作过程中或者制作过程后来测量，但是为了保证 HDR 显示器在 MaxCLL HDR 范围里的色彩过渡，并且在显示器的最大亮度外施加一个硬 clip，显示器的 MaxCLL 也可以被用作 MaxCLL 元数据。</p>
<h4 id="maxfall-metadata-maxfall-元数据">MaxFALL Metadata MaxFALL 元数据</h4>
<p>Maximum Frame Average Light Level（MaxFALL）是一个整数类型的元数据值，用于定义某个编码的 HDR 视频流或者文件中，任意一帧画面的最高的平均亮度，单位是 nits。MaxFALL 是通过计算每一帧画面解码后的所有像素的亮度的平均值来获取的。</p>
<h4 id="peak-code-value-峰值编码值">Peak Code Value 峰值编码值</h4>
<p>Peak Code Value 指的是通过某一个系统组件而不产生硬剪（clip）的最大数字编码值。</p>
<h4 id="peak-display-luminance-峰值显示亮度">Peak Display Luminance 峰值显示亮度</h4>
<p>一个显示器所能产生的最高亮度。</p>
<h4 id="perceptual-quantizer-感官量化曲线">Perceptual Quantizer 感官量化曲线</h4>
<p>Perceptual Quantizer 的缩写，它是一个 EOTF。</p>
<p>MovieLabs 提出了一条基于 Barton Curve，并可被用于高动态范围（HDR）的数学曲线，于 2014 年由 SMPTE 制定了 ST2084 标准。</p>
<p>Perceptual Quantization 是一个高效率的编码 HDR 明度信息的方式。在整个动态范围中，每一对相邻的编码值区别都比可感知的区别略小，使得码值利用率极高。</p>
<p>但是，这一 EOTF 并不兼容传统显示器（legacy display），PQ 编码的信号只能在新的、支持 HDR 的设备上被解码。</p>
<p>PQ 为 10bit 或者 12bit 内容所设计，且根据 SMPTE ST2084 标准，不推荐在实时广播时使用它。</p>
<h4 id="quantum-dot-qd-displays-量子点显示器">Quantum Dot（QD）Displays 量子点显示器</h4>
<p>量子点显示器使用了纳米尺度（2nm-10nm）的晶体“点”。每一个点会发出一个不同的纯色，而它们所发出的颜色取决于它的尺寸。</p>
<p>在 LCD 背光前加入一张带有量子点的薄膜（film），图像的色彩还原和总体的亮度可以被显著提高。</p>
<p>这些微小的纳米晶体可以在背光到达红、绿、蓝子像素前改变背光的光谱，实现高达 20-30% 的色域提升，使得显示设备的色彩可以更接近 Rec.2020 目标色域。</p>
<h4 id="st2084">ST2084</h4>
<p>SMPTE 标准中定义的用于制作 HDR 内容母版所用的 EOTF。该 EOTF 又被称为 PQ，主要用于制作非广播内容的母版。</p>
<h4 id="st2086">ST2086</h4>
<p>SMPTE 标准中定义的用于描述制作视频母版所使用的显示器的绝对色彩空间的元数据（基色坐标、白点、亮度范围）。</p>
<h4 id="tone-mapping-tone-mapping-operator-tmo-色调映射-色调映射运算符">Tone Mapping/Tone Mapping Operator（TMO） 色调映射/色调映射运算符</h4>
<p>色调映射是一种用于图像处理和计算机图形的技术，它被用于将一组颜色映射到另一组颜色，从而在具有更有限动态范围的介质中实现逼近高动态范围（HDR）图像的观感。 打印输出，CRT或标准动态范围（SDR）监视器和投影仪都具有较低的动态范围，不足以再现HDR图像中存在的全部光强。色调映射解决了从记录范围到可显示范围的对比度剧烈降低的问题，同时保留了图像细节和色彩表现，这对于欣赏原始场景内容和保留创作意图是重要的。一般使用色调映射运算符（Tone Mapping Operator）执行该色调映射过程，通常为“S”形曲线以实现高光和阴影细节的柔和过渡。参见 Inverse Tone Mapping（ITM）。</p>
<h4 id="wide-color-gamut-wcg-广色域">Wide Color Gamut（WCG） 广色域</h4>
<p>Wide Color Gamut 的缩写，意为广色域。广色域包括了比 Recommendation ITU-R BT.709 更饱和的色彩，比如说被 Rec.2020 所定义的色彩空间就属于广色域。</p>
<h4 id="white-point-白点">White Point 白点</h4>
<p>白点（通常在技术文档中被称为参考白 reference white 或目标白 target white）是一组用于定义图像采集，编码或再现中的“白色”颜色的色度坐标。根据应用，需要不同的“白色”定义以提供可接受的结果。例如，在室内拍摄的照片可能用白炽灯照明，白炽灯比日光相对偏橙。 因此，大多数专业相机拥有在白炽灯照明与日光下拍摄所用的不同设置。同样，为 D65 白点显示器所生产的图像在具有不同白点的显示器上将无法被正确显示。</p>
<p>CIE 定义 D65 常被用来定义视频显示器的白点。</p>
<p>D55 曾是胶片投影的标准白点，DCI 白点（译者注：接近 D63，但更绿）和 D60 白点这两个白点均被数字电影广泛使用。</p>
<blockquote>
<p>更多术语可以参考：<a href="/shares/hdr-field-guide-final-web.pdf"><strong>Quick Reference HDR Glossary</strong></a></p>
</blockquote>
<h2 id="参考资料">参考资料</h2>
<p>1: <a href="https://www.cnet.com/news/hdr-for-cameras-vs-hdr-for-tvs-whats-the-difference/">https://www.cnet.com/news/hdr-for-cameras-vs-hdr-for-tvs-whats-the-difference/</a><br>
2: <a href="https://en.wikipedia.org/wiki/High-dynamic-range_imaging">https://en.wikipedia.org/wiki/High-dynamic-range_imaging</a><br>
3: <a href="https://en.wikipedia.org/wiki/High-dynamic-range_video">https://en.wikipedia.org/wiki/High-dynamic-range_video</a><br>
4: <a href="https://www.zhihu.com/question/19774840/answer/998271233">https://www.zhihu.com/question/19774840/answer/998271233</a><br>
5: <a href="https://alliance.experienceuhd.com/uhd-premium-features">https://alliance.experienceuhd.com/uhd-premium-features</a><br>
6: <a href="https://www.experienceuhd.com/uhd-mobile-hdr-premium-features">https://www.experienceuhd.com/uhd-mobile-hdr-premium-features</a><br>
7: <a href="http://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=AB4FAB66987D97573EA90F4DD56ABA36">http://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=AB4FAB66987D97573EA90F4DD56ABA36</a><br>
8: <a href="http://www.cuva.org.cn/ueditor/php/upload/file/20200904/1599186578364054.pdf">http://www.cuva.org.cn/ueditor/php/upload/file/20200904/1599186578364054.pdf</a><br>
9: <a href="https://zhuanlan.zhihu.com/p/345169019">https://zhuanlan.zhihu.com/p/345169019</a><br>
10: <a href="https://www.videoproc.com/resource/high-dynamic-range.htm">What Is HDR: Concepts, Standards, and Related Aspects</a></p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>HDR</tag>
      </tags>
  </entry>
  <entry>
    <title>FFmpeg解码API以及在解码过程中存在的丢帧问题</title>
    <url>/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/</url>
    <content><![CDATA[<p><img src="/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/1.png" alt></p>
<h2 id="背景">背景</h2>
<p>在优化视频客观全参考算法（主要是<em>PSNR</em>, <em>SSIM</em>, <em>MS-SSIM</em>）时，我们首先利用FFmpeg提供的API（<em><code>avcodec_send_packet()</code></em>，<em><code>avcodec_receive_frame()</code></em>）对输入的两个MP4文件转成对应的YUV格式的数据文件，然后再基于这两份YUV数据文件进行计算，得到对应的结果。</p>
<p>但是，我们发现，MP4文件转成YUV数据后，总是会发生<strong>丢失视频最后几帧</strong>的现象。</p>
<p>为了弄清楚这个问题，查阅了FFmpeg的源码，并参考了网络上的资料，然后总结出了这篇文章。</p>
<span id="more"></span>
<h2 id="ffmpeg的编解码api">FFmpeg的编解码API</h2>
<p>从<a href="https://github.com/FFmpeg/FFmpeg/commit/7fc329e2dd6226dfecaa4a1d7adf353bf2773726">3.1版本</a>开始，FFmpeg提供了<a href="https://github.com/FFmpeg/FFmpeg/blob/release/3.1/libavcodec/avcodec.h">新的编解码API</a>来对音视频数据进行编解码操作，从而实现对输入和输出的解耦：</p>
<ul>
<li>解码API
<ul>
<li>avcodec_send_packet()</li>
<li>avcodec_receive_frame()</li>
</ul>
</li>
<li>编码API
<ul>
<li>avcodec_send_frame()</li>
<li>avcodec_receive_packet()</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @ingroup libavc</span></span><br><span class="line"><span class="comment"> * @defgroup lavc_encdec send/receive encoding and decoding API overview</span></span><br><span class="line"><span class="comment"> * @&#123;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The avcodec_send_packet()/avcodec_receive_frame()/avcodec_send_frame()/</span></span><br><span class="line"><span class="comment"> * avcodec_receive_packet() functions provide an encode/decode API, which</span></span><br><span class="line"><span class="comment"> * decouples input and output.</span></span><br><span class="line"><span class="comment"> * ...</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>同时，也正是从3.1版本开始，之前的编解码API也被标注为<code>deprecated</code>：</p>
<ul>
<li>解码API
<ul>
<li>avcodec_decode_video2()</li>
<li>avcodec_decode_audio4():</li>
</ul>
</li>
<li>编码API
<ul>
<li>avcodec_encode_video2()</li>
<li>avcodec_encode_audio2()</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">attribute_deprecated</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">avcodec_decode_audio4</span><span class="params">(AVCodecContext *avctx, AVFrame *frame,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">int</span> *got_frame_ptr, <span class="keyword">const</span> AVPacket *avpkt)</span></span>;</span><br></pre></td></tr></table></figure>
<p>在我们的工具中，我们采用了新的解码API：<code>avcodec_send_packet()</code>和<code>avcodec_receive_frame()</code>，实现视频帧的解码，并将解码后的数据转成YUV数据。具体的代码片段如下，<a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/test_video_parser_1.cpp">点击可查看完整测试代码</a>。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">process_frame</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//decode operation.</span></span><br><span class="line"><span class="keyword">while</span> (!<span class="built_in">av_read_frame</span>(fmt_ctx, pkt)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pkt-&gt;stream_index != video_stream_idx) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> packet_new = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">process_frame</span>(fmt_ctx, dec_ctx, video_stream-&gt;codecpar, </span><br><span class="line">                         frame, pkt, &amp;packet_new) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">av_packet_unref</span>(pkt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从代码可以看出，<code>i</code>是解码帧的总数，但是我们运行之后发现，一个252帧的视频，最终只得到了248帧。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> g++ --std=c++11 test_video_parser_1.cpp $(pkg-config --cflags --libs libavcodec libavdevice libavformat libavutil)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> frame count: 248</span></span><br></pre></td></tr></table></figure>
<h2 id="send-packet-receive-frame">send_packet &amp; receive_frame</h2>
<p>为了加深对解码API的了解，以便能查出问题原因，我们查阅了<a href="https://github.com/FFmpeg/FFmpeg/blob/master/libavcodec/avcodec.h">FFmpeg的代码</a>，从代码的注释中，我们发现了问题：<strong>我们没有遵循API的使用规范，同时FFmpeg在注释中也说明了为什么会出现我们遇到的问题</strong>。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * ... </span></span><br><span class="line"><span class="comment">  * At the beginning of decoding or encoding, the codec might accept multiple</span></span><br><span class="line"><span class="comment">  * input frames/packets without returning a frame, until its internal buffers</span></span><br><span class="line"><span class="comment">  * are filled. This situation is handled transparently if you follow the steps</span></span><br><span class="line"><span class="comment">  * outlined above.</span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * End of stream situations. These require &quot;flushing&quot; (aka draining) the codec,</span></span><br><span class="line"><span class="comment">  * as the codec might buffer multiple frames or packets internally for</span></span><br><span class="line"><span class="comment">  * performance or out of necessity (consider B-frames).</span></span><br><span class="line"><span class="comment">  * ...</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>
<p>也就是说，为了提升性能或出于其他的考虑，解码器会在内部缓存多个<code>frames</code>/<code>packets</code>。因此，当流结束的时候，需要对解码器执行<code>flushing</code>操作，以便获取解码器缓存的<code>frames</code>/<code>packets</code>。</p>
<p>我们的工具中，在流结束之后，并没有执行<code>flushing</code>操作，因此就出现了解码过程丢帧的现象。按照FFmpeg的指导，我们补充了如下的逻辑，以便获取解码器中缓存的帧，<a href="https://github.com/wangwei1237/wangwei1237.github.io/blob/master/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/test_video_parser_2.cpp">点击可查看完整测试代码</a>。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Flush remaining frames that are cached in the decoder</span></span><br><span class="line"><span class="keyword">int</span> packet_new = <span class="number">1</span>;</span><br><span class="line"><span class="built_in">av_init_packet</span>(pkt);</span><br><span class="line">pkt-&gt;data = <span class="literal">NULL</span>;</span><br><span class="line">pkt-&gt;size = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="built_in">process_frame</span>(fmt_ctx, dec_ctx, video_stream-&gt;codecpar, </span><br><span class="line">                     frame, pkt, &amp;packet_new) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    i++;</span><br><span class="line">    packet_new = <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>再次运行，我们发现，丢帧问题消失了。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> g++ --std=c++11 test_video_parser_1.cpp $(pkg-config --cflags --libs libavcodec libavdevice libavformat libavutil)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> frame count: 252</span></span><br></pre></td></tr></table></figure>
<h2 id="ffmpeg解码api状态机">FFMPeg解码API状态机</h2>
<h3 id="avcodec-send-packet返回值">avcodec_send_packet返回值</h3>
<p>从FFmpeg的源码中，我们会发现，正常情况下，<code>avcodec_send_packet()</code>函数的返回值主要有以下三种：</p>
<ul>
<li><code>0</code>: on success.</li>
<li><code>EAGAIN</code>: input is not accepted in the current state - user must read output with avcodec_receive_frame() (once all output is read, the packet should be resent, and the call will not fail with EAGAIN).</li>
<li><code>EOF</code>: the decoder has been flushed, and no new packets can be sent to it (also returned if more than 1 flush packet is sent).</li>
</ul>
<h3 id="avcodec-receive-frame返回值">avcodec_receive_frame返回值</h3>
<p>同样的，正常情况下，<code>avcodec_receive_frame()</code>函数的返回值主要有以下三种：</p>
<ul>
<li><code>0</code>: success, a frame was returned.</li>
<li><code>EAGAIN</code>: output is not available in this state - user must try to send new input.</li>
<li><code>EOF</code>: the decoder has been fully flushed, and there will be no more output frames.</li>
</ul>
<h3 id="解码api状态机">解码API状态机</h3>
<p><code>avcodec_send_packet()</code>和<code>avcodec_receive_frame()</code>不同的返回值代表了解码器的不同的状态。</p>
<p>对API的调用实际上是一种动作，而API的返回值则用来标志当前解码器的状态。因此，解码API的整个过程实际上就是一个状态机。</p>
<p>根据<a href="#avcodec_send_packet%E8%BF%94%E5%9B%9E%E5%80%BC">avcodec_send_packet返回值</a>和<a href="#avcodec_receive_frame%E8%BF%94%E5%9B%9E%E5%80%BC">avcodec_receive_frame返回值</a>中的介绍，可以得到正常情况下，解码过程的状态机，如下图所示。</p>
<p><img src="/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/2.png" alt></p>
<p>在图中，<code>节点</code>代表状态（API的返回值），<code>箭头</code>代表API的调用。蓝色表示和<code>avcodec_send_packet()</code>相关，红色表示和<code>avcodec_receive_frame()</code>相关。</p>
<p><a href="https://wangwei1237.gitee.io/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/test_video_parser_2.cpp">我们修复版本的解码实现</a>实际上就是对如上图所示的状态机的实现。</p>
<p>而如果在实现的时候，没有处理如下图所示的状态，则会导致无法获取视频最后几帧的问题。</p>
<p><img src="/2021/01/19/FFMpeg-decode-process-and-lose-frame-in-that-process/3.png" alt></p>
<h2 id="思考">思考</h2>
<ul>
<li>源码面前，了无秘密。侯捷老师说过“源码面前，了无秘密”。工作中发现，源码确实是我们获取知识和经验的一个非常有效的途径，尤其是那些好的开源项目的源码，更是如此。</li>
<li>源码还是我们解决问题的强有力的手段之一。对于这些优秀的开源项目的源码而言，代码只是一个部分，源码中的注释、文档等会为我们提供足够的资源。这次问题的解决就是依赖源码，之前在Android摄像头Mock技术的研究中，也是在查阅Android相关源码后才有了思路。因此，当我们在工作中遇到问题的时候，第一手的资料还是源码（当然，要有源码才行），其次才是官方文档，最后才是网络上的其他资源。</li>
<li>看了那么多的源码才发现：优秀的项目是那么的一致，而糟糕的项目，各有各的糟糕之处。</li>
</ul>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
        <tag>视频解码</tag>
        <tag>解码丢帧</tag>
        <tag>avcodec_send_packet</tag>
        <tag>avcodec_receive_frame</tag>
      </tags>
  </entry>
  <entry>
    <title>信任，但也要核查</title>
    <url>/2021/01/11/Trust-but-Verify/</url>
    <content><![CDATA[<p><img src="/2021/01/11/Trust-but-Verify/1.jpg" alt></p>
<blockquote>
<p>1987年，在美苏中程核武器协议谈判时，美国总统里根旁敲侧击，对戈尔巴乔夫说：“我非常喜欢一句俄国谚语——<strong><code>Trust, but verify</code></strong>”。</p>
<p>意思就是，里根相信苏联领导人的承诺，但还必须有个有效的验证机制。</p>
<p><a href="https://en.wikipedia.org/wiki/Trust,_but_verify"><div align="right">关于该谚语的详细信息，可以参考维基百科</div></a></p>
</blockquote>
<span id="more"></span>
<p>随着自己的成长，随着工作内容从完成上级安排的工作到自己开始规划并安排某些工作，随着工作范围从团队内部到跨团队的协作，自己对<code>Trust, but verify</code>这种思想的感触越来越深。</p>
<p>尤其是在做大团队横向工作的规划和推动，以及组建视频小组来探索视频相关的技术，更加深了对<code>Trust, but verify</code>的理解。</p>
<p><code>信任</code>给予我们工作的自由，而<code>核查</code>会给这份自由增加一定的限制。绝对的信任会导致信任的终结，不加限制的信任最终可能会影响团队的可持续发展。信马由缰者，终不能达到目标。</p>
<p><code>核查</code>机制下的<code>信任</code>，才能在给予工作自由的同时，获得个人和公司的利益最大化。</p>
<h2 id="网飞文化中的自由与责任">网飞文化中的自由与责任</h2>
<p>作为一家传奇的公司，成立于1997年的网飞，在成功应对了娱乐领域和商业领域的四次大规模转型之后，其股价已经从1$一路攀升至500$，如今，其市值已经超过了2000亿美元。</p>
<p><img src="/2021/01/11/Trust-but-Verify/3.jpg" alt></p>
<p>根据招聘网站<a href="https://hired.com/">Hired</a>的<a href="https://hired.com/blog/highlights/2020-brand-health-report/">第4次《全球品牌健康报告》</a>，Netflix已经取代Google，成为人们最想去工作的顶级科技公司。</p>
<p><img src="/2021/01/11/Trust-but-Verify/2.png" alt></p>
<p>网飞的成功，离不开其企业文化。在《自由与责任——网飞文化手册》的<em>网飞文化的七个方面</em>中，就提到了<strong>自由与责任</strong>这一文化。在手册中，也提到：自由不是绝对的，和言论自由一样，工作自由也是有限度的。</p>
<div class="douban-card-block">
	<a class="douban-card" href="https://book.douban.com/subject/35102294">
		<div class="douban-card-bgimg" style="background-image: url('https://images.weserv.nl/?url=https://img1.doubanio.com/view/subject/s/public/s33784858.jpg');"></div>
		<div class="douban-card-left">
			<div class="douban-card-img" style="background-image: url('https://images.weserv.nl/?url=https://img1.doubanio.com/view/subject/s/public/s33784858.jpg');"></div>
		</div>
		<div class="douban-card-right" style="line-height: 1.7;">
			<div class="douban-card-item"><span>书名: </span><strong>不拘一格</strong></div>
			<div class="douban-card-item"><span>作者: </span><span>[美]里德·哈斯廷斯</span></div>
			<div class="douban-card-item"><span>出版年份: </span><span>2021-1-1</span></div>
			<div class="douban-card-item"><span>评分: </span><span>8.1</span></div>
		</div>
	</a>
</div>
<style>
	.douban-card-block {
		display: flex;
		justify-content: center;
		align-items: center;
		width: 100%;
		max-height: 400px;
	}
	.douban-card {
		display: flex;
		margin: 30px 10px;
		padding: 15px;
		border-radius: 10px;
		position: relative;
		justify-content: center;
		align-items: center;
		overflow: hidden;
		color: antiquewhite;
		text-decoration: none;
	}
	.douban-card:hover {
		text-decoration: none;
	}
	.douban-card-bgimg {
		position: absolute;
		width: 115%;
		height: 115%;
		filter: blur(15px) brightness(0.6);
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
		background-size: 100%;
		background-position: center;
		background-repeat: no-repeat;
	}
	.douban-card-img {
		position: relative;
		height: 130px;
		width: 80px;
	}
	.douban-card-left {
		position: relative;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	.douban-card-right {
		position: relative;
		display: flex;
		flex-direction: column;
		margin-left: 12px;
		font-size: 16px;
		font-family: 'Courier New', Courier, monospace;
		line-height: 1.3;
		color: antiquewhite;
	}
	.douban-card-item {
		margin-top: 4px;
	}
</style>
<p>在网飞创始人里德·哈斯廷斯的《不拘一格——网飞的自由与责任工作法》一书的第三章中，也列举了2个例子来介绍其自由与责任的文化：</p>
<ul>
<li>取消限期休假制度</li>
<li>取消差旅和经费审批</li>
</ul>
<p>网飞没有对关于花销、娱乐、馈赠、出差、以及休假给出具体的规则和制度，而是给予员工极大的自由来自主安排，但是这种自由的前提是：公司利益至上。</p>
<p>而公司利益至上，则意味着：</p>
<ul>
<li>花该花的钱，否则就别花，而且这些钱应该是为了工作而花</li>
<li>透漏重要供应商馈赠的礼物</li>
<li>利用公司的资源，必须是为了提高工作效率，且必须合理</li>
<li>……</li>
</ul>
<p>同时，对于公司给予员工的这份自由，网飞还有一套时候核实的制度来确保，员工的自由满足了公司利益至上的原则。这种制度在网飞内部称为：<strong>事情情景设定，时候核实报销</strong>。</p>
<h2 id="自由与责任-信任与核查">自由与责任&amp;信任与核查</h2>
<p>当最开始没有流程和制度的时候，我们可以根据遇到的具体的问题制定相关的流程和制度，这个时候，流程和制度会是有效的。但问题是，随着时间的不断发展，随着问题的不断增加，起初的那个流程制度就被补充的会越来越多。这个时候，每个人都需要对流程和制度进行学习，然后按照这个复杂的制度来行事，在互联网公司中，这简直是一件不可想象的事情。如果员工在遇到问题的时候，还需要通过查阅流程制度文档来指引自己的行动，那文化的意义也就荡然无存了。</p>
<p>我总是遇到很多的流程制度，比如申请某个一般的权限需要总监来审批，在某个时间点上线需要总监审批确认，……这些制度真的能解决问题吗？无非是用这些门槛来限制某些事情的发生而已。但是，当紧急事情真的出现的时候，这些制度反而成为了阻碍效率最大的问题。这些往往被称作为“大公司”通病。根本原因就是随着公司的发展，工作的核心动力不再是初心，不再是思考“这是否对公司是有利的”，而是复杂的制度和流程。</p>
<p>在《不拘一格》中也提到：</p>
<blockquote>
<p>随着一个快速灵活的初创企业发展为成熟的企业，公司往往会建立一套完整的体系对员工的支出进行监管。</p>
<p>这让管理有了一种控制感，但往往也会拖慢公司业务的进程。</p>
<p>而网飞的<strong>事情情景设定，时候核实报销</strong>制度在保证员工不会虚假报销的情况下，给予员工极大的自由，来使的他们可以再关键时刻作出有利于公司的决断。</p>
</blockquote>
<p>实际上，<strong>事前情景设定，事后核实报销</strong>正是一种Trust, but verify制度。</p>
<p>我们要相信员工能秉承公司利益至上的原则，但是我们也需要对其行为进行核查。单纯的相信是不行的。</p>
<p>在《不拘一格》中提到：</p>
<blockquote>
<p>据一项研究显示：被调查者一旦确认自己的行为不会为人所知，远超半数的人会利用漏洞，为自己谋取更多利益。</p>
</blockquote>
<p>所以，作为项目的负责人或者管理者，需要做好核查的工作：</p>
<ul>
<li>确保员工形成公司利益至上的理念</li>
<li>确保员工是在按照预期完成工作</li>
<li>确保及时发现问题，并给予及时的鼓励、指导、资源支持</li>
<li>确保形成即重视结果，也重视过程的文化，只有过程，没有结果，是不行的，只有结果，没有过程，同样也是不行的</li>
</ul>
<p><img src="/2021/01/11/Trust-but-Verify/4.jpg" alt></p>
]]></content>
      <categories>
        <category>文化</category>
      </categories>
      <tags>
        <tag>不拘一格</tag>
        <tag>自由与责任</tag>
      </tags>
  </entry>
  <entry>
    <title>一场关于FLV是否要支持HEVC的争论</title>
    <url>/2020/10/29/a-debate-about-supporting-HEVC-over-FLV/</url>
    <content><![CDATA[<blockquote>
<p>前几天，在浏览FFmpeg的Trac时，发现了一个希望<a href="https://trac.ffmpeg.org/ticket/6389"><strong>FFmpeg增加<em>让FLV支持HEVC编码</em></strong></a>的需求。</p>
<p>这个需求是2017年提交到FFmpeg社区的，从整个交流过程可以看出，需求提出者和FFmpeg的社区维护者对这个需求的分歧较大，从中也能看出一些工作思路和工作文化上的差异。看完整个讨论过程，感触还是比较深的，所以想写一篇文章来记录一下自己的感触。</p>
</blockquote>
<p><img src="/2020/10/29/a-debate-about-supporting-HEVC-over-FLV/1.png" alt></p>
<span id="more"></span>
<h2 id="整个需求讨论的大概过程">整个需求讨论的大概过程</h2>
<ul>
<li><strong>提议发起</strong>：目前HLS和TS都已经支持H265了，但是国内大部分CDN更多采用的是RTMP/HTTP-FLV格式。并且，因为HLS的延迟比较高，因此国内大部分直播业务采用的都是RTMP/HTTP-FLV格式。所以，该ISSUE的发起者就想问一下FFmpeg社区是否有计划让FLV支持HEVC。</li>
<li><strong>FFmpeg社区回复</strong>：不得不说，社区的回复还是很快的。在需求提出20分钟后，有人回复了。大概意思就是：并不是不能让FLV支持HEVC，只是因为Adobe没有对FLV支持HEVC做出具体说明。因此，如果Adobe不扩展标准，FFmpeg是不会让FLV支持HEVC的。同时，社区还提出了一些备选的解决方法。</li>
<li><strong>针对延迟的争论</strong>：接下来就是双方针对直播流延迟的争论了。一方认为可以对HLS或MPEG-DASH做一些优化来降低延迟，一方认为HLS不可能达到1-3秒的延迟，基本上接下来的讨论就是在讨论延迟了。因为RTMP/HTTP-FLV的低延迟已经国内CDN厂商的完美支持，因此，还是希望FFmpeg能让FLV支持HEVC。并且，有好多评论也在支持这个需求。确实，在2017年，尤其是在国内，对于直播业务而言，能让FLV支持H265真的是一件非常值得激动的事。</li>
<li><strong>社区强烈反对</strong>：在众多支持该需求的评论之后，FFmpeg直接关闭了这个提议，并且将该提议置为了<code>invalid</code>状态。
<ul>
<li>这些是马甲账号的灌水评论，这些评论对于FFmpeg是否实现该提议没有任何作用。</li>
<li>只要Adobe不升级FLV的标准，FFmpeg就不会让FLV支持HEVC。</li>
<li>不管怎么样，FFmpeg都不会支持这种定制的需求。</li>
</ul>
</li>
</ul>
<p>因此，一直到现在，3年过去了，FFmpeg也没有实现在FLV中支持HEVC的特性。因此，直到如今，在直播业务中，也都无法使用社区版本的FFmpeg实现：在FLV格式中传输H265的直播流。</p>
<p>所幸的<a href="https://github.com/ksvc/FFmpeg/tree/release/3.4"><strong>金山云实现了FFmpeg的<em>hack</em>版本</strong></a>，从而让RTMP/HTTP-FLV协议支持了HEVC编码。因此，即使标准的解码器（播放器）无法播放金山云的<em>hack</em>版本生成的RTMP/HTTP-FLV的H265直播流，但是，金山云实现的这个私有的协议也基本上成为了国内直播相关业务的标准协议了。</p>
<h2 id="协议-标准先行-还是实现先行？">协议/标准先行，还是实现先行？</h2>
<blockquote>
<p>11:6 耶和华说，看哪，他们成为一样的人民，都是一样的言语，如今既作起这事来，以后他们所要作的事就没有不成就的了。</p>
<p>11:7 我们下去，在那里变乱他们的口音，使他们的言语彼此不通。</p>
<p>11:8 于是，耶和华使他们从那里分散在全地上。他们就停工，不造那城了。</p>
<p>11:9 因为耶和华在那里变乱天下人的言语，使众人分散在全地上，所以那城名叫巴别（就是变乱的意思）。</p>
<div align="right">——《圣经·创世纪》</div>
</blockquote>
<p>如今，生产社会化程度越来越高，技术要求越来越复杂，生产协作越来越广泛。许多技术和产品，往往涉及几十个、几百个甚至上万个企业，这客观上要求：必须在技术上使生产活动保持高度的统一和协调。此时，必须通过制定和执行技术标准使各生产部门和企业内部各生产环节有机地联系起来，保证生产有条不紊地进行。没有标准、协议，就无法有效的实现社会化大生产。</p>
<p>纵观整个计算机行业，无论哪个领域，无论是网络通信还是编解码协议，都是协议先行。私有协议的推广，也是先从标准化开始，然后才推动具体实现。否则，行业内就无法达成共识，否则，整个网络的互联、互通也就无从谈起。因此，必须是标准、协议先行。</p>
<p>另一个方面，标准、协议是具体实现的抽象，没有接口的定义，哪里来的接口的实现呢？当然，也可以从具体的实现中抽取接口，但是我们必须意识到，在接口抽取之前，这个实现相当于是私有的。</p>
<p>因此，FFmpeg社区拒绝让FLV自持HEVC是合理的。否则，我们的工作就会充斥着各种FFmpeg的<em>hack</em>版本，并且每个<em>hack</em>版本都是用来解决不同的问题。这真是一件非常恐怖的事情。</p>
<p>兵马未动，粮草先行。如果真的想让事情变的更便捷，最好的方式就是优先推动标准或协议的升级。</p>
<p>我见到过很多次较为严重的线上问题，其根本原因就是上下游之间没有一个定义良好的协议，导致升级过程出现了<a href="/monolith-to-microservices/docs/Breaking_Changes.html">破坏性修改</a>，进而导致问题的发生。</p>
<h2 id="组织文化优先还是用户需求优先？">组织文化优先还是用户需求优先？</h2>
<p>不同的社区有不同的文化。组织的文化会使得当出现问题的时候，组织内所有成员对该问题的应激反应都是一致的，这种应激反应是无需请求上级就可以作出的。从<a href="https://trac.ffmpeg.org/ticket/6389">提议</a>中可以看出，FFmpeg社区的文化之一是：编解码器要针对标准和规范来实施。</p>
<p>如果阅读FFmpeg的源码，其实也能发现很多如下的代码：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">    <span class="comment">// 7.4.3.1: vps_max_layers_minus1 is in [0, 62].</span></span><br><span class="line">    HEVC_MAX_LAYERS     = <span class="number">63</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.1: vps_max_sub_layers_minus1 is in [0, 6].</span></span><br><span class="line">    HEVC_MAX_SUB_LAYERS = <span class="number">7</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.1: vps_num_layer_sets_minus1 is in [0, 1023].</span></span><br><span class="line">    HEVC_MAX_LAYER_SETS = <span class="number">1024</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7.4.2.1: vps_video_parameter_set_id is u(4).</span></span><br><span class="line">    HEVC_MAX_VPS_COUNT = <span class="number">16</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.2.1: sps_seq_parameter_set_id is in [0, 15].</span></span><br><span class="line">    HEVC_MAX_SPS_COUNT = <span class="number">16</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.3.1: pps_pic_parameter_set_id is in [0, 63].</span></span><br><span class="line">    HEVC_MAX_PPS_COUNT = <span class="number">64</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A.4.2: MaxDpbSize is bounded above by 16.</span></span><br><span class="line">    HEVC_MAX_DPB_SIZE = <span class="number">16</span>,</span><br><span class="line">    <span class="comment">// 7.4.3.1: vps_max_dec_pic_buffering_minus1[i] is in [0, MaxDpbSize - 1].</span></span><br><span class="line">    HEVC_MAX_REFS     = HEVC_MAX_DPB_SIZE,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>因此，社区不同的人对该提议的意见都是一致的。即便这个用户需求再合理，即便这个需求有多少用户支持，只要是标准不更新，FFmpeg永远都不会支持。</p>
<p>另外，用户只是需要一种能够支持H265编码的、CDN又支持良好的、延迟又非常低的视频流媒体格式而已，不是吗？如果真的有这种格式，让FLV支持HEVC是否就不是一个问题了呢？既然，Adobe已经停止了对RTMP的维护了，那么为什么还要花时间在这个协议上呢？为什么不选择更新的技术呢？虽然选择新的技术意味着需要冒更大的风险和花费更多的成本。</p>
<p>尤其是当不同的用户需求之间存在冲突，如何处理？To be or not to be,that’s a question!</p>
<h2 id="对于技术-是向前看还是回头看？">对于技术，是向前看还是回头看？</h2>
<p>“始生之物，其形必丑”。但是，新技术必然会取代旧技术，从根本上说是因为：</p>
<ul>
<li>新技术具有新的结构和功能，能适应已经变化了的环境和条件</li>
<li>新技术是对旧技术的扬弃，并添加了旧技术所不能容纳的新内容</li>
</ul>
<p>因此，对于技术而言，我们需要向前看，需要去了解这些新技术。当然，采用新技术肯定是要付出一定代价的，没有不付出就会有的收获。需要深入研究新技术和我们业务之间的差距，然后在业务的实践中不断完善新的技术。</p>
<p>另外，在了解新技术时，还要了解新技术的历史，了解在新技术是基于什么历史背景而产出的，是用于解决什么问题的？这些东西，是新技术的应用根本，只有深入了解了这些，才能在后续的应用中，得心应手。错误的应用新技术产生的问题比正确的使用旧技术要大的多。</p>
<p>例如在HTTP2的协议中，有这样的描述：</p>
<blockquote>
<p>HTTP/2 addresses these issues by defining an optimized mapping of HTTP’s semantics to an underlying connection. Specifically, it allows interleaving of request and response messages on the same connection and uses an efficient coding for HTTP header fields. It also allows prioritization of requests, letting more important requests complete more quickly, further improving performance.</p>
</blockquote>
<p>在HTTP3中，有如下的描述：</p>
<blockquote>
<p>HTTP/2 introduced a binary framing and multiplexing layer to improve latency without modifying the transport layer. However, because the parallel nature of HTTP/2’s multiplexing is not visible to TCP’s loss recovery mechanisms, a lost or reordered packet causes all active transactions to experience a stall regardless of whether that transaction was impacted by the lost packet.</p>
<p>The QUIC transport protocol incorporates stream multiplexing and per-stream flow control, similar to that provided by the HTTP/2 framing layer. By providing reliability at the stream level and congestion control across the entire connection, it has the capability to improve the performance of HTTP compared to a TCP mapping.</p>
</blockquote>
<p><img src="/2020/10/29/a-debate-about-supporting-HEVC-over-FLV/2.jpg" alt></p>
<p>就像上图的“乌鸦喝水”一样，是采用吸管呢？还是对原有的石头进行各种改进呢？</p>
<p>后来，在网上找到了又拍云的一篇<a href="https://www.cnblogs.com/upyun/p/7053150.html">《如何将HLS延时缩短至4秒，HLS+技术详解》</a>的一篇文章。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>直播</tag>
        <tag>hevc</tag>
        <tag>flv</tag>
      </tags>
  </entry>
  <entry>
    <title>高并发下的“读后写”模式存在的问题</title>
    <url>/2020/09/07/keep-the-architecture-from-write-after-read/</url>
    <content><![CDATA[<p>我们的服务有一个功能，该功能会限制同时使用的用户数，例如使用该功能的用户不能超过100个。就好像购买车票一样，可以购买到车票的人数不能超过该车次的对应区间的车票总数。然后，在并发测试中，我们发现，实际可以使用该功能的用户数达到了200。追查之后，我们发现，这是一个典型的“读后写“的模式带来并发问题。</p>
<p><img src="/2020/09/07/keep-the-architecture-from-write-after-read/1.png" alt></p>
<span id="more"></span>
<h2 id="什么是-读后写-模式">什么是“读后写”模式</h2>
<p><code>读后写</code>是在并发场景下，针对同一数据记录的<strong>先读后写</strong>操作，并且数据写入的值依赖于数据读取的值。具体如下图所示：</p>
<p><img src="/2020/09/07/keep-the-architecture-from-write-after-read/2.png" alt></p>
<p>从定义中可以看出，只有在3个条件都具备的前提下，才会考虑<code>读后写</code>模式带来的问题：</p>
<ul>
<li>并发场景</li>
<li>同一数据</li>
<li>对数据的修改依赖于对数据的读取</li>
</ul>
<h2 id="显示的-读后写-模式的问题">显示的“读后写”模式的问题</h2>
<p>对于<code>redis</code>而言，典型的<code>读后写</code>逻辑如<strong><a href="http://test.sh">test.sh</a></strong>所示：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">x=$(redis-cli -h 127.0.0.1 -p 8079 GET x)</span><br><span class="line">x=$(expr $&#123;x&#125; + 1)</span><br><span class="line">redis-cli -h 127.0.0.1 -p 8079 SET x $&#123;x&#125;</span><br></pre></td></tr></table></figure>
<p>设置<code>x=0</code>在非并发场景下，多次运行<strong><a href="http://test.sh">test.sh</a></strong>后不会存在问题：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"><span class="keyword">for</span> ((i=0; i&lt;100; i++)); <span class="keyword">do</span> sh test.sh; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -h 127.0.0.1 -p 8079 GET x</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="string">&quot;100&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>但是，对于如下的代码，我们则会发现，对<code>KEY x</code>的更新并没有按照预期的逻辑来更新：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> ((i=0; i&lt;100; i++)); <span class="keyword">do</span> sh test.sh &gt;/dev/null 2&gt;&amp;1 &amp;; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -h 127.0.0.1 -p 8079 GET x</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="string">&quot;3&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>我称这种场景下导致的问题为：显示的“读后写”模式带来的问题。因为此时，并发是显而易见的，并且操作的是单一的redis实例。</p>
<h2 id="隐式的-读后写-模式的问题">隐式的“读后写”模式的问题</h2>
<p>在实际的服务中，为了提升服务的性能，往往会采用<code>读写分离</code>的架构来设计数据存储，例如MySQL的主从架构，Redis的主从架构。在<code>读写分离</code>架构下，<code>写操作</code>一般均在<strong>主</strong>服务器上执行，而<code>读操作</code>则在<strong>从</strong>服务器上执行，而主从之间则通过某种方式来通信。具体如下所示：</p>
<p><img src="/2020/09/07/keep-the-architecture-from-write-after-read/3.png" alt></p>
<p>这种场景下，比较重要的问题就是“主从延迟”的问题。当“主从延迟”的时间，超过了请求间隔的时间时，虽然看起来并没有什么并发的场景，但是实际上也是一种“隐式的并发”。</p>
<p>举个极端的例子——现实场景中可能不会有这么大的主从延迟——主从延迟的时间为5s，而当前服务的负载为2s一个请求。此时，虽然看起来没有什么“并发”的场景，但是实际上，当第2个请求到来时，由于主从延迟的存在，到时此时该请求获取的数据仍然为旧的数据，进而导致更新逻辑的异常。</p>
<p>因为，这种场景下的并发实际上被“主从”架构隐藏了起来，因此，我称这种场景下导致的问题为：隐式的“读后写”模式的问题。</p>
<p>很多时候，这两种模式会同时发生。在文章开始介绍的问题，就是这两种场景共同作用而产生的“读后写”的问题。</p>
<h2 id="如何避免-读后写-带来的问题">如何避免“读后写”带来的问题</h2>
<p>解决该问题的具体方法需要视具体的应用场景。不要期待那种“放之四海而皆准”的解决方案，而要根据自己所面临的具体场景来选择最合适的解决方案。尽管如此，我们在解决该问题时，可以有一个总的指导原则：将“读后写”模式改为“事务写后写”模式。</p>
<p>“写操作”都在“主”服务器上执行，因此，改为“写后写”模式首先避免了“主从”架构的问题。然后，在“写后写”的基础上，再使用“事务性的写操作”，就可以基本解决“读后写”的问题。</p>
<p>例如，将<code>test.sh</code>稍作修改：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">redis-cli -h 127.0.0.1 -p 8079 incr x</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> ((i=0; i&lt;100; i++)); <span class="keyword">do</span> sh test.sh &gt;/dev/null 2&gt;&amp;1 &amp;; <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -h 127.0.0.1 -p 8079 GET x</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="string">&quot;100&quot;</span></span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>架构</category>
      </categories>
      <tags>
        <tag>数据一致性</tag>
        <tag>redis原子操作</tag>
      </tags>
  </entry>
  <entry>
    <title>从单体架构迁移到微服务架构</title>
    <url>/2020/08/19/monolith-to-microservices/</url>
    <content><![CDATA[<p><img src="/2020/08/19/monolith-to-microservices/cover.png" alt></p>
<span id="more"></span>
<p>恰好今年在了解微服务相关的技术，又恰好在浏览nginx官网的时候发现了这本书，当时读完第一章的第一节就感觉这是一本我会认真阅读的技术书籍。</p>
<p>后来，随着阅读的深入，发现我自己工作中遇到的很多的问题恰巧就是书里写的那样，与其对每一个点单独写成一篇文章或博客，还不如就以批注的形式呈现出来，这样也能更系统。</p>
<p>基于如上的想法，在阅读本书的过程中，对整个书籍内容进行了中文版的翻译，并在正文中以批注的形式写入的自己的思考，经历。</p>
<p>这本书是我读过的相对上乘的一本书，在亚马逊上的评价非常好，不但讲了微服务的迁移技术，更多讲了很多作者的思考和很多为什么的问题。正如一位读者的评论：这本书没有宣传什么技术，没有兜售什么技术，而更多的是让我们学会如何思考？我们是否真的需要使用微服务？使用过程要注意什么？……</p>
<p>翻译的版本可以点击：<a href="/monolith-to-microservices"><strong>monolith to microservices中文版</strong></a>，此版本仅供学习交流使用。如有疑问，评论区留言交流。</p>
<p>因为官方版的翻译版本至今还没有，因此，推荐大家购买英文原版，<a href="https://www.amazon.com/Monolith-Microservices-Evolutionary-Patterns-Transform/dp/1492047848"><strong>购买链接</strong></a>。</p>
]]></content>
      <categories>
        <category>架构</category>
      </categories>
      <tags>
        <tag>荐书</tag>
        <tag>微服务</tag>
        <tag>单体</tag>
      </tags>
  </entry>
  <entry>
    <title>kill -9导致subprocess.run启动的子进程无法退出</title>
    <url>/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/</url>
    <content><![CDATA[<h2 id="背景">背景</h2>
<p>我们有一个任务托管平台，该平台可以托管<code>python</code>语言编写任务，并且可以对任务状态进行管理。由于业务的需要，我们需要在<code>python</code>的任务中调起一个<code>shell</code>脚本来完成一些额外的事情。当我们把编写好的任务部署到任务托管平台之后，我们发现一个奇怪的现象：当在任务的超时时间内手动结束任务的时候，只有<code>python</code>的父进程退出了，而<code>python</code>启动的<code>shell</code>子进程却没有退出。</p>
<span id="more"></span>
<h2 id="subprocess模块">subprocess模块</h2>
<p>我们使用subprocess.run()来创建新的shell进程，具体如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">subprocess.run(</span><br><span class="line">    cmd,</span><br><span class="line">    cwd=cwd,</span><br><span class="line">    shell=<span class="literal">True</span>,</span><br><span class="line">    stdout=subprocess.PIPE,</span><br><span class="line">    stderr=subprocess.PIPE,</span><br><span class="line">    encoding=<span class="string">&quot;utf-8&quot;</span>,</span><br><span class="line">    timeout=<span class="number">600</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>为了方便测试，分别写了一段<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/timeout.py"><code>python</code>代码</a>和<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/timeout.sh"><code>shell</code>代码</a>，可以点击链接查看具体代码。其中，<code>shell</code>脚本为一个死循环，具体如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for((i=0;;i++))</span><br><span class="line">do</span><br><span class="line">    echo &quot;$i&quot; &gt;log 2&gt;&amp;1</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>然后，我们在本地使用<code>kill -2（ctrl+c）</code>结束父进程的时候，子进程也确实结束了。具体如下图所示：</p>
<p><img src="/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/sigint.png" alt></p>
<p>我们继续查出问题的原因，我们咨询了任务托管平台的负责人：任务托管平台页面上的<code>结束任务</code>是怎么实现的？</p>
<p>平台的负责人回应说：<code>kill -9</code>命令结束的。</p>
<p>在这时候，我知道，我可能大概知道问题的原因了。</p>
<h2 id="kill和signal">kill和signal</h2>
<p>关于<code>kill</code>命令，此处不做详细介绍，具体可以参考<a href="https://man7.org/linux/man-pages/man1/kill.1.html">kill(1)手册</a>。<code>kill</code>的作用是向某个特殊的进程或进程组发送一个特殊的信号，从而达到结束进程的目的。关于<code>信号(signal)</code>，此处也不做详细介绍，具体可以参考<a href="https://man7.org/linux/man-pages/man7/signal.7.html">signal(7)手册</a>。</p>
<p>而<code>kill -9</code>命令实际上是向进程发送了<code>SIGKILL</code>信号，而在<a href="https://man7.org/linux/man-pages/man7/signal.7.html">signal(7)手册</a>中可以看到：<strong>The signals SIGKILL and SIGSTOP cannot be caught, blocked, or ignored.</strong> 因此，<code>kill -9</code>是一种不可捕获的、不可忽略的信号，用来在特殊情况下紧急结束进程（如果该信号可以捕获和忽略的话，就达不到这个目的了）。</p>
<p>而对于一个单进程的程序而言，直接<code>kill -9</code>结束并没有什么问题，但是对于一个多进程的程序，例如本文中的例子，在<code>python</code>进程中又创建了<code>shell</code>子进程，那么直接用<code>kill -9</code>粗暴的结束父进程是非常不安全的，具体如下图所示：</p>
<p><img src="/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/sig9.jpg" alt></p>
<p>可见，在<code>kill -9</code>结束父进程之后，<code>shell</code>编写的子进程成为了<a href="https://www.geeksforgeeks.org/zombie-and-orphan-processes-in-c/">孤儿进程</a>，并继续执行。</p>
<p>这也就是，我们在任务托管平台上结束任务后，子进程并没有退出的根本原因。父进程结束的信号根本就没有机会通知到子进程，子进程也就不可能结束了。</p>
<p>那么，我们换另外一个可以被捕获和忽略的信号，例如<code>SIGTERM</code>是否能结束子进程呢？</p>
<p><img src="/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/sigterm.jpg" alt></p>
<p>从图中可以看出，<code>SIGTERM</code>信号也没有结束子进程。</p>
<h2 id="subprocess-run-所捕获的异常">subprocess.run()所捕获的异常</h2>
<p>我们从<a href="https://github.com/python/cpython/blob/3.8/Lib/subprocess.py">subprocess模块的源码</a>中可以发现，<code>subprocess.run()</code>实际上只捕获自定义的<code>TimeoutExpired</code>异常和<code>KeyboardInterrupt</code>异常，而在<code>python</code>中，<code>KeyboardInterrupt</code>异常对应的就是<strong>用户中断执行</strong>，一般就是输入<code>ctl+c</code>或发送<code>SIGINT</code>信号。具体如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> Popen(*popenargs, **kwargs) <span class="keyword">as</span> process:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        stdout, stderr = process.communicate(<span class="built_in">input</span>, timeout=timeout)</span><br><span class="line">    <span class="keyword">except</span> TimeoutExpired <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line">    <span class="keyword">except</span>:  <span class="comment"># Including KeyboardInterrupt, communicate handled that.</span></span><br><span class="line">        process.kill()</span><br><span class="line">        <span class="comment"># We don&#x27;t call process.wait() as .__exit__ does that for us.</span></span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>
<p>可见，对于<code>SIGINT</code>信号而言，<code>subprocess.run()</code>函数会调用<code>Popen.kill()</code>来结束子进程。</p>
<p>因此，对于多进程而言，当父进结束之前，需要通过某种机制来通知其子进程，进而让子进程知晓父进程的退出信息，并作出合理的后续行为。否则，就会出现本文中出现的孤儿进程的现象。</p>
<p>因此，对于其他的信号，<code>subprocess</code>模块本身就无法处理了。</p>
<h2 id="捕获sigterm信号">捕获SIGTERM信号</h2>
<p>如果要捕获<code>SIGTERM</code>信号，使得<code>kill -15</code>结束python任务的时候，同时也能结束子进程，那么就要耍点小聪明了，例如：在<code>python</code>中捕获其他信号，并将其转成<code>SIGINT</code>信号，具体可以参见<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/timeout_1.py">timeout_1.py</a>。具体执行效果如下所示：</p>
<p><img src="/2020/08/07/cannot-terminate-the-subprocess-run-child-process-caused-by-kill-9/popen.jpg" alt></p>
<p>此处，我用了一个偷懒的方法，也就是把<code>SIGTERM</code>信号捕获之后转成<code>SIGINT</code>信号，具体的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def sigintHandler(signum, frame):</span><br><span class="line">    raise KeyboardInterrupt</span><br><span class="line"></span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">def run_cmd(cmd, cwd):</span><br><span class="line">    signal.signal(signal.SIGTERM, sigintHandler)</span><br><span class="line">    # ...</span><br></pre></td></tr></table></figure>
<h2 id="结语">结语</h2>
<p>查完这个问题，也算是对进程相关的内容有了更深入的了解。孤儿进程，僵尸进程，不可屏蔽进程……，好像经过很多时间之后，忽然都不记得自己曾经也钻研过这些概念一样。感谢我的同事<em>一卓</em>(<a href="https://github.com/GerenLiu">@GerenLiu</a>)，在工作之余抽时间来一起讨论这个问题。</p>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>subprocess</tag>
        <tag>kill命令</tag>
        <tag>多线程</tag>
      </tags>
  </entry>
  <entry>
    <title>自动化测试首先是一种工作文化</title>
    <url>/2020/07/08/autotest-is-a-working-culture-first/</url>
    <content><![CDATA[<blockquote>
<p>自古以来，人类就有创造自动装置以减轻或代替人劳动的想法。自动化技术的产生和发展经历了漫长的历史过程。古代中国的铜壶滴漏（简称漏壶）、指南车以及17世纪欧洲出现的钟表和风磨控制装置，虽然都是毫无联系的发明，但对自动化技术的形成却起到了先导作用。</p>
</blockquote>
<h2 id="自动化测试之痛">自动化测试之痛</h2>
<p>最近在帮助一个团队梳理团队测试效率的问题，其目标是提升该团队的测试效率。在整个梳理的过程中，我发现一件非常有意思的事情：这个团队基本上没有自动化测试，大部分的测试手段还是手工测试加CR。更为有意思的事情是：团队成员大都对自动化测试比较抵触，认为自动化测试的成本较大，且看不到收益。</p>
<p>回想过去几年的测试工作，我发现，几乎所有的测试团队在面对自动化测试时都会存在类似的问题：<strong>希望自动化测试提升效率，但是执行时却发现自动化测试反而没有提升效率，因此慢慢废弃自动化测试，直至抵触自动化测试，到最后自动化测试变成一种“形而上”般的存在</strong>。我姑且称这种现象为——<strong>自动化测试之痛</strong>。</p>
<span id="more"></span>
<p>自动化测试之痛的问题根源究竟是什么呢？事情真的如有些团队所说：自动化case的成本太大，又没有收益吗？</p>
<h2 id="侠客岛的故事">侠客岛的故事</h2>
<blockquote>
<p>自从三十年前开始，每过十年，就会有大批的武林高手被请去侠客岛喝腊八粥，不但这些武林高手从此都一去不复返，而且侠客岛还演变成为了赏善罚恶的行动。</p>
<p>为此，江湖中人人自危，每到十年之期，各大门派的掌门就纷纷寻找替身，来躲避侠客岛的赏善罚恶。但是，当这些武林高手到了侠客岛之后才终于揭开了侠客岛的秘密。</p>
<p>原来岛上刻有武林秘籍，由于岛主人参不透秘籍，所以才会请武林高手到岛上共同参悟。并且由于岛上的‘断肠蚀骨腐心草’十年一开花，此草若再配以其他佐使之药，熬成热粥，服后于练武之士大有补益，因此才有了每十年邀请一次的惯例。被邀上岛的人也并不是遇害，而是痴迷于武学，都不想回去罢了。</p>
<p><strong><div align="right">——《侠客行》</div></strong></p>
</blockquote>
<p>有多少时候，我们对自动化测试的认识和江湖人士对侠客岛的认识是类似的呢？<br>
有多少时候，明明是侠客岛盛情所邀，江湖之上却人人躲而避之呢？<br>
有多少时候，明明是对自己大有补益的腊八粥，所有被邀的武林人士却不敢喝下呢？</p>
<p>或许你会反驳，但凡有上岛的武林人士扩散一下事实真相，那整个江湖也不至于如此？<br>
但是，正如本文开篇所述，整个人类社会都是证明自动化的历史，为什么还有那么多的团队在质疑自动化测试呢？<br>
为什么有那么多的测试实践已经证明了自动化测试的成效——例如谷歌的<a href="https://mike-bland.com/2012/07/10/test-mercenaries.html"><strong>Test Mercenaries</strong></a>计划，还是有那么多的团队对自动化测试心存质疑呢？</p>
<p>正如Sam NewMan在<a href="https://samnewman.io/books/monolith-to-microservices/"><strong>Monolith To Microservices</strong></a>一书中说的那样：<a href="https://wangwei1237.gitee.io/monolith-to-microservices/docs/The_Monolith.html#ref_denigrating_monolith">一旦我们陷入系统性抹黑单体的陷阱，我们就会面临很大的麻烦</a>。</p>
<h2 id="自动化测试的定位">自动化测试的定位</h2>
<p>接下来，我从3个方面来阐述自动化测试的定位。</p>
<h3 id="测试的4大活动">测试的4大活动</h3>
<p>根据乔梁老师的<a href="https://item.jd.com/12512514.html">《持续集成2.0》</a>一书中所述，测试领域有4大基本活动，如<a href="#f1">图1</a>所示。</p>
<p><span id="f1"><img src="/2020/07/08/autotest-is-a-working-culture-first/f1.png" alt></span></p>
<p>图1. 测试的4大基本活动</p>
<p>其中，各活动的基本含义如下：</p>
<ul>
<li><strong>问题认知</strong>：对业务问题本身的理解和认知，包括需求理解，技术设计理解……</li>
<li><strong>分析</strong>：测试分析和测试设计，根据对问题的认知，设计测试方案和用例，保证业务质量</li>
<li><strong>执行</strong>：执行分析阶段的测试用例，产出测试结论</li>
<li><strong>决策</strong>：根据测试结论进行相关决策，包括是否存在风险，是否达到上线标准……</li>
</ul>
<h3 id="敏捷测试4象限">敏捷测试4象限</h3>
<p>根据测试所支持的对象，测试可以分为：<a href="https://www.tutorialspoint.com/agile_testing/agile_testing_quadrants.htm">面向业务的测试和面向研发的测试</a>。<a href="http://www.exampler.com/old-blog/2003/08/22/#agile-testing-project-2">Brian Marick</a>根据这两种测试类型提出了<strong>敏捷测试4象限</strong>的概念，如<a href="#f2">图2</a>所示。</p>
<p><span id="f2"><img src="/2020/07/08/autotest-is-a-working-culture-first/f2.png" alt></span></p>
<p>图2. 敏捷测试4象限</p>
<p>在<a href="#f2">图2</a>中：</p>
<ul>
<li><strong>功能验收测试</strong>：从用户的角度来验收功能</li>
<li><strong>第三象限的自动化测试</strong>：研发团队对自我软件技术实现的验证</li>
</ul>
<h3 id="自动化测试的4要素">自动化测试的4要素</h3>
<p>在测试的4大活动中，“执行”环节会存在大量的重复工作，而其中的大部分工作都可以由机器来承担。此时就可以发挥自动化测试的优势，释放人的重复劳动。</p>
<p>而在Brian Marick的敏捷测试4象限中，第2、第3象限的测试类型也可以发挥自动化测试的优势，提升整个测试执行的效率。</p>
<p>对于自动化测试而言，我总结了自动化测试的4要素：自动部署、自动执行、自动校验、自动报告，如<a href="#f3">图3</a>所示。</p>
<p><span id="f3"><img src="/2020/07/08/autotest-is-a-working-culture-first/f3.gif" alt></span></p>
<p>图3. 自动化测试的4要素</p>
<h2 id="自动化测试的误区">自动化测试的误区</h2>
<p>接下来，着重来说一下我所见到、听到的一些关于自动化测试的误区。</p>
<h3 id="误区1：只看短期效率收益">误区1：只看短期效率收益</h3>
<p>有的团队希望自动化case来提升测试效率，当然，这是自动化case可以获取的收益之一。这些团队还会针对自动化对效率的提升制定定量的指标，然后每周，每月，每季度（当然，有些人还没有坚持到季度末就不做了）来跟进。</p>
<p>但是，正如Sam Newman在<a href="https://wangwei1237.gitee.io/monolith-to-microservices/docs/How_Will_You_Know_if_the_Transition_Is_Working.html#%E5%AE%9A%E9%87%8F%E6%8C%87%E6%A0%87"><em>Monolith To Microservices</em></a>一书中所说：</p>
<blockquote>
<p>有的指标可能很难在短时间内有量的变化。</p>
<p>如果在微服务迁移的前几个月就看到cycle time的大幅改善，我会感到惊讶。</p>
<p>实际上，我更希望看到cycle time会在迁移的初期变得更糟。</p>
<p>因为团队需要不断适应新的工作方式，因此短期内对工作方式的变革通常会对生产效率产生负面影响。</p>
</blockquote>
<p>自动化测试也是一个很难在很短的时间内就能看到收益的工具，并且还需要付出一些成本：需要学习自动化测试的配套工具，编写自动化case的框架，调度自动化执行的相关工具……</p>
<p>因此，最开始的一段时间内，自动化测试有可能会降低测试效率。但是，一旦掌握这些技巧，我们就会发现汽车确实比马车跑的快，难道不是吗？</p>
<p>短期收益不明显还有另外一个因素：短期内适合自动化测试的项目分布并不均匀。如<a href="#f3">图3</a>所示，自动化测试在<a href="#%E6%B5%8B%E8%AF%95%E7%9A%844%E5%A4%A7%E6%B4%BB%E5%8A%A8">测试4大活动</a>中的执行阶段以及<a href="#%E6%95%8F%E6%8D%B7%E6%B5%8B%E8%AF%954%E8%B1%A1%E9%99%90">敏捷测试4象限</a>中的第2、第3象限才能发挥其作用。但是对于周、月维度的项目而言，能有多少项目会让自动化测试有用武之地呢？接下来发生的事情就是对自动化测试的定量指标而言，没有数据上的变化，然后坏的事情就会发生了，团队慢慢就失去了耐心……</p>
<h3 id="误区2：只看个人效率收益">误区2：只看个人效率收益</h3>
<p>在进行自动化测试之前，大多数团队都会选择一些业务来试点，然后根据试点业务的反馈来确定是否要大范围推广。</p>
<p>但是，在实际试点的时候，会出现很多影响因素：例如测试人员前期没有接入测试了解，测试人员没有提前和研发人员确定接口定义，测试人员前期在跟进其他项目……</p>
<p>如上的因素会导致当一个测试项目到来时，测试人员没有足够的时间来消化那些需要在前期所付出的学习成本。在面对一个个紧急的项目和需要付出一定的成本时，这些试点的测试人员会自然而然的继续使用旧有的手工测试的方式来保证项目的快速跟进。</p>
<p>试点项目的测试人员会从自身的利益出发来选择测试方案。然后这些试点的测试人员就会汇报说：自动化测试太浪费时间了，没法提高效率。如果管理者不仔细继续和这些一线的同学深入探讨，那么最终就会根据试点同学的结论得出一个偏离事实的结论：自动化测试确实无法提升效率。</p>
<p>然而，上述的一些试点人员遇到的问题从本质上讲，并不是自动化测试本身的问题，这里涉及到更多的流程、沟通、协作的问题。不是自动化测试不能提升效率，而是当前的环境不允许自动化测试发挥作用。</p>
<p>泥泞的道路上，是马车快呢还是跑车快呢？</p>
<p>在所有人只从自身利益来考虑问题，而忽略其所处的环境时，就会出现这种：马车比跑车快的滑稽结论。</p>
<h3 id="误区3：成本核算标准不一致">误区3：成本核算标准不一致</h3>
<p>如前所述，自动化测试是需要学习成本的，不经历风雨怎么见彩虹？自动化测试和手工测试的ROI权衡如<a href="#f4">图4</a>所示。</p>
<p><span id="f4"><img src="/2020/07/08/autotest-is-a-working-culture-first/f4.png" alt></span></p>
<p>但是在我的观察中，我发现大多数团队在核算手工测试和自动化测试的成本时采用的标准并不一致。他们会忽略：手工测试重复测试的成本，会忽略手工测试重复书写测试报告的成本……但是他们会给自动化测试追加上：上下游环境依赖成本，环境部署成本，接口定义不完备的成本，自动化用例的维护成本太大了……</p>
<p>点一下最简单，成本最低，点点吧。</p>
<p>当夜深人静的时候，你再细想这些话术、你细想……就会发现这些成本和自动化测试什么关系，手工测试不也需要这些成本吗？要是一个项目要测多轮，难不成每次都点点？OH，当然不是了，下一次只点那些上一次失败的用例就好了……OMG……</p>
<p>手工用例就不需要维护成本？不过从我的观察发现，确实不需要。因为有些团队压根就不写手工用例，当然就谈不上成本了。还有的团队即便有手工用例也从来不会维护，下一个同学测试类似的项目的时候，参考一下之前的用例，然后自己重新写用例。</p>
<h3 id="误区4：不关注团队收益">误区4：不关注团队收益</h3>
<p>在误区2中，试点项目的测试人员只根据自己的个人收益来做测试方案的选择。但是团队中的个人是相互联系的，团队内部的项目也会是连续的，而不是离散的。</p>
<p>某个人测试的某个项目，下一次可能就换其他人来测试了。某个短期来看不会变化的项目，可能数月之后就会修改了。项目每次都修改一点点，可能半年之后就会有上百个修改点了……</p>
<p>如果站在团队的角度考虑，我们团队内每个人编写的自动化用例有时候虽然对个人而言ROI很低，但是对团队的ROI却可能非常大。</p>
<p>如果每一个变更很小的项目都不编写自动化用例，那么当项目做大的时候怎么办？<br>
如果每个项目都是上线后就不修改了，那当这个项目的代码要下线的时候怎么办？</p>
<p>当然，这些对于个人而言是无需关注的事情，因为谁知道接下来的测试还是不是你负责？但是，最终却还是这个团队来负责的，不是吗？当所有这些都没有仔细执行的时候，在遇到大的项目，在遇到团队技术重构的项目时，对于团队而言，一个怪异的现象就发生了：大多数团队都在试图寻找另外的测试方法来弥补自动化用例缺失的遗憾，比如引流测试diff测试等等。</p>
<h3 id="误区5：自动化用例是万年不变的">误区5：自动化用例是万年不变的</h3>
<p>因为自动化用例需要随着业务代码的迭代而迭代，而很多团队又认为这样的成本太大了。因此自动化用例就成了一堆万年不变的功能的测试用例，最终自动化就成了“形而上”般的存在。</p>
<p>业务代码都在不断变化，不断升级，不断迭代，凭什么自动化的用例就得万年不变，自动化的用例就不用维护？实在是想不通这里面的道理。</p>
<p>自动化用例的落后，会导致自动化用例无法成为业务代码的试刀石，当他变成一件附属品时，他所带来的一切就只有成本了。</p>
<h3 id="误区6：项目迭代太快了-等稳定了再用自动化测试">误区6：项目迭代太快了，等稳定了再用自动化测试</h3>
<p>这一点是我听到过的所有的谬误中最没有道理的一个了。</p>
<p>从<a href="#f4">图4</a>中可以看出，越是大的项目，越是迭代次数多的项目，越是变化快的项目，自动化测试的收益越大。大多数团队，此时想到的更多的是快速的变化带来的是更多的自动化用例的维护成本。</p>
<p>但是，即便是创业公司，谁也不会在项目启动的时候就朝着把项目做烂的目标行进吧？</p>
<p>等项目稳定的时候，估计就是这个产品要下线的时候了。</p>
<h2 id="自动化测试是一种文化">自动化测试是一种文化</h2>
<p>在考虑自动化测试的时候，需要认真的思考自动化测试的定位和目标，需要认识到自动化测试需要付出一定的成本，自动化测试还需要修改既有的研发流程，需要认识到团队的累计收益……</p>
<p>在考虑自动化测试的时候，还需要意识到，自动化测试一种项目文档化的手段，正所谓“测试即文档”，自动化测试还是团队内部不同测试人员有效沟通的一种手段，自动化测试更是团队积累的一种有效载体……</p>
<p>自我看来，自动化测试首先应该是一种工作文化，而不单纯是一种测试手段。工作文化意味着当出现问题的时候，我们的反应是我们没会使用这个工具，或者我们的使用方法不对，而不是说这个工具是有问题的。</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>方法论</tag>
        <tag>测试</tag>
        <tag>自动化测试</tag>
        <tag>auto test</tag>
        <tag>敏捷</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Boost::Python用C++开发Python库</title>
    <url>/2020/06/13/write-python-library-using-c-with-boost-python/</url>
    <content><![CDATA[<h2 id="背景">背景</h2>
<p>很多系统都会用<code>json</code>格式进行数据交互。为了保证数据在系统上下游的自动校验，避免数据结构异常带来的系统稳定性问题，可以采用<a href="http://json-schema.org"><code>json-schema</code></a>来定义<code>json接口</code>，并利用<a href="https://datatracker.ietf.org/doc/draft-handrews-json-schema-validation"><code>json-schema-validator</code></a>来校验接口响应的结构的合法性。</p>
<p>然而系统中不同子系统的实现（编程语言）并非总是一致，虽然各种语言都提供了<a href="https://datatracker.ietf.org/doc/draft-handrews-json-schema-validation"><code>json-schema-validator</code></a>的具体实现，但是不同语言支持的<code>json-schema-validator</code>标准的版本并非完全一致，这会对后续的使用带来一些混乱，例如：</p>
<ul>
<li>Java: <a href="https://github.com/java-json-tools/json-schema-validator">json-schema-validator</a>支持<a href="https://tools.ietf.org/html/draft-fge-json-schema-validation-00">Draft 4</a></li>
<li>C++: <a href="https://github.com/pboettch/json-schema-validator">json-schema-validator</a>支持<a href="https://tools.ietf.org/html/draft-handrews-json-schema-validation-01">Draft 7</a></li>
<li>Python <a href="https://github.com/Julian/jsonschema">jsonschema</a>支持<a href="https://tools.ietf.org/html/draft-handrews-json-schema-validation-01">Draft 7</a></li>
</ul>
<span id="more"></span>
<p>目前大多数语言，例如：Java, Golang, Php, Python, Lua等都支持C/C<ins>的扩展。因此，可以用C/C</ins>来为其他语言提供统一的扩展库支持，本文就是介绍怎么利用<code>Boost::Python</code>库提供<a href="https://github.com/pboettch/json-schema-validator"><code>json-schema-validator</code></a>的Python支持，并介绍如何利用<code>distutils</code>来编译&amp;分发Python库。</p>
<p><img src="/2020/06/13/write-python-library-using-c-with-boost-python/1.png" alt></p>
<h2 id="python调用c-c-的方式">Python调用C/C++的方式</h2>
<p>有两种方式可以实现Python调用C/C++编写的库：</p>
<ul>
<li>使用Python扩展</li>
<li>使用<code>ctypes</code>模块直接加载C/C++编写的so</li>
</ul>
<h4 id="ctypes加载so文件">ctypes加载so文件</h4>
<p><code>ctype</code>是Python的外部函数库。它提供了C兼容的数据类型，并允许在DLL或共享库中调用函数。</p>
<p><code>ctype</code>是Python封装的API函数库。其中<code>cdll = &lt;ctypes.LibraryLoader object&gt;</code>是一个库加载器对象，调用<code>cdll.LoadLibrary</code>便可调用C/C++的so库。</p>
<p>此处不再对如何使用<code>ctype</code>模块加载so文件做过多的介绍，具体可以参考其<a href="https://docs.python.org/3/library/ctypes.html#module-ctypes">官方文档</a>。</p>
<h4 id="使用python扩展">使用Python扩展</h4>
<p>该方式是Python为整合其它语言而提供的一种扩展机制，并且该机制不局限于C/C++，也可以用于其它语言。Python的可扩展性具有如下的优点：</p>
<ul>
<li>方便为语言增加新功能</li>
<li>具有可定制性</li>
<li>可以实现代码复用</li>
<li>……</li>
</ul>
<p>该方式的具体使用此处也不再做过多介绍，具体信息可以直接参考Python的官方文档<a href="https://docs.python.org/3/extending/building.html"><strong>Building C and C++ Extensions</strong></a>来了解。接下来要讲的例子就是利用了<code>可以实现代码复用</code>的优点。</p>
<p>如<a href="https://docs.python.org/3/extending/building.html"><strong>Building C and C++ Extensions</strong></a>所示，Python提供了<code>Python/C++ API</code>用来实现Python和C<ins>的交互。然而，直接使用这些API来完成Python和C/C</ins>的交互还是会存在很多重复工作的。<code>Boost::Python</code>则对<code>Python/C++ API</code>进行了抽象和包装，从而使得Python和C++的交互更加方便。</p>
<h2 id="boost-python封装c-c-扩展">Boost::Python封装C/C++扩展</h2>
<p>接下来我们介绍我们是如何利用Boost::Python来为<a href="https://github.com/pboettch/json-schema-validator">nlohmann_json_schema_validator</a>增加Python扩展。</p>
<p><code>nlohmann_json_schema_validator</code> is a C++ library for validating JSON documents based on a <strong>JSON Schema</strong> which itself should validate with <strong>draft-7 of JSON Schema Validation</strong>.</p>
<h4 id="编译nlohmann-json-schema-validator库">编译nlohmann json schema validator库</h4>
<p><code>nlohmann json schema validator</code>支持产出可执行的bin文件以及可供其他项目使用的动态库。为了可以将该扩展包装成Python扩展，我们需要生成该库的动态库。</p>
<p>首先根据<code>nlohmann json schema validator</code>的<a href="https://github.com/pboettch/json-schema-validator/blob/master/README.md#building-as-shared-library">编译文档</a>编译出<code>nlohmann json schema validator</code>的动态库。</p>
<p><img src="/2020/06/13/write-python-library-using-c-with-boost-python/2.jpg" alt></p>
<h4 id="boost-python封装c-c-代码">Boost::Python封装C/C++代码</h4>
<p>在安装Boost的时候，虽然Boost的头文件中存在Boost::Python相关的hpp文件，但是默认却没有该动态库。因此，在使用Boost::Python之前，首先需要安装该库。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ brew install boost-python3</span><br></pre></td></tr></table></figure>
<p>然后，我们用C++编写<code>class json_validator_python;</code>来封装<code>nlohmann json schema validator</code>库，并利用Boost::Python来导出，具体如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// jsv_python.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;nlohmann/json-schema.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/python.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> boost::python;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSON_SCHEMA_VALIDATOR_API</span> <span class="title">json_validator_python</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    nlohmann::json_schema::json_validator validator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">json_validator_python</span>() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set_root_schema</span><span class="params">(<span class="keyword">const</span> std::string &amp;json_string)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        validator.<span class="built_in">set_root_schema</span>(nlohmann::json::<span class="built_in">parse</span>(json_string.<span class="built_in">begin</span>(), json_string.<span class="built_in">end</span>()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">validate</span><span class="params">(<span class="keyword">const</span> std::string &amp;json_string)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        validator.<span class="built_in">validate</span>(nlohmann::json::<span class="built_in">parse</span>(json_string.<span class="built_in">begin</span>(), json_string.<span class="built_in">end</span>()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// json_schema_validator为module名，必需和生成的so库名一样</span></span><br><span class="line"><span class="built_in">BOOST_PYTHON_MODULE</span>(json_schema_validator)</span><br><span class="line">&#123;</span><br><span class="line">    class_&lt;json_validator_python, boost::noncopyable&gt; (<span class="string">&quot;json_validator_python&quot;</span>)</span><br><span class="line">            .<span class="built_in">def</span>(<span class="string">&quot;set_root_schema&quot;</span>, &amp;json_validator_python::set_root_schema)</span><br><span class="line">            .<span class="built_in">def</span>(<span class="string">&quot;validate&quot;</span>, &amp;json_validator_python::validate)</span><br><span class="line">            ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上所示的<code>BOOST_PYTHON_MODULE</code>代码，目的是导出类及成员方法，这些导出的类和方法可以在Python中调用。</p>
<p>关于Boost::Python更详细的使用，可以参考其<a href="https://www.boost.org/doc/libs/1_66_0/libs/python/doc/html/index.html">官方文档</a>。</p>
<h4 id="编译并产出python扩展">编译并产出Python扩展</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">g++ --std&#x3D;c++11 -fPIC -c jsv_python.cpp \</span><br><span class="line">-I$&#123;json-schema-validator_PATH&#125;&#x2F;src \</span><br><span class="line">-I$&#123;nlohmann-json_PATH&#125; \</span><br><span class="line">-I$&#123;Boost_PATH&#125;&#x2F;include \</span><br><span class="line">-I$&#123;Python_INCLUDE_PATH&#125;</span><br><span class="line"></span><br><span class="line">g++ --std&#x3D;c++11 -shared \</span><br><span class="line">-L$&#123;json-schema-validator_LIB_PATH&#125; \</span><br><span class="line">-L$&#123;Python_LIB_PATH&#125; \</span><br><span class="line">-L$&#123;Boost_Python_LIB_PATH&#125; \</span><br><span class="line">-lnlohmann_json_schema_validator \</span><br><span class="line">-lboost_python38 -lpython3.8 \</span><br><span class="line">-o json_schema_validator.so jsv_python.o</span><br></pre></td></tr></table></figure>
<p>如上的指令，会生成封装之后的Python扩展：<code>json_schema_validator.so</code>。</p>
<h4 id="测试python扩展">测试python扩展</h4>
<p>在当前目录执行如下的Python代码，可以发现，我们封装的扩展已经可以当做Python扩展来导入并使用了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json_schema_validator <span class="keyword">as</span> jsv</span><br><span class="line"></span><br><span class="line">validator = jsv.json_validator_python()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">isValidator = <span class="literal">True</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    validator.set_root_schema(<span class="string">&#x27;&#123;&quot;type&quot;:&quot;object&quot;, &quot;properties&quot;: &#123;&quot;a&quot;:&#123;&quot;type&quot;: &quot;string&quot;&#125;&#125;&#125;&#x27;</span>)</span><br><span class="line">    validator.validate(<span class="string">&#x27;&#123;&quot;a&quot;:&quot;1&quot;&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    isValidator = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(isValidator)</span><br></pre></td></tr></table></figure>
<h2 id="使用distutils编译并分发扩展">使用distutils编译并分发扩展</h2>
<p>为了使用方便，使用<a href="https://docs.python.org/3/extending/building.html"><strong>Building C and C++ Extensions</strong></a>介绍的<code>distutils模块</code>编译Python扩展。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> distutils.core <span class="keyword">import</span> setup, Extension</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.environ[<span class="string">&quot;CC&quot;</span>] = <span class="string">&quot;g++&quot;</span></span><br><span class="line">os.environ[<span class="string">&quot;CXX&quot;</span>] = <span class="string">&quot;g++&quot;</span></span><br><span class="line"></span><br><span class="line">module1 = Extension(<span class="string">&#x27;json_schema_validator&#x27;</span>,</span><br><span class="line">                    include_dirs = [<span class="string">&#x27;../../src&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;../../&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;/usr/local/Cellar/boost/1.72.0_3/include&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;/usr/local/opt/python@3.8/Frameworks/Python.framework/Versions/3.8/include/python3.8&#x27;</span>],</span><br><span class="line">                    libraries = [<span class="string">&#x27;boost_python38&#x27;</span>, <span class="string">&#x27;python3.8&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;nlohmann_json_schema_validator&#x27;</span>],</span><br><span class="line">                    library_dirs = [<span class="string">&#x27;/usr/local/opt/python@3.8/Frameworks/Python.framework/Versions/3.8/lib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;/usr/local/Cellar/boost-python3/1.72.0_1/lib&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;.&#x27;</span>],</span><br><span class="line">                    sources = [<span class="string">&#x27;jsv_python.cpp&#x27;</span>],</span><br><span class="line">                    extra_compile_args=[<span class="string">&#x27;--std=c++11&#x27;</span>],</span><br><span class="line">                    extra_link_args=[<span class="string">&#x27;--std=c++11&#x27;</span>])</span><br><span class="line"></span><br><span class="line">setup (name = <span class="string">&#x27;json-schema-validator&#x27;</span>,</span><br><span class="line">       version = <span class="string">&#x27;1.0&#x27;</span>,</span><br><span class="line">       description = <span class="string">&#x27;json schema validator&#x27;</span>,</span><br><span class="line">       ext_modules = [module1])</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3 setup.py build</span><br><span class="line">$ python3 setup.py install</span><br><span class="line">$ export LD_LIBRARY_PATH&#x3D;$LD_LIBRARY_PATH:&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;json_schema_validator</span><br></pre></td></tr></table></figure>
<p>然后就可以在任意位置，执行<a href="#%E6%B5%8B%E8%AF%95python%E6%89%A9%E5%B1%95">测试python扩展</a>一节的测试代码啦。</p>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>Boost::Python</tag>
        <tag>setup.py</tag>
        <tag>distutils</tag>
      </tags>
  </entry>
  <entry>
    <title>集群时间戳不一致导致的问题及其分析和思考</title>
    <url>/2020/05/29/problem-caused-by-timestamp-s-difference-in-cluster-and-analysis/</url>
    <content><![CDATA[<blockquote>
<p>1883年11月18日，美国第一个全国统一铁路时刻表诞生，这一天的正午时分，美国东部的时钟全部回拨。从此，上帝的时间被改用人间的指针来度量。 ——<strong>公司的力量</strong></p>
</blockquote>
<h2 id="背景">背景</h2>
<p>最近遇到的业务上的问题涉及：<em>在一个集群中，存在部分机器的<code>时间戳</code>和其它机器不一致而导致的重大问题</em>。为了不泄露业务的相关信息，文中会用一个类似的场景来对这个问题进行分析。</p>
<span id="more"></span>
<h2 id="时间戳-unix-time-stamp">时间戳（unix time stamp）</h2>
<p>需要注意的是，这里涉及到的问题是集群<code>时间戳</code>不一致而不是<code>时间</code>不一致。</p>
<p><a href="https://www.unixtimestamp.com">The unix time stamp</a> is a way to track time as a running total of seconds. This count starts at the Unix Epoch on January 1st, 1970 at UTC. Therefore, the unix time stamp is merely the number of seconds between a particular date and the Unix Epoch. It should also be pointed out (thanks to the comments from visitors to this site) that <strong><code>this point in time technically does not change no matter where you are located on the globe</code></strong>. This is very useful to computer systems for tracking and sorting dated information in dynamic and distributed applications both online and client side.</p>
<p>由此可知，<code>时间戳</code>和<code>时间</code>不同，是一个和时区无关的全球一致的时间计量方式。不同集群会因为其所在的时区不同而存在时间不同的问题，但是其时间戳是一致的。</p>
<p>Linux系统而言，时间戳可以利用<a href="https://www.gnu.org/software/shellutils/shellutils.html"><code>GNU shell utilities</code></a>提供的<a href="https://github.com/coreutils/coreutils/blob/master/src/date.c"><code>date</code>命令</a>来获取。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ date +%s</span><br><span class="line">$ 1590719825</span><br></pre></td></tr></table></figure>
<h2 id="时间戳不一致带来的问题">时间戳不一致带来的问题</h2>
<p>考虑如下的一个购物站点的活动场景，如下的场景可能不会在现实的电商活动中存在，该场景仅仅是为了说明本文的问题而抽象的一个场景。</p>
<blockquote>
<p>原价100￥的商品，现价10￥元销售，但前提是下单的用户需要在1分钟内完成支付。如果下单用户未能在1分钟内完成支付，则该订单无效，同时该用户无法继续以折扣价下单。</p>
</blockquote>
<p>为了方便问题说明，下单和支付等功能合并在<code>trade</code>，产生的相关数据则存储于<code>DB</code>。简化之后的架构如下所示：</p>
<p><img src="/2020/05/29/problem-caused-by-timestamp-s-difference-in-cluster-and-analysis/1.png" alt></p>
<p>当<code>trade</code>为单机部署时，不会存在问题。但是当<code>trade</code>作为集群部署时，则会存在集群时间戳不一致导致用户支付失败的问题。具体如下所示：</p>
<p><img src="/2020/05/29/problem-caused-by-timestamp-s-difference-in-cluster-and-analysis/2.png" alt></p>
<p>如图所示，<code>m1</code>和<code>m2</code>的时间戳是一致的，但是<code>m3</code>的时间戳比其它机器正好快了<strong>60s</strong>。因此，如果<code>支付</code>的流量由<code>m3</code>机器的<code>trade</code>处理，则即便是在1分钟内支付，因为<code>m3</code>机器的时间戳快60s而导致支付超时，进而导致用户支付失败，影响用户体验。</p>
<p>这就是我们要讲的：在一个集群中，部分机器的<code>时间戳</code>和其它机器不一致而导致的重大问题。</p>
<h2 id="问题如何解决">问题如何解决</h2>
<p>在不修改系统架构的前提下，则可以利用同一时钟同步集群中所有机器的时钟，从而让集群的时钟保持同步，进而解决该问题。具体的方案如下图所示。</p>
<p><img src="/2020/05/29/problem-caused-by-timestamp-s-difference-in-cluster-and-analysis/3.png" alt></p>
<h3 id="ntp">ntp</h3>
<p>对Linux而言，可以使用<a href="https://en.wikipedia.org/wiki/Network_Time_Protocol"><code>ntp</code></a>来实现集群的时间同步。</p>
<p>同步时间，可以使用<code>ntpdate</code>命令，也可以使用<code>ntpd</code>服务。</p>
<h3 id="ntpdate">ntpdate</h3>
<p>使用<code>ntpdate</code>比较简单。格式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ntpdate [-nv] [NTP IP&#x2F;hostname]</span><br><span class="line">$ ntpdate 192.168.0.1</span><br><span class="line">$ ntpdate time.ntp.org</span><br></pre></td></tr></table></figure>
<p><code>ntpdate</code>只是强制将系统时间设置为ntp服务器时间。如果机器cpu tick有问题，这种同步治标不治本。此时，一般配合<code>cron</code>任务来定期同步。例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0 12 * * * * &#x2F;usr&#x2F;sbin&#x2F;ntpdate 192.168.0.1</span><br></pre></td></tr></table></figure>
<h3 id="ntpd">ntpd</h3>
<p>使用<code>ntpd</code>服务，要好于使用<code>ntpdate+cron</code>。</p>
<p><code>ntpdate</code>同步时间，会造成时间的跳跃，对一些依赖时间的程序和服务会造成影响，比如sleep，timer等。</p>
<p><code>ntpd</code>服务可以在修正时间的同时，修正cpu tick。</p>
<p>理想的做法为，在开机的时候，使用<code>ntpdate</code>强制同步时间，在其他时候使用<code>ntpd</code>服务来同步时间。</p>
<p>需要注意的是，<code>ntpd</code>有一个自我保护设置: 如果本机时间与源时间相差太大, 则<code>ntpd</code>不运行。所以新设置的时间服务器一定要先利用<code>ntpdate</code>命令获取初始时间, 然后启动<code>ntpd</code>服务。</p>
<p>关于ntpd的使用，网上已经有很多资料了，这里就不做过多的介绍了。</p>
<h3 id="ntpstat">ntpstat</h3>
<p><code>ntpstat</code>用于显示网络时间的同步状态。<code>ntpstat</code>会给出本地计算机上运行的<code>ntpd</code>的同步状态。如果本地系统与参考时间源同步，则<code>ntpstat</code>会给出近似的时间精度。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ntpstat</span><br><span class="line">synchronised to NTP server (192.168.0.1) at stratum 3</span><br><span class="line">   time correct to within 43 ms</span><br><span class="line">   polling server every 1024 s</span><br></pre></td></tr></table></figure>
<h2 id="问题引申">问题引申</h2>
<p>虽然可以利用<code>ntp</code>来同步集群时间，但是有一个问题是值的思考的：<strong>如何在集群时钟不同的情况下，解决<a href="#%E6%97%B6%E9%97%B4%E6%88%B3%E4%B8%8D%E4%B8%80%E8%87%B4%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98">时间戳不一致带来的问题</a>一节中描述的问题</strong>。</p>
<p>系统在架构上要做何种优化，才能避免业务对集群时钟同步的依赖？而这种优化所带来的系统架构的复杂度和成本又将如何？</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>ntp</tag>
        <tag>时间戳不同步</tag>
      </tags>
  </entry>
  <entry>
    <title>软件的熵和破窗原理</title>
    <url>/2020/05/20/Software-Entropy-and-A-Broken-Window/</url>
    <content><![CDATA[<blockquote>
<p><strong>如下的内容，摘选自《程序员修炼之道——通向务实的最高境界（第二版）》。</strong></p>
</blockquote>
<p>虽然软件开发不受绝大多数物理法则的约束，但我们无法躲避来自“熵”的增加的重击。“熵”是一个物理学术语，它定义了一个系统的“无序”总量。不幸的是，热力学法则决定了宇宙中的熵会趋向最大化。当软件中的无序化增加时，程序员会说“软件在腐烂”。有些人可能会用更乐观的术语来称呼它，即“技术债”，潜台词是说他们总有一天会偿还的——恐怕不会还了。</p>
<p><img src="/2020/05/20/Software-Entropy-and-A-Broken-Window/1.png" alt></p>
<span id="more"></span>
<p>不过不管叫什么名字，债务和腐烂都可能失控地蔓延开。</p>
<p>有很多因素会导致软件腐烂。最重要的一个似乎是项目工作中的心理性状态，或者说文化。即使是一个单人团队，你的项目的心理性状态也是个非常脆弱的东西。即使有最合理的计划和最佳的人员，项目还是可能在生命周期中逐步荒废、腐烂。但也有一些项目在经历了巨大的困难、持续不断的挫折之后，成功地对抗了天然的无序化倾向，走出了困境。</p>
<p>是什么造成了差异？</p>
<p>在城市中心，有些建筑干净漂亮，而另一些则破落不堪。为什么会这样？一些犯罪和城市衰败领域的研究人员发现了一个有趣的触发机制，只需一样东西就能非常迅速地把一幢干净完好的宜居建筑变成一个破败的废弃物。</p>
<h2 id="破窗原理">破窗原理</h2>
<p>一扇破损的窗户，只要一段时间不去修理，建筑中的居民就会潜移默化地产生一种被遗弃的感觉——当权者不关心这幢建筑的感觉。然后，其他的窗户也开始损坏，居民开始乱丢废物，墙上开始出现涂鸦，建筑开始出现严重的结构性损坏。在看上去很短的时间内，建筑的损坏程度就足以打消业主们想修好它的期望，被遗弃的感觉终变成了现实。</p>
<p><img src="/2020/05/20/Software-Entropy-and-A-Broken-Window/2.jpeg" alt></p>
<p>为何造成这样的影响？</p>
<p><strong>心理学家的研究表明，绝望是会传染的，就像狭窄空间中的流感病毒。无视一个明显损坏的东西，会强化这样一种观念：看来没有什么是能修好的，也没人在乎，一切都命中注定了。所有的负面情绪会在团队成员间蔓延，变成恶性循环。</strong></p>
<h2 id="不要放任破窗">不要放任破窗</h2>
<p><strong>不要搁置“破窗”(糟糕的设计、错误的决定、低劣的代码）不去修理。</strong></p>
<p>每发现一个就赶紧修一个。如果没有足够的时间完全修好，那么就把它钉起来。也许你可以注释掉那些糟糕的代码，显示一行“尚未实现”的信息，或用假数据先替代一下。采取行动，预防进一步的损害发生，表明一切尽在你的掌握中。</p>
<p>现在我们了解了一旦窗户开始破裂，运转良好的干净系统会迅速恶化。还有一些其他因素会导致软件腐烂，我们将在别处探讨，但与其他任何因素相比，漠视会加速腐烂的过程。</p>
<p>你或许会觉得，没人有时间来来回回清理项目中所有的碎玻璃。如果你真这么想，劝你还是趁早多想想怎么料理这个项目的后事，或是直接离开是非之地。</p>
<p>不要让熵赢得胜利。</p>
<h2 id="先勿伤害">先勿伤害</h2>
<p>多年以前，Andy认识一个土豪。他的房子富丽堂皇，屋子里摆满了无价的古董，到处陈列着精美的艺术品。有一天，一张挂毯因为离客厅壁炉太近而着火了。消防员奋勇冲进去救民于水火，当然主要是火。但是在把巨大的水管拖进屋子前，他们停了下来——尽管里面火势紧急——消防员毅然选择先在前门和火源之间铺上垫子，因为他们觉得水管太脏。</p>
<p>他们不想弄坏地毯。</p>
<p>现在听起来这很偏激。消防部门的首要任务当然是灭火，何必管过程中的那些附带损害呢？但是，他们在清醒地评估了形势后，出于对自己控制这场火势能力的绝对自信，还是尽力兼顾了不对财物造成不必要的毁害。</p>
<p>这也是软件开发中应该遵循的方法：<strong>不要只是因为一些东西非常危急，就去造成附带损害。破窗一扇都嫌太多</strong>。</p>
<p><img src="/2020/05/20/Software-Entropy-and-A-Broken-Window/3.jpg" alt></p>
<p><strong>一扇破窗——一段设计情糕的代码，一个让团队在整个项目周期内都必须要遵守的糟糕的管理决策——是一切衰退的开始。</strong></p>
<p>如果你发现自己正处在有几扇破窗的项目中，就非常容易陷入这样的想法——“反正代码所有其他部分都是一坨屎，我只是随大流而已。”</p>
<p>项目在这个时间点之前是否一直良好运行并不重要。在最初启发“破窗理论”的实验中，一辆废弃的汽车完好无损地停放了一个星期。但是一旦有一块玻璃被打破，这辆车在几个小时内就会被扒光并翻了个底朝天。</p>
<p><strong>出于同样原因，如果身处一个健康团队，你们项目的代码如此完美——编写清晰、设计优良、简洁优雅——你就会倾向于格外地小心，不把它弄糟。</strong> 就像那些消防员一样，即使屋内火势熊熊（截止时限、发行日期、销售演示，等等），你也不想成为第一个弄乱它、造成附带损害的人。反之，这个项目就会从某一扇破窗（糟糕的设计，混乱的代码……）开始衰退，腐烂……</p>
<p>一定要告诉自己，“不要打破窗户”。</p>
]]></content>
      <categories>
        <category>软件理论</category>
      </categories>
      <tags>
        <tag>技术债</tag>
        <tag>荐书</tag>
      </tags>
  </entry>
  <entry>
    <title>matplotlib的backends以及非交互式绘图</title>
    <url>/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/</url>
    <content><![CDATA[<p>在分析视频的psnr时，需要用到<code>matplotlib</code>来绘制视频每一帧的psnr。在Mac调试的时候可以正常生成如下所示的psnr趋势图：</p>
<p><img src="/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/1.png" alt></p>
<p>但是将应用部署到linux机器的时候，却提示**ModuleNotFoundError: No module named ‘_tkinter’**的错误。</p>
<span id="more"></span>
<p>具体如下图所示：</p>
<p><img src="/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/2.jpg" alt></p>
<p>请教了同事后采用如下的方式解决了问题：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import matplotlib </span><br><span class="line">matplotlib.use(&#39;Agg&#39;)</span><br><span class="line">import matplotlib.pyplot as plt</span><br></pre></td></tr></table></figure>
<p><img src="/2020/04/28/Matplotlib-s-backends-and-non-interactive-backends-for-rendering/3.jpg" alt></p>
<p>虽然解决了问题，但是当时没有明白：</p>
<ul>
<li>问题究竟是如何解决的？</li>
<li>为什么这样就可以解决？</li>
<li>解决方案和之前的写法的差异在哪里？</li>
</ul>
<p>因此查阅了matplotlib的文档，然后就有了该文接下来的内容。为了保证材料的原汁原味，如下的内容均摘录自<a href="https://matplotlib.org/3.2.1/tutorials/introductory/usage.html#backends">matplotlib的开发文档</a>。</p>
<h2 id="matplotlib中backend的概念">matplotlib中backend的概念</h2>
<p>A lot of documentation on the website and in the mailing lists refers to the <strong>“backend”</strong> and many new users are confused by this term. matplotlib targets many different use cases and output formats. Some people use matplotlib interactively from the python shell and have plotting windows pop up when they type commands. Some people run Jupyter notebooks and draw inline plots for quick data analysis. Others embed matplotlib into graphical user interfaces like wxpython or pygtk to build rich applications. Some people use matplotlib in batch scripts to generate postscript images from numerical simulations, and still others run web application servers to dynamically serve up graphs.</p>
<p><strong>To support all of these use cases, matplotlib can target different outputs, and each of these capabilities is called a backend; the “frontend” is the user facing code, i.e., the plotting code, whereas the “backend” does all the hard work behind-the-scenes to make the figure.</strong></p>
<p>There are two types of backends:</p>
<ul>
<li>user interface backends (for use in pygtk, wxpython, tkinter, qt4, or macosx; also referred to as <code>&quot;interactive backends&quot;</code>). The interactive backends: GTK3Agg, GTK3Cairo, MacOSX, nbAgg, Qt4Agg, Qt4Cairo, Qt5Agg, Qt5Cairo, TkAgg, TkCairo, WebAgg, WX, WXAgg, WXCairo.</li>
<li>hardcopy backends to make image files (PNG, SVG, PDF, PS; also referred to as <code>&quot;non-interactive backends&quot;</code>). The non-interactive backends: agg, cairo, pdf, pgf, ps, svg, template.</li>
</ul>
<h2 id="matplotlib中backend的默认配置">matplotlib中backend的默认配置</h2>
<p>By default, <strong>Matplotlib should automatically select a default backend which allows both interactive work and plotting from scripts</strong>, with output to the screen and/or to a file, so at least initially you will not need to worry about the backend. <strong>The most common exception is if your Python distribution comes without tkinter and you have no other GUI toolkit installed; this happens on certain Linux distributions</strong>, where you need to install a Linux package named python-tk (or similar).</p>
<p>If, however, you want to write graphical user interfaces, or a web application server, or need a better understanding of what is going on, read on. To make things a little more customizable for graphical user interfaces, matplotlib separates the concept of the renderer (the thing that actually does the drawing) from the canvas (the place where the drawing goes). The canonical renderer for user interfaces is Agg which uses the Anti-Grain Geometry C++ library to make a raster (pixel) image of the figure; it is used by the Qt5Agg, Qt4Agg, GTK3Agg, wxAgg, TkAgg, and macosx backends. An alternative renderer is based on the Cairo library, used by Qt5Cairo, Qt4Cairo, etc.</p>
<h2 id="interactive模式的概念">interactive模式的概念</h2>
<p>Use of an interactive backend (see What is a backend?) permits–but does not by itself require or ensure–plotting to the screen. Whether and when plotting to the screen occurs, and whether a script or shell session continues after a plot is drawn on the screen, depends on the functions and methods that are called, and on a state variable that determines whether matplotlib is in “interactive mode”. The default Boolean value is set by the matplotlibrc file, and may be customized like any other configuration parameter (see Customizing Matplotlib with style sheets and rcParams). It may also be set via matplotlib.interactive(), and its value may be queried via matplotlib.is_interactive(). Turning interactive mode on and off in the middle of a stream of plotting commands, whether in a script or in a shell, is rarely needed and potentially confusing, so in the following we will assume all plotting is done with interactive mode either on or off.</p>
<p>Interactive mode may also be turned on via matplotlib.pyplot.ion(), and turned off via matplotlib.pyplot.ioff().</p>
<p><strong>In interactive mode, pyplot functions automatically draw to the screen.</strong> When plotting interactively, if using object method calls in addition to pyplot functions, then call draw() whenever you want to refresh the plot.</p>
<p>Use non-interactive mode in scripts in which you want to generate one or more figures and display them before ending or generating a new set of figures. In that case, use show() to display the figure(s) and to block execution until you have manually destroyed them.</p>
<h2 id="如何选择backend">如何选择backend</h2>
<p>There are three ways to configure your backend:</p>
<ul>
<li>The <code>rcParams[&quot;backend&quot;]</code> (default: ‘agg’) parameter in your matplotlibrc file</li>
<li>The <code>MPLBACKEND</code> environment variable</li>
<li>The function <code>matplotlib.use()</code></li>
</ul>
<p>A more detailed description is given below.</p>
<p>If multiple of these are configurations are present, the last one from the list takes precedence; e.g. calling <code>matplotlib.use()</code> will override the setting in your matplotlibrc.</p>
<p>If no backend is explicitly set, Matplotlib automatically detects a usable backend based on what is available on your system and on whether a GUI event loop is already running. On Linux, if the environment variable <code>DISPLAY</code> is unset, the “event loop” is identified as “headless”, which causes a fallback to a noninteractive backend (agg).</p>
<p>Here is a detailed description of the configuration methods:</p>
<ol>
<li>Setting <code>rcParams[&quot;backend&quot;]</code> (default: ‘agg’) in your matplotlibrc file:</li>
</ol>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">backend : qt5agg   # use pyqt5 with antigrain (agg) rendering</span><br></pre></td></tr></table></figure>
<p>See also Customizing Matplotlib with style sheets and rcParams.</p>
<ol start="2">
<li>Setting the <code>MPLBACKEND</code> environment variable:</li>
</ol>
<p>You can set the environment variable either for your current shell or for a single script.</p>
<p>On Unix:</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; export MPLBACKEND&#x3D;qt5agg</span><br><span class="line">&gt; python simple_plot.py</span><br><span class="line"></span><br><span class="line">&gt; MPLBACKEND&#x3D;qt5agg python simple_plot.py</span><br></pre></td></tr></table></figure>
<p>On Windows, only the former is possible:</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; set MPLBACKEND&#x3D;qt5agg</span><br><span class="line">&gt; python simple_plot.py</span><br></pre></td></tr></table></figure>
<p>Setting this environment variable will override the backend parameter in any matplotlibrc, even if there is a matplotlibrc in your current working directory. Therefore, setting MPLBACKEND globally, e.g. in your .bashrc or .profile, is discouraged as it might lead to counter-intuitive behavior.</p>
<ol start="3">
<li>If your script depends on a specific backend you can use the function <code>matplotlib.use()</code>:</li>
</ol>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import matplotlib</span><br><span class="line">matplotlib.use(&#39;qt5agg&#39;)</span><br></pre></td></tr></table></figure>
<p>This should be done before any figure is created; otherwise Matplotlib may fail to switch the backend and raise an ImportError.</p>
<p>Using use will require changes in your code if users want to use a different backend. Therefore, you should avoid explicitly calling use unless absolutely necessary.</p>
<h2 id="matplotlib-use-agg-的作用">matplotlib.use(‘Agg’)的作用</h2>
<p>在介绍完整整体的matplotlib中的backends以及matplotlib中的绘图模式之后，就能明白为什么文章开始出现的迁移过程中会出现类似的错误。</p>
<p>首先根据<a href="#matplotlib%E4%B8%ADbackend%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE">matplotlib中backend的默认配置</a>中的介绍可以知道，matplotlib会有一个默认的backend配置，并且该默认的backend会同时支持交互式绘图模式以及利用脚本绘图的模式。并且，交互式绘图还需要利用GUI工具来生成一个屏幕绘图的窗口。而迁移的Linux机器上缺乏tkinter这样的GUI工具，因此在<code>import matplotlib.pyplot as plt</code>的时候会产生错误。</p>
<p>而利用<code>matplotlib.use('Agg')</code>可以切换matplotlib的backend，将其backend从默认的交互式模式切换为非交互式模式，此时，生成的图形会以图片的形式保存起来，而无需tkinter这样的GUI工具的支持，因此可以解决本文最开始出现的问题。</p>
]]></content>
      <categories>
        <category>matplotlib</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>matplotlib</tag>
        <tag>non-interactive rendering</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Wireshark分析SRT直播流</title>
    <url>/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/</url>
    <content><![CDATA[<p><a href="https://www.haivision.com/products/srt-secure-reliable-transport/">SRT(Secure Reliable Transport)</a>是一种基于<a href="https://tools.ietf.org/html/draft-gg-udt-03">UDT(UDP-based Data Transfer)</a>的、安全的、可靠的、开源的数据传输协议&amp;技术。SRT在UDP基础之上实现了：智能数据重传机制和AES256加密技术，这使得其成为一种安全、可靠、低延迟的传输技术。利用SRT，可以实现在不可预测的网络环境下（例如互联网）高效、安全的传输数据。<a href="https://github.com/Haivision/srt/">SRT</a>还做了特殊优化以适合视频实时流数据的传输。根据<a href="https://www.srtalliance.org/srt-alliance-announces-the-addition-of-the-srt-low-latency-protocol-to-open-broadcaster-softwares-obs-studio/">SRT Alliance</a>在2019-04-04的介绍，目前如下的应用已经集成并支持SRT：<a href="https://obsproject.com/">OBS Studio</a>，<a href="https://www.videolan.org/vlc/">VideoLAN’s VLC</a>，<a href="http://ffmpeg.org/">FFmpeg</a>，<a href="https://www.wireshark.org/">Wireshark</a>。</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/1.png" alt></p>
<span id="more"></span>
<p>本文只介绍：<strong>如何利用FFmpeg生成SRT数据流并利用Wireshark对该SRT数据进行抓包分析</strong>。关于SRT的详细内容，可以参考<a href="https://github.com/Haivision/srt/files/2489142/SRT_Protocol_TechnicalOverview_DRAFT_2018-10-17.pdf">SRT Protocol Technical Overview Draft</a>。</p>
<h2 id="前期准备">前期准备</h2>
<ol>
<li>
<p>按照<a href="https://github.com/Haivision/srt/blob/master/README.md">说明</a>安装SRT</p>
</li>
<li>
<p>利用<code>./configure --enable-libsrt</code>重新编译FFmpeg，让ffmpeg工具集支持SRT协议。重新configure的过程如果遇到<code>ERROR: srt &gt;= 1.3.0 not found using pkg-config</code>的错误，可以查看<code>ffbuild/config.log</code>的相关信息，一般需要把srt和srt所依赖的openssl的<strong>pkgconfig</strong>路径增加到<code>PKG_CONFIG_PATH</code>环境变量中即可。</p>
</li>
<li>
<p>升级Wireshark到3.0之后的版本，并且设置Wireshark取消Wireshark对UDT协议的支持，具体做法为：点击菜单栏中的<code>Analyze</code>-&gt;<code>Enabled Protocols</code>，然后从弹出的支持协议中找到UDT，并取消UDT前面的选择标记。</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/2.jpg" alt></p>
</li>
<li>
<p>安装VLC播放器，用于播放SRT协议的视频流。</p>
</li>
</ol>
<h2 id="生成srt直播流">生成SRT直播流</h2>
<p>可以利用<code>ffmpeg</code>和<code>srt-live-transmit</code>（该工具在安装srt的时候会默认安装）来生成SRT直播流。主要思路是首先利用<code>ffmpeg</code>生成UDP的直播流，然后利用<code>srt-live-transmit</code>把UDP的直播流转换成SRT的直播流，更详细的方式可以参考<a href="https://github.com/Haivision/srt/blob/master/docs/srt-live-transmit.md">srt-live-transmit的使用说明</a>。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 生成UDP视频流</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ffmpeg -f lavfi -re -i smptebars=duration=300:size=1280x720:rate=30 \</span></span><br><span class="line"><span class="bash">-f lavfi -re -i sine=frequency=1000:duration=60:sample_rate=44100 \</span></span><br><span class="line"><span class="bash">-pix_fmt yuv420p -c:v libx264 -b:v 1000k -g 30 -keyint_min 120 \</span></span><br><span class="line"><span class="bash">-profile:v baseline -preset veryfast -f mpegts \</span></span><br><span class="line"><span class="bash"><span class="string">&quot;udp://127.0.0.1:5000?pkt_size=1316&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成SRT视频流</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> srt-live-transmit -s:10 udp://:5000 srt://:5001</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用ffplay播放SRT视频流</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ffplay <span class="string">&quot;srt://127.0.0.1:5001&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>具体播放效果如下所示：</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/3.jpg" alt></p>
<h2 id="使用wireshark分析srt">使用Wireshark分析SRT</h2>
<p>为了可以用Wireshark抓到SRT数据包，需要使用VLC播放器来打开刚才创建的SRT视频流，具体如下所示：</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/4.jpg" alt></p>
<p>打开Wireshark，选择Lookback（因为要捕获的SRT地址为127.0.0.1），然后在捕获的数据窗口选择srt协议过滤，稍等片刻就可以看到捕获的SRT数据包，具体如下图所示：</p>
<p><img src="/2020/04/09/analysize-SRT-protocol-live-stream-with-wireshark/5.jpg" alt></p>
<p>接下来就可以利用Wireshark来分析SRT协议的处理流程，例如上图中的Handshake数据包。尤其是在学习的过程中，配合<a href="https://github.com/Haivision/srt/files/2489142/SRT_Protocol_TechnicalOverview_DRAFT_2018-10-17.pdf">SRT的协议文档</a>以及Wireshark的抓包分析，能够加深对SRT协议的理解，达到事半功倍的效果。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>Wireshark</tag>
        <tag>SRT</tag>
        <tag>网络协议分析</tag>
      </tags>
  </entry>
  <entry>
    <title>macOS Catalina的strip版本异常导致编译的FFmpeg运行被kill</title>
    <url>/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/</url>
    <content><![CDATA[<p>因为近期正在调研&amp;了解<a href="https://github.com/Haivision/srt">SRT协议</a>的相关内容，为了方便，需要打开FFmpeg的<code>--enable-libsrt</code>功能并重新编译FFmpeg，从而保证FFmpeg支持SRT协议。但是重新编译之后却发现启动ffmpeg工具就会被内核杀死，具体如下所示。</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/1.jpg" alt></p>
<span id="more"></span>
<p>利用<em>lldb</em>调试该<em>ffmpeg</em>发现直接提示<code>error: Malformed Mach-o file</code>的错误，具体如下：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/2.jpg" alt></p>
<p>编译异常的Mac版本和Xcode版本信息分别如下：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/3.jpg" alt></p>
<p>查阅了<a href="https://trac.ffmpeg.org/ticket/8073">网上的资料</a>，也查看了<a href="https://github.com/Homebrew/homebrew-core/blob/master/Formula/ffmpeg.rb">brew编译FFmpeg的指令</a>，原因可能是：<strong>Xcode11下clang默认开启-fstack-check</strong>。</p>
<p>同时，在如下图所示的Xcode 10.3版本的Mac上则可编译成功：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/4.jpg" alt></p>
<p>因此根据如上信息：<code>./configure</code>时需要增加<code>--host-cflags=-fno-stack-check</code>配置。</p>
<p>但是增加该配置之后，编译出的ffmpeg依然无法正常运行。</p>
<h2 id="发现原因">发现原因</h2>
<p><strong>恰好最近升级了系统和Xcode版本，想着再编译一下看下是否可用，终于有了新的发现。</strong></p>
<p>编译的系统版本和Xcode版本如下所示：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/5.jpg" alt></p>
<p>编译命令如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> .&#x2F;configure --enable-shared --enable-pthreads --enable-version3 --enable-avresample \</span><br><span class="line">--cc&#x3D;clang --host-cflags&#x3D; --host-ldflags&#x3D; --enable-ffplay --enable-gnutls --enable-gpl \</span><br><span class="line">--enable-libaom --enable-libbluray --enable-libmp3lame --enable-libopus \</span><br><span class="line">--enable-librubberband --enable-libsnappy --enable-libtesseract --enable-libtheora \</span><br><span class="line">--enable-libvidstab --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 \</span><br><span class="line">--enable-libx265 --enable-libxvid --enable-lzma --enable-libfontconfig --enable-libfreetype \</span><br><span class="line">--enable-frei0r --enable-libass --enable-libopencore-amrnb --enable-libopencore-amrwb \</span><br><span class="line">--enable-libopenjpeg --enable-librtmp --enable-libspeex --enable-libsoxr \</span><br><span class="line">--enable-videotoolbox --disable-libjack --disable-indev&#x3D;jack</span><br></pre></td></tr></table></figure>
<p>编译之后，惊喜的发现，虽然<code>ffprobe</code>命令依旧异常，但是<code>ffprobe_g</code>命令已经可以使用了。具体如下图所示：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/6.jpg" alt></p>
<p><code>ffprobe</code>和<code>ffprobe_g</code>的不同就是<code>ffprobe_g</code>会包含调试信息。</p>
<p>回顾编译指令的最后几条指令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LD ffmpeg_g</span><br><span class="line">LD ffprobe_g</span><br><span class="line">LD ffplay_g</span><br><span class="line">STRIP ffmpeg</span><br><span class="line">STRIP ffprobe</span><br><span class="line">STRIP ffplay</span><br></pre></td></tr></table></figure>
<p>可以发现，在编译的最后，使用<code>strip</code>命令，去掉了<code>ffprobe</code>中的调试信息。那么是否是<code>strip</code>命令有问题呢？</p>
<p>带着这个疑问，写了一段测试代码<code>test.cpp</code>：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Hello World!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>clang++</code>编译并对比利用<code>strip</code>命令去掉调试信息前后的运行结果，终于发现了问题所在：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/7.jpg" alt></p>
<p>至此，终于找到原因：<code>strip</code>命令生成的无调试信息的可执行程序，会发生<code>Malformed Mach-o file</code>的现象。</p>
<h2 id="修正strip版本">修正strip版本</h2>
<p>怀疑机器上的<code>strip</code>版本异常导致去掉调试信息后的可执行文件出现异常。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ which strip</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;opt&#x2F;binutils&#x2F;bin&#x2F;strip</span><br><span class="line">$ which clang++</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;clang++</span><br><span class="line">$ ls &#x2F;usr&#x2F;bin&#x2F;strip</span><br><span class="line">&#x2F;usr&#x2F;bin&#x2F;strip</span><br><span class="line">$ &#x2F;usr&#x2F;bin&#x2F;strip -x a.out</span><br><span class="line">$ .&#x2F;a.out</span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>
<p>经过如上的过程发现，确实是<code>strip</code>的版本有问题，利用<code>/usr/bin/strip</code>生成的无调试信息的可执行程序是正常的。</p>
<h2 id="问题解决">问题解决</h2>
<p>在编译ffmpeg时，利用<code>--strip</code>选项来指定<code>strip</code>的版本。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> .&#x2F;configure --enable-shared --enable-pthreads --enable-version3 --enable-avresample \</span><br><span class="line">--cc&#x3D;clang --host-cflags&#x3D; --host-ldflags&#x3D; --enable-ffplay --enable-gnutls --enable-gpl \</span><br><span class="line">--enable-libaom --enable-libbluray --enable-libmp3lame --enable-libopus \</span><br><span class="line">--enable-librubberband --enable-libsnappy --enable-libtesseract --enable-libtheora \</span><br><span class="line">--enable-libvidstab --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 \</span><br><span class="line">--enable-libx265 --enable-libxvid --enable-lzma --enable-libfontconfig --enable-libfreetype \</span><br><span class="line">--enable-frei0r --enable-libass --enable-libopencore-amrnb --enable-libopencore-amrwb \</span><br><span class="line">--enable-libopenjpeg --enable-librtmp --enable-libspeex --enable-libsoxr \</span><br><span class="line">--enable-videotoolbox --disable-libjack --disable-indev&#x3D;jack \</span><br><span class="line">--strip&#x3D;&#x2F;usr&#x2F;bin&#x2F;strip</span><br></pre></td></tr></table></figure>
<p>大功告成，问题解决，具体如下所示：</p>
<p><img src="/2020/04/08/ffmpeg-compiled-in-macOS-Catalina-runs-crash/8.jpg" alt></p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
        <tag>编译</tag>
        <tag>macOS Catalina</tag>
        <tag>strip</tag>
      </tags>
  </entry>
  <entry>
    <title>Android环境下编译libyuv</title>
    <url>/2020/03/30/compile-libyuv-for-Android/</url>
    <content><![CDATA[<p>libyuv是Google开源的实现各种YUV格式与RGB格式之间相互转换、旋转、缩放的库。关于libyuv的具体介绍可以参考<a href="https://chromium.googlesource.com/libyuv/libyuv">官网介绍</a>。</p>
<span id="more"></span>
<h2 id="android-studio编译libyuv">Android Studio编译libyuv</h2>
<p>在自己编译libyuv的过程中，遇到了很多坑。在解决这些坑的过程中发现，从网上查询的很多资料并没有对问题的解决提供帮助。因此，在自己趟过了所有的坑之后，就想把编译libyuv的过程整理了出来，一方面是做一个梳理和总结，另一方面也希望帮助更多有类似需求的人。</p>
<p>接下来，开始介绍在Android平台上，利用NKD编译包含libjpeg库的libyuv库。这个主要通过<a href="https://chromium.googlesource.com/libyuv/libyuv/+/refs/heads/master/Android.mk">libyuv/Android.mk</a>中的如下代码实现：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">LOCAL_WHOLE_STATIC_LIBRARIES :&#x3D; libyuv_static</span><br><span class="line">LOCAL_MODULE :&#x3D; libyuv</span><br><span class="line">ifneq ($(LIBYUV_DISABLE_JPEG), &quot;yes&quot;)</span><br><span class="line">LOCAL_SHARED_LIBRARIES :&#x3D; jpeg</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">include $(BUILD_SHARED_LIBRARY)</span><br></pre></td></tr></table></figure>
<h2 id="需要下载的库">需要下载的库</h2>
<ul>
<li><a href="https://chromium.googlesource.com/libyuv/libyuv">libyuv</a>或者<a href="https//github.com/lemenkov/libyuv.git">libyuv</a></li>
<li><a href="https://github.com/libjpeg-turbo/libjpeg-turbo.git">libjpeg-turbo</a></li>
</ul>
<h2 id="编译依赖">编译依赖</h2>
<h3 id="ndk">NDK</h3>
<p>因为NDK-r17之后的版本，不支持gcc编译so，需要使用clang来编译so库。因此编译时，需要确定好自己的NDK版本。</p>
<h3 id="cmake-nasm-gcc等">CMAKE, NASM, GCC等</h3>
<p>该部分编译依赖为编译libjpeg-turbo库的编译依赖，具体可以参见libjpeg-turbo的<a href="https://github.com/libjpeg-turbo/libjpeg-turbo/blob/master/BUILDING.md">BUILD.md</a></p>
<h2 id="编译libjpeg-turbo">编译libjpeg-turbo</h2>
<ol>
<li>
<p>下载编译脚本，编译脚本位于<a href="https://github.com/wangwei1237/libyuv-with-jpeg/tree/master/libjpeg-turbo">libjpeg-turbo</a>目录下，共计有三个脚本：</p>
<ol>
<li><a href="http://config.sh">config.sh</a>：配置编译参数，例如ANDROID_NDK_ROOT等，需要根据自己的环境变量进行替换。</li>
<li>build_jpeg.sh：编译某个CPU架构的so库，该脚本中的变量一般不需要修改。</li>
<li>build_jpeg_all.sh：编译所有CPU架构的so库</li>
</ol>
</li>
<li>
<p>下载<a href="https://github.com/libjpeg-turbo/libjpeg-turbo">libjpeg-turbo</a>源码：<code>git clone https://github.com/libjpeg-turbo/libjpeg-turbo.git</code>。</p>
</li>
<li>
<p>将第<em>1</em>步中下载到的三个文件复制到libjepg-turob源码的根目录下：<code>cp -r libjpeg-turbo/* JPEG_SRC_ROOT_PATH/</code>。</p>
</li>
<li>
<p>修改<em><a href="http://config.sh">config.sh</a></em>中的<code>ANDROID_NDK_ROOT</code>为自己的NDK路径，修改<code>ANDROID_NDK_VERSION</code>为对应的数字版本。例如<em>r16b</em>版本的为<code>ANDROID_NDK_VERSION=16</code>。</p>
</li>
<li>
<p>运行<code>sh build_jpeg_all.sh</code>编译libjpeg-turbo，运行之后会在当前目录的<em>libs</em>目录下生成各种CPU架构对应的so库。如下图所示：</p>
<p><img src="/2020/03/30/compile-libyuv-for-Android/1.jpg" alt="图1. libjpeg-turbo编译产物"></p>
</li>
</ol>
<h2 id="编译libyuv">编译libyuv</h2>
<ol>
<li>
<p>将之前下载的libyuv的源码导入到Android Studio中的指定目录：PROJECT/app/jni/libyuv,该目录自己定义就可以。</p>
</li>
<li>
<p>将上一步生成的so文件按照ABI的格式复制到libyuv/libs目录下，如下图所示：</p>
<p><img src="/2020/03/30/compile-libyuv-for-Android/2.png" alt="图2"></p>
</li>
<li>
<p>修改libyuv目录下的Android.mk文件，<a href="https://github.com/wangwei1237/libyuv-with-jpeg/blob/master/myapp/jni/libyuv/Android.mk">libyuv/Android.mk</a>文件中的第4~12行的内容即可。</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">########################################################</span><br><span class="line">## &#123;&#123;BEGIN 增加如下的代码</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line">LOCAL_MODULE :&#x3D; jpeg</span><br><span class="line">LOCAL_SRC_FILES :&#x3D; libs&#x2F;$(TARGET_ARCH_ABI)&#x2F;libjpeg.so</span><br><span class="line">LOCAL_EXPORT_C_INCLUDES :&#x3D; $(LOCAL_PATH)&#x2F;include</span><br><span class="line">include $(PREBUILT_SHARED_LIBRARY)</span><br><span class="line">## END&#125;&#125;</span><br><span class="line">########################################################</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>按照<a href="https://github.com/wangwei1237/libyuv-with-jpeg">仓库</a>所示的<a href="https://github.com/wangwei1237/libyuv-with-jpeg/tree/master/myapp/jni">myapp/jni</a>目录下的<em><a href="http://Android.mk">Android.mk</a></em>和<em><a href="http://Application.mk">Application.mk</a></em>文件修改自己代码中的对应文件即可，主要是用于编译libyuv使用。</p>
</li>
<li>
<p>修改自己app目录下的<a href="https://github.com/wangwei1237/libyuv-with-jpeg/blob/master/myapp/build.gradle">build.gradle</a>，在android{}中增加如下编译任务</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">externalNativeBuild &#123;</span><br><span class="line">    ndkBuild &#123;</span><br><span class="line">        path file(&#39;jni&#x2F;Android.mk&#39;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>点击Android Studio的编译按钮编译即可，编译后生成的编译产物如下图所示：</p>
<p><img src="/2020/03/30/compile-libyuv-for-Android/3.jpg" alt="图3. libyuv的编译产物"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>libyuv</tag>
      </tags>
  </entry>
  <entry>
    <title>图像金字塔简介</title>
    <url>/2020/03/18/introduction-to-image-pyramid/</url>
    <content><![CDATA[<h1>图像金字塔</h1>
<h2 id="图像金字塔的概念">图像金字塔的概念</h2>
<p>一般而言，我们处理的图像通常是恒定大小（分辨率）的图像。但是在某些特殊的场景下，需要处理同一图像的不同分辨率的图像。例如，在图像中搜索某些内容时（例如面部），由于不确定待搜索的内容在图像中的区域大小，因此需要创建一个具有不同分辨率的图像集，并在该图像集的所有图像中执行搜索操作。</p>
<p>这些具有不同分辨率的图像集称为“图像金字塔”。之所以称其为“图像金字塔”，是因为当这些图像按照分辨率由低到高堆叠在一起时，底部的最大图像和顶部的最小图像看起来就像是一座金字塔。</p>
<span id="more"></span>
<p>因此，图像金字塔是图像的集合，这些图像集合由单个原始图像通过连续的降采样——直到达到某个期望的暂停点为止——产生。</p>
<p><img src="/2020/03/18/introduction-to-image-pyramid/1.jpg" alt></p>
<h2 id="图像金字塔的分类">图像金字塔的分类</h2>
<p>应用中经常用到的图像金字塔主要有两种：</p>
<ul>
<li>高斯金字塔</li>
<li>拉普拉斯金字塔</li>
</ul>
<p>高斯金字塔一般用于图像的降采样，而拉普拉斯金字塔则用于通过图像金字塔中的低分辨率图像重构高分率图像的图像上采样。</p>
<h3 id="高斯金字塔">高斯金字塔</h3>
<p>高斯金字塔中的低分辨率图像是通过删除高分辨率图像中的行和列而产生，具体如下所示：</p>
<ul>
<li>令高斯金字塔中第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>层的图像为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>使用一个高斯核对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>执行卷积操作得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>G</mi><mi>i</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">G_i^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.010556em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span></li>
<li>然后删除<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>G</mi><mi>i</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow><annotation encoding="application/x-tex">G_i^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.010556em;vertical-align:-0.258664em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span></span></span></span>中的偶数行和偶数列，得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">G_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>根据如上的步骤，可以知道，第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>级图像的分辨率是第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>级图像的分辨率的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。</p>
<h4 id="pyrdown">pyrDown</h4>
<p>在OpenCV中，可以使用<code>cv2.pyrDown()</code>生成图像的上一层级图像。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">higher_resolution = cv2.imread(<span class="string">&#x27;img.jpg&#x27;</span>)</span><br><span class="line">lower_resolution  = cv2.pyrDown(higher_resolution)</span><br></pre></td></tr></table></figure>
<p>下图是一个4级的高斯金字塔的例子。<br>
<img src="/2020/03/18/introduction-to-image-pyramid/2.jpg" alt></p>
<h4 id="pyrup">pyrUp</h4>
<p>我们还可以使用<code>cv2.pyrUp()</code>将图像转换为每个方向两倍大小的图像，该函数</p>
<ul>
<li>首先将图像的大小在各个维度上扩展2倍</li>
<li>然后对新增的行用0进行填充</li>
<li>最后再使用高斯滤波器执行卷积计算来获取“丢失”的像素的值</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">higher_resolution_2 = cv2.pyrUp(lower_resolution)</span><br></pre></td></tr></table></figure>
<p>从如上的步骤不难发现，<code>cv2.pyrUp()</code>并不是<code>cv2.pyrDown()</code>的逆运算，因为<code>cv2.pyrDown()</code>是一个丢失信息的操作，一旦分辨率降低，就会存在信息丢失。</p>
<p>因此，在示例代码中，<code>higher_resolution_2</code>和<code>higher_resolution</code>是不同的。</p>
<p>对<a href="#pyrDown">pyrDown</a>中的图像执行<code>pyrUp()</code>效果如下所示：<br>
<img src="/2020/03/18/introduction-to-image-pyramid/3.jpg" alt></p>
<h3 id="拉普拉斯金字塔">拉普拉斯金字塔</h3>
<p>为了从图像金字塔中的低分辨率图像恢复高分辨率的图像，需要使用下采样过程中丢弃的信息。而这些数据则构成了拉普拉斯金字塔。</p>
<p>令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>为高斯金字塔的第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>级图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">G_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>下采样得到第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>级图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">G_{i+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.891661em;vertical-align:-0.208331em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span></span></span></span>时丢失的信息，则：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mi>i</mi></msub><mo>=</mo><msub><mi>G</mi><mi>i</mi></msub><mo>−</mo><mi>c</mi><mi>v</mi><mn>2.</mn><mi>p</mi><mi>y</mi><mi>r</mi><mi>U</mi><mi>p</mi><mo stretchy="false">(</mo><msub><mi>G</mi><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L_i=G_i - cv2.pyrUp(G_{i+1})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord">2</span><span class="mord">.</span><span class="mord mathdefault">p</span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.208331em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace linebreak="newline"></mspace><mrow><msub><mi>L</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mi>i</mi><mo>∈</mo><mn>1...</mn><mi>n</mi><mspace linebreak="newline"></mspace></mrow></mrow><annotation encoding="application/x-tex">\\{L_i | i \in 1...n\\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">.</span><span class="mord">.</span><span class="mord mathdefault">n</span><span class="mspace newline"></span></span></span></span></span>则构成拉普拉斯金字塔。</p>
<p>拉普拉斯金字塔由高斯金字塔而形成，并没有其它的额外功能，并且拉普拉斯金字塔图像和图像的边缘图像很像。在拉普拉斯金字塔中的图像的大多数元素为零。一个4级拉普拉斯金字塔的图像如下所示（已调整图像的曝光度以增强图像内容）：<br>
<img src="/2020/03/18/introduction-to-image-pyramid/4.jpg" alt></p>
<h2 id="尺度空间和图像金字塔卷积核的选择">尺度空间和图像金字塔卷积核的选择</h2>
<p>在现实世界中，客观物体在不同尺度时有着不同的结构。这意味着，如果从不同的尺度去观察同一个物体，会得出不一样的结果。例如，从不同的距离观察同一个图像时，随着距离的不断缩小，能够观察到的图像的结构也有所不同。</p>
<p>观察一棵树的尺度和观察一片树叶的尺度也是不同的：观察一棵树的适当尺度应该是<strong>米</strong>，而观察一片叶子可能需要更细粒度的尺度才能得出较好的结果。</p>
<p>当计算机系统要对一个未知的场景进行分析时，并不能提前预知用什么样的尺度来描述图像信息中的<strong>interesting structures</strong>是最合适的。因此，唯一可行的方案就是将多个不同尺度的描述都考虑进来，以便捕获未知的尺度变化。</p>
<p>尺度空间理论和生物视觉之间也有着十分密切的联系。哺乳动物的视网膜以及视觉皮层第一阶段所记录的接受场的分布，与许多尺度空间操作都高度近似。</p>
<p>如<a href="#%E9%AB%98%E6%96%AF%E9%87%91%E5%AD%97%E5%A1%94">高斯金字塔</a>的描述，在生成高斯金字塔时，会采用高斯核(<em>filter</em>)对图像进行处理，那么为什么非要采用高斯核呢？</p>
<p>实际上，并非任何低通滤波器（<em>low-pass filter</em>）都可用于生成尺度空间。可用于生成尺度空间的filter必须满足如下的条件：</p>
<blockquote>
<p>由该平滑filter生成的粗尺度图像（高层图像）不会引入不存在于细尺度图像（低层图像）中的杂散结构。</p>
</blockquote>
<p>如上的条件的言外之意就是：给定粗尺度图像中的任何一个区域，细尺度图像上总能找到相应的区域。对这两个区域而言，粗尺度图像区域不能有新的结构。</p>
<p>受制于<a href="https://en.wikipedia.org/wiki/Scale-space_axioms">尺度空间公理</a>，高斯卷积核是实现尺度变换的唯一线性核。因此，在图像金字塔中，需要采用高斯卷积核对图像进行处理。</p>
<p><a href="https://en.wikipedia.org/wiki/Scale-space_axioms">尺度空间公理</a>需要满足如下的条件：</p>
<ul>
<li>线性</li>
<li>平移不变性</li>
<li>半群特性</li>
<li>旋转不变性</li>
<li>尺度不变性</li>
<li>正定性</li>
<li>正规性(积分为1)</li>
<li>不会引入新的极点</li>
<li>不会增强极点</li>
<li>存在无穷小的算子（可微性）</li>
</ul>
<h2 id="图像金字塔的应用">图像金字塔的应用</h2>
<p>图像金字塔的一种应用是图像融合。例如，在图像拼接中会将两个图像堆叠，但是由于图像之间的不连续性，这种对原始图像的直接拼接的效果并不好。例如，我们对如下图所示的两幅图像：</p>
<p><img src="/2020/03/18/introduction-to-image-pyramid/5.jpg" alt></p>
<p>的直接拼接效果和采用图像金字塔拼接效果分别为（左图为直接拼接）：</p>
<p><img src="/2020/03/18/introduction-to-image-pyramid/8.jpg" alt></p>
<p>由此可以看出，使用“图像金字塔”融合图像则可以让拼接之后的图像看起来天衣无缝。</p>
<p>可以按照如下的步骤使用“图像金字塔”来拼接如上的图像（<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/03/18/introduction-to-image-pyramid/image_pyramid_blend.ipynb">玩转多尺度图像融合</a>)：</p>
<ol>
<li>加载图像</li>
<li>计算图像的高斯金字塔（在此示例中，级数为6）</li>
<li>从高斯金字塔中计算拉普拉斯金字塔</li>
<li>在每个拉普拉斯金字塔中加入苹果的左半部分和橙子的右半部分</li>
<li>最后，从联合图像金字塔中重建原始图像</li>
</ol>
<p>除了如上的<strong>多分辨率图像融合算法会用到图像金字塔</strong>之外，图像金字塔还可用于如下的场景：</p>
<ul>
<li>sift算法</li>
<li>在from coarse to fine由粗到精的搜索策略中都可以用金字塔</li>
<li>optical flow光流法</li>
<li>slam当中的姿态估计</li>
<li>……</li>
</ul>
]]></content>
      <categories>
        <category>视觉技术</category>
      </categories>
      <tags>
        <tag>图像金字塔</tag>
        <tag>高斯金字塔</tag>
        <tag>拉普拉斯金字塔</tag>
        <tag>image pyramid</tag>
      </tags>
  </entry>
  <entry>
    <title>数字视频基本概念</title>
    <url>/2020/03/03/digital-video-concept/</url>
    <content><![CDATA[<p>在学习和研究视频技术的过程中，联合几个同事一起翻译了<a href="https://link.springer.com/book/10.1007/978-1-4302-6713-3">Digital Video Concepts, Methods, and Metrics: Quality, Compression, Performance, and Power Trade-off Analysis</a>，形成了<a href="/digital-video-concept"><strong>数字视频概念，方法和测量指标：质量，压缩，性能和电量等的权衡分析（中文版）</strong></a>。该翻译版本仅供学习交流之用。希望对想学习和了解数字视频相关技术的同学，有所帮助。</p>
<p>在翻译的过程中，尽可能的保留了原书的内容，并且对原书中的个别内容进行了修正和补充。</p>
<span id="more"></span>
<p><img src="/digital-video-concept/images/cover_0.jpg" alt></p>
<p>该书在翻译的过程中采用gitbook方式编写，可以利用gitbook将该项目打包成静态网页格式或者PDF<br>
格式，具体可以参见：<a href="https://einverne.github.io/gitbook-tutorial/output/static.html">gitbook教程</a>。</p>
<p>项目主页地址：<a href="https://github.com/wangwei1237/digital_video_concepts.git">github仓库</a></p>
<p>在线预览地址：<a href="https://wangwei1237.gitee.io/digital-video-concept">预览地址1</a>, <a href="https://wangwei1237.github.io/digital-video-concept">预览地址2</a>, <a href="https://wangwei1237.gitbook.io/digital_video_concepts">预览地址3</a></p>
<p>在阅读过程中有任何意见或建议，欢迎在github上提交issue，我们也会快速跟进。</p>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>数字视频</tag>
        <tag>荐书</tag>
        <tag>digital video</tag>
        <tag>视频基础知识</tag>
      </tags>
  </entry>
  <entry>
    <title>数字视频技术导论</title>
    <url>/2020/02/28/Introduction-to-digital-video-technology/</url>
    <content><![CDATA[<h1>背景</h1>
<p>因为工作关系需要了解数字视频相关技术，在学习的过程中找到了这份托管在github上的<strong>数字视频导论</strong>的材料。</p>
<p>这份材料介绍了基本的数字视频相关技术，言简意赅但又不枯燥无味，即有理论又有丰富的实践操作，在我学习的所有材料中算是比较上乘的材料。</p>
<p>基于如上的原因，将该材料的相关内容转载到此处。大家可以直接访问该材料的github仓库<a href="https://github.com/leandromoreira/digital_video_introduction"><strong>digital_video_introduction</strong></a>获取相关内容。如下的所有内容皆来自<a href="https://github.com/leandromoreira/digital_video_introduction"><strong>digital_video_introduction</strong></a>，特此标注。</p>
<p><a href="license-BSD--3--Clause-blue.svg"><img src="/2020/02/28/Introduction-to-digital-video-technology/license-BSD--3--Clause-blue.svg" alt="license"></a></p>
<span id="more"></span>
<h1>介绍</h1>
<p>这是一份循序渐进的视频技术的介绍。尽管它面向的是软件开发人员/工程师，但我们希望<strong>对任何人而言</strong>，这份文档都能简单易学。这个点子产生于一个<a href="https://docs.google.com/presentation/d/17Z31kEkl_NGJ0M66reqr9_uTG6tI5EDDVXpdPKVuIrs/edit#slide=id.p">视频技术新手小型研讨会</a>期间。</p>
<p>本文档旨在尽可能使用<strong>浅显的词语，丰富的图像和实际例子</strong>介绍数字视频概念，使这些知识能适用于各种场合。你可以随时反馈意见或建议，以改进这篇文档。</p>
<h1>目录</h1>
<ul>
<li><a href="#%E4%BB%8B%E7%BB%8D">介绍</a></li>
<li><a href="#%E7%9B%AE%E5%BD%95">目录</a></li>
<li><a href="#%E5%9F%BA%E6%9C%AC%E6%9C%AF%E8%AF%AD">基本术语</a>
<ul>
<li><a href="#%E7%BC%96%E7%A0%81%E5%BD%A9%E8%89%B2%E5%9B%BE%E5%83%8F%E7%9A%84%E5%85%B6%E5%AE%83%E6%96%B9%E6%B3%95">编码彩色图像的其它方法</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E7%8E%A9%E8%BD%AC%E5%9B%BE%E5%83%8F%E5%92%8C%E9%A2%9C%E8%89%B2">自己动手：玩转图像和颜色</a></li>
<li><a href="#DVD-%E7%9A%84-DAR-%E6%98%AF-4-3">DVD 的 DAR 是 4:3</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%A3%80%E6%9F%A5%E8%A7%86%E9%A2%91%E5%B1%9E%E6%80%A7">自己动手：检查视频属性</a></li>
</ul>
</li>
<li><a href="#%E6%B6%88%E9%99%A4%E5%86%97%E4%BD%99">消除冗余</a>
<ul>
<li><a href="#%E9%A2%9C%E8%89%B2%EF%BC%8C%E4%BA%AE%E5%BA%A6%E5%92%8C%E6%88%91%E4%BB%AC%E7%9A%84%E7%9C%BC%E7%9D%9B">颜色，亮度和我们的眼睛</a>
<ul>
<li><a href="#%E9%A2%9C%E8%89%B2%E6%A8%A1%E5%9E%8B">颜色模型</a></li>
<li><a href="#YCbCr-%E5%92%8C-RGB-%E4%B9%8B%E9%97%B4%E7%9A%84%E8%BD%AC%E6%8D%A2">YCbCr 和 RGB 之间的转换</a></li>
<li><a href="#%E8%89%B2%E5%BA%A6%E5%AD%90%E9%87%87%E6%A0%B7">色度子采样</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%A3%80%E6%9F%A5-YCbCr-%E7%9B%B4%E6%96%B9%E5%9B%BE">自己动手：检查 YCbCr 直方图</a></li>
</ul>
</li>
<li><a href="#%E5%B8%A7%E7%B1%BB%E5%9E%8B">帧类型</a>
<ul>
<li><a href="#I-%E5%B8%A7%EF%BC%88%E5%B8%A7%E5%86%85%E7%BC%96%E7%A0%81%EF%BC%8C%E5%85%B3%E9%94%AE%E5%B8%A7%EF%BC%89">I 帧（内部，关键帧）</a></li>
<li><a href="#P-%E5%B8%A7%EF%BC%88%E9%A2%84%E6%B5%8B%EF%BC%89">P 帧（预测）</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E5%85%B7%E6%9C%89%E5%8D%95%E4%B8%AA-I-%E5%B8%A7%E7%9A%84%E8%A7%86%E9%A2%91">自己动手：具有单个 I 帧的视频</a></li>
</ul>
</li>
<li><a href="#B-%E5%B8%A7%EF%BC%88%E5%8F%8C%E5%90%91%E9%A2%84%E6%B5%8B%EF%BC%89">B 帧（双向预测）</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E4%BD%BF%E7%94%A8-B-%E5%B8%A7%E6%AF%94%E8%BE%83%E8%A7%86%E9%A2%91">自己动手：使用 B 帧比较视频</a></li>
</ul>
</li>
<li><a href="#%E5%B0%8F%E7%BB%93">小结</a></li>
</ul>
</li>
<li><a href="#%E6%97%B6%E9%97%B4%E5%86%97%E4%BD%99%EF%BC%88%E5%B8%A7%E9%97%B4%E9%A2%84%E6%B5%8B%EF%BC%89">时间冗余（帧间预测）</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%9F%A5%E7%9C%8B%E8%BF%90%E5%8A%A8%E5%90%91%E9%87%8F">自己动手：查看运动向量</a></li>
</ul>
</li>
<li><a href="#%E7%A9%BA%E9%97%B4%E5%86%97%E4%BD%99%EF%BC%88%E5%B8%A7%E5%86%85%E9%A2%84%E6%B5%8B%EF%BC%89">空间冗余（帧内预测）</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%9F%A5%E7%9C%8B%E5%B8%A7%E5%86%85%E9%A2%84%E6%B5%8B">自己动手：查看帧内预测</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E8%A7%86%E9%A2%91%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8%E6%98%AF%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C%E7%9A%84%EF%BC%9F">视频编解码器是如何工作的？</a>
<ul>
<li><a href="#%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%EF%BC%9F%E6%80%8E%E4%B9%88%E5%81%9A%EF%BC%9F">是什么？为什么？怎么做？</a></li>
<li><a href="#%E5%8E%86%E5%8F%B2">历史</a>
<ul>
<li><a href="#AV1-%E7%9A%84%E8%AF%9E%E7%94%9F">AV1 的诞生</a></li>
</ul>
</li>
<li><a href="#%E9%80%9A%E7%94%A8%E7%BC%96%E8%A7%A3%E7%A0%81%E5%99%A8">通用编解码器</a></li>
<li><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5-%E5%9B%BE%E7%89%87%E5%88%86%E5%8C%BA">第一步 - 图片分区</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%9F%A5%E7%9C%8B%E5%88%86%E5%8C%BA">自己动手：查看分区</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E9%A2%84%E6%B5%8B">第二步 - 预测</a></li>
<li><a href="#%E7%AC%AC%E4%B8%89%E6%AD%A5-%E8%BD%AC%E6%8D%A2">第三步 - 转换</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E4%B8%A2%E5%BC%83%E4%B8%8D%E5%90%8C%E7%9A%84%E7%B3%BB%E6%95%B0">自己动手：丢弃不同的系数</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5-%E9%87%8F%E5%8C%96">第四步 - 量化</a>
<ul>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E9%87%8F%E5%8C%96">自己动手：量化</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E4%BA%94%E6%AD%A5-%E7%86%B5%E7%BC%96%E7%A0%81">第五步 - 熵编码</a>
<ul>
<li><a href="#VLC-%E7%BC%96%E7%A0%81%EF%BC%9A">VLC 编码</a></li>
<li><a href="#%E7%AE%97%E6%9C%AF%E7%BC%96%E7%A0%81">算术编码</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9ACABAC-vs-CAVLC">自己动手：CABAC vs CAVLC</a></li>
</ul>
</li>
<li><a href="#%E7%AC%AC%E5%85%AD%E6%AD%A5-%E6%AF%94%E7%89%B9%E6%B5%81%E6%A0%BC%E5%BC%8F">第六步 - 比特流格式</a>
<ul>
<li><a href="#H-264-%E6%AF%94%E7%89%B9%E6%B5%81">H.264 比特流</a></li>
<li><a href="#%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%EF%BC%9A%E6%A3%80%E6%9F%A5-H-264-%E6%AF%94%E7%89%B9%E6%B5%81">自己动手：检查 H.264 比特流</a></li>
</ul>
</li>
<li><a href="#%E5%9B%9E%E9%A1%BE">回顾</a></li>
<li><a href="#H-265-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%AF%94-H-264-%E6%9B%B4%E5%A5%BD%E7%9A%84%E5%8E%8B%E7%BC%A9%E7%8E%87">H.265 如何实现比 H.264 更好的压缩率?</a></li>
</ul>
</li>
<li><a href="#%E5%9C%A8%E7%BA%BF%E6%B5%81%E5%AA%92%E4%BD%93">在线流媒体</a>
<ul>
<li><a href="#%E9%80%9A%E7%94%A8%E6%9E%B6%E6%9E%84">通用架构</a></li>
<li><a href="#%E6%B8%90%E8%BF%9B%E5%BC%8F%E4%B8%8B%E8%BD%BD%E5%92%8C%E8%87%AA%E9%80%82%E5%BA%94%E6%B5%81">渐进式下载和自适应流</a></li>
<li><a href="#%E5%86%85%E5%AE%B9%E4%BF%9D%E6%8A%A4">内容保护</a></li>
</ul>
</li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-jupyter">如何使用 jupyter</a></li>
<li><a href="#%E4%BC%9A%E8%AE%AE">会议</a></li>
<li><a href="#%E5%8F%82%E8%80%83">参考</a></li>
</ul>
<h1>基本术语</h1>
<p>一个<strong>图像</strong>可以视作一个<strong>二维矩阵</strong>。如果将<strong>色彩</strong>考虑进来，我们可以做出推广：将这个图像视作一个<strong>三维矩阵</strong>——多出来的维度用于储存色彩信息。</p>
<p>如果我们选择三原色（红、绿、蓝）代表这些色彩，这就定义了三个平面：第一个是红色平面，第二个是绿色平面，最后一个是蓝色平面。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/image_3d_matrix_rgb.png" alt="an image is a 3d matrix RGB" title="An image is a 3D matrix"></p>
<p>我们把这个矩阵里的每一个点称为<strong>像素</strong>（图像元素）。像素的色彩由三原色的<strong>强度</strong>（通常用数值表示）表示。例如，一个<strong>红色像素</strong>是指强度为 0 的绿色，强度为 0 的蓝色和强度最大的红色。<strong>粉色像素</strong>可以通过三种颜色的组合表示。如果规定强度的取值范围是 0 到 255，<strong>红色 255、绿色 192、蓝色 203</strong> 则表示粉色。</p>
<blockquote>
<h3 id="编码彩色图像的其它方法">编码彩色图像的其它方法</h3>
<p>还有许多其它模型也可以用来表示色彩，进而组成图像。例如，给每种颜色都标上序号（如下图），这样每个像素仅需一个字节就可以表示出来，而不是 RGB 模型通常所需的 3 个。在这样一个模型里我们可以用一个二维矩阵来代替三维矩阵去表示我们的色彩，这将节省存储空间，但色彩的数量将会受限。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/nes-color-palette.png" alt="NES palette" title="NES palette"></p>
</blockquote>
<p>例如以下几张图片。第一张包含所有颜色平面。剩下的分别是红、绿、蓝色平面（显示为灰调）（译注：颜色强度高的地方显示为亮色，强度低为暗色）。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/rgb_channels_intensity.png" alt="RGB channels intensity" title="RGB channels intensity"></p>
<p>我们可以看到，对于最终的成像，红色平面对强度的贡献更多（三个平面最亮的是红色平面），蓝色平面（最后一张图片）的贡献大多只在马里奥的眼睛和他衣服的一部分。所有颜色平面对马里奥的胡子（最暗的部分）均贡献较少。</p>
<p>存储颜色的强度，需要占用一定大小的数据空间，这个大小被称为颜色深度。假如每个颜色（平面）的强度占用 8 bit（取值范围为 0 到 255），那么颜色深度就是 24（8*3）bit，我们还可以推导出我们可以使用 2 的 24 次方种不同的颜色。</p>
<blockquote>
<p>很棒的学习材料：<a href="http://www.cambridgeincolour.com/tutorials/camera-sensors.htm">现实世界的照片是如何拍摄成 0 和 1 的</a>。</p>
</blockquote>
<p>图片的另一个属性是<strong>分辨率</strong>，即一个平面内像素的数量。通常表示成宽*高，例如下面这张 <strong>4x4</strong> 的图片。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/resolution.png" alt="image resolution" title="image resolution"></p>
<blockquote>
<h3 id="自己动手：玩转图像和颜色">自己动手：玩转图像和颜色</h3>
<p>你可以使用 <a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-jupyter">jupyter</a>（python, numpy, matplotlib 等等）<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/image_as_3d_array.ipynb">玩转图像</a>。</p>
<p>你也可以学习<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/filters_are_easy.ipynb">图像滤镜（边缘检测，磨皮，模糊。。。）的原理</a>。</p>
</blockquote>
<p>图像或视频还有一个属性是宽高比，它简单地描述了图像或像素的宽度和高度之间的比例关系。</p>
<p>当人们说这个电影或照片是 16:9 时，通常是指显示宽高比（DAR），然而我们也可以有不同形状的单个像素，我们称为像素宽高比（PAR）。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/DAR.png" alt="display aspect ratio" title="display aspect ratio"></p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/PAR.png" alt="pixel aspect ratio" title="pixel aspect ratio"></p>
<blockquote>
<h2 id="dvd-的-dar-是-4-3">DVD 的 DAR 是 4:3</h2>
<p>虽然 DVD 的实际分辨率是 704x480，但它依然保持 4:3 的宽高比，因为它有一个 10:11（704x10／480x11）的 PAR。</p>
</blockquote>
<p>现在我们可以将<strong>视频</strong>定义为在<strong>单位时间</strong>内<strong>连续的 n 帧</strong>，这可以视作一个新的维度，n 即为帧率，若单位时间为秒，则等同于 FPS (每秒帧数 Frames Per Second)。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/video.png" alt="video" title="video"></p>
<p>播放一段视频每秒所需的数据量就是它的<strong>比特率</strong>（即常说的码率）。</p>
<blockquote>
<p>比特率 = 宽 * 高 * 颜色深度 * 帧每秒</p>
</blockquote>
<p>例如，一段每秒 30 帧，每像素 24 bits，分辨率是 480x240 的视频，如果我们不做任何压缩，它将需要 <strong>82,944,000 比特每秒</strong>或 82.944 Mbps (30x480x240x24)。</p>
<p>当<strong>比特率</strong>几乎恒定时称为恒定比特率（<strong>CBR</strong>）；但它也可以变化，称为可变比特率（<strong>VBR</strong>）。</p>
<blockquote>
<p>这个图形显示了一个受限的 VBR，当帧为黑色时不会花费太多的数据量。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/vbr.png" alt="constrained vbr" title="constrained vbr"></p>
</blockquote>
<p>在早期，工程师们想出了一项技术能将视频的感官帧率加倍而<strong>没有消耗额外带宽</strong>。这项技术被称为<strong>隔行扫描</strong>；总的来说，它在一个时间点发送一个画面——画面用于填充屏幕的一半，而下一个时间点发送的画面用于填充屏幕的另一半。</p>
<p>如今的屏幕渲染大多使用<strong>逐行扫描技术</strong>。这是一种显示、存储、传输运动图像的方法，每帧中的所有行都会被依次绘制。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/interlaced_vs_progressive.png" alt="interlaced vs progressive" title="interlaced vs progressive"></p>
<p>现在我们知道了数字化<strong>图像</strong>的原理；它的<strong>颜色</strong>的编排方式；给定<strong>帧率</strong>和<strong>分辨率</strong>时，展示一个视频需要花费多少<strong>比特率</strong>；它是恒定的（CBR）还是可变的（VBR）；还有很多其它内容，如隔行扫描和 PAR。</p>
<blockquote>
<h2 id="自己动手：检查视频属性">自己动手：检查视频属性</h2>
<p>你可以<a href="https://github.com/leandromoreira/introduction_video_technology/blob/master/encoding_pratical_examples.md#inspect-stream">使用 ffmpeg 或 mediainfo 检查大多数属性的解释</a>。</p>
</blockquote>
<h1>消除冗余</h1>
<p>我们认识到，不对视频进行压缩是不行的；<strong>一个单独的一小时长的视频</strong>，分辨率为 720p 和 30fps 时将<strong>需要 278GB<sup>*</sup></strong>。仅仅使用无损数据压缩算法——如 DEFLATE（被PKZIP, Gzip, 和 PNG 使用）——也无法充分减少视频所需的带宽，我们需要找到其它压缩视频的方法。</p>
<blockquote>
<p><sup>*</sup>我们使用乘积得出这个数字 1280 x 720 x 24 x 30 x 3600 （宽，高，每像素比特数，fps 和秒数）</p>
</blockquote>
<p>为此，我们可以<strong>利用视觉特性</strong>：和区分颜色相比，我们区分亮度要更加敏锐。<strong>时间上的重复</strong>：一段视频包含很多只有一点小小改变的图像。<strong>图像内的重复</strong>：每一帧也包含很多颜色相同或相似的区域。</p>
<h2 id="颜色-亮度和我们的眼睛">颜色，亮度和我们的眼睛</h2>
<p>我们的眼睛<a href="http://vanseodesign.com/web-design/color-luminance/">对亮度比对颜色更敏感</a>，你可以看看下面的图片自己测试。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/luminance_vs_color.png" alt="luminance vs color" title="luminance vs color"></p>
<p>如果你看不出左图的<strong>方块 A 和方块 B</strong> 的颜色是<strong>相同的</strong>，那么好，是我们的大脑玩了一个小把戏，这让我们更多的去注意光与暗，而不是颜色。右边这里有一个使用同样颜色的连接器，那么我们（的大脑）就能轻易分辨出事实，它们是同样的颜色。</p>
<blockquote>
<p><strong>简单解释我们的眼睛工作的原理</strong></p>
<p><a href="http://www.biologymad.com/nervoussystem/eyenotes.htm">眼睛是一个复杂的器官</a>，有许多部分组成，但我们最感兴趣的是视锥细胞和视杆细胞。眼睛有<a href="https://en.wikipedia.org/wiki/Photoreceptor_cell">大约1.2亿个视杆细胞和6百万个视锥细胞</a>。</p>
<p><strong>简单来说</strong>，让我们把颜色和亮度放在眼睛的功能部位上。<a href="https://en.wikipedia.org/wiki/Rod_cell">视杆细胞</a><strong>主要负责亮度</strong>，而<a href="https://en.wikipedia.org/wiki/Cone_cell">视锥细胞</a><strong>负责颜色</strong>，有三种类型的视锥，每个都有不同的颜料，叫做：<a href="https://upload.wikimedia.org/wikipedia/commons/1/1e/Cones_SMJ2_E.svg">S-视锥（蓝色），M-视锥（绿色）和L-视锥（红色）</a>。</p>
<p>既然我们的视杆细胞（亮度）比视锥细胞多很多，一个合理的推断是相比颜色，我们有更好的能力去区分黑暗和光亮。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/eyes.jpg" alt="eyes composition" title="eyes composition"></p>
</blockquote>
<p>一旦我们知道我们对<strong>亮度</strong>（图像中的亮度）更敏感，我们就可以利用它。</p>
<h3 id="颜色模型">颜色模型</h3>
<p>我们最开始学习的<a href="#%E5%9F%BA%E6%9C%AC%E6%9C%AF%E8%AF%AD">彩色图像的原理</a>使用的是 <strong>RGB 模型</strong>，但也有其他模型。有一种模型将亮度（光亮）和色度（颜色）分离开，它被称为 <strong>YCbCr</strong><sup>*</sup>。</p>
<blockquote>
<p><sup>*</sup> 有很多种模型做同样的分离。</p>
</blockquote>
<p>这个颜色模型使用 <strong>Y</strong> 来表示亮度，还有两种颜色通道：Cb（蓝色色度） 和 Cr（红色色度）。YCbCr 可以由 RGB 转换得来，也可以转换回 RGB。使用这个模型我们可以创建拥有完整色彩的图像，如下图。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/ycbcr.png" alt="ycbcr 例子" title="ycbcr 例子"></p>
<h3 id="ycbcr-和-rgb-之间的转换">YCbCr 和 RGB 之间的转换</h3>
<p>有人可能会问，在**不使用绿色（色度）**的情况下，我们如何表现出所有的色彩？</p>
<p>为了回答这个问题，我们将介绍从 RGB 到 YCbCr 的转换。我们将使用 <a href="https://en.wikipedia.org/wiki/ITU-R">ITU-R 小组</a>*建议的<a href="https://en.wikipedia.org/wiki/Rec._601">标准 BT.601</a> 中的系数。</p>
<p>第一步是计算亮度，我们将使用 ITU 建议的常量，并替换 RGB 值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Y &#x3D; 0.299R + 0.587G + 0.114B</span><br></pre></td></tr></table></figure>
<p>一旦我们有了亮度后，我们就可以拆分颜色（蓝色色度和红色色度）：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Cb &#x3D; 0.564(B - Y)</span><br><span class="line">Cr &#x3D; 0.713(R - Y)</span><br></pre></td></tr></table></figure>
<p>并且我们也可以使用 YCbCr 转换回来，甚至得到绿色。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">R &#x3D; Y + 1.402Cr</span><br><span class="line">B &#x3D; Y + 1.772Cb</span><br><span class="line">G &#x3D; Y - 0.344Cb - 0.714Cr</span><br></pre></td></tr></table></figure>
<blockquote>
<p><sup>*</sup>组织和标准在数字视频领域中很常见，它们通常定义什么是标准，例如，<a href="https://en.wikipedia.org/wiki/Rec._2020">什么是 4K？我们应该使用什么帧率？分辨率？颜色模型？</a></p>
</blockquote>
<p>通常，<strong>显示屏</strong>（监视器，电视机，屏幕等等）<strong>仅使用 RGB 模型</strong>，并以不同的方式来组织，看看下面这些放大效果：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/new_pixel_geometry.jpg" alt="pixel geometry" title="pixel geometry"></p>
<h3 id="色度子采样">色度子采样</h3>
<p>一旦我们能从图像中分离出亮度和色度，我们就可以利用人类视觉系统对亮度比色度更敏感的特点，选择性地剔除信息。<strong>色度子采样</strong>是一种编码图像时，使<strong>色度分辨率低于亮度</strong>的技术。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/ycbcr_subsampling_resolution.png" alt="ycbcr 子采样分辨率" title="ycbcr 子采样分辨率"></p>
<p>我们应该减少多少色度分辨率呢？已经有一些模式定义了如何处理分辨率和合并（<code>最终的颜色 = Y + Cb + Cr</code>）。</p>
<p>这些模式称为子采样系统，并被表示为 3 部分的比率 - <code>a:x:y</code>，其定义了色度平面的分辨率，与亮度平面上的、分辨率为 <code>a x 2</code> 的小块之间的关系。</p>
<ul>
<li><code>a</code> 是水平采样参考 (通常是 4)，</li>
<li><code>x</code> 是第一行的色度样本数（相对于 a 的水平分辨率），</li>
<li><code>y</code> 是第二行的色度样本数。</li>
</ul>
<blockquote>
<p>存在的一个例外是 4:1:0，其在每个亮度平面分辨率为 4 x 4 的块内提供一个色度样本。</p>
</blockquote>
<p>现代编解码器中使用的常用方案是： 4:4:4 (没有子采样)**, 4:2:2, 4:1:1, 4:2:0, 4:1:0 and 3:1:1。</p>
<blockquote>
<p>YCbCr 4:2:0 合并</p>
<p>这是使用 YCbCr 4:2:0 合并的一个图像的一块，注意我们每像素只花费 12bit。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/ycbcr_420_merge.png" alt="YCbCr 4:2:0 合并" title="YCbCr 4:2:0 合并"></p>
</blockquote>
<p>下图是同一张图片使用几种主要的色度子采样技术进行编码，第一行图像是最终的 YCbCr，而最后一行图像展示了色度的分辨率。这么小的损失确实是一个伟大的胜利。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/chroma_subsampling_examples.jpg" alt="色度子采样例子" title="色度子采样例子"></p>
<p>前面我们计算过我们需要 <a href="#%E6%B6%88%E9%99%A4%E5%86%97%E4%BD%99">278GB 去存储一个一小时长，分辨率在720p和30fps的视频文件</a>。如果我们使用 <code>YCbCr 4:2:0</code> 我们能剪掉<code>一半的大小（139GB）</code><sup>*</sup>，但仍然不够理想。</p>
<blockquote>
<p><sup>*</sup> 我们通过将宽、高、颜色深度和 fps 相乘得出这个值。前面我们需要 24 bit，现在我们只需要 12 bit。</p>
</blockquote>
<blockquote>
<h3 id="自己动手：检查-ycbcr-直方图">自己动手：检查 YCbCr 直方图</h3>
<p>你可以<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#generates-yuv-histogram">使用 ffmpeg 检查 YCbCr 直方图</a>。这个场景有更多的蓝色贡献，由<a href="https://en.wikipedia.org/wiki/Histogram">直方图</a>显示。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/yuv_histogram.png" alt="ycbcr 颜色直方图" title="ycbcr 颜色直方图"></p>
</blockquote>
<h2 id="帧类型">帧类型</h2>
<p>现在我们进一步消除<code>时间冗余</code>，但在这之前让我们来确定一些基本术语。假设我们一段 30fps 的影片，这是最开始的 4 帧。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_1.png" alt="球 1" title="球 1"> <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_2.png" alt="球 2" title="球 2"> <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_3.png" alt="球 3" title="球 3"><br>
<img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_4.png" alt="球 4" title="球 4"></p>
<p>我们可以在帧内看到<strong>很多重复内容</strong>，如<strong>蓝色背景</strong>，从 0 帧到第 3 帧它都没有变化。为了解决这个问题，我们可以将它们<strong>抽象地分类</strong>为三种类型的帧。</p>
<h3 id="i-帧-帧内编码-关键帧">I 帧（帧内编码，关键帧）</h3>
<p>I 帧（可参考，关键帧，帧内编码）是一个<strong>自足的帧</strong>。它不依靠任何东西来渲染，I 帧与静态图片相似。第一帧通常是 I 帧，但我们将看到 I 帧被定期插入其它类型的帧之间。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_1.png" alt="球 1" title="球 1"></p>
<h3 id="p-帧-预测">P 帧（预测）</h3>
<p>P 帧利用了一个事实：当前的画面几乎总能<strong>使用之前的一帧进行渲染</strong>。例如，在第二帧，唯一的改变是球向前移动了。仅仅使用（第二帧）对前一帧的引用和差值，我们就能重建前一帧。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_1.png" alt="球 1" title="球 1"> &lt;-  <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_2_diff.png" alt="球 2" title="球 2"></p>
<blockquote>
<h4 id="自己动手：具有单个-i-帧的视频">自己动手：具有单个 I 帧的视频</h4>
<p>既然 P 帧使用较少的数据，为什么我们不能用<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#1-i-frame-and-the-rest-p-frames">单个 I 帧和其余的 P 帧</a>来编码整个视频？</p>
<p>编码完这个视频之后，开始观看它，并<strong>快进到视频的末尾部分</strong>，你会注意到<strong>它需要花一些时间</strong>才真正跳转到这部分。这是因为 <strong>P 帧需要一个引用帧</strong>（比如 I 帧）才能渲染。</p>
<p>你可以做的另一个快速试验，是使用单个 I 帧编码视频，然后<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#1-i-frames-per-second-vs-05-i-frames-per-second">再次编码且每 2 秒插入一个 I 帧</a>，并<strong>比较成品的大小</strong>。</p>
</blockquote>
<h3 id="b-帧-双向预测">B 帧（双向预测）</h3>
<p>如何引用前面和后面的帧去做更好的压缩？！简单地说 B 帧就是这么做的。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_1.png" alt="球 1" title="球 1"> &lt;-  <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_2_diff.png" alt="球 2" title="球 2"> -&gt; <img src="/2020/02/28/Introduction-to-digital-video-technology/smw_background_ball_3.png" alt="球 3" title="球 3"></p>
<blockquote>
<h4 id="自己动手：使用-b-帧比较视频">自己动手：使用 B 帧比较视频</h4>
<p>你可以生成两个版本，一个使用 B 帧，另一个<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#no-b-frames-at-all">全部不使用 B 帧</a>，然后查看文件的大小以及画质。</p>
</blockquote>
<h3 id="小结">小结</h3>
<p>这些帧类型用于提供更好的压缩率，我们将在下一章看到这是如何发生的。现在，我们可以想到 I 帧是昂贵的，P 帧是便宜的，最便宜的是 B 帧。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/frame_types.png" alt="帧类型例子" title="帧类型例子"></p>
<h2 id="时间冗余-帧间预测">时间冗余（帧间预测）</h2>
<p>让我们探究去除<strong>时间上的重复</strong>，去除这一类冗余的技术就是<strong>帧间预测</strong>。</p>
<p>我们将尝试<strong>花费较少的数据量</strong>去编码在时间上连续的 0 号帧和 1 号帧。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/original_frames.png" alt="原始帧" title="原始帧"></p>
<p>我们可以做个减法，我们简单地<strong>用 0 号帧减去 1 号帧</strong>，得到残差，这样我们就只需要<strong>对残差进行编码</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/difference_frames.png" alt="残差帧" title="残差帧"></p>
<p>但我们有一个<strong>更好的方法</strong>来节省数据量。首先，我们将<code>0 号帧</code> 视为一个个分块的集合，然后我们将尝试将 <code>帧 1</code> 和 <code>帧 0</code> 上的块相匹配。我们可以将这看作是<strong>运动预测</strong>。</p>
<blockquote>
<h3 id="维基百科-块运动补偿">维基百科—块运动补偿</h3>
<p>“运动补偿是一种描述相邻帧（相邻在这里表示在编码关系上相邻，在播放顺序上两帧未必相邻）差别的方法，具体来说是描述前面一帧（相邻在这里表示在编码关系上的前面，在播放顺序上未必在当前帧前面）的每个小块怎样移动到当前帧中的某个位置去。”</p>
</blockquote>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/original_frames_motion_estimation.png" alt="原始帧运动预测" title="原始帧运动预测"></p>
<p>我们预计那个球会从 <code>x=0, y=25</code> 移动到 <code>x=6, y=26</code>，<strong>x</strong> 和 <strong>y</strong> 的值就是<strong>运动向量</strong>。<strong>进一步</strong>节省数据量的方法是，只编码这两者运动向量的差。所以，最终运动向量就是 <code>x=6 (6-0), y=1 (26-25)</code>。</p>
<blockquote>
<p>实际情况下，这个球会被切成 n 个分区，但处理过程是相同的。</p>
</blockquote>
<p>帧上的物体<strong>以三维方式移动</strong>，当球移动到背景时会变小。当我们尝试寻找匹配的块，<strong>找不到完美匹配的块</strong>是正常的。这是一张运动预测与实际值相叠加的图片。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/motion_estimation.png" alt="运动预测" title="运动预测"></p>
<p>但我们能看到当我们使用<strong>运动预测</strong>时，<strong>编码的数据量少于</strong>使用简单的残差帧技术。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/comparison_delta_vs_motion_estimation.png" alt="运动预测 vs 残差 " title="运动预测 vs 残差"></p>
<p>你可以<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/frame_difference_vs_motion_estimation_plus_residual.ipynb">使用 jupyter 玩转这些概念</a>。</p>
<blockquote>
<h3 id="自己动手：查看运动向量">自己动手：查看运动向量</h3>
<p>我们可以<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#generate-debug-video">使用 ffmpeg 生成包含帧间预测（运动向量）的视频</a>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/motion_vectors_ffmpeg.png" alt="ffmpeg 帧间预测（运动向量）" title="ffmpeg 帧间预测（运动向量）"></p>
<p>或者我们也可使用 <a href="https://software.intel.com/en-us/intel-video-pro-analyzer">Intel® Video Pro Analyzer</a>（需要付费，但也有只能查看前 10 帧的免费试用版）。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/inter_prediction_intel_video_pro_analyzer.png" alt="Intel® Video Pro Analyzer 使用帧间预测" title="inter prediction intel video pro analyzer"></p>
</blockquote>
<h2 id="空间冗余-帧内预测">空间冗余（帧内预测）</h2>
<p>如果我们分析一个视频里的<strong>每一帧</strong>，我们会看到有<strong>许多区域是相互关联的</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/repetitions_in_space.png" alt="空间内重复" title="空间内重复"></p>
<p>让我们举一个例子。这个场景大部分由蓝色和白色组成。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_bg.png" alt="smw 背景" title="smw 背景"></p>
<p>这是一个 <code>I 帧</code>，我们<strong>不能使用前面的帧来预测</strong>，但我们仍然可以压缩它。我们将编码我们选择的那块红色区域。如果我们<strong>看看它的周围</strong>，我们可以<strong>估计它周围颜色的变化</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_bg_block.png" alt="smw 背景块" title="smw 背景块"></p>
<p>我们预测:帧中的颜色在垂直方向上保持一致，这意味着<strong>未知像素的颜色与临近的像素相同</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_bg_prediction.png" alt="smw 背景预测" title="smw 背景预测"></p>
<p>我们的<strong>预测会出错</strong>，所以我们需要先利用这项技术（<strong>帧内预测</strong>），然后<strong>减去实际值</strong>，算出残差，得出的矩阵比原始数据更容易压缩。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/smw_residual.png" alt="smw 残差" title="smw 残差"></p>
<blockquote>
<h3 id="自己动手：查看帧内预测">自己动手：查看帧内预测</h3>
<p>你可以<a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#generate-debug-video">使用 ffmpeg 生成包含宏块及预测的视频</a>。请查看 ffmpeg 文档以了解<a href="https://trac.ffmpeg.org/wiki/Debug/MacroblocksAndMotionVectors">每个块颜色的含义</a>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/macro_blocks_ffmpeg.png" alt="ffmpeg 帧内预测（宏块）" title="ffmpeg 帧内预测（宏块）"></p>
<p>或者我们也可使用 <a href="https://software.intel.com/en-us/intel-video-pro-analyzer">Intel® Video Pro Analyzer</a>（需要付费，但也有只能查看前 10 帧的免费试用版）。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/intra_prediction_intel_video_pro_analyzer.png" alt="Intel® Video Pro Analyzer 帧内预测" title="Intel® Video Pro Analyzer 帧内预测"></p>
</blockquote>
<h1>视频编解码器是如何工作的？</h1>
<h2 id="是什么？为什么？怎么做？">是什么？为什么？怎么做？</h2>
<p><strong>是什么？</strong> 就是用于压缩或解压数字视频的软件或硬件。<strong>为什么？</strong> 人们需要在有限带宽或存储空间下提高视频的质量。还记得当我们计算每秒 30 帧，每像素 24 bit，分辨率是 480x240 的视频<a href="#%E5%9F%BA%E6%9C%AC%E6%9C%AF%E8%AF%AD">需要多少带宽</a>吗？没有压缩时是 <strong>82.944 Mbps</strong>。电视或互联网提供 HD/FullHD/4K 只能靠视频编解码器。<strong>怎么做？</strong> 我们将简单介绍一下主要的技术。</p>
<blockquote>
<p>视频编解码 vs 容器</p>
<p>初学者一个常见的错误是混淆数字视频编解码器和<a href="https://en.wikipedia.org/wiki/Digital_container_format">数字视频容器</a>。我们可以将<strong>容器</strong>视为包含视频（也很可能包含音频）元数据的包装格式，<strong>压缩过的视频</strong>可以看成是它承载的内容。</p>
<p>通常，视频文件的格式定义其视频容器。例如，文件 <code>video.mp4</code> 可能是 <a href="https://en.wikipedia.org/wiki/MPEG-4_Part_14">MPEG-4 Part 14</a> 容器，一个叫 <code>video.mkv</code> 的文件可能是 <a href="https://en.wikipedia.org/wiki/Matroska">matroska</a>。我们可以使用 <a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#inspect-stream">ffmpeg 或 mediainfo</a> 来完全确定编解码器和容器格式。</p>
</blockquote>
<h2 id="历史">历史</h2>
<p>在我们跳进通用编解码器内部工作之前，让我们回头了解一些旧的视频编解码器。</p>
<p>视频编解码器 <a href="https://en.wikipedia.org/wiki/H.261">H.261</a> 诞生在 1990（技术上是 1988），被设计为以 <strong>64 kbit/s 的数据速率</strong>工作。它已经使用如色度子采样、宏块，等等理念。在 1995 年，<strong>H.263</strong> 视频编解码器标准被发布，并继续延续到 2001 年。</p>
<p>在 2003 年 <strong>H.264/AVC</strong> 的第一版被完成。在同一年，一家叫做 <strong>TrueMotion</strong> 的公司发布了他们的<strong>免版税</strong>有损视频压缩的视频编解码器，称为 <strong>VP3</strong>。在 2008 年，<strong>Google 收购了</strong>这家公司，在同一年发布 <strong>VP8</strong>。在 2012 年 12 月，Google 发布了 <strong>VP9</strong>，<strong>市面上大约有 3/4 的浏览器</strong>（包括手机）支持。</p>
<p><a href="https://en.wikipedia.org/wiki/AOMedia_Video_1">AV1</a> 是由 <strong>Google, Mozilla, Microsoft, Amazon, Netflix, AMD, ARM, NVidia, Intel, Cisco</strong> 等公司组成的<a href="http://aomedia.org/">开放媒体联盟（AOMedia）</a>设计的一种新的视频编解码器，免版税，开源。<strong>第一版</strong> 0.1.0 参考编解码器<strong>发布于 2016 年 4 月 7 号</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/codec_history_timeline.png" alt="编解码器历史线路图" title="编解码器历史线路图"></p>
<blockquote>
<h3 id="av1-的诞生">AV1 的诞生</h3>
<p>2015 年早期，Google 正在 VP10 上工作，Xiph (Mozilla) 正在 Daala 上工作，Cisco 开源了它的称为 Thor 的免版税视频编解码器。</p>
<p>接着 MPEG LA 宣布了 HEVC (H.265) 每年版税的的上限，比 H.264 高 8 倍，但很快他们又再次改变了条款：</p>
<ul>
<li><strong>不设年度收费上限</strong></li>
<li><strong>收取内容费</strong>（收入的 0.5%）</li>
<li><strong>每单位费用高于 h264 的 10 倍</strong></li>
</ul>
<p><a href="http://aomedia.org/about-us/">开放媒体联盟</a>由硬件厂商（Intel, AMD, ARM , Nvidia, Cisco），内容分发商（Google, Netflix, Amazon），浏览器维护者（Google, Mozilla），等公司创建。</p>
<p>这些公司有一个共同目标，一个免版税的视频编解码器，所以 AV1 诞生时使用了一个更<a href="http://aomedia.org/license/patent/">简单的专利许可证</a>。<strong>Timothy B. Terriberry</strong> 做了一个精彩的介绍，<a href="https://www.youtube.com/watch?v=lzPaldsmJbk">关于 AV1 的概念，许可证模式和它当前的状态</a>，就是本节的来源。</p>
<p>前往 <a href="http://aomanalyzer.org/">http://aomanalyzer.org/</a>， 你会惊讶于<strong>使用你的浏览器就可以分析 AV1 编解码器</strong>。<br>
<img src="/2020/02/28/Introduction-to-digital-video-technology/av1_browser_analyzer.png" alt="av1 浏览器分析器" title="浏览器分析器"></p>
<p>附：如果你想了解更多编解码器的历史，你需要了解<a href="https://www.vcodex.com/video-compression-patents/">视频压缩专利</a>背后的基本知识。</p>
</blockquote>
<h2 id="通用编解码器">通用编解码器</h2>
<p>我们接下来要介绍<strong>通用视频编解码器背后的主要机制</strong>，大多数概念都很实用，并被现代编解码器如 VP9, AV1 和 HEVC 使用。需要注意：我们将简化许多内容。有时我们会使用真实的例子（主要是 H.264）来演示技术。</p>
<h2 id="第一步-图片分区">第一步 - 图片分区</h2>
<p>第一步是<strong>将帧</strong>分成几个<strong>分区</strong>，<strong>子分区</strong>甚至更多。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/picture_partitioning.png" alt="图片分区" title="图片分区"></p>
<p>**但是为什么呢？**有许多原因，比如，当我们分割图片时，我们可以更精确的处理预测，在微小移动的部分使用较小的分区，而在静态背景上使用较大的分区。</p>
<p>通常，编解码器<strong>将这些分区组织</strong>成切片（或瓦片），宏（或编码树单元）和许多子分区。这些分区的最大大小有所不同，HEVC 设置成 64x64，而 AVC 使用 16x16，但子分区可以达到 4x4 的大小。</p>
<p>还记得我们学过的<strong>帧的分类</strong>吗？你也可以<strong>把这些概念应用到块</strong>，因此我们可以有 I 切片，B 切片，I 宏块等等。</p>
<blockquote>
<h3 id="自己动手：查看分区">自己动手：查看分区</h3>
<p>我们也可以使用 <a href="https://software.intel.com/en-us/intel-video-pro-analyzer">Intel® Video Pro Analyzer</a>（需要付费，但也有只能查看前 10 帧的免费试用版）。这是 <a href="https://github.com/leandromoreira/digital_video_introduction/blob/master/encoding_pratical_examples.md#transcoding">VP9 分区</a>的分析。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/paritions_view_intel_video_pro_analyzer.png" alt="Intel® Video Pro Analyzer VP9 分区视图 " title="Intel® Video Pro Analyzer VP9 分区视图"></p>
</blockquote>
<h2 id="第二步-预测">第二步 - 预测</h2>
<p>一旦我们有了分区，我们就可以在它们之上做出预测。对于<a href="#%E6%97%B6%E9%97%B4%E5%86%97%E4%BD%99%EF%BC%88%E5%B8%A7%E9%97%B4%E9%A2%84%E6%B5%8B%EF%BC%89">帧间预测</a>，我们需要<strong>发送运动向量和残差</strong>；至于<a href="#%E7%A9%BA%E9%97%B4%E5%86%97%E4%BD%99%EF%BC%88%E5%B8%A7%E5%86%85%E9%A2%84%E6%B5%8B%EF%BC%89">帧内预测</a>，我们需要<strong>发送预测方向和残差</strong>。</p>
<h2 id="第三步-转换">第三步 - 转换</h2>
<p>在我们得到残差块（<code>预测分区-真实分区</code>）之后，我们可以用一种方式<strong>变换</strong>它，这样我们就知道<strong>哪些像素我们应该丢弃</strong>，还依然能保持<strong>整体质量</strong>。这个确切的行为有几种变换方式。</p>
<p>尽管有<a href="https://en.wikipedia.org/wiki/List_of_Fourier-related_transforms#Discrete_transforms">其它的变换方式</a>，但我们重点关注离散余弦变换（DCT）。<a href="https://en.wikipedia.org/wiki/Discrete_cosine_transform">DCT</a> 的主要功能有：</p>
<ul>
<li>将<strong>像素</strong>块<strong>转换</strong>为相同大小的<strong>频率系数块</strong>。</li>
<li><strong>压缩</strong>能量，更容易消除空间冗余。</li>
<li><strong>可逆的</strong>，也意味着你可以还原回像素。</li>
</ul>
<blockquote>
<p>2017 年 2 月 2 号，F. M. Bayer 和 R. J. Cintra 发表了他们的论文：<a href="https://arxiv.org/abs/1702.00817">图像压缩的 DCT 类变换只需要 14 个加法</a>。</p>
</blockquote>
<p>如果你不理解每个要点的好处，不用担心，我们会尝试进行一些实验，以便从中看到真正的价值。</p>
<p>我们来看下面的<strong>像素块</strong>（8x8）：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/pixel_matrice.png" alt="像素值矩形" title="像素值矩形"></p>
<p>下面是其渲染的块图像（8x8）：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/gray_image.png" alt="像素值矩形" title="像素值矩形"></p>
<p>当我们对这个像素块<strong>应用 DCT</strong> 时， 得到如下<strong>系数块</strong>（8x8）：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dct_coefficient_values.png" alt="系数值 values" title="系数值"></p>
<p>接着如果我们渲染这个系数块，就会得到这张图片：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dct_coefficient_image.png" alt="dct 系数图片" title="dct 系数图片"></p>
<p>如你所见它看起来完全不像原图像，我们可能会注意到<strong>第一个系数</strong>与其它系数非常不同。第一个系数被称为直流分量，代表了输入数组中的<strong>所有样本</strong>，有点<strong>类似于平均值</strong>。</p>
<p>这个系数块有一个有趣的属性：高频部分和低频部分是分离的。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dctfrequ.jpg" alt="dct 频率系数属性" title="dct 频率系数属性"></p>
<p>在一张图像中，<strong>大多数能量</strong>会集中在<a href="https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm">低频部分</a>，所以如果我们将图像转换成频率系数，并<strong>丢掉高频系数</strong>，我们就能<strong>减少描述图像所需的数据量</strong>，而不会牺牲太多的图像质量。</p>
<blockquote>
<p>频率是指信号变化的速度。</p>
</blockquote>
<p>让我们通过实验学习这点，我们将使用 DCT 把原始图像转换为频率（系数块），然后丢掉最不重要的系数。</p>
<p>首先，我们将它转换为其<strong>频域</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dct_coefficient_values.png" alt="系数值" title="系数值"></p>
<p>然后我们丢弃部分（67%）系数，主要是它的右下角部分。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/dct_coefficient_zeroed.png" alt="系数清零" title="系数清零"></p>
<p>然后我们从丢弃的系数块重构图像（记住，这需要可逆），并与原始图像相比较。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/original_vs_quantized.png" alt="原始 vs 量化" title="原始 vs 量化"></p>
<p>如我们所见它酷似原始图像，但它引入了许多与原来的不同，我们<strong>丢弃了67.1875%</strong>，但我们仍然得到至少类似于原来的东西。我们可以更加智能的丢弃系数去得到更好的图像质量，但这是下一个主题。</p>
<blockquote>
<h3 id="使用全部像素形成每个系数">使用全部像素形成每个系数</h3>
<p>重要的是要注意，每个系数并不直接映射到单个像素，但它是所有像素的加权和。这个神奇的图形展示了如何计算出第一和第二个系数，使用每个唯一的索引做权重。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/applicat.jpg" alt="dct 计算" title="dct 计算"></p>
<p>来源：<a href="https://web.archive.org/web/20150129171151/https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm">https://web.archive.org/web/20150129171151/https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm</a></p>
<p>你也可以尝试<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/dct_better_explained.ipynb">通过查看在 DCT 基础上形成的简单图片来可视化 DCT</a>。例如，这是使用每个系数权重<a href="https://en.wikipedia.org/wiki/Discrete_cosine_transform#Example_of_IDCT">形成的字符 A</a>。</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Idct-animation.gif" alt></p>
</blockquote>
<br>
<blockquote>
<h3 id="自己动手：丢弃不同的系数">自己动手：丢弃不同的系数</h3>
<p>你可以玩转 <a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/uniform_quantization_experience.ipynb">DCT 变换</a></p>
</blockquote>
<h2 id="第四步-量化">第四步 - 量化</h2>
<p>当我们丢弃一些系数时，在最后一步（变换），我们做了一些形式的量化。这一步，我们选择性地剔除信息（<strong>有损部分</strong>）或者简单来说，我们将<strong>量化系数以实现压缩</strong>。</p>
<p>我们如何量化一个系数块？一个简单的方法是均匀量化，我们取一个块并<strong>将其除以单个的值</strong>（10），并舍入值。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/quantize.png" alt="量化" title="量化"></p>
<p>我们如何<strong>逆转</strong>（重新量化）这个系数块？我们可以通过<strong>乘以我们先前除以的相同的值</strong>（10）来做到。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/re-quantize.png" alt="逆转量化" title="逆转量化"></p>
<p>这<strong>不是最好的方法</strong>，因为它没有考虑到每个系数的重要性，我们可以使用一个<strong>量化矩阵</strong>来代替单个值，这个矩阵可以利用 DCT 的属性，多量化右下部，而少（量化）左上部，<a href="https://www.hdm-stuttgart.de/~maucher/Python/MMCodecs/html/jpegUpToQuant.html">JPEG 使用了类似的方法</a>，你可以通过<a href="https://github.com/google/guetzli/blob/master/guetzli/jpeg_data.h#L40">查看源码看看这个矩阵</a>。</p>
<blockquote>
<h3 id="自己动手：量化">自己动手：量化</h3>
<p>你可以玩转<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/28/Introduction-to-digital-video-technology/py/dct_experiences.ipynb">量化</a></p>
</blockquote>
<h2 id="第五步-熵编码">第五步 - 熵编码</h2>
<p>在我们量化数据（图像块／切片／帧）之后，我们仍然可以以无损的方式来压缩它。有许多方法（算法）可用来压缩数据。我们将简单体验其中几个，你可以阅读这本很棒的书去深入理解：<a href="https://www.amazon.com/Understanding-Compression-Data-Modern-Developers/dp/1491961538/">Understanding Compression: Data Compression for Modern Developers</a>。</p>
<h3 id="vlc-编码：">VLC 编码：</h3>
<p>让我们假设我们有一个符号流：<strong>a</strong>, <strong>e</strong>, <strong>r</strong> 和 <strong>t</strong>，它们的概率（从0到1）由下表所示。</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>e</th>
<th>r</th>
<th>t</th>
</tr>
</thead>
<tbody>
<tr>
<td>概率</td>
<td>0.3</td>
<td>0.3</td>
<td>0.2</td>
<td>0.2</td>
</tr>
</tbody>
</table>
<p>我们可以分配不同的二进制码，（最好是）小的码给最可能（出现的字符），大些的码给最少可能（出现的字符）。</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>e</th>
<th>r</th>
<th>t</th>
</tr>
</thead>
<tbody>
<tr>
<td>概率</td>
<td>0.3</td>
<td>0.3</td>
<td>0.2</td>
<td>0.2</td>
</tr>
<tr>
<td>二进制码</td>
<td>0</td>
<td>10</td>
<td>110</td>
<td>1110</td>
</tr>
</tbody>
</table>
<p>让我们压缩 <strong>eat</strong> 流，假设我们为每个字符花费 8 bit，在没有做任何压缩时我们将花费 <strong>24 bit</strong>。但是在这种情况下，我们使用各自的代码来替换每个字符，我们就能节省空间。</p>
<p>第一步是编码字符 <strong>e</strong> 为 <code>10</code>，第二个字符是 <strong>a</strong>，追加（不是数学加法）后是 <code>[10][0]</code>，最后是第三个字符 <strong>t</strong>，最终组成已压缩的比特流 <code>[10][0][1110]</code> 或 <code>1001110</code>，这只需 <strong>7 bit</strong>（比原来的空间少 3.4 倍）。</p>
<p>请注意每个代码必须是唯一的前缀码，<a href="https://en.wikipedia.org/wiki/Huffman_coding">Huffman 能帮你找到这些数字</a>。虽然它有一些问题，但是<a href="https://en.wikipedia.org/wiki/Context-adaptive_variable-length_coding">视频编解码器仍然提供该方法</a>，它也是很多应用程序的压缩算法。</p>
<p>编码器和解码器都<strong>必须知道</strong>这个（包含编码的）字符表，因此，你也需要传送这个表。</p>
<h3 id="算术编码">算术编码</h3>
<p>让我们假设我们有一个符号流：<strong>a</strong>, <strong>e</strong>, <strong>r</strong>, <strong>s</strong> 和 <strong>t</strong>，它们的概率由下表所示。</p>
<table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>e</th>
<th>r</th>
<th>s</th>
<th>t</th>
</tr>
</thead>
<tbody>
<tr>
<td>概率</td>
<td>0.3</td>
<td>0.3</td>
<td>0.15</td>
<td>0.05</td>
<td>0.2</td>
</tr>
</tbody>
</table>
<p>考虑到这个表，我们可以构建一个区间，区间包含了所有可能的字符，字符按出现概率排序。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/range.png" alt="初始算法区间" title="初始算法区间"></p>
<p>让我们编码 <strong>eat</strong> 流，我们选择第一个字符 <strong>e</strong> 位于 <strong>0.3 到 0.6</strong> （但不包括 0.6）的子区间，我们选择这个子区间，按照之前同等的比例再次分割。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/second_subrange.png" alt="第二个子区间" title="第二个子区间"></p>
<p>让我们继续编码我们的流 <strong>eat</strong>，现在使第二个 <strong>a</strong> 字符位于 <strong>0.3 到 0.39</strong> 的区间里，接着再次用同样的方法编码最后的字符 <strong>t</strong>，得到最后的子区间 <strong>0.354 到 0.372</strong>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/arithimetic_range.png" alt="最终算法区间" title="最终算法区间"></p>
<p>我们只需从最后的子区间 0.354 到 0.372 里选择一个数，让我们选择 0.36，不过我们可以选择这个子区间里的任何数。仅靠这个数，我们将可以恢复原始流 <strong>eat</strong>。就像我们在区间的区间里画了一根线来编码我们的流。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/range_show.png" alt="最终区间横断面" title="最终区间横断面"></p>
<p><strong>反向过程</strong>（又名解码）一样简单，用数字 <strong>0.36</strong> 和我们原始区间，我们可以进行同样的操作，不过现在是使用这个数字来还原被编码的流。</p>
<p>在第一个区间，我们发现数字落入了一个子区间，因此，这个子区间是我们的第一个字符，现在我们再次切分这个子区间，像之前一样做同样的过程。我们会注意到 <strong>0.36</strong> 落入了 <strong>a</strong> 的区间，然后我们重复这一过程直到得到最后一个字符 <strong>t</strong>（形成我们原始编码过的流 eat）。</p>
<p>编码器和解码器都<strong>必须知道</strong>字符概率表，因此，你也需要传送这个表。</p>
<p>非常巧妙，不是吗？人们能想出这样的解决方案实在是太聪明了，一些<a href="https://en.wikipedia.org/wiki/Context-adaptive_binary_arithmetic_coding">视频编解码器使用</a>这项技术（或至少提供这一选择）。</p>
<p>关于无损压缩量化比特流的办法，这篇文章无疑缺少了很多细节、原因、权衡等等。作为一个开发者你<a href="https://www.amazon.com/Understanding-Compression-Data-Modern-Developers/dp/1491961538/">应该学习更多</a>。刚入门视频编码的人可以尝试使用不同的<a href="https://en.wikipedia.org/wiki/Asymmetric_Numeral_Systems">熵编码算法，如ANS</a>。</p>
<blockquote>
<h3 id="自己动手：cabac-vs-cavlc">自己动手：CABAC vs CAVLC</h3>
<p>你可以<a href="https://github.com/leandromoreira/introduction_video_technology/blob/master/encoding_pratical_examples.md#cabac-vs-cavlc">生成两个流，一个使用 CABAC，另一个使用 CAVLC</a>，并比较生成每一个的时间以及最终的大小。</p>
</blockquote>
<h2 id="第六步-比特流格式">第六步 - 比特流格式</h2>
<p>完成所有这些步之后，我们需要将<strong>压缩过的帧和内容打包进去</strong>。需要明确告知解码器<strong>编码定义</strong>，如颜色深度，颜色空间，分辨率，预测信息（运动向量，帧内预测方向），配置<sup>*</sup>，层级<sup>*</sup>，帧率，帧类型，帧号等等更多信息。</p>
<blockquote>
<p><sup>*</sup> 译注：原文为 profile 和 level，没有通用的译名</p>
</blockquote>
<p>我们将简单地学习 H.264 比特流。第一步是<a href="https://github.com/leandromoreira/introduction_video_technology/blob/master/encoding_pratical_examples.md#generate-a-single-frame-h264-bitstream">生成一个小的 H.264<sup>*</sup> 比特流</a>，可以使用本 repo 和 <a href="http://ffmpeg.org/">ffmpeg</a> 来做。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;s&#x2F;ffmpeg -i &#x2F;files&#x2F;i&#x2F;minimal.png -pix_fmt yuv420p &#x2F;files&#x2F;v&#x2F;minimal_yuv420.h264</span><br></pre></td></tr></table></figure>
<blockquote>
<p><sup>*</sup> ffmpeg 默认将所有参数添加为 <strong>SEI NAL</strong>，很快我们会定义什么是 NAL。</p>
</blockquote>
<p>这个命令会使用下面的图片作为帧，生成一个具有<strong>单个帧</strong>，64x64 和颜色空间为 yuv420 的原始 h264 比特流。</p>
<blockquote>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/minimal.png" alt="使用帧来生成极简 h264 比特流" title="使用帧来生成极简 h264 比特流"></p>
</blockquote>
<h3 id="h-264-比特流">H.264 比特流</h3>
<p>AVC (H.264) 标准规定信息将在宏帧（网络概念上的）内传输，称为 <a href="https://en.wikipedia.org/wiki/Network_Abstraction_Layer">NAL</a>（网络抽象层）。NAL 的主要目标是提供“网络友好”的视频呈现方式，该标准必须适用于电视（基于流），互联网（基于数据包）等。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/nal_units.png" alt="H.264 NAL 单元" title="H.264 NAL 单元"></p>
<p><a href="https://en.wikipedia.org/wiki/Frame_synchronization">同步标记</a>用来定义 NAL 单元的边界。每个同步标记的值固定为  <code>0x00 0x00 0x01</code> ，最开头的标记例外，它的值是  <code>0x00 0x00 0x00 0x01</code> 。如果我们在生成的 h264 比特流上运行 <strong>hexdump</strong>，我们可以在文件的开头识别至少三个 NAL。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/minimal_yuv420_hex.png" alt="NAL 单元上的同步标记" title="NAL 单元上的同步标记"></p>
<p>我们之前说过，解码器需要知道不仅仅是图片数据，还有视频的详细信息，如：帧、颜色、使用的参数等。每个 NAL 的<strong>第一位</strong>定义了其分类和<strong>类型</strong>。</p>
<table>
<thead>
<tr>
<th>NAL type id</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Undefined</td>
</tr>
<tr>
<td>1</td>
<td>Coded slice of a non-IDR picture</td>
</tr>
<tr>
<td>2</td>
<td>Coded slice data partition A</td>
</tr>
<tr>
<td>3</td>
<td>Coded slice data partition B</td>
</tr>
<tr>
<td>4</td>
<td>Coded slice data partition C</td>
</tr>
<tr>
<td>5</td>
<td><strong>IDR</strong> Coded slice of an IDR picture</td>
</tr>
<tr>
<td>6</td>
<td><strong>SEI</strong> Supplemental enhancement information</td>
</tr>
<tr>
<td>7</td>
<td><strong>SPS</strong> Sequence parameter set</td>
</tr>
<tr>
<td>8</td>
<td><strong>PPS</strong> Picture parameter set</td>
</tr>
<tr>
<td>9</td>
<td>Access unit delimiter</td>
</tr>
<tr>
<td>10</td>
<td>End of sequence</td>
</tr>
<tr>
<td>11</td>
<td>End of stream</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>通常，比特流的第一个 NAL 是 <strong>SPS</strong>，这个类型的 NAL 负责传达通用编码参数，如<strong>配置，层级，分辨率</strong>等。</p>
<p>如果我们跳过第一个同步标记，就可以通过解码<strong>第一个字节</strong>来了解第一个 <strong>NAL 的类型</strong>。</p>
<p>例如同步标记之后的第一个字节是 <code>01100111</code>，第一位（<code>0</code>）是 <strong>forbidden_zero_bit</strong> 字段，接下来的两位（<code>11</code>）告诉我们是 <strong>nal_ref_idc</strong> 字段，其表示该 NAL 是否是参考字段，其余 5 位（<code>00111</code>）告诉我们是 <strong>nal_unit_type</strong> 字段，在这个例子里是 NAL 单元 <strong>SPS</strong> (7)。</p>
<p>SPS NAL 的第 2 位 (<code>binary=01100100, hex=0x64, dec=100</code>) 是 <strong>profile_idc</strong> 字段，显示编码器使用的配置，在这个例子里，我们使用<a href="https://en.wikipedia.org/wiki/H.264/MPEG-4_AVC#Profiles">受限高配置</a>，一种没有 B（双向预测） 切片支持的高配置。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/minimal_yuv420_bin.png" alt="SPS 二进制视图" title="SPS 二进制视图"></p>
<p>当我们阅读 SPS NAL 的 H.264 比特流规范时，会为<strong>参数名称</strong>，<strong>分类</strong>和<strong>描述</strong>找到许多值，例如，看看字段 <code>pic_width_in_mbs_minus_1</code> 和 <code>pic_height_in_map_units_minus_1</code>。</p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>分类</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>pic_width_in_mbs_minus_1</td>
<td>0</td>
<td>ue(v)</td>
</tr>
<tr>
<td>pic_height_in_map_units_minus_1</td>
<td>0</td>
<td>ue(v)</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>ue(v)</strong>: 无符号整形 <a href="https://pythonhosted.org/bitstring/exp-golomb.html">Exp-Golomb-coded</a></p>
</blockquote>
<p>如果我们对这些字段的值进行一些计算，将最终得出<strong>分辨率</strong>。我们可以使用值为 <code>119（ (119 + 1) * macroblock_size = 120 * 16 = 1920）</code>的 <code>pic_width_in_mbs_minus_1</code> 表示 <code>1920 x 1080</code>，再次为了减少空间，我们使用 <code>119</code> 来代替编码 <code>1920</code>。</p>
<p>如果我们再次使用二进制视图检查我们创建的视频 (ex: <code>xxd -b -c 11 v/minimal_yuv420.h264</code>)，可以跳到帧自身上一个 NAL。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/slice_nal_idr_bin.png" alt="h264 idr 切片头" title="h264 idr 切片头"></p>
<p>我们可以看到最开始的 6 个字节：<code>01100101 10001000 10000100 00000000 00100001 11111111</code>。我们已经知道第一个字节告诉我们 NAL 的类型，在这个例子里， (<code>00101</code>) 是 <strong>IDR 切片 (5)</strong>，可以进一步检查它：</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/slice_header.png" alt="h264 切片头规格" title="h264 切片头规格"></p>
<p>对照规范，我们能解码切片的类型（<strong>slice_type</strong>），帧号（<strong>frame_num</strong>）等重要字段。</p>
<p>为了获得一些字段（<code>ue(v), me(v), se(v) 或 te(v)</code>）的值，我们需要称为 <a href="https://pythonhosted.org/bitstring/exp-golomb.html">Exponential-Golomb</a> 的特定解码器来解码它。当存在很多默认值时，这个方法编码变量值特别高效。</p>
<blockquote>
<p>这个视频里 <strong>slice_type</strong> 和 <strong>frame_num</strong> 的值是 7（I 切片）和 0（第一帧）。</p>
</blockquote>
<p>我们可以将<strong>比特流视为一个协议</strong>，如果你想学习更多关于比特流的内容，请参考 <a href="http://www.itu.int/rec/T-REC-H.264-201610-I">ITU H.264 规范</a>。这个宏观图展示了图片数据（压缩过的 YUV）所在的位置。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/h264_bitstream_macro_diagram.png" alt="h264 比特流宏观图" title="h264 比特流宏观图"></p>
<p>我们可以探究其它比特流，如 <a href="https://storage.googleapis.com/downloads.webmproject.org/docs/vp9/vp9-bitstream-specification-v0.6-20160331-draft.pdf">VP9 比特流</a>，<a href="http://handle.itu.int/11.1002/1000/11885-en?locatt=format:pdf">H.265（HEVC）</a>或是我们的新朋友 <a href="https://medium.com/@mbebenita/av1-bitstream-analyzer-d25f1c27072b#.d5a89oxz8">AV1 比特流</a>，<a href="http://www.gpac-licensing.com/2016/07/12/vp9-av1-bitstream-format/">他们很相似吗？不</a>，但只要学习了其中之一，学习其他的就简单多了。</p>
<blockquote>
<h3 id="自己动手：检查-h-264-比特流">自己动手：检查 H.264 比特流</h3>
<p>我们可以<a href="https://github.com/leandromoreira/introduction_video_technology/blob/master/encoding_pratical_examples.md#generate-a-single-frame-video">生成一个单帧视频</a>，使用 <a href="https://en.wikipedia.org/wiki/MediaInfo">mediainfo</a> 检查它的 H.264 比特流。事实上，你甚至可以查看<a href="https://github.com/MediaArea/MediaInfoLib/blob/master/Source/MediaInfo/Video/File_Avc.cpp">解析 h264(AVC) 视频流的源代码</a>。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/mediainfo_details_1.png" alt="mediainfo h264 比特流的详情 " title="mediainfo h264 比特流的详情"></p>
<p>我们也可使用 <a href="https://software.intel.com/en-us/intel-video-pro-analyzer">Intel® Video Pro Analyzer</a>，需要付费，但也有只能查看前 10 帧的免费试用版，这已经够达成学习目的了。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/intel-video-pro-analyzer.png" alt="Intel® Video Pro Analyzer h264 比特流的详情" title="Intel® Video Pro Analyzer h264 比特流的详情"></p>
</blockquote>
<blockquote>
<h3 id="关于h264-我们还需要了解什么？">关于H264，我们还需要了解什么？</h3>
<p>除了如上对H264码流的介绍外，H264还有很多其他的内容需要了解，例如：X264和H264之间的关系是什么？H264未来会被其他的新型编解码器所代替吗？……关于这些信息可以参考：<a href="https://www.videoproc.com/resource/h264-codec.htm">https://www.videoproc.com/resource/h264-codec.htm</a>。</p>
</blockquote>
<h2 id="回顾">回顾</h2>
<p>我们可以看到我们学了许多<strong>使用相同模型的现代编解码器</strong>。事实上，让我们看看 Thor 视频编解码器框图，它包含所有我们学过的步骤。你现在应该能更好地理解数字视频领域内的创新和论文。<br>
<img src="/2020/02/28/Introduction-to-digital-video-technology/thor_codec_block_diagram.png" alt="thor 编解码器块图" title="thor 编解码器块图"></p>
<p>之前我们计算过我们<a href="#%E8%89%B2%E5%BA%A6%E5%AD%90%E9%87%87%E6%A0%B7">需要 139GB 来保存一个一小时，720p 分辨率和30fps的视频文件</a>，如果我们使用在这里学过的技术，如<strong>帧间和帧内预测，转换，量化，熵编码和其它</strong>我们能实现——假设我们<strong>每像素花费 0.031 bit</strong>——同样观感质量的视频，<strong>对比 139GB 的存储，只需 367.82MB</strong>。</p>
<blockquote>
<p>我们根据这里提供的示例视频选择<strong>每像素使用 0.031 bit</strong>。</p>
</blockquote>
<h2 id="h-265-如何实现比-h-264-更好的压缩率">H.265 如何实现比 H.264 更好的压缩率</h2>
<p>我们已经更多地了解了编解码器的工作原理，那么就容易理解新的编解码器如何使用更少的数据量传输更高分辨率的视频。</p>
<p>我们将比较 AVC 和 HEVC，要记住的是：我们几乎总是要在压缩率和更多的 CPU 周期（复杂度）之间作权衡。</p>
<p>HEVC 比 AVC 有更大和更多的<strong>分区</strong>（和<strong>子分区</strong>）选项，更多<strong>帧内预测方向</strong>，<strong>改进的熵编码</strong>等，所有这些改进使得 H.265 比 H.264 的压缩率提升 50%。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/avc_vs_hevc.png" alt="h264 vs h265" title="H.264 vs H.265"></p>
<h1>在线流媒体</h1>
<h2 id="通用架构">通用架构</h2>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/general_architecture.png" alt="general_architecture"></p>
<p>[TODO]</p>
<h2 id="渐进式下载和自适应流">渐进式下载和自适应流</h2>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/progressive_download.png" alt="progressive_download"></p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/adaptive_streaming.png" alt="adaptive_streaming"></p>
<p>[TODO]</p>
<h2 id="内容保护">内容保护</h2>
<p>我们可以用一个简单的令牌认证系统来保护视频。用户需要拥有一个有效的令牌才可以播放视频，CDN 会拒绝没有令牌的用户的请求。它与大多数网站的身份认证系统非常相似。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/token_protection.png" alt="token_protection"></p>
<p>仅仅使用令牌认证系统，用户仍然可以下载并重新分发视频。DRM 系统可以用来避免这种情况。</p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/drm.png" alt="drm"></p>
<p>实际情况下，人们通常同时使用这两种技术提供授权和认证。</p>
<h3 id="drm">DRM</h3>
<h4 id="主要系统">主要系统</h4>
<ul>
<li>FPS - <a href="https://developer.apple.com/streaming/fps/"><strong>FairPlay Streaming</strong></a></li>
<li>PR - <a href="https://www.microsoft.com/playready/"><strong>PlayReady</strong></a></li>
<li>WV - <a href="http://www.widevine.com/"><strong>Widevine</strong></a></li>
</ul>
<h4 id="是什么">是什么</h4>
<p>DRM 指的是数字版权管理，是一种<strong>为数字媒体提供版权保护</strong>的方法，例如数字视频和音频。尽管用在了很多场合，但它并<a href="https://en.wikipedia.org/wiki/Digital_rights_management#DRM-free_works">没有被普遍接受</a>.</p>
<h4 id="为什么">为什么</h4>
<p>内容的创作者（大多是工作室/制片厂）希望保护他们的知识产权，使他们的数字媒体免遭未经授权的分发。</p>
<h4 id="怎么做">怎么做</h4>
<p>我们将用一种简单的、抽象的方式描述 DRM</p>
<p>现有一份<strong>内容 C1</strong>（如 HLS 或 DASH 视频流），一个<strong>播放器 P1</strong>（如 shaka-clappr, exo-player 或 iOS），装在<strong>设备 D1</strong>（如智能手机、电视或台式机/笔记本）上，使用 <strong>DRM 系统 DRM1</strong>（如 FairPlay Streaming, PlayReady, Widevine）</p>
<p>内容 C1 由 DRM1 用一个<strong>对称密钥 K1</strong> 加密，生成<strong>加密内容 C’1</strong></p>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/drm_general_flow.jpeg" alt="DRM 一般流程" title="DRM 一般流程"></p>
<p>设备 D1 上的播放器 P1 有一个非对称密钥对，密钥对包含一个<strong>私钥 PRK1</strong>（这个密钥是受保护的<sup>1</sup>，只有 <strong>D1</strong> 知道密钥内容），和一个<strong>公钥 PUK1</strong></p>
<blockquote>
<p><strong><sup>1</sup>受保护的</strong>: 这种保护可以<strong>通过硬件</strong>进行保护，例如, 将这个密钥存储在一个特殊的芯片（只读）中，芯片的工作方式就像一个用来解密的[黑箱]。 或<strong>通过软件</strong>进行保护（较低的安全系数）。DRM 系统提供了识别设备所使用的保护类型的方法。</p>
</blockquote>
<p>当 <strong>播放器 P1 希望播放****加密内容 C’1</strong> 时，它需要与 <strong>DRM1</strong> 协商，将公钥 <strong>PUK1</strong> 发送给 DRM1, DRM1 会返回一个被公钥 <strong>PUK1</strong> <strong>加密过的 K1</strong>。按照推论，结果就是<strong>只有 D1 能够解密</strong>。</p>
<p><code>K1P1D1 = enc(K1, PUK1)</code></p>
<p><strong>P1</strong> 使用它的本地 DRM 系统（这可以使用 <a href="https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%8A%AF%E7%89%87">SoC</a> ，一个专门的硬件和软件，这个系统可以使用它的私钥 PRK1 用来<strong>解密</strong>内容，它可以解密被加密过的<strong>K1P1D1 的对称密钥 K1</strong>。理想情况下，密钥不会被导出到内存以外的地方。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">K1 &#x3D; dec(K1P1D1, PRK1)</span><br><span class="line"></span><br><span class="line">P1.play(dec(C&#39;1, K1))</span><br></pre></td></tr></table></figure>
<p><img src="/2020/02/28/Introduction-to-digital-video-technology/drm_decoder_flow.jpeg" alt="DRM 解码流程" title="DRM 解码流程"></p>
<h1>如何使用 jupyter</h1>
<p>确保你已安装 docker，只需运行 <code>./s/start_jupyter.sh</code>，然后按照控制台的说明进行操作。</p>
<h1>会议</h1>
<ul>
<li><a href="https://demuxed.com/">DEMUXED</a> - 您可以<a href="https://www.youtube.com/channel/UCIc_DkRxo9UgUSTvWVNCmpA">查看最近的2个活动演示</a>。</li>
</ul>
<h1>参考</h1>
<p>这里有最丰富的资源，这篇文档包含的信息，均摘录、依据或受它们启发。你可以用这些精彩的链接，书籍，视频等深化你的知识。</p>
<p>在线课程和教程：</p>
<ul>
<li><a href="https://www.coursera.org/learn/digital/">https://www.coursera.org/learn/digital/</a></li>
<li><a href="https://people.xiph.org/~tterribe/pubs/lca2012/auckland/intro_to_video1.pdf">https://people.xiph.org/~tterribe/pubs/lca2012/auckland/intro_to_video1.pdf</a></li>
<li><a href="https://xiph.org/video/vid1.shtml">https://xiph.org/video/vid1.shtml</a></li>
<li><a href="https://xiph.org/video/vid2.shtml">https://xiph.org/video/vid2.shtml</a></li>
<li><a href="http://slhck.info/ffmpeg-encoding-course">http://slhck.info/ffmpeg-encoding-course</a></li>
<li><a href="http://www.cambridgeincolour.com/tutorials/camera-sensors.htm">http://www.cambridgeincolour.com/tutorials/camera-sensors.htm</a></li>
<li><a href="http://www.slideshare.net/vcodex/a-short-history-of-video-coding">http://www.slideshare.net/vcodex/a-short-history-of-video-coding</a></li>
<li><a href="http://www.slideshare.net/vcodex/introduction-to-video-compression-13394338">http://www.slideshare.net/vcodex/introduction-to-video-compression-1339433</a></li>
<li><a href="https://developer.android.com/guide/topics/media/media-formats.html">https://developer.android.com/guide/topics/media/media-formats.html</a></li>
<li><a href="http://www.slideshare.net/MadhawaKasun/audio-compression-23398426">http://www.slideshare.net/MadhawaKasun/audio-compression-23398426</a></li>
<li><a href="http://inst.eecs.berkeley.edu/~ee290t/sp04/lectures/02-Motion_Compensation_girod.pdf">http://inst.eecs.berkeley.edu/~ee290t/sp04/lectures/02-Motion_Compensation_girod.pdf</a></li>
</ul>
<p>书籍:</p>
<ul>
<li><a href="https://www.amazon.com/Understanding-Compression-Data-Modern-Developers/dp/1491961538/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1486395327&amp;sr=1-1">https://www.amazon.com/Understanding-Compression-Data-Modern-Developers/dp/1491961538/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1486395327&amp;sr=1-1</a></li>
<li><a href="https://www.amazon.com/H-264-Advanced-Video-Compression-Standard/dp/0470516925">https://www.amazon.com/H-264-Advanced-Video-Compression-Standard/dp/0470516925</a></li>
<li><a href="https://www.amazon.com/Practical-Guide-Video-Audio-Compression/dp/0240806301/ref=sr_1_3?s=books&amp;ie=UTF8&amp;qid=1486396914&amp;sr=1-3&amp;keywords=A+PRACTICAL+GUIDE+TO+VIDEO+AUDIO">https://www.amazon.com/Practical-Guide-Video-Audio-Compression/dp/0240806301/ref=sr_1_3?s=books&amp;ie=UTF8&amp;qid=1486396914&amp;sr=1-3&amp;keywords=A+PRACTICAL+GUIDE+TO+VIDEO+AUDIO</a></li>
<li><a href="https://www.amazon.com/Video-Encoding-Numbers-Eliminate-Guesswork/dp/0998453005/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1486396940&amp;sr=1-1&amp;keywords=jan+ozer">https://www.amazon.com/Video-Encoding-Numbers-Eliminate-Guesswork/dp/0998453005/ref=sr_1_1?s=books&amp;ie=UTF8&amp;qid=1486396940&amp;sr=1-1&amp;keywords=jan+ozer</a></li>
</ul>
<p>比特流规范:</p>
<ul>
<li><a href="http://www.itu.int/rec/T-REC-H.264-201610-I">http://www.itu.int/rec/T-REC-H.264-201610-I</a></li>
<li><a href="http://www.itu.int/ITU-T/recommendations/rec.aspx?rec=12904&amp;lang=en">http://www.itu.int/ITU-T/recommendations/rec.aspx?rec=12904&amp;lang=en</a></li>
<li><a href="https://storage.googleapis.com/downloads.webmproject.org/docs/vp9/vp9-bitstream-specification-v0.6-20160331-draft.pdf">https://storage.googleapis.com/downloads.webmproject.org/docs/vp9/vp9-bitstream-specification-v0.6-20160331-draft.pdf</a></li>
<li><a href="http://iphome.hhi.de/wiegand/assets/pdfs/2012_12_IEEE-HEVC-Overview.pdf">http://iphome.hhi.de/wiegand/assets/pdfs/2012_12_IEEE-HEVC-Overview.pdf</a></li>
<li><a href="http://phenix.int-evry.fr/jct/doc_end_user/current_document.php?id=7243">http://phenix.int-evry.fr/jct/doc_end_user/current_document.php?id=7243</a></li>
<li><a href="http://gentlelogic.blogspot.com.br/2011/11/exploring-h264-part-2-h264-bitstream.html">http://gentlelogic.blogspot.com.br/2011/11/exploring-h264-part-2-h264-bitstream.html</a></li>
</ul>
<p>软件:</p>
<ul>
<li><a href="https://ffmpeg.org/">https://ffmpeg.org/</a></li>
<li><a href="https://ffmpeg.org/ffmpeg-all.html">https://ffmpeg.org/ffmpeg-all.html</a></li>
<li><a href="https://ffmpeg.org/ffprobe.html">https://ffmpeg.org/ffprobe.html</a></li>
<li><a href="https://trac.ffmpeg.org/wiki/">https://trac.ffmpeg.org/wiki/</a></li>
<li><a href="https://software.intel.com/en-us/intel-video-pro-analyzer">https://software.intel.com/en-us/intel-video-pro-analyzer</a></li>
<li><a href="https://medium.com/@mbebenita/av1-bitstream-analyzer-d25f1c27072b#.d5a89oxz8">https://medium.com/@mbebenita/av1-bitstream-analyzer-d25f1c27072b#.d5a89oxz8</a></li>
</ul>
<p>非-ITU 编解码器:</p>
<ul>
<li><a href="https://aomedia.googlesource.com/">https://aomedia.googlesource.com/</a></li>
<li><a href="https://github.com/webmproject/libvpx/tree/master/vp9">https://github.com/webmproject/libvpx/tree/master/vp9</a></li>
<li><a href="https://people.xiph.org/~xiphmont/demo/daala/demo1.shtml">https://people.xiph.org/~xiphmont/demo/daala/demo1.shtml</a></li>
<li><a href="https://people.xiph.org/~jm/daala/revisiting/">https://people.xiph.org/~jm/daala/revisiting/</a></li>
<li><a href="https://www.youtube.com/watch?v=lzPaldsmJbk">https://www.youtube.com/watch?v=lzPaldsmJbk</a></li>
<li><a href="https://fosdem.org/2017/schedule/event/om_av1/">https://fosdem.org/2017/schedule/event/om_av1/</a></li>
</ul>
<p>编码概念:</p>
<ul>
<li><a href="http://x265.org/hevc-h265/">http://x265.org/hevc-h265/</a></li>
<li><a href="http://slhck.info/video/2017/03/01/rate-control.html">http://slhck.info/video/2017/03/01/rate-control.html</a></li>
<li><a href="http://slhck.info/video/2017/02/24/vbr-settings.html">http://slhck.info/video/2017/02/24/vbr-settings.html</a></li>
<li><a href="http://slhck.info/video/2017/02/24/crf-guide.html">http://slhck.info/video/2017/02/24/crf-guide.html</a></li>
<li><a href="https://arxiv.org/pdf/1702.00817v1.pdf">https://arxiv.org/pdf/1702.00817v1.pdf</a></li>
<li><a href="https://trac.ffmpeg.org/wiki/Debug/MacroblocksAndMotionVectors">https://trac.ffmpeg.org/wiki/Debug/MacroblocksAndMotionVectors</a></li>
<li><a href="http://web.ece.ucdavis.edu/cerl/ReliableJPEG/Cung/jpeg.html">http://web.ece.ucdavis.edu/cerl/ReliableJPEG/Cung/jpeg.html</a></li>
<li><a href="http://www.adobe.com/devnet/adobe-media-server/articles/h264_encoding.html">http://www.adobe.com/devnet/adobe-media-server/articles/h264_encoding.html</a></li>
<li><a href="https://prezi.com/8m7thtvl4ywr/mp3-and-aac-explained/">https://prezi.com/8m7thtvl4ywr/mp3-and-aac-explained/</a></li>
</ul>
<p>测试用视频序列:</p>
<ul>
<li><a href="http://bbb3d.renderfarming.net/download.html">http://bbb3d.renderfarming.net/download.html</a></li>
<li><a href="https://www.its.bldrdoc.gov/vqeg/video-datasets-and-organizations.aspx">https://www.its.bldrdoc.gov/vqeg/video-datasets-and-organizations.aspx</a></li>
</ul>
<p>杂项:</p>
<ul>
<li><a href="http://stackoverflow.com/a/24890903">http://stackoverflow.com/a/24890903</a></li>
<li><a href="http://stackoverflow.com/questions/38094302/how-to-understand-header-of-h264">http://stackoverflow.com/questions/38094302/how-to-understand-header-of-h264</a></li>
<li><a href="http://techblog.netflix.com/2016/08/a-large-scale-comparison-of-x264-x265.html">http://techblog.netflix.com/2016/08/a-large-scale-comparison-of-x264-x265.html</a></li>
<li><a href="http://vanseodesign.com/web-design/color-luminance/">http://vanseodesign.com/web-design/color-luminance/</a></li>
<li><a href="http://www.biologymad.com/nervoussystem/eyenotes.htm">http://www.biologymad.com/nervoussystem/eyenotes.htm</a></li>
<li><a href="http://www.compression.ru/video/codec_comparison/h264_2012/mpeg4_avc_h264_video_codecs_comparison.pdf">http://www.compression.ru/video/codec_comparison/h264_2012/mpeg4_avc_h264_video_codecs_comparison.pdf</a></li>
<li><a href="http://www.csc.villanova.edu/~rschumey/csc4800/dct.html">http://www.csc.villanova.edu/~rschumey/csc4800/dct.html</a></li>
<li><a href="http://www.explainthatstuff.com/digitalcameras.html">http://www.explainthatstuff.com/digitalcameras.html</a></li>
<li><a href="http://www.hkvstar.com">http://www.hkvstar.com</a></li>
<li><a href="http://www.hometheatersound.com/">http://www.hometheatersound.com/</a></li>
<li><a href="http://www.lighterra.com/papers/videoencodingh264/">http://www.lighterra.com/papers/videoencodingh264/</a></li>
<li><a href="http://www.red.com/learn/red-101/video-chroma-subsampling">http://www.red.com/learn/red-101/video-chroma-subsampling</a></li>
<li><a href="http://www.slideshare.net/ManoharKuse/hevc-intra-coding">http://www.slideshare.net/ManoharKuse/hevc-intra-coding</a></li>
<li><a href="http://www.slideshare.net/mwalendo/h264vs-hevc">http://www.slideshare.net/mwalendo/h264vs-hevc</a></li>
<li><a href="http://www.slideshare.net/rvarun7777/final-seminar-46117193">http://www.slideshare.net/rvarun7777/final-seminar-46117193</a></li>
<li><a href="http://www.springer.com/cda/content/document/cda_downloaddocument/9783642147029-c1.pdf">http://www.springer.com/cda/content/document/cda_downloaddocument/9783642147029-c1.pdf</a></li>
<li><a href="http://www.streamingmedia.com/Articles/Editorial/Featured-Articles/A-Progress-Report-The-Alliance-for-Open-Media-and-the-AV1-Codec-110383.aspx">http://www.streamingmedia.com/Articles/Editorial/Featured-Articles/A-Progress-Report-The-Alliance-for-Open-Media-and-the-AV1-Codec-110383.aspx</a></li>
<li><a href="http://www.streamingmediaglobal.com/Articles/ReadArticle.aspx?ArticleID=116505&amp;PageNum=1">http://www.streamingmediaglobal.com/Articles/ReadArticle.aspx?ArticleID=116505&amp;PageNum=1</a></li>
<li><a href="http://yumichan.net/video-processing/video-compression/introduction-to-h264-nal-unit/">http://yumichan.net/video-processing/video-compression/introduction-to-h264-nal-unit/</a></li>
<li><a href="https://cardinalpeak.com/blog/the-h-264-sequence-parameter-set/">https://cardinalpeak.com/blog/the-h-264-sequence-parameter-set/</a></li>
<li><a href="https://cardinalpeak.com/blog/worlds-smallest-h-264-encoder/">https://cardinalpeak.com/blog/worlds-smallest-h-264-encoder/</a></li>
<li><a href="https://codesequoia.wordpress.com/category/video/">https://codesequoia.wordpress.com/category/video/</a></li>
<li><a href="https://developer.apple.com/library/content/technotes/tn2224/_index.html">https://developer.apple.com/library/content/technotes/tn2224/_index.html</a></li>
<li><a href="https://en.wikibooks.org/wiki/MeGUI/x264_Settings">https://en.wikibooks.org/wiki/MeGUI/x264_Settings</a></li>
<li><a href="https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming">https://en.wikipedia.org/wiki/Adaptive_bitrate_streaming</a></li>
<li><a href="https://en.wikipedia.org/wiki/AOMedia_Video_1">https://en.wikipedia.org/wiki/AOMedia_Video_1</a></li>
<li><a href="https://en.wikipedia.org/wiki/Chroma_subsampling#/media/File:Colorcomp.jpg">https://en.wikipedia.org/wiki/Chroma_subsampling#/media/File:Colorcomp.jpg</a></li>
<li><a href="https://en.wikipedia.org/wiki/Cone_cell">https://en.wikipedia.org/wiki/Cone_cell</a></li>
<li><a href="https://en.wikipedia.org/wiki/File:H.264_block_diagram_with_quality_score.jpg">https://en.wikipedia.org/wiki/File:H.264_block_diagram_with_quality_score.jpg</a></li>
<li><a href="https://en.wikipedia.org/wiki/Inter_frame">https://en.wikipedia.org/wiki/Inter_frame</a></li>
<li><a href="https://en.wikipedia.org/wiki/Intra-frame_coding">https://en.wikipedia.org/wiki/Intra-frame_coding</a></li>
<li><a href="https://en.wikipedia.org/wiki/Photoreceptor_cell">https://en.wikipedia.org/wiki/Photoreceptor_cell</a></li>
<li><a href="https://en.wikipedia.org/wiki/Pixel_aspect_ratio">https://en.wikipedia.org/wiki/Pixel_aspect_ratio</a></li>
<li><a href="https://en.wikipedia.org/wiki/Presentation_timestamp">https://en.wikipedia.org/wiki/Presentation_timestamp</a></li>
<li><a href="https://en.wikipedia.org/wiki/Rod_cell">https://en.wikipedia.org/wiki/Rod_cell</a></li>
<li><a href="https://it.wikipedia.org/wiki/File:Pixel_geometry_01_Pengo.jpg">https://it.wikipedia.org/wiki/File:Pixel_geometry_01_Pengo.jpg</a></li>
<li><a href="https://leandromoreira.com.br/2016/10/09/how-to-measure-video-quality-perception/">https://leandromoreira.com.br/2016/10/09/how-to-measure-video-quality-perception/</a></li>
<li><a href="https://sites.google.com/site/linuxencoding/x264-ffmpeg-mapping">https://sites.google.com/site/linuxencoding/x264-ffmpeg-mapping</a></li>
<li><a href="https://softwaredevelopmentperestroika.wordpress.com/2014/02/11/image-processing-with-python-numpy-scipy-image-convolution/">https://softwaredevelopmentperestroika.wordpress.com/2014/02/11/image-processing-with-python-numpy-scipy-image-convolution/</a></li>
<li><a href="https://tools.ietf.org/html/draft-fuldseth-netvc-thor-03">https://tools.ietf.org/html/draft-fuldseth-netvc-thor-03</a></li>
<li><a href="https://www.encoding.com/android/">https://www.encoding.com/android/</a></li>
<li><a href="https://www.encoding.com/http-live-streaming-hls/">https://www.encoding.com/http-live-streaming-hls/</a></li>
<li><a href="https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm">https://www.iem.thm.de/telekom-labor/zinke/mk/mpeg2beg/whatisit.htm</a></li>
<li><a href="https://www.lifewire.com/cmos-image-sensor-493271">https://www.lifewire.com/cmos-image-sensor-493271</a></li>
<li><a href="https://www.linkedin.com/pulse/brief-history-video-codecs-yoav-nativ">https://www.linkedin.com/pulse/brief-history-video-codecs-yoav-nativ</a></li>
<li><a href="https://www.linkedin.com/pulse/video-streaming-methodology-reema-majumdar">https://www.linkedin.com/pulse/video-streaming-methodology-reema-majumdar</a></li>
<li><a href="https://www.vcodex.com/h264avc-intra-precition/">https://www.vcodex.com/h264avc-intra-precition/</a></li>
<li><a href="https://www.youtube.com/watch?v=9vgtJJ2wwMA">https://www.youtube.com/watch?v=9vgtJJ2wwMA</a></li>
<li><a href="https://www.youtube.com/watch?v=LFXN9PiOGtY">https://www.youtube.com/watch?v=LFXN9PiOGtY</a></li>
<li><a href="https://www.youtube.com/watch?v=Lto-ajuqW3w&amp;list=PLzH6n4zXuckpKAj1_88VS-8Z6yn9zX_P6">https://www.youtube.com/watch?v=Lto-ajuqW3w&amp;list=PLzH6n4zXuckpKAj1_88VS-8Z6yn9zX_P6</a></li>
<li><a href="https://www.youtube.com/watch?v=LWxu4rkZBLw">https://www.youtube.com/watch?v=LWxu4rkZBLw</a></li>
</ul>
<p>其他资源：</p>
<ul>
<li><a href="https://www.videoproc.com/resource/h264-codec.htm">https://www.videoproc.com/resource/h264-codec.htm</a></li>
</ul>
]]></content>
      <categories>
        <category>视频技术</category>
      </categories>
      <tags>
        <tag>数字视频</tag>
      </tags>
  </entry>
  <entry>
    <title>如何计算MS-SSIM</title>
    <url>/2020/02/25/how-to-calculate-the-MS-SSIM/</url>
    <content><![CDATA[<h2 id="ssim的本质及其缺点">SSIM的本质及其缺点</h2>
<p>在<a href="/2020/02/15/how-to-calculate-the-SSIM-in-FFmpeg/">FFmpeg如何计算图像的SSIM</a>中，详细介绍了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的相关概念，并对FFmpeg中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>实现做了详细的分析。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法基于HVS更擅长从图像中提取结构信息的事实，并且利用结构相似度来计算图像的感知质量。在Z. Wang等人的论文<strong>Multi-scale structural similarity for image quality assessment</strong>中也提到，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法要好于当时的其它的感知图像质量指标。</p>
<p>就其本质而言，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>是一种单尺度的算法，但是实际上正确的图像尺度取决于用户的观看条件，例如显示设备的分辨率，用户的观看距离等。因此，用单尺度的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法来评估图像的感知质量也存在其缺点。</p>
<span id="more"></span>
<h2 id="ms-ssim的基本概念">MS-SSIM的基本概念</h2>
<p>图像细节的可感知性取决于：</p>
<ul>
<li>图像信号的采样密度</li>
<li>用户的观看距离</li>
<li>HVS的感知能力</li>
</ul>
<p>当如上的因素发生变化时，则对给定图像的主观评估也会随之发生变化。单尺度的SSIM算法可能仅适用于某个特定的配置。为了解决该问题，论文<strong>Multi-scale structural similarity for image quality assessment</strong>在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法的基础上提出了如图1所示的多尺度的结构相似性评估算法，即<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法。</p>
<p><img src="/2020/02/25/how-to-calculate-the-MS-SSIM/1.jpg" alt="图1. MS-SSIM算法"></p>
<p>图1. MS-SSIM算法，L 表示低通滤波器，2↓ 表示采样间隔为2的下采样</p>
<p>因此，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>实际上是一种以不同分辨率合并图像细节的图像质量评估方法。对于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>，原始图像的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">scale=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，图像的最大<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo>=</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">scale=M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>c</mi><mi>a</mi><mi>l</mi><mi>e</mi><mo>=</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">scale=j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">c</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span></span></span></span>的尺度而言，其亮度、对比度、结构的相似性分别表示为：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>l</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l_j(X,Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">c_j(X,Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">s_j(X,Y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span></span></span></span></li>
</ul>
<p>因此，根据图1可以得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的计算方式。</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mo fence="false">[</mo><msub><mi>l</mi><mi>M</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>α</mi><mi>M</mi></msub></msup><mo>⋅</mo><munderover><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mrow><mo fence="false">[</mo><msub><mi>c</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>β</mi><mi>j</mi></msub></msup><mo fence="false">[</mo><msub><mi>s</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>γ</mi><mi>j</mi></msub></msup></mrow></mrow><annotation encoding="application/x-tex">MS-SSIM(X,Y)=\big[l_M(X,Y)\big]^{\alpha_M} \cdot \prod _{j=1}^{M}  {\big[c_j(X,Y)\big]^{\beta_j}\big[s_j(X,Y)\big]^{\gamma_j}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.254302em;vertical-align:-0.35001em;"></span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.904292em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.2421130000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000006em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.089008em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.05278em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.904292em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.05556em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>一般，令<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>j</mi></msub><mo>=</mo><msub><mi>β</mi><mi>j</mi></msub><mo>=</mo><msub><mi>γ</mi><mi>j</mi></msub><mtext>  </mtext><mo separator="true">,</mo><mtext> </mtext><mi>j</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\alpha_j=\beta_j=\gamma_j \ \ , \ j \in [1, M]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.9456279999999999em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.05556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace"> </span><span class="mspace"> </span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mclose">]</span></span></span></span>，我们得到：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mo fence="false">[</mo><msub><mi>l</mi><mi>M</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>α</mi><mi>M</mi></msub></msup><mo>⋅</mo><munderover><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mrow><mo fence="false">[</mo><msub><mi>c</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>s</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><msup><mo fence="false">]</mo><msub><mi>α</mi><mi>j</mi></msub></msup></mrow></mrow><annotation encoding="application/x-tex">MS-SSIM(X,Y)=\big[l_M(X,Y)\big]^{\alpha_M} \cdot \prod _{j=1}^{M}  {\big[c_j(X,Y) \cdot s_j(X,Y)\big]^{\alpha_j}}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.254302em;vertical-align:-0.35001em;"></span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.904292em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.2421130000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000006em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">]</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.904292em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>Multi-scale structural similarity for image quality assessment</strong>给出了一种计算各尺度参数的方法，并同时给出不同尺度的参数值：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>1</mn></msub><mo>=</mo><mn>0.0448</mn></mrow><annotation encoding="application/x-tex">\alpha_1=0.0448</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">4</span><span class="mord">4</span><span class="mord">8</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>2</mn></msub><mo>=</mo><mn>0.2856</mn></mrow><annotation encoding="application/x-tex">\alpha_2=0.2856</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">8</span><span class="mord">5</span><span class="mord">6</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>3</mn></msub><mo>=</mo><mn>0.3001</mn></mrow><annotation encoding="application/x-tex">\alpha_3=0.3001</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">3</span><span class="mord">0</span><span class="mord">0</span><span class="mord">1</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>4</mn></msub><mo>=</mo><mn>0.2363</mn></mrow><annotation encoding="application/x-tex">\alpha_4=0.2363</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">2</span><span class="mord">3</span><span class="mord">6</span><span class="mord">3</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>5</mn></msub><mo>=</mo><mn>0.1333</mn></mrow><annotation encoding="application/x-tex">\alpha_5=0.1333</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">1</span><span class="mord">3</span><span class="mord">3</span><span class="mord">3</span></span></span></span></li>
</ul>
<h2 id="ms-ssim算法的实现">MS-SSIM算法的实现</h2>
<p>采用FFmpeg中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的实现方式来实现<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。根据<a href="/2020/02/15/how-to-calculate-the-SSIM-in-FFmpeg/">FFmpeg如何计算图像的SSIM</a>的介绍：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mo fence="false">(</mo><mfrac><mrow><mn>2</mn><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>s</mi><mn>2</mn><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>1</mn></msub></mrow><mrow><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>1</mn></msub></mrow></mfrac><msup><mo fence="false">)</mo><msub><mi>α</mi><mi>M</mi></msub></msup><mo>⋅</mo><munderover><mo>∏</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mo fence="false">(</mo><mfrac><mrow><mn>2</mn><mi>c</mi><mi>o</mi><mi>v</mi><mi>a</mi><mi>r</mi><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>2</mn></msub></mrow><mrow><mi>v</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>2</mn></msub></mrow></mfrac><msup><mo fence="false">)</mo><msub><mi>α</mi><mi>j</mi></msub></msup></mrow><annotation encoding="application/x-tex">MS-SSIM(X,Y)=\bigg(\frac{2s1 \cdot s2 + ssimC_{1}}{s1^2+s2^2+ssimC_{1}}\bigg)^{\alpha_{M}} \cdot \prod _{j=1}^{M}\bigg(\frac{2covar + ssimC_2}{vars + ssimC_2}\bigg)^{\alpha_j}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.454322em;vertical-align:-0.95003em;"></span><span class="mord"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord"><span class="delimsizing size3">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.504292em;"><span style="top:-3.9029000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567071428571427em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.14329285714285717em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:3.2421130000000007em;vertical-align:-1.4137769999999998em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000006em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∏</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.3139999999999996em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8360000000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mord"><span class="delimsizing size3">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.5042920000000002em;"><span style="top:-3.9029000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3280857142857143em;"><span style="top:-2.357em;margin-left:-0.0037em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2818857142857143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>对于图像采样而言，采用简单的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>×</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2 \times 2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span></span></span></span>的卷积核执行图像的下采样，：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.15999999999999992em" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><mn>4</mn></mfrac></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
\frac{1}{4} &amp; \frac{1}{4} \\\\
\frac{1}{4} &amp; \frac{1}{4} \\\\
\end{bmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.8102160000000005em;vertical-align:-2.1551080000000002em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6529999999999996em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎣</span></span></span><span style="top:-2.79999em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.3959900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-3.4119800000000002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎢</span></span></span><span style="top:-4.653em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎡</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"><span></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6551080000000002em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span><span style="top:-2.404892em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-1.2048919999999999em;"><span class="pstrut" style="height:3em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.1551080000000002em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6551080000000002em;"><span style="top:-4.8100000000000005em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.4048920000000003em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9551079999999996em;"><span></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.6529999999999996em;"><span style="top:-1.6499900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎦</span></span></span><span style="top:-2.79999em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.3959900000000003em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-3.4119800000000002em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎥</span></span></span><span style="top:-4.653em;"><span class="pstrut" style="height:3.1550000000000002em;"></span><span class="delimsizinginner delim-size4"><span>⎤</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15003em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>具体的采样代码如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void downsample_2x2_mean(pixel *input, int width, int height, pixel *output) &#123;</span><br><span class="line">    int downsample_width &#x3D;  width &gt;&gt; 1;</span><br><span class="line">    int downsample_height &#x3D; height &gt;&gt; 1;</span><br><span class="line"></span><br><span class="line">    for (int y &#x3D; 0; y &lt; downsample_height; y++) &#123;</span><br><span class="line">        for (int x &#x3D;0; x &lt; downsample_width; x++) &#123;</span><br><span class="line">            output[y * downsample_width + x] &#x3D; (input[2 * y * width + 2 * x] +</span><br><span class="line">                                                input[2 * y * width + 2 * x + 1] +</span><br><span class="line">                                                input[(2 * y + 1) * width + 2 * x] +</span><br><span class="line">                                                input[(2 * y + 1) * width + 2 * x + 1]) &#x2F; 4;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后利用<a href="https://github.com/FFmpeg/FFmpeg/blob/master/tests/tiny_ssim.c">tiny_ssim</a>中的<code>ssim_plane()</code>迭代计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mo>−</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MS-SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">float ms_ssim_plane(pixel *pix1, pixel *pix2, int width, int height, int scale) &#123;</span><br><span class="line">    for (int i &#x3D; 0; i &lt; w * h; i++) &#123;</span><br><span class="line">        ori_img1[i] &#x3D; pix1[i];</span><br><span class="line">        ori_img2[i] &#x3D; pix2[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 计算每个尺度的ssim值.</span><br><span class="line">    for (int i &#x3D; 1; i &lt;&#x3D; scale; i++) &#123;</span><br><span class="line">        if (i !&#x3D; 1) &#123;</span><br><span class="line">            downsample_2x2_mean(ori_img1, w, h, sample_img1);</span><br><span class="line">            downsample_2x2_mean(ori_img2, w, h, sample_img2);</span><br><span class="line">            w &#x3D; w &gt;&gt; 1;</span><br><span class="line">            h &#x3D; h &gt;&gt; 1;</span><br><span class="line">            for (int j &#x3D; 0; j &lt; w * h; j++) &#123;</span><br><span class="line">                ori_img1[j] &#x3D; sample_img1[j];</span><br><span class="line">                ori_img2[j] &#x3D; sample_img2[j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        value &#x3D; ssim_plane(ori_img1, w, ori_img2, w, w, h, temp, NULL);</span><br><span class="line">        result *&#x3D; pow(value.C_S, WEIGHT[i-1]);</span><br><span class="line">        luminance_value[i-1] &#x3D; value.L;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result *&#x3D; pow(luminance_value[scale-1], WEIGHT[scale-1]);</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完整的代码可以参考<a href="https://gitee.com/wangwei1237/wangwei1237/blob/master/2020/02/25/how-to-calculate-the-MS-SSIM/test_msssim.cpp">test_msssim.cpp</a>。代码的很大部分是由我的同事<em>贤杰</em>(github: <a href="https://github.com/bodhisatan">@bodhisatan</a>)实现的，在此一并表示感谢。</p>
]]></content>
      <categories>
        <category>IVQA</category>
      </categories>
      <tags>
        <tag>SSIM</tag>
        <tag>MS-SSIM</tag>
      </tags>
  </entry>
  <entry>
    <title>The Proof of the ssim_end1() in FFmpeg</title>
    <url>/2020/02/18/the-proof-of-the-SSIM-in-FFMpeg/</url>
    <content><![CDATA[<p>这篇文章是对<a href="https://github.com/FFmpeg/FFmpeg/blob/master/tests/tiny_ssim.c">FFmpeg中计算SSIM算法</a>中用到的公式的证明。其中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">fs1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">fs2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>s</mi><mn>12</mn></mrow><annotation encoding="application/x-tex">fs12</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>s</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">fss</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span></span></span></span>的含义和FFmpeg保持一致，具体可以参考<a href="/2020/02/15/how-to-calculate-the-SSIM-in-FFmpeg/">FFmpeg如何计算图像的SSIM</a>中的说明。</p>
<span id="more"></span>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable rowspacing="0.24999999999999992em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><msub><mi>μ</mi><mi>a</mi></msub><msub><mi>μ</mi><mi>b</mi></msub><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>σ</mi><mrow><mi>a</mi><mi>b</mi></mrow></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>a</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>b</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mi>σ</mi><mi>a</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>b</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>μ</mi><mi>a</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mi>f</mi><mi>s</mi><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>μ</mi><mi>b</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mi>f</mi><mi>s</mi><mn>2</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msubsup><mi>σ</mi><mi>a</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>b</mi><mn>2</mn></msubsup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mi>μ</mi><mi>a</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mi>μ</mi><mi>b</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><msubsup><mi>μ</mi><mi>a</mi><mn>2</mn></msubsup><mo>−</mo><mn>2</mn><mo>⋅</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>μ</mi><mi>a</mi></msub><mo>+</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><msubsup><mi>μ</mi><mi>b</mi><mn>2</mn></msubsup><mo>−</mo><mn>2</mn><mo>⋅</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>μ</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo stretchy="false">)</mo><mo>−</mo><mn>2</mn><mo stretchy="false">(</mo><msub><mi>μ</mi><mi>a</mi></msub><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>+</mo><msub><mi>μ</mi><mi>b</mi></msub><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>+</mo><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>a</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>b</mi><mn>2</mn></msubsup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><mi>s</mi><mo>−</mo><mn>2</mn><mo>⋅</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo>+</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><mi>s</mi><mo>−</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mn>64</mn><mi>f</mi><mi>s</mi><mi>s</mi><mo>−</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>−</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>σ</mi><mrow><mi>a</mi><mi>b</mi></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mi>μ</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><msub><mi>μ</mi><mi>b</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></munder><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>−</mo><mi>a</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msub><mi>μ</mi><mi>b</mi></msub><mo>−</mo><mi>b</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msub><mi>μ</mi><mi>a</mi></msub><mo>+</mo><msub><mi>μ</mi><mi>a</mi></msub><mo>⋅</mo><msub><mi>μ</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><mn>12</mn><mo>−</mo><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><msub><mi>μ</mi><mi>b</mi></msub><mo>−</mo><mi>f</mi><mi>s</mi><mn>2</mn><mo>⋅</mo><msub><mi>μ</mi><mi>a</mi></msub><mo>+</mo><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><msub><mi>μ</mi><mi>b</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><mn>12</mn><mo>−</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>f</mi><mi>s</mi><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mn>1</mn><mn>63</mn></mfrac><mfrac><mn>1</mn><mn>64</mn></mfrac><mo stretchy="false">(</mo><mn>64</mn><mi>f</mi><mi>s</mi><mn>12</mn><mo>−</mo><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>f</mi><mi>s</mi><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mo>∴</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>f</mi><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>f</mi><mi>s</mi><mn>2</mn><mo>+</mo><mn>6</mn><msup><mn>4</mn><mn>2</mn></msup><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><mo>⋅</mo><mn>64</mn><mi>f</mi><mi>s</mi><mn>12</mn><mo>−</mo><mn>2</mn><mi>f</mi><mi>s</mi><mn>1</mn><mi>f</mi><mi>s</mi><mn>2</mn><mo>+</mo><mn>63</mn><mo>⋅</mo><mn>64</mn><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>6</mn><msup><mn>4</mn><mn>2</mn></msup><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>64</mn><mi>f</mi><mi>s</mi><mi>s</mi><mo>−</mo><mi>f</mi><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>−</mo><mi>f</mi><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>63</mn><mo>⋅</mo><mn>64</mn><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}

SSIM(a,b)&amp;=\frac{(2\mu_a\mu_b+C_1)(2\sigma_{ab}+C_2)}{(\mu_a^2+\mu_b^2+C_1)(\sigma_a^2+\sigma_b^2+C_2)} \\

\mu_a&amp;=\frac{1}{64}fs1 \\

\mu_b&amp;=\frac{1}{64}fs2 \\

\sigma_a^2+\sigma_b^2&amp;=\frac{1}{63}(\sum_{i,j}(a(i,j)-\mu_a)^2 + \sum_{i,j}(b(i,j)-\mu_b)^2) \\

&amp;=\frac{1}{63}\sum_{i,j}(a(i,j)^2+\mu_a^2-2 \cdot a(i,j) \cdot \mu_a+b(i,j)^2+\mu_b^2-2 \cdot b(i,j) \cdot \mu_b) \\

&amp;=\frac{1}{63}(\sum_{i,j}(a(i,j)^2+b(i,j)^2)-2(\mu_a\sum_{i,j}a(i,j)+\mu_b\sum_{i,j}b(i,j))+\sum_{i,j}
(\mu_a^2+\mu_b^2)) \\

&amp;=\frac{1}{63}(fss-2 \cdot \frac{1}{64}(fs1^2+fs2^2)+\frac{1}{64}(fs1^2+fs2^2) \\

&amp;=\frac{1}{63}(fss-\frac{1}{64}(fs1^2+fs2^2)) \\

&amp;=\frac{1}{63}\frac{1}{64}(64fss-fs1^2-fs2^2) \\

\sigma_{ab}&amp;=\frac{1}{63}\sum_{i,j}((a(i,j)-\mu_a)(b(i,j)-\mu_b)) \\

&amp;=\frac{1}{63}\sum_{i,j}(a(i,j) \cdot b(i,j)-a(i,j)\mu_b-b(i,j)\mu_a+\mu_a \cdot \mu_b) \\

&amp;=\frac{1}{63}(fs12-fs1 \cdot \mu_b-fs2 \cdot \mu_a+fs1 \cdot \mu_b) \\

&amp;=\frac{1}{63}(fs12-\frac{1}{64}fs1 \cdot fs2) \\

&amp;=\frac{1}{63}\frac{1}{64}(64fs12-fs1 \cdot fs2) \\

\therefore SSIM(a,b)&amp;=\frac{(2fs1 \cdot fs2+64^2C_1)(2 \cdot 64fs12-2fs1fs2+63 \cdot 64C_2)}{(fs1^2+fs2^2+64^2C_1)(64fss-fs1^2-fs2^2+63 \cdot 64C_2)}

\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:39.07702099999999em;vertical-align:-19.288510499999994em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:19.788510499999994em;"><span style="top:-21.852618499999995em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span><span style="top:-19.243870499999993em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-16.936430499999997em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-14.628990499999997em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span></span></span><span style="top:-11.593773499999994em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:-8.558556499999995em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:-5.523339499999996em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:-3.215899499999997em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:-0.9084594999999974em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:1.398980500000001em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:4.4341975em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:7.4694145em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:9.776854499999999em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:12.084294499999999em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"></span></span><span style="top:14.561402499999993em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mrel amsrm">∴</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:19.288510499999994em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:19.788510499999994em;"><span style="top:-21.852618499999995em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959079999999998em;"><span style="top:-2.398692em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30130799999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959079999999998em;"><span style="top:-2.398692em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.30130799999999996em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">a</span><span class="mord mathdefault mtight">b</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9873080000000001em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-19.243870499999993em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span><span style="top:-16.936430499999997em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span><span style="top:-14.628990499999997em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-11.593773499999994em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-8.558556499999995em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-5.523339499999996em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.215899499999997em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:-0.9084594999999974em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641079999999999em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:1.398980500000001em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">)</span></span></span><span style="top:4.4341975em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.050005em;"><span style="top:-1.8723309999999997em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.0500049999999996em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.413777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">a</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">b</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:7.4694145em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:9.776854499999999em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose">)</span></span></span><span style="top:12.084294499999999em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">3</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">6</span><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose">)</span></span></span><span style="top:14.561402499999993em;"><span class="pstrut" style="height:3.491108em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord mathdefault" style="margin-right:0.10764em;">f</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:19.288510499999994em;"><span></span></span></span></span></span></span></span></span></span></span></span></p>
]]></content>
      <categories>
        <category>IVQA</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
        <tag>SSIM</tag>
      </tags>
  </entry>
  <entry>
    <title>FFmpeg如何计算图像的SSIM</title>
    <url>/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/</url>
    <content><![CDATA[<h2 id="ssim基本概念">SSIM基本概念</h2>
<p>关于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的具体解释，此处不再介绍，具体可以参见<a href="https://wangwei1237.gitee.io/digital-video-concept/">数字视频相关概念</a>中的<a href="https://wangwei1237.gitee.io/digital-video-concept/docs/4_2_2_3_StructuralSimilarityBasedApproaches.html">SSIM算法</a>一节的介绍。</p>
<p>直接给出<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的计算方法：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">SSIM(x,y)=\frac{(2\mu_x\mu_y+C_1)(2\sigma_{xy}+C_2)}{(\mu_x^2+\mu_y^2+C_1)(\sigma_x^2+\sigma_y^2+C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.496108em;vertical-align:-1.069108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.069108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub><mo>=</mo><mo stretchy="false">(</mo><msub><mi>K</mi><mn>1</mn></msub><mi>L</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo separator="true">,</mo><msub><mi>C</mi><mn>2</mn></msub><mo>=</mo><mo stretchy="false">(</mo><msub><mi>K</mi><mn>2</mn></msub><mi>L</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">C_1=(K_1L)^2, C_2=(K_2L)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">L</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">L</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mn>1</mn></msub><mo>≪</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K_1\ll1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mn>2</mn></msub><mo>≪</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">K_2\ll1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">≪</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>均为常数，计算时，一般<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mn>1</mn></msub><mo>=</mo><mn>0.01</mn></mrow><annotation encoding="application/x-tex">K_1=0.01</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">1</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>K</mi><mn>2</mn></msub><mo>=</mo><mn>0.03</mn></mrow><annotation encoding="application/x-tex">K_2=0.03</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">0</span><span class="mord">3</span></span></span></span>。<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">L</span></span></span></span>是灰度的动态范围，由图像的数据类型决定，如果数据为<em>uint8</em>，则<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mn>255</mn></mrow><annotation encoding="application/x-tex">L=255</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault">L</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mord">5</span><span class="mord">5</span></span></span></span>。</p>
<span id="more"></span>
<h2 id="ssim计算中的图像分割">SSIM计算中的图像分割</h2>
<p>在整幅图片的跨度上，图像亮度的均值和方差变化较为剧烈；并且图像上不同区块的失真程度也有可能不同；再者人眼睛每次只能聚焦于一处，更关注局部数据而非全局数据。因此如上的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>算法不能直接作用于一整副图像。</p>
<p>在论文<strong>Image quality assessment: From error visibility to structural similarity</strong>中，作者采用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>11</mn><mo>×</mo><mn>11</mn></mrow><annotation encoding="application/x-tex">11 \times 11</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">1</span></span></span></span>的滑动窗口将整副图像分割为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span>个patch，然后计算每一个patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>，最后计算所有patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>值的平均数（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>e</mi><mi>a</mi><mi>n</mi><mtext>  </mtext><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo>:</mo><mi>M</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">Mean \ \ SSIM:MSSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault">e</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mspace"> </span><span class="mspace"> </span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>）作为整副图像的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。为了避免滑动窗口带来的块效应，在计算每个patch的均值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault">μ</span></span></span></span>和方差<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>时，作者采用了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo>=</mo><mn>1.5</mn></mrow><annotation encoding="application/x-tex">\sigma=1.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">5</span></span></span></span>的高斯卷积核作加权平均。</p>
<p>如果整副图像有<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span></span>个patch，则<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">MSSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的计算方式为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">MSSIM(X,Y) = \frac{1}{N}\sum_{i=1}^{N}{SSIM(x_i, y_i)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.106005em;vertical-align:-1.277669em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283360000000002em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3000050000000005em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p>
<p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SSIM(x_i, y_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>为第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>个patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<h2 id="ffmpeg中计算ssim的算法">FFmpeg中计算SSIM的算法</h2>
<p>在FFmpeg中，也提供了计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的实现：<a href="https://github.com/FFmpeg/FFmpeg/blob/master/tests/tiny_ssim.c">tiny_ssim</a>。从代码的注释中可以看到：为了提升算法的性能，没有采用论文中的高斯加权方式计算每个patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>，而是采用了一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8 \times 8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>的块来计算每个patch的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * tiny_ssim.c</span><br><span class="line"> * Computes the Structural Similarity Metric between two rawYV12 video files.</span><br><span class="line"> * original algorithm:</span><br><span class="line"> * Z. Wang, A. C. Bovik, H. R. Sheikh and E. P. Simoncelli,</span><br><span class="line"> *   &quot;Image quality assessment: From error visibility to structural similarity,&quot;</span><br><span class="line"> *   IEEE Transactions on Image Processing, vol. 13, no. 4, pp. 600-612, Apr. 2004.</span><br><span class="line"> *</span><br><span class="line"> * To improve speed, this implementation uses the standard approximation of</span><br><span class="line"> * overlapped 8x8 block sums, rather than the original gaussian weights.</span><br><span class="line"> *&#x2F;</span><br></pre></td></tr></table></figure>
<h3 id="standard-approximation-of-overlapped-8x8-block-sums">standard approximation of overlapped 8x8 block sums</h3>
<p>接下来就解释一下注释中的<em>standard approximation of overlapped 8x8 block sums</em>究竟是什么含义。在解释的过程中会分解成两个部分来解释：<em>overlapped 8x8 block</em>和<em>sums</em>。</p>
<h3 id="overlapped-8x8-block的含义">overlapped 8x8 block的含义</h3>
<p>FFmpeg在计算图像<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>时，首先以<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>×</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">4 \times 4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">4</span></span></span></span>的块大小把<strong>图1</strong>所示的分辨率为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>×</mo><mi>H</mi></mrow><annotation encoding="application/x-tex">W \times H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">W</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span>的图像：<br>
<img src="/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/1.jpg" alt="图1"><br>
图1：原始图像</p>
<p>分割为<strong>图2</strong>的样式。<br>
<img src="/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/2.jpg" alt="图2"></p>
<p>图2：分割后的图像</p>
<p>对于<strong>图2</strong>中的每一块用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>来表示（<em>图2中的红色块</em>），FFmpeg使用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>及其<strong>上、右、右上块</strong>（<em>图2中的绿色块</em>）来计算其<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo>:</mo><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SSIM:SSIM(x_{ij},y_{ij})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>及其<strong>上、右、右上块</strong>构成一个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>的像素块，并且该<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>的块和计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>用到的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>的块存在重合像素，这就是注释中的<strong>overlapped 8x8 block</strong>的真正含义。</p>
<p>因此，根据如上规则：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mfrac><mi>H</mi><mn>4</mn></mfrac><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>j</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">i \in [1,\frac{H}{4}],j \in [0,\frac{W}{4}-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69862em;vertical-align:-0.0391em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.217331em;vertical-align:-0.345em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.217331em;vertical-align:-0.345em;"></span><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span>。也就是说：第0行和最后一列的块不会计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<p>最后得到FFmpeg中的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>计算方式为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo>=</mo><mi>M</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mfrac><mi>H</mi><mn>4</mn></mfrac></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mrow><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn></mrow></munderover><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">SSIM = MSSIM(X,Y) = \frac{1}{N}\sum_{i=1}^{\frac{H}{4}}\sum_{j=0}^{\frac{W}{4}-1}{SSIM(x_{ij}, y_{ij})}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.526047em;vertical-align:-1.4137769999999998em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.11227em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.451805em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1122700000000005em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.451805em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mo stretchy="false">(</mo><mfrac><mi>H</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N=(\frac{H}{4}-1)(\frac{W}{4}-1)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="sums的含义">sums的含义</h3>
<p>如前所述，我们分析了FFmpeg计算图像的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的整体思路，接下来我们继续分析FFmpeg是如何计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SSIM(x_{ij},y_{ij})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>的。</p>
<p>首先利用函数<code>ssim_4x4x2_core()</code>来计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的结构相似性指标，主要是如下的4个指标：</p>
<ul>
<li><em>s1</em>：参考图像在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的像素之和</li>
<li><em>s2</em>：受损图像在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的像素之和</li>
<li><em>ss</em>：参考图像和受损图像在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的像素平方之和</li>
<li><em>s12</em>：参考图像和受损图像在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>块的对应像素乘积之和</li>
</ul>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>1</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><mrow><mi>x</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">s1=\sum_{i=0}^{3}\sum_{j=0}^{3}{x(i,j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.389826em;vertical-align:-0.43581800000000004em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>2</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><mrow><mi>y</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">s2=\sum_{i=0}^{3}\sum_{j=0}^{3}{y(i,j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.389826em;vertical-align:-0.43581800000000004em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><mrow><mo fence="false">(</mo><mo fence="false">(</mo><mi>x</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msup><mo fence="false">)</mo><mn>2</mn></msup><mo>+</mo><mo fence="false">(</mo><mi>y</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><msup><mo fence="false">)</mo><mn>2</mn></msup><mo fence="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">ss=\sum_{i=0}^{3}\sum_{j=0}^{3}{\Big(\big(x(i,j)\big)^2+\big(y(i,j)\big)^2\Big)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.80002em;vertical-align:-0.65002em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="delimsizing size2">(</span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">x</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054008em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="mord"><span class="delimsizing size1">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.054008em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size2">)</span></span></span></span></span></span><br>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>12</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mn>3</mn></msubsup><mrow><mo fence="false">(</mo><mi>x</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>y</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo><mo fence="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">s12=\sum_{i=0}^{3}\sum_{j=0}^{3}{\big(x(i,j) \cdot y(i,j)\big)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.389826em;vertical-align:-0.43581800000000004em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.43581800000000004em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord mathdefault">x</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></span></p>
<p>如上的4个指标就是我们后续会用到的sums，该sums也就是<em>overlapped 8x8 block sums</em>中的<em>sums</em>的概念。</p>
<h3 id="利用sums计算各块的ssim">利用sums计算各块的SSIM</h3>
<p>接下来利用该sums值计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<p>为了提升效率，FFmpeg会按照行来计算每一行的各个块的sums数据，并将每个行块的sums数据存储在长度为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>W</mi><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{W}{4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.217331em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.872331em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>的数组指针sum（<code>(int(*)[4])</code>）中。</p>
<p>其中sum指针有两种：</p>
<ul>
<li>sum0：存储当前行的各块的sums结果</li>
<li>sum1：存储当前行的上一行的sums结果</li>
</ul>
<p>先计算第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.74285em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>行块和第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>行块的sums结果，并分别存入<code>sum1</code>和<code>sum0</code>中。然后遍历第<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.65952em;vertical-align:0em;"></span><span class="mord mathdefault">i</span></span></span></span>行块的每一个块，并利用<code>sum1</code>和<code>sum0</code>中计算的结果来计算每一块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。</p>
<p>函数<code>ssim_end4()</code>展示了如何利用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i-1,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i-1,j+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span>的sums信息来计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">SSIM(x_{ij},y_{ij})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>：</p>
<ul>
<li>先对4个块的sums结果进行加和处理，得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>块的sums结果</li>
<li>然后利用该<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>块的sums来计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span></li>
</ul>
<p>函数<code>ssim_end1()</code>就展示了如何利用<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>块的sums信息来计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。具体的计算方法如下。</p>
<p>将红色区块<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的图像放大一点，如图3所示。我们接下来计算其<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>。<br>
<img src="/2020/02/15/how-to-calculate-the-SSIM-in-FFMpeg/3.jpg" alt="图3"><br>
图3：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><mi>k</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">block(i,j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathdefault">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span>的示意图</p>
<p>在计算时，首先将4个区块的sums值求和，得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn><mo>×</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">8\times8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">8</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">8</span></span></span></span>区块的sums值，分别为：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>1</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>63</mn></msubsup><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s1=\sum_{i=0}^{63}{x_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>2</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>63</mn></msubsup><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">s2=\sum_{i=0}^{63}{y_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>s</mi><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>63</mn></msubsup><mrow><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>i</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>y</mi><mi>i</mi><mn>2</mn></msubsup><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">ss=\sum_{i=0}^{63}{(x_i^2+y_i^2)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.441336em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.258664em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mn>12</mn><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>0</mn></mrow><mn>63</mn></msubsup><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">s12=\sum_{i=0}^{63}{(x_i \cdot y_i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.253718em;vertical-align:-0.29971000000000003em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-0.0000050000000000050004em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.954008em;"><span style="top:-2.40029em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.29971000000000003em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></li>
</ul>
<p>根据如上的计算，可以得到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">\mu_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">\mu_y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">\mu_x\mu_y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\mu_x^2+\mu_y^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">\sigma_x^2+\sigma_y^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\sigma_{xy}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>x</mi></msub><mo>=</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo>⋅</mo><mi>s</mi><mn>1</mn></mrow><annotation encoding="application/x-tex">\mu_x=\frac{1}{64} \cdot s1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>y</mi></msub><mo>=</mo><mfrac><mn>1</mn><mn>64</mn></mfrac><mo>⋅</mo><mi>s</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">\mu_y=\frac{1}{64} \cdot s2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub><mo>=</mo><mfrac><mn>1</mn><mrow><mn>64</mn><mo>⋅</mo><mn>64</mn></mrow></mfrac><mo stretchy="false">(</mo><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>s</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mu_x\mu_y=\frac{1}{64 \cdot 64}(s1 \cdot s2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span><span class="mbin mtight">⋅</span><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><mn>64</mn><mo>⋅</mo><mn>64</mn></mrow></mfrac><mo fence="false">(</mo><mo stretchy="false">(</mo><mi>s</mi><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><mi>s</mi><mn>2</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo fence="false">)</mo></mrow><annotation encoding="application/x-tex">\mu_x^2+\mu_y^2=\frac{1}{64 \cdot 64}\big((s1)^2+(s2)^2\big)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span><span class="mbin mtight">⋅</span><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup><mo>=</mo><mfrac><mn>1</mn><mrow><mn>64</mn><mo>⋅</mo><mn>63</mn></mrow></mfrac><mo fence="false">(</mo><mn>64</mn><mo>⋅</mo><mi>s</mi><mi>s</mi><mo>−</mo><mo stretchy="false">(</mo><mi>s</mi><mn>1</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>−</mo><mo stretchy="false">(</mo><mi>s</mi><mn>2</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo fence="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_x^2+\sigma_y^2=\frac{1}{64 \cdot 63}\big(64 \cdot ss-(s1)^2- (s2)^2\big)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.061108em;vertical-align:-0.247em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-0.383108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span><span class="mbin mtight">⋅</span><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="delimsizing size1">(</span></span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.66666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.20001em;vertical-align:-0.35001em;"></span><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="delimsizing size1">)</span></span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mfrac><mn>1</mn><mrow><mn>64</mn><mo>⋅</mo><mn>63</mn></mrow></mfrac><mo stretchy="false">(</mo><mn>64</mn><mo>⋅</mo><mi>s</mi><mn>12</mn><mo>−</mo><mi>s</mi><mn>1</mn><mo>⋅</mo><mi>s</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sigma_{xy}=\frac{1}{64 \cdot 63}(64 \cdot s12 - s1 \cdot s2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.190108em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span><span class="mbin mtight">⋅</span><span class="mord mtight">6</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mclose">)</span></span></span></span></li>
</ul>
<p>利用如上的公式（具体推导可以参考<a href="/2020/02/18/the-proof-of-the-SSIM-in-FFmpeg/">ssim_end1()的推导</a>）对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的公式进行计算可以得到：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><msub><mi>μ</mi><mi>x</mi></msub><msub><mi>μ</mi><mi>y</mi></msub><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><msub><mi>σ</mi><mrow><mi>x</mi><mi>y</mi></mrow></msub><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><msubsup><mi>μ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>μ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mi>σ</mi><mi>x</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>σ</mi><mi>y</mi><mn>2</mn></msubsup><mo>+</mo><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">SSIM(x,y)=\frac{(2\mu_x\mu_y+C_1)(2\sigma_{xy}+C_2)}{(\mu_x^2+\mu_y^2+C_1)(\sigma_x^2+\sigma_y^2+C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.496108em;vertical-align:-1.069108em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401079999999999em;"><span style="top:-2.4530000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7401079999999999em;"><span style="top:-2.4530000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.383108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">x</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.069108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>s</mi><mn>1</mn><mi>s</mi><mn>2</mn><mo>+</mo><mn>6</mn><msup><mn>4</mn><mn>2</mn></msup><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><mo>⋅</mo><mn>64</mn><mi>s</mi><mn>12</mn><mo>−</mo><mn>2</mn><mi>s</mi><mn>1</mn><mi>s</mi><mn>2</mn><mo>+</mo><mn>64</mn><mo>⋅</mo><mn>63</mn><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>6</mn><msup><mn>4</mn><mn>2</mn></msup><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>64</mn><mi>s</mi><mi>s</mi><mo>−</mo><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>−</mo><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>64</mn><mo>⋅</mo><mn>63</mn><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">=\frac{(2s1s2+64^2C_1)(2\cdot64s12-2s1s2+64\cdot63C_2)}{(s1^2+s2^2+64^2C_1)(64ss-s1^2-s2^2+64\cdot63C_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.36687em;vertical-align:0em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.427108em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">3</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord"><span class="mord">4</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">6</span><span class="mord">3</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>FFmpeg中，对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">C_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">C_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>的定义中的因子<strong>64</strong>或<strong>63</strong>也是根据上面的公式，但是从公式看，<a href="https://trac.ffmpeg.org/ticket/8529"><strong>FFmpeg对<code>ssim_c1</code>的计算少乘了64</strong></a>：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssim_c1 &#x3D; 0.01 * 0.01 * 255 * 255 * 64 + 0.5</span><br><span class="line">ssim_c2 &#x3D; 0.03 * 0.03 * 255 * 255 * 64 * 63 + 0.5</span><br></pre></td></tr></table></figure>
<p>当然，为了简化处理，FFmpeg还做了如下的定义：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vars  &#x3D; ss  * 64 - s1 * s1 - s2 * s2;</span><br><span class="line">covar &#x3D; s12 * 64 - s1 * s2;</span><br></pre></td></tr></table></figure>
<p>因此，最终在FFmpeg中，计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的公式为：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mn>2</mn><mi>s</mi><mn>1</mn><mi>s</mi><mn>2</mn><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mn>2</mn><mi>c</mi><mi>o</mi><mi>v</mi><mi>a</mi><mi>r</mi><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><mrow><mo stretchy="false">(</mo><mi>s</mi><msup><mn>1</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>v</mi><mi>a</mi><mi>r</mi><mi>s</mi><mo>+</mo><mi>s</mi><mi>s</mi><mi>i</mi><mi>m</mi><msub><mi>C</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">SSIM(x,y)=\frac{(2s1s2+ssimC_1)(2covar+ssimC_2)}{(s1^2+s2^2+ssimC_1)(vars + ssimC_2)}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">s</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault">s</span><span class="mord">1</span><span class="mord mathdefault">s</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">2</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord mathdefault">s</span><span class="mord mathdefault">s</span><span class="mord mathdefault">i</span><span class="mord mathdefault">m</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.07153em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>如上的公式就是函数<code>ssim_end1()</code>中最终的计算方式。</p>
<h3 id="利用各块的ssim计算图像的ssim">利用各块的SSIM计算图像的SSIM</h3>
<p>计算完所有块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>之后，就可以计算所有块的平均<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>并作为该图像的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>：</p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><mi>X</mi><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mfrac><mi>H</mi><mn>4</mn></mfrac></munderover><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>0</mn></mrow><mrow><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn></mrow></munderover><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">SSIM(X,Y)= \frac{1}{N}\sum_{i=1}^{\frac{H}{4}}\sum_{j=0}^{\frac{W}{4}-1}{SSIM(x_{ij}, y_{ij})}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.07847em;">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathdefault" style="margin-right:0.22222em;">Y</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:3.526047em;vertical-align:-1.4137769999999998em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.11227em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.451805em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.08125em;">H</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.1122700000000005em;"><span style="top:-1.872331em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">0</span></span></span></span><span style="top:-3.050005em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.451805em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8720928571428572em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.13889em;">W</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4137769999999998em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em;"><span style="top:-2.5500000000000003em;margin-left:-0.03588em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p>
<p class="katex-block has-jax"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mo stretchy="false">(</mo><mfrac><mi>H</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mfrac><mi>W</mi><mn>4</mn></mfrac><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">N=(\frac{H}{4}-1)(\frac{W}{4}-1)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.08125em;">H</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.04633em;vertical-align:-0.686em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">W</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="编码过程中的技巧">编码过程中的技巧</h3>
<p>在FFmpeg计算<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>的算法实现中，为了提升效率和抽象代码逻辑，也利用了很多的编程技巧，例如：</p>
<ul>
<li>计算YUV各分量图像宽度时用<code>w &gt;&gt; !!i</code></li>
<li>为了避免对第0行的特殊处理，采用两层循环来处理</li>
<li>计算每一行的各块的sums信息时，为了降低循环次数，每次循环计算2个块的sums结果，<code>ssim_4x4x2_core</code>的函数名可能就是这么来的。</li>
<li>计算每一行的各块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>时，为了降低循环次数，每次循环计算4个块的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>S</mi><mi>I</mi><mi>M</mi></mrow><annotation encoding="application/x-tex">SSIM</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.05764em;">S</span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault" style="margin-right:0.10903em;">M</span></span></span></span>，<code>ssim_end4</code>的函数名可能就是这么来的。</li>
</ul>
<h2 id="感谢">感谢</h2>
<p>分析过程离不开和贤杰(github: <a href="https://github.com/bodhisatan">@bodhisatan</a>)的不断讨论和交流，感谢@贤杰在繁忙的工作之余抽出时间来一起分析FFmpeg中SSIM算法的实现原理。</p>
]]></content>
      <categories>
        <category>IVQA</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
        <tag>SSIM</tag>
      </tags>
  </entry>
  <entry>
    <title>解决hexo-asset-image的图片地址错误问题</title>
    <url>/2020/02/05/handle-the-bug-of-hexo-asset-image-plugin/</url>
    <content><![CDATA[<p>由于<code>hexo-asset-image</code>插件存在bug，会导致博文中引用图片时无法生成正确的链接地址，进而导致图片无法访问的现象。<br>
具体解决方案为将文件<code>node_modules/hexo-asset-image/index.js</code>替换为如下的内容：</p>
<span id="more"></span>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> cheerio = <span class="built_in">require</span>(<span class="string">&#x27;cheerio&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// http://stackoverflow.com/questions/14480345/how-to-get-the-nth-occurrence-in-a-string</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPosition</span>(<span class="params">str, m, i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str.split(m, i).join(m).length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> version = <span class="built_in">String</span>(hexo.version).split(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">hexo.extend.filter.register(<span class="string">&#x27;after_post_render&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> config = hexo.config;</span><br><span class="line">  <span class="keyword">if</span>(config.post_asset_folder)&#123;</span><br><span class="line">    	<span class="keyword">var</span> link = data.permalink;</span><br><span class="line">	<span class="keyword">if</span>(version.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">Number</span>(version[<span class="number">0</span>]) == <span class="number">3</span>)</span><br><span class="line">	   <span class="keyword">var</span> beginPos = getPosition(link, <span class="string">&#x27;/&#x27;</span>, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	   <span class="keyword">var</span> beginPos = getPosition(link, <span class="string">&#x27;/&#x27;</span>, <span class="number">3</span>) + <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// In hexo 3.1.1, the permalink of &quot;about&quot; page is like &quot;.../about/index.html&quot;.</span></span><br><span class="line">	<span class="keyword">var</span> endPos = link.lastIndexOf(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>;</span><br><span class="line">    link = link.substring(beginPos, endPos);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> toprocess = [<span class="string">&#x27;excerpt&#x27;</span>, <span class="string">&#x27;more&#x27;</span>, <span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; toprocess.length; i++)&#123;</span><br><span class="line">      <span class="keyword">var</span> key = toprocess[i];</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">var</span> $ = cheerio.load(data[key], &#123;</span><br><span class="line">        ignoreWhitespace: <span class="literal">false</span>,</span><br><span class="line">        xmlMode: <span class="literal">false</span>,</span><br><span class="line">        lowerCaseTags: <span class="literal">false</span>,</span><br><span class="line">        decodeEntities: <span class="literal">false</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      $(<span class="string">&#x27;img&#x27;</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ($(<span class="built_in">this</span>).attr(<span class="string">&#x27;src&#x27;</span>))&#123;</span><br><span class="line">			<span class="comment">// For windows style path, we replace &#x27;\&#x27; to &#x27;/&#x27;.</span></span><br><span class="line">			<span class="keyword">var</span> src = $(<span class="built_in">this</span>).attr(<span class="string">&#x27;src&#x27;</span>).replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">			<span class="keyword">if</span>(!<span class="regexp">/http[s]*.*|\/\/.*/</span>.test(src) &amp;&amp;</span><br><span class="line">			   !<span class="regexp">/^\s*\//</span>.test(src)) &#123;</span><br><span class="line">			  <span class="comment">// For &quot;about&quot; page, the first part of &quot;src&quot; can&#x27;t be removed.</span></span><br><span class="line">			  <span class="comment">// In addition, to support multi-level local directory.</span></span><br><span class="line">			  <span class="keyword">var</span> linkArray = link.split(<span class="string">&#x27;/&#x27;</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">elem</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> elem != <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">			  &#125;);</span><br><span class="line">			  <span class="keyword">var</span> srcArray = src.split(<span class="string">&#x27;/&#x27;</span>).filter(<span class="function"><span class="keyword">function</span>(<span class="params">elem</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">return</span> elem != <span class="string">&#x27;&#x27;</span> &amp;&amp; elem != <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">			  &#125;);</span><br><span class="line">			  <span class="keyword">if</span>(srcArray.length &gt; <span class="number">1</span>)</span><br><span class="line">				srcArray.shift();</span><br><span class="line">			  src = srcArray.join(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">			  $(<span class="built_in">this</span>).attr(<span class="string">&#x27;src&#x27;</span>, config.root + link + src);</span><br><span class="line">			  <span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">&quot;update link as:--&gt;&quot;</span>+config.root + link + src);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">&quot;no src attr, skipped...&quot;</span>);</span><br><span class="line">			<span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info($(<span class="built_in">this</span>));</span><br><span class="line">		&#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      data[key] = $.html();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>使用hexo和github搭建个人博客</title>
    <url>/2020/02/05/use-hexo-and-github-for-blog/</url>
    <content><![CDATA[<h2 id="创建github仓库">创建github仓库</h2>
<p>首先打开<a href="https://github.com/">github</a>，点击<code>New repository</code>，创建一个新仓库用于存储博客的所有内容。</p>
<p>仓库名必须为：<code>账户名.github.io</code>，并且需要勾选<strong>Initialize this repository with a README</strong>。</p>
<p>在建好的仓库右侧有个<strong>settings</strong>按钮，点击<strong>settings</strong>，向下滑动到<strong>GitHub Pages</strong>，会发现有个网址，github会把该仓库中的项目部署到该网址下，该网址也是博客的默认地址。当然也可以购买域名，将其换成喜欢的地址。</p>
<span id="more"></span>
<p><img src="/2020/02/05/use-hexo-and-github-for-blog/1.jpg" alt></p>
<p><img src="/2020/02/05/use-hexo-and-github-for-blog/2.jpg" alt></p>
<h2 id="准备node-js环境">准备node.js环境</h2>
<p>由于hexo是基于<a href="https://nodejs.org/en/">node.js</a>开发的，因此在安装hexo之前，需要先安装node.js并配置响应的node.js环境。具体如下所示：</p>
<p><img src="/2020/02/05/use-hexo-and-github-for-blog/3.jpg" alt></p>
<h2 id="准备hexo环境">准备hexo环境</h2>
<p>根据<a href="https://hexo.io/">hexo官网</a>的提示，安装hexo。具体如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-cli -g</span><br><span class="line">$ hexo init blog</span><br><span class="line">$ cd blog</span><br><span class="line">$ npm install</span><br><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>此时hexo会在4000端口启动一个webserver，用浏览器访问<code>localhost:4000</code>则会看到初始化之后默认的站点。</p>
<h2 id="安装hexo插件">安装hexo插件</h2>
<h3 id="hexo-generator-category">hexo-generator-category</h3>
<p>该插件用于自动生成category，具体安装方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-generator-category --save</span><br><span class="line">$ hexo new page categories</span><br></pre></td></tr></table></figure>
<p>然后修改<code>source/categories/index.md</code>的内容为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: categories</span><br><span class="line">date: 2020-02-05 11:53:35</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">layout: &quot;categories&quot;</span><br><span class="line">comments: false</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<h3 id="hexo-generator-tag">hexo-generator-tag</h3>
<p>该插件用于自动生成tags，具体安装方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-generator-tag --save</span><br><span class="line">$ hexo new page tags</span><br></pre></td></tr></table></figure>
<p>然后修改<code>source/tags/index.md</code>的内容为：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2020-02-05 11:53:58</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">layout: &quot;tags&quot;</span><br><span class="line">comments: false</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<h3 id="hexo-asset-image">hexo-asset-image</h3>
<p>该插件主要用于解决在文章中引用图片的场景，具体安装方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm install hexo-asset-image --save</span><br></pre></td></tr></table></figure>
<p>安装该插件后，利用<code>hexo new post 'test'</code>生成新文章内容时，会在<code>source/_posts</code>目录下同时生成<code>test.md</code>和<code>test目录</code>，<code>test.md</code>中需要的图片可以存储在<code>test目录</code>下。在文档中，采用如下的方式来引用图片：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">![图片的描述信息](1.jpg)</span><br></pre></td></tr></table></figure>
<p>关于hexo-asset-image生成图片的bug，可以参考文章：<a href="/2020/02/05/handle-the-bug-of-hexo-asset-image-plugin/">解决hexo-asset-image的图片地址错误问题</a></p>
<h3 id="hexo-deployer-git">hexo-deployer-git</h3>
<p>该插件用于将编译后生成的站点内容发布到第一步创建的github仓库中，从而实现内容更新。具体安装方式如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ npm add hexo-deployer-git</span><br></pre></td></tr></table></figure>
<p>然后配置_config.yml中的<code>url</code>和<code>deploy</code>配置，以便可以通过该插件自动部署项目。具体配置如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">url:</span> <span class="string">https://wangwei1237.github.io/</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://github.com/wangwei1237/wangwei1237.github.io</span></span><br></pre></td></tr></table></figure>
<p>配置完毕之后，如果项目内容发生修改，则利用如下的命令就可以完成自动发布：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br><span class="line">$ hexo generate</span><br><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>技术</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>github</tag>
        <tag>建站</tag>
      </tags>
  </entry>
  <entry>
    <title>凡所过往，皆是序章</title>
    <url>/2020/02/05/where-of-what-is-past-is-prologue/</url>
    <content><![CDATA[<p>凡所过往，皆是序章，新的一年，用4个关键词来讲一讲2019年自己心中的过往和序章。</p>
<p><img src="/2020/02/05/where-of-what-is-past-is-prologue/1.jpg" alt></p>
<span id="more"></span>
<h2 id="变化">变化</h2>
<p>如果要用1个词来形容2019年的话，我觉得就是 变化了。无论内部，还是外部，都在发生着翻天覆地的变化。变化这种滋味起初很痛苦，但是却蕴含着无限的机会。</p>
<p>未来，变化会是常态。工作方式要变，工具平台要变，开发语言要变……所有的事情都在向着好的方向变化、发展。</p>
<p>在这个变化的过程中，不能随波逐流，也不能固守己见。需要顺应变化，找到其中的机会，顺势而为，乘风而起。</p>
<h2 id="学习">学习</h2>
<p>在快速的变化中，怎么才能乘风而起？秘诀也就是 学习了。</p>
<p>2019年，我学习了opengl，kotlin；</p>
<p>2019年，学习了数字视频，ffmpeg，opencv；</p>
<p>2019年，学习了Android的相机系统，学习了逆向破解；</p>
<p>2019年，学习了如何写作，学习了如何演讲，学习了如何系统化思考……</p>
<p>在学校的时候，为了工作而学习。现在或者未来，要为了学习而工作，不断学习新的技能。</p>
<p>学习是应对各种变化的不二法门。学习，在路上……</p>
<h2 id="创新">创新</h2>
<p>创新这个词呢，总会和 造轮子这个词关联起来。</p>
<p>2019年， 造轮子这个词很频繁，频繁的有点令我不知所措。实际上，我个人不反对造轮子，但是反对 为了造轮子而造轮子。每种技术都有他的能力边界，在 造轮子的时候，要首先识别到能力的边界，然后找到一种快速有效的方式来解决我们的问题，这才是创新。</p>
<p>技术的进步就是一个造轮子的过程。为什么有了c++还会有java，有了java还会有kotlin？为什么有了苹果还会有安卓？为什么有了快手还会有抖音？……</p>
<p>未来，在创新的路上，需要更多的践行work smarter not work harder。</p>
<p><img src="/2020/02/05/where-of-what-is-past-is-prologue/2.jpg" alt></p>
<h2 id="突破">突破</h2>
<p>毫无疑问，未来肯定是新人的天下。</p>
<p>未来需要更多的想，怎么能够让新人可以站在巨人的肩膀上成长；也要更多的想，怎们样才能够让自己成为人老心不老的老新人。</p>
<p>工作中，更无须给自己设限，这个我可能不行呢，那个我可能也搞不定呀，这个我没接触过呀，那个我没学过呀。怕什么呢，不试试怎们知道不行，不搞一搞怎么知道搞不定，没接触过就接触嘛，没学过就学起来嘛，没有什么大不了的。</p>
<p>工程师不就是要逢山开路遇水搭桥吗？要坚信，在我们可以想象的范围内，没有技术解决不了的问题。</p>
<p>冲破牢笼，方得始终。</p>
<p>加勒比海盗中有个桥段：</p>
<blockquote>
<p>船长：扬帆！起航！<br>
水手：什么方向？<br>
船长：海盗需要什么方向？起航！</p>
</blockquote>
<p>2020，扬帆，起航！乘着梦想之风，向着星光的方向，找到最好的自己。</p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>测试工作</tag>
      </tags>
  </entry>
  <entry>
    <title>对QA的思考——我的这些年</title>
    <url>/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/</url>
    <content><![CDATA[<p>2012年毕业后怀着一颗忐忑的心开始了测试工作的职业生涯，到现在也有7年啦。经历过奋斗和激情，也经历过徘徊和迷茫，勤恳却不庸碌。虽然对测试也有担忧，但是对这个行业始终保持着一种激情。</p>
<p>接下来结合自己的工作谈一下对测试的一些思考，也回顾下自己过去的测试工作中遵循的一些工作原则。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/1.jpg" alt></p>
<span id="more"></span>
<h2 id="原则1：正确的认识自己">原则1：正确的认识自己</h2>
<p>好多人，自视甚高，傲视一切。但是，实际上，牛人很多。我们能做成一件事情，能力是一个方面，但能力绝对不是全部因素。没有上级的支持，没有同事的协作和配合，没有公司提供的资源，我们是什么事情也做不成的。不能因为自己的工作时间长，对业务了解的深，就对别人横加指责，也不能因为自己职称高就给别人以压力。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/2.png" alt></p>
<h2 id="原则2：先成就别人-再成就自己">原则2：先成就别人，再成就自己</h2>
<p>我们经常问QA的价值是什么？</p>
<p>实际上有些东西是很难讲清楚的。好多QA为了证明自己的技术能力、技术价值，做了很多看似高超，但是实际上对业务快速迭代并没有用的事情。</p>
<p>我总觉得，自己的价值不是由自己体现的，而是由别人来体现的。只有先成就别人，才能最终成就自己。这就是我工作以来一直遵循的一个工作原则。不争，不抢，认真做事，认真帮别人做事，认真的帮业务做事情，帮助RD分析线上问题，解决BUG。到了后来，也颇有点：桃李不言，下自成蹊的味道。</p>
<p>好多人也会说，在这个时代，酒香也怕巷子深。如果不主动宣传自己的价值，宣传自己的影响力，别人是不会知道的。但是，实际上，影响力和价值是由别人来评估的，历史交由后人评就是这个道理。并且，影响力是处于某个圈层的，并通过圈层而扩散。我们首先在团队的圈层内做到影响力，才有可能通过圈层的扩散而扩散自己的价值。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/3.jpg" alt></p>
<h2 id="原则3：方便别人-方便自己">原则3：方便别人，方便自己</h2>
<p>做测试的同学，每天会写很多测试case，每天也会发很多测试报告，但是如果打开这些邮件，经常发现这些case很难让人理解，这些测试报告虽然篇幅很大，但是如果要从中找到接下来RD要做什么，还是要花费一点时间的。</p>
<p>在测试工作过程中，无论是测试报告，还是风险通报，首先要了解到这些内容的接收者到底是谁，然后需要思考，要以什么样的描述和组织才能方便对方快速了解到内容的含义，也就是要做到：到什么山头，唱什么歌。</p>
<p>我刚入职的时候，因为之前没有做过测试，也不知道测试报告要以什么样的格式来发，所以很害怕发测试报告。虽然学习了其他前辈的测试报告和前辈们的测试报告范式，但是总感觉还是害怕。因为，从RD的角度来看，阅读那些测试报告的成本还是很大的。</p>
<p>然后，我站在RD的角度上想，怎么组织测试报告，才能让RD一眼就知道自己接下来要做什么呢？然后我重新组织了之前测测试报告，在报告的最开始用1句话概括项目的测试结论：该项目测试是否通过，原因是什么？具体的BUG量是多少？然后接下来是详细的测试清单，清单中明确表明每一个case的测试点，前置，预期结果，实际测试结果，是否通过等信息。对于测试通过的case，用绿色来标注；对于测试失败的case，用红色标注；对于有疑问的case，比如建议等，用黄色标注。RD收到测试报告之后，先看结论，然后看非绿色的测试case修复BUG。</p>
<h2 id="原则4：消除门槛-而不是提升门槛">原则4：消除门槛，而不是提升门槛</h2>
<p>大禹治水之所以成功，最重要的思想就是：改“堵”为“疏”。</p>
<p>但是真正的测试过程中，经常会发现如下的现象：领导质疑QA的测试时间太长，QA质疑RD的提测质量太差，然后QA增加了准入打回的流程，对于RD提测的、没有通过准入的项目不予测试。</p>
<p>实际上，这种现象就是QA在项目的测试环节设置了一个门槛，而如果这种门槛设置的越来越多，那么对于业务而言也会发生“洪涝灾害”。单从测试团队的角度看，确实增加这个门槛，测试效率提升了，测试时间降低了，但是如果从整个业务的迭代来看，效率并没有提升。</p>
<p>我们提了门槛，发了准入case，增加了流程，这一点也不能说不好。但是我们有没有想过：这些准入case别人看的懂吗？我们怎么设计case能够使得RD自测的时候更加方便呢？即便看懂了，我们怎么保证RD确实执行了呢？我们怎么保证增加的这个流程每次都贯彻落实了呢？</p>
<p>QA不应该是一个门槛设置者，而应该是一种有效的武器。不能用看似合理的各种标准和要求卡住事情，而应该成为帮助团队解决问题的秘密武器。</p>
<p>QA不能只报问题，只说现象，只说RD不靠谱，上线不检查。QA需要思考：</p>
<ul>
<li>我们能为快速迭代做些什么？</li>
<li>我们能做些什么可以帮助RD快速发现自己的代码问题？</li>
<li>我们能做什么可以帮助RD快速发现上线过程异常了？</li>
</ul>
<h2 id="原则5：不断学习-不做伪学习者">原则5：不断学习，不做伪学习者</h2>
<p>现在，技术更新换代的频率很快，所以一定要不断的学习，持续的学习。还记得刚入职的时候，那时候就会c/c++，java。现在看看自己的github和内网的提交记录，发现语言层面基本上涵盖了：c/c++，java，php，python，go，javascript，shell，object-c，swift，lua。项目类型覆盖了服务端，策略端，iOS，Android，自动化等不同的方向。从原来只会用IIS的小白，到今天了解Apache，Lighttpd，Nginx等各种web服务器。从原来的服务端，到慢慢了解前端，了解策略端，了解客户端。</p>
<p>参加过好多会，和好多人沟通过，大家都希望组织提供学习的机会，提供分享的机会，希望组织能提供自己技术成长的机会。但是，实际上，成长是自己的事，学习是个人的事，为什么要求组织给提供这些机会呢？我组织过很长时间的分享，我也最反对组织大规模的技术学习和分享，因为让太多的伪学习者进入之后，效果并不理想。相反，规模较小的沙龙和讨论对个人的技术成长效果更为明显。伪学习者只是想学习而已，只是想让组织提供学习机会而已，仅此而已。</p>
<p>学习是自己的事情，白天求生存，晚上求发展。凌晨2点的时候，也曾在灯下啃过Nginx的源码，分析一个个的线上问题，没有这些个凌晨2点就不会有《Nginx沉思录》，《Nginx洗冤录》等一系列的总结。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/4.jpg" alt></p>
<h2 id="原则6：做积极的抱怨者-不做消极的抱怨者">原则6：做积极的抱怨者，不做消极的抱怨者</h2>
<p>没有“抱怨”就不会有技术的进步，但是反过来说没有“抱怨”就不会存在那么多的失败，一无是处，庸庸碌碌。关键是要看待我们对待“抱怨”的态度。当“抱怨”还仅仅是停留在嘴上，停留在思想上，被“抱怨”所控制时，基本上也就离碌碌无为不远了。当我们开始和“抱怨”对抗时，利用一切技术手段和努力消灭“抱怨”时，技术就开始进步了。所以，我一般不反对抱怨，并一直鼓励大家抱怨，但是接下来我会仔细分析抱怨的原因是什么？技术上需要什么探索才能消灭这些抱怨？</p>
<p>每一个“抱怨”都是一次机会，都是一个机遇，都是一次成长。逢山开路，遇水搭桥，勇往直前。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/5.jpg" alt></p>
<h2 id="原则7：正确认识qa和rd的异同">原则7：正确认识QA和RD的异同</h2>
<p>天分日夜黑白，季节有春夏秋冬，虽然全栈模式有他的优点，但是四季也有四季的美。文能提笔安天下，武能上马定乾坤。关键是，我们需要对QA和RD有正确的认识。</p>
<p>我们不能按照一个原则来评定事情。比如：老驴拉磨，始终走不出那个圈圈。和日行千里的良马相比，当然老驴要羞愧了。但是如果换个角度，拉磨一天，产面千斤。良马再能跑，也跑不出千斤面。</p>
<p>QA和RD虽然都是研发岗，都是技术体系，那他们的差异在哪呢？</p>
<p>我觉得有以下几点吧：</p>
<ul>
<li>从工作关系上讲，QA是RD的下游，RD是QA的客户。</li>
<li>从工作重点上讲，QA注重分析，而RD注重实践。RD要做的是解决问题，采用任何可能的方法，快速实现需求，快速上线。而QA没有太大的业务压力，可以有更多的时间来思考每一种技术的优势和劣势，有更多的时间来仔细分析和追查每一个bug的深层原因，帮助RD在快速解决问题后可以彻底解决问题，锦上添花。</li>
<li>从涵盖业务上讲，QA关注的业务广度较高，而RD关注业务的深度更高。</li>
</ul>
<p>实际上，技术是一个很广泛的概念，不能认为只有写代码，设计架构才是技术，我们的思维本身就是一种技术。关键是，我们的技术要为业务的发展而存在，而不是孤立的存在。</p>
<p><img src="/2020/02/05/thinking-about-QA-my-years-for-work-as-a-QA/6.jpg" alt></p>
]]></content>
      <categories>
        <category>总结</category>
      </categories>
      <tags>
        <tag>测试工作</tag>
      </tags>
  </entry>
</search>
